<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2021/ping-implementations" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">你真的理解過 PING 這個指令嗎? | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.hwchiu.com/docs/2021/ping-implementations"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="你真的理解過 PING 這個指令嗎? | hwchiu learning note"><meta data-rh="true" name="description" content="探討 ping 指令的不同實作方式"><meta data-rh="true" property="og:description" content="探討 ping 指令的不同實作方式"><meta data-rh="true" name="keywords" content="Linux,Ping"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.hwchiu.com/docs/2021/ping-implementations"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2021/ping-implementations" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2021/ping-implementations" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://L4HXL74VLW-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="hwchiu learning note" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5bc72551.css">
<link rel="preload" href="/assets/js/runtime~main.81c0ceb6.js" as="script">
<link rel="preload" href="/assets/js/main.da90dc4a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2021/cncf-tech-radar-secrets">CNCF Secrets 使用者調查報告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2021/cncf-tech-radar-storage">CNCF Storage 使用者調查報告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2021/cncf-tech-rader-multicaluster">CNCF MultiCluster 使用者調查報告</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/2021/iThome_Challenge/day1">iThome_Challenge</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2021/k8s-network-issue">從網路觀點來看導入 Kubernetes 的可能痛點</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2021/k8s-tcpdump">Kubernetes 之封包去哪兒</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2021/ping-implementations">你真的理解過 PING 這個指令嗎?</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2021"><span itemprop="name">2021</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">你真的理解過 PING 這個指令嗎?</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>前言</h1><p>2021/06 某天晚上，我正透過 ping 指令研究一下 ICMP 封包，霎那間不知道哪來的靈感，便把 ping 指令上的 capabilities 給拔掉，結果整個 ping 指令依然可以運作，這個結果完全是我沒有預料到的
畢竟 ICMP 封包以前預設情況下是使用者不太能自行創造的，所以 ping 指令從早期的 setuid 到後來引進 Linux Capabilities 提供更細緻的權限管理，都是要讓 ping 這個指令能夠順利地開啟 RAW socket 來發送 ICMP 封包。
不知道從什麼時候開始， ping 指令已經不需要上述機制的幫忙，任何使用者都可以輕鬆地透過 PING 指令發送 ICMP 的封包，而這篇文章就是針對這個現象觀察的筆記。</p><h1>Ping 指令觀察</h1><p>這邊使用三種不同的環境來看一下 ping 這個指令不同的設定方式</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ubuntu-1404">Ubuntu 14.04<a href="#ubuntu-1404" class="hash-link" aria-label="Direct link to Ubuntu 14.04" title="Direct link to Ubuntu 14.04">​</a></h2><p>第一個實驗環境如下</p><ol><li>Ubuntu 14.04.5 LTS</li><li>Linux network-lab 4.4.0-31-generic #50~14.04.1-Ubuntu SMP Wed Jul 13 01:07:32 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</li><li>ping utility, iputils-s20121221</li></ol><p>該 Ubuntu 環境底下的 ping 是來自 iputiles 這個套件，版本是 2012/12/21</p><p>先透過 ls -l 的指令去觀察，可以發現 ping 這個指令的權限比較特別，是 rwsr-xr-x，其中 s 的部分就是所謂的 setuid，透過 setuid 可以讓執行該程式的使用者短暫提升權限變成該程式的 owner，這意味任何執行 ping 這個應用程式的使用者都會短暫被提權到 root 權限。</p><p>因此使用 ping 指令就會非常正常，沒有什麼特別的問題。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ ls -l $(which ping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwsr-xr-x 1 root root 44168 May  7  2014 /bin/ping*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ ping 8.8.8.8 -c 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 8.8.8.8: icmp_seq=1 ttl=63 time=20.7 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- 8.8.8.8 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtt min/avg/max/mdev = 20.740/20.740/20.740/0.000 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這時候嘗試透過 chmod u-s 的方式將 setuid 給移除，移除後就會看到 ping 指令的權限變回到 rwxr-xr-x 的權限。
這時候如果直接執行 ping 指令就會發現沒有辦法運作，直接得到 <code>icmp open socket: Operation not permitted</code> 錯誤訊息。</p><p>但是如果採用 sudo 的方式讓自己提權到 root，則 ping 指令也是可以順利進行。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sudo chmod u-s $(which ping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ ls -l $(which ping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x 1 root root 44168 May  7  2014 /bin/ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ ping 8.8.8.8 -c 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping: icmp open socket: Operation not permitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sudo ping 8.8.8.8 -c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 8.8.8.8: icmp_seq=1 ttl=63 time=14.0 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- 8.8.8.8 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtt min/avg/max/mdev = 14.020/14.020/14.020/0.000 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>嘗試透過 strace 去觀察一下到底上述的 <code>icmp open socket</code> 跟什麼有關，可以發現是 <code>socket(PF_INET, SOCK_RAW, IPPROTO_ICMP) = -1 EPERM (Operation not permitted)</code> 這個 syscall 造成的，看起來一般使用者是沒有辦法創造基於 ICMP 協定的 RAW Socket，所以才需要借助 setuid 來提權。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ strace ping 8.8.8.8 -c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capget({_LINUX_CAPABILITY_VERSION_3, 0}, NULL) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capget({_LINUX_CAPABILITY_VERSION_3, 0}, {0, 0, 0}) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket(PF_INET, SOCK_RAW, IPPROTO_ICMP) = -1 EPERM (Operation not permitted)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capget({_LINUX_CAPABILITY_VERSION_3, 0}, NULL) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capget({_LINUX_CAPABILITY_VERSION_3, 0}, {0, 0, 0}) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket(PF_INET, SOCK_DGRAM, IPPROTO_IP) = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connect(3, {sa_family=AF_INET, sin_port=htons(1025), sin_addr=inet_addr(&quot;8.8.8.8&quot;)}, 16) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getsockname(3, {sa_family=AF_INET, sin_port=htons(44904), sin_addr=inet_addr(&quot;10.0.2.15&quot;)}, [16]) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close(3)                                = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dup(2)                                  = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fcntl(3, F_GETFL)                       = 0x8002 (flags O_RDWR|O_LARGEFILE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fstat(3, {st_mode=S_IFCHR|0620, st_rdev=makedev(136, 0), ...}) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f845fe4a000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lseek(3, 0, SEEK_CUR)                   = -1 ESPIPE (Illegal seek)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(3, &quot;ping: icmp open socket: Operatio&quot;..., 48ping: icmp open socket: Operation not permitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) = 48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close(3)                                = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">munmap(0x7f845fe4a000, 4096)            = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exit_group(2)                           = ?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="centos-7">CentOS 7<a href="#centos-7" class="hash-link" aria-label="Direct link to CentOS 7" title="Direct link to CentOS 7">​</a></h2><ol><li>CentOS Linux release 7.9.2009 (Core)</li><li>3.10.0-1062.18.1.el7.x86_64</li><li>ping utility, iputils-s20160308</li></ol><p>這個環境中首先透過 ls 觀察 ping 指令的權限，可以發現是單純的 rwx-r-xr-x，但是 ping 指令是可以正常運作的</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ ls -l $(which ping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x. 1 root root 66176 Aug  4  2017 /usr/bin/ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ ping 8.8.8.8 -c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 8.8.8.8: icmp_seq=1 ttl=93 time=7.85 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- 8.8.8.8 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtt min/avg/max/mdev = 7.851/7.851/7.851/0.000 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這種情況下 ping 可以運作是因為透過了 <a href="https://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="noopener noreferrer">Linux Capabilities</a> 這個框架賦予該應用程式額外的權限，可以透過 getcap 這個指令來觀察</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ getcap $(which ping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin/ping = cap_net_admin,cap_net_raw+p</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>從上述的指令可以觀察到 ping 這個應用程式被賦予了 net_admin, net_raw+p(permitted) 這兩個主要權限，這時候透過 strace 去觀察該 ping 指令的運行(strace 預設情況都會忽略 setuid/capabilities, 要用 -u 去處理)，可以看到整個過程很順利基於 SOCK_RAW 去開啟一個 ICMP 協定的 socket，該 socket fd 是 3，後續就針對 3 這個 fd 進行 ICMP 封包的讀寫。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sudo strace -u vagrant ping 8.8.8.8 -c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket(AF_INET, SOCK_RAW, IPPROTO_ICMP) = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setsockopt(3, SOL_SOCKET, SO_TIMESTAMP, [1], 4) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setsockopt(3, SOL_SOCKET, SO_SNDTIMEO, &quot;\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;, 16) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setsockopt(3, SOL_SOCKET, SO_RCVTIMEO, &quot;\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;, 16) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getpid()                                = 32035</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sendto(3, &quot;\10\0\230\34}#\0\1\271\0217a\0\0\0\0(y\v\0\0\0\0\0\20\21\22\23\24\25\26\27&quot;..., 64, 0, {sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr(&quot;8.8.8.8&quot;)}, 16) = 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recvmsg(3, {msg_name={sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr(&quot;8.8.8.8&quot;)}, msg_namelen=128-&gt;16, msg_iov=[{iov_base=&quot;E`\0T\0\0\0\0]\1\247q\10\10\10\10\n\36\233\252\0\0\240\34}#\0\1\271\0217a&quot;..., iov_len=192}], msg_iovlen=1, msg_control=[{cmsg_len=32, cmsg_level=SOL_SOCKET, cmsg_type=SCM_TIMESTAMP, cmsg_data={tv_sec=1630998969, tv_usec=759874}}], msg_controllen=32, msg_flags=0}, 0) = 84</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;64 bytes from 8.8.8.8: icmp_seq=&quot;..., 5464 bytes from 8.8.8.8: icmp_seq=1 ttl=93 time=7.96 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) = 54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;\n&quot;, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)                       = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;--- 8.8.8.8 ping statistics ---\n&quot;, 32--- 8.8.8.8 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) = 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;1 packets transmitted, 1 receive&quot;..., 601 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這個時候如果透過 setcap 將 capbility 給拔掉，整個 ping 指令又會不能正常運作了。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sudo setcap -r $(which ping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ ./ping 8.8.8.8 -c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping: socket: Operation not permitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sudo strace -u vagrant ping 8.8.8.8 -c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP) = -1 EACCES (Permission denied)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket(AF_INET, SOCK_RAW, IPPROTO_ICMP) = -1 EPERM (Operation not permitted)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">open(&quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fstat(3, {st_mode=S_IFREG|0644, st_size=2502, ...}) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f088dd51000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2502</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read(3, &quot;&quot;, 4096)                       = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close(3)                                = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(2, &quot;ping: socket: Operation not perm&quot;..., 38ping: socket: Operation not permitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ubuntu-2004">Ubuntu 20.04<a href="#ubuntu-2004" class="hash-link" aria-label="Direct link to Ubuntu 20.04" title="Direct link to Ubuntu 20.04">​</a></h2><p>前述兩個環境分別透過 SetUID 與 Capabilities 讓一般使用者都可以順利的使用 PING ，然而下列的實驗環境卻完全不同了</p><ol><li>Ubuntu 20.04.1 LTS</li><li>Linux network-lab 5.4.0-58-generic #64-Ubuntu SMP Wed Dec 9 08:16:25 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</li><li>ping:  ping from iputils s20190709</li></ol><p>該系統下的 ping 指令也沒有賦予 SetUID 的權限，但是 Capabilities 還是有給予 net_raw 的權限，這時候嘗試將該 Capabilities 給移除並且使用 ping 看看。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ ls -l $(which ping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x 1 root root 72776 Jan 30  2020 /usr/bin/ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ getcap $(which ping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin/ping = cap_net_raw+ep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sudo setcap -r $(which ping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ getcap $(which ping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ ping 8.8.8.8 -c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 8.8.8.8: icmp_seq=1 ttl=63 time=22.2 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- 8.8.8.8 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtt min/avg/max/mdev = 22.150/22.150/22.150/0.000 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>與前述不同的是，就算不給予 SetUID 與 Capabilities， ping 指令也可以正常運作，就算使用最基本的 strace 去觀察 ping 指令也可以正常運作，似乎除了 SetUID 與 Ccapbilities 外還有其他的機制來幫忙處理</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ strace ping 8.8.8.8 -c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP) = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket(AF_INET6, SOCK_DGRAM, IPPROTO_ICMPV6) = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sendto(3, &quot;\10\0\v\372\0\0\0\1`\0247a\0\0\0\0\211\274\f\0\0\0\0\0\20\21\22\23\24\25\26\27&quot;..., 64, 0, {sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr(&quot;8.8.8.8&quot;)}, 16) = 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setitimer(ITIMER_REAL, {it_interval={tv_sec=0, tv_usec=0}, it_value={tv_sec=10, tv_usec=0}}, NULL) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recvmsg(3, {msg_name={sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr(&quot;8.8.8.8&quot;)}, msg_namelen=128-&gt;16, msg_iov=[{iov_base=&quot;\0\0\23\367\0\3\0\1`\0247a\0\0\0\0\211\274\f\0\0\0\0\0\20\21\22\23\24\25\26\27&quot;..., iov_len=192}], msg_iovlen=1, msg_control=[{cmsg_len=32, cmsg_level=SOL_SOCKET, cmsg_type=SO_TIMESTAMP_OLD, cmsg_data={tv_sec=1630999648, tv_usec=855986}}, {cmsg_len=20, cmsg_level=SOL_IP, cmsg_type=IP_TTL, cmsg_data=[63]}], msg_controllen=56, msg_flags=0}, 0) = 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;64 bytes from 8.8.8.8: icmp_seq=&quot;..., 5464 bytes from 8.8.8.8: icmp_seq=1 ttl=63 time=21.3 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) = 54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;\n&quot;, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)                       = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;--- 8.8.8.8 ping statistics ---\n&quot;, 32--- 8.8.8.8 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) = 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;1 packets transmitted, 1 receive&quot;..., 601 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) = 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;rtt min/avg/max/mdev = 21.289/21&quot;..., 53rtt min/avg/max/mdev = 21.289/21.289/21.289/0.000 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) = 53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close(1)                                = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close(2)                                = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exit_group(0)                           = ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ exited with 0 +++</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>透過 strace 的觀察結果，我發現呼叫的 syscall 有些微的不同，之前的系統是透過 <code>socket(AF_INET, SOCK_RAW, IPPROTO_ICMP) = 3</code> 取得一個基於 RAW Socket 的 ICMP Socket，而新版則是呼叫 <code>socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP) = 3</code>，基於 DGRAM 類型的 ICMP Socket.</p><p>針對這個關鍵字去搜尋後可以得到這個最初討論的 Linux Kernel Patch <a href="https://lwn.net/Articles/420800/" target="_blank" rel="noopener noreferrer">ipv4: add ICMP socket kind
</a>，該 Patch 希望於基於 SOCK_DGRAM 去增加一個全新的 IPPROTO_ICMP 的類型封包，讓收送 ICMP 封包可以不需要透過 RAW Socket 來處理，而是讓 Kernel 幫忙處理掉 ICMP 的封包來回，藉此打造出一個不用權限的 ping 指令。
這也是為什麼第三個環境系統上的 ping 指令不需要任何 SetUID 與 Capabilities 也能夠順利的收送 ICMP 封包，原因就是底層 Kernel 使用的機制不同，從過往的 RAW Socket 改成專門提供 ICMP 服務的 socket。</p><p>上述的 Patch 最後還是有加上一些門檻，並非所有使用者都可以直接呼叫 <code>socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP)</code> 來收送 ICMP 封包，只有呼叫者的 GID 符合 net.ipv4.ping_group_range 這個參數的使用者才可以直接呼叫。</p><p>以第三個系統來說，可以觀察到</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sysctl net.ipv4.ping_group_range</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.ping_group_range = 0   2147483647</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uid=1000(vagrant) gid=1000(vagrant) groups=1000(vagrant),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),111(lxd),118(lpadmin),119(sambashare),997(docker)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>該系統內只要使用者的 GID 是介於 0~2147483647 的就可以呼叫該特殊的 socket，基於實驗精神，將該參數改到無法符合當前 vagrant 使用者的 GID 並且再次執行 ping 看看</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sudo sysctl -w net.ipv4.ping_group_range=&quot;2147483647 2147483647&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.ping_group_range = 2147483647 2147483647</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sysctl net.ipv4.ping_group_range</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.ping_group_range = 2147483647  2147483647</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$  ping 8.8.8.8 -c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping: socket: Operation not permitted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>透過 sysctl 的指令將 <code>ping_group_range</code> 的範圍修改成只有 2147483647 可以符合，而 vagrant 這個使用者的 GID 並沒有包含其中，所以這時候的 ping 指令就沒有辦法順利啟動。</p><p>最後進行一個小實驗，手動新增一個全新的 group，將其 GID 設定為 2147483647，並命名為 ping_test
接者將 vagrant 使用者加入到該 ping_test 的群組中，再次使用 ping 指令測試看看。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sudo groupadd ping_test -g 2147483647</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ sudo usermod -a -G ping_test vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uid=1000(vagrant) gid=1000(vagrant) groups=1000(vagrant),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),111(lxd),118(lpadmin),119(sambashare),997(docker),2147483647(ping_test)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@network-lab:~$ ping 8.8.8.8 -c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 8.8.8.8: icmp_seq=1 ttl=63 time=15.0 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- 8.8.8.8 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtt min/avg/max/mdev = 15.027/15.027/15.027/0.000 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>果不其然的 ping 又可以順利啟動了</p><p>透過一系列簡單的實驗觀察了不同系統上三種不同的 ping 實作方式，有趣的讀者也可以觀察一下自己的系統目前是採取何種方式的實作</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">Linux</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kernel">Kernel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/ubuntu">Ubuntu</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2021/k8s-tcpdump"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Kubernetes 之封包去哪兒</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/2020"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">2020</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ubuntu-1404" class="table-of-contents__link toc-highlight">Ubuntu 14.04</a></li><li><a href="#centos-7" class="table-of-contents__link toc-highlight">CentOS 7</a></li><li><a href="#ubuntu-2004" class="table-of-contents__link toc-highlight">Ubuntu 20.04</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.81c0ceb6.js"></script>
<script src="/assets/js/main.da90dc4a.js"></script>
</body>
</html>