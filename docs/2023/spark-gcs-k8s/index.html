<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2023/spark-kubernetes" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Spark SQL, ThriftServer, GCS in Kubernetes. | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hwchiu.com/docs/2023/spark-gcs-k8s"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spark SQL, ThriftServer, GCS in Kubernetes. | hwchiu learning note"><meta data-rh="true" name="description" content="紀錄如何於 K8s 上安裝 Spark SQL/ThriftServer 並且操作 GCS 上的資料"><meta data-rh="true" property="og:description" content="紀錄如何於 K8s 上安裝 Spark SQL/ThriftServer 並且操作 GCS 上的資料"><meta data-rh="true" name="keywords" content="Kubernetes,Network,Linux,Ubuntu"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hwchiu.com/docs/2023/spark-gcs-k8s"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/2023/spark-gcs-k8s" hreflang="en"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/2023/spark-gcs-k8s" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.a4f4719e.css">
<link rel="preload" href="/assets/js/runtime~main.c9ca7c58.js" as="script">
<link rel="preload" href="/assets/js/main.c5e93c40.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/gitops-repo-structure">GitOps 下的 Git Repo 架構探討</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/k8s-sidecar">Kubernetes 1.28 Sidecar Container 初體驗</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/k8s-pod-affinity-2">解密 Assigning Pod To Nodes(下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/k8s-pod-affinity-1">解密 Assigning Pod To Nodes(上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/k8s-gc">讓你的 Container Image 逃脫 Kubelet Image GC 的魔掌</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/k8s-network-debug">Kubernetes 網路除錯之旅</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/kind-fun-facts">從 KIND 環境中學到的 DNS 小趣聞</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/k8s-node-fault-recovery">節點崩壞時如何快速處理 Pod</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/python-ruamel">ruamel.yaml 小筆記</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2023/spark-gcs-k8s">Spark SQL, ThriftServer, GCS in Kubernetes.</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2023"><span itemprop="name">2023</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spark SQL, ThriftServer, GCS in Kubernetes.</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Spark SQL, ThriftServer, GCS in Kubernetes.</h1></header><p>本篇文章記錄如何於 Kubernetes 安裝 Spark SQL 與 Spark Thrift Server，並且使用 GCS 作為 Spark SQL 來源，最後透過 JDBC 相容的應用程式與之溝通之來運行 Spark SQL.</p><p>文章並不會針對 Spark SQL, Thrift Server 等有過多琢磨，單純紀錄使用之指令與檔案。</p><h1>架構</h1><p>本文的目的架構如下，</p><ol><li>以 GKE 為基礎當作 Kubernetes 平台</li><li>於 GKE 中部署 Spark Thrift Server</li><li>欲查詢之資料存放於 GCS 中</li><li>透過 Beeline CLI 或其他 JDBC 相容之工具與 Spark Thrift Server 溝通並且執行 SQL 相關語法。</li><li>Spark Thrift 收到請求產生對應的 Spark Executor，並從 GCS 中讀取相關資料並回應。</li></ol><p>整個架構如下圖所述</p><p><img loading="lazy" src="https://hackmd.io/_uploads/Bk5TEXjJ6.png" class="img_ev3q"></p><p>接下來就針對圖中每個元件記錄一下實際上的設定</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gcs">GCS<a href="#gcs" class="hash-link" aria-label="Direct link to GCS" title="Direct link to GCS">​</a></h2><p>為了 Spark 可以有權限存取 GCS 上的資料，我們必須要創建一組 Service Account 並且給予對應的權限</p><p>此外由於 Spark 目前並不支援 Workload Identity 的方式，因此該 Service Account 必須要創建一組基於 Json 格式的 credential.json，然後將該檔案掛載到 Kubernetes 內讓 Spark Executor 可以透過其來與 GCS 互動。</p><p>流程為</p><ol><li>創建一個 Service Account</li><li>賦予該 Service Account 一個 IAM Role 來讀寫 GCS</li><li>產生一個對應的 Credential Key</li><li>將該 Credential 給寫入到 Kubernetes 內</li></ol><p>流程對應指令如下</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ gcloud iam service-accounts --project my-project create spark-example --description=&quot;For Spark To Access GCS&quot; --display-name=spark-example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ gcloud projects add-iam-policy-binding my-project --member=&quot;serviceAccount:spark-example@my-project.iam.gserviceaccount.com&quot; --role=&quot;roles/storage.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ gcloud iam service-accounts --project my-project keys create spark_test.json --iam-account=spark-example@my-project.iam.gserviceaccount.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create secret generic gcs-sa --from-file=gcp-credentials.json=spark_test.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>執行完畢後，環境中就會有一跟名為 <strong>gcs-sa</strong> 的 Kubernetes secret，之後部署 Spark 的時候必須要將該掛載到環境中並且告知使用 <strong>gcp-credentials.json</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spark">Spark<a href="#spark" class="hash-link" aria-label="Direct link to Spark" title="Direct link to Spark">​</a></h2><p>由於 Spark Server 需要動態創建 Spark Executor(Pod) ，因此本身需要 Kubernetes 的 Service Account 來獲得權限</p><p>以下 YAML 基於 RBAC 的規則準備好相關權限，並且賦予到名為 &quot;spark&quot; 的 Service Account 上</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;pods&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;persistentvolumeclaims&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;configmaps&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;services&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;get&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;deletecollection&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;create&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;list&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;watch&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;delete&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rolebinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subjects</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">roleRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>一切準備就緒後，接下來就是準備一個 statefulset 來部署 Spark Thrift Server
首先， Spark 的官方 Image 中目前沒有包含可以跟 GCS 溝通用的 Connector，因此我們必需要額外安裝 <a href="https://github.com/GoogleCloudDataproc/hadoop-connectors/tree/master/gcs" target="_blank" rel="noopener noreferrer">Google Cloud Storage Connector for Spark </a> 到環境中</p><p>這邊有兩個做法</p><ol><li>重新建置 Spark Image，將相關檔案直接包含到 Image 內</li><li>採用 Init Container 的方式下載該檔案，並且透過 Volume 的方式共享給主要的 Spark Container，並且放到 /opt/spark/jars 的資料夾內讓 Thrift Server 啟動時可以一併初始化</li></ol><p>這邊採取 (2) 的方式來示範抓取 <a href="https://github.com/GoogleCloudDataproc/hadoop-connectors/releases" target="_blank" rel="noopener noreferrer">hadoop3-2.2.16-shared.jar</a></p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">initContainers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: download-file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image: busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  command: [&quot;sh&quot;, &quot;-c&quot;, &quot;if [ ! -e /tmp/gcs-connector-hadoop3-2.2.16-shaded.jar ]; then wget -O /tmp/gcs-connector-hadoop3-2.2.16-shaded.jar https://github.com/GoogleCloudDataproc/hadoop-connectors/releases/download/v2.2.16/gcs-connector-hadoop3-2.2.16-shaded.jar; fi&quot;] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: data-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mountPath: /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: data-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  emptyDir: {}       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: thrift-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image: apache/spark:3.4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: data-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mountPath: /app/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - &#x27;bash&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - &#x27;-c&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - &gt;-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cp /app/data/gcs-connector-hadoop3-2.2.16-shaded.jar /opt/spark/jars/ &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /opt/spark/sbin/start-thriftserver.sh  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --jars /app/data/gcs-connector-hadoop3-2.2.16-shaded.jar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --packages com.google.cloud.bigdataoss:gcs-connector:hadoop3-2.2.16,org.apache.spark:spark-hadoop-cloud_2.12:3.4.0      </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此做法的缺點就是效率比較低，但是彈性高，如果有版本需求更動時只需要改動 YAML 即可，不需要每次重新建置 Container Image。</p><p>接下來還要把前述提到的 Service Account 以及 GCS 的相關權限也帶入到環境中</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">serviceAccountName: spark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- secret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secretName: gcs-sa  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: gcs-sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: thrift-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image: apache/spark:3.4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: gcs-sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mountPath: /etc/secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      readOnly: true      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.hadoop.fs.gs.impl=com.google.cloud.hadoop.fs.gcs.GoogleHadoopFileSystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.hadoop.google.cloud.auth.service.account.enable=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.hadoop.fs.gs.project.id=my-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.hadoop.google.cloud.auth.service.account.json.keyfile=/etc/secrets/gcp-credentials.json      </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再來處理 hive server 相關的設定，本範例部署採用的是本地 hive metastore 的部署，因此會使用 Kubernetes PVC 來存放 hive 的資料。</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">volumeClaimTemplates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: spark-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    accessModes: [ &quot;ReadWriteOnce&quot; ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storage: 100Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: thrift-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image: apache/spark:3.4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: gcs-sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mountPath: /etc/secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      readOnly: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: spark-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mountPath: /opt/spark/work-dir      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --hiveconf hive.server2.thrift.port=10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --hiveconf hive.server2.thrift.bind.port=0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.kubernetes.driver.ownPersistentVolumeClaim=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.kubernetes.driver.reusePersistentVolumeClaim=true      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最後就是微調一些跟 Kubernetes 有關的參數，詳細設定都可以參閱 <a href="https://spark.apache.org/docs/latest/running-on-kubernetes.html" target="_blank" rel="noopener noreferrer">Running Spark on Kubernetes</a></p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: spark-thrift-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clusterIP: None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: spark-thrift-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: thrift-server-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetPort: 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: spark-driver-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 7078</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetPort: 7078</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: spark-ui-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 4040</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetPort: 4040      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: thrift-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image: apache/spark:3.4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --master k8s://https://kubernetes.default.svc.cluster.local:443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.dynamicAllocation.enabled=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.kubernetes.container.image=apache/spark:v3.4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.kubernetes.driver.pod.name=spark-thrift-server-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.kubernetes.executor.request.cores=&quot;500m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.kubernetes.executor.request.memory=&quot;1g&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.kubernetes.executor.secrets.gcs-sa=/etc/secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.kubernetes.namespace=dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.driver.host=spark-thrift-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.driver.bindAddress=spark-thrift-server-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --conf spark.driver.port=7078</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &amp;&amp; tail -f /opt/spark/logs/spark--org.apache.spark.sql.hive.thriftserver.HiveThriftServer2-1-spark-thrift-server-0.out</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述的設定包含</p><ol><li>告知 Kubernetes API Server 的位置</li><li>Executor 會將 <strong>gcs-sa</strong> secret 給掛載到環境中的 <strong>/etc/secrets</strong> 內</li><li>準備一個 Service 來提供網路服務供未來其他應用程式存取</li><li>使用 dev namespace</li><li>thrift-server 預設會把 log 寫出來到檔案，因此透過 tail 的方式轉出來</li></ol><p>最後全部整理起來可以得到下列的 YAML 檔案</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: spark-thrift-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clusterIP: None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: spark-thrift-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: thrift-server-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetPort: 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: spark-driver-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 7078</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetPort: 7078</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: StatefulSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: spark-thrift-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceName: spark-thrift-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: spark-thrift-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  volumeClaimTemplates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: spark-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accessModes: [ &quot;ReadWriteOnce&quot; ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          storage: 100Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: spark-thrift-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceAccountName: spark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      initContainers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: download-file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          command: [&quot;sh&quot;, &quot;-c&quot;, &quot;if [ ! -e /tmp/gcs-connector-hadoop3-2.2.16-shaded.jar ]; then wget -O /tmp/gcs-connector-hadoop3-2.2.16-shaded.jar https://github.com/GoogleCloudDataproc/hadoop-connectors/releases/download/v2.2.16/gcs-connector-hadoop3-2.2.16-shaded.jar; fi&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: data-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - secret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            secretName: gcs-sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: gcs-sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: data-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          emptyDir: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: thrift-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: apache/spark:3.4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: gcs-sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /etc/secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              readOnly: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: data-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /app/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: spark-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /opt/spark/work-dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &#x27;bash&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &#x27;-c&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &gt;-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cp /app/data/gcs-connector-hadoop3-2.2.16-shaded.jar /opt/spark/jars/ &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              /opt/spark/sbin/start-thriftserver.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --master k8s://https://kubernetes.default.svc.cluster.local:443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --jars /app/data/gcs-connector-hadoop3-2.2.16-shaded.jar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --packages com.google.cloud.bigdataoss:gcs-connector:hadoop3-2.2.16,org.apache.spark:spark-hadoop-cloud_2.12:3.4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --hiveconf hive.server2.thrift.port=10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --hiveconf hive.server2.thrift.bind.port=0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.dynamicAllocation.enabled=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.kubernetes.container.image=apache/spark:v3.4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.kubernetes.driver.pod.name=spark-thrift-server-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.kubernetes.driver.ownPersistentVolumeClaim=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.kubernetes.driver.reusePersistentVolumeClaim=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.kubernetes.executor.request.cores=&quot;500m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.kubernetes.executor.request.memory=&quot;1g&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.kubernetes.executor.secrets.gcs-sa=/etc/secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.kubernetes.namespace=dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.driver.host=spark-thrift-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.driver.bindAddress=spark-thrift-server-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.driver.port=7078</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.hadoop.fs.gs.impl=com.google.cloud.hadoop.fs.gcs.GoogleHadoopFileSystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.hadoop.google.cloud.auth.service.account.enable=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.hadoop.fs.gs.project.id=my-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              --conf spark.hadoop.google.cloud.auth.service.account.json.keyfile=/etc/secrets/gcp-credentials.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &amp;&amp; tail -f /opt/spark/logs/spark--org.apache.spark.sql.hive.thriftserver.HiveThriftServer2-1-spark-thrift-server-0.out</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>將上述檔案部署到環境內後，可以觀察部署的情況</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n dev logs -f spark-thrift-server-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">23/09/23 01:58:13 INFO AbstractService: Service:ThriftBinaryCLIService is started.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">23/09/23 01:58:13 INFO ThriftCLIService: Starting ThriftBinaryCLIService on port 10000 with 5...500 worker threads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">23/09/23 01:58:13 INFO AbstractService: Service:HiveServer2 is started.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">23/09/23 01:58:13 INFO HiveThriftServer2: HiveThriftServer2 started</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>出現 <strong>HiveThriftServe2</strong> 就代表一切部署完畢，接下來就來進行環境驗證</p><h1>Verify</h1><p>為了驗證存取，我們先創建一個 GCS 來存放資料</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud storage buckets create gs://hungwei_spark_test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由於接下來要透過 Spark SQL 的語法操作，所以資料本身必須包含</p><ol><li>database/table</li><li>scheme </li><li>data kc port-forward -n dev --address 0.0.0.0 svc/spark-thrift-service 10000:10000</li></ol><p>因此 GCS 上的資料存取可以分成兩種類型</p><ol><li>創建全新的 table 與 data</li><li>存取已經存在的資料</li></ol><p>以下使用 beeline CLI 來示範兩種情境
先透過 kubectl port-forward 創立 Tunnel 並且來存取</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl port-forward -n dev --address 0.0.0.0 svc/spark-thrift-service 10000:10000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接者透過 beeline 來連線(也可以使用 dbeaver)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./beeline -u jdbc:hive2://localhost:10000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此外由於前述安裝時有特別設定 <code>spark.dynamicAllocation.enabled=true</code>，因此每次執行都會動態產生 Pod 來運行，所以第一次執行指令都會比較花費時間</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="case-1">Case 1<a href="#case-1" class="hash-link" aria-label="Direct link to Case 1" title="Direct link to Case 1">​</a></h2><p>接下來的示範流程為</p><ol><li>使用 gcs 內的資料夾來創建一個 database，並且設定相關 sceheme</li><li>寫入資料</li><li>讀取資料</li></ol><p>其中創建 table 的時候要特別加上 <code>OPTIONS (path &#x27;gs://$bucket_name/$folder&#x27;)</code> 來使用</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:hive2://localhost:10000&gt; CREATE TABLE test (id int, name string) OPTIONS (path &#x27;gs://hungwei_spark_test/case1&#x27;);    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:hive2://localhost:10000&gt; INSERT INTO TABLE test VALUES (1234, &#x27;test&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:hive2://localhost:10000&gt; INSERT INTO TABLE test VALUES (2345, &#x27;test2&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:hive2://localhost:10000&gt; INSERT INTO TABLE test VALUES (1234, &#x27;test3&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:hive2://localhost:10000&gt; INSERT INTO TABLE test VALUES (1234, &#x27;test3&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:hive2://localhost:10000&gt; INSERT INTO TABLE test VALUES (5678, &#x27;test3&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:hive2://localhost:10000&gt; select * from test where name=&quot;test3&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------+--------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  id   |  name  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------+--------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 5678  | test3  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1234  | test3  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1234  | test3  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------+--------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3 rows selected (3.415 seconds)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述指令的執行過程可以觀察到相關的 Pod 被創立</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-7   1/1     Running             0             1s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-6   0/1     Completed           0             5m28s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-6   0/1     Terminating         0             5m28s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-6   0/1     Terminating         0             5m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-6   0/1     Terminating         0             5m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-6   0/1     Terminating         0             5m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-7   0/1     Completed           0             65s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-7   0/1     Terminating         0             65s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-7   0/1     Terminating         0             67s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-7   0/1     Terminating         0             67s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thrift-jdbc-odbc-server-7e310a8abfc209d1-exec-7   0/1     Terminating         0             67s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>觀察 GCS 內的狀態，可以看到有些許檔案被創建來描述資料</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ gsutil list gs://hungwei_spark_test/case1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gs://hungwei_spark_test/case1/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gs://hungwei_spark_test/case1/part-00000-26846a09-e18e-4d38-8b2a-c7c005e2c7e8-c000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gs://hungwei_spark_test/case1/part-00000-29411642-fd0b-4c1c-bcad-fe6f77adef53-c000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gs://hungwei_spark_test/case1/part-00000-34bc8daf-3944-4156-8ff9-f8d2839f6a9f-c000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gs://hungwei_spark_test/case1/part-00000-7ca852d0-97e1-4c06-a3e1-e329c1bfebde-c000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gs://hungwei_spark_test/case1/part-00000-8a105d8b-f314-4763-ba5e-d82ff00506bf-c000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>透過相同的 port-forward 方式去存取 4040 port，就可觀察到 Spark UI</p><p><img loading="lazy" src="https://hackmd.io/_uploads/rJUnkVnkp.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="case-2">Case 2<a href="#case-2" class="hash-link" aria-label="Direct link to Case 2" title="Direct link to Case 2">​</a></h2><p>第二個範例我們要存取一個事先存在的資料，因此會先透過 gsutil 的工具將資料上傳到 bucket 內的 case2 資料夾，總共有三個檔案
每個檔案的內容都是一樣的格式，為 int, string 的格式，範例如下</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">287, 341feba68a7c515288ba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">288, 7db6394632c5ee7c2bc3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">289, 5c2fb14de85ac40013bc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">290, 831596bd2c3051aa128e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">291, 673c62da4b7b0eee8efd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">292, 46107b341ed115c03ac2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">293, 140fde027a05d316fa95</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">294, ba0760ff44610f797ad0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>先透過 gsutil 上傳到 case2 資料夾內</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ gsutil cp data*   gs://hungwei_spark_test/case2/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copying file://data1 [Content-Type=application/octet-stream]...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copying file://data2 [Content-Type=application/octet-stream]...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copying file://data3 [Content-Type=application/octet-stream]...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| [3 files][  2.9 MiB/  2.9 MiB]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Operation completed over 3 objects/2.9 MiB.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ gsutil ls   gs://hungwei_spark_test/case2/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gs://hungwei_spark_test/case2/data1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gs://hungwei_spark_test/case2/data2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gs://hungwei_spark_test/case2/data3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>檔案準備就緒後就回到 beeline CLI 的介面，這時候要透過 <code>EXTERNAL TABLE</code> 搭配其他變數來描述該檔案格式，範例如下</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:hive2://localhost:10000&gt; CREATE EXTERNAL TABLE case2 (id int, name string) row format delimited fields terminated by &#x27;,&#x27; stored as textfile OPTIONS (path &#x27;gs://hungwei_spark_test/case2&#x27;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:hive2://localhost:10000&gt; select * from case2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 111291  |  3b8b2b1eca0561d4ab62  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 111292  |  01a20fc8e8f91984e447  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 111293  |  ecf8d25c0ed6f8576f96  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 111294  |  558f78477c1b2151f6e9  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 111295  |  b5ae29bda237add37650  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 111296  |  ea2caeabbf3559a6cdea  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 111297  |  0d56273274b4012f690f  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 111298  |  20a25f019018272013fd  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------+------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  id   |          name          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------+------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 111299  |  dead09f62d571453339e  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 111300  |  3ab89d041368f1717543  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------+------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">106,902 rows selected (51.873 seconds)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:hive2://localhost:10000&gt; select count(*) from case2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| count(1)  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 106902    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row selected (42.869 seconds)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Summary</h1><ol><li>Spark 原生不支持 GCS，需要安裝相關 Connector</li><li>Spark 不支援 Workload Identity，需要創建 Service Account，設定好權限並且創建相關的 Key</li><li>Spark 於 Kubernetes 上有眾多參數可以微調</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/spark">Spark</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/gcp">GCP</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2023/python-ruamel"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">ruamel.yaml 小筆記</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/2022"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">2022</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#gcs" class="table-of-contents__link toc-highlight">GCS</a></li><li><a href="#spark" class="table-of-contents__link toc-highlight">Spark</a></li><li><a href="#case-1" class="table-of-contents__link toc-highlight">Case 1</a></li><li><a href="#case-2" class="table-of-contents__link toc-highlight">Case 2</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c9ca7c58.js"></script>
<script src="/assets/js/main.c5e93c40.js"></script>
</body>
</html>