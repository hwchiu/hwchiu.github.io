<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2023/k8s-assigning-pod-2" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">解密 Assigning Pod To Nodes(下) | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.hwchiu.com/docs/2023/k8s-assigning-pod-2"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="解密 Assigning Pod To Nodes(下) | hwchiu learning note"><meta data-rh="true" name="description" content="探討 Kubernetes 內如何控制 Pod 與節點的分配關係"><meta data-rh="true" property="og:description" content="探討 Kubernetes 內如何控制 Pod 與節點的分配關係"><meta data-rh="true" name="keywords" content="Kubernetes,DevOps,PodAffinity"><meta data-rh="true" property="og:image" content="https://hackmd.io/_uploads/SkWAL7S33.png"><meta data-rh="true" name="twitter:image" content="https://hackmd.io/_uploads/SkWAL7S33.png"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.hwchiu.com/docs/2023/k8s-assigning-pod-2"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2023/k8s-assigning-pod-2" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2023/k8s-assigning-pod-2" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://L4HXL74VLW-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="hwchiu learning note" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5bc72551.css">
<link rel="preload" href="/assets/js/runtime~main.3270a02e.js" as="script">
<link rel="preload" href="/assets/js/main.b48a7a09.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/autoscaler">Kubernetes 中 VPA, HPA, CA, CPA 的差異是什麼?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/descheduler">何謂 Kubernetes Descheduler 以及可以做什麼?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/gitops-repo-structure">GitOps 下的 Git Repo 架構探討</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/k8s-1-28-sidecar">Kubernetes 1.28 Sidecar Container 初體驗</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2023/k8s-assigning-pod-2">解密 Assigning Pod To Nodes(下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/k8s-assigning-pod">解密 Assigning Pod To Nodes(上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/k8s-gc">讓你的 Container Image 逃脫 Kubelet Image GC 的魔掌</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/k8s-network-debug">Kubernetes 網路除錯之旅</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/kind-network">從 KIND 環境中學到的 DNS 小趣聞</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/node-failure-1">節點崩壞時如何快速處理 Pod</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/python-yaml">ruamel.yaml 小筆記</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2023/spark-kubernetes">Spark SQL, ThriftServer, GCS in Kubernetes.</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2023"><span itemprop="name">2023</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">解密 Assigning Pod To Nodes(下)</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>解密 Assigning Pod To Nodes(下)</h1></header><p>本篇文章要來探討 Kubernetes 中有哪些方式可以用來影響 Pod 與 Node 之間的分配關係。</p><p>對環境與前述章節不熟的請先前往閱讀前篇文章 <a href="https://www.hwchiu.com/docs/2023/k8s-assigning-pod.html" target="_blank" rel="noopener noreferrer">解密 Assigning Pod To Nodes(上)</a></p><h1>Inter-Pod (Anti)Affinity</h1><p>Inter-Pod Affinity 與 Anti-Affinity 讓使用者根據已在節點上運行的 Pod 的標籤而非 Node 本身的標籤來限制 Pod 可以被調度到哪些節點上。</p><p>所以比較對方已經不單單是 Node 而是 Pod 的標籤。</p><p>而實作上更為精準的說法，其判斷與調度的目標對象並不是節點，而是一個分群後的結果</p><p>舉例來說，我們可以有下列不同的分群結果</p><p><img loading="lazy" src="/assets/images/BJ5XNkE33-caacc5f3872a29542bbd572b1b8b1ea2.png" width="3432" height="1200" class="img_ev3q">
<img loading="lazy" src="/assets/images/BkD4V1Vhn-90ae866222166bf21ebfc41a92443a9f.png" width="3508" height="1206" class="img_ev3q">
<img loading="lazy" src="/assets/images/HykSNkNnh-b8fcde141ad137b6a6c1687b8a9b31fd.png" width="3448" height="1200" class="img_ev3q"></p><p>分群的方式則是透過 Node 上的 label，透過 key/value 的形式將相同 value 的節點給歸類為同一群體，而 Key 的選擇則是透過 &quot;topologyKey&quot; 這個欄位來設定</p><p>舉例來說，如果今天設定
topologyKey = <code>kubernetes.io/hostname</code>，則就會基於節點的 hostname 來分群，那因為沒有節點有一樣的名稱，所以四個節點就會自動分成四群，如上圖一
但是若採用
topologyKey = <code>kind.zone</code>，則就會基於 <code>kind.zone</code> 的方式去分群，所以分群的結果就會如同上圖二所示，最後分成兩群。</p><p>因此使用 Inter-Pod (Anti)Affinity 時還要先考慮如何將節點分群，常見的方法有</p><ol><li>以節點的名稱分群</li><li>以Zone的分群，特別是雲端環境中希望服務可以部署到不同的 Zone 來達到高可用性。</li></ol><p>這邊要注意的是，官網有提到若有部分節點沒有 <code>topoologyKey</code> 所描述的 Key 那可能會造成些非預期的行為，因此一定要確保所有節點都有對應的 Label key。</p><p>與 NodeAffinity 相似， Inter-Pod Affinity 也提供基於 &quot;Required&quot; 與 &quot;Preferred&quot; 兩種不同的選擇策略，因此設定上的邏輯與格式幾乎完全雷同，幾個唯一的差異是</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl explain pod.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KIND:     Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VERSION:  v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESOURCE: requiredDuringSchedulingIgnoredDuringExecution &lt;[]Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DESCRIPTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     If the affinity requirements specified by this field are not met at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     scheduling time, the pod will not be scheduled onto the node. If the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     affinity requirements specified by this field cease to be met at some point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     during pod execution (e.g. due to a pod label update), the system may or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     may not try to eventually evict the pod from its node. When there are</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     multiple elements, the lists of nodes corresponding to each podAffinityTerm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     are intersected, i.e. all terms must be satisfied.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Defines a set of pods (namely those matching the labelSelector relative to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     the given namespace(s)) that this pod should be co-located (affinity) or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     not co-located (anti-affinity) with, where co-located is defined as running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     on a node whose value of the label with key &lt;topologyKey&gt; matches that of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     any node on which a pod of the set of pods is running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FIELDS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   labelSelector        &lt;Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     A label query over a set of resources, in this case pods.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   namespaceSelector    &lt;Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     A label query over the set of namespaces that the term applies to. The term</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     is applied to the union of the namespaces selected by this field and the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ones listed in the namespaces field. null selector and null or empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     namespaces list means &quot;this pod&#x27;s namespace&quot;. An empty selector ({})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     matches all namespaces.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   namespaces   &lt;[]string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     namespaces specifies a static list of namespace names that the term applies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     to. The term is applied to the union of the namespaces listed in this field</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     and the ones selected by namespaceSelector. null or empty namespaces list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     and null namespaceSelector means &quot;this pod&#x27;s namespace&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   topologyKey  &lt;string&gt; -required-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     This pod should be co-located (affinity) or not co-located (anti-affinity)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     with the pods matching the labelSelector in the specified namespaces, where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     co-located is defined as running on a node whose value of the label with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     key topologyKey matches that of any node on which any of the selected pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     is running. Empty topologyKey is not allowed.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl explain pod.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KIND:     Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VERSION:  v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESOURCE: podAffinityTerm &lt;Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DESCRIPTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Required. A pod affinity term, associated with the corresponding weight.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Defines a set of pods (namely those matching the labelSelector relative to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     the given namespace(s)) that this pod should be co-located (affinity) or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     not co-located (anti-affinity) with, where co-located is defined as running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     on a node whose value of the label with key &lt;topologyKey&gt; matches that of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     any node on which a pod of the set of pods is running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FIELDS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   labelSelector        &lt;Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     A label query over a set of resources, in this case pods.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   namespaceSelector    &lt;Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     A label query over the set of namespaces that the term applies to. The term</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     is applied to the union of the namespaces selected by this field and the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ones listed in the namespaces field. null selector and null or empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     namespaces list means &quot;this pod&#x27;s namespace&quot;. An empty selector ({})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     matches all namespaces.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   namespaces   &lt;[]string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     namespaces specifies a static list of namespace names that the term applies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     to. The term is applied to the union of the namespaces listed in this field</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     and the ones selected by namespaceSelector. null or empty namespaces list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     and null namespaceSelector means &quot;this pod&#x27;s namespace&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   topologyKey  &lt;string&gt; -required-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     This pod should be co-located (affinity) or not co-located (anti-affinity)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     with the pods matching the labelSelector in the specified namespaces, where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     co-located is defined as running on a node whose value of the label with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     key topologyKey matches that of any node on which any of the selected pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     is running. Empty topologyKey is not allowed.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>需要透過 <code>topologyKey</code> 來指定如何分群節點</li><li>由於決策是基於 Pod 的 Label 來決定，而 Pod 本身實際上是有 namespace 的概念的，預設情況下只會比較相同 namespace 的 Pod，如果有特別需求的時候還要使用 namespaceSelector 或是 namespace 來選定目標 namespace，則這些 namespace 上的所有 Pod 都會被納入考量</li></ol><p>此外 Anti-Affinity 與 Affinity 實作上有一些關於對稱性的差異，詳細來源為<a href="https://github.com/kubernetes/design-proposals-archive/blob/main/scheduling/podaffinity.md#a-comment-on-symmetry?WT.mc_id=AZ-MVP-5003331" target="_blank" rel="noopener noreferrer">官方設計文件</a></p><p>對 Anti-Affinity 來說，若服務 A 不想要與服務 B 被調度一起，則隱含服務 B 也不想要跟服務A 一起，但是對 Affinity 來說則沒有這種對稱性，所以兩者部署的演算法有些許不同，以下節錄自<a href="https://github.com/kubernetes/design-proposals-archive/blob/main/scheduling/podaffinity.md#a-comment-on-symmetry?WT.mc_id=AZ-MVP-5003331" target="_blank" rel="noopener noreferrer">官方設計文件</a></p><p>Anti-Affinity</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if S1 has the aforementioned RequiredDuringScheduling anti-affinity rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if a node is empty, you can schedule S1 or S2 onto the node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if a node is running S1 (S2), you cannot schedule S2 (S1) onto the node</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這意味如果今天有服務 A 透過 Anti-Affinity 去限制與 B 的調度情況，則部署服務 A 或是服務 B 都會去檢查是否有違反規則，沒有的話則隨意部署。</p><p>Affintiy</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if S1 has the aforementioned RequiredDuringScheduling affinity rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if a node is empty, you can schedule S2 onto the node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if a node is empty, you cannot schedule S1 onto the node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if a node is running S2, you can schedule S1 onto the node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if a node is running S1+S2 and S1 terminates, S2 continues running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if a node is running S1+S2 and S2 terminates, the system terminates S1 (eventually)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>相同範例來看，服務 A 透過 Affinity 去要求與服務 B 一起的調度情況，根據第二條規則，若服務 B 不存在，則服務 A 會卡住不能調度，處於 Pending 狀況。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="anti-affinity">Anti-Affinity<a href="#anti-affinity" class="hash-link" aria-label="Direct link to Anti-Affinity" title="Direct link to Anti-Affinity">​</a></h2><p>第一個範例嘗試透過 <code>required</code> 來限制部署情況，而參照對象為自己</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pod-affinity-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: pod-affinity-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: pod-affinity-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: www-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: hwchiu/netutils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        podAntiAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - labelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - key: app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - pod-affinity-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            topologyKey: &quot;kind.zone&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>基於 <code>kind.zone</code> 作為 TopologyKey </li><li>使用 <code>AntiAffinity</code> 配上 Required，要求同 ToplogyKey 中彼此不能出現第二個 Pod</li><li>部署三個副本</li></ol><p>根據前述對稱性所描述的規則，若當下環境沒有任何符合規則的 Pod，則可以隨意部署，所以第一個 Pod 可以順利部署。</p><p><img loading="lazy" src="/assets/images/HJVMwDEh3-b3166d14b0267a3416c05fa9c9df7550.png" width="3508" height="1206" class="img_ev3q"></p><p>第二個 Pod 部署的時候就會觀察到 Pod1 已經把左邊給佔據了，因此只剩下右邊該群可用</p><p><img loading="lazy" src="/assets/images/Bk8bwwVnh-58d9b63c2b4722630943908f04c5f5ea.png" width="3508" height="1206" class="img_ev3q"></p><p>第三個 Pod 部署的時候因為兩個群上面都已經有 Pod 正在運行，而環境中沒有任何其他符合條件的節點可以用，因此最終就會卡到 Pending.</p><p><img loading="lazy" src="/assets/images/Byx8vPEn3-b25715ebe9b51612dc33e9a7a13b7a2b.png" width="3406" height="1775" class="img_ev3q"></p><p>由結果可以觀察根據 <code>TopologyKey=kind.zone</code> 來分類，叢集中只能分到兩群，而第三個 Pod 則會因為 AntiAffinity + Required 的效果因此沒有辦法被部署，所以這種使用方法就要特別注意副本數量與分群數量，特別是當透過 HPA 來動態調整副本時更容易出錯。</p><p>若將 <code>Rqeuired</code> 改成 <code>Prefer</code> 的概念的話，則可以達到一樣將 Pod 給分散同時又不會出現 Pending 的狀況，因為此時的條件不是硬性規定，而是參考而已，所以前面兩個 Pod 都會盡量分散，而第三個 Pod 依然有能力被調度。</p><p>這時候得到的結果可能會是如下圖</p><p><img loading="lazy" src="/assets/images/BJ1n2_4n2-0139e32992f4b1266324d751a146fa5d.png" width="3508" height="1401" class="img_ev3q"></p><p>第二個範例準備兩個檔案，模擬服務 A 與 B 彼此之間的 Anti-Affinity 設定</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pod-affinity-3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: pod-affinity-3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: pod-affinity-3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: www-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: hwchiu/netutils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        podAntiAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - labelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - key: app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - pod-affinity-4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            topologyKey: &quot;kind.zone&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>該範例繼續使用 Anti-Affinity + required 的方式來限制，不過這次的參照對象是別的服務 <code>pod-affinity-4</code>，而環境中目前沒有這個服務出現</p><p>部署上不會出現問題，所有的 Pod 都可以正常運行，接者我們嘗試部署一個沒有任何 Affinity 的 <code>pod-affinity-4</code> 服務</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pod-affinity-4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: pod-affinity-4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: pod-affinity-4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: www-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: hwchiu/netutils</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以觀察到這時候 pod-affinity-4 這個服務卻卡 Pending 了
<img loading="lazy" src="/assets/images/rJrPpdN3n-d0d3e71460fae981b73d9dcb24b97789.png" width="3482" height="216" class="img_ev3q"></p><p>透過 <code>kubectl describe</code> 可以看到原因為是因為不滿足當下運行 Pod 的 Anti-Affinity。
<img loading="lazy" src="/assets/images/r1OipdN22-9ba4f13bcc6aac7701a9f18ad37d8cd2.png" width="3784" height="188" class="img_ev3q"></p><p>這也是設計文件中所描述的對稱性，因此即使後續服務沒有特別撰寫 Anti-Affinity，其調度的過程中也會根據當下其他 Pod 的資訊來判別是否可以調度</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="affinity">Affinity<a href="#affinity" class="hash-link" aria-label="Direct link to Affinity" title="Direct link to Affinity">​</a></h2><p>接下來基於相同概念來測試 Affinity，服務 A 依賴於 服務 B(pod-affinity-6)</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pod-affinity-5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: pod-affinity-5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: pod-affinity-5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: www-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: hwchiu/netutils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        podAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - labelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - key: app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - pod-affinity-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            topologyKey: &quot;kind.zone&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>與 <code>Anti-Affinity</code> 不同，若當下找不到目標服務， <code>Affinity</code> 則會卡在 Pending 的狀況，沒有辦法部署。
<img loading="lazy" src="/assets/images/SkZ1JtEn2-e9440049c129541857dade70787af6e4.png" width="3512" height="266" class="img_ev3q"></p><p>註: 若參考對象是自己則為特殊情況，不會有 Pending 的情況發生，否則會有 deadlock 的情形出現。</p><p>接下來部署服務 B</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pod-affinity-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: pod-affinity-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: pod-affinity-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: www-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: hwchiu/netutils</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>部署下去後可以觀察到服務 A 與 B 幾乎同時順利完成調度的決策，一起被分配到相同的 kind.zone 內
<img loading="lazy" src="/assets/images/HkKllKE23-f3af5ae9a89d57cf411b47428d4f6e16.png" width="3116" height="284" class="img_ev3q"></p><p>以過程中來說，最初的服務 A 因為找不到服務 B 可以匹配，所以全部卡 Pending 的狀況
<img loading="lazy" src="/assets/images/r1DebtNhh-dc71a3d2ae2e0e8970c757446bab356e.png" width="1918" height="954" class="img_ev3q"></p><p>而服務 B 本身沒有描述任何 Affinity 的規則，因此本身順利被調度
<img loading="lazy" src="/assets/images/SJzbWt432-734a12fd6df456d3177e7e4aff20ab66.png" width="1800" height="936" class="img_ev3q"></p><p>當服務 B 被調度到 kind.zone=zone1 後，所有卡住的服務 A 就有參照對象可以比較，所已全部 Pod 就直接部署上去了。
<img loading="lazy" src="/assets/images/HkJzWtVn3-c27aec0dd643a68fcc01a334608bcea0.png" width="1772" height="736" class="img_ev3q"></p><h1>PodTopologySpread</h1><p>前述所探討的 NodeAffinity 以及 Inter-Pod (Anti)Affinity 可以滿足許多人控制 Pod 調度的需求，然而實際使用上會遇到一些問題</p><ol><li>透過 NodeAffinity 並沒有保證 Pod 可以均勻的分散到各節點上，有可能會遇到分佈不均勻的情況 (<a href="https://github.com/kubernetes/kubernetes/issues/68981?WT.mc_id=AZ-MVP-5003331" target="_blank" rel="noopener noreferrer">66981</a>)</li><li>Inter-Pod Anti Affinity 碰到 Deployment rolling upgrade 時會出問題，新的 Pod 要先被創立但是因為 Anti-Affinity 的限制導致沒有節點可用，所以新版本的 Pod 就會處於 Pending 而整個 Deployment 更新就會卡死 <a href="https://github.com/kubernetes/kubernetes/issues/40358?WT.mc_id=AZ-MVP-5003331" target="_blank" rel="noopener noreferrer">40358</a></li></ol><p>因為上述問題所以就有了 <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-scheduling/895-pod-topology-spread#motivation" target="_blank" rel="noopener noreferrer">Pod Topology Spread</a> 的發展，而整個 <code>Pod Topology Spread</code> 中最重要的一個因素就稱為 Skew，該數值是用來處理 Pod 分配不均勻的問題，其定義為。</p><p>skew = Pods number matched in current topology - min Pods matches in a topology</p><p><code>PodTopologySpread</code> 每次分配 Pod 的時候都會針對每個節點計算當下的 Skew 數值並且以數值來影響調度的決策。</p><p>以下圖為範例</p><p><img loading="lazy" src="/assets/images/SkWAL7S33-08bbfe0f59afad8380f63e1af86df610.png" width="2288" height="832" class="img_ev3q"></p><ol><li><code>topologyKey</code> 將節點分成三群</li><li>每個群上面目前運行的 Pod 數量分別為 <code>3,2,1</code></li><li>群中最少的運行 Pod 數量為 1</li><li>分別計算可以得到每群對應的 Skew 數值為 2,1,0</li></ol><p>下列是透過 <code>kubectl explain</code> 得到的欄位介紹，由於篇幅過程所以只保留重點欄位，實際上還有很多選項不過部分選項即使到 v1.26 都還是 Beta 測試</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl explain pod.spec.topologySpreadConstraints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KIND:     Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VERSION:  v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESOURCE: topologySpreadConstraints &lt;[]Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DESCRIPTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     TopologySpreadConstraints describes how a group of pods ought to spread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     across topology domains. Scheduler will schedule pods in a way which abides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     by the constraints. All topologySpreadConstraints are ANDed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     TopologySpreadConstraint specifies how to spread matching pods among the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     given topology.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FIELDS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   labelSelector        &lt;Object&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     LabelSelector is used to find matching pods. Pods that match this label</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     selector are counted to determine the number of pods in their corresponding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     topology domain.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   maxSkew      &lt;integer&gt; -required-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     MaxSkew describes the degree to which pods may be unevenly distributed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     required field. Default value is 1 and 0 is not allowed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   topologyKey  &lt;string&gt; -required-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     TopologyKey is the key of node labels. Nodes that have a label with this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     key and identical values are considered to be in the same topology. We</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     consider each &lt;key, value&gt; as a &quot;bucket&quot;, and try to put balanced number of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     pods into each bucket. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   whenUnsatisfiable    &lt;string&gt; -required-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     WhenUnsatisfiable indicates how to deal with a pod if it doesn&#x27;t satisfy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Possible enum values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - `&quot;DoNotSchedule&quot;` instructs the scheduler not to schedule the pod when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     constraints are not satisfied.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - `&quot;ScheduleAnyway&quot;` instructs the scheduler to schedule the pod even if</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     constraints are not satisfied.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>maxSkew 則是用來控制 skew 的上限值，若 Pod 部署到該節點後會使得 Skew 超過此限制，則該節點就會被跳過</li><li>topologyKey 如同 Inter-Pod 的設定，用來判定如何分類節點</li><li>whenUnsatisfiable 則是用來設定當 maxSkew 找不到任何符合規則節點時該怎處理，可以卡在 Pending 狀態或是就忽略當前設定按照其他設定部署</li><li>labelSelector 則是用來選擇要把哪些 Pod 的數量納入考慮</li></ol><p>因此使用上很常透過下列方式讓 Pod 可以均勻地散落到不同的 Zone 內</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: www-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: hwchiu/netutils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  topologySpreadConstraints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - maxSkew: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    topologyKey: kind.zone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    whenUnsatisfiable: DoNotSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: pod-ts-1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果要細部調整現在還有下列參數可以使用，使用前請參閱<a href="https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/#example-one-topologyspreadconstraint" target="_blank" rel="noopener noreferrer">官方文件</a></p><ol><li>nodeAffinityPolicy: <!-- -->[Honor|Ignore]</li><li>nodeTaintsPolicy: <!-- -->[Honor|Ignore]</li><li>matchLabelKeys: list</li><li>minDomains: integer</li></ol><h1>Summary</h1><p>本系列文探討如何透過 Kubernetes 內建的方式來影響 Scheduler 調度的決策，這類型的設定能夠於 Zone/Region 等架構下達到更好的高可用性設定，此外若 Pod 之間有強烈依賴且希望網路延遲盡可能低的，也可以考慮用這類型的設定來處理。</p><p>使用上請務必確保理解每個欄位的意思，特別是當參數本身為 List 型態的時候，要確認一下其結果是基於 OR 或是 AND 的運算，以免發生結果與預期不符導致花費太多時間除錯。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/dev-ops">DevOps</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2023/k8s-1-28-sidecar"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Kubernetes 1.28 Sidecar Container 初體驗</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2023/k8s-assigning-pod"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">解密 Assigning Pod To Nodes(上)</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#anti-affinity" class="table-of-contents__link toc-highlight">Anti-Affinity</a></li><li><a href="#affinity" class="table-of-contents__link toc-highlight">Affinity</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3270a02e.js"></script>
<script src="/assets/js/main.b48a7a09.js"></script>
</body>
</html>