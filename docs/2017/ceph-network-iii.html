<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2017/ceph-network-iii" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Ceph Network Architecture 研究(三) | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.hwchiu.com/docs/2017/ceph-network-iii"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ceph Network Architecture 研究(三) | hwchiu learning note"><meta data-rh="true" name="description" content="Async 希望在與底層kernel socket進行I/O處理時是以 Async 的方式去運行，而不是像 Simple 一樣每條 connetion 都要開兩個 threads 來負責處理 read 跟 write。"><meta data-rh="true" property="og:description" content="Async 希望在與底層kernel socket進行I/O處理時是以 Async 的方式去運行，而不是像 Simple 一樣每條 connetion 都要開兩個 threads 來負責處理 read 跟 write。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.hwchiu.com/docs/2017/ceph-network-iii"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2017/ceph-network-iii" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2017/ceph-network-iii" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://L4HXL74VLW-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="hwchiu learning note" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5bc72551.css">
<link rel="preload" href="/assets/js/runtime~main.81c0ceb6.js" as="script">
<link rel="preload" href="/assets/js/main.da90dc4a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/DRBD-networking-structure">Drbd Networking Structure Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/DRBD-v9-0-Network-Work-Flow-ii">DRBD v9.0 Network Work Flow(ii)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/DRBD-v9-0-Network-Work-Flow">DRBD v9.0 Network Work Flow(i)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/android-http">How to download http file in Android</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/anki-tutorial">Anki 使用感想 (tutorial)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ceph-async-connection">Ceph Network - AsyncConnection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ceph-network-i">Ceph Network Architecture 研究(一)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ceph-network-ii">Ceph Network Architecture 研究(二)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2017/ceph-network-iii">Ceph Network Architecture 研究(三)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ceph-with-rdma">How to enable Ceph with RDMA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/docker-build-image">Docker image for Hexo (一)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/docker-hexo-ii">Docker image for Hexo (二)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/drbd-9-0-install-on-ubuntu-16-04">Install DRBD v9.0 on Ubuntu 16.04</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/jupyter-converter">Translate jupyter notebook to python script</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/lxr-server-with-docker">docker image for lxr server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/lxr-setup-with-multiple-projects">LXR Server With Multiple Projects</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/nat-loopback">NAT Lookback Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/onos-trllis-testing">ONOS Trellis Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ovs-dpdk-docker-2">OVS + DPDK + Docker 共同玩耍(二)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ovs-dpdk-docker">OVS + DPDK + Docker 共同玩耍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/paper-maglve">[論文導讀] Maglev: A Fast and Reliable Software Network Load Balancer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/paper-redesign-data-center">[論文導讀] Re-architecting datacenter networks and stacks for low latency and high performance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/rdma-introduction-i">RDMA Introduction (一)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/setup-mininet-like-environment">手把手打造仿 mininet 網路</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2017"><span itemprop="name">2017</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Ceph Network Architecture 研究(三)</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Introduction</h1><p><strong>Async</strong> 希望在與底層kernel socket進行I/O處理時是以 <strong>Async</strong> 的方式去運行，而不是像 <strong>Simple</strong> 一樣每條 connetion 都要開兩個 <strong>threads</strong> 來負責處理 read 跟 write。
而現在普遍人在撰寫 <strong>Network Programming</strong> 時，幾乎都會採用 event-driven 類型的方式來處理，如 select.</p><p>在 <strong>Async</strong> 中負責進行上述這類型 <strong>event-driven I/O</strong> 處理的就是 <strong>Event</strong> 物件
<strong>Event</strong> 是一個抽象的介面，提供API給上層的 <strong>Worker</strong> 使用，而各種不同的類型的 <strong>I/O</strong>  都必須要繼承<strong>Event</strong>物件，並且實作所有的API。
目前的Event物件中有提供下列實作</p><ul><li>DPDK</li><li>EPOLL</li><li>KQUEUE</li><li>SELECT</li></ul><p>在程式碼內，習慣以<strong>driver</strong>的字眼來稱呼這些方法，如 <strong>SelectDriver</strong>。</p><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0110   if (t == &quot;dpdk&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0111 #ifdef HAVE_DPDK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0112     driver = new DPDKDriver(cct);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0113 #endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0114   } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0115 #ifdef HAVE_EPOLL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0116   driver = new EpollDriver(cct);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0117 #else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0118 #ifdef HAVE_KQUEUE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0119   driver = new KqueueDriver(cct);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0120 #else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0121   driver = new SelectDriver(cct);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0122 #endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0123 #endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0124   }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Architecture</h1><p>整個 <strong>Event</strong> 由下列物件組成</p><ul><li>EventCallback</li><li>EventCenter</li><li>EventDriver</li></ul><p>接下來分別介紹這三個物件在整個運作中扮演的角色。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eventcallback">EventCallBack<a href="#eventcallback" class="hash-link" aria-label="Direct link to EventCallBack" title="Direct link to EventCallBack">​</a></h2><ul><li>當事件發生時，要怎處理的介面雛形，所有的 CallBack 都必須要繼承此介面同時實作 <code>do_request</code>， 此 function 會得到一個 input，告知哪一個 fd 有事件發生了，然後實作對應的事情即可</li><li>該 fd 到底是 read 還是 write 被呼叫，這個 <strong>EventCallBack</strong> 本身不處理，此邏輯交給 EventCenter 去處理，所以若你的 CallBack 要依據 read/write 有不同處理，請註冊兩種不同的 callBack 來使用</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0054 class EventCallback {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0055</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0056  public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0057   virtual void do_request(int fd_or_id) = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0058   virtual ~EventCallback() {}       // we want a virtual destructor!!!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0059 };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eventdriver">EventDriver<a href="#eventdriver" class="hash-link" aria-label="Direct link to EventDriver" title="Direct link to EventDriver">​</a></h2><ul><li>此物件是底層每個方法都需要實現的介面，基本上跟<strong>Event</strong>有關的操作都在這邊完成，譬如哪些<strong>fd</strong>要監聽，哪些不用，然後監聽結果為何等。</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0068 /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0069  * EventDriver is a wrap of event mechanisms depends on different OS.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0070  * For example, Linux will use epoll(2), BSD will use kqueue(2) and select will</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0071  * be used for worst condition.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0072  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0073 class EventDriver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0074  public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0075   virtual ~EventDriver() {}       // we want a virtual destructor!!!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0076   virtual int init(EventCenter *center, int nevent) = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0077   virtual int add_event(int fd, int cur_mask, int mask) = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0078   virtual int del_event(int fd, int cur_mask, int del_mask) = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0079   virtual int event_wait(vector&lt;FiredFileEvent&gt; &amp;fired_events, struct timeval *tp) = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0080   virtual int resize_events(int newsize) = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0081   virtual bool need_wakeup() { return true; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0082 };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="init">init<a href="#init" class="hash-link" aria-label="Direct link to init" title="Direct link to init">​</a></h3><ul><li>進行一些初始化的動作，以 <strong>select</strong> 為範例，就會將 read/write 的 FD 都初始化</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="add_event">add_event<a href="#add_event" class="hash-link" aria-label="Direct link to add_event" title="Direct link to add_event">​</a></h3><ul><li>加入一個新的 <strong>fd</strong> 到需要觀察的清單中，而 <strong>mask</strong> 則有三種類型，分別是初始化/可讀/可寫。</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0048 #define EVENT_NONE 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0049 #define EVENT_READABLE 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0050 #define EVENT_WRITABLE 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>以 <strong>select</strong> 為範例，此 function 就是將該 fd 加入到 <strong>fd set</strong> 中，同時更新當前最大 fd 數值</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="del_event">del_event<a href="#del_event" class="hash-link" aria-label="Direct link to del_event" title="Direct link to del_event">​</a></h3><ul><li>將一個目標 fd 從觀察清單中移除，譬如當連線斷線後，就不需要在監聽此事件。</li><li>以 <strong>select</strong> 為範例，就是使用 <code>FD_CLR</code> 將該 fd 清除</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="event_wait">event_wait<a href="#event_wait" class="hash-link" aria-label="Direct link to event_wait" title="Direct link to event_wait">​</a></h3><ul><li>這邊是真正重要的地方，此 function 會必須要真正去得到有哪些<strong>fd</strong>有對應的 event 產生，然後將這些 event收集起來。</li><li>呼叫此 function 時，必須要傳入一個含有 <strong>FiredFileEvent</strong> 的 vector以及 timeout 的時間</li><li>若這次等待中，有任何 <strong>event</strong> 被觸發，就將該 fd 放到該 vector 中即可。
FiredFileEvent 包含兩個成員，一個是發生事件的 fd，以及其對應的 mask (read/write)</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0063 struct FiredFileEvent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0064   int fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0065   int mask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0066 };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="resize_event">resize_event<a href="#resize_event" class="hash-link" aria-label="Direct link to resize_event" title="Direct link to resize_event">​</a></h3><ul><li>目前只有 kqueue 在使用，當加入新的 fd 超過當前容納數量，會透過此 function 去更新</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="need_wakup">need_wakup<a href="#need_wakup" class="hash-link" aria-label="Direct link to need_wakup" title="Direct link to need_wakup">​</a></h3><ul><li>預設是回傳 True，目前只有 DPDK 有重新定義，原因是因為 DPDK 跟其他三者 event-based 的模式不相同，主要是一直依賴 polling 的方式去問。
-這邊比較有趣的是，DPDK 這種 polling-based 的也一併放到<strong>event</strong>的架構中實作，不過因為還沒有看完<strong>DPDK</strong>的實作，還沒看清他是如何轉換這兩邊概念的。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eventcenter">EventCenter<a href="#eventcenter" class="hash-link" aria-label="Direct link to EventCenter" title="Direct link to EventCenter">​</a></h2><p>此介面是用來給上層使用的，在這邊將<strong>Event</strong>分成三大類，分別是</p><ul><li>read/write call-back event</li><li>time event (多少ms後執行）</li><li>external event (馬上執行，可以想成時間為 0 的 time event)</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0087 class EventCenter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0088  public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0102   struct FileEvent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0103     int mask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0104     EventCallbackRef read_cb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0105     EventCallbackRef write_cb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0106     FileEvent(): mask(0), read_cb(NULL), write_cb(NULL) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0107   };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0108</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0109   struct TimeEvent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0110     uint64_t id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0111     EventCallbackRef time_cb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0112</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0113     TimeEvent(): id(0), time_cb(NULL) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0114   };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0115</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0178   int process_time_events();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0201   // Used by internal thread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0202   int create_file_event(int fd, int mask, EventCallbackRef ctxt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0203   uint64_t create_time_event(uint64_t milliseconds, EventCallbackRef ctxt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0204   void delete_file_event(int fd, int mask);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0205   void delete_time_event(uint64_t id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0206   int process_events(int timeout_microseconds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0207   void wakeup();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>此物件內部還有在包含一個 <strong>Poller</strong> 的物件，主要是給DPDK使用</li><li>此外，針對非DPDK需要 wakeup 類型的 driver，如 EPOLL/KQUEUE/SELECT，實作了一個 read/write 的通知事件，為了避免 <strong>driver</strong> 卡在 <strong>wait</strong> 事件中，會透過 <code>pipe</code> 於本地創立一個專用的 FD，針對其 read fd 創造一個簡單的 read handler，單純讀取而已。</li><li>之後就透過一個只會寫入特定字元的 write event 使得該 driver 能夠從 wait 事件中出來。</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0038 class C_handle_notify : public EventCallback {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0039   EventCenter *center;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0040   CephContext *cct;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0041</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0042  public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0043   C_handle_notify(EventCenter *c, CephContext *cc): center(c), cct(cc) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0044   void do_request(int fd_or_id) override {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0045     char c[256];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0046     int r = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0047     do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0048       r = read(fd_or_id, c, sizeof(c));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0049       if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0050         if (errno != EAGAIN)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0051           ldout(cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read notify pipe failed: &quot; &lt;&lt; cpp_strerror(errno) &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0052       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0053     } while (r &gt; 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0054   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0055 };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0315 void EventCenter::wakeup()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0316 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0317   // No need to wake up since we never sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0318   if (!pollers.empty() || !driver-&gt;need_wakeup())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0319     return ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0320</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0321   ldout(cct, 2) &lt;&lt; __func__ &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0322   char buf = &#x27;c&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0323   // wake up &quot;event_wait&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0324   int n = write(notify_send_fd, &amp;buf, sizeof(buf));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0325   if (n &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0326     if (errno != EAGAIN) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0327       ldout(cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; write notify pipe failed: &quot; &lt;&lt; cpp_strerror(errno) &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0328       ceph_abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0329     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0330   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0331 }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="init-1">init<a href="#init-1" class="hash-link" aria-label="Direct link to init" title="Direct link to init">​</a></h3><p>此 function 會決定底層要跑哪種<strong>driver</strong>，主要會基於參數<strong>type</strong>以及當前系統的平台，Linux優先走<strong>Epoll</strong>,
FreeBSD則是<strong>Kqueue</strong>,兩種都不符合的話就走<strong>select</strong>。
接下來呼叫該 <strong>driver</strong>的 init。
如果該 dirver 需要 wakeup (目前是除了DPDK以外)</p><ul><li>透過 pipe 創建一對 local fd並且設定為 non-blocking</li><li>之後的 read/write notifier 會透過這對 fd 來傳輸。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="destructor">destructor<a href="#destructor" class="hash-link" aria-label="Direct link to destructor" title="Direct link to destructor">​</a></h3><ul><li>執行所有的 external events  並且從 queue 中移除。</li><li>若之前有透過 pipe 創立 local fd，將其關閉</li><li>移除 driver 以及供 wakup 使用的 notify_handler</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="set_owner">set_owner<a href="#set_owner" class="hash-link" aria-label="Direct link to set_owner" title="Direct link to set_owner">​</a></h3><ul><li>讓該 <strong>eventCenter</strong> 記住擁有的 <strong>thread</strong> 是誰<ul><li>此變數主要會給 <code>in_thread</code> 這隻 function 來比較當前呼叫 event 的人是否是其owner。</li></ul></li><li>創立一個(或是回傳已經存在的)全域的 event center<ul><li>此 global_cenets 是 <code>AssociatedCenters</code> 的物件</li><li>裡面會存放 id 與 thread 的 mapping 關係</li><li>主要是搭配 <code>submit_to</code> 使用，可以讓任意的人使用 <code>submit_to</code> 搭配特定的 id 馬上塞入一個 event 到對應的 thread 中</li></ul></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0095   struct AssociatedCenters {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0096     EventCenter *centers[MAX_EVENTCENTER];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0097     AssociatedCenters(CephContext *c) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0098       memset(centers, 0, MAX_EVENTCENTER * sizeof(EventCenter*));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0099     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0100   };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>若當前 driver 需要 wakeup，則創立一個 read evnet handler</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0196     if (driver-&gt;need_wakeup()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0197       notify_handler = new C_handle_notify(this, cct);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0198       int r = create_file_event(notify_receive_fd, EVENT_READABLE, notify_handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0199       assert(r == 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0200     }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create_file_event">create_file_event<a href="#create_file_event" class="hash-link" aria-label="Direct link to create_file_event" title="Direct link to create_file_event">​</a></h3><ul><li>必須是同個 thread 才能夠透過此 function 來加入 event。</li><li>若傳入的 fd 大小超過當前的 fd上限，則透過 driver-&gt;resize_events 來調整</li><li>透過 <code>_get_file_event(fd)</code> 取得當前 FD 對應的 FileEvent<ul><li>此物件主要記錄當前 FD 對應的 mask</li></ul></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0063 struct FiredFileEvent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0064   int fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0065   int mask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0066 };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>若該 fd 以前就有 event，且其 mask 跟這次要加入的 mask 相同，那代表沒有任何改變，沒有必要繼續往下執行，故直接跳掉</li><li>接下來透過 driver-&gt;add_event 去創立該 event<ul><li>也有可能是修改已經存在 event 的 mask (read/write)</li></ul></li><li>最後透過 mask 的數值設定其 read_cb/write_cb 對應的 event handler</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0237   event-&gt;mask |= mask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0238   if (mask &amp; EVENT_READABLE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0239     event-&gt;read_cb = ctxt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0240   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0241   if (mask &amp; EVENT_WRITABLE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0242     event-&gt;write_cb = ctxt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0243   }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="delete_file_event">delete_file_event<a href="#delete_file_event" class="hash-link" aria-label="Direct link to delete_file_event" title="Direct link to delete_file_event">​</a></h3><ul><li>跟 <code>create_file_event</code> 類似</li><li>若該 fd 超過目前已知FD的上限，代表有問題，輸出 log 並離開</li><li>透過 <code>_get_file_event(fd)</code> 取得該 fd 對應的 FileEvent</li><li>若對應的 mask 是0，代表此 fd 還沒有設定過任何的 event handler，所以不需要刪除，可以直接離開</li><li>呼叫 <code>driver-&gt;del_event</code> 刪除該 evnet</li><li>移除對應的 call back，並且修改該 event 的 mask</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0269   if (mask &amp; EVENT_READABLE &amp;&amp; event-&gt;read_cb) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0270     event-&gt;read_cb = nullptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0271   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0272   if (mask &amp; EVENT_WRITABLE &amp;&amp; event-&gt;write_cb) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0273     event-&gt;write_cb = nullptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0274   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0275</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0276   event-&gt;mask = event-&gt;mask &amp; (~mask);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create_time_event">create_time_event<a href="#create_time_event" class="hash-link" aria-label="Direct link to create_time_event" title="Direct link to create_time_event">​</a></h3><ul><li>透過 <code>clock_type::now()</code> 加上傳入的 <strong>microseconds</strong> 計算出 <strong>expire</strong> 的時間點<ul><li>使用 clock_type::time_point 當作該 event 要 expire 的時間點</li></ul></li><li>透過 multimap 記住每個 time_point 對應的 event Handler<ul><li><code>std::multimap&lt;clock_type::time_point, TimeEvent&gt; time_events</code></li></ul></li><li>最後用一個 map  記住當前 id　對應上述 multimap 紀錄<ul><li>id 則是用一個 global 的 time_event_next 來記住</li><li></li></ul></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0288   clock_type::time_point expire = clock_type::now() + std::chrono::microseconds(microseconds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0289   event.id = id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0290   event.time_cb = ctxt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0291   std::multimap&lt;clock_type::time_point, TimeEvent&gt;::value_type s_val(expire, event);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0292   auto it = time_events.insert(std::move(s_val));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0293   event_map[id] = it;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="delete_time_event">delete_time_event<a href="#delete_time_event" class="hash-link" aria-label="Direct link to delete_time_event" title="Direct link to delete_time_event">​</a></h3><ul><li>這邊是根據 id 來刪除對應的 time event</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0305   auto it = event_map.find(id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0306   if (it == event_map.end()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0307     ldout(cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; id=&quot; &lt;&lt; id &lt;&lt; &quot; not found&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0308     return ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0309   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0310</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0311   time_events.erase(it-&gt;second);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0312   event_map.erase(it);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="wakeup">wakeup<a href="#wakeup" class="hash-link" aria-label="Direct link to wakeup" title="Direct link to wakeup">​</a></h3><ul><li>判斷需不需要 wakeup<ul><li>若走DPDK，則需要看 pollers 是否空的，若非空則往下走</li><li>其餘總類都必須要 wakeup</li></ul></li><li>藉由寫入之前的 <code>notify_send_fd</code> 來叫起整 <code>event_wait</code></li><li>DPDK 的部分必須要再研究，私以為DPDK不應該下來，因為其 <code>notify_send_fd</code> 應該不會被初始化。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="process_time_events">process_time_events<a href="#process_time_events" class="hash-link" aria-label="Direct link to process_time_events" title="Direct link to process_time_events">​</a></h3><ul><li>處理所有的 time events</li><li>對於所有的 time event，如果當前的時間超過該 time event 的 expire time<ul><li>將該 event 從結構中移除</li><li>呼叫該 event 的 call back function</li><li>這邊傳入的是 ID，跟 FD 無關</li><li></li></ul></li><li>回傳這次總共處理了多少個 event</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="process_events">process_events<a href="#process_events" class="hash-link" aria-label="Direct link to process_events" title="Direct link to process_events">​</a></h3><ul><li>該 function 會傳入一個變數<code>timeout_microseconds</code>，這是給 driver 用的 timeout</li><li>符合下列情況，將 timeout 設定為0，這會讓 driver 變成 non-blocking<ul><li>存在外部 event</li><li>存在 poller</li></ul></li><li>否則，計算一下 timeout 的時候，讓 driver 會 block 一段時間</li><li>透過 driver-&gt;evnet_wait 去詢問當前有哪些 event ready 了</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0394   vector&lt;FiredFileEvent&gt; fired_events;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0395   numevents = driver-&gt;event_wait(fired_events, &amp;tv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0396   for (int j = 0; j &lt; numevents; j++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0419   }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>對於所有被觸發的 event, 呼叫對應的 read/write handler<ul><li>若某個 FD同時可以進行 read/write  且對應的 call back handler 是相同的，則執行完 read 後，就不執行 write了 (不確定原因)</li><li>&quot;可能&quot;是避免重複執行相同內容，因為 function 沒有辦法知道當前被叫起是 read or write event ready。</li></ul></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0405     if (event-&gt;mask &amp; fired_events[j].mask &amp; EVENT_READABLE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0406       rfired = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0407       cb = event-&gt;read_cb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0408       cb-&gt;do_request(fired_events[j].fd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0409     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0410</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0411     if (event-&gt;mask &amp; fired_events[j].mask &amp; EVENT_WRITABLE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0412       if (!rfired || event-&gt;read_cb != event-&gt;write_cb) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0413         cb = event-&gt;write_cb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0414         cb-&gt;do_request(fired_events[j].fd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0415       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0416     }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>嘗試執行 time_events，並且繼續記錄總共處理的 event 數量</li><li>若當前 external queue 內有東西，則將全部都執行完畢</li><li>若到現在都還沒有執行任何 event 且也不是 blocking mode，則呼叫 pollers去 polling 對應的 event，並且記錄下來總數</li><li>最後回傳總數量</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0421   if (trigger_time)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0422     numevents += process_time_events();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0423</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0424   if (external_num_events.load()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0425     external_lock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0426     deque&lt;EventCallbackRef&gt; cur_process;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0427     cur_process.swap(external_events);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0428     external_num_events.store(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0429     external_lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0430     while (!cur_process.empty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0431       EventCallbackRef e = cur_process.front();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0432       ldout(cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; do &quot; &lt;&lt; e &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0433       e-&gt;do_request(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0434       cur_process.pop_front();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0435       numevents++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0436     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0437   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0438</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0439   if (!numevents &amp;&amp; !blocking) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0440     for (uint32_t i = 0; i &lt; pollers.size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0441       numevents += pollers[i]-&gt;poll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0442   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0444   return numevents;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dispatch_event_external">dispatch_event_external<a href="#dispatch_event_external" class="hash-link" aria-label="Direct link to dispatch_event_external" title="Direct link to dispatch_event_external">​</a></h3><ul><li>將 event 存放到 <code>external_events</code> 內</li><li>看看 <code>external_num_events</code> 這個變數是不是0，若是0則代表可以 wake<ul><li>external_num_events 是個 atomic 類型的變數</li><li>用此變數來控管當前是否正在清除 external_queue 內的 event</li></ul></li><li>若符合下列條件，則呼叫 <code>wake</code> 將 event 叫起來<ul><li>caller 的 thread 跟真正擁有此 eventCenter 的 thread 是相同</li><li>前述的 <code>external_num_events</code> 決定當前需要</li></ul></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0450   external_events.push_back(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0451   bool wake = !external_num_events.load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0452   uint64_t num = ++external_num_events;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0453   external_lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0454   if (!in_thread() &amp;&amp; wake)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0455     wakeup();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="submit_to">submit_to<a href="#submit_to" class="hash-link" aria-label="Direct link to submit_to" title="Direct link to submit_to">​</a></h3><ul><li>此 function 可以將特定的 function 傳入給特定的 eventCenter，走 external event 的方式去執行</li><li>這邊的 event 會被包裝成 <strong>C_submit_event</strong><ul><li>這邊 <strong>do_eqeust</strong> 會透過 condition_variable 與 <strong>wait</strong>來溝通</li></ul></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0217   class C_submit_event : public EventCallback {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0218     std::mutex lock;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0219     std::condition_variable cond;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0220     bool done = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0221     func f;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0222     bool nonwait;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0223    public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0224     C_submit_event(func &amp;&amp;_f, bool nw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0225       : f(std::move(_f)), nonwait(nw) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0226     void do_request(int id) override {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0227       f();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0228       lock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0229       cond.notify_all();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0230       done = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0231       bool del = nonwait;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0232       lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0233       if (del)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0234         delete this;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0235     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0236     void wait() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0237       assert(!nonwait);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0238       std::unique_lock&lt;std::mutex&gt; l(lock);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0239       while (!done)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0240         cond.wait(l);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0241     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0242   };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>若 caller 跟該 EventCenter 屬於同個 thread，就直接執行了，不再塞到 exterbnl_queue</li><li>接下來根據變數中的 <strong>no_wait</strong>來決定要不要等待該 function 執行完畢</li><li>假如是 no_wait，則丟到 external_queue 後就直接離開</li><li>假如是 wait,則丟到 external_queue 後，<strong>馬上呼叫 wait()</strong>，等待 <strong>do_request()</strong>執行完畢後，會使得 <strong>wait</strong> 結束，然後離開此 function。</li></ul><h1>Summary</h1><p>整個 Event 系列的檔案其實不會太困難，除了 <strong>DPDK</strong> 本身還有額外的實作外，其餘 <strong>POSIX</strong> 系列的三種只要熟悉本身的用法，來看這些程式碼就不會覺得太陌生，所有的運作都可以想像的到，同時也在預料之中。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/ceph">Ceph</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/sds">SDS</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/source-code">SourceCode</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">Linux</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2017/ceph-network-ii"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ceph Network Architecture 研究(二)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2017/ceph-with-rdma"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">How to enable Ceph with RDMA</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#eventcallback" class="table-of-contents__link toc-highlight">EventCallBack</a></li><li><a href="#eventdriver" class="table-of-contents__link toc-highlight">EventDriver</a><ul><li><a href="#init" class="table-of-contents__link toc-highlight">init</a></li><li><a href="#add_event" class="table-of-contents__link toc-highlight">add_event</a></li><li><a href="#del_event" class="table-of-contents__link toc-highlight">del_event</a></li><li><a href="#event_wait" class="table-of-contents__link toc-highlight">event_wait</a></li><li><a href="#resize_event" class="table-of-contents__link toc-highlight">resize_event</a></li><li><a href="#need_wakup" class="table-of-contents__link toc-highlight">need_wakup</a></li></ul></li><li><a href="#eventcenter" class="table-of-contents__link toc-highlight">EventCenter</a><ul><li><a href="#init-1" class="table-of-contents__link toc-highlight">init</a></li><li><a href="#destructor" class="table-of-contents__link toc-highlight">destructor</a></li><li><a href="#set_owner" class="table-of-contents__link toc-highlight">set_owner</a></li><li><a href="#create_file_event" class="table-of-contents__link toc-highlight">create_file_event</a></li><li><a href="#delete_file_event" class="table-of-contents__link toc-highlight">delete_file_event</a></li><li><a href="#create_time_event" class="table-of-contents__link toc-highlight">create_time_event</a></li><li><a href="#delete_time_event" class="table-of-contents__link toc-highlight">delete_time_event</a></li><li><a href="#wakeup" class="table-of-contents__link toc-highlight">wakeup</a></li><li><a href="#process_time_events" class="table-of-contents__link toc-highlight">process_time_events</a></li><li><a href="#process_events" class="table-of-contents__link toc-highlight">process_events</a></li><li><a href="#dispatch_event_external" class="table-of-contents__link toc-highlight">dispatch_event_external</a></li><li><a href="#submit_to" class="table-of-contents__link toc-highlight">submit_to</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.81c0ceb6.js"></script>
<script src="/assets/js/main.da90dc4a.js"></script>
</body>
</html>