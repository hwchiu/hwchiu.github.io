<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2017/ceph-async-connection" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Ceph Network - AsyncConnection | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.hwchiu.com/docs/2017/ceph-async-connection"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ceph Network - AsyncConnection | hwchiu learning note"><meta data-rh="true" name="description" content="AsyncConnection 此物件代表整個 connection，裡面提供了收送(Write/Read)兩個主要介面供應用層(OSD/MON等)使用外，裡面也處理了整個 Ceph Node收送封包的邏輯處理，這部分比較像是一個 finite state machine(FSM)，當前狀態是什麼時候，收到的封包是什麼，就切換到什麼狀態來處理。"><meta data-rh="true" property="og:description" content="AsyncConnection 此物件代表整個 connection，裡面提供了收送(Write/Read)兩個主要介面供應用層(OSD/MON等)使用外，裡面也處理了整個 Ceph Node收送封包的邏輯處理，這部分比較像是一個 finite state machine(FSM)，當前狀態是什麼時候，收到的封包是什麼，就切換到什麼狀態來處理。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.hwchiu.com/docs/2017/ceph-async-connection"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2017/ceph-async-connection" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2017/ceph-async-connection" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://L4HXL74VLW-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="hwchiu learning note" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5bc72551.css">
<link rel="preload" href="/assets/js/runtime~main.9a4bf489.js" as="script">
<link rel="preload" href="/assets/js/main.77e0ace0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/DRBD-networking-structure">Drbd Networking Structure Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/DRBD-v9-0-Network-Work-Flow-ii">DRBD v9.0 Network Work Flow(ii)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/DRBD-v9-0-Network-Work-Flow">DRBD v9.0 Network Work Flow(i)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/android-http">How to download http file in Android</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/anki-tutorial">Anki 使用感想 (tutorial)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2017/ceph-async-connection">Ceph Network - AsyncConnection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ceph-network-i">Ceph Network Architecture 研究(一)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ceph-network-ii">Ceph Network Architecture 研究(二)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ceph-network-iii">Ceph Network Architecture 研究(三)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ceph-with-rdma">How to enable Ceph with RDMA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/docker-build-image">Docker image for Hexo (一)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/docker-hexo-ii">Docker image for Hexo (二)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/drbd-9-0-install-on-ubuntu-16-04">Install DRBD v9.0 on Ubuntu 16.04</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/jupyter-converter">Translate jupyter notebook to python script</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/lxr-server-with-docker">docker image for lxr server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/lxr-setup-with-multiple-projects">LXR Server With Multiple Projects</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/nat-loopback">NAT Lookback Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/onos-trllis-testing">ONOS Trellis Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ovs-dpdk-docker-2">OVS + DPDK + Docker 共同玩耍(二)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/ovs-dpdk-docker">OVS + DPDK + Docker 共同玩耍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/paper-maglve">[論文導讀] Maglev: A Fast and Reliable Software Network Load Balancer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/paper-redesign-data-center">[論文導讀] Re-architecting datacenter networks and stacks for low latency and high performance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/rdma-introduction-i">RDMA Introduction (一)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2017/setup-mininet-like-environment">手把手打造仿 mininet 網路</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2017"><span itemprop="name">2017</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Ceph Network - AsyncConnection</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Ceph Network - AsyncConnection</h1></header><p>AsyncConnection 此物件代表整個 connection，裡面提供了收送(Write/Read)兩個主要介面供應用層(OSD/MON等)使用外，裡面也處理了整個 <strong>Ceph Node</strong>收送封包的邏輯處理，這部分比較像是一個 <strong>finite state machine(FSM)</strong>，當前狀態是什麼時候，收到的封包是什麼，就切換到什麼狀態來處理。
每個 AsyncConnection 會像底層的 <strong>Event Engine</strong>註冊一個 <strong>call back function</strong>，當該 <strong>connection</strong> 接收到封包後，就會觸發該 <strong>function</strong>，而此 <strong>function</strong>就是 <strong>Process</strong>，所以接下來會從此 function 當作下手點，主要研究雙方連線建立的過程，特別是從 <strong>Service side</strong> 去觀察 <strong>Accept</strong> 封包後的流程。</p><h1>Accept</h1><ul><li>當 <strong>Server Side</strong> 呼叫此 <strong>function</strong>後，就會開始等待 <strong>client</strong>來連線。</li><li>將 socket 跟 addr 都記錄下來，並且將狀態改成 <strong>STATE_ACCEPTING</strong></li><li>發送一個 external event(read_handler) 給 eventCenter<ul><li>此 read_handler 就是 <code>process</code>，會一直根據當前 state 的狀態來進行各種處理</li></ul></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1866 void AsyncConnection::accept(ConnectedSocket socket, entity_addr_t &amp;addr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1867 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1868   ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; sd=&quot; &lt;&lt; socket.fd() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1869   assert(socket.fd() &gt;= 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1870</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1871   std::lock_guard&lt;std::mutex&gt; l(lock);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1872   cs = std::move(socket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1873   socket_addr = addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1874   state = STATE_ACCEPTING;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1875   // rescheduler connection in order to avoid lock dep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1876   center-&gt;dispatch_event_external(read_handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1877 }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Process</h1><p>當<strong>AsyncConnection</strong>有收到任何封包時，就會呼叫這個 <strong>function</strong>，我們這邊假設我們是 <strong>Server Side</strong>，然後當前 <strong>Socket</strong> 處於一種 <strong>Accepting</strong> 的狀態，在此狀態下收到連線的封包後，會怎麼處理。</p><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0329 void AsyncConnection::process()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0330 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0331   ssize_t r = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0332   int prev_state = state;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0333 #if defined(WITH_LTTNG) &amp;&amp; defined(WITH_EVENTTRACE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0334   utime_t ltt_recv_stamp = ceph_clock_now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0335 #endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0336   bool need_dispatch_writer = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0337   std::lock_guard&lt;std::mutex&gt; l(lock);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0338   last_active = ceph::coarse_mono_clock::now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0339   do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0340     ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; prev state is &quot; &lt;&lt; get_state_name(prev_state) &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0341     prev_state = state;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0342     switch (state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0343       case STATE_OPEN:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0837       default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0838         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0839           if (_process_connection() &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0840             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0841           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0842         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0843     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0844   } while (prev_state != state);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0845</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0846   if (need_dispatch_writer &amp;&amp; is_connected())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0847     center-&gt;dispatch_event_external(write_handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0848   return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0849</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0850  fail:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0851   fault();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0852 }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>基本上就是跑一個大迴圈，根據當前狀態處理不同的事情，直到狀態已經穩定 <strong>(prev_state == state)</strong>， 如果不符合大部分的 State，則呼叫 <code>_process_connection</code> 來處理，譬如 <strong>STATE_ACCEPTING</strong>。
一旦建立 <strong>Server Socket</strong>時並且開始透過 <strong>Accept</strong> 等待連線時，狀態則初始化為 <strong>STATE_ACCEPTING</strong>，所以接下來就從這個狀態開始往下研究。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_accepting">STATE_ACCEPTING<a href="#state_accepting" class="hash-link" aria-label="Direct link to STATE_ACCEPTING" title="Direct link to STATE_ACCEPTING">​</a></h2><ul><li>因為先前切換到此狀態時，是透過 <strong>external event</strong> 呼叫的(只會執行一次)，所以這邊要將該 <strong>readable event handler (process)</strong> 正式的丟給 <strong>event center</strong> 一次</li><li>接下來要發送一些訊息到對面去，這邊需要下列資訊<ul><li>CEPH_BANNER</li><li>Addr + Port</li></ul></li><li>呼叫 try_send 去發送訊息<ul><li>若成功 (r == 0), 狀態切換到 <strong>STATE_ACCEPTING_WAIT_BANNER_ADDR</strong></li><li>若失敗 (r &gt; 0),狀態切換到 <strong>STATE_WAIT_SEND</strong>，並且使用一個 <strong>strate_after_send</strong> 的變數來記住當成功送出後要切換成什麼狀態</li><li>若失敗 (r &lt; 0),真的失敗了，就當作失敗處理。</li></ul></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1215     case STATE_ACCEPTING:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1216       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1217         bufferlist bl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1218         center-&gt;create_file_event(cs.fd(), EVENT_READABLE, read_handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1219</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1220         bl.append(CEPH_BANNER, strlen(CEPH_BANNER));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1221</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1222         ::encode(async_msgr-&gt;get_myaddr(), bl, 0); // legacy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1223         port = async_msgr-&gt;get_myaddr().get_port();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1224         ::encode(socket_addr, bl, 0); // legacy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1225         ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; sd=&quot; &lt;&lt; cs.fd() &lt;&lt; &quot; &quot; &lt;&lt; socket_addr &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1226</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1227         r = try_send(bl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1228         if (r == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1229           state = STATE_ACCEPTING_WAIT_BANNER_ADDR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1230           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; write banner and addr done: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1231             &lt;&lt; get_peer_addr() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1232         } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1233           state = STATE_WAIT_SEND;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1234           state_after_send = STATE_ACCEPTING_WAIT_BANNER_ADDR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1235           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; wait for write banner and addr: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1236                               &lt;&lt; get_peer_addr() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1237         } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1238           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1239         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1240</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1241         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1242       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_accepting_wait_banner_addr">STATE_ACCEPTING_WAIT_BANNER_ADDR<a href="#state_accepting_wait_banner_addr" class="hash-link" aria-label="Direct link to STATE_ACCEPTING_WAIT_BANNER_ADDR" title="Direct link to STATE_ACCEPTING_WAIT_BANNER_ADDR">​</a></h2><ul><li>讀取對方的封包的資訊(代表 Client Side 也必須要發送相關訊息)<ul><li>CEPH_BANNER</li><li>Addr + Port</li></ul></li><li>比較 banner 資訊</li><li>若對方不知道自己的 addr，則透過 socket 的資訊取得並且記錄下來</li><li>狀態改成 <strong>STATE_ACCEPTING_WAIT_CONNECT_MSG</strong></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1243     case STATE_ACCEPTING_WAIT_BANNER_ADDR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1244       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1245         bufferlist addr_bl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1246         entity_addr_t peer_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1247</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1248         r = read_until(strlen(CEPH_BANNER) + sizeof(ceph_entity_addr), state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1249         if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1250           ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read peer banner and addr failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1251           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1252         } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1253           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1254         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1256         if (memcmp(state_buffer, CEPH_BANNER, strlen(CEPH_BANNER))) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1257           ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; accept peer sent bad banner &#x27;&quot; &lt;&lt; state_buffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1258                                     &lt;&lt; &quot;&#x27; (should be &#x27;&quot; &lt;&lt; CEPH_BANNER &lt;&lt; &quot;&#x27;)&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1259           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1260         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1261</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1262         addr_bl.append(state_buffer+strlen(CEPH_BANNER), sizeof(ceph_entity_addr));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1263         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1264           bufferlist::iterator ti = addr_bl.begin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1265           ::decode(peer_addr, ti);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1266         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1268         ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; accept peer addr is &quot; &lt;&lt; peer_addr &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1269         if (peer_addr.is_blank_ip()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1270           // peer apparently doesn&#x27;t know what ip they have; figure it out for them.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1271           int port = peer_addr.get_port();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1272           peer_addr.u = socket_addr.u;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1273           peer_addr.set_port(port);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1274           ldout(async_msgr-&gt;cct, 0) &lt;&lt; __func__ &lt;&lt; &quot; accept peer addr is really &quot; &lt;&lt; peer_addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1275                              &lt;&lt; &quot; (socket is &quot; &lt;&lt; socket_addr &lt;&lt; &quot;)&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1276         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1277         set_peer_addr(peer_addr);  // so that connection_state gets set up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1278         state = STATE_ACCEPTING_WAIT_CONNECT_MSG;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1279         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1280       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_accepting_wait_connect_msg">STATE_ACCEPTING_WAIT_CONNECT_MSG<a href="#state_accepting_wait_connect_msg" class="hash-link" aria-label="Direct link to STATE_ACCEPTING_WAIT_CONNECT_MSG" title="Direct link to STATE_ACCEPTING_WAIT_CONNECT_MSG">​</a></h2><ul><li>讀取 connect_msg 大小的資料,並且存放到 <strong>AsyncConnection</strong> 的成員 <strong>connect_msg</strong>中，該結構如下，紀錄了如 <strong>feature</strong>, <strong>type</strong> 等資訊。</li><li>最後將狀態轉換成 **
**</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0099 struct ceph_msg_connect {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0100     __le64 features;     /* supported feature bits */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0101     __le32 host_type;    /* CEPH_ENTITY_TYPE_* */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0102     __le32 global_seq;   /* count connections initiated by this host */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0103     __le32 connect_seq;  /* count connections initiated in this session */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0104     __le32 protocol_version;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0105     __le32 authorizer_protocol;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0106     __le32 authorizer_len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0107     __u8  flags;         /* CEPH_MSG_CONNECT_* */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0108 } __attribute__ ((packed));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1282     case STATE_ACCEPTING_WAIT_CONNECT_MSG:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1283       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1284         r = read_until(sizeof(connect_msg), state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1285         if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1286           ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read connect msg failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1287           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1288         } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1289           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1290         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1291</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1292         connect_msg = *((ceph_msg_connect*)state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1293         state = STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1294         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1295       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_accepting_wait_connect_msg_auth">STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH<a href="#state_accepting_wait_connect_msg_auth" class="hash-link" aria-label="Direct link to STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH" title="Direct link to STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH">​</a></h2><ul><li>根據之前讀取到的 <strong>connect_msg</strong> 來操作</li><li>如果對方有設定 authorizer_len 的話，則在額外讀取 authorizer 相關的資訊</li><li>設定 peer 的 host type</li><li>根據 host type，取得對應的 policy</li><li>呼叫 handle_connect_msg 處理該 connection_msg</li><li>最後確認狀態已經不是本來的 <strong>STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH</strong><ul><li>狀態理論上要因為呼叫了 <strong>handle_connect_msg</strong> 而變換，正常來說要變成 <strong>STATE_ACCEPTING_WAIT_SEQ</strong></li></ul></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1297     case STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1298       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1299         bufferlist authorizer_reply;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1301         if (connect_msg.authorizer_len) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1302           if (!authorizer_buf.length())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1303             authorizer_buf.push_back(buffer::create(connect_msg.authorizer_len));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1304</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1305           r = read_until(connect_msg.authorizer_len, authorizer_buf.c_str());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1306           if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1307             ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read connect authorizer failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1308             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1309           } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1310             break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1311           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1312         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1313</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1314         ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; accept got peer connect_seq &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1315                              &lt;&lt; connect_msg.connect_seq &lt;&lt; &quot; global_seq &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1316                              &lt;&lt; connect_msg.global_seq &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1317         set_peer_type(connect_msg.host_type);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1318         policy = async_msgr-&gt;get_policy(connect_msg.host_type);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1319         ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; accept of host_type &quot; &lt;&lt; connect_msg.host_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1320                                    &lt;&lt; &quot;, policy.lossy=&quot; &lt;&lt; policy.lossy &lt;&lt; &quot; policy.server=&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1321                                    &lt;&lt; policy.server &lt;&lt; &quot; policy.standby=&quot; &lt;&lt; policy.standby</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1322                                    &lt;&lt; &quot; policy.resetcheck=&quot; &lt;&lt; policy.resetcheck &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1323</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1324         r = handle_connect_msg(connect_msg, authorizer_buf, authorizer_reply);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1325         if (r &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1326           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1327</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1328         // state is changed by &quot;handle_connect_msg&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1329         assert(state != STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1330         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1331       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_accepting_wait_seq">STATE_ACCEPTING_WAIT_SEQ<a href="#state_accepting_wait_seq" class="hash-link" aria-label="Direct link to STATE_ACCEPTING_WAIT_SEQ" title="Direct link to STATE_ACCEPTING_WAIT_SEQ">​</a></h2><ul><li>從對面讀取其使用的 seq</li><li>呼叫 discard_requeued_up_to 來處理，根據當前收到的 seq 來做條件<ul><li>將 <strong>out_q</strong> 一些不符合條件的成員都移除</li></ul></li><li>狀態改成 <strong>STATE_ACCEPTING_READY</strong></li><li></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1333     case STATE_ACCEPTING_WAIT_SEQ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1334       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1335         uint64_t newly_acked_seq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1336         r = read_until(sizeof(newly_acked_seq), state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1337         if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1338           ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read ack seq failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1339           goto fail_registered;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1340         } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1341           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1342         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1343</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1344         newly_acked_seq = *((uint64_t*)state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1345         ldout(async_msgr-&gt;cct, 2) &lt;&lt; __func__ &lt;&lt; &quot; accept get newly_acked_seq &quot; &lt;&lt; newly_acked_seq &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1346         discard_requeued_up_to(newly_acked_seq);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1347         state = STATE_ACCEPTING_READY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1348         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1349       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_accepting_ready">STATE_ACCEPTING_READY<a href="#state_accepting_ready" class="hash-link" aria-label="Direct link to STATE_ACCEPTING_READY" title="Direct link to STATE_ACCEPTING_READY">​</a></h2><ul><li>清空 <strong>connect_msg</strong></li><li>狀態改成 <strong>STATE_OPEN</strong></li><li>如果當前 queue 內有資料(也許是先前 existing connection產生的?)，馬上送一個 write_handler 將其處理完畢</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1351     case STATE_ACCEPTING_READY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1352       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1353         ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; accept done&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1354         state = STATE_OPEN;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1355         memset(&amp;connect_msg, 0, sizeof(connect_msg));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1356</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1357         if (delay_state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1358           assert(delay_state-&gt;ready());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1359         // make sure no pending tick timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1360         if (last_tick_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1361           center-&gt;delete_time_event(last_tick_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1362         last_tick_id = center-&gt;create_time_event(inactive_timeout_us, tick_handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1363</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1364         write_lock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1365         can_write = WriteStatus::CANWRITE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1366         if (is_queued())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1367           center-&gt;dispatch_event_external(write_handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1368         write_lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1369         maybe_start_delay_thread();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1370         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1371       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_open">STATE_OPEN<a href="#state_open" class="hash-link" aria-label="Direct link to STATE_OPEN" title="Direct link to STATE_OPEN">​</a></h2><ul><li>讀取 TAG，根據 TAG 不同的數值執行不同的事情<ul><li>CEPH_MSGR_TAG_MSG: 代表有訊息近來，故將狀態切換成 STATE_OPEN_MESSAGE_HEADER</li></ul></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0343       case STATE_OPEN:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0344         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0345           char tag = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0346           r = read_until(sizeof(tag), &amp;tag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0347           if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0348             ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read tag failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0349             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0350           } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0351             break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0352           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0353</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0354           if (tag == CEPH_MSGR_TAG_KEEPALIVE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0355             ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; got KEEPALIVE&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0356             set_last_keepalive(ceph_clock_now());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0357           } else if (tag == CEPH_MSGR_TAG_KEEPALIVE2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0358             state = STATE_OPEN_KEEPALIVE2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0359           } else if (tag == CEPH_MSGR_TAG_KEEPALIVE2_ACK) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0360             state = STATE_OPEN_KEEPALIVE2_ACK;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0361           } else if (tag == CEPH_MSGR_TAG_ACK) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0362             state = STATE_OPEN_TAG_ACK;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0363           } else if (tag == CEPH_MSGR_TAG_MSG) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0364             state = STATE_OPEN_MESSAGE_HEADER;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0365           } else if (tag == CEPH_MSGR_TAG_CLOSE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0366             state = STATE_OPEN_TAG_CLOSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0367           } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0368             ldout(async_msgr-&gt;cct, 0) &lt;&lt; __func__ &lt;&lt; &quot; bad tag &quot; &lt;&lt; (int)tag &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0369             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0370           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0371</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0372           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0373         }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_open_message_header">STATE_OPEN_MESSAGE_HEADER<a href="#state_open_message_header" class="hash-link" aria-label="Direct link to STATE_OPEN_MESSAGE_HEADER" title="Direct link to STATE_OPEN_MESSAGE_HEADER">​</a></h2><ul><li>根據 feature 的值，決定要走新版還是舊版的 header</li><li>讀取 header 大小的資料，然後將需要的資料都抓出來記錄下來。</li><li>驗證對方送來資料的 CRC 是否正確</li><li>將相關資料給 reset (這些結構都跟 header 有關)<ul><li>data_buf</li><li>front</li><li>middle</li><li>data</li></ul></li><li>記錄收到時間的時間戳</li><li>將狀態改變成 <strong>STATE_OPEN_MESSAGE_THROTTLE_MESSAGE</strong></li></ul><div class="language-C++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0435       case STATE_OPEN_MESSAGE_HEADER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0436         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0437 #if defined(WITH_LTTNG) &amp;&amp; defined(WITH_EVENTTRACE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0438           ltt_recv_stamp = ceph_clock_now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0439 #endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0440           ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; begin MSG&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0441           ceph_msg_header header;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0442           ceph_msg_header_old oldheader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0443           __u32 header_crc = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0444           unsigned len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0445           if (has_feature(CEPH_FEATURE_NOSRCADDR))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0446             len = sizeof(header);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0447           else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0448             len = sizeof(oldheader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0449</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0450           r = read_until(len, state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0451           if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0452             ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read message header failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0453             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0454           } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0455             break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0456           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0457</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0458           ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; got MSG header&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0459</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0460           if (has_feature(CEPH_FEATURE_NOSRCADDR)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0461             header = *((ceph_msg_header*)state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0462             if (msgr-&gt;crcflags &amp; MSG_CRC_HEADER)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0463               header_crc = ceph_crc32c(0, (unsigned char *)&amp;header,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0464                                        sizeof(header) - sizeof(header.crc));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0465           } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0466             oldheader = *((ceph_msg_header_old*)state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0467             // this is fugly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0468             memcpy(&amp;header, &amp;oldheader, sizeof(header));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0469             header.src = oldheader.src.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0470             header.reserved = oldheader.reserved;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0471             if (msgr-&gt;crcflags &amp; MSG_CRC_HEADER) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0472               header.crc = oldheader.crc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0473               header_crc = ceph_crc32c(0, (unsigned char *)&amp;oldheader, sizeof(oldheader) - sizeof(oldheader.crc));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0474             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0475           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0476</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0477           ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; got envelope type=&quot; &lt;&lt; header.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0478                               &lt;&lt; &quot; src &quot; &lt;&lt; entity_name_t(header.src)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0479                               &lt;&lt; &quot; front=&quot; &lt;&lt; header.front_len</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0480                               &lt;&lt; &quot; data=&quot; &lt;&lt; header.data_len</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0481                               &lt;&lt; &quot; off &quot; &lt;&lt; header.data_off &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0482</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0483           // verify header crc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0484           if (msgr-&gt;crcflags &amp; MSG_CRC_HEADER &amp;&amp; header_crc != header.crc) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0485             ldout(async_msgr-&gt;cct,0) &lt;&lt; __func__ &lt;&lt; &quot; got bad header crc &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0486                                      &lt;&lt; header_crc &lt;&lt; &quot; != &quot; &lt;&lt; header.crc &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0487             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0488           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0489</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0490           // Reset state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0491           data_buf.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0492           front.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0493           middle.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0494           data.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0495           recv_stamp = ceph_clock_now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0496           current_header = header;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0497           state = STATE_OPEN_MESSAGE_THROTTLE_MESSAGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0498           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0499         }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_open_message_throttle_message">STATE_OPEN_MESSAGE_THROTTLE_MESSAGE<a href="#state_open_message_throttle_message" class="hash-link" aria-label="Direct link to STATE_OPEN_MESSAGE_THROTTLE_MESSAGE" title="Direct link to STATE_OPEN_MESSAGE_THROTTLE_MESSAGE">​</a></h2><ul><li>在 Policy 中有兩個關於 Throttle 的變數</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0085     /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0086      *  The throttler is used to limit how much data is held by Messages from</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0087      *  the associated Connection(s). When reading in a new Message, the Messenger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0088      *  will call throttler-&gt;throttle() for the size of the new Message.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0089      */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0090     Throttle *throttler_bytes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0091     Throttle *throttler_messages;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>這個 function 檢查是否有 <strong>throttle</strong> 訊息的數量限制，若有限制且超過上限，則建立一個 time event，並儲存下來。</li><li>最後將狀態切換到 <strong>STATE_OPEN_MESSAGE_THROTTLE_BYTES</strong></li></ul><div class="language-C++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0501       case STATE_OPEN_MESSAGE_THROTTLE_MESSAGE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0502         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0503           if (policy.throttler_messages) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0504             ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; wants &quot; &lt;&lt; 1 &lt;&lt; &quot; message from policy throttler &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0505                                        &lt;&lt; policy.throttler_messages-&gt;get_current() &lt;&lt; &quot;/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0506                                        &lt;&lt; policy.throttler_messages-&gt;get_max() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0507             if (!policy.throttler_messages-&gt;get_or_fail()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0508               ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; wants 1 message from policy throttle &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0509                                          &lt;&lt; policy.throttler_messages-&gt;get_current() &lt;&lt; &quot;/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0510                                          &lt;&lt; policy.throttler_messages-&gt;get_max() &lt;&lt; &quot; failed, just wait.&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0511               // following thread pool deal with th full message queue isn&#x27;t a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0512               // short time, so we can wait a ms.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0513               if (register_time_events.empty())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0514                 register_time_events.insert(center-&gt;create_time_event(1000, wakeup_handler));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0515               break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0516             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0517           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0518</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0519           state = STATE_OPEN_MESSAGE_THROTTLE_BYTES;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0520           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0521         }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_open_message_throttle_bytes">STATE_OPEN_MESSAGE_THROTTLE_BYTES;<a href="#state_open_message_throttle_bytes" class="hash-link" aria-label="Direct link to STATE_OPEN_MESSAGE_THROTTLE_BYTES;" title="Direct link to STATE_OPEN_MESSAGE_THROTTLE_BYTES;">​</a></h2><ul><li>從 <strong>connection</strong> 讀取資料，分別對應到 header 中的三個成員<ul><li>front</li><li>middle</li><li>data</li></ul></li><li>此 function 則是檢查 throttle 訊息的 bytes 數量，若數量超過上限，也是建議一個 time event並存下來，待之後處理</li><li>最後將狀態切換到 <strong>STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE</strong></li></ul><div class="language-C++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0523       case STATE_OPEN_MESSAGE_THROTTLE_BYTES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0524         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0525           cur_msg_size = current_header.front_len + current_header.middle_len + current_header.data_len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0526           if (cur_msg_size) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0527             if (policy.throttler_bytes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0528               ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; wants &quot; &lt;&lt; cur_msg_size &lt;&lt; &quot; bytes from policy throttler &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0529                                          &lt;&lt; policy.throttler_bytes-&gt;get_current() &lt;&lt; &quot;/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0530                                          &lt;&lt; policy.throttler_bytes-&gt;get_max() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0531               if (!policy.throttler_bytes-&gt;get_or_fail(cur_msg_size)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0532                 ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; wants &quot; &lt;&lt; cur_msg_size &lt;&lt; &quot; bytes from policy throttler &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0533                                            &lt;&lt; policy.throttler_bytes-&gt;get_current() &lt;&lt; &quot;/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0534                                            &lt;&lt; policy.throttler_bytes-&gt;get_max() &lt;&lt; &quot; failed, just wait.&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0535                 // following thread pool deal with th full message queue isn&#x27;t a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0536                 // short time, so we can wait a ms.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0537                 if (register_time_events.empty())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0538                   register_time_events.insert(center-&gt;create_time_event(1000, wakeup_handler));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0539                 break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0540               }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0541             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0542           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0543</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0544           state = STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0545           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0546         }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_open_message_throttle_dispatch_queue">STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE<a href="#state_open_message_throttle_dispatch_queue" class="hash-link" aria-label="Direct link to STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE" title="Direct link to STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE">​</a></h2><ul><li>如果剛剛有在 <strong>STATE_OPEN_MESSAGE_THROTTLE_BYTES</strong> 讀取到 front/middle/data 的資料的話，則這邊要確認 disaptch 本身的 throttle 有沒有超過，若超過也是送一個 time event 待稍後再來重新試試看</li><li>紀錄 throttle 的時間戳</li><li>狀態切換成 <strong>STATE_OPEN_MESSAGE_READ_FRONT</strong></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0548       case STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0549         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0550           if (cur_msg_size) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0551             if (!dispatch_queue-&gt;dispatch_throttler.get_or_fail(cur_msg_size)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0552               ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; wants &quot; &lt;&lt; cur_msg_size &lt;&lt; &quot; bytes from dispatch throttle &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0553                                          &lt;&lt; dispatch_queue-&gt;dispatch_throttler.get_current() &lt;&lt; &quot;/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0554                                          &lt;&lt; dispatch_queue-&gt;dispatch_throttler.get_max() &lt;&lt; &quot; failed, just wait.&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0555               // following thread pool deal with th full message queue isn&#x27;t a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0556               // short time, so we can wait a ms.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0557               if (register_time_events.empty())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0558                 register_time_events.insert(center-&gt;create_time_event(1000, wakeup_handler));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0559               break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0560             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0561           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0562</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0563           throttle_stamp = ceph_clock_now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0564           state = STATE_OPEN_MESSAGE_READ_FRONT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0565           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0566         }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_open_message_read_front">STATE_OPEN_MESSAGE_READ_FRONT<a href="#state_open_message_read_front" class="hash-link" aria-label="Direct link to STATE_OPEN_MESSAGE_READ_FRONT" title="Direct link to STATE_OPEN_MESSAGE_READ_FRONT">​</a></h2><ul><li>接下來就是開始讀取真正的封包資料了，主要是分成三個部分<ul><li>front</li><li>middle</li><li>data</li></ul></li><li>讀取前段資料，將內容先放到本身的 front 變數中</li><li>將狀態切成 <strong>STATE_OPEN_MESSAGE_READ_MIDDLE</strong></li></ul><div class="language-C++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0568       case STATE_OPEN_MESSAGE_READ_FRONT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0569         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0570           // read front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0571           unsigned front_len = current_header.front_len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0572           if (front_len) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0573             if (!front.length())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0574               front.push_back(buffer::create(front_len));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0575</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0576             r = read_until(front_len, front.c_str());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0577             if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0578               ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read message front failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0579               goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0580             } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0581               break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0582             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0583</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0584             ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; got front &quot; &lt;&lt; front.length() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0585           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0586           state = STATE_OPEN_MESSAGE_READ_MIDDLE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0587         }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_open_message_read_middle">STATE_OPEN_MESSAGE_READ_MIDDLE<a href="#state_open_message_read_middle" class="hash-link" aria-label="Direct link to STATE_OPEN_MESSAGE_READ_MIDDLE" title="Direct link to STATE_OPEN_MESSAGE_READ_MIDDLE">​</a></h2><ul><li>讀取中段資料，將內容先放到本身的 middle 變數中</li><li>將狀態切成 <strong>STATE_OPEN_MESSAGE_READ_DATA_PREPARE</strong></li></ul><div class="language-C++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0589       case STATE_OPEN_MESSAGE_READ_MIDDLE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0590         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0591           // read middle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0592           unsigned middle_len = current_header.middle_len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0593           if (middle_len) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0594             if (!middle.length())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0595               middle.push_back(buffer::create(middle_len));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0596</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0597             r = read_until(middle_len, middle.c_str());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0598             if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0599               ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read message middle failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0600               goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0601             } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0602               break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0603             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0604             ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; got middle &quot; &lt;&lt; middle.length() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0605           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0606</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0607           state = STATE_OPEN_MESSAGE_READ_DATA_PREPARE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0608         }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_open_message_read_data_prepare">STATE_OPEN_MESSAGE_READ_DATA_PREPARE<a href="#state_open_message_read_data_prepare" class="hash-link" aria-label="Direct link to STATE_OPEN_MESSAGE_READ_DATA_PREPARE" title="Direct link to STATE_OPEN_MESSAGE_READ_DATA_PREPARE">​</a></h2><ul><li>準備好 buffer 供之後讀取 data 用，其中 data 部分除了長度外，還有 <strong>offset</strong> 也要處理</li><li>這邊還不會讀取資料，只是會根據讀出來的空間長度預先配置一個空間供之後讀取資料使用</li><li>將狀態切成 STATE_OPEN_MESSAGE_READ_DATA</li></ul><div class="language-C++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0610       case STATE_OPEN_MESSAGE_READ_DATA_PREPARE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0611         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0612           // read data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0613           unsigned data_len = le32_to_cpu(current_header.data_len);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0614           unsigned data_off = le32_to_cpu(current_header.data_off);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0615           if (data_len) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0616             // get a buffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0617             map&lt;ceph_tid_t,pair&lt;bufferlist,int&gt; &gt;::iterator p = rx_buffers.find(current_header.tid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0618             if (p != rx_buffers.end()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0619               ldout(async_msgr-&gt;cct,10) &lt;&lt; __func__ &lt;&lt; &quot; seleting rx buffer v &quot; &lt;&lt; p-&gt;second.second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0620                                   &lt;&lt; &quot; at offset &quot; &lt;&lt; data_off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0621                                   &lt;&lt; &quot; len &quot; &lt;&lt; p-&gt;second.first.length() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0622               data_buf = p-&gt;second.first;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0623               // make sure it&#x27;s big enough</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0624               if (data_buf.length() &lt; data_len)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0625                 data_buf.push_back(buffer::create(data_len - data_buf.length()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0626               data_blp = data_buf.begin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0627             } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0628               ldout(async_msgr-&gt;cct,20) &lt;&lt; __func__ &lt;&lt; &quot; allocating new rx buffer at offset &quot; &lt;&lt; data_off &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0629               alloc_aligned_buffer(data_buf, data_len, data_off);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0630               data_blp = data_buf.begin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0631             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0632           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0633</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0634           msg_left = data_len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0635           state = STATE_OPEN_MESSAGE_READ_DATA;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0636         }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_open_message_read_data">STATE_OPEN_MESSAGE_READ_DATA<a href="#state_open_message_read_data" class="hash-link" aria-label="Direct link to STATE_OPEN_MESSAGE_READ_DATA" title="Direct link to STATE_OPEN_MESSAGE_READ_DATA">​</a></h2><ul><li>透過一個迴圈嘗試將資料讀取出來並且放到之前所預先配置的空間 <strong>DATA</strong></li><li>最後狀態切換到 <strong>STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH</strong></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0638       case STATE_OPEN_MESSAGE_READ_DATA:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0639         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0640           while (msg_left &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0641             bufferptr bp = data_blp.get_current_ptr();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0642             unsigned read = MIN(bp.length(), msg_left);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0643             r = read_until(read, bp.c_str());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0644             if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0645               ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read data error &quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0646               goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0647             } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0648               break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0649             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0650</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0651             data_blp.advance(read);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0652             data.append(bp, 0, read);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0653             msg_left -= read;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0654           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0655</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0656           if (msg_left &gt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0657             break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0658</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0659           state = STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0660         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0661</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_open_message_read_footer_and_dispatch">STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH<a href="#state_open_message_read_footer_and_dispatch" class="hash-link" aria-label="Direct link to STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH" title="Direct link to STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH">​</a></h2><ul><li>這個 function 比較長，不過可以說是最後一步驟了。</li><li>跟 header 一樣，根據 <strong>feature</strong> 決定使用新舊版本的 <strong>footer</strong> 格式</li><li>讀取 footer 的資料，如各區段的CRC等</li><li>透過 decode_message 此 function，將收集到的 (front, middle, data, footer.etc) 組合成一個完整的 <strong>message</strong> 格式的封包</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0270 Message *decode_message(CephContext *cct, int crcflags,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0271                         ceph_msg_header&amp; header,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0272                         ceph_msg_footer&amp; footer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0273                         bufferlist&amp; front, bufferlist&amp; middle,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0274                         bufferlist&amp; data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0315   // make message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0316   Message *m = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0317   int type = header.type;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0318   switch (type) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0319</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0320     // -- with payload --</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0321</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0322   case MSG_PGSTATS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0323     m = new MPGStats;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0324     break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0325   case MSG_PGSTATSACK:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0326     m = new MPGStatsAck;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0327     break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0328</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0329   case CEPH_MSG_STATFS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0330     m = new MStatfs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0331     break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0332   case CEPH_MSG_STATFS_REPLY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0333     m = new MStatfsReply;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0334     break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0335   case MSG_GETPOOLSTATS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0336     m = new MGetPoolStats;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0337     break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0338   case MSG_GETPOOLSTATSREPLY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0339     m = new MGetPoolStatsReply;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>針對該 message 設定一些相關屬性<ul><li>byte_throttler</li><li>message_throttler</li><li>dispatch_throttle_size</li><li>recv_stamp</li><li>throttle_stamp</li><li>recv_complete_stamp</li></ul></li><li>針對 sequence 進行一些判斷，當前的 message 可能中間有遺漏，或是很久以前的 message</li><li>將該 messaged 的 sequence 當作目前最後一個收到 sequence</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0765           // note last received message.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0766           in_seq.set(message-&gt;get_seq());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>將狀態改成 STATE_OPEN</li><li>將本訊息塞入到 dispatch_queue 內，供應用層去處理</li><li>到這邊就結束了，接下來 <strong>AsyncManager</strong> 去定期去檢查 <strong>dispatch_queue</strong>，當有封包進來後，就會將該封包送給所有註冊的 <strong>Dispatcher</strong> 去處理。</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0662       case STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0663         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0664           ceph_msg_footer footer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0665           ceph_msg_footer_old old_footer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0666           unsigned len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0667           // footer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0668           if (has_feature(CEPH_FEATURE_MSG_AUTH))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0669             len = sizeof(footer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0670           else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0671             len = sizeof(old_footer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0672</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0673           r = read_until(len, state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0674           if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0675             ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read footer data error &quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0676             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0677           } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0678             break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0679           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0680</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0681           if (has_feature(CEPH_FEATURE_MSG_AUTH)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0682             footer = *((ceph_msg_footer*)state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0683           } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0684             old_footer = *((ceph_msg_footer_old*)state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0685             footer.front_crc = old_footer.front_crc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0686             footer.middle_crc = old_footer.middle_crc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0687             footer.data_crc = old_footer.data_crc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0688             footer.sig = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0689             footer.flags = old_footer.flags;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0690           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0691           int aborted = (footer.flags &amp; CEPH_MSG_FOOTER_COMPLETE) == 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0692           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; aborted = &quot; &lt;&lt; aborted &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0693           if (aborted) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0694             ldout(async_msgr-&gt;cct, 0) &lt;&lt; __func__ &lt;&lt; &quot; got &quot; &lt;&lt; front.length() &lt;&lt; &quot; + &quot; &lt;&lt; middle.length() &lt;&lt; &quot; + &quot; &lt;&lt; data.length()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0695                                 &lt;&lt; &quot; byte message.. ABORTED&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0696             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0697           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0698</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0699           ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; got &quot; &lt;&lt; front.length() &lt;&lt; &quot; + &quot; &lt;&lt; middle.length()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0700                               &lt;&lt; &quot; + &quot; &lt;&lt; data.length() &lt;&lt; &quot; byte message&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0701           Message *message = decode_message(async_msgr-&gt;cct, async_msgr-&gt;crcflags, current_header, footer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0702                                             front, middle, data, this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0703           if (!message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0704             ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; decode message failed &quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0705             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0706           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0707</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0708           //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0709           //  Check the signature if one should be present.  A zero return indicates success. PLR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0710           //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0711</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0712           if (session_security.get() == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0713             ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; no session security set&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0714           } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0715             if (session_security-&gt;check_message_signature(message)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0716               ldout(async_msgr-&gt;cct, 0) &lt;&lt; __func__ &lt;&lt; &quot; Signature check failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0717               message-&gt;put();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0718               goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0719             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0720           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0721           message-&gt;set_byte_throttler(policy.throttler_bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0722           message-&gt;set_message_throttler(policy.throttler_messages);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0723</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0724           // store reservation size in message, so we don&#x27;t get confused</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0725           // by messages entering the dispatch queue through other paths.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0726           message-&gt;set_dispatch_throttle_size(cur_msg_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0727</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0728           message-&gt;set_recv_stamp(recv_stamp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0729           message-&gt;set_throttle_stamp(throttle_stamp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0730           message-&gt;set_recv_complete_stamp(ceph_clock_now());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0731</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0732           // check received seq#.  if it is old, drop the message.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0733           // note that incoming messages may skip ahead.  this is convenient for the client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0734           // side queueing because messages can&#x27;t be renumbered, but the (kernel) client will</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0735           // occasionally pull a message out of the sent queue to send elsewhere.  in that case</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0736           // it doesn&#x27;t matter if we &quot;got&quot; it or not.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0737           uint64_t cur_seq = in_seq.read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0738           if (message-&gt;get_seq() &lt;= cur_seq) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0739             ldout(async_msgr-&gt;cct,0) &lt;&lt; __func__ &lt;&lt; &quot; got old message &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0740                     &lt;&lt; message-&gt;get_seq() &lt;&lt; &quot; &lt;= &quot; &lt;&lt; cur_seq &lt;&lt; &quot; &quot; &lt;&lt; message &lt;&lt; &quot; &quot; &lt;&lt; *message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0741                     &lt;&lt; &quot;, discarding&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0742             message-&gt;put();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0743             if (has_feature(CEPH_FEATURE_RECONNECT_SEQ) &amp;&amp; async_msgr-&gt;cct-&gt;_conf-&gt;ms_die_on_old_message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0744               assert(0 == &quot;old msgs despite reconnect_seq feature&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0745             break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0746           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0747           if (message-&gt;get_seq() &gt; cur_seq + 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0748             ldout(async_msgr-&gt;cct, 0) &lt;&lt; __func__ &lt;&lt; &quot; missed message?  skipped from seq &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0749                                       &lt;&lt; cur_seq &lt;&lt; &quot; to &quot; &lt;&lt; message-&gt;get_seq() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0750             if (async_msgr-&gt;cct-&gt;_conf-&gt;ms_die_on_skipped_message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0751               assert(0 == &quot;skipped incoming seq&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0752           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0753</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0754           message-&gt;set_connection(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0755</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0756 #if defined(WITH_LTTNG) &amp;&amp; defined(WITH_EVENTTRACE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0757           if (message-&gt;get_type() == CEPH_MSG_OSD_OP || message-&gt;get_type() == CEPH_MSG_OSD_OPREPLY) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0758             utime_t ltt_processed_stamp = ceph_clock_now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0759             double usecs_elapsed = (ltt_processed_stamp.to_nsec()-ltt_recv_stamp.to_nsec())/1000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0760             ostringstream buf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0761             if (message-&gt;get_type() == CEPH_MSG_OSD_OP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0762               OID_ELAPSED_WITH_MSG(message, usecs_elapsed, &quot;TIME_TO_DECODE_OSD_OP&quot;, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0763             else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0764               OID_ELAPSED_WITH_MSG(message, usecs_elapsed, &quot;TIME_TO_DECODE_OSD_OPREPLY&quot;, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0765           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0766 #endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0767</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0768           // note last received message.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0769           in_seq.set(message-&gt;get_seq());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0770           ldout(async_msgr-&gt;cct, 5) &lt;&lt; &quot; rx &quot; &lt;&lt; message-&gt;get_source() &lt;&lt; &quot; seq &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0771                                     &lt;&lt; message-&gt;get_seq() &lt;&lt; &quot; &quot; &lt;&lt; message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0772                                     &lt;&lt; &quot; &quot; &lt;&lt; *message &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0773</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0774           if (!policy.lossy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0775             ack_left.inc();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0776             need_dispatch_writer = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0777           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0778           state = STATE_OPEN;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0779</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0780           logger-&gt;inc(l_msgr_recv_messages);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0781           logger-&gt;inc(l_msgr_recv_bytes, cur_msg_size + sizeof(ceph_msg_header) + sizeof(ceph_msg_footer));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0782</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0783           async_msgr-&gt;ms_fast_preprocess(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0784           if (delay_state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0785             utime_t release = message-&gt;get_recv_stamp();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0786             double delay_period = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0787             if (rand() % 10000 &lt; async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_delay_probability * 10000.0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0788               delay_period = async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_delay_max * (double)(rand() % 10000) / 10000.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0789               release += delay_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0790               ldout(async_msgr-&gt;cct, 1) &lt;&lt; &quot;queue_received will delay until &quot; &lt;&lt; release &lt;&lt; &quot; on &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0791                                         &lt;&lt; message &lt;&lt; &quot; &quot; &lt;&lt; *message &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0792             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0793             delay_state-&gt;queue(delay_period, release, message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0794           } else if (async_msgr-&gt;ms_can_fast_dispatch(message)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0795             lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0796             dispatch_queue-&gt;fast_dispatch(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0797             lock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0798           } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0799             dispatch_queue-&gt;enqueue(message, message-&gt;get_priority(), conn_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0800           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0801</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0802           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0803         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0804</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述已經大概跑完了整個 <strong>Accept</strong> 的流程，當然此流程中是確保沒有任何錯誤，一切都是順利往下進行的。
接下來來探討若 <strong>Client</strong> 想要連線，則會怎麼處理。</p><h1>Connect</h1><ul><li>當 AsyncMessager 創立 AsyncConnection時，就會先呼叫此 function 進行連線了，後續若有訊息發送時，會透過 <code>_connect</code>重新連線。</li><li>設定 peer 的 addr以及 policy</li><li>呼叫 _connect 完成最後的連線步驟</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0200   void connect(const entity_addr_t&amp; addr, int type) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0201     set_peer_type(type);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0202     set_peer_addr(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0203     policy = msgr-&gt;get_policy(type);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0204     _connect();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0205   }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>_connect</h1><ul><li>將狀態設定為 <strong>STATE_CONNECTING</strong>，接下來就將 <strong>read_handler</strong> 送給 <strong>Event Engine</strong>去處理，由於是透過 <strong>external event</strong>，所以則會馬上執行 <strong>read_handler</strong>，也就是 <strong>process</strong>。</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1856 void AsyncConnection::_connect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1857 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1858   ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; csq=&quot; &lt;&lt; connect_seq &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1859</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1860   state = STATE_CONNECTING;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1861   // rescheduler connection in order to avoid lock dep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1862   // may called by external thread(send_message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1863   center-&gt;dispatch_event_external(read_handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1864 }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_connecting">STATE_CONNECTING<a href="#state_connecting" class="hash-link" aria-label="Direct link to STATE_CONNECTING" title="Direct link to STATE_CONNECTING">​</a></h2><ul><li>檢查 cs 此變數，如果之前有連線過，則關閉先前的連線<ul><li>同時也先刪除之前的 event</li></ul></li><li>呼叫 worker 跟對方的 socket 去連線</li><li>創造一個 read_handler 的 event，來處理接下來收到封包的行為<ul><li>read_handler 就是 process</li></ul></li><li>狀態切換成 STATE_CONNECTING_RE</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0870     case STATE_CONNECTING:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0871       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0872         assert(!policy.server);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0873</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0874         // reset connect state variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0875         got_bad_auth = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0876         delete authorizer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0877         authorizer = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0878         authorizer_buf.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0879         memset(&amp;connect_msg, 0, sizeof(connect_msg));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0880         memset(&amp;connect_reply, 0, sizeof(connect_reply));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0881</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0882         global_seq = async_msgr-&gt;get_global_seq();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0883         // close old socket.  this is safe because we stopped the reader thread above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0884         if (cs) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0885           center-&gt;delete_file_event(cs.fd(), EVENT_READABLE|EVENT_WRITABLE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0886           cs.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0887         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0889         SocketOptions opts;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0890         opts.priority = async_msgr-&gt;get_socket_priority();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0891         opts.connect_bind_addr = msgr-&gt;get_myaddr();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0892         r = worker-&gt;connect(get_peer_addr(), opts, &amp;cs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0893         if (r &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0894           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0895</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0896         center-&gt;create_file_event(cs.fd(), EVENT_READABLE, read_handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0897         state = STATE_CONNECTING_RE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0898         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0899       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_connecting_re">STATE_CONNECTING_RE<a href="#state_connecting_re" class="hash-link" aria-label="Direct link to STATE_CONNECTING_RE" title="Direct link to STATE_CONNECTING_RE">​</a></h2><ul><li>檢查當前 connectionSocket 連線狀態，本身若發現沒有連線則會自己重新連線<ul><li>r &lt; 0, 連線依然失敗，則判定有問題， goto 離開</li><li>r == 1, 成功，不做事情</li><li>r == 0, 重連過程中有出現錯誤，可能是 EINPROGRESS  或是 EALREADY。</li></ul></li><li>嘗試送出 CEPH_BANNER</li><li>若成功，狀態切換成 <strong>STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY</strong></li><li>若失敗，狀態切換成 <strong>STATE_WAIT_SEND</strong>，待之後重送後再處理。</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0055   int is_connected() override {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0056     if (connected)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0057       return 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0058</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0059     int r = handler.reconnect(sa, _fd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0060     if (r == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0061       connected = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0062       return 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0063     } else if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0064       return r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0065     } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0066       return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0067     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0068   }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0901     case STATE_CONNECTING_RE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0902       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0903         r = cs.is_connected();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0904         if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0905           ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; reconnect failed &quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0906           if (r == -ECONNREFUSED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0907             ldout(async_msgr-&gt;cct, 2) &lt;&lt; __func__ &lt;&lt; &quot; connection refused!&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0908             dispatch_queue-&gt;queue_refused(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0909           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0910           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0911         } else if (r == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0912           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; nonblock connect inprogress&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0913           if (async_msgr-&gt;get_stack()-&gt;nonblock_connect_need_writable_event())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0914             center-&gt;create_file_event(cs.fd(), EVENT_WRITABLE, read_handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0915           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0916         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0917</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0918         center-&gt;delete_file_event(cs.fd(), EVENT_WRITABLE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0919         ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; connect successfully, ready to send banner&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0920</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0921         bufferlist bl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0922         bl.append(CEPH_BANNER, strlen(CEPH_BANNER));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0923         r = try_send(bl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0924         if (r == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0925           state = STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0926           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; connect write banner done: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0927                                      &lt;&lt; get_peer_addr() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0928         } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0929           state = STATE_WAIT_SEND;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0930           state_after_send = STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0931           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; connect wait for write banner: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0932                                &lt;&lt; get_peer_addr() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0933         } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0934           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0935         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0936</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0937         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0938       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0223 }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_connecting_wait_banner_and_identify">STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY<a href="#state_connecting_wait_banner_and_identify" class="hash-link" aria-label="Direct link to STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY" title="Direct link to STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY">​</a></h2><ul><li>讀取 SERVER 端送來的資訊<ul><li>CEPH_BANNER</li><li>Address (Server本身，以及Server看到的 Client)，所以有兩份。</li></ul></li><li>比較兩邊的 CEPH_BANNER</li><li>比較 peer addr (server address)<ul><li>我自己 socket 看到的</li><li>對方送過來的</li></ul></li><li>將自己的 address 送給 server</li><li>若成功，將狀態切換成 <strong>STATE_CONNECTING_SEND_CONNECT_MSG</strong></li><li>若失敗，將狀態切換成 <strong>STATE_WAIT_SEND</strong>，之後再處理。</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0940     case STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0941       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0942         entity_addr_t paddr, peer_addr_for_me;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0943         bufferlist myaddrbl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0944         unsigned banner_len = strlen(CEPH_BANNER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0945         unsigned need_len = banner_len + sizeof(ceph_entity_addr)*2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0946         r = read_until(need_len, state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0947         if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0948           ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read banner and identify addresses failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0949           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0950         } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0951           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0952         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0953</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0954         if (memcmp(state_buffer, CEPH_BANNER, banner_len)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0955           ldout(async_msgr-&gt;cct, 0) &lt;&lt; __func__ &lt;&lt; &quot; connect protocol error (bad banner) on peer &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0956                                     &lt;&lt; get_peer_addr() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0957           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0958         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0959</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0960         bufferlist bl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0961         bl.append(state_buffer+banner_len, sizeof(ceph_entity_addr)*2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0962         bufferlist::iterator p = bl.begin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0963         try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0964           ::decode(paddr, p);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0965           ::decode(peer_addr_for_me, p);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0966         } catch (const buffer::error&amp; e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0967           lderr(async_msgr-&gt;cct) &lt;&lt; __func__ &lt;&lt;  &quot; decode peer addr failed &quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0968           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0969         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0970         ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt;  &quot; connect read peer addr &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0971                              &lt;&lt; paddr &lt;&lt; &quot; on socket &quot; &lt;&lt; cs.fd() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0972         if (peer_addr != paddr) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0973           if (paddr.is_blank_ip() &amp;&amp; peer_addr.get_port() == paddr.get_port() &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0974               peer_addr.get_nonce() == paddr.get_nonce()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0975             ldout(async_msgr-&gt;cct, 0) &lt;&lt; __func__ &lt;&lt;  &quot; connect claims to be &quot; &lt;&lt; paddr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0976                                 &lt;&lt; &quot; not &quot; &lt;&lt; peer_addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0977                                 &lt;&lt; &quot; - presumably this is the same node!&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0978           } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0979             ldout(async_msgr-&gt;cct, 0) &lt;&lt; __func__ &lt;&lt; &quot; connect claims to be &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0980                                 &lt;&lt; paddr &lt;&lt; &quot; not &quot; &lt;&lt; peer_addr &lt;&lt; &quot; - wrong node!&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0981             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0982           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0983         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0984</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0985         ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; connect peer addr for me is &quot; &lt;&lt; peer_addr_for_me &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0986         lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0987         async_msgr-&gt;learned_addr(peer_addr_for_me);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0988         if (async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_internal_delays) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0989           if (rand() % async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_socket_failures == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0990             ldout(msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; sleep for &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0991                                  &lt;&lt; async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_internal_delays &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0992             utime_t t;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0993             t.set_from_double(async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_internal_delays);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0994             t.sleep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0995           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0996         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0997</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0998         lock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0999         if (state != STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1000           ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; state changed while learned_addr, mark_down or &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1001                                     &lt;&lt; &quot; replacing must be happened just now&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1002           return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1003         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1004</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1005         ::encode(async_msgr-&gt;get_myaddr(), myaddrbl, 0); // legacy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1006         r = try_send(myaddrbl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1007         if (r == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1008           state = STATE_CONNECTING_SEND_CONNECT_MSG;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1009           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; connect sent my addr &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1010               &lt;&lt; async_msgr-&gt;get_myaddr() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1011         } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1012           state = STATE_WAIT_SEND;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1013           state_after_send = STATE_CONNECTING_SEND_CONNECT_MSG;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1014           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; connect send my addr done: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1015               &lt;&lt; async_msgr-&gt;get_myaddr() &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1016         } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1017           ldout(async_msgr-&gt;cct, 2) &lt;&lt; __func__ &lt;&lt; &quot; connect couldn&#x27;t write my addr, &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1018               &lt;&lt; cpp_strerror(r) &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1019           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1020         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1021</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1022         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1023       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_connecting_send_connect_msg">STATE_CONNECTING_SEND_CONNECT_MSG<a href="#state_connecting_send_connect_msg" class="hash-link" aria-label="Direct link to STATE_CONNECTING_SEND_CONNECT_MSG" title="Direct link to STATE_CONNECTING_SEND_CONNECT_MSG">​</a></h2><ul><li>設定 <strong>connect_msg</strong> 的資訊<ul><li>如同之前所述，包含 <strong>featrue</strong>, <strong>type</strong>等。</li></ul></li><li>將該 <strong>connect_msg</strong> 的資訊封裝起來到 <strong>bl</strong>變數中，透過 <strong>try_send</strong>送出</li><li>若成功則將狀態切換到 <strong>STATE_CONNECTING_WAIT_CONNECT_REPLY</strong></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1025     case STATE_CONNECTING_SEND_CONNECT_MSG:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1026       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1027         if (!got_bad_auth) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1028           delete authorizer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1029           authorizer = async_msgr-&gt;get_authorizer(peer_type, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1030         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1031         bufferlist bl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1032</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1033         connect_msg.features = policy.features_supported;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1034         connect_msg.host_type = async_msgr-&gt;get_myinst().name.type();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1035         connect_msg.global_seq = global_seq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1036         connect_msg.connect_seq = connect_seq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1037         connect_msg.protocol_version = async_msgr-&gt;get_proto_version(peer_type, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1038         connect_msg.authorizer_protocol = authorizer ? authorizer-&gt;protocol : 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1039         connect_msg.authorizer_len = authorizer ? authorizer-&gt;bl.length() : 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1040         if (authorizer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1041           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt;  &quot; connect_msg.authorizer_len=&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1042                                      &lt;&lt; connect_msg.authorizer_len &lt;&lt; &quot; protocol=&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1043                                      &lt;&lt; connect_msg.authorizer_protocol &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1044         connect_msg.flags = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1045         if (policy.lossy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1046           connect_msg.flags |= CEPH_MSG_CONNECT_LOSSY;  // this is fyi, actually, server decides!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1047         bl.append((char*)&amp;connect_msg, sizeof(connect_msg));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1048         if (authorizer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1049           bl.append(authorizer-&gt;bl.c_str(), authorizer-&gt;bl.length());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1050         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1051         ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; connect sending gseq=&quot; &lt;&lt; global_seq &lt;&lt; &quot; cseq=&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1052             &lt;&lt; connect_seq &lt;&lt; &quot; proto=&quot; &lt;&lt; connect_msg.protocol_version &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1053</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1054         r = try_send(bl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1055         if (r == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1056           state = STATE_CONNECTING_WAIT_CONNECT_REPLY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1057           ldout(async_msgr-&gt;cct,20) &lt;&lt; __func__ &lt;&lt; &quot; connect wrote (self +) cseq, waiting for reply&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1058         } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1059           state = STATE_WAIT_SEND;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1060           state_after_send = STATE_CONNECTING_WAIT_CONNECT_REPLY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1061           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; continue send reply &quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1062         } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1063           ldout(async_msgr-&gt;cct, 2) &lt;&lt; __func__ &lt;&lt; &quot; connect couldn&#x27;t send reply &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1064               &lt;&lt; cpp_strerror(r) &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1065           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1066         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1067</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1068         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1069       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_connecting_wait_connect_reply">STATE_CONNECTING_WAIT_CONNECT_REPLY<a href="#state_connecting_wait_connect_reply" class="hash-link" aria-label="Direct link to STATE_CONNECTING_WAIT_CONNECT_REPLY" title="Direct link to STATE_CONNECTING_WAIT_CONNECT_REPLY">​</a></h2><ul><li>從 <strong>Server</strong> 端讀取資料，將資料放到 <strong>state_buffer</strong>，此資料的格式為 <strong>ceph_msg_connect_reply</strong></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0110 struct ceph_msg_connect_reply {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0111     __u8 tag;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0112     __le64 features;     /* feature bits for this session */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0113     __le32 global_seq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0114     __le32 connect_seq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0115     __le32 protocol_version;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0116     __le32 authorizer_len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0117     __u8 flags;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0118 } __attribute__ ((packed));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>將此資訊記錄下來後，狀態切換成 <strong>STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH</strong></li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1071     case STATE_CONNECTING_WAIT_CONNECT_REPLY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1072       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1073         r = read_until(sizeof(connect_reply), state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1074         if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1075           ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read connect reply failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1076           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1077         } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1078           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1079         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1081         connect_reply = *((ceph_msg_connect_reply*)state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1082</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1083         ldout(async_msgr-&gt;cct, 20) &lt;&lt; __func__ &lt;&lt; &quot; connect got reply tag &quot; &lt;&lt; (int)connect_reply.tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1084                              &lt;&lt; &quot; connect_seq &quot; &lt;&lt; connect_reply.connect_seq &lt;&lt; &quot; global_seq &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1085                              &lt;&lt; connect_reply.global_seq &lt;&lt; &quot; proto &quot; &lt;&lt; connect_reply.protocol_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1086                              &lt;&lt; &quot; flags &quot; &lt;&lt; (int)connect_reply.flags &lt;&lt; &quot; features &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1087                              &lt;&lt; connect_reply.features &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1088         state = STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1089</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1090         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1091       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_connecting_wait_connect_reply_auth">STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH<a href="#state_connecting_wait_connect_reply_auth" class="hash-link" aria-label="Direct link to STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH" title="Direct link to STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH">​</a></h2><ul><li>若前述回傳的 <strong>ceph_msg_connect_reply</strong> 有 <strong>authorizer</strong> 的資訊，則進行額外處理。</li><li>最後呼叫 <code>handle_connect_reply</code> 進行處理<ul><li>理論上 <strong>handle_connect_reply</strong> 會改變當前狀態，最後變成 <strong>STATE_CONNECTING_READY</strong></li></ul></li><li>上述處理完畢後，狀態必須要改變，若沒有代表有問題，直接 <strong>Assert</strong></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1093     case STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1094       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1095         bufferlist authorizer_reply;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1096         if (connect_reply.authorizer_len) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1097           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; reply.authorizer_len=&quot; &lt;&lt; connect_reply.authorizer_len &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1098           assert(connect_reply.authorizer_len &lt; 4096);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1099           r = read_until(connect_reply.authorizer_len, state_buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1100           if (r &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1101             ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read connect reply authorizer failed&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1102             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1103           } else if (r &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1104             break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1105           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1106</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1107           authorizer_reply.append(state_buffer, connect_reply.authorizer_len);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1108           bufferlist::iterator iter = authorizer_reply.begin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1109           if (authorizer &amp;&amp; !authorizer-&gt;verify_reply(iter)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1110             ldout(async_msgr-&gt;cct, 0) &lt;&lt; __func__ &lt;&lt; &quot; failed verifying authorize reply&quot; &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1111             goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1112           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1113         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1114         r = handle_connect_reply(connect_msg, connect_reply);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1115         if (r &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1116           goto fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1117</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1118         // state must be changed!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1119         assert(state != STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1120         break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1121       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state_connecting_ready">STATE_CONNECTING_READY<a href="#state_connecting_ready" class="hash-link" aria-label="Direct link to STATE_CONNECTING_READY" title="Direct link to STATE_CONNECTING_READY">​</a></h2><ul><li>這邊有個有趣的註解 <strong>// hooray!</strong>，代表到這一步連線基本上已經完成了，剩下最後一步驟就結束了。</li><li>對 dispatch_queue 設定當前 connection<ul><li>dispatch_queue 這邊有兩種類型，一種是存放 message，一種則是 Type + Connection，這邊屬於第二種</li><li>在 dispatch_queue 的 loop 中，會針對這兩種去處理，若是 messag 的，則直接將此訊息丟給所有註冊的 dispatcher，反之則根據 type 執行不同的任務</li><li>這邊放入的是 D_CONNECT 的 event，所以之後會執行 <code>ms_deliver_handle_connect</code> 這支 function。</li><li>接者這支 function 則是會通知所有 dispathcer 目前有新的連線到來，呼叫對應的 <code>ms_handle_connect</code>來處理</li></ul></li><li>呼叫 AsyncMessegner 內的 <strong>ms_deliver_handle_fast_connect</strong><ul><li>fast_connect 相對於 connect 是更早會處理的函式，底層可確保此 function 一定會在有任何 message 被處理前先呼叫。</li></ul></li><li>如果當前 queue 內有訊息，這時候再發送一個外部的 write_handler把queue給清空。<ul><li>可能是由於先前的 try_send 沒有成功</li></ul></li><li>到這邊後，連線就完成了，可以開始供應用層各種發送訊息了。</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1163     case STATE_CONNECTING_READY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1164       {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1165         // hooray!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1166         peer_global_seq = connect_reply.global_seq;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0155     while (!mqueue.empty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0156       QueueItem qitem = mqueue.dequeue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0157       if (!qitem.is_code())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0158         remove_arrival(qitem.get_message());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0159       lock.Unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0160</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0161       if (qitem.is_code()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0162         if (cct-&gt;_conf-&gt;ms_inject_internal_delays &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0163             cct-&gt;_conf-&gt;ms_inject_delay_probability &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0164             (rand() % 10000)/10000.0 &lt; cct-&gt;_conf-&gt;ms_inject_delay_probability) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0165           utime_t t;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0166           t.set_from_double(cct-&gt;_conf-&gt;ms_inject_internal_delays);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0167           ldout(cct, 1) &lt;&lt; &quot;DispatchQueue::entry  inject delay of &quot; &lt;&lt; t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0168                         &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0169           t.sleep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0170         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0171         switch (qitem.get_code()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0172         case D_BAD_REMOTE_RESET:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0173           msgr-&gt;ms_deliver_handle_remote_reset(qitem.get_connection());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0174           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0175         case D_CONNECT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0176           msgr-&gt;ms_deliver_handle_connect(qitem.get_connection());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0177           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0178         case D_ACCEPT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0179           msgr-&gt;ms_deliver_handle_accept(qitem.get_connection());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0180           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0181         case D_BAD_RESET:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0182           msgr-&gt;ms_deliver_handle_reset(qitem.get_connection());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0183           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0184         case D_CONN_REFUSED:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0185           msgr-&gt;ms_deliver_handle_refused(qitem.get_connection());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0186           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0187         default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0188           ceph_abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0189         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0190       } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0191         Message *m = qitem.get_message();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0192         if (stop) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0193           ldout(cct,10) &lt;&lt; &quot; stop flag set, discarding &quot; &lt;&lt; m &lt;&lt; &quot; &quot; &lt;&lt; *m &lt;&lt; dendl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0194           m-&gt;put();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0195         } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0196           uint64_t msize = pre_dispatch(m);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0197           msgr-&gt;ms_deliver_dispatch(m);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0198           post_dispatch(m, msize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0199         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0610   /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0611    * Notify each Dispatcher of a new Connection. Call</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0612    * this function whenever a new Connection is initiated or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0613    * reconnects.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0614    *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0615    * @param con Pointer to the new Connection.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0616    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0617   void ms_deliver_handle_connect(Connection *con) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0618     for (list&lt;Dispatcher*&gt;::iterator p = dispatchers.begin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0619          p != dispatchers.end();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0620          ++p)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0621       (*p)-&gt;ms_handle_connect(con);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0622   }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0110   /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0111    * This function will be called synchronously whenever a Connection is</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0112    * newly-created or reconnects in the Messenger, if you support fast</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0113    * dispatch. It is guaranteed to be called before any messages are</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0114    * dispatched.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0115    *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0116    * @param con The new Connection which has been established. You are not</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0117    * granted a reference to it -- take one if you need one!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0118    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0119   virtual void ms_handle_fast_connect(Connection *con) {}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述在 <strong>Accpeting</strong> 或者是 <strong>Connecting</strong> 的過程中，會透過下列兩個方式做一些深層的處理，這些處理同時會改變當前狀態，這邊就簡單大致上看過而已。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="handle_connect_reply">handle_connect_reply<a href="#handle_connect_reply" class="hash-link" aria-label="Direct link to handle_connect_reply" title="Direct link to handle_connect_reply">​</a></h2><ul><li>根據 reply 內的 tag 類型來執行各種不同事情, 大部分都是錯誤相關的處理，若一切都正常的話，則會是<code>CEPH_MSGR_TAG_READY</code>，此時會將狀態切換成 STATE_CONNECTING_READY<ul><li>CEPH_MSGR_TAG_FEATURES</li><li>CEPH_MSGR_TAG_BADPROTOVER</li><li>CEPH_MSGR_TAG_BADAUTHORIZER</li><li>CEPH_MSGR_TAG_RESETSESSION</li><li>CEPH_MSGR_TAG_RETRY_GLOBAL</li><li>CEPH_MSGR_TAG_RETRY_SESSION</li><li>CEPH_MSGR_TAG_WAIT</li><li>CEPH_MSGR_TAG_SEQ</li><li>CEPH_MSGR_TAG_READY</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="handle_connect_msg">handle_connect_msg<a href="#handle_connect_msg" class="hash-link" aria-label="Direct link to handle_connect_msg" title="Direct link to handle_connect_msg">​</a></h2><ul><li>根據 peer type 取得對應的 proto_version，放到 ceph_msg_connect_reply 的變數中</li></ul><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0671       case CEPH_ENTITY_TYPE_OSD: return CEPH_OSDC_PROTOCOL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0672       case CEPH_ENTITY_TYPE_MDS: return CEPH_MDSC_PROTOCOL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0673       case CEPH_ENTITY_TYPE_MON: return CEPH_MONC_PROTOCOL;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>若兩邊的 proto_version 不一致，則呼叫 <code>_reply_aceept</code> 去處理。</li><li>若對方有要使用 cephX<ul><li>根據不同的 protocol type (OSD/MDS/MOM) 進行不同的處理</li></ul></li><li>檢查兩邊的 feature set 是否滿足彼此，若有問題則呼叫 <code>_reply_accept</code> 去處理</li><li>進行用戶驗證，失敗則呼叫 <code>_reply_accept</code></li><li>若以前 peer addr 曾經有 connection 存在過，這時候就要進行一些處理，主要的處理都是基於兩個變數來決定，global_seq 以及 connect_seq<ul><li>global_seq 代表的是這個host已經建立過多少條 connection</li><li>connect_seq 代表的是這個 session建立過多少條 connection</li></ul></li><li>某些情況下，會嘗試捨棄舊有的 connection 並建立新的 connection 來使用</li><li>某些情況則是會繼續使用舊有的 connection，然後把一些新的資訊賦予到舊有 connection 的成員中</li><li>呼叫 accept_conn 將連線給記錄下來放到 conns 中，並且從 accepting_conns 中移除，</li><li>最後則將狀態改成 STATE_ACCEPTING_WAIT_SEQ</li></ul><h1>Summary</h1><p>此 <strong>AsyncConnection</strong> 內容眾多，目前先主要觀察到整個建立連線的步驟，包含了 <strong>Accept</strong> 以及 <strong>connect</strong> 。
有機會再來把 <strong>read/write</strong> 相關的介面也都看一次，到時候可以更瞭解整體收送的行為。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/ceph">Ceph</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/sds">SDS</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/source-code">SourceCode</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">Linux</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2017/anki-tutorial"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Anki 使用感想 (tutorial)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2017/ceph-network-i"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Ceph Network Architecture 研究(一)</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#state_accepting" class="table-of-contents__link toc-highlight">STATE_ACCEPTING</a></li><li><a href="#state_accepting_wait_banner_addr" class="table-of-contents__link toc-highlight">STATE_ACCEPTING_WAIT_BANNER_ADDR</a></li><li><a href="#state_accepting_wait_connect_msg" class="table-of-contents__link toc-highlight">STATE_ACCEPTING_WAIT_CONNECT_MSG</a></li><li><a href="#state_accepting_wait_connect_msg_auth" class="table-of-contents__link toc-highlight">STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH</a></li><li><a href="#state_accepting_wait_seq" class="table-of-contents__link toc-highlight">STATE_ACCEPTING_WAIT_SEQ</a></li><li><a href="#state_accepting_ready" class="table-of-contents__link toc-highlight">STATE_ACCEPTING_READY</a></li><li><a href="#state_open" class="table-of-contents__link toc-highlight">STATE_OPEN</a></li><li><a href="#state_open_message_header" class="table-of-contents__link toc-highlight">STATE_OPEN_MESSAGE_HEADER</a></li><li><a href="#state_open_message_throttle_message" class="table-of-contents__link toc-highlight">STATE_OPEN_MESSAGE_THROTTLE_MESSAGE</a></li><li><a href="#state_open_message_throttle_bytes" class="table-of-contents__link toc-highlight">STATE_OPEN_MESSAGE_THROTTLE_BYTES;</a></li><li><a href="#state_open_message_throttle_dispatch_queue" class="table-of-contents__link toc-highlight">STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE</a></li><li><a href="#state_open_message_read_front" class="table-of-contents__link toc-highlight">STATE_OPEN_MESSAGE_READ_FRONT</a></li><li><a href="#state_open_message_read_middle" class="table-of-contents__link toc-highlight">STATE_OPEN_MESSAGE_READ_MIDDLE</a></li><li><a href="#state_open_message_read_data_prepare" class="table-of-contents__link toc-highlight">STATE_OPEN_MESSAGE_READ_DATA_PREPARE</a></li><li><a href="#state_open_message_read_data" class="table-of-contents__link toc-highlight">STATE_OPEN_MESSAGE_READ_DATA</a></li><li><a href="#state_open_message_read_footer_and_dispatch" class="table-of-contents__link toc-highlight">STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH</a></li><li><a href="#state_connecting" class="table-of-contents__link toc-highlight">STATE_CONNECTING</a></li><li><a href="#state_connecting_re" class="table-of-contents__link toc-highlight">STATE_CONNECTING_RE</a></li><li><a href="#state_connecting_wait_banner_and_identify" class="table-of-contents__link toc-highlight">STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY</a></li><li><a href="#state_connecting_send_connect_msg" class="table-of-contents__link toc-highlight">STATE_CONNECTING_SEND_CONNECT_MSG</a></li><li><a href="#state_connecting_wait_connect_reply" class="table-of-contents__link toc-highlight">STATE_CONNECTING_WAIT_CONNECT_REPLY</a></li><li><a href="#state_connecting_wait_connect_reply_auth" class="table-of-contents__link toc-highlight">STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH</a></li><li><a href="#state_connecting_ready" class="table-of-contents__link toc-highlight">STATE_CONNECTING_READY</a></li><li><a href="#handle_connect_reply" class="table-of-contents__link toc-highlight">handle_connect_reply</a></li><li><a href="#handle_connect_msg" class="table-of-contents__link toc-highlight">handle_connect_msg</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9a4bf489.js"></script>
<script src="/assets/js/main.77e0ace0.js"></script>
</body>
</html>