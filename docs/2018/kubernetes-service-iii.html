<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2018/kubernetes-service-iii" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">[Kubernetes] How to Implement Kubernetes Service - NodePort | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.hwchiu.com/docs/2018/kubernetes-service-iii"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[Kubernetes] How to Implement Kubernetes Service - NodePort | hwchiu learning note"><meta data-rh="true" name="description" content="在前述中我們已經學過了什麼是 kubernetes service 以及如何實現 ClusterIP 這種類型的 service. 透過對 iptables 的探討與研究, 我們可以理解到 ClusterIP 本身會提供一個虛擬的 IP 地址,接下來只要跟這個地址有關的封包,都會透過 DNAT 的方式進行轉換找到最後的 Endpoint IP. 至於如何選擇的部分,則是透過機率的方式去尋找. 接下來我們要來探討另外一個也是很常使用的 kubernetes service 類型, 也就是 NodePort. NodePort 本身包含了 ClusterIP 的所有功能, 此外也額外開啟了一個新的存取方式. 透過直接存取節點的 IP 地址配上一個設定好的 Port, 也可以將該封包直接送到最後面的容器應用程式. 因此本文也要延續上一篇的思路,繼續研究 iptables 的規則來探討 NodePort 到底是如何實現的"><meta data-rh="true" property="og:description" content="在前述中我們已經學過了什麼是 kubernetes service 以及如何實現 ClusterIP 這種類型的 service. 透過對 iptables 的探討與研究, 我們可以理解到 ClusterIP 本身會提供一個虛擬的 IP 地址,接下來只要跟這個地址有關的封包,都會透過 DNAT 的方式進行轉換找到最後的 Endpoint IP. 至於如何選擇的部分,則是透過機率的方式去尋找. 接下來我們要來探討另外一個也是很常使用的 kubernetes service 類型, 也就是 NodePort. NodePort 本身包含了 ClusterIP 的所有功能, 此外也額外開啟了一個新的存取方式. 透過直接存取節點的 IP 地址配上一個設定好的 Port, 也可以將該封包直接送到最後面的容器應用程式. 因此本文也要延續上一篇的思路,繼續研究 iptables 的規則來探討 NodePort 到底是如何實現的"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.hwchiu.com/docs/2018/kubernetes-service-iii"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2018/kubernetes-service-iii" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2018/kubernetes-service-iii" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://L4HXL74VLW-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="hwchiu learning note" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5bc72551.css">
<link rel="preload" href="/assets/js/runtime~main.25d3a6ea.js" as="script">
<link rel="preload" href="/assets/js/main.12b38d81.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/cert-manager">Automatically Renew Your Certificated in kubernetes by Cert-Manager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/cni-compare">常見 CNI (Container Network Interface) Plugin 介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/cni-questions">CNI 常見問題整理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/gpu-gke">Install GPU in GKE(Google Kubernetes Engine)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/introduce-cni-i">[Container Network Interface] Bridge Network In Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/introduce-cni-ii">[Container Network Interface] CNI Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/introduce-cni-iii">[Container Network Interface] Implement Your CNI In Golang</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/k8s-security-11tips-i">11個保護你 Kubernetes 集群的技巧與觀念(上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/k8s-security-11tips-ii">11個保護你 Kubernetes 集群的技巧與觀念(下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns-ii">[Kubernetes] DNS Setting When DnsPolicy Is Default</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns-iii">[Kubernetes] DNS Setting with Dockerd(原始碼分析上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns-iiii">[Kubernetes] DNS Setting with Dockerd(原始碼分析下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns">[Kubernetes] DNS setting in your Pod</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-fedora">Install the kubernetes as single node in Fedora 28</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-service-i">[Kubernetes] What Is Service?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-service-ii">[Kubernetes] How to Implement Kubernetes Service - ClusterIP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2018/kubernetes-service-iii">[Kubernetes] How to Implement Kubernetes Service - NodePort</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-service-iiii">[Kubernetes] How to Implement Kubernetes Service - SessionAffinity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-storage-i">Kubernetes X Storage (I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-storage-ii">NFS 於 Kubernetes 內的各種應用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/mgo-aggregate">[Golang] aggregate in mongo</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/netfilter-eiptables-i">[netfilter] Introduction to ebtables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/netfilter-eiptables-ii">[netfilter] Introduction to iptables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/netfilter-eiptables-iii">[netfilter] Dig Into Docker Bridge Network By iptables/ebtables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/paper-tensorflow-with-rdma">[論文導讀] - Towards Zero Copy Dataflows using RDMA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/tools-ncdu">NCurses Disk Usage(ncdu)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/travisci-k8s">使用 Travis CI 為你的 Kubernetes 應用程式打造自動化測試</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/travisci-step-job-stage">[DevOps] Travis CI - Step/Job/Stage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2018"><span itemprop="name">2018</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">[Kubernetes] How to Implement Kubernetes Service - NodePort</span><meta itemprop="position" content="2"></li></ul></nav><div class="theme-doc-markdown markdown"><h1>Preface</h1><p>本文章是屬於 <code>kubernetes</code> service 系列文之一，該系列文希望能夠與大家討論下列兩個觀念</p><ol><li>什麼是 <code>Kubernetes Service</code>, 為什麼我們需要它？ 它能夠幫忙解決什麼問題</li><li><code>Kubernetes Service</code> 是怎麼實現的?， 讓我們用 iptables 來徹徹底底的理解他</li></ol><p>相關文章:
<a href="https://www.hwchiu.com/docs/2018/kubernetes-service-i" target="_blank" rel="noopener noreferrer">[Kubernetes] What is Service</a>
<a href="https://www.hwchiu.com/docs/2018/kubernetes-service-ii" target="_blank" rel="noopener noreferrer">[Kubernetes] How To Implement Kubernetes Service - ClusterIP</a>
<a href="https://www.hwchiu.com/docs/2018/kubernetes-service-iiii" target="_blank" rel="noopener noreferrer">[Kubernetes] How To Implement Kubernetes Service - SessionAffinity</a></p><p>本文銜接上篇文章，繼續透過對 <code>iptables</code> 的分析來研究 <code>kubernetes service</code> 中 <code>NodePort</code> 的實作原理。</p><p><code>NodePort</code> 的功能就如同字面上的意思一樣,<code>Node Port</code>, 提供了一種透過存取叢集節點上事先定義好的<code>Port Number</code> 就可以輾轉存取到後端的真正服務。</p><p>作為一個靠腦力生存的人，每次遇到全新概念的時候，都要問問自己幾個問題</p><ol><li>這個概念是想要解決什麼問題?</li><li>什麼時候會用到?</li><li>如果是我，我會怎麼實作?</li></ol><h1>Why We Need NortPort</h1><p><code>NodePort</code> 本身是屬於 <code>kubernetes service</code>的一環，自然就是要提供一個方式可以讓外部來存取集群內的服務，而且可以不用去理會後面這些容器們的真實<code>IP</code>地址。</p><p>既然已經有前面的 <code>ClusterIP</code> 提供了一種叢集內存取的方式，什麼情況下我們會需要 <code>NodePort</code> 這種透過存取節點的方式?</p><p>這邊使用一個下列的範例來解釋可能的情況</p><p>以下只是一種範例，但是未必是最佳解</p><p>假設今天有一個試驗環境，在<code>Cloud Provider(Google/Azure/AWS...etc)</code>中架設了一個<code>kubernetes</code>叢集，裡面透過 <code>nginx</code> 的方式部屬了一個網頁伺服器。
與此同時，我希望該叢集能夠提供下列的特性供我使用</p><ul><li>我希望管理人員可以不需要去擔心該 <code>nginx</code> 的狀態，其網頁服務能夠一直正常運作。</li><li>我可以在任意地方直接連接到該 <code>nginx</code> 提供的網頁伺服器服務</li></ul><p>為了滿足第一個條件，我們可以透過 <code>kubernetes deployment</code> 的方式去確保 <code>nginx</code> 的容器處於一種運行的狀態。
為了滿足第二個條件，我們可以透過 <code>kubernetes service</code> 的方式去連接上述的 <code>nginx</code> 容器們並且提供一種接口讓外部存取
在這種情況下，只要<code>kubernetes</code>叢集內的節點擁有一個固定的對外<code>IP</code>地址，同時 <code>kubernetes server</code> 透過 <code>NodePorts</code> 的方式提供該<code>nginx</code>往外存取的能力。
這種情況下，我們就可以在任何地方，透過直接存取該節點的對外<code>IP</code>地址，然後間接透過<code>NodePort</code>的功能存取到集群內的<code>nginx</code>服務。</p><h1>How It Works</h1><p>已經有了前述關於 <code>ClusterIP</code> 運作的概念後，其實要探討 <code>NodePort</code> 是如何實現的就非常簡單了。</p><p>我們先快速複習一下 <code>ClusterIP</code> 的運作流程
<img loading="lazy" src="https://i.imgur.com/xoPvipq.png" alt="Imgur" class="img_ev3q"></p><ol><li>封包若來自叢集上的應用程式/節點，則跳到 `KUBE-SVC</li><li>如果封包的目標<code>IP</code>地址是 <code>ClusterIP</code> 所提供的虛擬<code>IP</code>地址, 則跳到 <code>KUBE-SVC-XXXX</code></li><li><code>KUBE-SVC-XXX</code> 裡面根據機率的方式，選到一個 <code>Endpoints</code>，最後跳到 <code>KUBE-SEP-XXX</code></li><li><code>KUBE-SEP-XXX</code> 裡面執行 <code>DNAT</code>, 將封包的目標地址改成真正的容器地址，然後轉發</li></ol><p>有了上述的概念，我們如果要支援 <code>NodePort</code> 這種能夠透過<code>節點IP</code>的方式存取的話。
想了一下，其實就是把上述的(1)/(2)改掉就好，能夠跳到 <code>KUBE-SVC-XXX</code>的話，後續就完全一致了。</p><p>接下來，我們繼續使用<a href="https://github.com/hwchiu/kubeDemo" target="_blank" rel="noopener noreferrer">kubeDemo</a>來進行相關的服務部屬以及<code>iptables</code>規則研究。</p><p>首先，我們先在環境內部署相關的 <code>nginx</code> 以及 <code>kubernetes service(NodePort)</code></p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:06:36:12 [~/go/src/github.com/hwchiu/kubeDemo/services](master)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$kubectl apply -f deployment/nginx.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/k8s-nginx created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:06:36:18 [~/go/src/github.com/hwchiu/kubeDemo/services](master)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$kubectl apply -f service/nginx-node.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/k8s-nginx-node created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊就不再敘述太多跟 <code>service/endpoints</code> 相關的資訊與位置，直接從 <code>iptables</code> 的角度出發。</p><p>我個人非常喜歡 <code>kubernetes</code>的一點就是所有的 <code>iptables</code> 的規則都會下註解，所以其實可以很輕易的透過 <code>grep</code> 的方式找到相關的規則。
以上述的範例來說，我們在 <code>default</code> namespace 中部屬了一個 <code>k8s-nginx-node</code> 的 <code>kubernetes service</code>.
所以透過 <code>grep default/k8s-nginx-node</code> 的方式就可以過濾出所有跟這個<code>Service</code>有關的所有規則。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:03:17:35 [~]vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$sudo iptables-save  | grep default/k8s-nginx-node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/k8s-nginx-node:&quot; -m tcp --dport 30136 -j KUBE-MARK-MASQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/k8s-nginx-node:&quot; -m tcp --dport 30136 -j KUBE-SVC-RD5DSC6PXE26GCYZ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-VRKO3GZ2XUCPVWY5 -s 10.244.0.115/32 -m comment --comment &quot;default/k8s-nginx-node:&quot; -j KUBE-MARK-MASQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-VRKO3GZ2XUCPVWY5 -p tcp -m comment --comment &quot;default/k8s-nginx-node:&quot; -m tcp -j DNAT --to-destination 10.244.0.115:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-YNJKNN6SS5424R7C -s 10.244.0.113/32 -m comment --comment &quot;default/k8s-nginx-node:&quot; -j KUBE-MARK-MASQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-YNJKNN6SS5424R7C -p tcp -m comment --comment &quot;default/k8s-nginx-node:&quot; -m tcp -j DNAT --to-destination 10.244.0.113:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-ZGMDZ7UNNV74OV5B -s 10.244.0.114/32 -m comment --comment &quot;default/k8s-nginx-node:&quot; -j KUBE-MARK-MASQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-ZGMDZ7UNNV74OV5B -p tcp -m comment --comment &quot;default/k8s-nginx-node:&quot; -m tcp -j DNAT --to-destination 10.244.0.114:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.98.128.179/32 -p tcp -m comment --comment &quot;default/k8s-nginx-node: cluster IP&quot; -m tcp --dport 80 -j KUBE-MARK-MASQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SERVICES -d 10.98.128.179/32 -p tcp -m comment --comment &quot;default/k8s-nginx-node: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-RD5DSC6PXE26GCYZ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-RD5DSC6PXE26GCYZ -m comment --comment &quot;default/k8s-nginx-node:&quot; -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-YNJKNN6SS5424R7C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-RD5DSC6PXE26GCYZ -m comment --comment &quot;default/k8s-nginx-node:&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-ZGMDZ7UNNV74OV5B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-RD5DSC6PXE26GCYZ -m comment --comment &quot;default/k8s-nginx-node:&quot; -j KUBE-SEP-VRKO3GZ2XUCPVWY5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我們快速的掃過所有的規則，根據 <code>custom chain</code> 來看，分成四個部分</p><ol><li>KUBE-NODEPORTS</li><li>KUBE-SEP-XXXX</li><li>KUBE-SERVICES</li><li>KUBE-SVC-XXXX</li></ol><p>這邊目前只有 <code>KUBE-NODEPORTS</code> 還沒有看過，剩下的都跟 <code>ClusterIP</code> 是一樣的功能的。</p><p>NodePort 的功能基於 ClusterIP 之上再添加新功能，所以本來 Cluster 該有的規則對於 NodePort 來說都不會少</p><h1>KUBE-NODEPORTS</h1><p>我們仔細觀察 <code>KUBE-NODEPORTS</code> 相關的兩條規則</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/k8s-nginx-node:&quot; -m tcp --dport 30136 -j KUBE-MARK-MASQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/k8s-nginx-node:&quot; -m tcp --dport 30136 -j KUBE-SVC-RD5DSC6PXE26GCYZ</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第一條規則的目標是 <code>-j KUBE-MARK-MASQ</code>, 這部份是跟 <code>SNAT</code> 有關的，這個之後有機會再寫額外的文章來介紹 <code>SNAT</code> 相關的功能以及處理方式。
這邊只要知道這是修改封包的來源<code>IP</code>位址即可
第二條規則比較重要，我們可以觀察到</p><ol><li>其比對條件是 <code>-m tcp --dport 30136</code>.</li><li>符合條件後執行的行為是 <code>-j KUBE-SVC-RD5DSC6PXE26GCYZ</code></li></ol><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:03:34:14 [~]vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-nginx-node   NodePort    10.98.128.179   &lt;none&gt;        80:30136/TCP   1d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根據查詢 <code>kubernetes svc</code> 的結果，我們可以觀察到透過存取 <code>30136/TCP</code> 的方式就可以存取 <code>NodePOrt</code>.
而這個資訊與我們前面看到的 <code>KUBE-NODEPORTS</code> 這邊的規則完全一樣
最後可以發現當規則一致時，就會跳到 <code>KUBE-SVC-XXX</code> 去進行 <code>endpoints</code> 的挑選以及相關的 <code>DNAT</code> 功能。</p><p>哪接下來的問題只剩下一個
到底封包什麼時候會進入到 <code>KUBE-NODEPORTS</code> ? 只要釐清這個問題，剩下的處理方式就都跟 <code>ClusterIP</code> 完全一樣了。
這時候我們就要一條一條 <code>iptables</code> 的規則來慢慢查詢</p><p>我偷懶直接使用 <code>-j KUBE-NODEPORTS</code> 的方式來查詢，到底誰會跳入 <code>KUBE-NODEPORT</code></p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:03:43:42 [~]vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$sudo iptables-save  | grep &quot;\-j KUBE-NODEPORTS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SERVICES -m comment --comment &quot;kubernetes service nodeports; NOTE: this must be the last rule in this chain&quot; -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這個規則非常有趣，首先我們可以觀察到，他在 <code>KUBE-SERVICES</code> 這個 <code>custom chain</code> 裡面。 接下來可以觀察他的註解</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubernetes service nodeports; NOTE: this must be the last rule in this chain</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然後看一下比對條件以及執行目標</p><ol><li>-m addrtype --dst-type LOCAL</li><li>-j KUBE-NODEPORTS</li></ol><p>第一個比對條件我們從文字上來解讀，只要封包的目標<code>IP</code>地址是屬於本節點上的任何網卡<code>IP</code>。
只要符合上述規則，就會跳到 <code>KUBE-NODEPORT</code> 裡面進行比對，然後就按照前述的去處理了。</p><p>對於 --dst-type LOCAL 有興趣的人可以嘗試閱讀下列這個檔案
<a href="https://elixir.bootlin.com/linux/v4.7.8/source/net/netfilter/xt_addrtype.c#L119" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/linux/v4.7.8/source/net/netfilter/xt_addrtype.c#L119</a>
<a href="https://elixir.bootlin.com/linux/v4.7.8/source/include/uapi/linux/rtnetlink.h#L203" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/linux/v4.7.8/source/include/uapi/linux/rtnetlink.h#L203</a>
看看 kernel 內大致上是怎麼處理這系列操作的</p><p>到這邊我們整理一下所有的思路。</p><ol><li>NodePort 也是倚賴 <code>KUBE-SERVICES</code>，當封包目標是本地端的 <code>IP</code> 位置的時候，就會跳到 <code>KUBE-NODEPORT</code> 裡面去比對 <code>protocol/port</code> 來進行後續跟 <code>ClusterIP</code> 相同的處理</li><li>所有的 <code>kubernetes NodePort service</code> 都會共用同一個 <code>KUBE-NODEPORT</code>, 因此所有的 <code>NodePort</code> 使用的 <code>Port</code> 都不能一樣</li></ol><p>我們用下列這張圖來總結 <code>NodePort</code> 的運作</p><p><img loading="lazy" src="https://i.imgur.com/9amwybH.png" alt="Imgur" class="img_ev3q"></p><h1>PortBinding</h1><p>由於 <code>NodePort</code> 會使用到節點上面的 <code>Port</code> 來提供服務
但從 <code>iptables</code> 的規則觀察下，其實 <code>NodePort</code> 所用到的 <code>Port</code> 就是一個虛擬的 <code>Port</code>，譬如上述範例的 <code>30136</code>。
為了避免有任何應用程式之後將 <code>NodePort</code> 要用到的 <code>Port</code> 給拿去使用，導致整個有任何非預期的行為出現</p><ul><li>譬如某服務想要用 30136 port, 但是所有的封包都被 iptables 導走了，導致該服務一直沒有辦法接收到真正的連線</li></ul><p>為了解決這個問題就是不要讓任何應用程式有機會使用到 <code>30136</code> 的連接埠，因此每個節點上面的 <code>kube-proxy</code> 就會幫忙做這件事情。</p><p>一旦 <code>NodePort</code> 成功建立後，就會將該 <code>Port</code> 給使用走，讓其他的應用程式沒有機會使用。</p><p>這部份我們可以透過 <code>netstat</code> 的指令來觀察</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:04:08:18 [~]vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$sudo netstat -ltpn | grep 30136</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       0      0 :::30136                :::*                    LISTEN      10181/kube-proxy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這點跟 <code>docker</code> 的想法是很類似的，不過 <code>docker</code> 所啟用的 <code>docker-proxy</code> 其實也會幫忙 <code>forward</code> 這些封包，而不是單純的搶占避免服務失效而已。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:01:08:39 [~/go/src/github.com/linkernetworks/vortex/vendor](hwchiu/VX-62)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$sudo docker run -d -p 5566:80 nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f4b6b72ad82c170a92cd6ea272fc8d665b69835b8508d20e1ac2b220b2ba5b31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:01:08:43 [~/go/src/github.com/linkernetworks/vortex/vendor](hwchiu/VX-62)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ps axuw  | grep docker-p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root     21499  0.0  0.0  59068  2852 ?        Sl   01:08   0:00 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 5566 -container-ip 172.18.0.2 -container-port 80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Summary</h1><p>本章節我們仔細的討論了 <code>NodePort</code> 各種面向的概念，最後發現其實 <code>NodePort</code> 的規則非常簡單，建立於 <code>ClusterIP</code> 之上。
只要能夠掌握 <code>ClusterIP</code> 是如何運作的，回過頭來看 <code>NodePort</code> 就不難理解這整個過程。</p><p>最後繼續使用這張圖作為總結，希望大家這時候都能夠順利的看懂這張圖要表達的一切概念
<img loading="lazy" src="https://i.imgur.com/9amwybH.png" alt="Imgur" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">Linux</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/iptables">iptables</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2018/kubernetes-service-ii"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">[Kubernetes] How to Implement Kubernetes Service - ClusterIP</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2018/kubernetes-service-iiii"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">[Kubernetes] How to Implement Kubernetes Service - SessionAffinity</div></a></nav><hr><br></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.25d3a6ea.js"></script>
<script src="/assets/js/main.12b38d81.js"></script>
</body>
</html>