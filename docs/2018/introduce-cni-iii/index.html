<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2018/introduce-cni-iii" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">[Container Network Interface] Implement Your CNI In Golang | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.hwchiu.com/docs/2018/introduce-cni-iii"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[Container Network Interface] Implement Your CNI In Golang | hwchiu learning note"><meta data-rh="true" name="description" content="As we know, the kubernetes use the CNI to provide the network connectivity for its Pod unit and the cluster administrator can choose what kind of the CNI should be installed in the cluster. For example, if the only requirement is the overlay network, you can choose the flannel CNI and choose the calico CNI if you have the requirement of the BGP. In this post, we will learn how to write your own CNI in golang language. Actually, You can implement it with any language as you like."><meta data-rh="true" property="og:description" content="As we know, the kubernetes use the CNI to provide the network connectivity for its Pod unit and the cluster administrator can choose what kind of the CNI should be installed in the cluster. For example, if the only requirement is the overlay network, you can choose the flannel CNI and choose the calico CNI if you have the requirement of the BGP. In this post, we will learn how to write your own CNI in golang language. Actually, You can implement it with any language as you like."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.hwchiu.com/docs/2018/introduce-cni-iii"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2018/introduce-cni-iii" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2018/introduce-cni-iii" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://L4HXL74VLW-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="hwchiu learning note" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5bc72551.css">
<link rel="preload" href="/assets/js/runtime~main.cd8c2ff3.js" as="script">
<link rel="preload" href="/assets/js/main.d0315f99.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/cert-manager">Automatically Renew Your Certificated in kubernetes by Cert-Manager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/cni-compare">常見 CNI (Container Network Interface) Plugin 介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/cni-questions">CNI 常見問題整理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/gpu-gke">Install GPU in GKE(Google Kubernetes Engine)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/introduce-cni-i">[Container Network Interface] Bridge Network In Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/introduce-cni-ii">[Container Network Interface] CNI Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2018/introduce-cni-iii">[Container Network Interface] Implement Your CNI In Golang</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/k8s-security-11tips-i">11個保護你 Kubernetes 集群的技巧與觀念(上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/k8s-security-11tips-ii">11個保護你 Kubernetes 集群的技巧與觀念(下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns-ii">[Kubernetes] DNS Setting When DnsPolicy Is Default</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns-iii">[Kubernetes] DNS Setting with Dockerd(原始碼分析上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns-iiii">[Kubernetes] DNS Setting with Dockerd(原始碼分析下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns">[Kubernetes] DNS setting in your Pod</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-fedora">Install the kubernetes as single node in Fedora 28</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-service-i">[Kubernetes] What Is Service?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-service-ii">[Kubernetes] How to Implement Kubernetes Service - ClusterIP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-service-iii">[Kubernetes] How to Implement Kubernetes Service - NodePort</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-service-iiii">[Kubernetes] How to Implement Kubernetes Service - SessionAffinity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-storage-i">Kubernetes X Storage (I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-storage-ii">NFS 於 Kubernetes 內的各種應用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/mgo-aggregate">[Golang] aggregate in mongo</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/netfilter-eiptables-i">[netfilter] Introduction to ebtables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/netfilter-eiptables-ii">[netfilter] Introduction to iptables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/netfilter-eiptables-iii">[netfilter] Dig Into Docker Bridge Network By iptables/ebtables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/paper-tensorflow-with-rdma">[論文導讀] - Towards Zero Copy Dataflows using RDMA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/tools-ncdu">NCurses Disk Usage(ncdu)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/travisci-k8s">使用 Travis CI 為你的 Kubernetes 應用程式打造自動化測試</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/travisci-step-job-stage">[DevOps] Travis CI - Step/Job/Stage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2018"><span itemprop="name">2018</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">[Container Network Interface] Implement Your CNI In Golang</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Preface</h1><p>It&#x27;s a series post about the Container Network Interface and you can find other posts below.
<a href="https://www.hwchiu.com/introduce-cni-i.html" target="_blank" rel="noopener noreferrer">[Container Network Interface] Bridge Network In Docker</a>
<a href="https://www.hwchiu.com/introduce-cni-ii.html" target="_blank" rel="noopener noreferrer">[Container Network Interface] CNI Introduction </a></p><p>In this post, I will show how to write your own CNI program.</p><p>Container Network Interface(CNI) can be implemented by any programming languages as you like.</p><p>You just to follow the interface and your program can be used for every infrastructure using the CNI for their network connectivity.</p><p>In this tutorial, I will use the <code>golang</code> to implement a simple CNI witch create a <code>Linux Bridge</code> in the host and connect the container and the host itself.</p><p>I have create a github repo for this tutorial and you can find it on <a href="HTTPS://github.com/hwchiu/CNI_Tutorial_2018" target="_blank" rel="noopener noreferrer">hwchiu CNI_Tutorial_2018</a></p><h1>Introduction</h1><p>In order to help the develop to develop their own CNI, the <code>CNCF</code> had setup two projects for developers.</p><p>Those projects are based on the golang language and provide useful libraries for the developer to control the Linux network functions, such as <code>IP</code>, <code>netlink</code> and <code>network namespace</code>.</p><p>The <a href="HTTPS://github.com/containernetworking/cni" target="_blank" rel="noopener noreferrer">ContainerNetworking/CNI</a> provides the basic function for CNI implementation in golang and you can see the introduction of that project in its README</p><blockquote><p>As well as the specification, this repository contains the Go source code of a library for integrating CNI into applications and an example command-line tool for executing CNI plugins. A separate repository contains reference plugins and a template for making new plugins.</p></blockquote><p>The other project <a href="HTTPS://github.com/containernetworking/plugins" target="_blank" rel="noopener noreferrer">ContainerNetwokring/Plugins</a> provides some basic network functions for your CNI and it can be divided into two types.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-cni">Basic CNI<a href="#basic-cni" class="hash-link" aria-label="Direct link to Basic CNI" title="Direct link to Basic CNI">​</a></h2><p>It provides some basic CNI, such as <code>Bridge</code>, <code>MacVlan</code>, <code>Host Device</code>.. And so on.
You can chain those CNI into your own CNI and combine those into a more powerful CNI.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ipam">IPAM<a href="#ipam" class="hash-link" aria-label="Direct link to IPAM" title="Direct link to IPAM">​</a></h2><p>IPAM (IP Address Management) provides some method to handle the IP/Route management. It provides <code>host-local</code>, <code>dhcp</code> and <code>static</code> three methods now.</p><p>In the <code>host-local</code>, you just need to provide a configuration file to describe what subnet/gateway you want to use and it will allocate a unused IP address from that subnet for your CNI.
And the <code>dhcp</code> will runs a <code>DHCP</code> client in each container and send a <code>dhcp request</code> to get a IP address from the <code>dhcp</code> server.</p><p>In this tutorial, we will implement a <code>bridge</code> CNI and explain those functions step by step.</p><h1>Before We Start</h1><p>Before we start to implement the CNI, we must know the <code>interface</code>/<code>specification</code> of the <code>CNI</code>.</p><ol><li>Your CNI will be invoked when the container is <code>ready to create or has been terminated</code>.</li></ol><ul><li>Allocate resources for the container, including the <code>IP address</code> and the network connectivity.</li><li>Remove all resources you allocated before when a container has been terminated.</li></ul><ol start="2"><li>The caller will pass the following information into your CNI program</li></ol><ul><li>Command (What kind of the event you should care)<ul><li>ADD</li><li>DELETE</li><li>VERSION</li></ul></li><li>ContainerID (The target ContainerID)</li><li>NetNS (THe network namespace path of the container)</li><li>IFNAME (The interface name should be created in the container)</li><li>PATH (The current working PATH, you should use it to execute other CNI)</li><li>STDIN (The configuration file of your CNI)</li></ul><h1>Step By Step</h1><p>For each step, you can find a corresponding folder in my github repo and there&#x27;s all golang files for each steps.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step1">Step1<a href="#step1" class="hash-link" aria-label="Direct link to Step1" title="Direct link to Step1">​</a></h2><p>First, we need to provide two function for <code>ADD</code> and <code>DELETE</code> event which is used to allocate/recycle resource when the container has been start/terminated.</p><p>We use the framework provided by the The <a href="HTTPS://github.com/containernetworking/cni" target="_blank" rel="noopener noreferrer">ContainerNetworking/CNI</a> and it will encapsulate</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Package main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Import (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/containernetworking/cni/pkg/skel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/containernetworking/cni/pkg/version&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func cmdAdd(args *skel.CmdArgs) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func cmdDel(args *skel.CmdArgs) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    skel.PluginMain(cmdAdd, cmdDel, version.All)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this framework, it encapsulates all information we need into a predefined type <code>skel.CmdArgs</code></p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type CmdArgs struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ContainerID string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Netns string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IfName string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Args string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Path string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StdinData []byte</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Use the <code>go build</code> to build the binary and assume our execution file  is <code>example</code> and then we should provide a basic configuration which should contains useful information for our CNI.
Maybe we call the file <code>configuration</code> its contents looks like</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mynet&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;BridgeName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;test&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;IP&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;192.0.2.1/24&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, We can use the following command to execute our CNI program.</p><div class="language-shell=bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell=bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo CNI_COMMAND=ADD CNI_CONTAINERID=ns1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CNI_NETNS=/var/run/netns/ns1 CNI_IFNAME=eth10 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CNI_PATH=`pwd` \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./example &lt; config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For that go CNI framework, those infromation should be passed by the <code>environement</code> and we can get that from the <code>CmdArgs</code>.</p><p>Actually, we have done the basic CNI program but it does nothing.</p><p>A good CNI should make a container network connectivity and assign a valid IP address to the container and we will do that in the foloowing tutorial.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2">Step 2<a href="#step-2" class="hash-link" aria-label="Direct link to Step 2" title="Direct link to Step 2">​</a></h2><p>Now, we will create a linux bridge for the container and the logical flow looks like</p><ol><li>Read the bridge information from the config.</li><li>Get the bridge name we want to use.</li><li>Create the bridge if it doesn&#x27;t exist in the system.</li></ol><p>Since the frametwork store the config content in the <code>CmdArgs</code> object as a <code>[]byte</code> form. we should create a <code>structure</code> to decode those <code>[]byte</code> data.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type SimpleBridge struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BridgeName string `json:&quot;bridgeName&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IP    string `json:&quot;ip&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and decode the config content in the <code>CmdAdd</code> function.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func cmdAdd(args *skel.CmdArgs) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sb := SimpleBridge{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err := json.Unmarshal(args.StdinData, &amp;sb); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Println(sb)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There&#x27;re many ways for creating the Linuxu Bridge, we can use the system commadn <code>brctl addbr</code> via the <code>os.Exec</code> or use the <code>netlink</code> to create.</p><p>We choose the <code>netlink</code> method here since the <code>os.Exec</code> is too easy for developer.</p><p>First, we should import the <code>netlink</code> package <code>&quot;github.com/vishvananda/netlink&quot;</code>
and we will use the type <code>netlink.Bridge</code> to describe the bridge we want.</p><p>In the following example, we will do three things.</p><ol><li>Prepare the netlink.Bridge object we want.</li><li>Create the Bridge</li><li>Setup the Linux Bridge.</li></ol><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    br := &amp;netlink.Bridge{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LinkAttrs: netlink.LinkAttrs{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name: sb.BridgeName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MTU:  1500,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Let kernel use default txqueuelen; leaving it unset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // means 0, and a zero-length TX queue messes up FIFO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // traffic shapers which use TX queue length as the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // default packet limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TxQLen: -1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err := netlink.LinkAdd(br)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil &amp;&amp; err != syscall.EEXIST {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err := netlink.LinkSetUp(br); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now. The <code>CmdAdd</code> function should look like below.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func cmdAdd(args *skel.CmdArgs) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sb := SimpleBridge{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err := json.Unmarshal(args.StdinData, &amp;sb); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Println(sb)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    br := &amp;netlink.Bridge{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LinkAttrs: netlink.LinkAttrs{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name: sb.BridgeName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MTU:  1500,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Let kernel use default txqueuelen; leaving it unset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // means 0, and a zero-length TX queue messes up FIFO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // traffic shapers which use TX queue length as the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // default packet limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TxQLen: -1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err := netlink.LinkAdd(br)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil &amp;&amp; err != syscall.EEXIST {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err := netlink.LinkSetUp(br); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Use the aforementioned command to call the binary again and you should see the linux bridge <code>test</code> has been created.</p><p>If youu don&#x27;t have the <code>brctl</code> command, use the <code>apt-get install bridge-utils to</code> to install the bridge tools.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step3">Step3<a href="#step3" class="hash-link" aria-label="Direct link to Step3" title="Direct link to Step3">​</a></h2><p>In the next step, we will creat a <code>veth</code> for connecting the <code>linux</code> bridge and the taget <code>container</code>.</p><p>The logical flow are</p><ol><li>Get the bridge object from the <code>Bridge</code> we created before</li><li>Get the namespace of the container</li><li>Create a veth on the container and move the host-end veth to host ns.</li><li>Attach a host-end veth to linux bridge</li></ol><p>This step is more complicate then previous steps. since we will handle the <code>network namespace</code> here.
Fortunately, the <code>CNI</code> project has provided convenience function to handle the veth and it can cover the (3) action itom above.</p><p>First, we use the <code>netlink.LinkByName</code> method to lookup the <code>netlink</code> object.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    l, err := netlink.LinkByName(sb.BridgeName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fmt.Errorf(&quot;could not lookup %q: %v&quot;, sb.BridgeName, err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and the we need to make sure that object is <code>netlink.Bridge</code>, so we do the type casting.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    newBr, ok := l.(*netlink.Bridge)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if !ok {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fmt.Errorf(&quot;%q already exists but is not a bridge&quot;, sb.BridgeName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Second, since the <code>CmdArgs</code> already provide the <code>network namespace </code> path of the container, we can use the method from the <code>ns</code> package to load the object of the network namespace.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import `&quot;github.com/containernetworking/plugins/pkg/ns&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    netns, err := ns.GetNS(args.Netns)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For each <code>NetNS</code> object, it implement a function <code>Do</code> which take a function as its parameter and that function&#x27;s parameter is the caller&#x27;s network namespace.</p><p>The <code>do</code> function will switch the network namespace to <code>NetNS</code> object itself and call the function(parameter) and feed the original network namespace as parameter.</p><p>See the following example to learn more about <code>do</code> function.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var handler = func(hostNS ns.NetNS) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hostVeth, containerVeth, err := ip.SetupVeth(args.IfName, 1500, hostNS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if err := netns.Do(handler); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>First , we create a function handler which calls the <code>ip.SetpuVeth</code> to create a veth pair on caller&#x27;s network namespace and move one side of veth pair to its third parameter(<code>hostNS</code>)</p><p>When we call the <code>netns.Do(handler)</code>, it will call the function <code>handler</code> in <code>netns&#x27;s</code> network namepsace and pass the caller&#x27;s network namespace to the <code>function handler</code>.
Which will result in that there will be a veth pair between the host&#x27;s network namespace and <code>netns&#x27;s</code> netowkr namespace.</p><p>In order to store the information about that veth pair, we can use the <code>current.Interface{}</code> object to store the data.</p><p>First, we need to import the library</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;github.com/containernetworking/cni/pkg/types/current&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and then create a variable represent to host side network interface in the function handler.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hostIface := &amp;current.Interface{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var handler = func(hostNs ns.Netns) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hostVeth, _, err := ip.SetupVeth(args.IfName, 1500, hostNS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hostIface.Name = hostVeth.Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, we can get the interface name of veth pair in the host side by <code>hostIface.Name</code> and then we will attach that link to the <code>Linux Bridge</code> we created before.</p><ol><li>Get the link object from the interface name by function call <code>netlink.LinkByName</code></li><li>Connect the link to bridge by function call <code>netlink.LinkSetMaster</code></li></ol><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hostVeth, err := netlink.LinkByName(hostIface.Name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if err := netlink.LinkSetMaster(hostVeth, newBr); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There is one important thing we need to care is the OS thread. since we will switch the <code>netns</code> to handle the namespace things.
We must make sure the OS won&#x27;t switch the thread during the <code>namespace</code> operations.</p><p>Use the function <code>runtime.LockOSThread()</code> in the golang predefined function <code>init()</code>.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // this ensures that main runs only on main thread (thread group leader).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // since namespace ops (unshare, setns) are done for a single thread, we</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // must ensure that the goroutine does not jump from OS thread to thread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        runtime.LockOSThread()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">See the whole example program in https://github.com/hwchiu/CNI_Tutorial_2018/tree/master/tutorial/step3 and you can directly run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">the `run.sh` in your linux machine to see the following output.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```shell=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ready to call the step3 example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{test 192.0.2.1/24}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The CNI has been called, see the following results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The bridge and the veth has been attatch to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bridge name     bridge id               STP enabled     interfaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test            8000.aa6e12faa09b       no              vethff65a064</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The interface in the netns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eth10     Link encap:Ethernet  HWaddr 7e:23:e2:e5:8f:c4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          inet6 addr: fe80::7c23:e2ff:fee5:8fc4/64 Scope:Link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          RX packets:1 errors:0 dropped:0 overruns:0 frame:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          TX packets:1 errors:0 dropped:0 overruns:0 carrier:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          collisions:0 txqueuelen:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          RX bytes:90 (90.0 B)  TX bytes:90 (90.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lo        Link encap:Local Loopback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          LOOPBACK  MTU:65536  Metric:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          collisions:0 txqueuelen:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We have successfully create a linux bridge and connect to the other network namespace via the veth pair and the interface in that namepsace is <code>eth10</code> which has been defiend in the config file.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step4">Step4<a href="#step4" class="hash-link" aria-label="Direct link to Step4" title="Direct link to Step4">​</a></h2><p>In this step, we will setup the IP address into the target network namespace.
To make the problem easy, we had set the target IP address in the config and we can get via the <code>sp.IP</code></p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type SimpleBridge struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BridgeName string `json:&quot;bridgeName&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IP         string `json:&quot;ip&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The function we used to assign the IP address is <code>netlink.AddrAdd</code>
So the workflow is</p><ol><li>Generate a IP object from the config.</li><li>Call the <code>nelink.AddrAdd</code> in the target network namespace.</li></ol><p>The parameter of <code>netlink.AddrAdd</code> is <code>netlink.Addr</code> and see its structure below.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Addr struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *net.IPNet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Label       string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Flags       int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Scope       int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Peer        *net.IPNet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Broadcast   net.IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreferedLft int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ValidLft    int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can use the <code>net</code> package provided by official golang to generate the <code>net.IPNet</code> type and its a CIDR form (IP address and the Mask).</p><p>Since the IP address in our config is a string<code>192.0.2.15/24</code>,
we use the <code>net.ParseCIDR</code> to parse the string and return a pointer of <code>net.IPNet</code></p><p>So, modify the previous handler to assign the IP address when we create a veth.</p><p>Since the <code>net.IPNet</code> object get from the <code>net.ParseCIDR</code> is the <code>subnet</code>  not a <code>real IP</code> addrees, we should reassign the <code>IP</code> address to its IP field again.</p><div class="language-go= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var handler = func(hostNS ns.NetNS) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hostVeth, containerVeth, err := ip.SetupVeth(args.IfName, 1500, hostNS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hostIface.Name = hostVeth.Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ipv4Addr, ipv4Net, err := net.ParseCIDR(sb.IP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link, err := netlink.LinkByName(containerVeth.Name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ipv4Net.IP = ipv4Addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr := &amp;netlink.Addr{IPNet: ipv4Net, Label: &quot;&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err = netlink.AddrAdd(link, addr); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>See the whole example program in <a href="https://github.com/hwchiu/CNI_Tutorial_2018/tree/master/tutorial/step4" target="_blank" rel="noopener noreferrer">https://github.com/hwchiu/CNI_Tutorial_2018/tree/master/tutorial/step4</a> and you can directly run
the <code>run.sh</code> in your linux machine to see the following output.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Ready to call the step4 example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">test </span><span class="token number" style="color:#36acaa">192.0</span><span class="token plain">.2.15/24</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The CNI has been called, see the following results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The bridge and the veth has been attatch to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bridge name     bridge </span><span class="token function" style="color:#d73a49">id</span><span class="token plain">               STP enabled     interfaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">test</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">8000</span><span class="token plain">.a6f55b2927c0       no              vethd611bb3b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The interface </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the netns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eth10     Link encap:Ethernet  HWaddr aa:a0:96:45:65:c5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          inet addr:192.0.2.15  Bcast:192.0.2.255  Mask:255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          inet6 addr: fe80::a8a0:96ff:fe45:65c5/64 Scope:Link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          RX packets:2 errors:0 dropped:0 overruns:0 frame:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          TX packets:1 errors:0 dropped:0 overruns:0 carrier:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          collisions:0 txqueuelen:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          RX bytes:168 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">168.0</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  TX bytes:90 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">90.0</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lo        Link encap:Local Loopback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          LOOPBACK  MTU:65536  Metric:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          collisions:0 txqueuelen:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          RX bytes:0 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  TX bytes:0 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And you can see we have already set the IP address to the interface <code>eth10</code>.
You can use the following command to mamually set the IP address to the linux bridge and use the <code>ping</code> command to check the network connectiviy between the host and the target network namespace.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ifconfig</span><span class="token plain"> </span><span class="token builtin class-name">test</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.0</span><span class="token plain">.2.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> netns </span><span class="token builtin class-name">exec</span><span class="token plain"> ns1 </span><span class="token function" style="color:#d73a49">ping</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.0</span><span class="token plain">.2.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Summary</h1><p>In this tutorial, we have implemented a simple Linux Bridge CNI (only Add function) in golang.</p><p>We create the linux bridge and use the veth to connect the linux bridge with the target netowrk namespace.
Besides, we also fethc the information we want from the pre-defined config file which means we can more flexible to change the behavior of your own CNI implementation.</p><p>To make the problem simple, we don&#x27;t use any complicated method to acquire a unique address from the config but you can desing you own algorithm to do that.
If you want to learn more about the IP related operations, you can go to the <a href="https://github.com/containernetworking/plugins/tree/master/plugins/ipam/host-local" target="_blank" rel="noopener noreferrer">host-local</a> to learn more.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/cni">CNI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/container">Container</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">Linux</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/ubuntu">Ubuntu</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/golang">Golang</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kernel">Kernel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">Kubernetes</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2018/introduce-cni-ii"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">[Container Network Interface] CNI Introduction</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2018/k8s-security-11tips-i"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">11個保護你 Kubernetes 集群的技巧與觀念(上)</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#basic-cni" class="table-of-contents__link toc-highlight">Basic CNI</a></li><li><a href="#ipam" class="table-of-contents__link toc-highlight">IPAM</a></li><li><a href="#step1" class="table-of-contents__link toc-highlight">Step1</a></li><li><a href="#step-2" class="table-of-contents__link toc-highlight">Step 2</a></li><li><a href="#step3" class="table-of-contents__link toc-highlight">Step3</a></li><li><a href="#step4" class="table-of-contents__link toc-highlight">Step4</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.cd8c2ff3.js"></script>
<script src="/assets/js/main.d0315f99.js"></script>
</body>
</html>