<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2018/kubernetes-service-ii" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">[Kubernetes] How to Implement Kubernetes Service - ClusterIP | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hwchiu.com/docs/2018/kubernetes-service-ii"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[Kubernetes] How to Implement Kubernetes Service - ClusterIP | hwchiu learning note"><meta data-rh="true" name="description" content="在前述中我們已經學過了什麼是 kubernetes service, 一般情況下都會採用 ClusterIP 的形態幫特定的容器應用程式提供 Service 的服務. 本文會針對 ClusterIP 的概念進行更深入的探討,並且嘗試從系統層面的設計與應用來研究到底 ClusterIP 底層是怎麼實作的,這部分的實作包含了1) ClusterIP 到底在那裡？ 2) 如果有多個 Endpoints 的話, 是如何選擇當前連線的最終目標. 這些研究的內容包含了常見了網路概念，如 NAT(Network Address Translation) 以及 iptables 本身的設計及使用，如 table/chian 等概念有初步的認知,這樣對於本文的探討會更明白與瞭解."><meta data-rh="true" property="og:description" content="在前述中我們已經學過了什麼是 kubernetes service, 一般情況下都會採用 ClusterIP 的形態幫特定的容器應用程式提供 Service 的服務. 本文會針對 ClusterIP 的概念進行更深入的探討,並且嘗試從系統層面的設計與應用來研究到底 ClusterIP 底層是怎麼實作的,這部分的實作包含了1) ClusterIP 到底在那裡？ 2) 如果有多個 Endpoints 的話, 是如何選擇當前連線的最終目標. 這些研究的內容包含了常見了網路概念，如 NAT(Network Address Translation) 以及 iptables 本身的設計及使用，如 table/chian 等概念有初步的認知,這樣對於本文的探討會更明白與瞭解."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hwchiu.com/docs/2018/kubernetes-service-ii"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/2018/kubernetes-service-ii" hreflang="en"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/2018/kubernetes-service-ii" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.a4f4719e.css">
<link rel="preload" href="/assets/js/runtime~main.968fc5ed.js" as="script">
<link rel="preload" href="/assets/js/main.fbbbbf6b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/cert-manager">Automatically Renew Your Certificated in kubernetes by Cert-Manager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/cni-compare">常見 CNI (Container Network Interface) Plugin 介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/cni-questions">CNI 常見問題整理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/gpu-gke">Install GPU in GKE(Google Kubernetes Engine)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/introduce-cni-i">[Container Network Interface] Bridge Network In Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/introduce-cni-ii">[Container Network Interface] CNI Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/introduce-cni-iii">[Container Network Interface] Implement Your CNI In Golang</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/k8s-security-11tips-i">11個保護你 Kubernetes 集群的技巧與觀念(上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/k8s-security-11tips-ii">11個保護你 Kubernetes 集群的技巧與觀念(下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns-ii">[Kubernetes] DNS Setting When DnsPolicy Is Default</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns-iii">[Kubernetes] DNS Setting with Dockerd(原始碼分析上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns-iiii">[Kubernetes] DNS Setting with Dockerd(原始碼分析下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-dns">[Kubernetes] DNS setting in your Pod</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-fedora">Install the kubernetes as single node in Fedora 28</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-service-i">[Kubernetes] What Is Service?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2018/kubernetes-service-ii">[Kubernetes] How to Implement Kubernetes Service - ClusterIP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-service-iii">[Kubernetes] How to Implement Kubernetes Service - NodePort</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-service-iiii">[Kubernetes] How to Implement Kubernetes Service - SessionAffinity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-storage-i">Kubernetes X Storage (I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/kubernetes-storage-ii">NFS 於 Kubernetes 內的各種應用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/mgo-aggregate">[Golang] aggregate in mongo</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/netfilter-eiptables-i">[netfilter] Introduction to ebtables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/netfilter-eiptables-ii">[netfilter] Introduction to iptables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/netfilter-eiptables-iii">[netfilter] Dig Into Docker Bridge Network By iptables/ebtables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/paper-tensorflow-with-rdma">[論文導讀] - Towards Zero Copy Dataflows using RDMA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/tools-ncdu">NCurses Disk Usage(ncdu)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/travisci-k8s">使用 Travis CI 為你的 Kubernetes 應用程式打造自動化測試</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2018/travisci-step-job-stage">[DevOps] Travis CI - Step/Job/Stage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2018"><span itemprop="name">2018</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">[Kubernetes] How to Implement Kubernetes Service - ClusterIP</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Preface</h1><p>本文章是屬於 <code>kubernetes</code> service 系列文之一，該系列文希望能夠與大家討論下列兩個觀念</p><ol><li>什麼是 <code>Kubernetes Service</code>, 為什麼我們需要它？ 它能夠幫忙解決什麼問題</li><li><code>Kubernetes Service</code> 是怎麼實現的?， 讓我們用 iptables 來徹徹底底的理解他</li></ol><p>相關文章:
<a href="https://www.hwchiu.com/kubernetes-service-i.html" target="_blank" rel="noopener noreferrer">[Kubernetes] What is Service</a>
<a href="https://www.hwchiu.com/kubernetes-service-iii.html" target="_blank" rel="noopener noreferrer">[Kubernetes] How To Implement Kubernetes Service - NodePort</a>
<a href="https://www.hwchiu.com/kubernetes-service-iiii.html" target="_blank" rel="noopener noreferrer">[Kubernetes] How To Implement Kubernetes Service - SessionAffinity</a></p><p>本篇文章著重於後者，透過對系統上的分析來探討 <code>kubernetes service</code> 實作的原理。
由於篇幅有限，本文會將基本概念都說明一遍，並且透過 <code>ClusterIP</code> 這個形式來解釋其運作原理。
待下篇文章在來解釋 <code>NodePort</code> 以及 <code>SessionAffinity</code> 是如何實現的。</p><p>很多人在學習一個新的系統的時候，最初接觸的都是如何使用，如何操作，然而對其背後的實現原理卻沒有太多的著墨。
為什麼要學習實現的原理？
很簡單，因為「知己知彼，百戰百勝」
當我們理解這些功能背後的實現方式後，我們不但可以學習到其背後的設計理念與方式，同時當問題出現時。
我們可以比一般使用者用更廣的角度去思考問題，同時也可以採用更系統的方式去除錯找出問題的根本，這更能體現出你相對於一般人的價值。</p><h1>Introduction</h1><p>在前篇文章 <a href="https://www.hwchiu.com/kubernetes-service-i.html" target="_blank" rel="noopener noreferrer">[Kubernetes] What is Service</a> 我們已經學習到關於 <code>Kubernetes Service</code> 的基本概念與用法
而本篇文章則是想要探討在預設安裝情況下， <code>kubernetes</code> 是如何實現 <code>service</code> 的功能。</p><h1>Kube-Proxy Mode</h1><p>目前的 <code>Kubernetes</code> 裡面總共有三種方法去實現 <code>Service</code>，分別是</p><ol><li>kube-Proxy (old)</li><li>iptables (default)</li><li>ipvs (experimental)</li></ol><p>簡單敘述一下這三種的差異</p><ol><li>kube-Proxy 是指透過<code>kube-proxy</code>本身程式內部的邏輯來實現 <code>service</code>，由於 <code>kube-proxy</code> 是 <code>user-space</code> 的應用程式，所以效率非常低落，但是因為是程式化的結果，彈性比較高。</li><li>iptables 的話，則是讓 <code>kube-proxy</code> 去維護跟 <code>service</code>有關的邏輯部分，真正所有封包轉送都交由 <code>kernel-space</code> 的 <code>iptables</code> 來處理。 效率比(1)來得強，但是在使用上則是會受限於 <code>iptables</code> 的規則與框架。</li><li>ipvs(IP virtual switch) 與(2)類似，只是在 <code>kernel-space</code> 裡面採用 <code>ipvs</code> 的方式來轉送封包，相對於 <code>iptables</code> 本身效率更高，同時也不會受限於<code>iptables</code> 的使用規則</li></ol><p>我們可以藉由設定 <code>kube-proxy</code> 裡面的 <code>--proxy-mode</code> 這個參數來決定要使用哪一種實現方式</p><p>kube-proxy 本身會透過 <code>daemonset</code> 的方式部屬到每一個節點上，有興趣的可以透過
kubectl -n kube-system describe ds kube-proxy 指令觀察一下相關的內容</p><p>回歸正題，本文主要探討的對象是 <code>iptables</code>，看看這個歷史悠久且功能強大的 <code>iptables</code> 框架是如何完成 <code>kubernetes service</code> 所需要的各種功能</p><h1>Iptables</h1><p><code>iptables</code> 本身真正講起來，其實是透過 <code>user-space</code> 的管理工具<code>iptables</code> 搭配 <code>kernel-space</code> 的 <code>netfilter</code> 網路子系統兩者組合來提供各式各樣的功能。</p><p>想要更加瞭解 <code>iptables</code> 的介紹可以參閱我在 <a href="https://www.slideshare.net/hongweiqiu/understand-the-iptables-step-by-step-109650841" target="_blank" rel="noopener noreferrer">COSCUP x GNOME.Asia x openSUSE.Asia 2018</a> 所講授的透過閱讀原始碼的方式來更加瞭解 <code>iptables</code>.
此外我之後也會撰寫跟 <code>iptables</code> 相關的文章，到時候會整理相關的內容讓大家更容易去理解這套強大的工具。</p><p>為了理解本篇文章接下來的內容，我們必須要對 <code>iptables</code> 有一些基本的認識，這邊幫大家整理一下需要的概念。</p><ol><li>在 <code>iptables</code> 裡面每個規則面對的對象都是一個個的網路封包</li><li>每條規則的邏輯大抵上如下<ul><li>請問該封包有沒有符合 <code>Match</code> 條件</li><li>如果有 <code>Match</code>, 則執行目標 <code>Action(Target)</code></li></ul></li><li>每條規則都屬於一個 <code>chain</code>, 一個 <code>chain</code> 可以有多條規則</li><li>除了內建的 <code>chain</code> 之外, 管理者可以自定義新的 <code>chain</code> 方便管理</li></ol><p>有了基本概念後，我們就可以開始來探討 <code>kubernetes serivce</code> 如何實作了</p><p>若需要真正完全理解這一切，還需要搭配 <code>PREROTUING</code>,<code>FORWARD</code>,<code>POSTRING</code> 等不同 <code>table</code> 的先後關係與概念，不但對於理解有更加的幫助，對於除錯找問題也是有很大的效益。
有興趣的讀者可自行上網尋找相關文章學習，或是等我哪天會寫出相關的文章來介紹這些資訊。</p><h1>Kubernetes Service</h1><p>在我們開始前，我們要先定義幾個相關的名詞，方便之後閱讀的時候可以順利的理解前後文的關係與概念。</p><p>這邊先借用 <a href="https://www.hwchiu.com/kubernetes-service-i.htmlvvv" target="_blank" rel="noopener noreferrer">[Kubernetes] What is Service</a> 內最後展示範例使用的概念圖
<img loading="lazy" src="https://i.imgur.com/osNqxlw.png" alt="Imgur" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="endpoints">Endpoints<a href="#endpoints" class="hash-link" aria-label="Direct link to Endpoints" title="Direct link to Endpoints">​</a></h2><p>在 <code>kubernetes</code> 內有一個名為 <code>endpoints</code> 的資源，其代表的是 <code>service</code> 所關注目標服務實際上真正運行<code>Pod</code>的 <code>IP</code> 地址</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:02:00:28 [~/go/src/github.com/hwchiu/kubeDemo](master)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$kubectl get endpoints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                ENDPOINTS                                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-nginx-cluster   10.244.0.88:80,10.244.0.89:80,10.244.0.90:80   9h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-nginx-node      10.244.0.88:80,10.244.0.89:80,10.244.0.90:80   9h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubernetes          172.17.8.100:6443                              11d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以從上述的輸出結果看到每個 <code>service</code> 都會對應到多組的 <code>endpoints</code>，所以當叢集內的容器有任何 <code>IP</code> 更動的時候，這邊的數據都會自動更新，以確保 <code>service</code> 有辦法存取後端真正的服務</p><p>有在使用 <code>Service</code> 的讀者，以後若有遇到 <code>service</code> 不通的情況，可以嘗試先看看該 <code>service</code> 是否有對應的 <code>endpoints</code>，沒有的話可能是 <code>selector</code> 寫錯或是目標服務根本沒有運行起來。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="custom-chain">Custom Chain<a href="#custom-chain" class="hash-link" aria-label="Direct link to Custom Chain" title="Direct link to Custom Chain">​</a></h2><p><code>kubenetes</code> 使用 iptables 時為了更有效管理不同的功能與規則的歸屬，建立的大量的 <code>custom chain</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iptables-save">iptables-save<a href="#iptables-save" class="hash-link" aria-label="Direct link to iptables-save" title="Direct link to iptables-save">​</a></h2><p>這是一個 <code>iptables</code> 相關的指令，我個人很喜歡用它來觀察 <code>iptables</code> 的規則，本文的所有範例都會是使用該指令進行展示</p><h1>ClusterIP</h1><p>我們已經知道 <code>ClusterIP</code> 的作用範圍只有<code>叢集內</code>的應用程式/節點，所以在本段落我們會著重於三個概念來理解</p><p>叢集內節點是的存取比較尷尬，的確可以透過 <code>ClusterIP</code> 地址來存取，但是預設情況下是沒有辦法解析<code>FQDN</code>取得對應的 <code>ClusterIP</code> 地址。</p><ol><li>如何透過 <code>FQDN</code> 輾轉存取到目標容器們(Endpoints)</li><li>如何做到只有<code>叢集內</code>的應用程式/節點才可以存取</li><li>假設有多個目標容器(Endpoints), 這中間的選擇方式是怎麼處理?</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="access-by-fqdn">Access By FQDN<a href="#access-by-fqdn" class="hash-link" aria-label="Direct link to Access By FQDN" title="Direct link to Access By FQDN">​</a></h2><p>我們都知道 <code>Service</code> 本身會提供一組對應的 <code>FQDN</code> 供應用程式使用
實際上這組<code>FQDN</code> 只有 <code>kube-dns</code> 能夠理解，而且其對應的 <code>IP</code> 地址其實就是每個 <code>Service</code> 提供的 <code>ClusterIP</code>
這邊的ClusterIP剛好跟 <code>Type</code> 的ClusterIP 名稱一樣，但是這邊要表示的真的是個<code>IP</code>地址</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:05:36:40 [~/go/src/github.com/hwchiu/kubeDemo](master)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-nginx-cluster   ClusterIP   10.98.51.150   &lt;none&gt;        80/TCP         1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-nginx-node      NodePort    10.99.157.45   &lt;none&gt;        80:32293/TCP   1d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在此範例中，可以看到不論是 <code>ClusterIP</code> 或是 <code>NodePort</code> 實際上都會有一組 <code>Cluster-IP</code> 的 <code>IP</code> 地址。</p><p>這個<code>Cluster-IP</code>最大的特性就是他是一個虛擬的<code>IP</code>地址，在整個<code>kubernetes</code>叢集內是找不到任何一張網卡擁有這個<code>IP</code>地址的。</p><p>所有針對該<code>Cluster-IP</code>發送的封包，在滿足特定的條件下，都會被透過<code>DNAT(Destination Network Address Translation)</code> 進行轉換，在<code>service</code>  其實就會是被轉換到其中一個 <code>EndPoints</code> 的真正 <code>IP</code> 地址</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:05:43:50 [~/go/src/github.com/hwchiu/kubeDemo](master)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$sudo iptables-save -t nat | grep nginx-cluster | grep DNAT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-7MBJVYFMXTKOJUKD -p tcp -m comment --comment &quot;default/k8s-nginx-cluster:&quot; -m tcp -j DNAT --to-destination 10.244.0.88:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-ARZAHNE3T3EMMTGB -p tcp -m comment --comment &quot;default/k8s-nginx-cluster:&quot; -m tcp -j DNAT --to-destination 10.244.0.90:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-O3CWA7STMVCKFPRY -p tcp -m comment --comment &quot;default/k8s-nginx-cluster:&quot; -m tcp -j DNAT --to-destination 10.244.0.89:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:05:43:54 [~/go/src/github.com/hwchiu/kubeDemo](master)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$kubectl get endpoints k8s-nginx-cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                ENDPOINTS                                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-nginx-cluster   10.244.0.88:80,10.244.0.89:80,10.244.0.90:80   1d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>透過 <code>iptables</code> 的觀察，我們可以看到在某些 <code>custom chain</code> 中會透過 <code>DNAT</code> 的方式把封包的目標<code>IP</code> 位址轉換到這些<code>endpoints</code> 擁有的<code>IP</code>地址。
實際上這個 <code>custom chain</code> 就是 <code>KUBE-SEP-XXXX</code>, 每個 <code>Endpoints</code> 都有一條屬於自己的 <code>custom chain</code>. 而 <code>KUBE-SEP</code> 我想其含意應該就是 <code>KUBE Service Endpoint</code> 吧。</p><p>剛剛我們對<code>iptables</code>規則的理解，每個規則都是<code>符合條件</code>,<code>做一件事情</code>，因此背後有多少個<code>endpoints</code>,實際上就會有多少條規則在處理<code>DNAT</code>。</p><p>到這邊我們還有一些疑問還沒有解開，只要先記住下面的結論就好。</p><ol><li>每個<code>service</code>的<code>FQDN</code>都會對應到一組<code>Cluster-IP</code> <code>IP</code> 地址，該地址其實是虛擬<code>IP</code>地址。</li><li>送往該<code>Cluster-IP</code> 的封包在滿足特定的情況下，會透過<code>DNAT</code>的方式轉換成其中一個<code>endpoints</code>容器上的真實<code>IP</code>地址</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-only">Cluster Only<a href="#cluster-only" class="hash-link" aria-label="Direct link to Cluster Only" title="Direct link to Cluster Only">​</a></h2><p>現在我們要來討論一下，到底所謂的只有<code>叢集內</code>的應用程式/節點才可以存取<code>clusterIP</code>這到底是怎麼運作的。</p><p>我們複習一下前面的某個敘述
送往該<code>Cluster-IP</code> 的封包在滿足特定的情況下，會透過<code>DNAT</code>的方式轉換成其中一個<code>endpoints</code>容器上的真實<code>IP</code>地址</p><p>這邊提到要滿足特定的情況才會走到<code>DNAT</code>轉到對應的<code>EndPoints</code>。
所以
<strong>只有<code>叢集內</code>的應用程式/節點才可以存取</strong> 其實就是 <strong>特定的情況</strong></p><p>我們都知道 <code>iptables</code> 的規則可以根據封包的一些資訊來做比對，所以我們能不能做出一種規則是
只有 <strong>封包的來源<code>IP</code>地址是來自<code>叢集內的應用程式/節點</code></strong>，符合這種規則的才有資格去進行 <code>DNAT</code> 進行轉發</p><p>實際上使用的概念是更簡單，這邊透過 <code>iptables build-in chain</code> 裡面的 <code>OUTPUT/PREROUTING</code> 兩個 <code>chain</code> 來達成
<strong>只有<code>叢集內</code>的應用程式/節點</strong>
這個功能</p><p>這邊我直接講明</p><ul><li>OUTPUT: 本地節點送出去的封包都會先走到這邊</li><li>PREROUTING: 本地網卡收到封包後會走到這邊，包含了<code>Contaienr</code>出來的封包都會走到</li></ul><p>接下我們來透過 <code>iptables</code> 的指令來觀察一下這些規則。</p><p>根據前面的查詢，我們知道 <code>ClusterIP</code> 地址是 <code>10.98.51.150</code>,</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:04:24:49 [~/go/src/github.com/hwchiu/kubeDemo](master)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$sudo iptables-save | grep k8s-nginx-cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SERVICES -d 10.98.51.150/32 -p tcp -m comment --comment &quot;default/k8s-nginx-cluster: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-3FL7SSXCKTCXAYCR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述的規則我們來仔細看一下每個參數的意義</p><ul><li>-A <code>KUBE-SERVICES</code><ul><li>這是一個 <code>Custom Chain</code>, 所有跟 <code>Kubernetes Service</code> 有關的第一到防線規則都在這邊</li></ul></li><li>-d 10.98.51.150/32<ul><li>目標位置是 <code>ClusterIP</code> 的話</li></ul></li><li>-p tcp<ul><li>目標是 TCP 協定</li></ul></li><li>-m comment<ul><li>就是註解</li></ul></li><li>-m tcp --dport 80<ul><li>使用外掛模組來解析TCP裡面的資訊，希望 TCP port 是80</li></ul></li><li>-j KUBE-SVC-3FL7SSXCKTCXAYCR<ul><li>上述所有條件都符合，就會跳入另外一個<code>custom chain</code>來執行後續任務</li></ul></li></ul><p>後面的部份我們先不管他，我們來看一下什麼情況下的封包會進入到 <code>KUBE-SERVICES</code> 這個 <code>custom chain</code>.</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo iptables-save -c | grep KUBE-SERVICES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:KUBE-SERVICES - [0:0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2376:171145] -A PREROUTING -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[3706:223392] -A OUTPUT -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊可以看到有兩條規則，分別對應到原生的 <code>OUTPUT</code> 以及 <code>PREROUTING</code>，直接透過 <code>-j</code> 直接跳入到 <code>KUBE-SERVICES</code> 來進行後續處理。</p><p>其實夠熟悉 iptables 的朋友應該已經可以猜到，在此規則狀況下，我只要有辦法讓流向<code>ClusterIP</code>的封包透過一些網路規則的方式流向到叢集內的節點，依然可以順利的存取背後的服務。
只是因為這些<code>ClusterIP</code>本身不存在網路之中，所以需要針對整個網路的路由表規則額外設定
這部份就是額外有興趣的人可以自己研究，這邊就不再多敘述。</p><p>我們先用下圖來幫助目前的概念做一個整理</p><ul><li>橘色底的代表是封包的來源，在此案例中其實就代表<code>叢集內的節點/應用程式</code></li><li>綠色底代表的是<code>iptables build-in chain</code>，主要用來處理叢集內應用程式/節點上的封包傳輸</li><li>藍色的則是<code>kubernetes</code> 的 <code>custom chain</code>.</li><li>紫色的則是代表 <code>iptables</code> 的描述規則</li><li>紅色則是我們知道最後會在 <code>KUBE-SEP-XXX</code> 透過 <code>DNAT</code> 把封包轉換到其中一個<code>endpoints</code>之中。</li><li>???則是代表我們還沒有研究到的，只知道這中間還有一部分的謎團等待解開</li></ul><p><img loading="lazy" src="https://i.imgur.com/74jQEiM.png" alt="Imgur" class="img_ev3q"></p><ol><li>每個<code>service</code>的<code>FQDN</code>都會對應到一組<code>ClusterIP</code> <code>IP</code> 地址，該地址其實是虛擬<code>IP</code>地址。</li><li>透過 <code>iptablse</code> 的 <code>OUTPUT/PREROUTING</code>，其有能力去匹配所有叢集內的應用程式/節點所送出的封包</li><li>最後透過去比對封包的目的地位址是否是 <code>ClusterIP</code> 來決定要不要往下跳到其他<code>custom chain</code> 去處理。</li><li>封包最後會透過<code>DNAT</code>的方式轉換成其中一個<code>endpoints</code>容器上的真實<code>IP</code>地址</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="loab-balancing">Loab Balancing<a href="#loab-balancing" class="hash-link" aria-label="Direct link to Loab Balancing" title="Direct link to Loab Balancing">​</a></h2><p>現在我們要來看看最後一個部分了，到底要怎麼從眾多的 <code>Endpoints</code> 中挑選出一個可用的 <code>Pod</code> 來使用。</p><p>根據前面的分析，當我們的封包符合叢集內使用的規則後，會跳到一個<code>KUBE-SVC-3FL7SSXCKTCXAYCR</code> 的 <code>custom chain</code>.
實際上 <code>KUBE-SVC-XXXX</code> 的 <code>custom chain</code> 就是用來處理挑選 <code>Endpoints</code> 用的，會根據每個 <code>kubernetes service</code> 創造一條屬於其的 <code>chain</code>.</p><p>我們先重新認真看一下這條規則</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SERVICES -d 10.98.51.150/32 -p tcp -m comment --comment &quot;default/k8s-nginx-cluster: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-3FL7SSXCKTCXAYCR</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>當封包滿足叢集內的條件時，就會跳到一個名為<code>KUBE-SVC-3FL7SSXCKTCXAYCR</code>的 <code>custom chain</code>.</p><p>這時候來仔細檢視其內容</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-3FL7SSXCKTCXAYCR -m comment --comment &quot;default/k8s-nginx-cluster:&quot; -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-POVAFWTN5ECIRK7J</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-3FL7SSXCKTCXAYCR -m comment --comment &quot;default/k8s-nginx-cluster:&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-AQWRPA7WRPWQAWLR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-3FL7SSXCKTCXAYCR -m comment --comment &quot;default/k8s-nginx-cluster:&quot; -j KUBE-SEP-XPSDT7KEI65EZ2WI</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我們可以觀察到裡面有幾個重點</p><ol><li>有 <code>-m statistic</code>, <code>random</code>, <code>probability</code> 這些跟機率相關的文字。</li><li>滿足特定條件後，都會跳到 <code>KUBE-SEP-XXXXX</code> 這些 <code>custom chain</code>. 這就如同我們之前所觀察到會執行 <code>DNAT</code> 的 <code>custom chain</code> 了</li></ol><p>接下來說明一下到底那群跟機率有關的規則是怎麼運作的。
我們先前已經說明過，<code>iptables</code>的運作方式是<strong>符合條件</strong>, <strong>就做一件事情</strong>
所以並沒有很簡單的在一條規則內，幫你選出對應的<strong>Endpoints</strong>.
於是這邊的作法是，假設我有三個 <strong>Endpoint</strong>，挑選的流程如下</p><ol><li>請問機率大神，給我一個數字<ul><li>若該數字&lt;0.33, 則使用第一個<strong>endpoints</strong></li><li>否則重新問機率大神，從剩下的 <strong>endpoints</strong> 挑選</li></ul></li><li>請問機率大神，再次給我一個數字<ul><li>若該數字&lt;0.5, 則使用第二個 <strong>endpoints</strong></li><li>否則直接使用地三個 <strong>endpoints</strong>.</li></ul></li></ol><p>用下圖的方式來重新解釋這個流程，假設今天有四個 <code>Endpoints</code> 要選擇
<img loading="lazy" src="https://i.imgur.com/tpSFwKg.png" alt="Imgur" class="img_ev3q"></p><ol><li>一開始要從四個裡面選擇，所以機率只有 <strong>1/4</strong>, 若符合了就採用第一個 <code>Endpoint</code></li><li>因為前面沒有符合，所以接下來要從三個裡面繼續選擇下一個 <strong>endpoints</strong>，這時候的機率就是<strong>1/3</strong>,但是因為要走到這步必須(1)沒有成功，所以機率是(3/4*1/3), 就是 <strong>1/4</strong></li><li>一此類推，每個 <strong>Endpoints</strong> 的機率都是 <strong>1/4</strong></li><li>運氣最不好的 <strong>endpoints</strong> 必須要進行 <strong>n-1</strong> 次的規則比對 (n是endpoints的數量)</li><li>運氣最好的只需要一次比對就可以找到。</li></ol><p>當找到要使用的 <strong>Endpoints</strong> 的時候，就會跳到對應的 <strong>KUBE-SEP-XXXX</strong> 去進行 <strong>DNAT</strong> 的轉換。</p><h1>Summary</h1><p>最後一塊拼圖也已經完成了，到這邊已經可以大概知道是如何透過 <code>iptables</code> 來完成 <code>clusterIP</code> 的轉發。
在這種實作架構中，每個節點的 <code>iptables</code> 都會自行去負責尋找 <code>endpoints</code> 來處理，而<code>ClusterIP</code> 這個不存在的<code>IP</code>地址只是幫助我們讓<code>iptables</code>有個好依據來處理。</p><p>就用下圖來幫這篇文章做個最後的結尾。
下篇文章在來仔細看看 <code>NodePort</code> 以及 <code>SessionAffinity</code> 這些功能如何透過 <code>iptables</code> 來實現。</p><p><img loading="lazy" src="https://i.imgur.com/xoPvipq.png" alt="Imgur" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">Linux</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/iptables">iptables</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2018/kubernetes-service-i"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">[Kubernetes] What Is Service?</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2018/kubernetes-service-iii"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">[Kubernetes] How to Implement Kubernetes Service - NodePort</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#endpoints" class="table-of-contents__link toc-highlight">Endpoints</a></li><li><a href="#custom-chain" class="table-of-contents__link toc-highlight">Custom Chain</a></li><li><a href="#iptables-save" class="table-of-contents__link toc-highlight">iptables-save</a></li><li><a href="#access-by-fqdn" class="table-of-contents__link toc-highlight">Access By FQDN</a></li><li><a href="#cluster-only" class="table-of-contents__link toc-highlight">Cluster Only</a></li><li><a href="#loab-balancing" class="table-of-contents__link toc-highlight">Loab Balancing</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.968fc5ed.js"></script>
<script src="/assets/js/main.fbbbbf6b.js"></script>
</body>
</html>