<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2020/ipvs-3" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">IPvS 學習手冊(三) | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.hwchiu.com/docs/2020/ipvs-3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="IPvS 學習手冊(三) | hwchiu learning note"><meta data-rh="true" name="description" content="本文作為 IPVS 系列文第三篇， 會從 Kernel 作為出發點，探討一下 IPVS 本身的模組概念，分享兩種不同的內建除錯方式，此外也會從原始碼的部分看一下 IPVS 初始化的過程做了哪些事情"><meta data-rh="true" property="og:description" content="本文作為 IPVS 系列文第三篇， 會從 Kernel 作為出發點，探討一下 IPVS 本身的模組概念，分享兩種不同的內建除錯方式，此外也會從原始碼的部分看一下 IPVS 初始化的過程做了哪些事情"><meta data-rh="true" name="keywords" content="linux,ipvs"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.hwchiu.com/docs/2020/ipvs-3"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2020/ipvs-3" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2020/ipvs-3" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://L4HXL74VLW-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="hwchiu learning note" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5bc72551.css">
<link rel="preload" href="/assets/js/runtime~main.3dd55255.js" as="script">
<link rel="preload" href="/assets/js/main.d1744312.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2024">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2024">2024</a><button aria-label="Toggle the collapsible sidebar category &#x27;2024&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/cncf-tech-radar-cd">CNCF Continuous Delivery 使用者調查報告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/cncf-tech-radar-observability">CNCF Observability 使用者調查報告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/cni-performance-2020">[文章導讀] - 基於10G網路的 Kubernetes CNI 效能比較</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/docker-network-model-lab-dnat">Docker 網路入門篇(四) - 外界主動存取</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/docker-network-model-lab">Docker 網路入門篇(二) - Bridge 網路模型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/docker-network-model-snat">Docker 網路入門篇(三) - 網路存取分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/docker-network-model">Docker Network - 網路模型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-bad-and-ugly">GitOps 帶來的痛點與反思</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch1">[書本導讀]-GitOps 到底解決了什麼問題</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch2">[書本導讀]-什麼是GitOps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch3">[書本導讀]-淺談GitOps過往</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch4">[書本導讀]-GitOps工具的選擇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch5">[書本導讀]- GitOps實作上的挑戰</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch6">[書本導讀]-GitOps後續</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops">淺談 GitOps 的概念</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/2020/iThome_Challenge/cicd">iThome_Challenge</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/iptables-1">初探 IPTABLES 流動之路 - 以 Docker 為範例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/iptables-masquerade-handson">Linux NAT Masquerade 研究(下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/ipvs-1">IPvS 學習手冊(一)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/ipvs-2">IPvS 學習手冊(二)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2020/ipvs-3">IPvS 學習手冊(三)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/ipvs-4">IPvS 學習手冊(四)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/kubernetes-duplicate-pod-ip">Kubernetes - IP 重複奇遇記</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/kubernetes-static-pod">[Kubernetes] Static Pod 介紹</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2020"><span itemprop="name">2020</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">IPvS 學習手冊(三)</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Preface</h1><p>本篇文章作為系列文章的第三篇，該系列文希望能夠從概念到實作，從簡單到複雜來探討 IPVS (IP Virtual Server) 的概念，目前規劃的主題包含：</p><ul><li><a href="https://www.hwchiu.com/docs/2020/ipvs-1" target="_blank" rel="noopener noreferrer">IPVS 的基本使用與概念</a></li><li><a href="https://www.hwchiu.com/docs/2020/ipvs-2" target="_blank" rel="noopener noreferrer">IPVS 與 Kubernetes 的整合</a></li><li><a href="https://www.hwchiu.com/docs/2020/ipvs-3" target="_blank" rel="noopener noreferrer">IPVS 除錯方式與基本 Kernel Module 概念</a></li><li><a href="https://www.hwchiu.com/docs/2020/ipvs-4" target="_blank" rel="noopener noreferrer">IPVS Kernel 架構實現</a></li></ul><p>本文主要是從 Linux Kernel 出發，介紹一下對於 <strong>IPVS</strong> 這個模組的概念，同時也介紹了預設的兩種除錯方式。</p><h1>環境</h1><p>整篇文章都是基於 Linux Kernel 4.15 為基準去閱讀, 可以從 <strong><a href="https://github.com/torvalds/linux/tree/v4.15/net/netfilter/ipvs" target="_blank" rel="noopener noreferrer">Github</a></strong> 或是 <strong><a href="https://elixir.bootlin.com/linux/v4.15/source" target="_blank" rel="noopener noreferrer">LXR</a></strong> 來進行線上閱讀</p><p>本篇沒有環境建置，因為懶得打包整個 <strong>建置 Linux Kernel</strong> 的環境到 <strong>Vagrant</strong> 裡面。可能要等全部文章都寫完再補齊</p><h1>正題</h1><p>研究都要有個起點，整個 Linux Kernel 過於龐大，實在是不可能全部閱讀。
今天要研究的是 <strong>IPVS</strong> 相關的功能，我們就從其<a href="https://github.com/torvalds/linux/tree/v4.15/net/netfilter/ipvs" target="_blank" rel="noopener noreferrer">資料夾</a>內開始看起。</p><p>根據先前的實驗，我們使用 <strong>IPVS</strong> 之前必須要先安裝對應的 <strong>kernel module</strong>，每個 <strong>kernel module</strong> 都會有相關的初始化函式可以使用。
所以我們就先從 <strong><a href="https://github.com/torvalds/linux/blob/v4.15/net/netfilter/ipvs/Makefile" target="_blank" rel="noopener noreferrer">Makefile</a></strong> 看起來，看一下到底這些 <strong>kernel module</strong> 實際上包含了哪些檔案</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># SPDX-License-Identifier: GPL-2.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Makefile for the IPVS modules on top of IPv4.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># IPVS transport protocol load balancing support</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs_proto-objs-y </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs_proto-objs-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_PROTO_TCP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_proto_tcp.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs_proto-objs-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_PROTO_UDP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_proto_udp.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs_proto-objs-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_PROTO_AH_ESP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_proto_ah_esp.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs_proto-objs-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_PROTO_SCTP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_proto_sctp.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs-extra_objs-y </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs-extra_objs-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_NFCT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_nfct.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs-objs </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain">   ip_vs_conn.o ip_vs_core.o ip_vs_ctl.o ip_vs_sched.o    \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ip_vs_xmit.o ip_vs_app.o ip_vs_sync.o              \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ip_vs_est.o ip_vs_proto.o ip_vs_pe.o               \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip_vs_proto-objs-y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip_vs-extra_objs-y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># IPVS core</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># IPVS schedulers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_RR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_rr.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_WRR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_wrr.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_LC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_lc.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_WLC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_wlc.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_FO</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_fo.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_OVF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_ovf.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_LBLC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_lblc.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_LBLCR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_lblcr.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_DH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_dh.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_SH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_sh.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_SED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_sed.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_NQ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_nq.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># IPVS application helpers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_FTP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_ftp.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># IPVS connection template retrievers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_IP_VS_PE_SIP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ip_vs_pe_sip.o</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這個 Makefile 看起來會覺得好像什麼都沒有，最主要的原因是整體的運作邏輯都在 Kernel 其他檔案裡面，特別是 <a href="https://github.com/torvalds/linux/blob/v4.15/scripts/Makefile.build" target="_blank" rel="noopener noreferrer">Makefile.build</a> ，這邊只是單純定義了每個 <strong>Obj</strong> 的狀況，看是要採取 <strong>Build-in</strong> 模式或是 <strong>kernel module</strong> 模式。</p><p>先複習一下之前安裝過程中所載入的 kernel module</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo modprobe -- ip_vs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo modprobe -- ip_vs_rr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo modprobe -- ip_vs_wrr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo modprobe -- ip_vs_sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊幾個可以注意到的是</p><ol><li>ipvs.ko 是由 ip_vs-objs 這一堆 objs 全部組合而成的。</li><li>每個 <strong>load balancing(scheduler)</strong> 都是一個獨立的 kernel module，剛好對應到 <strong>ip_vs_rr</strong>, <strong>ip_vs_wrr</strong>...等，如果你要用不同的算法，那要確認對應的 module 都有被載入</li></ol><p>有了這個方向，我們就從 <strong>ip_cs-objs</strong> 裡面的開始看起來，其中 <strong>ip_vs_core</strong> 這個名稱非常顯眼，看起來就是核心功能，因此決定之後從該檔案開始看起。</p><h1>Debug IPVS</h1><p>開始往下閱讀 <strong>IPVS</strong> 原始碼之前，我們先來探討一下如何除錯以及如何學習相關的函式呼叫順序</p><p>不修改任何原始碼的情況下， <strong>IPVS</strong> 提供了兩種 <strong>Debug</strong> 的方式讓管理員去檢視相關的函式呼叫情況，這邊要注意的是，其提供的是 <strong>函式呼叫情況</strong>, 而不是一個能夠一一檢視封包的方式。就我個人的使用情況來說，如果本身對於 <strong>IPVS</strong> 的實作與 <strong>Kernel</strong> 不熟悉的人，就沒有辦法 100% 的利用這些除錯訊息。
這邊跟大家介紹這兩種除錯方式該如何開啟</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-option">Dynamic Option<a href="#dynamic-option" class="hash-link" aria-label="Direct link to Dynamic Option" title="Direct link to Dynamic Option">​</a></h2><p>第一種方式是整個 <strong>Kernel</strong> 所提供的除錯方式, 稱之為 <a href="https://www.kernel.org/doc/html/v4.19/admin-guide/dynamic-debug-howto.html" target="_blank" rel="noopener noreferrer">dynamic-debug</a>，所有 <strong>kernel function</strong> 都可以向 <strong>kernel</strong> 註冊一組輸出格式與條件，當今天管理員有需求時就可以動態的打開這些開關使得 <strong>kernel</strong> 開始輸出相關訊息。</p><p>系統上支援的 <strong>dynamic debug</strong> 都存放於 <code>/sys/kernel/debug/dynamic_debug/control</code> 這個路徑，透過 <strong>cat</strong> 的方式可以看到的內容都是由 <strong>filename:line_number, <!-- -->[kernel_module name]<!-- -->, topic, output_format</strong> 這樣的格式，譬如下列範例</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat /sys/kernel/debug/dynamic_debug/control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net/netfilter/xt_LOG.c:60 [xt_LOG]log_tg_check =_ &quot;prefix is not null-terminated\012&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net/netfilter/xt_LOG.c:55 [xt_LOG]log_tg_check =_ &quot;level %u &gt;= 8\012&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net/bridge/netfilter/ebtables.c:2260 [ebtables]compat_do_replace =_ &quot;tmp.entries_size %d, kern off %d, user off %d delta %d\012&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net/bridge/netfilter/ebtables.c:2129 [ebtables]size_entry_mwt =_ &quot;change offset %d to %d\012&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net/bridge/netfilter/ebtables.c:1775 [ebtables]compat_calc_entry =_ &quot;0x%08X -&gt; 0x%08X\012&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net/netfilter/ipvs/ip_vs_proto.c:266 [ip_vs]ip_vs_tcpudp_debug_packet_v6 =_ &quot;%s: %s %s\012&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net/netfilter/ipvs/ip_vs_proto.c:234 [ip_vs]ip_vs_tcpudp_debug_packet_v4 =_ &quot;%s: %s %s\012&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>前面代表的是每個檔案的路徑與行數，再來是對應的 <strong>kernel module name</strong> 以及標題，最後是其輸出的格式。</p><p>對於管理者來說，可以針對 <strong>檔案名稱, 行數 或是 kernel module name 來進行開關，譬如我今天想要打開跟 </strong>ipvs** 有關的所有輸出，就可以執行</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo -n &#x27;module ip_vs +p&#x27; &gt; /sys/kernel/debug/dynamic_debug/control</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這樣 <strong>kernel</strong> 就會知道把 <strong>control</strong> 裡面全部屬於 <strong>ip_vs</strong> 的訊息都輸出，譬如</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[ 3415.992622] ip_vs_tcpudp_debug_packet_v4:234: IPVS: ip_vs_in: packet continues traversal as normal: TCP 10.0.2.2:58199-&gt;10.0.2.15:22</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>對於想要細部觀察封包流向來說，也是不無小補，提供一些資訊觀察</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ip_vs_debug">IP_VS_DEBUG<a href="#ip_vs_debug" class="hash-link" aria-label="Direct link to IP_VS_DEBUG" title="Direct link to IP_VS_DEBUG">​</a></h2><p>第二個則是由 <strong>IPVS</strong> 自己實作的除錯方式，這個除錯方式相關的功能則是在編譯期間根據參數 <strong>IP_VS_DEBUG</strong> 來定是否要一起編譯, 預設情況下這個功能是關閉的，這也意味各位如果都適用已經建置好的 <strong>IPVS</strong> 那基本上是沒有辦法打開這個功能的。
為了打開這個功能，你必須要執行下列步驟</p><ol><li>準備對應你系統版本的 kernel source code</li><li>加入相關的參數，重新建置 IP_VS 的 kernel module</li><li>移除舊有的 kernel module 並安裝新的到系統內</li></ol><p>如果你有興趣要嘗試看看的話，這邊可以顯示一下大概的修改過程 (假設你準備好相關的 kernel source code) 之後</p><ol><li>先複製系統目前使用的 kernel config (Ubutnu 為範例)</li><li>根據該設定檔案重新加入 IP_VS_DEBUG 的參數</li><li>重新建置 Kernel Module</li><li>移除舊有的 Kernel Module, 並且加入新的</li></ol><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cp /boot/config-`uname -r` .config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make menuconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo rmmod ip_vs_wlc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo rmmod ip_vs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo insmod net/netfilter/ipvs/ip_vs.ko</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo insmod net/netfilter/ipvs/ip_vs_wlc.ko</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -j4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中第二部會彈出一個灰色畫面，可以透過 <code>f</code> 進行參數的搜尋，找到對應的位置，然後將其打該設定成 <strong>Y</strong> 即可，畫面如下
<img loading="lazy" src="https://i.imgur.com/TuejssF.png" class="img_ev3q">
<img loading="lazy" src="https://i.imgur.com/VakjFDI.png" class="img_ev3q">
圖中也可以看到 <strong>IPVS</strong> 滿滿的參數有哪些，其中標示為 &quot;M&quot; 都代表會建置成獨立的 <strong>kernel module</strong>，如果有興趣的也可以將全部變成 <strong>Build-in</strong> 的方式，這意味 <strong>kernel</strong> 本身就會包含這些功能，不需要額外在那邊 <strong>insmod/rmmod</strong>。</p><p>此外如果你本身已經有建置過 <strong>kernel</strong> 的話，可以直接輸入 <strong>make modules</strong> 單純編譯 <strong>kernel modules</strong> 相關即可</p><p>完成上述步驟之後就可以在系統上的位置發現多了一個路徑 <strong>/proc/sys/net/ipv4/vs/debug_level</strong>
<img loading="lazy" src="https://i.imgur.com/f4yNxpd.png" class="img_ev3q"></p><p>該路徑對應到 <strong>kernel</strong> 內則是一個整數，預設是 <strong>0</strong>, 今天如果要打開 <strong>debug</strong> 功能的話，就輸入數字到該路徑即可，譬如</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> echo &quot;12&quot; &gt; /proc/sys/net/ipv4/vs/debug_level</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>一但該功能打開後，就會看到系統噴出滿滿的除錯訊息，譬如</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554844] IPVS: Enter: ip_vs_out, net/netfilter/ipvs/ip_vs_core.c line 1352</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554846] IPVS: Enter: ip_vs_proto_name, net/netfilter/ipvs/ip_vs_core.c line 83</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554847] IPVS: lookup/out TCP 172.17.8.111:37926-&gt;172.17.8.156:80 not hit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554848] IPVS: Enter: sysctl_nat_icmp_send, net/netfilter/ipvs/ip_vs_core.c line 671</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554849] IPVS: Enter: ip_vs_local_request4, net/netfilter/ipvs/ip_vs_core.c line 2074</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554850] IPVS: Enter: ip_vs_in, net/netfilter/ipvs/ip_vs_core.c line 1884</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554851] IPVS: Enter: ip_vs_proto_name, net/netfilter/ipvs/ip_vs_core.c line 83</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554852] IPVS: lookup/in TCP 172.17.8.111:37926-&gt;172.17.8.156:80 hit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554853] IPVS: Enter: is_new_conn, net/netfilter/ipvs/ip_vs_core.c line 1084</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554854] IPVS: Enter: sysctl_expire_nodest_conn, net/netfilter/ipvs/ip_vs_core.c line 677</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554854] IPVS: Enter: is_new_conn_expected, net/netfilter/ipvs/ip_vs_core.c line 1111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554855] IPVS: Enter: ip_vs_in_stats, net/netfilter/ipvs/ip_vs_core.c line 117</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554856] IPVS: Enter: ip_vs_set_state, net/netfilter/ipvs/ip_vs_core.c line 209</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554858] IPVS: Enter: ip_vs_nat_xmit, net/netfilter/ipvs/ip_vs_xmit.c line 756</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554859] IPVS: Enter: __ip_vs_get_out_rt, net/netfilter/ipvs/ip_vs_xmit.c line 325</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554860] IPVS: Enter: __ip_vs_dst_check, net/netfilter/ipvs/ip_vs_xmit.c line 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554861] IPVS: Enter: crosses_local_route_boundary, net/netfilter/ipvs/ip_vs_xmit.c line 179</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554862] IPVS: Enter: decrement_ttl, net/netfilter/ipvs/ip_vs_xmit.c line 269</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554863] IPVS: Enter: ensure_mtu_is_adequate, net/netfilter/ipvs/ip_vs_xmit.c line 226</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554865] IPVS: Enter: ip_vs_nat_send_or_cont, net/netfilter/ipvs/ip_vs_xmit.c line 624</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[391968.554868] IPVS: Enter: ip_vs_nat_send_or_cont, net/netfilter/ipvs/ip_vs_xmit.c line 641</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Module Init</h1><p>如上面所述， 我們將從 <strong>ip_vs_core.c</strong> 來探討整個 <strong>ip_vs</strong> 的初始化過程
以下的程式碼來自 <a href="https://github.com/torvalds/linux/blob/v4.15/net/netfilter/ipvs/ip_vs_core.c" target="_blank" rel="noopener noreferrer">Linux 4.15 GitHub ip_vs_core.c</a></p><p>每個 <strong>Kernel Module</strong> 都會從 <strong>module_init</strong> 這邊開始，傳入的參數都會是一個 <strong>function</strong>，當 Module 被載入後這個 function 就會被執行，也可以想成 <strong>modprobe ip_vs</strong> 呼叫後，這個 function 就會先被執行</p><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">module_init(ip_vs_init);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根據上述語法，可以觀察到 <strong>ip_vs_init</strong> 這個 <strong>function</strong></p><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static int __init ip_vs_init(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = ip_vs_control_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pr_err(&quot;can&#x27;t setup control.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto exit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_vs_protocol_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = ip_vs_conn_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pr_err(&quot;can&#x27;t setup connection table.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto cleanup_protocol;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = register_pernet_subsys(&amp;ipvs_core_ops);   /* Alloc ip_vs struct */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto cleanup_conn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = register_pernet_device(&amp;ipvs_core_dev_ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto cleanup_sub;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = ip_vs_register_nl_ioctl();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pr_err(&quot;can&#x27;t register netlink/ioctl.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto cleanup_dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pr_info(&quot;ipvs loaded.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup_dev:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unregister_pernet_device(&amp;ipvs_core_dev_ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup_sub:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unregister_pernet_subsys(&amp;ipvs_core_ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup_conn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_vs_conn_cleanup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup_protocol:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_vs_protocol_cleanup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_vs_control_cleanup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exit:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module_init(ip_vs_init);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module_exit(ip_vs_cleanup);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通常觀察一個 <code>kernel module</code> 就是先觀察 <code>init function</code>, 看看到底初始化哪些相關的資訊，其中上面呼叫的函示有</p><ol><li><p>ip_vs_control_init
用來幫內部一些資料結構初始化，主要都是 HASH table 相關的資料結構</p></li><li><p>ip_vs_protocol_init
用來初始化支持的 <code>Protocol</code>，譬如 <code>TCP,UDP,SCTP</code> 等
根據前述的 <strong>make menuconfig</strong> 我們可以觀察到相關協定的支持也是可以透過參數去開關的。</p></li><li><p>ip_vs_conn_init
主要是用來初始化跟 <code>connection</code> 有關的資訊，<code>connection</code> 可以想成 <code>Client</code> 的請求與配置 <code>Real Server</code> 的關係表。 也是透過 <code>connection</code> 來確保相同連線的封包都會被轉發到相同的 <code>Real Server</code> 上</p></li><li><p>register_pernet_subsys/register_pernet_device
上述兩個函式非常有趣，他們的都是用來註冊 <code>pernet</code> 底下相關元件的函式
，這邊的 <code>pernet</code> 的意思就是 <strong>每個 Network Namespace</strong>。 等等我們再來仔細看看到底做了什麼</p></li><li><p>ip_vs_register_nl_ioctl
用來註冊基於 <code>netlink</code> 的 <code>function handler</code>，這也是我們透過 <code>ipvsadm</code> 這個工具用來操作整個 <code>kernel</code> 內部邏輯的入口。所有的操作指令都會透過 <code>netlink</code> 從 <code>userspace</code> 送到 <code>kernel space</code> 並且呼叫起對應的 <code>Function</code> 來處理。</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="register_pernet_subsysdevice">register_pernet_subsys/device<a href="#register_pernet_subsysdevice" class="hash-link" aria-label="Direct link to register_pernet_subsys/device" title="Direct link to register_pernet_subsys/device">​</a></h2><p>Kernel 對於 <strong>network namespace</strong> 的創建提供了兩個方法來註冊相關的 <strong>handler</strong>, 這兩個差異主要在於對背後資料結構操作的位置不同，詳細的可以參閱 <a href="http://www.programmersought.com/article/907433913/" target="_blank" rel="noopener noreferrer">Kernel network namespace
</a>, 這邊就單純針對 <code>register_pernet_subsys</code> 來研究。</p><p>直接看一下該函式的註解，簡單來說就是註冊一組任何 <strong>network namespace</strong> 被刪除與創建時都會被呼叫的函式，而要特別注意的是當註冊的瞬間，也會對所有已經存在的 <strong>network namespace</strong> 呼叫一次。</p><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> *      register_pernet_subsys - register a network namespace subsystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      @ops:  pernet operations structure for the subsystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      Register a subsystem which has init and exit functions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      that are called when network namespaces are created and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      destroyed respectively.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      When registered all network namespace init functions are</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      called for every existing network namespace.  Allowing kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      modules to have a race free view of the set of network namespaces.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      When a new network namespace is created all of the init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      methods are called in the order in which they were registered.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      When a network namespace is destroyed all of the exit methods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      are called in the reverse of the order with which they were</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      registered.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下來看一下這個函式的呼叫範例</p><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    ret = register_pernet_subsys(&amp;ipvs_core_ops);   /* Alloc ip_vs struct */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其傳入的參數是一個名為 <code>ipvs_core_ops</code> 的結構，而該結構內容如下</p><div class="language-c＝ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c＝ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static struct pernet_operations ipvs_core_ops = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .init = __ip_vs_init,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .exit = __ip_vs_cleanup,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .id   = &amp;ip_vs_net_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .size = sizeof(struct netns_ipvs),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這個結構內最重要的就是 <strong>.init</strong> 這個 <strong>function pointer</strong>，其意思是 <strong>每當有任何一個 namespace 被創建之時</strong>，請呼叫對應的 <strong>function</strong> 來處理，而這邊這個 <strong>function</strong> 就是 <strong>__ip_vs_init</strong>.</p><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *  Initialize IP Virtual Server netns mem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int __net_init __ip_vs_init(struct net *net)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct netns_ipvs *ipvs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ipvs = net_generic(net, ip_vs_net_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ipvs == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -ENOMEM;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Hold the beast until a service is registerd */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ipvs-&gt;enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ipvs-&gt;net = net;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Counters used for creating unique names */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ipvs-&gt;gen = atomic_read(&amp;ipvs_netns_cnt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atomic_inc(&amp;ipvs_netns_cnt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    net-&gt;ipvs = ipvs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ip_vs_estimator_net_init(ipvs) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto estimator_fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ip_vs_control_net_init(ipvs) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto control_fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ip_vs_protocol_net_init(ipvs) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto protocol_fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ip_vs_app_net_init(ipvs) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto app_fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ip_vs_conn_net_init(ipvs) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto conn_fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ip_vs_sync_net_init(ipvs) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto sync_fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = nf_register_net_hooks(net, ip_vs_ops, ARRAY_SIZE(ip_vs_ops));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto hook_fail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Error handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hook_fail:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_vs_sync_net_cleanup(ipvs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sync_fail:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_vs_conn_net_cleanup(ipvs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conn_fail:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_vs_app_net_cleanup(ipvs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app_fail:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_vs_protocol_net_cleanup(ipvs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protocol_fail:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_vs_control_net_cleanup(ipvs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">control_fail:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_vs_estimator_net_cleanup(ipvs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">estimator_fail:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    net-&gt;ipvs = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return -ENOMEM;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>該函式的註解直接標示，針對每一個 <code>network namespace</code> 去進行相關的初始化，其中為重要的則是 <code>ip_vs_control_net_init</code> 以及 <code>nf_register_net_hooks</code> 這兩個函式，後者則是與 <strong>netfilter</strong> 也就是 <strong>iptables</strong> 相關的互動，下一章節我們再來仔細看一下這個函式。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ip_vs_control_net_init">ip_vs_control_net_init<a href="#ip_vs_control_net_init" class="hash-link" aria-label="Direct link to ip_vs_control_net_init" title="Direct link to ip_vs_control_net_init">​</a></h2><p>根據上述的 <strong>debug</strong> 規則我們知道系統上會有一個路徑 <strong>/proc/sys/net/ipv4/vs</strong> 可以讓使用者與之互動，而這個介面的初始化其實就是透過 <strong>ip_vs_control_net_init</strong> 來完成的。</p><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int __net_init ip_vs_control_net_init(struct netns_ipvs *ipvs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i, idx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ip_vs_control_net_init_sysctl(ipvs))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                goto err;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其呼叫了 <code>ip_vs_control_net_init_sysctl</code></p><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_SYSCTL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int __net_init ip_vs_control_net_init_sysctl(struct netns_ipvs *ipvs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct net *net = ipvs-&gt;net;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int idx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct ctl_table *tbl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        idx = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tbl[idx++].data = &amp;ipvs-&gt;sysctl_backup_only;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ipvs-&gt;sysctl_conn_reuse_mode = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tbl[idx++].data = &amp;ipvs-&gt;sysctl_conn_reuse_mode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tbl[idx++].data = &amp;ipvs-&gt;sysctl_schedule_icmp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tbl[idx++].data = &amp;ipvs-&gt;sysctl_ignore_tunneled;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ipvs-&gt;sysctl_hdr = register_net_sysctl(net, &quot;net/ipv4/vs&quot;, tbl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述的概念就是創建一個 <strong>struct ctl_table *tbl</strong> 的物件，並且填入相關的資訊後，呼叫 <strong>register_net_stsctl</strong> 來註冊這一系列的路徑，也可以觀察到其子路徑就是 <strong>net/ipv4/vs</strong>. 而這些 <strong>table</strong> 的資料的定義如下</p><div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      IPVS sysctl table (under the /proc/sys/net/ipv4/vs/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      Do not change order or insert new entries without</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      align with netns init in ip_vs_control_net_init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static struct ctl_table vs_vars[] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .procname       = &quot;amemthresh&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .maxlen         = sizeof(int),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .mode           = 0644,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .proc_handler   = proc_dointvec,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .procname       = &quot;am_droprate&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .maxlen         = sizeof(int),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .mode           = 0644,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .proc_handler   = proc_dointvec,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .procname       = &quot;drop_entry&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .maxlen         = sizeof(int),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .mode           = 0644,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .proc_handler   = proc_do_defense_mode,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_IP_VS_DEBUG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .procname       = &quot;debug_level&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .data           = &amp;sysctl_ip_vs_debug_level,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .maxlen         = sizeof(int),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .mode           = 0644,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .proc_handler   = proc_dointvec,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊用一種格式化的方式去定義每個路徑的 <strong>名稱, 類別， 相關的處理函式以及存取模式</strong>，特別注意到的是 <strong>debug_level</strong> 本身則是被 <strong>ifdef CONFIG_IP_VS_DEBUG</strong> 這個 <strong>macro</strong> 給包起來，所以如果沒有特別處理的話，預設情況下就不會把 <strong>debug_level</strong> 給編譯進去。</p><p>觀看這些資料還有一個好處就是你可以知道系統中有哪些參數可以餵給 Kernel 去處理，同時也可以搭配觀看原始碼的方式來了解這些參數到底實際上做了什麼。</p><p>這邊有一個概念要注意的就是 <strong>net</strong> 這個物件是 <strong>kernel</strong> 內網路系統最重要的結構，每個 <strong>netowrk namespace</strong> 都會有一個自己的副本，基本上只要函數本身有吃 <strong>net</strong> 參數，就可以猜到這個功能絕對是每個 <strong>network namespace</strong> 獨立。這邊要特別注意的是 <strong>Host</strong> 本身也是一個 <strong>network namespace</strong>，所以當我們註冊這個函式的時候，就會先針對系統本身這個 <strong>network namespace</strong> 呼叫這一組對應的 <strong>init function</strong>.</p><p>如果你的操作環境是舊版一點的 <code>kernel</code> ，譬如 <code>4.4.0</code> 之類的，你可以在系統觀察到類似下列的訊息</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[3534469.163231] IPVS: Creating netns size=2192 id=1342</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[3534793.388007] IPVS: Creating netns size=2192 id=1343</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[3535052.371673] IPVS: Creating netns size=2192 id=1344</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[3535706.550968] IPVS: Creating netns size=2192 id=1345</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[3535761.378872] IPVS: Creating netns size=2192 id=1346</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[3537083.860486] IPVS: Creating netns size=2192 id=1347</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>題外話， <code>kernel code</code> 內滿滿的 <code>goto</code>, <code>goto</code> 不是不能用，而是你要會用，可以看看 <strong>kernel</strong> 這邊的用法，同時你也可以想想不用 <strong>goto</strong> 的話，這些程式碼你會怎麼修改。</p><h1>Summary</h1><p>今天這個章節針對 <strong>IPVS</strong> 底層的資訊進行了粗略地探索，主要是知道要如何透過 <strong>IPVS</strong> 提供的方式來進行除錯，藉由這除錯方式之後會更方便地去整個瞭解程式的呼叫脈絡並且我認為也是一個很好的學習方式</p><p>對於 <strong>IPVS</strong> 的概念可以理解成，<strong>IPVS</strong> 的功能由 <strong>Kernel</strong> 提供，但是每個 <strong>network namespace</strong> 互相獨立不影響彼此，所以你到不同的 <strong>network namespace</strong> 內透過 <strong>ipvsadm</strong> 看到的結果都互相獨立，不會牽扯彼此。</p><p>透過註冊 <strong>register_pernet_subsys</strong> 這個函式， <strong>ipvs</strong> 能夠自動對系統上每個已經存在/未來新增的 <strong>network namespace</strong> 進行處理，幫其初始化 <strong>ipvs</strong> 相關的物件。</p><p>最後，由於 <strong>init</strong> 函式開始後就會去進行 <strong>sys</strong> 相關的初始化，來不及將 <strong>debug_level</strong> 設定而輸出，因此我在修改原始碼之後重新安裝到系統來觀察更細部的 <strong>init</strong> 流程。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783857] IPVS: Enter: ip_vs_init, net/netfilter/ipvs/ip_vs_core.c line 2371</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783858] IPVS: Enter: ip_vs_control_init, net/netfilter/ipvs/ip_vs_ctl.c line 4122</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783862] IPVS: Enter: ip_vs_protocol_init, net/netfilter/ipvs/ip_vs_proto.c line 338</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783863] IPVS: Registered protocols (TCP, UDP, SCTP, AH, ESP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783864] IPVS: Enter: ip_vs_conn_init, net/netfilter/ipvs/ip_vs_conn.c line 1403</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783937] IPVS: Connection hash table configured (size=4096, memory=64Kbytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783937] IPVS: Each connection entry needs 288 bytes at least</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783944] IPVS: Enter: __ip_vs_init, net/netfilter/ipvs/ip_vs_core.c line 2257</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783945] IPVS: Enter: ip_vs_control_net_init, net/netfilter/ipvs/ip_vs_ctl.c line 4037</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783951] IPVS: Enter: ip_vs_control_net_init_sysctl, net/netfilter/ipvs/ip_vs_ctl.c line 3926</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783963] IPVS: Enter: ip_vs_protocol_net_init, net/netfilter/ipvs/ip_vs_proto.c line 309</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783966] IPVS: Enter: ip_vs_conn_net_init, net/netfilter/ipvs/ip_vs_conn.c line 1384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.783968] IPVS: Enter: __ip_vs_dev_init, net/netfilter/ipvs/ip_vs_core.c line 2329</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.981664] IPVS: Enter: ip_vs_register_nl_ioctl, net/netfilter/ipvs/ip_vs_ctl.c line 4091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[669447.981678] IPVS: ipvs loaded.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下一章節我們會主要針對 封包的流向 來進行探討，包含 <strong>iptables/netfilter</strong> 與之的互動，以及實際由本地端送出一個封包後，實際上背後的運作邏輯是哪些，又會呼叫到哪些 <strong>function</strong> 來處理。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/ipvs">IPVS</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">Linux</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kernel">Kernel</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2020/ipvs-2"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">IPvS 學習手冊(二)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2020/ipvs-4"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">IPvS 學習手冊(四)</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#dynamic-option" class="table-of-contents__link toc-highlight">Dynamic Option</a></li><li><a href="#ip_vs_debug" class="table-of-contents__link toc-highlight">IP_VS_DEBUG</a></li><li><a href="#register_pernet_subsysdevice" class="table-of-contents__link toc-highlight">register_pernet_subsys/device</a></li><li><a href="#ip_vs_control_net_init" class="table-of-contents__link toc-highlight">ip_vs_control_net_init</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3dd55255.js"></script>
<script src="/assets/js/main.d1744312.js"></script>
</body>
</html>