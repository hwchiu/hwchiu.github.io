<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2020/docker-network-model-snat" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Docker 網路入門篇(三) - 網路存取分析 | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.hwchiu.com/docs/2020/docker-network-model-snat"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Docker 網路入門篇(三) - 網路存取分析 | hwchiu learning note"><meta data-rh="true" name="description" content="本篇文章探討 Docker Bridge 網路模型的運作過程，透過一系列步驟去拆解到底容器是如何對外上網"><meta data-rh="true" property="og:description" content="本篇文章探討 Docker Bridge 網路模型的運作過程，透過一系列步驟去拆解到底容器是如何對外上網"><meta data-rh="true" name="keywords" content="docker,network"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.hwchiu.com/docs/2020/docker-network-model-snat"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2020/docker-network-model-snat" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2020/docker-network-model-snat" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://L4HXL74VLW-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="hwchiu learning note" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5bc72551.css">
<link rel="preload" href="/assets/js/runtime~main.0b7f5591.js" as="script">
<link rel="preload" href="/assets/js/main.77e0ace0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/cncf-tech-radar-cd">CNCF Continuous Delivery 使用者調查報告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/cncf-tech-radar-observability">CNCF Observability 使用者調查報告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/cni-performance-2020">[文章導讀] - 基於10G網路的 Kubernetes CNI 效能比較</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/docker-network-model-lab-dnat">Docker 網路入門篇(四) - 外界主動存取</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/docker-network-model-lab">Docker 網路入門篇(二) - Bridge 網路模型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2020/docker-network-model-snat">Docker 網路入門篇(三) - 網路存取分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/docker-network-model">Docker Network - 網路模型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-bad-and-ugly">GitOps 帶來的痛點與反思</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch1">[書本導讀]-GitOps 到底解決了什麼問題</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch2">[書本導讀]-什麼是GitOps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch3">[書本導讀]-淺談GitOps過往</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch4">[書本導讀]-GitOps工具的選擇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch5">[書本導讀]- GitOps實作上的挑戰</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops-book-ch6">[書本導讀]-GitOps後續</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/gitops">淺談 GitOps 的概念</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/2020/iThome_Challenge/cicd">iThome_Challenge</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/iptables-1">初探 IPTABLES 流動之路 - 以 Docker 為範例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/iptables-masquerade-handson">Linux NAT Masquerade 研究(下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/ipvs-1">IPvS 學習手冊(一)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/ipvs-2">IPvS 學習手冊(二)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/ipvs-3">IPvS 學習手冊(三)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/ipvs-4">IPvS 學習手冊(四)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/kubernetes-duplicate-pod-ip">Kubernetes - IP 重複奇遇記</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2020/kubernetes-static-pod">[Kubernetes] Static Pod 介紹</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2020"><span itemprop="name">2020</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Docker 網路入門篇(三) - 網路存取分析</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>前言</h1><p>本篇文章是 Docker 網路入門篇系列文第三篇，閱讀本文前要先有前面兩篇文章的基本概念，因此還不夠熟悉的讀者可以再次閱讀前面兩篇文章</p><p><a href="https://www.hwchiu.com/docs/2020/docker-network-model" target="_blank" rel="noopener noreferrer">Docker Network - 網路模型</a>
<a href="https://www.hwchiu.com/docs/2020/docker-network-model-lab" target="_blank" rel="noopener noreferrer">Docker 網路入門篇(二) - Bridge 網路模型</a></p><blockquote><p>這系列的文章都會用比較使用者的角度來探討網路概念，比較不會去深度探討底層實作細節</p></blockquote><h1>本文</h1><p>前篇文章中，我們透過指令的方式一步一步的打造一個 Bridge 網路模型，最後成功的讓兩個容器可以透過  ping 指令來互相存取，然而該環境中這兩個容器都沒有辦法對外上網，而且最後的過程中我們還留下了一個 iptables 指令的未解之謎，因此本篇文章要來將這些資訊給釐清作為一個完結篇</p><p>這篇文章會從三個面向，配上三個主軸來進行探討，分別是</p><ol><li>容器間如何互相存取</li><li>容器如何主動存取外部服務</li><li>外部網路如何主動存取容器</li></ol><p>其中第三點的功能就是 <strong>docker -p</strong> 這功能的意思，因此範例中也會仔細介紹如何使用</p><p>每個面向裡面都由三個主軸來探討，分別是</p><ol><li>封包要送給誰</li><li>誰來處理封包</li><li>誰來過濾封包</li></ol><p>用技術層面來講上面三個概念的話，大概是下列這些內容，不過本文不會太細究每個元件的內容</p><ol><li>routing table + forwrding table</li><li>kernel + iptables + conntrack</li><li>iptables</li></ol><h1>環境</h1><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ lsb_release -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No LSB modules are available.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Distributor ID: Ubuntu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description:    Ubuntu 18.04.3 LTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Release:        18.04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Codename:       bionic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ uname -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Linux k8s-dev 4.15.0-72-generic #81-Ubuntu SMP Tue Nov 26 12:20:02 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Docker version 19.03.13, build 4484c46d9d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>實驗所有步驟都可以於 <a href="https://github.com/technologynoteniu/bloglab" target="_blank" rel="noopener noreferrer">GitHub Repo</a> 中找到</p><h1>容器間如何存取</h1><p>本實驗是基於上次環境來進行後續觀察，到底一個簡單的 ICMP 封包可以通實際上系統中到底做了什麼事情。</p><p>可以直接執行範例 Repo 中的 <strong>docker_network_basic_3/lab1.sh</strong> 來打造上次的環境</p><p>首先，我們的環境中，特別設定了同網段的封包，所以這個環境中的存取就會相對簡單</p><p>整個環境架構圖如下
架構中兩個容器 C1 &amp; C2 透過我們自行創造的 Linux Bridge(hwchiu0) 以及相關的 <strong>veth</strong> 虛擬網卡來串間彼此。</p><p><img loading="lazy" src="https://i.imgur.com/XhNnxAq.jpg" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="封包要送給誰">封包要送給誰<a href="#封包要送給誰" class="hash-link" aria-label="Direct link to 封包要送給誰" title="Direct link to 封包要送給誰">​</a></h2><p>之前我們透過 <strong>ifconfig</strong> 幫 <strong>eth0</strong> 設定 IP 後，Kernel 會針對該網卡設定一個 Routing 規則，告訴系統說，什麼樣的封包，往什麼樣的網卡送出去</p><p>我們來看一下當前兩個容器 C1 &amp; C2 分別的狀態長怎樣</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">○ → docker exec c1 route -n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kernel IP routing table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.55.66.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">○ → docker exec c2 route -n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kernel IP routing table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.55.66.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這兩個訊息的概念都很簡單，就是告訴系統，當未來看到 <strong>10.55.66.0/24</strong> 的封包，就往 eth0 這張網卡送出去，但是因為 eth0 網卡是由 <strong>veth</strong> 組成的， <strong>veth</strong> 就如同水管一樣，從左邊進去，右邊就會出來，因此送到 <strong>eth0</strong> 的封包就會馬上從另一端的 <strong>veth0/veth1</strong> 跑出來。</p><p>概念如下圖
根據上述觀念，當前兩個容器往 <strong>10.55.66.0/24</strong> 的封包最後都會從宿主機身上的 <strong>veth0/veth1</strong> 上出現。</p><p><img loading="lazy" src="https://i.imgur.com/YxMBsYX.jpg" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="誰來處理封包">誰來處理封包<a href="#誰來處理封包" class="hash-link" aria-label="Direct link to 誰來處理封包" title="Direct link to 誰來處理封包">​</a></h2><p>當封包進入 eth0 網卡，之後從 veth0/veth1 出現後，因為 <strong>veth0/veth1</strong> 本身是掛在 Linux Bridge (hwchiu0) 身上，因此封包就會交由 <strong>Linux Bridge</strong> 來處理！</p><p>這邊的處理分成兩個部分(這邊不談實際封包處理順序)</p><ol><li>Linux Bridge 內部會有一個機制用來決定如何轉送封包</li><li>ebtables (本文忽略這個概念)</li></ol><p>Linux Bridge 的轉送機制是基於 <strong>MAC Address</strong> 來決定封包怎麼轉送，而這份轉換表可以稱為 Forwarding Table，根據 <strong>MAC Address</strong> 來轉發封包</p><p>下圖為一個範例，當封包進入到 Linux Bridge 後，其會根據封包的目標 <strong>MAC Address</strong> 是誰，來決定從哪個 <strong>Port</strong> 送出去。</p><p>因此我們的範例中，C1/C2 容器之間的封包就是透過這種機制來處理轉發。
<img loading="lazy" src="https://i.imgur.com/Cns14pD.jpg" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="誰來過濾封包">誰來過濾封包<a href="#誰來過濾封包" class="hash-link" aria-label="Direct link to 誰來過濾封包" title="Direct link to 誰來過濾封包">​</a></h2><p>有了上述的規則後，C1/C2 容器之間要可以互相傳輸封包了，但是實務上卻發現會有問題，我們的 PING 不會通，原因是因為 <strong>iptables</strong> 偷偷介入來進行處理，並且將不符合規則的封包都丟棄。</p><p>這邊有兩個議題</p><ol><li>iptables 為什麼偷偷介入來處理</li><li>為什麼不符合規則的封包要丟棄，而不是符合規則的封包才丟棄</li></ol><p><strong>iptables</strong> 預設不會干擾任何 <strong>Linux Bridge</strong> 轉發的封包，這邊是有個開關要打開，也是 <strong>docker</strong> 安裝後會幫忙打開的開關</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">→ cat /proc/sys/net/bridge/bridge-nf-call-iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊我們可以做個實驗，步驟是</p><ol><li>確認當前網路不通</li><li>將上述開關關閉，讓 iptables 不要干涉</li><li>重新發送 ping</li></ol><p>這時候就會發現容器之間可以透過 ICMP 傳送封包了</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c1 ping 10.55.66.3 -c1 -W1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.55.66.3 (10.55.66.3) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- 10.55.66.3 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 packets transmitted, 0 received, 100% packet loss, time 0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ echo &quot;0&quot; | sudo tee /proc/sys/net/bridge/bridge-nf-call-iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c1 ping 10.55.66.3 -c1 -W1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.55.66.3 (10.55.66.3) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.55.66.3: icmp_seq=1 ttl=64 time=0.025 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- 10.55.66.3 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtt min/avg/max/mdev = 0.025/0.025/0.025/0.000 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ echo &quot;1&quot; | sudo tee /proc/sys/net/bridge/bridge-nf-call-iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>當 <strong>iptables</strong> 被告知要干涉 <strong>Linux Bridge</strong> 的封包管理後，所有經過的封包都會讓 <strong>iptables</strong> 來進行檢查</p><p>Docker 的環境之中，採取的是白名單機制，若沒有告知要通過，則將該封包給丟棄，所以這也是為什麼我們的封包不會通過。
這邊有兩種解決方法</p><ol><li>修改成黑名單的概念，預設通過封包</li><li>加入相關規則，讓我們的封包可以通過</li></ol><p>前一篇文章的實驗就是針對 (1) 進行操作,這邊透過 <strong>iptables -P FORWARD ACCEPT</strong> 去說明，對於 <strong>FORAWRD</strong> 封包的處理，預設就是 <strong>ACCEPT</strong> 去接納他們</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c1 ping 10.55.66.3 -c1 -W1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.55.66.3 (10.55.66.3) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- 10.55.66.3 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 packets transmitted, 0 received, 100% packet loss, time 0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo iptables -P FORWARD ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c1 ping 10.55.66.3 -c1 -W1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.55.66.3 (10.55.66.3) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.55.66.3: icmp_seq=1 ttl=64 time=0.039 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- 10.55.66.3 ping statistics ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtt min/avg/max/mdev = 0.039/0.039/0.039/0.000 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># recover</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo iptables -P FORWARD DROP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a href="#結論" class="hash-link" aria-label="Direct link to 結論" title="Direct link to 結論">​</a></h2><p>針對同節點上不同容器之間的傳輸，基本上都是依靠 <strong>Linux Bridge</strong> 來幫忙處理，藉由 <strong>Forwarding Table</strong> 來決定該怎麼傳輸封包，透過 <strong>iptables</strong> 來決定封包能不能通行。</p><p>Docker 預設的情況下會讓 <strong>iptables</strong> 介入 <strong>Linux Bridge</strong> 的處理，同時採由白名單機制，沒有符合規則的就一律丟棄，而 Docker 這邊的作法則是會加入相關的規則來打通封包連接。</p><p><img loading="lazy" src="https://i.imgur.com/b1veY6Z.jpg" class="img_ev3q"></p><h1>容器如何主動存取外部服務</h1><p>上述討論了容器間的基本存取方式，有了上述的概念之後，我們接下來可以往下邁進去探討，如果容器想要存取外部服務，譬如 8.8.8.8 之類的外部網站時，到底該怎麼處理，這也是容器服務中最常使用的類型，畢竟沒有對外上網能力，很多事情都沒辦法完成。</p><p>這個範例中將探討如何讓一個容器作為我們的 Client 端，能夠透過 PING 這個指令來存取外部 8.8.8.8 服務器</p><p>架構圖如下方，最終目標是容器 C1 能夠用 ping 存取 8.8.8.8
<img loading="lazy" src="https://i.imgur.com/PtgBuvH.jpg" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="封包要送給誰-1">封包要送給誰<a href="#封包要送給誰-1" class="hash-link" aria-label="Direct link to 封包要送給誰" title="Direct link to 封包要送給誰">​</a></h2><p>封包的轉送我們一開始都需要先決定，到底送給誰，這邊我們再次回顧一下當前容器 c1 內的路由表</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c1 route -n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kernel IP routing table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.55.66.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這時候如果我們強行連接 8.8.8.8 的話，會得到相關錯誤,因為系統中根本不知道要怎麼轉送 8.8.8.8 的封包，完全沒有可以符合的規則使用</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c1 ping 8.8.8.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connect: Network is unreachable</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>網路除錯時要格外小心與謹慎，我建議所有網路除錯都是先畫出架構圖，然後思考一下你認為封包該怎麼運作，對於所有關鍵點你有沒有辦法舉證他是對或是錯，藉由這個過程縮小可能出錯的範圍。</p></blockquote><p>為了解決這個問題，我們可以 <strong>明確告訴系統，看到 8.8.8.8 的封包該怎麼送</strong>
但是這種思路造成的問題就是如果今天你想要存取 <strong>1.1.1.1</strong>，你就要額外的新規則，所以我們可以透過另外一種作法。</p><p><strong>沒有符合任何規則的話，就走預設走法吧！</strong>
這也是系統實務上常見的作法，因為沒有人有辦法預料到你會想要連哪個網站，針對每個網站都寫一條規則實在是不太合理</p><p>有了這個想法後，我們下一個問題就是，那我要送給誰幫忙處理，這邊因為牽扯到 L3 路由的概念相對複雜，直接講結論就是
我們希望透過 <strong>宿主機</strong> 幫我們處理，如果宿主機本身就有能力存取外部網路，我們是不是能夠依賴宿主機幫我們處理，我們只要想辦法將封包送給宿主機，讓宿主機知道有封包要處理，請繼續往下弄</p><p>為了達成這個條件，我們需要進行下列設定</p><ol><li>給 Linux Bridge (hwchiu0) 一個 IP 地址</li><li>告訴容器說，預設走法就是將封包送給 <strong>Linux Bridge (hwchiu0)</strong></li></ol><p>上述兩個概念轉換成系統指令如下</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo ifconfig hwchiu0 10.55.66.1 netmask 255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo docker exec -it c1 ip route add default via 10.55.66.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo docker exec -it c1 ip route show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default via 10.55.66.1 dev eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.55.66.0/24 dev eth0  proto kernel  scope link  src 10.55.66.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>設定完畢後，我們容器現在多了一個規則，預設情況下，就將封包透過 <strong>eth0</strong> 送出去，並且將其 閘道(Gateway) 設定成 <strong>10.55.66.1</strong>。</p><blockquote><p>這邊不解釋 Gateway 的概念，想成我們想要透過 Linux Bridge 幫我們轉發，封包送給他就對了！</p></blockquote><p>接下來針對系統上的 <strong>eth0</strong> 去監聽封包，看看這時候從 <strong>container c1</strong> 發送封包到 8.8.8.8 會怎麼樣</p><p><strong>為了避免 iptables 又來干擾過濾功能，我們先修改成預設封包都會通</strong></p><p><strong>開兩個視窗執行</strong></p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo iptables -P FORWARD ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo docker exec -it c1 ping 8.8.8.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo tcpdump -vvvnn -i eth0 icmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">19:01:20.425931 IP (tos 0x0, ttl 63, id 60779, offset 0, flags [DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.55.66.2 &gt; 8.8.8.8: ICMP echo request, id 16700, seq 1, length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">19:01:21.445051 IP (tos 0x0, ttl 63, id 60899, offset 0, flags [DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.55.66.2 &gt; 8.8.8.8: ICMP echo request, id 16700, seq 2, length 64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>透過上述指令可以觀察到，封包還是不通，沒有辦法得到正確的 ICMP 回應，但是我們可以從宿主機上面的 <strong>eth0</strong> 觀察到相關封包了，這些封包標示 <strong>10.55.66.2</strong> 想要送給 <strong>8.8.8.8</strong>。</p><p>只是目前都只有看到 <strong>ICMP</strong> 的請求，而沒有回應。</p><p>上述的所有流程我們用下列流程圖再次解釋</p><p>該圖片怎麼觀看</p><ol><li>上面白色框框代表不同元件，若元件上方有IP，則代表該元件的 IP 地址</li><li>每個元件之間透過箭頭來描述封包流向，並且表明該流向中，封包內的 <strong>IP</strong> 地址是什麼，<strong>由誰送給誰</strong></li><li>封包流向下方描述的則是當前過程中，有哪些元件涉入進行處理</li></ol><p><img loading="lazy" src="https://i.imgur.com/POi2cVr.jpg" class="img_ev3q"></p><p>重新整理目前已知流程與思路</p><ol><li>當容器內發出一個送往 <strong>8.8.8.8</strong> 的封包，因為規則的關係，該封包會透過 <strong>eth0</strong> 送出去</li><li>當封包從 <strong>eth0</strong> 送出去後，因為 <strong>veth</strong> 的特性，封包會到達系統上的 <strong>veth0</strong> 虛擬網卡</li><li>從 <strong>veth0</strong> 進入到 <strong>Linux Bridge</strong> 的世界，這時候透過 <strong>Forwarding Table</strong> 的概念，最終該封包會進入到 Linux Bridge(hwchiu0) 本身。</li><li>hwchiu0 收到封包後，接下來都是 <strong>kernel</strong> 內的事情了，這邊太複雜，我們忽略</li><li>Kernel 最後透過本身的 <strong>routing talbe</strong> 去查詢，該怎麼轉送 <strong>8.8.8.8</strong> 的封包，然後根據規則送往宿主機上的 <strong>eth0</strong> 網卡</li><li>封包送了出去，但是我們沒有辦法監聽到回來的封包</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="誰來處理封包-1">誰來處理封包<a href="#誰來處理封包-1" class="hash-link" aria-label="Direct link to 誰來處理封包" title="Direct link to 誰來處理封包">​</a></h2><p>為什麼收不到封包，理由很簡單
我們送出去的封包來源是 <strong>10.55.66.2</strong>，大部分情況下我們這個網段都是 <strong>private</strong>，也就是私有網段，世界上可能有很多人都會使用 <strong>10.55.66.2</strong>，那這種情況下， <strong>8.8.8.8</strong> 根本不知道要怎麼把封包送回給 <strong>10.55.66.2</strong></p><p>這時候我們要來思考，我們的宿主機是不是可以上網，是不是他的封包都回得來？
如果是的話，我們能不能叫宿主機幫忙好人作到底，把封包的來源也變成宿主機的 <strong>IP</strong> ? 然後宿主機再想辦法把封包轉送回給我們後面的容器即可</p><p>這個概念就是所謂的 Network Address Translation (NAT)，這個範例中我們想要修改封包的來源 <strong>IP</strong> 地址，因此這個行為我們會稱為 Source NAT (SNAT)。</p><p>為了達成這個目的，我們要透過 <strong>iptables</strong> 的規則來幫我們做，而 <strong>iptables</strong> 有多種用法可以滿足這個需求，我們決定採用最簡單的也是最常用的方式, <strong>MASQUERADE</strong>，這種動態 SNAT 的功能來處理</p><blockquote><p>工商我的其他文章，從 Linux Kernel Source Code 來探討這個行為，不適合初學者看 <a href="https://www.hwchiu.com/docs/2019/iptables-masquerade" target="_blank" rel="noopener noreferrer">Linux NAT Masquerade 研究(上)
</a></p></blockquote><p>我們使用下列規則，告訴 <strong>iptables</strong> 說，以後你只要看到 <strong>10.55.66.2/32</strong> 的封包，而且要從宿主機上面的 <strong>eth0</strong> 送出去的，請你順便幫忙修改封包來源，改成自己</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo iptables -t nat -I POSTROUTING -s 10.55.66.2/32 -o eth0 -j MASQUERADE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo docker exec -it c1 ping 8.8.8.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 8.8.8.8: icmp_seq=1 ttl=61 time=18.2 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 8.8.8.8: icmp_seq=2 ttl=61 time=15.0 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這時候我們再透過 <strong>tcpdump</strong> 來監聽封包，就會觀察到一切都不同了!</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo tcpdump -vvvnn -i eth0 icmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">19:40:52.893673 IP (tos 0x0, ttl 63, id 39804, offset 0, flags [DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.0.2.15 &gt; 8.8.8.8: ICMP echo request, id 19069, seq 3, length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">19:40:52.906130 IP (tos 0x0, ttl 62, id 11543, offset 0, flags [DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    8.8.8.8 &gt; 10.0.2.15: ICMP echo reply, id 19069, seq 3, length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">19:40:54.962322 IP (tos 0x0, ttl 63, id 40179, offset 0, flags [DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.0.2.15 &gt; 8.8.8.8: ICMP echo request, id 19079, seq 1, length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">19:40:54.977470 IP (tos 0x0, ttl 62, id 11559, offset 0, flags [DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    8.8.8.8 &gt; 10.0.2.15: ICMP echo reply, id 19079, seq 1, length 64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>裡面的內容我們分成兩筆來看</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">19:40:52.893673 IP (tos 0x0, ttl 63, id 39804, offset 0, flags [DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.0.2.15 &gt; 8.8.8.8: ICMP echo request, id 19069, seq 3, length 64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我們可以看到出去的封包 <strong>IP</strong> 再也不是 <strong>10.55.66.2</strong> 了，而是宿主機本身的 <strong>10.0.2.15</strong>，你可能會想說 <strong>10.0.2.15</strong> 也是私有 IP，為什麼 <strong>8.8.8.8</strong> 本身可以回應，這是因為我的系統環境外面還有一層 <strong>SNAT</strong>，一個封包經歷過多次 SNAT 是滿正常且合理的，但是整個運作邏輯都是一致的</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    8.8.8.8 &gt; 10.0.2.15: ICMP echo reply, id 19069, seq 3, length 64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這個情況下我們也可以看到封包順利回來了，同時從容器中也可以看到 <strong>ICMP</strong> 有正常回應。</p><p>這邊補充一下，如果我們針對 <strong>hwchiu0</strong> 這張 Linux Bridge 的網卡去監聽封包，會得到下列資訊</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo tcpdump -vvvnn -i hwchiu0 icmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcpdump: listening on hwchiu0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">19:47:55.128471 IP (tos 0x0, ttl 64, id 18861, offset 0, flags [DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.55.66.2 &gt; 8.8.8.8: ICMP echo request, id 19515, seq 1, length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">19:47:55.146004 IP (tos 0x0, ttl 61, id 11872, offset 0, flags [DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    8.8.8.8 &gt; 10.55.66.2: ICMP echo reply, id 19515, seq 1, length 64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>從 <strong>hwchiu0</strong> 的角度來看，他看到的封包都是 <strong>10.55.66.2</strong>，跟宿主機上面的 IP 沒有任何關係。</p><p>所以上述的概念我們用一樣的流程圖來看，這時候會變成怎麼樣</p><p>這份圖中，我們可以順利接收封包，所以多了回來封包的路線，其中 <strong>IP</strong> 特別用紅色底標示代表的是該封包是有被改過的。</p><p><img loading="lazy" src="https://i.imgur.com/tBBZIn7.jpg" class="img_ev3q"></p><p>這邊重新整理所有思路，將其條列下來</p><ol><li>封包按照前面所有概念，一路送到 Linux Kernel</li><li>Linux Kernel 這時候查詢完 Routing Table 後，確認封包要送給 <strong>eth0</strong></li><li>iptables 這時候會介入，透過 <strong>MASQUERADE</strong> 的功能來修改封包的來源 ip 地址</li><li>封包的來源被修改成 <strong>10.0.2.15</strong>，最後 <strong>8.8.8.8</strong> 收到這些封包後一路送回來</li><li>回應的封包到達 <strong>eth0</strong> 之後，<strong>iptables</strong> 再度介入，畢竟誰幫你轉換封包，誰就要幫你轉回來，幫你把封包的目標從 <strong>10.0.2.15</strong> 轉回最初的 <strong>10.55.66.2</strong><blockquote><p>其實更精準的說這邊還有 conntrack 的介入來處理，但是過於複雜，因此這邊忽略，我們懂大概念就好</p></blockquote></li><li>封包一路透過 Linux Bridge + Forwardnig Table + Veth 等元件回到容器手上</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="誰來過濾封包-1">誰來過濾封包<a href="#誰來過濾封包-1" class="hash-link" aria-label="Direct link to 誰來過濾封包" title="Direct link to 誰來過濾封包">​</a></h2><p>到這邊為止，基本上我們的容器已經可以對外存取了，但是這邊有個前提是，我們事先修改 <strong>iptables</strong> 的規則，讓他預設是轉送封包，而不是丟棄</p><blockquote><p>Docker 安裝完畢後，會讓 iptables <strong>FORWARD</strong> 預設丟棄封包，所以 docker 會針對這一塊去撰寫規則讓你的容器可以對外上網</p></blockquote><p>因此這個小節我們就來看看，要如何透過 iptables 來允許我們的封包通過</p><p>根據我們前面的流程加上最初的運作，其實 iptables 運作的地方有兩個</p><ol><li>Linux Bridge 這邊會偷偷請 iptables 處理一次</li><li>Linux Kernel 往宿主機 eth0 這邊發送時也會有一次</li></ol><p>這兩個環節於這個情境下，概念完全不同。
對於 Linux Bridge(hwchiu0) 來說，容器的封包會到達他身上，這邊是&quot;到達&quot;他身上，因此 <strong>iptables</strong> 內的規則就不是 <strong>FORWARD</strong> 這種轉發概念來處理，而是 <strong>INPUT</strong> 來處理。因此這邊我們就不需要特別處理</p><blockquote><p>INPUT chain 本身沒有被改成預設丟棄，因此都會通</p></blockquote><p>相反的，第二個流程是 <strong>LINUX KERNEL</strong> 轉發封包，從 <strong>eth0</strong> 出發，因此這邊 <strong>iptables</strong> 的 <strong>FORWARD</strong> 規則表就要被考慮，所以我們要處理的就是這一段過程</p><p>首先我們將 <strong>iptables</strong> 中的 <strong>FORWARD</strong> 修改回預設丟棄封包，回歸到安裝好 <strong>docker</strong> 的設定。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo iptables -P FORWARD DROP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo docker exec -it c1 ping 8.8.8.8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這時候你會發現封包不會通，透過 <strong>tcpdump</strong> 去監聽 <strong>eth0</strong> 的封包也沒有任何訊息，不過若是監聽 <strong>hwchiu0</strong> 則是會有封包</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo tcpdump -vvvnn -i eth0 icmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 packets captured</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 packets received by filter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 packets dropped by kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo tcpdump -vvvnn -i hwchiu0 icmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcpdump: listening on hwchiu0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">20:16:28.313865 IP (tos 0x0, ttl 64, id 60164, offset 0, flags [DF], proto ICMP (1), length 84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.55.66.2 &gt; 8.8.8.8: ICMP echo request, id 21202, seq 33, length 64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所以我們要透過 <strong>iptables</strong> 告訴系統，請允許我們的封包通過，這邊有非常多種思路</p><ol><li>針對來源與目的 IP 去處理</li><li>針對來源與目的 網卡 去處理</li></ol><p>用網卡會簡單很多，這部份沒有一定，完全看你設計， <strong>docker</strong> 會使用網卡來處理，這樣規則數量不會因為容器過多而變多。</p><p>以下是我們使用的規則，我們告訴 <strong>iptables</strong> 說</p><ol><li>從 hwchiu0 到 eth0 的封包，給他過！</li><li>從 eth0 到 hwchiu0 的封包，給他過 !</li></ol><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo iptables -t filter -I FORWARD -i hwchiu0 -o eth0 -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo iptables -t filter -I FORWARD -i eth0 -o hwchiu0 -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo docker exec -it c1 ping 8.8.8.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 8.8.8.8: icmp_seq=1 ttl=61 time=16.3 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 8.8.8.8: icmp_seq=2 ttl=61 time=15.8 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這時後來看架構圖，這個範例中， iptables 會有兩個地方干涉，分別是進入到 hwchiu0 以及宿主機 eth0 兩個地方。
但是兩個地方因為概念不同，使用的是 iptables 下不同的表，而我們這邊針對 FORWARD 表去處理，因為其預設是丟棄封包
<img loading="lazy" src="https://i.imgur.com/ZyOxFzc.jpg" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="總結">總結<a href="#總結" class="hash-link" aria-label="Direct link to 總結" title="Direct link to 總結">​</a></h2><p>到這邊為止，我盡可能的用簡單的方式去描述，到底一個容器要對外上網中間會發生什麼事情，而這些事情平常我們都沒有感覺，是因為 <strong>docker</strong> 本身都幫我們處理完畢了，整體思路都完全一樣，不過對於 <strong>iptables</strong> 的規則會因為細度不同，所以下法也不太一樣。</p><h1>總結</h1><p>由於本篇文章已經過長，因此如何從外部存取容器就留到下篇文章再來分享</p><p>綜合本文與前文，這邊幫大家整理一下，基於 <strong>Bridge</strong> 網路模型下， Docker 容器是如何對外上網</p><ol><li>擁有 Linux Bridge，並且設定一個 IP</li><li>創造容器，透過 veth 將容器與宿主機的 Linux Bridge 連接</li><li>對容器內的網卡設定 IP，並且設定一個預設路由規則，讓 Linux Bridge 幫忙轉發對外封包</li><li>設定相關 iptables 規則，讓系統轉發時，封包不會被丟棄</li><li>設定 iptables SNAT 規則，讓我們往外的封包能夠有機會回來，最後輾轉回到容器手上</li></ol><p>這一系列的規則看起來很多，但是其實整體都圍繞再 TCP/IP 的網路規則下，簡單的說就是
封包該怎麼走，誰幫忙處理封包，會不會有人攔截封包
將這三個思路整理下來，就可以很清晰的去分析封包的走向與除錯</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/docker">Docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">Kubernetes</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2020/docker-network-model-lab"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Docker 網路入門篇(二) - Bridge 網路模型</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2020/docker-network-model"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Docker Network - 網路模型</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#封包要送給誰" class="table-of-contents__link toc-highlight">封包要送給誰</a></li><li><a href="#誰來處理封包" class="table-of-contents__link toc-highlight">誰來處理封包</a></li><li><a href="#誰來過濾封包" class="table-of-contents__link toc-highlight">誰來過濾封包</a></li><li><a href="#結論" class="table-of-contents__link toc-highlight">結論</a></li><li><a href="#封包要送給誰-1" class="table-of-contents__link toc-highlight">封包要送給誰</a></li><li><a href="#誰來處理封包-1" class="table-of-contents__link toc-highlight">誰來處理封包</a></li><li><a href="#誰來過濾封包-1" class="table-of-contents__link toc-highlight">誰來過濾封包</a></li><li><a href="#總結" class="table-of-contents__link toc-highlight">總結</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0b7f5591.js"></script>
<script src="/assets/js/main.77e0ace0.js"></script>
</body>
</html>