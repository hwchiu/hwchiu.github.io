<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2019/iThome_Challenge/cni-ipam" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">初探 CNI 的 IP 分配問題 (IPAM) | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.hwchiu.com/docs/2019/iThome_Challenge/cni-ipam"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="初探 CNI 的 IP 分配問題 (IPAM) | hwchiu learning note"><meta data-rh="true" name="description" content="IP Address Management 作為 CNI 本身可提供的一個重要功能之一，更是 kubernetes 本身不可或缺的能力，透過 IPAM 的管理可以讓每個 Pod 都獲得一個 IPv4 或是 IPv6 的地址，至於 Pod 本身能不能上網，那就是 CNI 本身要處理的問題，根據不同需求來建議不同的網路環境提供 Pod 上網能力。本篇文章主要是探討 IPAM 的部分，針對三個由官方維護作為參考用的 IPAM，分別介紹他們的用途以及使用方式，來深入了解 IPAM 設計需要思考的部分以及相關議題"><meta data-rh="true" property="og:description" content="IP Address Management 作為 CNI 本身可提供的一個重要功能之一，更是 kubernetes 本身不可或缺的能力，透過 IPAM 的管理可以讓每個 Pod 都獲得一個 IPv4 或是 IPv6 的地址，至於 Pod 本身能不能上網，那就是 CNI 本身要處理的問題，根據不同需求來建議不同的網路環境提供 Pod 上網能力。本篇文章主要是探討 IPAM 的部分，針對三個由官方維護作為參考用的 IPAM，分別介紹他們的用途以及使用方式，來深入了解 IPAM 設計需要思考的部分以及相關議題"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.hwchiu.com/docs/2019/iThome_Challenge/cni-ipam"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2019/iThome_Challenge/cni-ipam" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.hwchiu.com/docs/2019/iThome_Challenge/cni-ipam" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://L4HXL74VLW-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="hwchiu learning note" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5bc72551.css">
<link rel="preload" href="/assets/js/runtime~main.36c89e7e.js" as="script">
<link rel="preload" href="/assets/js/main.580de630.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/aks-cni-i">Azure Kubernetes Service (AKS) - CNI (I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/aws-profile">Management AWS Profiles</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/b4-after">[閱讀筆記] B4 and After: Managing Hierarchy, partitioning, and Asymmetry for Availability and Scale in Google&#x27;s Software-Defined WAN</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/circleci">CircleCI 使用經驗談</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-design">iThome_Challenge</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-design">淺談 Kubernetes 設計原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/container-design-i">淺談 Container 實現原理, 以 Docker 為例(I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/summary">完賽感想</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/container-design-ii">淺談 Container 實現原理, 以 Docker 為例(II)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/container-design-iii">淺談 Container 實現原理, 以 Docker 為例(III)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-cri-i">Kubernetes &amp; CRI (I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-cri-ii">Kubernetes &amp; CRI (II) - containerd</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-cri-o">Container Runtime - CRI-O</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/container-runtime-security-container">Container Runtime - Security Container</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/container-runtime-vm">Container Runtime - Virtual Machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni">Container Network Interface 介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-cni">kubernetes 與 CNI 的互動</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-golnag">使用 golang 開發第一個 CNI 程式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2019/iThome_Challenge/cni-ipam">初探 CNI 的 IP 分配問題 (IPAM)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-flannel-i">CNI - Flannel - 安裝設定篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-flannel-ii">CNI - Flannel - IP 管理篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-flannel-iii">CNI - Flannel - VXLAN 封包運作篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-experience">CNI 閒談</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/csi">Container Storage Interface 基本介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/csi-ii">Container Storage Interface 標準介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/csi-iii">Container Storage Interface 與 kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/csi-nfs">Container Storage Interface(CSI) - NFS 初體驗</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/csi-other">CSI 雜談</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-device-plugin"> Device Plugin - Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-device-plugin-implement">Device Plugin - Implementation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-device-plugin-rdma">Kubernetes - Device Plugin - RDMA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-device-plugin-sriov">Kubernetes - Device Plugin - SRIOV</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-operator-pattern">Kubernetes - Operator Pattern 介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-service-catalog">Service Catalog</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-security">Kubernetes Container Security 探討</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/ingress-1">Introduction to Kubernetes Ingress (Nginx)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iptables-masquerade">Linux NAT Masquerade 研究(上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/k8s-concept">你到底知不知道什麼是 Kubernetes?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/keel">[DevOps] 基於 Kubernetes 的自動部屬流程 - Keel</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2019"><span itemprop="name">2019</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">iThome_Challenge</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">初探 CNI 的 IP 分配問題 (IPAM)</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>前言</h1><p>上篇文章中我們使用 golang 作為開發語言嘗試撰寫第一個簡單的 CNI 解決方案，並且在這個解決方案內我們完成 Linux Bridge 的建置，並且透過 <strong>veth</strong> 的方式連接 <strong>host</strong> 與 <strong>network namespace</strong> 串連起來。</p><p>此外上篇文章中也有檢討設計的問題，最重要的就是 <strong>IP</strong> 位址的分配，上篇的範例採用靜態分配的方式，沒有辦法擴展使用，單純只能作為測試實驗。
而本篇文章則會針對三個由 <a href="https://github.com/containernetworking/plugins/tree/master/plugins/ipam" target="_blank" rel="noopener noreferrer">CNI 官方 GitHub</a> 維護的 IP Address Management (IPAM) 解決方案。</p><p>探討到 IPAM 之前，我們先來複習一下 CNI 的基本設定格式 <strong>Network Configuration</strong>，其中有個<a href="https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration" target="_blank" rel="noopener noreferrer">欄位</a> 就叫做 <strong>ipam</strong>.</p><p>其說明非常簡單:</p><blockquote><p>ipam (dictionary, optional): Dictionary with IPAM specific values:
type (string): Refers to the filename of the IPAM plugin executable.</p></blockquote><p>這邊再次重申一個概念，不論是建立網路功能，分配 IP，各式各樣的輔助功能，這些應用程式只要有符合 <strong>CNI</strong> 標準，都可以稱之為 <strong>CNI Plugin</strong>。</p><p>所謂的 <strong>IPAM</strong> 也都有符合 <strong>CNI</strong> 的標準，但是其主要的功能就是幫你找到一個可用的 IP，非常簡單，但是這邊也要注意。這邊唯一的標準只有 <strong>CNI</strong> 的格式， <strong>IPAM</strong> 本身沒有標準，所以你要怎麼實作都沒有規範，能夠滿足需求就好。</p><p>我認為官方為了讓整個 CNI 的設定檔案看起來有結構且規範，特別在 <strong>Network Configuration</strong> 中加入了一個 <strong>IPAM</strong> 的欄位，讓這個 <strong>CNI Plugin</strong> 知道當前的設定有特別指定的 <strong>IPAM</strong> 方式，你就依照這個資料將相關的設定傳入 <strong>IPAM</strong> 參數指定的執行檔，期盼該執行檔會回你一個可以用的 IP， 最後你再將該 IP 設定到你自己創建的網路介面上。</p><p>所以下列設定檔案其運作邏輯是</p><ol><li>先呼叫 <strong>bridge</strong> 這個執行檔去處理</li><li><strong>bridge</strong> 內部建立一切資訊後，會準備好相關資訊，再次呼叫 <strong>host-local</strong> 這隻相容 <strong>CNI</strong> 標準的執行檔(但是目的是為了 IP)</li><li><strong>host-local</strong>被呼叫後根據設定回傳資訊，該資訊包含了一個可用的 IP 地址</li><li><strong>bridge</strong> 取得該可用的 <strong>IP</strong> 地址後，設定到創立的網路介面。</li></ol><div class="language-json= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;mynet&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;type&quot;: &quot;bridge&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;bridge&quot;: &quot;mynet0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;isDefaultGateway&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;forceAddress&quot;: false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ipMasq&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;hairpinMode&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ipam&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;host-local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;subnet&quot;: &quot;10.10.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述的流程看似合理但是我認為確有一個致命的問題就是，上面的流程都只是 <strong>Bridge</strong> 自己說的，並不在 <strong>CNI</strong> 的標準規範內。
今天我們也可以寫一個 <strong>CNI</strong> 完全忽略 <strong>IPAM</strong> 這個欄位，自己用別的方式取得 IP 來設定，也是可以。
甚至我寫一個欄位，然後我也呼叫 <strong>IPAM</strong>， 但是我期盼 <strong>IPAM</strong> 不要只是回傳 <strong>IP</strong> 給我，請幫我一起設定。 這種邏輯也可以</p><p>因此 <strong>CNI</strong> 這邊由於網路架構太多元化，沒有辦法訂下一個完美的標準，最後就變成溝通介面標準化，剩下就是各自努力想辦法讓一切運作，同時每個 CNI 都要描述自己支援的設定有哪些。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dhcp">DHCP<a href="#dhcp" class="hash-link" aria-label="Direct link to DHCP" title="Direct link to DHCP">​</a></h2><p>首先介紹的第一個 IPAM 就是 <strong>DHCP</strong>，這個 <strong>DHCP IPAM</strong> 我自己只有拿來做一些 POC 測試的時候玩過，其使用限制不少，並不太容易直接整合到大部分的使用情境中。</p><p>一個 DHCP 的服務流程需要有兩個元件分別是</p><ol><li>dhcp client</li><li>dhcp server</li></ol><p>而這個 DHCP IPAM 扮演的角色就是 <strong>DHCP Client</strong>，而 <strong>dhcp client</strong> 按照慣例的運作模式就是</p><ol><li>發送 DHCP Request</li><li>等待 DHCP Reply</li><li>設定 IP 到目標網路介面</li><li>定期 Renew</li></ol><p>而 <strong>DHCP IPAM</strong> 實實在在的扮演上面四個角色，而這邊就有一個問題了，這個 <strong>IPAM</strong> 會幫你設定 <strong>IP</strong>，因為 <strong>DHCP</strong> 會需要定期 <strong>renew</strong>，同時有更換 IP 的話就會自動幫你替換掉，這個是正常的行為。</p><p>由這邊可以知道不同的 <strong>IPAM</strong> 的運作行為不同，所以使用前一定要確認其使用方法與情境。</p><p>另外一個問題就是 <strong>DHCP</strong> 的封包，在預設的情況下是 <strong>Layer2</strong> 的封包，沒有任何的 <strong>dhcp relay</strong> 的幫忙的話，你的 <strong>DHCP Request</strong> 很難送到外面的 <strong>dhcp server</strong> 來取得一個 IP，所以這個 <strong>DHCP IPAM</strong> 的官方文件有特別說明</p><blockquote><p>With dhcp plugin the containers can get an IP allocated by a DHCP server already running on your network. This can be especially useful with plugin types such as macvlan.</p></blockquote><p>一種使用情境是直接透過 <strong>macvlan</strong> 的方式把 <strong>host</strong> 上的網路介面與 <strong>network namespace</strong> 共用，這樣從 <strong>network namespace</strong> 出去的封包就會直接從該網路介面出去。</p><p>接下來來探討一下整個 <strong>DHCP IPAM</strong> 的運作模式，該專案本身提供個兩種運作模式，一種是單純的 <strong>CNI</strong> 模式，一種則是一個不停運行的 <strong>daemon</strong> 模式。</p><p><strong>daemon</strong> 模式的功用很簡單，接受所有來自 <strong>CNI</strong> 模式的請求，然後切換到目標的 <strong>network namespace</strong> 裡面去根據目標的網路介面發送一個 <strong>DHCP</strong> 請求封包。</p><p>所以運行這個 <strong>DHCP IPAM</strong>  之前，要先在系統上跑一隻 <strong>daemon</strong>，然後會透過 <strong>unix socket</strong> 的方式等待 <strong>DHCP IPAM CNI</strong> 發送命令過來，當然該命令會包含</p><ol><li>目標的 network namespace</li><li>目標的 網路卡名稱</li></ol><p>整個運作流程可以歸納為下圖
<img loading="lazy" src="https://i.imgur.com/2sSTHuq.png" class="img_ev3q"></p><ol><li>首先當該 <strong>DHCP CNI</strong>被呼叫後，會先透過 <strong>unix socket</strong>  的方式通知 <strong>daemon</strong></li><li><strong>daemon</strong> 接者潛入到該 netns 之中，確認該 Interface 存在後，就開始發送 <strong>DHCP</strong> 請求</li><li>這邊我用一個 <strong>magic</strong> 的意思代表沒有限定外表要怎麼實作，總之你的 <strong>DHCP</strong> 封包要有辦法出去就好</li><li>最後外面的(甚至同一台機器)上面的 <strong>DHCP Server</strong> 可以看到 <strong>Request</strong> 並且回覆 <strong>Reply</strong></li><li>最後當 <strong>DHCP Daemon</strong> 發送 <strong>DHCP</strong>  請求的那隻 thread 接收到 <strong>DHCP</strong> 回覆後，就會幫目標網卡設定 <strong>IP</strong> 地址。</li></ol><p>最後，這個 <strong>IPAM</strong> 沒有這麼好用，光是那個 <strong>magic</strong> 的部分就不是一般使用者習慣的用法，我認為可以當作研究並增廣見聞即可。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="static">Static<a href="#static" class="hash-link" aria-label="Direct link to Static" title="Direct link to Static">​</a></h2><p>這個 <strong>IPAM</strong> 其實沒有什麼好說，就是一個測試用的 IPAM，根據其 <a href="https://github.com/containernetworking/plugins/tree/master/plugins/ipam/static" target="_blank" rel="noopener noreferrer">GitHub</a> 上面的介紹</p><blockquote><p>Overview
static IPAM is very simple IPAM plugin that assigns IPv4 and IPv6 addresses statically to container. This will be useful in debugging purpose and in case of assign same IP address in different vlan/vxlan to containers.</p></blockquote><p>就是一個除錯使用的 IPAM，我覺得唯一可以看的就是格式內容，完全可以補足我們前篇文章所設計的用法，將其擴大到更完整。</p><p>首先裡面分成三大塊，分別是</p><ol><li>IP 地址，包含了 ipv4/ipv6</li><li>Route 路由表</li><li>DNS 設定</li></ol><p>如果你對於上述三個概念都熟悉的話，其實下面的設定檔案不太需要講，大概看過就知道代表什麼意思。</p><p>另外要注意一下的是這個 <strong>IPAM</strong> 的運作模式就比較上述講述的，只專心在分 <strong>IP</strong> 地址，本身沒有任何設定的功能。 所以呼叫者最後要根據回傳的資訊自己去決定要怎麼設定。</p><div class="language-json= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;test&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ipam&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;static&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;addresses&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;address&quot;: &quot;10.10.0.1/24&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;gateway&quot;: &quot;10.10.0.254&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;address&quot;: &quot;3ffe:ffff:0:01ff::1/64&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;gateway&quot;: &quot;3ffe:ffff:0::1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;routes&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { &quot;dst&quot;: &quot;0.0.0.0/0&quot; },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { &quot;dst&quot;: &quot;192.168.0.0/16&quot;, &quot;gw&quot;: &quot;10.10.5.1&quot; },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { &quot;dst&quot;: &quot;3ffe:ffff:0:01ff::1/64&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;dns&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;nameservers&quot; : [&quot;8.8.8.8&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;domain&quot;: &quot;example.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;search&quot;: [ &quot;example.com&quot; ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h3><p><strong>kubeadm</strong> 本身沒有內建這個 <strong>CNI</strong> 執行檔，需要的要自行去官方下載或是自行編譯安裝。
假設有這個檔案後，我們可以直接使用之前執行 <strong>CNI</strong> 的方式來執行該檔案，先把上述的設定存成一個名為 <strong>static</strong> 的檔案。
最後可以觀察其輸出結果，這些結果理論上是呼叫他的 <strong>CNI</strong> 去解讀，然後根據需求去設定 <strong>IP, Route, DNS</strong> 這些資源。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo CNI_COMMAND=ADD CNI_CONTAINERID=ns1 CNI_NETNS=/var/run/netns/ns1 CNI_IFNAME=eth10 CNI_PATH=/opt/cni/bin/ /opt/cni/bin/static &lt; static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;cniVersion&quot;: &quot;0.2.0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ip4&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;ip&quot;: &quot;10.10.0.1/24&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;gateway&quot;: &quot;10.10.0.254&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;routes&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;dst&quot;: &quot;0.0.0.0/0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;dst&quot;: &quot;192.168.0.0/16&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;gw&quot;: &quot;10.10.5.1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ip6&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;ip&quot;: &quot;3ffe:ffff:0:1ff::1/64&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;gateway&quot;: &quot;3ffe:ffff::1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;routes&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;dst&quot;: &quot;3ffe:ffff:0:1ff::1/64&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;dns&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;nameservers&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;8.8.8.8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;domain&quot;: &quot;example.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;search&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;example.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="host-local">Host-Local<a href="#host-local" class="hash-link" aria-label="Direct link to Host-Local" title="Direct link to Host-Local">​</a></h2><p>最後終於要講最重要的 <strong>IPAM</strong> 了，其使用率也是頗高的，滿多的 <strong>CNI</strong> 會使用這個 <strong>IPAM</strong> 作為基底去處理 <strong>IP</strong> 分配的問題，因此這邊來好好的研究一下這個 <strong>IPAM</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-1">Example<a href="#example-1" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h3><p>開始研究其特色之前，我們直接先直接運行一個簡單的範例</p><ol><li>準備一個 config 給 host-local</li><li>呼叫 <strong>host-local cni</strong>，觀察其結果</li><li>呼叫 <strong>host-local cni</strong>，觀察其結果</li><li>呼叫 <strong>host-local cni</strong>，觀察其結果</li></ol><p>上面是認真的要呼叫三次，來觀察呼叫三次會有什麼不一樣的結果</p><p>首先我們先觀察一下其設定檔案，裡面相對於 <strong>static</strong> 來說，裡面最大的不一樣是出現了 <strong>range</strong>, <strong>subnet</strong> 之類的字眼</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;ipam&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;host-local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ranges&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        &quot;subnet&quot;: &quot;10.10.0.0/16&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        &quot;rangeStart&quot;: &quot;10.10.1.20&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        &quot;rangeEnd&quot;: &quot;10.10.3.50&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        &quot;gateway&quot;: &quot;10.10.0.254&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        &quot;subnet&quot;: &quot;172.16.5.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接者我們就運行該 <strong>host-local CNI</strong> 三次，看看三次的結果如何</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo CNI_COMMAND=ADD CNI_CONTAINERID=ns1 CNI_NETNS=/var/run/netns/ns1 CNI_IFNAME=eth10 CNI_PATH=/opt/cni/bin/ /opt/cni/bin/host-local &lt; config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;cniVersion&quot;: &quot;0.2.0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ip4&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;ip&quot;: &quot;10.10.1.20/16&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;gateway&quot;: &quot;10.10.0.254&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;dns&quot;: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo CNI_COMMAND=ADD CNI_CONTAINERID=ns1 CNI_NETNS=/var/run/netns/ns1 CNI_IFNAME=eth10 CNI_PATH=/opt/cni/bin/ /opt/cni/bin/host-local &lt;config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;cniVersion&quot;: &quot;0.2.0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ip4&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;ip&quot;: &quot;10.10.1.21/16&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;gateway&quot;: &quot;10.10.0.254&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;dns&quot;: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo CNI_COMMAND=ADD CNI_CONTAINERID=ns1 CNI_NETNS=/var/run/netns/ns1 CNI_IFNAME=eth10 CNI_PATH=/opt/cni/bin/ /opt/cni/bin/host-local &lt;config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;cniVersion&quot;: &quot;0.2.0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ip4&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;ip&quot;: &quot;10.10.1.22/16&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;gateway&quot;: &quot;10.10.0.254&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;dns&quot;: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>輸出的結果非常的有趣，每次的輸出內容幾乎都一樣，除了 <strong>ip4.ip</strong> 這個欄位之外有些許差別，分別是
<strong>10.10.1.20/16, 10.10.1.21/16, 10.10.1.22/16</strong></p><p>同時我們在複習一下剛剛設定裡面的 <strong>range.subnet</strong> 相關設定</p><div class="language-json= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;subnet&quot;: &quot;10.10.0.0/16&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;rangeStart&quot;: &quot;10.10.1.20&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;rangeEnd&quot;: &quot;10.10.3.50&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;gateway&quot;: &quot;10.10.0.254&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>看到這邊應該心裡已經有個譜了， <strong>host-local</strong> 會根據參數給予的 <strong>IP</strong> 範圍，依序回傳一個沒有被使用過的 <strong>IP</strong>， 這個運作原理非常的符合我們真正的需求，每次有 <strong>POD</strong> 產生的時候都可以得到一個沒有被使用過的 <strong>IP</strong> 地址，避免重複同時又能夠使用。</p><p>接下來我們來正式的研究這個 <strong>IPAM CNI</strong>，看看其設計上還有什麼樣的特色與注意事項</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h3><p>如慣例一樣，我們先看看官方 <a href="https://github.com/containernetworking/plugins/tree/master/plugins/ipam/host-local" target="_blank" rel="noopener noreferrer">GitHub</a> 怎麼描述這個專案</p><blockquote><p>host-local IPAM plugin allocates ip addresses out of a set of address ranges. It stores the state locally on the host filesystem, therefore ensuring uniqueness of IP addresses on a single host.
The allocator can allocate multiple ranges, and supports sets of multiple (disjoint) subnets. The allocation strategy is loosely round-robin within each range set.</p></blockquote><p>擷取幾個重點</p><ol><li>從 address ranges 中分配 IP</li><li>將分配的結果存在本地機器，所以這也是為什麼叫做 <strong>host-local</strong></li></ol><p>其中(2)算是一個手段，用來滿足(1)，畢竟如果沒有地方進行紀錄來進行比較，就沒有辦法每次都回傳一個沒有被用過的 <strong>IP</strong> 地址。</p><p>接下來看一個比較完整的設定檔案</p><div class="language-json= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ipam&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;host-local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;ranges&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;subnet&quot;: &quot;10.10.0.0/16&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;rangeStart&quot;: &quot;10.10.1.20&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;rangeEnd&quot;: &quot;10.10.3.50&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;gateway&quot;: &quot;10.10.0.254&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;subnet&quot;: &quot;172.16.5.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;subnet&quot;: &quot;3ffe:ffff:0:01ff::/64&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;rangeStart&quot;: &quot;3ffe:ffff:0:01ff::0010&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;rangeEnd&quot;: &quot;3ffe:ffff:0:01ff::0020&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;routes&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { &quot;dst&quot;: &quot;0.0.0.0/0&quot; },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { &quot;dst&quot;: &quot;192.168.0.0/16&quot;, &quot;gw&quot;: &quot;10.10.5.1&quot; },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { &quot;dst&quot;: &quot;3ffe:ffff:0:01ff::1/64&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;dataDir&quot;: &quot;/run/my-orchestrator/container-ipam-state&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這裡面我認為相對有趣的事情有</p><ol><li>支援 ipv6, 其支援 ipv6 的速度遠早於 kubernetes 1.16，這意味之前其實就可以透過 host-local 的方式去分配 ipv6 address， 只是 kubernetes 內部的所有功能都還是基於 ipv4，變成使用上沒有整合很不方便</li><li><strong>dataDir</strong> 的變數會指定要用哪個資料夾作為 <strong>host-local</strong> 記錄用過的資訊，預設值是 <strong>/var/lib/cni/networks/</strong>.</li></ol><p>根據上述簡單的範例，因為我沒有特別指定 <strong>dataDir</strong>，所以所有的檔案都會存放在 <strong>/var/lib/cni/networks/</strong> 裡面</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo find /var/lib/cni/networks/ -type f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/cni/networks/last_reserved_ip.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/cni/networks/10.10.1.20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/cni/networks/10.10.1.22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/cni/networks/10.10.1.21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo find /var/lib/cni/networks/ -type f | xargs -I % sh -c &#x27;echo -n &quot;%:   -&gt;&quot;; cat %; echo &quot;&quot;;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/cni/networks/last_reserved_ip.0:   -&gt;10.10.1.22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/cni/networks/10.10.1.20:   -&gt;ns1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/cni/networks/10.10.1.22:   -&gt;ns1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/cni/networks/10.10.1.21:   -&gt;ns1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我們可以觀察到，每個被用過的 <strong>IP</strong> 都會產生一個以該 <strong>IP</strong> 為名的檔案，該檔案中的內容非常簡單，就是使用的 <strong>container ID</strong>，由於我目前的範例非常簡單，所以資訊不夠豐富，等之後我們探討 kubernetes 的使用情境後，就可以再次觀察這個欄位。</p><p>此外，還可以觀察到一個名為 <strong>last_reserved_ip</strong> 的檔案，該檔案用來記住每個 <strong>range</strong> 目前分配的最後一個 <strong>IP</strong> 是哪個。
目前 <strong>host-local</strong> 分配的演算法是 <strong>round-robin</strong>，對演算法有興趣的可以參考下方的<a href="https://github.com/containernetworking/plugins/blob/ded2f1757770e8e2aa41f65687f8fc876f83048b/plugins/ipam/host-local/backend/allocator/allocator.go#L150" target="_blank" rel="noopener noreferrer">原始碼</a></p><div class="language-golang= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// GetIter encapsulates the strategy for this allocator.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// We use a round-robin strategy, attempting to evenly use the whole set.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// More specifically, a crash-looping container will not see the same IP until</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// the entire range has been run through.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// We may wish to consider avoiding recently-released IPs in the future.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (a *IPAllocator) GetIter() (*RangeIter, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最後我們再來思考一個問題，今天我們可以使用 <strong>range.subnet</strong> 這類的設定檔案讓 <strong>host-local</strong>來幫我們分配 <strong>IP</strong> 地址，避免重複的問題。
但是前述有提過， <strong>CNI</strong> 本身是每個節點都要配置的，所以如果今天每個節點都使用一樣的設定檔，會發生什麼事情?
基於 <strong>round-robin</strong> 的演算法下，就會發生不同節點上的 <strong>Pod</strong> 使用到相同的 <strong>IP</strong> 地址，這樣問題還是沒有解決。
為了解決這個問題，唯一的辦法就是每台節點上面都要部署不同內容的設定檔案，譬如第一個節點使用 <strong>10.0.1.0/24</strong>，第二個使用 <strong>10.0.2.0/24</strong>，諸如此類的方式。
這樣的使用雖然可以解決問題，但是對於安裝與部署來說又產生其他的困擾，如果今天有舊的節點要移除，新的節點要進來，也要確保設定檔案沒有重複，不然 <strong>IP</strong> 問題就會繼續浮上來。</p><p>只能說這種分散式的東西本身在處理與使用上就要格外小心，沒有集中控制的管理就容易導致群龍無首然後各自為王。</p><p>當然要解決這個問題也是有其他的辦法，下一篇會來探討 <strong>ｆlannel</strong> 的基本安裝過程，並且探討一下 <strong>flannel</strong> 是如何解決對所有節點上的 <strong>Pod</strong> 都能夠分配一個不重複的 <strong>IP</strong> 地址。</p><h1>Summary</h1><p>本篇文章介紹三種不同官方提供的 <strong>IPAM</strong> 解決方案，這些解決方案也都基於 <strong>CNI</strong> 的標準去設計，所以相容彼此的參數傳遞以及結果回傳。這使得這些 <strong>IPAM</strong> 能夠與其他的 <strong>CNI</strong> 更好整合，藉由分層的概念讓 <strong>IPAM</strong> 專心處理 <strong>IP</strong> 管理分配的問題，而其他的 <strong>CNI</strong> 則是專注於如何建立網路資源，確保目標 <strong>network namespace</strong> 可以獲得想要的上網能力。</p><p>到這一邊我們已經對 <strong>CNI</strong> 有一些基本概念了，接下來我們要實際演練一台具有三個節點的 kubernetes cluster 與 <strong>Flannel CNI</strong> 是如何運作的，包含了安裝過程，設定檔案內容，到最後封包的轉發是如何做到跨節點存取的。</p><h1>參考</h1><ul><li><a href="https://github.com/containernetworking/plugins" target="_blank" rel="noopener noreferrer">https://github.com/containernetworking/plugins</a></li><li><a href="https://github.com/containernetworking/cni" target="_blank" rel="noopener noreferrer">https://github.com/containernetworking/cni</a></li><li><a href="https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration" target="_blank" rel="noopener noreferrer">https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/cni">CNI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/ipam">IPAM</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/i-thome">iThome</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2019/iThome_Challenge/cni-golnag"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">使用 golang 開發第一個 CNI 程式</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2019/iThome_Challenge/cni-flannel-i"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CNI - Flannel - 安裝設定篇</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#dhcp" class="table-of-contents__link toc-highlight">DHCP</a></li><li><a href="#static" class="table-of-contents__link toc-highlight">Static</a><ul><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li></ul></li><li><a href="#host-local" class="table-of-contents__link toc-highlight">Host-Local</a><ul><li><a href="#example-1" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.36c89e7e.js"></script>
<script src="/assets/js/main.580de630.js"></script>
</body>
</html>