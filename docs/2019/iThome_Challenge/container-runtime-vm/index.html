<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2019/iThome_Challenge/container-runtime-vm" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Container Runtime - Virtual Machine | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hwchiu.com/docs/2019/iThome_Challenge/container-runtime-vm"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Container Runtime - Virtual Machine | hwchiu learning note"><meta data-rh="true" name="description" content="本文作為 CRI 系列文章的最後一篇文章，要來跟大家分享一個比較少見的用法，透過 kubernetes 管理 Pod 的方式來管理 Virtual Machine，底層所有運行的服務都是基於 Virtual Machine 去跑，但是對於 Kubernetes 來說完全不知情，依然認為是一個 Pod 的形式。 這部分依賴重新撰寫一個符合 CRI 標準應用程式來對接 kubelet, 並且底下所有的運作都使用 virtual machine  來操作，因此這個範例就完全不會有 OCI 的存在，因為是真正的 virtual machine, 而非 container."><meta data-rh="true" property="og:description" content="本文作為 CRI 系列文章的最後一篇文章，要來跟大家分享一個比較少見的用法，透過 kubernetes 管理 Pod 的方式來管理 Virtual Machine，底層所有運行的服務都是基於 Virtual Machine 去跑，但是對於 Kubernetes 來說完全不知情，依然認為是一個 Pod 的形式。 這部分依賴重新撰寫一個符合 CRI 標準應用程式來對接 kubelet, 並且底下所有的運作都使用 virtual machine  來操作，因此這個範例就完全不會有 OCI 的存在，因為是真正的 virtual machine, 而非 container."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hwchiu.com/docs/2019/iThome_Challenge/container-runtime-vm"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/2019/iThome_Challenge/container-runtime-vm" hreflang="en"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/2019/iThome_Challenge/container-runtime-vm" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.a4f4719e.css">
<link rel="preload" href="/assets/js/runtime~main.c9ca7c58.js" as="script">
<link rel="preload" href="/assets/js/main.c5e93c40.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/aks-cni-i">Azure Kubernetes Service (AKS) - CNI (I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/aws-profile">Management AWS Profiles</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/b4-after">[閱讀筆記] B4 and After: Managing Hierarchy, partitioning, and Asymmetry for Availability and Scale in Google&#x27;s Software-Defined WAN</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/circleci">CircleCI 使用經驗談</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-design">iThome_Challenge</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-design">淺談 Kubernetes 設計原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/container-design-i">淺談 Container 實現原理, 以 Docker 為例(I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/summary">完賽感想</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/container-design-ii">淺談 Container 實現原理, 以 Docker 為例(II)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/container-design-iii">淺談 Container 實現原理, 以 Docker 為例(III)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-cri-i">Kubernetes &amp; CRI (I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-cri-ii">Kubernetes &amp; CRI (II) - containerd</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-cri-o">Container Runtime - CRI-O</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/container-runtime-security-container">Container Runtime - Security Container</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2019/iThome_Challenge/container-runtime-vm">Container Runtime - Virtual Machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni">Container Network Interface 介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-cni">kubernetes 與 CNI 的互動</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-golnag">使用 golang 開發第一個 CNI 程式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-ipam">初探 CNI 的 IP 分配問題 (IPAM)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-flannel-i">CNI - Flannel - 安裝設定篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-flannel-ii">CNI - Flannel - IP 管理篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-flannel-iii">CNI - Flannel - VXLAN 封包運作篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/cni-experience">CNI 閒談</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/csi">Container Storage Interface 基本介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/csi-ii">Container Storage Interface 標準介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/csi-iii">Container Storage Interface 與 kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/csi-nfs">Container Storage Interface(CSI) - NFS 初體驗</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/csi-other">CSI 雜談</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-device-plugin"> Device Plugin - Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-device-plugin-implement">Device Plugin - Implementation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-device-plugin-rdma">Kubernetes - Device Plugin - RDMA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-device-plugin-sriov">Kubernetes - Device Plugin - SRIOV</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-operator-pattern">Kubernetes - Operator Pattern 介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-service-catalog">Service Catalog</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iThome_Challenge/k8s-security">Kubernetes Container Security 探討</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/ingress-1">Introduction to Kubernetes Ingress (Nginx)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/iptables-masquerade">Linux NAT Masquerade 研究(上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/k8s-concept">你到底知不知道什麼是 Kubernetes?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2019/keel">[DevOps] 基於 Kubernetes 的自動部屬流程 - Keel</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2019"><span itemprop="name">2019</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">iThome_Challenge</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Container Runtime - Virtual Machine</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>前言</h1><p>本篇文章作為 <code>Container Runtime Interface</code> 系列文的最後一篇，這次的主題也是延續前兩篇，繼續探討各種不同的 <code>CRI</code> 解決方案。
藉由瞭解這些不同目的需求的解決方案，可以幫助我們去探索對於 <code>kubernetes</code> 的各種應用，畢竟有需求才會有開發，有人遇到了痛點是當前的 <code>kubernetes</code> 沒有辦法解決的，所以才會開始著手開發符合自己需求的方式。
如同最一開始闡述過，透過 <code>Container Runtime Inteface</code> 的架構，可以讓開發者更自由且彈性的去開發與發布這些功能，而不用跟 <code>kubernetes</code> 本身綁定導致開發週期過長。</p><p>前兩篇我們探討了兩種 <code>CRI </code>使用情境</p><ol><li>切換不同的 <code>CRI</code> 解決方案，譬如 <code>containerd</code> 與 <code>cri-o</code>, 但是底層都是基於 <code>runc</code> 這個 <code>OCI Runtime</code> 來產生 <code>Container</code>.</li><li>為了安全性而誕生的 <code>OCI Runtime</code>, 譬如 <code>gVisor</code> 與 <code>kata container</code> 等。 透過 <code>OCI</code> 的標準架構，開發者與使用者都可以於 <code>containerd</code> 或是 <code>cri-o</code> 中將 <code>runc</code> 切換成這些更加安全的 <code>container</code>。</li></ol><p>而今天要探討的則是第三種情形，是真正的 <code>Virtual Machine</code>，目的非常簡單，就是透過 <code>kubernetes</code> 去管理 <code>Virtual Machine</code>，統一透過 <code>Pod/Deployment</code> 等習慣的方式同事去管理 <code>Container</code> 與 <code>Virtual Machine</code>.</p><p>不同於 <code>Kata Container</code> 這種基於 <code>Virtual Machine</code> 的 <code>Container</code> 解決方案，本文探討的就是實實在在的 <code>Virtual Machine</code>，一點 <code>Container</code> 的概念都不存在的環境，使用者在建立該資源的時候甚至不是提供 <code>Container Image</code>，而是提供 <code>VM Image</code> 來創立服務。</p><h1>緣由</h1><p>如同前篇文中所述， <code>Container</code> 與 <code>Virtual Machine</code> 彼此的比較從來沒有中斷過，然而隨者微服務概念的普及與發展，愈來愈多的使用情境都在嘗試使用容器來管理，在這種前提下，為什麼會有這種純 <code>Virtual Machine</code> 的需求被提出?</p><p>如果今天的使用情境都是基於自己公司內部開發，那我覺得通常不會有這個問題，因為不同組別之間可以互相協調，規劃出一個對於開發，維運與測試都接受的模式與架構。</p><p>但是有些情況是運行的服務並非自行開發，而是第三方廠商的解決方案，並且將該解決方案給整合到 <code>Virtual Machine</code> 之中。
畢竟 <code>Virtual Machine</code> 發展的時間更久，有很多已經開發許久的軟體都是基於 <code>Virtual Machine</code> 的環境進行設計與使用，同時在販售與合作方面也都是基於 <code>VM Image</code> 的方式在發布，因此這會造成服務提供商的服務部分來自 <code>Container</code>，部分來自 <code>Virtual Machine</code>，那 <code>kubernetes</code> 能不能解決這個問題 ?</p><p>事實上就我目前接觸到的所有案例裡面，幾乎全部都跟 <code>Network Function Virtualization(NFV)</code> 有關。隨者 <code>NFV</code> 與 <code>OpenStaack</code> 的發展，很多的廠商開始將自己的服務從軟硬體綁在一起到當純只賣軟體，使用 <code>VM</code> 方式釋出該 <code>VM Image</code> 供他人使用。</p><p>對於一般的研究人員或是開發者來說，這個問題更加嚴重，因為支援不足與地位差距，你今天根本沒有辦法要求原開發商將軟體從 <code>VM</code> 轉移到 <code>Container</code>，這種情況下你會覺得很難處理，因為根本沒有辦法運行。</p><p>所以就漸漸有不同的方式被提出來解決這個問題，譬如 <code>OpenStack</code> 堆疊在 <code>Kubernetes </code>上，或是 <code>Kubernetes</code> 堆疊在 <code>OPenStack</code> 上，然後重新開發其他的管理工具同時掌管 <code>Kubernetes</code> 以及 <code>OpenStack</code>。</p><p>這樣的架構也許可行，但是卻將複雜度提升到一個難以理解的地方，對於開發者，使用者，維運者都帶來難以除錯與管理的問題，所以問題就退回到，能不能用 <code>kubernetes</code> 直接管理 <code>Virtual Machine</code>?</p><p>曾經覺得困難的問題，現在如果瞭解了 <code>CRI</code> 的架構與運作模式，對這個問題似乎就不會覺得太困難了，可以直接打造一個滿足 <code>CRI</code> 介面的程式，背後全部都用 <code>Virtual Machine</code> 去實現。</p><blockquote><p>這個情況下可以完全不需要去管 OCI 標準了，因為我們的目標是純 Virtual Machine，不太需要管 Container。</p></blockquote><p>除了上述的難以容器化的原因外，還有一些原因是打造這種專案的契機</p><ol><li>混合作業系統環境的運行環境，對於一個全部都採用 <code>Linux</code> 環境架設的 <code>Kubernetes</code>  叢集，要如何在其中運行一些基於 <code>Windows</code> 環境的服務?</li><li>安全性考量，就算有了前幾天關於 <code>gVisror</code> 與 <code>Kata Container</code> 相關的解決方案，也未必能夠說服所有人目前這兩個專案的開發以經處於 <code>Production Ready</code>，所以如果可以繼續研究已經運行長期的 <code>Virtual Machine</code> 環境是再好不過。</li></ol><p>這方面我目前知道比較有名的專案為 <code>kubevirt</code> 以及 <code>virtlet</code>，那接下來會針對 <code>virtlet</code> 為主去介紹探討一下這種架構的設計，以及怎麼使用</p><h1>Virtlet</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>就跟前述的慣例一下，先看一下 <a href="https://github.com/Mirantis/virtlet" target="_blank" rel="noopener noreferrer">官方 GitHub</a> 是如何描述自己這個專案的</p><blockquote><p>Virtlet is a Kubernetes runtime server which allows you to run VM workloads, based on QCOW2 images.</p></blockquote><p>這邊值得注意的是其用的詞是 <code>Kubernetes runtime server</code>, 這邊所指的就是 <code>Container Runtime Interface</code>，該專案本身額外實現了一個全新的應用程式，該應用程式本身支援 <code>CRI</code> 的 <code>gRPC</code> 介面，但是底下實現這些功能時全部都使用基於 <code>QCOW2 Images</code> 格式的 <code>Virtual Machine</code>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="design">Design<a href="#design" class="hash-link" aria-label="Direct link to Design" title="Direct link to Design">​</a></h2><p><code>virtlet</code> 開發的初衷並不是要用 <code>VM</code> 取代所有的 <code>Container</code>, 而是希望能夠提供另外一種選擇。為了達成這個目的，則 <code>CRI</code> 的部分勢必要重新撰寫，不能使用原生的 <code>containerd</code> 或是 <code>cri-o</code>。</p><p>同時這個全新設計的 <code>CRI</code>處理程式也要能夠根據情況決定使用 <code>Virtual Machine</code> 或是 <code>Container</code> 來創建對應的運算資源。
於是乎，<code> CRI Proxy</code> 這個專案就因應這個需求而生</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cri-proxy">CRI Proxy<a href="#cri-proxy" class="hash-link" aria-label="Direct link to CRI Proxy" title="Direct link to CRI Proxy">​</a></h3><p><code>CRI Proxy Server</code> 的功能分成簡單，就是根據條件轉發 <code>CRI</code> 請求到不同的後端，針對 <code>container</code> 的部分，目前支援 <code>dockershim</code> 或是 <code>containerd</code> ，而針對 <code>Virtual Machine</code> 的部分則是 <code>virtlet</code> server 。</p><p><img loading="lazy" src="https://i.imgur.com/ixMsRIl.png" class="img_ev3q">
本圖節錄自<a href="https://github.com/Mirantis/criproxy" target="_blank" rel="noopener noreferrer">GitHub CRIProxy</a></p><p><code>CRI Proxy</code> 要用什麼條件來判斷到底該怎麼處理這個請求，這部分就使用上了 <code>kubernetes</code> 本身針對其資源內部提供的標記欄位，也就是所謂的 <code>annotation</code></p><p>對於每個創建的 <code>Pod</code>，只要於 <code>metadata.annotations.kubernetes.io/target-runtime</code> 設定為 <code>virtlet.cloud</code>, 則 <code>CRI Proxy</code> 就會認得這個 <code>Pod</code> 要走 <code>VM</code> 去處理，而非傳統的 <code>Container</code>。</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: cirros-vm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/target-runtime: virtlet.cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>透過這種標記的方式與架構，可以讓使用者方便的去根據需求來決定要使用 <code>VM</code> 還是 <code>Container</code>。</p><p>此外 <code>CRI Proxy</code> 會被 <code>kubelet</code> 呼叫，所以本身也是每個節點上都要存在，因此一開始會先用 <code>systemd</code> 的方式在每台節點上都運行安裝，這樣基本的 <code>kubelet</code> 才可以啟動。 接者所有沒有設定的 <code>Pod</code> 就會走 <code>kubelet</code> -&gt; <code>CRI Proxy</code> -&gt; <code>dockershim/containerd</code> 的方式以 <code>Container</code> 被創建出來。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a href="#architecture" class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture">​</a></h3><p>除了上述的 <code>CRI Proxy</code> 之外，我們接下來看一下其完整的運作架構。</p><p><img loading="lazy" src="https://i.imgur.com/Kbf0zaf.png" class="img_ev3q">
本圖節錄自 <a href="https://github.com/Mirantis/virtlet/blob/master/docs/docs/dev/architecture.md" target="_blank" rel="noopener noreferrer">Architecture</a></p><p>當 <code>CRI Proxy</code> 收到創建 <code>VM</code> 的請求後，就會將該 <code>CRI</code> 的請求轉發到後端處理，這個處理的角色就是 <code>Virtlet Container</code>，也是俗稱的 <code>virtlet Manager</code>。</p><p>當整個 <code>kubernetes</code> 系統起來後，會透過 <code>daemonset</code> 的方式去部署 <code>virtlet Manager</code></p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo kubectl -n kube-system get daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME         DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-proxy   3         3         3       3            3           &lt;none&gt;          8h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">virtlet      1         1         1       1            1           &lt;none&gt;          8h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo kubectl get pods --all-namespaces -l runtime=virtlet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME            READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   virtlet-gghd4   3/3     Running   0          8h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然而該 DaemonSet 本身其實也有設定節點的選擇條件，並非所有的節點都會部署，畢竟該節點要有能力產生 <code>VM</code>，目前使用的規則是該節點必須要含有個標籤 <code>extraRuntime: virtlet</code> 即可，值得注意的是其使用的條件是 <code>In</code>, 所以只要含有 <code>virtlet</code> 這個字的節點都會被部署 <code>virtlet Manager</code>。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          nodeAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              nodeSelectorTerms:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - key: extraRuntime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    - virtlet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>當 <code>virtlet Manager</code> 收到指令後，會透過 <code>libvirt</code> API 的方式進行後續的處理，叫起 <code>vmwrapper</code> 來產生對應的 <code>VM</code> 環境</p><blockquote><p>vmrapper is run by libvirt and wraps the emulator (QEMU/KVM). It requests tap file descriptor from Virtlet, adds command line arguments needed by the emulator to use the tap device and then execs the emulator.</p></blockquote><p>其完整架構非常複雜，其中自行設計了不少元件來處理資源的處理，譬如使用 <code>tapmanager</code> 來處理整個 <code>CNI</code>，這部分幾乎沒有文件，只能依賴閱讀原始碼的方式來理解其實作方法。</p><p><a href="https://github.com/Mirantis/virtlet/blob/master/docs/docs/dev/vm-pod-lifecycle.md" target="_blank" rel="noopener noreferrer">vm-pod-lifecycle</a> 這邊描述了關於 <code>Pod</code> 創造與刪除時整體處理流程，非常的長，有興趣的可以自行閱讀。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installation">Installation<a href="#installation" class="hash-link" aria-label="Direct link to Installation" title="Direct link to Installation">​</a></h2><p><a href="https://docs.virtlet.cloud/user-guide/virtlet-on-kdc/" target="_blank" rel="noopener noreferrer">官方文件</a> 中有提供兩種安裝方式，一種是使用 <code>kubernetes-dind-cluster</code> 去安裝整個測試環境，另外一種則是按部就班的描述要安裝的所有元件，只是單純測試跟研究的話，我認為選擇第一種會比較方便</p><p>我自己的電腦環境是<code>MAC Pro</code>，平常都會透過 <code>Vagrant + VirtualBox</code> 產生一個 Linux 環境來測試，這次就基於這個 <code>Linux</code> 的環境使用 kubernetes-dind-cluster 安裝 kubernetes 並且在裡面使用 virtlet 產生 VM。</p><p>架構如下，非常的有趣</p><ol><li>先疊一層 VM</li><li>裡面創三個 <code>Container</code>, 以這三個 <code>Container</code> 組成一個 <code>Kubernetes Cluster</code></li><li>Kubernetes 使用 <code>Virtlet</code> 作為其 <code>CRI</code> 解決方案，最後在裡面產生一個基於 <code>Virtual Machine</code> 的 <code>Pod</code><img loading="lazy" src="https://i.imgur.com/Gsh8hwW.png" class="img_ev3q"></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="steps">Steps<a href="#steps" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps">​</a></h3><ol><li>準備好 Ubuntu 環境，下載<a href="https://github.com/Mirantis/virtlet/blob/master/deploy/demo.sh" target="_blank" rel="noopener noreferrer">demo.sh</a></li><li>執行安裝，我自己是沒有遇到任何問題</li><li>最後會幫你創建好 VM 並且要你透過 ssh 登入到該 VM, 密碼是 <code>gocubsgo</code>.</li></ol><p><img loading="lazy" src="https://i.imgur.com/7e93E60.png" class="img_ev3q"></p><p>可以看到創建出來的 <code>pod</code>, 有特別標注一個 <code>annotations</code>，這樣 <code>CRIProxy</code> 就會根據需求使用 <code>containerd</code> 或是 <code>VM</code> 來創建服務
<img loading="lazy" src="https://i.imgur.com/WRQiVBg.png" class="img_ev3q"></p><p>這時候透過 <code>kubectl get pods -o wide</code> 取得該 <code>Pod</code> 運行的節點位置，並且透過 <code>docker exec -it $name bash</code> 到節點裡面進行觀察</p><p>透過觀察真的發現該節點內透過 <code>qemu</code> 創建了一個 <code>VM</code>
<img loading="lazy" src="https://i.imgur.com/gxHHxuN.jpg" class="img_ev3q"></p><p>除了上述最簡單的範例之外，<a href="https://github.com/Mirantis/virtlet/tree/master/examples" target="_blank" rel="noopener noreferrer">GitHub</a> 這邊還有提供其他不同的 <code>Yaml</code>, 其中我覺得非常有趣的就是 <a href="https://github.com/Mirantis/virtlet/blob/master/examples/k8s.yaml" target="_blank" rel="noopener noreferrer">k8s.yml</a></p><p>可以讓你在 <code>kubernetes</code> 裡面透過 <code>VM</code> 產生另外一個 <code>kubernetes</code> cluster， 我暫時想不到應用情境，但是就是一個很有趣的架構。
節錄一下裡面的內容，可以看到該 <code>VM</code> 起來後會透過 <code>kubeadm</code> 的方式去初始化一個 cluster.</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - path: /usr/local/bin/provision.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            permissions: &quot;0755&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            owner: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            content: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              #!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              set -u -e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              set -o pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              apt-get update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              apt-get install -y docker.io kubelet kubeadm kubectl kubernetes-cni</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sed -i &#x27;s/--cluster-dns=10\.96\.0\.10/--cluster-dns=10.97.0.10/&#x27; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              if [[ $(hostname) =~ -0$ ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # master node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                kubeadm init --token adcb82.4eae29627dc4c5a6 --pod-network-cidr=10.200.0.0/16 --service-cidr=10.97.0.0/16 --apiserver-cert-extra-sans=127.0.0.1,localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                export KUBECONFIG=/etc/kubernetes/admin.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                export kubever=$(kubectl version | base64 | tr -d &#x27;\n&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$kubever&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                while ! kubectl get pods -n kube-system -l k8s-app=kube-dns|grep &#x27; 1/1&#x27;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  sleep 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mkdir -p /root/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                chmod 700 /root/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cp &quot;${KUBECONFIG}&quot; /root/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                echo &quot;Master setup complete.&quot; &gt;&amp;2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # worker node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                kubeadm join --token adcb82.4eae29627dc4c5a6 --discovery-token-unsafe-skip-ca-verification k8s-0.k8s:6443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                echo &quot;Node setup complete.&quot; &gt;&amp;2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Summary</h1><p><code>Container Runtime Interface(CRI)</code> 的文章到這邊告了一個段落，我個人對於 <code>CRI</code> 這種介面的設計是滿喜歡的，透過介面將實作與主體抽離，能夠讓社群開發者自己開發想要的功能，同時又能夠簡單且順利的與 <code>kubernetes</code> 整合。</p><p>也正是因為如此才可以看到各式各樣針對不同議題而努力的專案，每個專案都有自己的特色與優劣，所以對於一個管理者來說，如果能夠理解這些不同的解決方案的優劣之處，不論是基於 <code>CRI</code> 標準的方案，或是更底下相容於 <code>OCI Runtime</code> 的實作，對於未來遇到任何不同的使用情境與問題時，腦中就可以很快的反射出是不是有相關的議題與資源可以去研究，而不會只用一套 <code>docker</code> 打天下。</p><p>接下來將針對網路的部分，從 <code>Container Network Interface(CNI)</code> 為出發點介紹其概念與架構，也包含了 <code>ipam</code> 的介紹，讓大家知道到底 <code>IP</code> 是怎麼被分配與指派的，接者也會探討常見的 <code>flannel</code> 其實作概念與運作流程。</p><h1>參考</h1><ul><li><a href="https://github.com/Mirantis/criproxy" target="_blank" rel="noopener noreferrer">https://github.com/Mirantis/criproxy</a></li><li><a href="https://github.com/Mirantis/virtlet" target="_blank" rel="noopener noreferrer">https://github.com/Mirantis/virtlet</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/cri">CRI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/vm">VM</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/i-thome">iThome</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2019/iThome_Challenge/container-runtime-security-container"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Container Runtime - Security Container</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2019/iThome_Challenge/cni"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Container Network Interface 介紹</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#design" class="table-of-contents__link toc-highlight">Design</a><ul><li><a href="#cri-proxy" class="table-of-contents__link toc-highlight">CRI Proxy</a></li><li><a href="#architecture" class="table-of-contents__link toc-highlight">Architecture</a></li></ul></li><li><a href="#installation" class="table-of-contents__link toc-highlight">Installation</a><ul><li><a href="#steps" class="table-of-contents__link toc-highlight">Steps</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c9ca7c58.js"></script>
<script src="/assets/js/main.c5e93c40.js"></script>
</body>
</html>