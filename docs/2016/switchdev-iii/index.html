<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-2016/switchdev-iii" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">[Switchdev] How Kernel Implement SwitchDev(ii) | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hwchiu.com/docs/2016/switchdev-iii"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[Switchdev] How Kernel Implement SwitchDev(ii) | hwchiu learning note"><meta data-rh="true" name="description" content="探討 Kernel 如何實作 SwitchDev (II)"><meta data-rh="true" property="og:description" content="探討 Kernel 如何實作 SwitchDev (II)"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hwchiu.com/docs/2016/switchdev-iii"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/2016/switchdev-iii" hreflang="en"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/2016/switchdev-iii" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL7X3W07"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XCGL7X3W07",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.a4f4719e.css">
<link rel="preload" href="/assets/js/runtime~main.187b671b.js" as="script">
<link rel="preload" href="/assets/js/main.ae23b154.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2016/build_mozilla_nss_on_windows">Build Mozilla NSS on windows</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2016/mtcp-reading-note">mTCP 讀後筆記</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2016/netfilter-nfqueue">NFQUEUE drop UDP packets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2016/switchdev-i">[Switchdev] Introduuction To Switchdev</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2016/switchdev-ii">[Switchdev] How Kernel Implement SwitchDev(i)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2016/switchdev-iii">[Switchdev] How Kernel Implement SwitchDev(ii)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2016"><span itemprop="name">2016</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">[Switchdev] How Kernel Implement SwitchDev(ii)</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>[Switchdev] How Kernel Implement SwitchDev(ii)</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>本篇文章主要會專注於 switchdev 本身的實作上，包含了其結構以及提供的 API 等。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="structure">Structure<a href="#structure" class="hash-link" aria-label="Direct link to Structure" title="Direct link to Structure">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transaction">Transaction<a href="#transaction" class="hash-link" aria-label="Direct link to Transaction" title="Direct link to Transaction">​</a></h3><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_trans_item {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct list_head list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        void *data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        void (*destructor)(const void *data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_trans {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct list_head item_list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bool ph_prepare;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static inline bool switchdev_trans_ph_prepare(struct switchdev_trans *trans)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return trans &amp;&amp; trans-&gt;ph_prepare;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static inline bool switchdev_trans_ph_commit(struct switchdev_trans *trans)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return trans &amp;&amp; !trans-&gt;ph_prepare;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Switchdev <a href="https://patchwork.ozlabs.org/patch/519719/" target="_blank" rel="noopener noreferrer">實作</a>了一種 trans 的機制，對於 hardware switch 進行一些寫入的動作，如 set/add 時，該動作會被拆成兩部份，分別是 prepare/commit 兩部分。</li><li>一開始會先將 <strong>ph_prepare</strong> 給設定為 <code>true</code>，然後寫入的資料傳給 driver，讓 driver 知道這次的寫入只是用來確認可行性而已，如果 driver 確定可以寫入後，會將 <strong>ph_prepare</strong> 變為 <code>false</code> 後，再次要求 driver 將真正的資料給寫入。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="attribute">Attribute<a href="#attribute" class="hash-link" aria-label="Direct link to Attribute" title="Direct link to Attribute">​</a></h3><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enum switchdev_attr_id {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_ATTR_ID_UNDEFINED,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_ATTR_ID_PORT_PARENT_ID,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_ATTR_ID_PORT_STP_STATE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_ATTR_ID_PORT_BRIDGE_FLAGS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_ATTR_ID_BRIDGE_AGEING_TIME,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_ATTR_ID_BRIDGE_VLAN_FILTERING,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  此 enum 用來定義 switch attribute 的種類，當 switch driver 收到一些如 get 的指令時，會根據該 attribute的種類回傳特定資料</p><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_attr {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct net_device *orig_dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enum switchdev_attr_id id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 flags;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        union {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                struct netdev_phys_item_id ppid;        /* PORT_PARENT_ID */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                u8 stp_state;                           /* PORT_STP_STATE */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                unsigned long brport_flags;             /* PORT_BRIDGE_FLAGS */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                u32 ageing_time;                        /* BRIDGE_AGEING_TIME */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                bool vlan_filtering;                    /* BRIDGE_VLAN_FILTERING */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } u;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>實際上用來紀錄 switch attribute 的結構</p><ul><li><strong>net_device</strong> 來記錄是哪個目標 device</li><li>id 如前述所說的種類</li><li>flags 目前有三種值</li></ul><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#define SWITCHDEV_F_NO_RECURSE          BIT(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SWITCHDEV_F_SKIP_EOPNOTSUPP     BIT(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SWITCHDEV_F_DEFER               BIT(2)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>u 則是用來存放該 id 所代表的值</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="object">Object<a href="#object" class="hash-link" aria-label="Direct link to Object" title="Direct link to Object">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enum switchdev_obj_id {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_OBJ_ID_UNDEFINED,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_OBJ_ID_PORT_VLAN,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_OBJ_ID_IPV4_FIB,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_OBJ_ID_PORT_FDB,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_OBJ_ID_PORT_MDB,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  此 enum 用來記錄該 switch object 的種類，</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_obj {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct net_device *orig_dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enum switchdev_obj_id id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 flags;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  此結構記錄 type， net_device 以及 flag，對應種類的數值因為太過於廣泛，所以此 structure 會再被其他的結構給包起來。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_obj_port_vlan {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct switchdev_obj obj;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 flags;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 vid_begin;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 vid_end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_obj_ipv4_fib {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct switchdev_obj obj;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 dst;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int dst_len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct fib_info fi;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 tos;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 type;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 nlflags;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 tb_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_obj_port_fdb {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct switchdev_obj obj;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unsigned char addr[ETH_ALEN];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 vid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 ndm_state;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_obj_port_mdb {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct switchdev_obj obj;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unsigned char addr[ETH_ALEN];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 vid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由上面可以觀察到，目前已經實作了四種的 switchdev obj，分別是 vlan 的設定， L2 的 FDB/MDB 以及 L3 的 FIB.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="operation">Operation<a href="#operation" class="hash-link" aria-label="Direct link to Operation" title="Direct link to Operation">​</a></h3><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * struct switchdev_ops - switchdev operations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @switchdev_port_attr_get: Get a port attribute (see switchdev_attr).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @switchdev_port_attr_set: Set a port attribute (see switchdev_attr).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @switchdev_port_obj_add: Add an object to port (see switchdev_obj_*).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @switchdev_port_obj_del: Delete an object from port (see switchdev_obj_*).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @switchdev_port_obj_dump: Dump port objects (see switchdev_obj_*).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_ops {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int     (*switchdev_port_attr_get)(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           struct switchdev_attr *attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int     (*switchdev_port_attr_set)(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           const struct switchdev_attr *attr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           struct switchdev_trans *trans);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int     (*switchdev_port_obj_add)(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          const struct switchdev_obj *obj,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          struct switchdev_trans *trans);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int     (*switchdev_port_obj_del)(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          const struct switchdev_obj *obj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int     (*switchdev_port_obj_dump)(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           struct switchdev_obj *obj,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           switchdev_obj_dump_cb_t *cb);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此結構被加入到 <strong>struct net_device</strong>內，所以 hardware switch driver 在創建 net_divce 時，要順便對該結構進行初始化，這樣對應的 function pointer 才有辦法在適當的時機被執行，這部分可以參考 rocker driver。</p><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dev-&gt;switchdev_ops = &amp;rocker_port_switchdev_ops;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="notifier">Notifier<a href="#notifier" class="hash-link" aria-label="Direct link to Notifier" title="Direct link to Notifier">​</a></h3><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enum switchdev_notifier_type {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_FDB_ADD = 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SWITCHDEV_FDB_DEL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_notifier_info {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct net_device *dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct switchdev_notifier_fdb_info {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct switchdev_notifier_info info; /* must be first */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const unsigned char *addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 vid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Notifier 是用來讓 hardware switch 通知 linux kernel 用的，目前只有實作 FDB 的部分。
當 hardware switch 的 FDB offload 有變化時(ADD/DEL)，要透過這個方式一路通知道 linux kernel 去，這樣的話使用 <code>brctl show</code> 指令去看的時候，就可以看到即時的狀態變化。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">Implementation<a href="#implementation" class="hash-link" aria-label="Direct link to Implementation" title="Direct link to Implementation">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="switchdev-port-attribute">SwitchDev Port Attribute<a href="#switchdev-port-attribute" class="hash-link" aria-label="Direct link to SwitchDev Port Attribute" title="Direct link to SwitchDev Port Attribute">​</a></h3><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_attr_get(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            struct switchdev_attr *attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_attr_set(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            const struct switchdev_attr *attr);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這兩個 function 是用來處理 attribute 的，其處理邏輯類似，基本上都按照下列走法</p><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">const struct switchdev_ops *ops = dev-&gt;switchdev_ops;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ops &amp;&amp; ops-&gt;switchdev_port_attr_get)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ops-&gt;switchdev_port_attr_get(dev, attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (attr-&gt;flags &amp; SWITCHDEV_F_NO_RECURSE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return err;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">netdev_for_each_lower_dev(dev, lower_dev, iter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* do something */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>先判斷該 device 是否有實作 switchdev_ops,若有的話則直接呼叫 fptr 來處理.<ul><li>參考 rocker driver.</li></ul></li></ol><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static const struct switchdev_ops rocker_port_switchdev_ops = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .switchdev_port_attr_get        = rocker_port_attr_get,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .switchdev_port_attr_set        = rocker_port_attr_set,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dev-&gt;switchdev_ops = &amp;rocker_port_switchdev_ops;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>判斷該 device 是否有被設定不需要遞迴往下尋找，若有的話則直接結束</li><li>因為 switch port 可能是屬於 bond/team/vlan 等 device 底下，所以若直接操作上層的 device 是沒有辦法碰到 switch port 的，這邊會使用 <a href="https://lists.ubuntu.com/archives/kernel-team/2014-June/043300.html" target="_blank" rel="noopener noreferrer">netdev_for_each_lower_dev</a> 來嘗試抓取到底下所有的 device。<ul><li>對於 get/set 來說，會針對底下每個 device 嘗試去 get/set 其 attribute.</li></ul></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="switchdev-port-object-operation">SwitchDev Port Object operation<a href="#switchdev-port-object-operation" class="hash-link" aria-label="Direct link to SwitchDev Port Object operation" title="Direct link to SwitchDev Port Object operation">​</a></h3><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_obj_add(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           const struct switchdev_obj *obj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_obj_del(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           const struct switchdev_obj *obj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_obj_dump(struct net_device *dev, struct switchdev_obj *obj,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            switchdev_obj_dump_cb_t *cb);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這三個 function 都是用來處理 object 的，其運作邏輯也類似</p><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">const struct switchdev_ops *ops = dev-&gt;switchdev_ops;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ops &amp;&amp; ops-&gt;switchdev_port_obj_add)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return ops-&gt;switchdev_port_obj_add(dev, obj, trans);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">netdev_for_each_lower_dev(dev, lower_dev, iter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* do something */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>先檢查該 device 是否有實作 switchdev_ops,若有就呼叫對應的 function 來處理</li><li>遞迴存取底下所有的 device (bond/team/vlan), 針對每個 device 都跑一次對應的結果。</li><li>obj_dump 的部分還會傳入一個 <strong>call back</strong> function, 目前看到的只有兩個實作，分別是 <strong>switchdev_port_obj_dump</strong> 以及 <strong>switchdev_port_vlan_dump_cb</strong>。 兩者都要搭配另外一個 `switchdev_port_xxx_dump** 的結構來使用，目前感覺用途不是很 general.<ul><li>fdb 的 dump 與 <strong>rfnetlink</strong> 有關係，要搭配 <strong>ndo_fdb_dump</strong> 使用。user space tool 透過 netlink 來問 fdb 的資料時，會透過此 cb 將對應的內容填入到 netlink header 中，最後再一路送回 user space 去檢查。</li></ul></li></ol><ul><li>vlan 的部分則是 <strong>rfnetlink</strong> 在使用的，會先呼叫到 <strong>ndo_bridge_getlink</strong>, 最後跑到 <strong>ndo_dflt_bridge_getlink</strong> 才會使用，ndo (network device operation) 的 netlink 操作有必要再多花一些時間去瞭解了。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="port-bridge">Port Bridge<a href="#port-bridge" class="hash-link" aria-label="Direct link to Port Bridge" title="Direct link to Port Bridge">​</a></h3><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_bridge_getlink(struct sk_buff *skb, u32 pid, u32 seq,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  struct net_device *dev, u32 filter_mask,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  int nlflags);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_bridge_setlink(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  struct nlmsghdr *nlh, u16 flags);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_bridge_dellink(struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  struct nlmsghdr *nlh, u16 flags);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這三個 function 是用來操作 bridge port attribute 的，基本上都是被設定成 <strong>ndo_bridge_xxx</strong> 的 handler。
目前可以參考的範例應該是使用 <strong>br</strong> 這個與 <strong>ip</strong> 類似的 user-space tool.
詳細說明可以參考此 <a href="http://comments.gmane.org/gmane.linux.network/232104" target="_blank" rel="noopener noreferrer">link</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fdb-operations">FDB Operations<a href="#fdb-operations" class="hash-link" aria-label="Direct link to FDB Operations" title="Direct link to FDB Operations">​</a></h3><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_fdb_add(struct ndmsg *ndm, struct nlattr *tb[],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           struct net_device *dev, const unsigned char *addr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           u16 vid, u16 nlm_flags);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_fdb_del(struct ndmsg *ndm, struct nlattr *tb[],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           struct net_device *dev, const unsigned char *addr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           u16 vid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_port_fdb_dump(struct sk_buff *skb, struct netlink_callback *cb,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            struct net_device *filter_dev, int idx);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這三個 function 是用來操作 fdb 的，當上層走 <strong>rtnetlink</strong> 中的 <strong>ndo_fdb_xxx</strong> type 時，就會觸發對應的 function handler，這些 function 最後都會呼叫到對應的 <strong>switchdev_port_obj_xxx</strong>。</p><p>關於整個 FDB 的操作，可以用下列這張圖來總結
<img loading="lazy" src="https://lh3.googleusercontent.com/-sk760sgtc28/VwO9Wle0NKI/AAAAAAAAFOo/QrHADU1hDps5c5SmGBwU-nd54ZSJ7UjpQCCo/s720-Ic42/FDB.png" class="img_ev3q"></p><ul><li>藍線代表的是 Notifer，當 Rocket 在 FDB 有任何變更時，會一路通知到 Linux Kernel 去，以確保 FDB 資料一致。</li><li>圖中紅線代表的是走 ndo 系列的 netlink event，會直接跟 Rocker 溝通，因此透過 <code>br</code> 此指令去修改 FDB entry時，會先走紅線到 Rocker 去，接者走藍線去通知 Kernel 同步 FDB。</li><li>當透過<code>brctl</code>指令去操作時，這邊目前能做的只有部分 attribute/obj 的修改，如 STP 的狀態，此時則會一路從 switchdev 的核心傳到 Rocker 去處理。</li><li>基本上 MDB 的操作則簡單很多，與 FIB 比較類似。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fib-operations">FIB Operations<a href="#fib-operations" class="hash-link" aria-label="Direct link to FIB Operations" title="Direct link to FIB Operations">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_fib_ipv4_add(u32 dst, int dst_len, struct fib_info *fi,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           u8 tos, u8 type, u32 nlflags, u32 tb_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int switchdev_fib_ipv4_del(u32 dst, int dst_len, struct fib_info *fi,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           u8 tos, u8 type, u32 tb_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void switchdev_fib_ipv4_abort(struct fib_info *fi);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>這三個 function 是用來操作 IPv4 FIB offload 的，不同於 FDB，此 offload rule 本身的學習只能靠 linux kernl 來管理，當 kernel 決定要針對特定 FIB route 處理時，會呼叫上述的 add/del 將相關的 FIB router 給加入到 hardware switch 中。</li></ul><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">err = switchdev_fib_ipv4_add(key, plen, fi,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      new_fa-&gt;fa_tos,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cfg-&gt;fc_type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cfg-&gt;fc_nlflags,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tb-&gt;tb_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (err) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      switchdev_fib_ipv4_abort(fi);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kmem_cache_free(fn_alias_kmem, new_fa);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      goto out;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>當執行失敗的時候，會呼叫 abort 將 rules 給全部清空，並且將 IPv4 offload 給關閉<ul><li>這部分還有待加強，由註解也可以看出來</li></ul></li></ul><div class="language-c= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> /* There was a problem installing this route to the offload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * device.  For now, until we come up with more refined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * policy handling, abruptly end IPv4 fib offloading for</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * for entire net by flushing offload device(s) of all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * IPv4 routes, and mark IPv4 fib offloading broken from</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * this point forward.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>而目前在加入 rules 的部分，也有針對條件去篩選，並非所有的 FIB 都會被加入</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_IP_MULTIPLE_TABLES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (fi-&gt;fib_net-&gt;ipv4.fib_has_custom_rules)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (fi-&gt;fib_net-&gt;ipv4.fib_offload_disabled)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return 0;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>關於整個 FIB 的操作，可以用下列這張圖來總結
<img loading="lazy" src="https://lh3.googleusercontent.com/-6xvPI9pzSrQ/VwO-v0MUQ5I/AAAAAAAAFPA/4P4aYSo6pfMzzPLacKWG-lfICRtn087xQCCo/s720-Ic42/FIB.png" class="img_ev3q"></p><ul><li>相對於 FDB，非常的簡單，只有 kernel 主動去加入 Rocker 而已</li><li>目前 ndo_xxx_ooo 系列的操作中，還沒有看到 FIB 相關的，大部分都是 bridge/vlan/macvlan 等。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="notifier-1">Notifier<a href="#notifier-1" class="hash-link" aria-label="Direct link to Notifier" title="Direct link to Notifier">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int register_switchdev_notifier(struct notifier_block *nb);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int unregister_switchdev_notifier(struct notifier_block *nb);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int call_switchdev_notifiers(unsigned long val, struct net_device *dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             struct switchdev_notifier_info *info);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>基本上就是用讓 hardware switch driver 呼叫的，當 switchdevb 有任何更動需要讓上層知道時就會呼叫 <strong>call_switchdev_notifiers</strong>，此時所有透過 <strong>register_switchdev_notifier</strong> 註冊的 handler 都會去處理</li><li>目前有透過的 <strong>register_switchdev_notifier</strong> 註冊的只有 bridge(br.c), 目的是用來同步 FIB 資訊。</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/system">System</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">Linux</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kernel">Kernel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/switchdev">Switchdev</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> by <b>HungWei Chiu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2016/switchdev-ii"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">[Switchdev] How Kernel Implement SwitchDev(i)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/2015"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">2015</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#structure" class="table-of-contents__link toc-highlight">Structure</a><ul><li><a href="#transaction" class="table-of-contents__link toc-highlight">Transaction</a></li><li><a href="#attribute" class="table-of-contents__link toc-highlight">Attribute</a></li><li><a href="#object" class="table-of-contents__link toc-highlight">Object</a></li><li><a href="#operation" class="table-of-contents__link toc-highlight">Operation</a></li><li><a href="#notifier" class="table-of-contents__link toc-highlight">Notifier</a></li></ul></li><li><a href="#implementation" class="table-of-contents__link toc-highlight">Implementation</a><ul><li><a href="#switchdev-port-attribute" class="table-of-contents__link toc-highlight">SwitchDev Port Attribute</a></li><li><a href="#switchdev-port-object-operation" class="table-of-contents__link toc-highlight">SwitchDev Port Object operation</a></li><li><a href="#port-bridge" class="table-of-contents__link toc-highlight">Port Bridge</a></li><li><a href="#fdb-operations" class="table-of-contents__link toc-highlight">FDB Operations</a></li><li><a href="#fib-operations" class="table-of-contents__link toc-highlight">FIB Operations</a></li><li><a href="#notifier-1" class="table-of-contents__link toc-highlight">Notifier</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.187b671b.js"></script>
<script src="/assets/js/main.ae23b154.js"></script>
</body>
</html>