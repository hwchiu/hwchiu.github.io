<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-techPost/2019/iThome_Challenge/csi-nfs" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Container Storage Interface(CSI) - NFS 初體驗 | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hwchiu.com/docs/techPost/2019/iThome_Challenge/csi-nfs"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Container Storage Interface(CSI) - NFS 初體驗 | hwchiu learning note"><meta data-rh="true" name="description" content="前述分享了關於不少 Container Storage Interface 的事情，接下來我們直接使用 NFS 作為範例，來看看要如何透過 CSI 的架構來掛載 NFS 到 kubernetes cluster 中供運算資源使用"><meta data-rh="true" property="og:description" content="前述分享了關於不少 Container Storage Interface 的事情，接下來我們直接使用 NFS 作為範例，來看看要如何透過 CSI 的架構來掛載 NFS 到 kubernetes cluster 中供運算資源使用"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hwchiu.com/docs/techPost/2019/iThome_Challenge/csi-nfs"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/techPost/2019/iThome_Challenge/csi-nfs" hreflang="en"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/techPost/2019/iThome_Challenge/csi-nfs" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed"><link rel="stylesheet" href="/assets/css/styles.a4f4719e.css">
<link rel="preload" href="/assets/js/runtime~main.d6ce37b6.js" as="script">
<link rel="preload" href="/assets/js/main.f9e3d066.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hwchiu/docusaurus-blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/aks-cni-i">Azure Kubernetes Service (AKS) - CNI (I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/aws-profile">Management AWS Profiles</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/b4-after">[閱讀筆記] B4 and After: Managing Hierarchy, partitioning, and Asymmetry for Availability and Scale in Google&#x27;s Software-Defined WAN</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/circleci">CircleCI 使用經驗談</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-design">iThome_Challenge</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-design">淺談 Kubernetes 設計原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/container-design-i">淺談 Container 實現原理, 以 Docker 為例(I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/summary">完賽感想</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/container-design-ii">淺談 Container 實現原理, 以 Docker 為例(II)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/container-design-iii">淺談 Container 實現原理, 以 Docker 為例(III)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-cri-i">Kubernetes &amp; CRI (I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-cri-ii">Kubernetes &amp; CRI (II) - containerd</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-cri-o">Container Runtime - CRI-O</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/container-runtime-security-container">Container Runtime - Security Container</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/container-runtime-vm">Container Runtime - Virtual Machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/cni">Container Network Interface 介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-cni">kubernetes 與 CNI 的互動</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/cni-golnag">使用 golang 開發第一個 CNI 程式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/cni-ipam">初探 CNI 的 IP 分配問題 (IPAM)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/cni-flannel-i">CNI - Flannel - 安裝設定篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/cni-flannel-ii">CNI - Flannel - IP 管理篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/cni-flannel-iii">CNI - Flannel - VXLAN 封包運作篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/cni-experience">CNI 閒談</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/csi">Container Storage Interface 基本介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/csi-ii">Container Storage Interface 標準介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/csi-iii">Container Storage Interface 與 kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/csi-nfs">Container Storage Interface(CSI) - NFS 初體驗</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/csi-other">CSI 雜談</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-device-plugin"> Device Plugin - Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-device-plugin-implement">Device Plugin - Implementation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-device-plugin-rdma">Kubernetes - Device Plugin - RDMA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-device-plugin-sriov">Kubernetes - Device Plugin - SRIOV</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-operator-pattern">Kubernetes - Operator Pattern 介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-service-catalog">Service Catalog</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iThome_Challenge/k8s-security">Kubernetes Container Security 探討</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/ingress-1">Introduction to Kubernetes Ingress (Nginx)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/iptables-masquerade">Linux NAT Masquerade 研究(上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/k8s-concept">你到底知不知道什麼是 Kubernetes?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2019/keel">[DevOps] 基於 Kubernetes 的自動部屬流程 - Keel</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2019"><span itemprop="name">2019</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">iThome_Challenge</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Container Storage Interface(CSI) - NFS 初體驗</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>前言</h1><p>本文會透過使用 <strong>CSI</strong> 的方式於 kubernetes 內使用 NFS 作為儲存解決方案，並且嘗試觀察各種與  CSI 有關的概念與架構，嘗試將實際部署的結果與前篇文章探討的架構與文件結合。</p><h1>NFS</h1><p>先前我有寫過一篇關於 <strong>NFS</strong> 各種用法的文章，有興趣的人可以前往閱讀 <a href="https://www.hwchiu.com/kubernetes-storage-ii.html" target="_blank" rel="noopener noreferrer">NFS 於 Kubernetes 內的各種應用
</a>
在該篇文章裡面我描述了兩種 <strong>NFS</strong> 的用法，第一種就是最基本的架設一個 <strong>NFS</strong> 服務器，接者將其分享出來的空間直接掛載到欲使用的 <strong>Pod</strong>，這種情況下就是 <strong>NFS</strong>服務器上面有什麼樣的資源與檔案，則 <strong>Pod</strong> 裡面看到的也就是相同的資源。這種用法也是最常見的使用方法。</p><p>而第二種方法則是希望採用 <strong>StorageClass</strong> 的方式來使用 <strong>NFS</strong> 伺服器，這種情況下就是 <strong>NFS</strong>服務器本身也是會分享一個空間，但是每次透過 <strong>StorageClass</strong> 以及 <strong>PVC</strong> 綁定的情況下，會在 <strong>NFS</strong> 分享的資料夾內在創建一個資料夾，專屬給該 <strong>PVC</strong> 去使用，使用起來的感覺就像是動態分割空間一樣，這部分過去是仰賴額外的 <strong>NFS Provisioner</strong> 來實現。</p><p>而本文要討論的架構屬於第一種，所以到時候掛載的 <strong>Pod</strong> 內部觀看到的資料就會與 <strong>NFS</strong> 本身分享的資料一致。</p><h1>環境建置</h1><p>本文環境基於</p><ol><li>kubernetes: 1.15.3</li><li>CSI: 1.0.0</li><li>NFS CSI Driver: <a href="https://github.com/hwchiu/csi-driver-nfs" target="_blank" rel="noopener noreferrer">https://github.com/hwchiu/csi-driver-nfs</a>
從官方 fork 過來，但是稍微調整了一下 nfs 掛載的位置以及相關的 image tag</li></ol><p>上述的環境已經整理成一個 <strong>Vagrant</strong> 的檔案</p><div class="language-ruby= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ruby= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># -*- mode: ruby -*-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># vi: set ft=ruby :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vagrant.configure(&quot;2&quot;) do |config|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.box = &quot;bento/ubuntu-18.04&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.hostname = &#x27;k8s-dev&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.define vm_name = &#x27;k8s&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.provision &quot;shell&quot;, privileged: false, inline: &lt;&lt;-SHELL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set -e -x -u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    export DEBIAN_FRONTEND=noninteractive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #change the source.list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get install -y vim git cmake build-essential tcpdump tig jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Install ntp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get install -y ntp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Install Docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # kubernetes official max validated version: 17.03.2~ce-0~ubuntu-xenial</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    export DOCKER_VERSION=&quot;18.06.3~ce~3-0~ubuntu&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get install -y docker-ce=${DOCKER_VERSION}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Install Kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    export KUBE_VERSION=&quot;1.15.3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    export NET_IF_NAME=&quot;enp0s8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot; | sudo tee --append /etc/apt/sources.list.d/kubernetes.list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get install -y kubeadm=${KUBE_VERSION}-00 kubelet=${KUBE_VERSION}-00 kubectl=${KUBE_VERSION}-00 kubernetes-cni=0.7.5-00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Disable swap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo swapoff -a &amp;&amp; sudo sysctl -w vm.swappiness=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo sed &#x27;/swap.img/d&#x27; -i /etc/fstab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo kubeadm init --kubernetes-version v${KUBE_VERSION} --apiserver-advertise-address=172.17.8.101 --pod-network-cidr=10.244.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p $HOME/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get install -qqy nfs-kernel-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo mkdir /nfsshare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo mkdir /nfsshare/mongodb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo mkdir /nfsshare/influxdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo mkdir /nfsshare/user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;/nfsshare *(rw,sync,no_root_squash)&quot; | sudo tee /etc/exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo exportfs -r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo showmount -e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git clone https://github.com/hwchiu/csi-driver-nfs.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl apply -f csi-driver-nfs/deploy/kubernetes/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl apply -f csi-driver-nfs/examples/kubernetes/nginx.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SHELL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.network :private_network, ip: &quot;172.17.8.101&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.provider :virtualbox do |v|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      v.customize [&quot;modifyvm&quot;, :id, &quot;--cpus&quot;, 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      v.customize [&quot;modifyvm&quot;, :id, &quot;--memory&quot;, 4096]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      v.customize [&#x27;modifyvm&#x27;, :id, &#x27;--nicpromisc1&#x27;, &#x27;allow-all&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>該檔案會自動架設一個基於 <strong>1.15.3</strong> 的 <strong>kubernetes cluster</strong>，同時也會自動安裝 <strong>NFS</strong> 伺服器，並且將其底下的 <strong>/nfsshare</strong> 資料夾分享出去。</p><p>此外也會自動部署 <strong>NFS CSI</strong> 解決方案的相關檔案，並且最後部署一個使用該 <strong>NFS</strong> 服務的 <strong>nginx</strong> 作為一個範例。</p><p>如果遇到下列錯誤，就進到機器後重新創建一次 <strong>nginx</strong> 相關的檔案即可</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">k8s: Error from server (Forbidden): error when creating &quot;csi-driver-nfs/examples/kubernetes/nginx.yaml&quot;: pods &quot;nginx&quot; is forbidden: error looking up service account default/default: serviceaccount &quot;default&quot; not found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">####</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f csi-driver-nfs/examples/kubernetes/nginx.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="安裝內容">安裝內容<a href="#安裝內容" class="hash-link" aria-label="Direct link to 安裝內容" title="Direct link to 安裝內容">​</a></h2><p>接下來我們來看一下剛剛安裝的過程到底裝了哪些資源到系統中，這邊我們就忽略其他資源，專注於跟儲存有關的資源上</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="controller">Controller<a href="#controller" class="hash-link" aria-label="Direct link to Controller" title="Direct link to Controller">​</a></h3><p>首先我們先看一下所謂的 <strong>CSI</strong> Controller  相關的設定檔案，如之前所述，這種情況通常會使用 <strong>StatefulSet</strong> 來設定，除非你的 <strong>Controller</strong> 本身有額外實現多實例的架構，可確保同時只有會一個副本正在運行。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kind: StatefulSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: csi-attacher-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceName: &quot;csi-attacher&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: csi-attacher-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceAccount: csi-attacher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: csi-attacher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: quay.io/k8scsi/csi-attacher:v1.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &quot;--v=5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &quot;--csi-address=$(ADDRESS)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: ADDRESS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              value: /csi/csi.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          imagePullPolicy: &quot;IfNotPresent&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: socket-dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /csi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: nfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: quay.io/k8scsi/nfsplugin:canary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          args :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &quot;--nodeid=$(NODE_ID)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &quot;--endpoint=$(CSI_ENDPOINT)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: NODE_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  fieldPath: spec.nodeName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: CSI_ENDPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              value: unix://plugin/csi.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          imagePullPolicy: &quot;IfNotPresent&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: socket-dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: socket-dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          emptyDir:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>該 <strong>Pod</strong> 中運行了兩個 <strong>Container</strong>，分別是</p><ol><li>quay.io/k8scsi/nfsplugin:canary</li><li>quay.io/k8scsi/csi-attacher:v1.0.1</li></ol><p>第一個則是關於基於 <strong>NFS</strong> 所實現相容於 <strong>CSI Controller</strong> 的解決方案，而第二個則是由官方推出便於發開者的 <strong>sidecar container</strong>，用來監聽相關的 kubernetes 事件並且透過 <strong>gRPC</strong> 的方式告知第一個容器。</p><p>這邊同時可以觀察到</p><ol><li>系統上透過 <strong>emptyDir</strong> 的方式創建了一個空間，並且讓兩個 <strong>container</strong> 都共同使用，而該檔案則是其實背後就是創建出來的 <strong>unix://plugin/csi.sock</strong>， 因此這兩個 <strong>container</strong> 就會透過這種方式來進行 IPC 的交談。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="node">Node<a href="#node" class="hash-link" aria-label="Direct link to Node" title="Direct link to Node">​</a></h3><p>接下來觀察一下另外一個部署，使用 <strong>DaemonSet</strong> 來部署，對應的就是之前提到的 <strong>CSI Node</strong> 服務，是必須每台需要使用儲存方案的節點都要部署的。</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kind: DaemonSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: csi-nodeplugin-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: csi-nodeplugin-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: csi-nodeplugin-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceAccount: csi-nodeplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hostNetwork: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: node-driver-registrar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: quay.io/k8scsi/csi-node-driver-registrar:v1.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          lifecycle:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preStop:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              exec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;rm -rf /registration/csi-nfsplugin /registration/csi-nfsplugin-reg.sock&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - --v=5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - --csi-address=/plugin/csi.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - --kubelet-registration-path=/var/lib/kubelet/plugins/csi-nfsplugin/csi.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: KUBE_NODE_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  fieldPath: spec.nodeName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: plugin-dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: registration-dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /registration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: nfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            privileged: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            capabilities:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              add: [&quot;SYS_ADMIN&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            allowPrivilegeEscalation: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: quay.io/k8scsi/nfsplugin:canary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          args :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &quot;--nodeid=$(NODE_ID)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &quot;--endpoint=$(CSI_ENDPOINT)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: NODE_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  fieldPath: spec.nodeName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: CSI_ENDPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              value: unix://plugin/csi.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          imagePullPolicy: &quot;IfNotPresent&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: plugin-dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: pods-mount-dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /var/lib/kubelet/pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPropagation: &quot;Bidirectional&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: plugin-dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          hostPath:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /var/lib/kubelet/plugins/csi-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type: DirectoryOrCreate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: pods-mount-dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          hostPath:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /var/lib/kubelet/pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type: Directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - hostPath:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /var/lib/kubelet/plugins_registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type: Directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: registration-dir</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>該 <strong>Pod</strong> 中也是部署了兩個 <strong>Container</strong>，分別是</p><ol><li>quay.io/k8scsi/csi-node-driver-registrar:v1.0.2</li><li>quay.io/k8scsi/nfsplugin:canary</li></ol><p>跟 <strong>Controller</strong> 的部署一樣，其中一個是自行解決方案的設計，另外一個則是官方提供的好用輔助容器。</p><p>首先看一下<strong>Volume</strong> 的部分，這邊有三個資料夾並且都是透過 <strong>hostpath</strong> 的方式來使用</p><ol><li>/var/lib/kubelet/plugins/csi-nfsplugin</li><li>/var/lib/kubelet/pods</li><li>/var/lib/kubelet/plugins_registry</li></ol><p>第一個 <strong>/var/lib/kubelet/plugins/csi-nfsplugin</strong> 根據觀察可以發現最後其實是用來指定相關的 <strong>unix socket</strong>。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo ls /var/lib/kubelet/plugins/csi-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">csi.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo file /var/lib/kubelet/plugins/csi-nfsplugin/csi.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/kubelet/plugins/csi-nfsplugin/csi.sock: socket</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二個 <strong>/var/lib/kubelet/pods</strong> 比較特別，這個資料夾是 <strong>kubelet</strong> 用來存放跟 <strong>pod</strong> 相關的資訊，其中該目錄底下都是基於 <strong>pod ID</strong> 來區隔的。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo ls /var/lib/kubelet/pods/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16010371-22a4-4152-af23-712def2a764d  7a5a5fa4-ea62-4106-8e2e-69f3a0abf48d  8bf65cf7-a02a-4829-9fab-784355fe5ba5  af50052304877bc1d4cd4d3409c6be5a      c3aedceb2d751faeb02f85ebcec869a6      db52b7d4-c828-49d8-b899-e52be600f0b5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">28f76958a7cfb29c8091821d6746ddea      7d5d3c0a6786e517a8973fa06754cb75      9f7d3f8c-63a8-46b9-8d69-d70656caf0b7  bd4f816d-01f0-4217-a66c-27bd4893c130  c9da1474-797c-4386-acb1-f7c74cc30dbd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo docker ps | grep nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2107ec8d04e1        maersk/nginx                               &quot;nginx&quot;                  10 hours ago        Up 10 hours                             k8s_nginx_nginx_default_8bf65cf7-a02a-4829-9fab-784355fe5ba5_0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dad41423889e        k8s.gcr.io/pause:3.1                       &quot;/pause&quot;                 10 hours ago        Up 10 hours                             k8s_POD_nginx_default_8bf65cf7-a02a-4829-9fab-784355fe5ba5_0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo ls /var/lib/kubelet/pods/8bf65cf7-a02a-4829-9fab-784355fe5ba5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containers  etc-hosts  plugins  volumes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到基於測試的 <strong>nginx pod</strong> 底下有個 volumes 的資料夾，接下來往下去看裡面有什麼資訊</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo tree /var/lib/kubelet/pods/8bf65cf7-a02a-4829-9fab-784355fe5ba5/volumes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/kubelet/pods/8bf65cf7-a02a-4829-9fab-784355fe5ba5/volumes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── kubernetes.io~csi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ └── data-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|     ├── mount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │ ├── influxdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │ ├── mongodb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │ ├── test1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │ └── user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     └── vol_data.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── kubernetes.io~secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── default-token-6bcvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── ca.crt -&gt; ..data/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── namespace -&gt; ..data/namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └── token -&gt; ..data/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo cat /var/lib/kubelet/pods/8bf65cf7-a02a-4829-9fab-784355fe5ba5/volumes//kubernetes.io~csi/data-nfsplugin/vol_data.json | jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;attachmentID&quot;: &quot;csi-f642ae48557f63a1f4377a265c43d6afe2e8d859837925fef2331b9e541e31a3&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;driverMode&quot;: &quot;persistent&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;driverName&quot;: &quot;csi-nfsplugin&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;nodeName&quot;: &quot;k8s-dev&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;specVolID&quot;: &quot;data-nfsplugin&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;volumeHandle&quot;: &quot;data-id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同時也可以看到上述的 <strong>mount</strong>  資料夾內有之前設定的 <strong>NFS</strong> 相關的分享資料夾內容，這部分引起我的好奇心，所以透過 <strong>mount</strong> 再次觀察。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ mount | grep nfsshare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:/nfsshare on /var/lib/kubelet/pods/8bf65cf7-a02a-4829-9fab-784355fe5ba5/volumes/kubernetes.io~csi/data-nfsplugin/mount type nfs4 (rw,relatime,vers=4.1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=127.0.0.1,local_lock=none,addr=127.0.0.1)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>大概可以瞭解整個運作原理了，先透過 <strong>CSI</strong> 的方式把目標的解決方案掛載到相關節點上，而掛載的地點必須是 <strong>/var/lib/kubelet/pods/${pod_id}/volumes/kubernetes.io~csi/${csi_name}</strong> 這個位置，當這邊處理完畢後。一旦 <strong>Pod</strong> 開始啟用後，就會透過 <strong>mount namespace</strong> 的方式再度的把這個空間給掛載到 <strong>Pod</strong> 裡面去使用。</p><p>最後的 <strong>/var/lib/kubelet/plugins_registry</strong> 看名稱就跟註冊有關，的確也是專門給 <strong>Register</strong> 這個額外的容器使用。
根據該<a href="https://github.com/kubernetes-csi/node-driver-registrar" target="_blank" rel="noopener noreferrer">專案說明</a></p><blockquote><p>Registration socket:
Registers the driver with kubelet.
Created by the node-driver-registrar.
Exposed on a Kubernetes node via hostpath in the Kubelet plugin registry. (typically /var/lib/kubelet/plugins_registry/$drivername.example.com-reg.sock). The hostpath volume must be mounted at /registration.</p></blockquote><p>所以可以看到這算是一個該容器的標準用法，如果要將該CSI解決方案註冊到 <strong>Node</strong> 上，就直接透過這個容器加上 <strong>Unix socket</strong> 與 <strong>kubelet</strong> 溝通，就算是完成註冊相關的功能了。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo ls /var/lib/kubelet/plugins_registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">csi-nfsplugin-reg.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo file /var/lib/kubelet/plugins_registry/csi-nfsplugin-reg.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/kubelet/plugins_registry/csi-nfsplugin-reg.sock: socket</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根據官方提供的參考部署架構圖
<img loading="lazy" src="https://i.imgur.com/sx31Z1w.png" class="img_ev3q">
該圖節錄自<a href="https://kubernetes.io/blog/2019/01/15/container-storage-interface-ga/" target="_blank" rel="noopener noreferrer">Recommended Mechanism for Deploying CSI Drivers on Kubernetes
</a></p><p>可以對應到上述所描述的部署方式以及相關的 <strong>volume</strong> 操作，同時對於整體的運作邏輯有更清晰的表達。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx">Nginx<a href="#nginx" class="hash-link" aria-label="Direct link to Nginx" title="Direct link to Nginx">​</a></h3><p>作為一個使用者 <strong>Pod</strong> 來說，這邊採用 <strong>PV/PVC</strong> 這種預先配置的方式來使用前述部署完畢的 <strong>CSI</strong> 環境，其中只有 <strong>PV</strong> 的部分使用方式跟過往不同，剩下的 <strong>PVC/Pod</strong> 都沒有任何變化。</p><p>可以看到 <strong>PV</strong> 之中必須要採用 <strong>csi</strong> 的架構，並且透過 <strong>volumeAttrivutes</strong> 傳遞每個解決方案需要的參數過去，以 <strong>NFS</strong> 為範例，就是目標伺服器的 <strong>IP</strong> 地址以及欲分享的資料夾。</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: data-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: data-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - ReadWriteMany</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capacity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage: 100Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  csi:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    driver: csi-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumeHandle: data-id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumeAttributes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      server: 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      share: /nfsshare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: data-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - ReadWriteMany</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage: 100Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - key: name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      values: [&quot;data-nfsplugin&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - image: maersk/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - containerPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - mountPath: /var/www</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: data-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: data-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    persistentVolumeClaim:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      claimName: data-nfsplugin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="觀察">觀察<a href="#觀察" class="hash-link" aria-label="Direct link to 觀察" title="Direct link to 觀察">​</a></h2><p>環境都架設完畢之後，第一步先觀察 <strong>NFS</strong> 是否如預期般的運作</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl exec nginx ls /var/www</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">influxdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mongodb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ ls /nfsshare/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">influxdb  mongodb  user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo touch /nfsshare/test1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl exec nginx ls /var/www</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">influxdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mongodb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>看起來非常順利，基本的 <strong>NFS</strong> 掛載已經成功，接下來我們就要來觀察基於 <strong>CSI</strong> 的環境有什麼不同</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl api-resources | grep -i storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">csidrivers                                     storage.k8s.io                 false        CSIDriver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">csinodes                                       storage.k8s.io                 false        CSINode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storageclasses                    sc           storage.k8s.io                 false        StorageClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">volumeattachments                              storage.k8s.io                 false        VolumeAttachment</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我們透過 <strong>kubectl api-resources</strong> 去觀察系統上目前有哪些跟 <strong>storage</strong> 有關的資源，發現除了過往的 <strong>storageclasses</strong> 之外，還多出了三個資源，分別是 <strong>csidrivers</strong>, <strong>csinodes</strong> 以及 <strong>volumeattachmenets</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="csidriver">CSIDriver<a href="#csidriver" class="hash-link" aria-label="Direct link to CSIDriver" title="Direct link to CSIDriver">​</a></h3><p>非常不幸的，我們的範例中並沒有創建任何資源於這個物件類別下</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get csidrivers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No resources found.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根據<a href="https://kubernetes-csi.github.io/docs/csi-driver-object.html" target="_blank" rel="noopener noreferrer">官方開發指南</a>，裡面對於 <strong>CSIDriver</strong> 的描述是</p><blockquote><p>The CSIDriver Kubernetes API object serves two purposes:
Simplify driver discovery
If a CSI driver creates a CSIDriver object, Kubernetes users can easily discover the CSI Drivers installed on their cluster (simply by issuing kubectl get CSIDriver)
Customizing Kubernetes behavior
Kubernetes has a default set of behaviors when dealing with CSI Drivers (for example, it calls the Attach/Detach operations by default). This object
allows CSI drivers to specify how Kubernetes should interact with it.</p></blockquote><p>簡單來說這個資源不一定會有，主要取決於 <strong>CSI</strong> 解決方案有沒有要創建，創建的話提供兩個好處</p><ol><li>使用者更容易的觀察到系統上安裝了哪些 <strong>CSI</strong> 解決方案
我認為這滿方便的，但是能夠強制要求創建該物件就更棒了</li><li>讓 <strong>CSI</strong>解決方案能夠有機會對 <strong>kubelet</strong> 進行控制，去管理整個 <strong>CSI</strong> 的運作邏輯。</li></ol><p>一個合法的內容可能如下</p><div class="language-yaml= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: storage.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: CSIDriver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: mycsidriver.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  attachRequired: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  podInfoOnMount: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  volumeLifecycleModes: # added in Kubernetes 1.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Persistent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Ephemeral</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 <strong>volumeLifycecleModes</strong> 甚至是 <strong>kubernetes 1.16</strong> 所加入的，有興趣的可以自行參閱<a href="https://kubernetes-csi.github.io/docs/csi-driver-object.html#what-fields-does-the-csidriver-object-have" target="_blank" rel="noopener noreferrer">開發指南</a> 去瞭解每個欄位的定義。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="csinodes">CSINodes<a href="#csinodes" class="hash-link" aria-label="Direct link to CSINodes" title="Direct link to CSINodes">​</a></h3><p>透過 <strong>kubectl describe</strong> 我們可以看到更多關於 <strong>CSINodes</strong> 的資料。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get csinodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME      CREATED AT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-dev   2019-09-29T07:19:27Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl describe csinodes k8s-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         k8s-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API Version:  storage.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kind:         CSINode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Creation Timestamp:  2019-09-29T07:19:27Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Owner References:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    API Version:     v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Kind:            Node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name:            k8s-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UID:             8ed067fe-dbe7-4297-8177-c8a9da227962</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Resource Version:  540</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Self Link:         /apis/storage.k8s.io/v1beta1/csinodes/k8s-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UID:               1fd550dd-194a-4f20-8d41-fd1f42fbe16a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Drivers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name:           csi-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Node ID:        k8s-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Topology Keys:  &lt;nil&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:             &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中最重要的就是 <strong>spec.drivers</strong> 內的資料，包含了</p><ol><li>該解決方案的名稱，定義於該解決方案內的程式碼。</li><li>該節點的名稱，因為 <strong>CSI</strong> 裡面有很多的介面都會需要 <strong>NodeID</strong> 來進行一些處理，特別是 <strong>Controller</strong> 端的介面。</li></ol><p>根據 <a href="https://kubernetes-csi.github.io/docs/csi-node-object.html#what-is-the-csinode-object" target="_blank" rel="noopener noreferrer">官方開發指南</a> 內的描述， CSINode 有下列的事項要注意</p><ol><li><strong>CSI</strong> 解決方案本身不需要自行創造，只要透過上篇介紹過的開發小幫手 - sidecar containers 中的 <strong>node-device-register</strong> 就會自動創造該物件</li><li>該物件創立的目的是希望提供下列資訊<ul><li>將 kubernetes node 的名稱轉換至 CSI node name</li><li>透過相關物件判斷特定節點上是否有註冊相關的 CSI 解決方案</li></ul></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="volumeattachments">VolumeAttachments<a href="#volumeattachments" class="hash-link" aria-label="Direct link to VolumeAttachments" title="Direct link to VolumeAttachments">​</a></h3><p>這個物件是用來描述 <strong>CSI</strong> 使用過程中去掛載 <strong>Volume</strong> 的相關資訊。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get volumeattachments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                                   ATTACHER        PV               NODE      ATTACHED   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">csi-f642ae48557f63a1f4377a265c43d6afe2e8d859837925fef2331b9e541e31a3   csi-nfsplugin   data-nfsplugin   k8s-dev   true       20m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl describe volumeattachments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         csi-f642ae48557f63a1f4377a265c43d6afe2e8d859837925fef2331b9e541e31a3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API Version:  storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kind:         VolumeAttachment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Creation Timestamp:  2019-09-29T07:19:49Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Resource Version:    577</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Self Link:           /apis/storage.k8s.io/v1/volumeattachments/csi-f642ae48557f63a1f4377a265c43d6afe2e8d859837925fef2331b9e541e31a3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UID:                 991d3c32-0d4f-43e8-bcdc-c5a5d038cd38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Attacher:   csi-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Node Name:  k8s-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Source:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Persistent Volume Name:  data-nfsplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Attached:  true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:      &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>譬如從 <strong>spec</strong> 可以看到有一個掛載的行為是</p><ol><li>透過 Attacher <strong>csi-nfsplugin</strong> 於 node <strong>k8s-dev</strong> 上掛載一個 <strong>volume</strong>，而該 <strong>volume</strong> 的來源是名為 <strong>data-nfsplugin</strong> 的 <strong>PVC</strong> 所定義的。</li></ol><p>這些資訊都可以幫忙釐清與確認當前是否 <strong>CSI</strong> 的儲存功能有正常運作，我覺得相對於之前單純的 <strong>PV/PVC</strong> 有來得清楚一些。</p><h1>Summary</h1><p>本文基於 <strong>CSI</strong> 架構下部署了一個 <strong>NFS</strong> 的儲存方案，並且用一個 <strong>Pod</strong> 作為掛載的範例，來實際部署的流程與架構，同時觀察整個 kubernetes 本身是否有新增加的資源與內容。</p><h1>參考</h1><ul><li><a href="https://github.com/kubernetes-csi/csi-driver-nfs" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-csi/csi-driver-nfs</a></li><li><a href="https://kubernetes-csi.github.io/docs" target="_blank" rel="noopener noreferrer">https://kubernetes-csi.github.io/docs</a></li><li><a href="https://github.com/kubernetes-csi/node-driver-registrar" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-csi/node-driver-registrar</a></li><li>kubernetes.io/blog/2019/01/15/container-storage-interface-ga/</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/csi">CSI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/storage">Storage</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/i-thome">iThome</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/techPost/2019/iThome_Challenge/csi-iii"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Container Storage Interface 與 kubernetes</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/techPost/2019/iThome_Challenge/csi-other"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CSI 雜談</div></a></nav><hr><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#安裝內容" class="table-of-contents__link toc-highlight">安裝內容</a><ul><li><a href="#controller" class="table-of-contents__link toc-highlight">Controller</a></li><li><a href="#node" class="table-of-contents__link toc-highlight">Node</a></li><li><a href="#nginx" class="table-of-contents__link toc-highlight">Nginx</a></li></ul></li><li><a href="#觀察" class="table-of-contents__link toc-highlight">觀察</a><ul><li><a href="#csidriver" class="table-of-contents__link toc-highlight">CSIDriver</a></li><li><a href="#csinodes" class="table-of-contents__link toc-highlight">CSINodes</a></li><li><a href="#volumeattachments" class="table-of-contents__link toc-highlight">VolumeAttachments</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d6ce37b6.js"></script>
<script src="/assets/js/main.f9e3d066.js"></script>
</body>
</html>