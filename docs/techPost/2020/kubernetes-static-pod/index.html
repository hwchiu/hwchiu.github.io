<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-techPost/2020/kubernetes-static-pod" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">[Kubernetes] Static Pod 介紹 | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hwchiu.com/docs/techPost/2020/kubernetes-static-pod"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[Kubernetes] Static Pod 介紹 | hwchiu learning note"><meta data-rh="true" name="description" content="本文主要跟大家分享如何透過 Static Pod 的方式來滿足用 Kubernetes 管理 API-Server/Controller/Scheduler 這些 Kubernetes 的基礎元件，其中 Static Pod 更是 Kubeadm 的架設原理，透過這個方式我們也可以更加了解 Kubeadm 的安裝方式"><meta data-rh="true" property="og:description" content="本文主要跟大家分享如何透過 Static Pod 的方式來滿足用 Kubernetes 管理 API-Server/Controller/Scheduler 這些 Kubernetes 的基礎元件，其中 Static Pod 更是 Kubeadm 的架設原理，透過這個方式我們也可以更加了解 Kubeadm 的安裝方式"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hwchiu.com/docs/techPost/2020/kubernetes-static-pod"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/techPost/2020/kubernetes-static-pod" hreflang="en"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/techPost/2020/kubernetes-static-pod" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed"><link rel="stylesheet" href="/assets/css/styles.d69aff92.css">
<link rel="preload" href="/assets/js/runtime~main.a31dc44e.js" as="script">
<link rel="preload" href="/assets/js/main.ff86d575.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hwchiu/docusaurus-blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/cncf-tech-radar-cd">CNCF Continuous Delivery 使用者調查報告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/cncf-tech-radar-observability">CNCF Observability 使用者調查報告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/cni-performance-2020">[文章導讀] - 基於10G網路的 Kubernetes CNI 效能比較</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/docker-network-model-lab-dnat">Docker 網路入門篇(四) - 外界主動存取</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/docker-network-model-lab">Docker 網路入門篇(二) - Bridge 網路模型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/docker-network-model-snat">Docker 網路入門篇(三) - 網路存取分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/docker-network-model">Docker Network - 網路模型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/gitops-bad-and-ugly">GitOps 帶來的痛點與反思</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/gitops-book-ch1">[書本導讀]-GitOps 到底解決了什麼問題</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/gitops-book-ch2">[書本導讀]-什麼是GitOps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/gitops-book-ch3">[書本導讀]-淺談GitOps過往</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/gitops-book-ch4">[書本導讀]-GitOps工具的選擇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/gitops-book-ch5">[書本導讀]- GitOps實作上的挑戰</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/gitops-book-ch6">[書本導讀]-GitOps後續</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/gitops">淺談 GitOps 的概念</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/techPost/2020/iThome_Challenge/cicd">iThome_Challenge</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/iptables-1">初探 IPTABLES 流動之路 - 以 Docker 為範例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/iptables-masquerade-handson">Linux NAT Masquerade 研究(下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/ipvs-1">IPvS 學習手冊(一)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/ipvs-2">IPvS 學習手冊(二)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/ipvs-3">IPvS 學習手冊(三)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/ipvs-4">IPvS 學習手冊(四)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2020/kubernetes-duplicate-pod-ip">Kubernetes - IP 重複奇遇記</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/techPost/2020/kubernetes-static-pod">[Kubernetes] Static Pod 介紹</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2020"><span itemprop="name">2020</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">[Kubernetes] Static Pod 介紹</span><meta itemprop="position" content="2"></li></ul></nav><div class="theme-doc-markdown markdown"><h1>Preface</h1><p>本文想要跟大家來分享討論一下另外一種部署 Kubernetes Pod 的方式，稱之為 Static Pod，這個部署方式最大的示範情境就是 Kubeadm 的使用。</p><p>當部署完 Kubeadm 後，透過 <code>kubectl -n kube-system get pods</code>，是不是會看到 <code>kube-scheduler</code>, <code>kube-apiserver</code> 以及 <code>kube-controller-manager</code>.</p><p>那..這些核心元件組成了 Kubernetes Control-Plane，但是本身卻又是被 Kubernetes 所管理，那到底是這中間是怎麼運作的?</p><p>這個問題就要從 Static Pod 的部署來談起</p><h1>Environment</h1><p>本文觀察環境基於下列版本</p><ol><li>kubeadm: v1.17.3</li><li>kubectl: v1.17.3</li><li>Kubernetes: v1.17.3</li></ol><p>如果有使用 Vagrant 的人，可以用下列的檔案建置相關環境</p><div class="language-ruby= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ruby= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># -*- mode: ruby -*-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># vi: set ft=ruby :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vagrant.configure(&quot;2&quot;) do |config|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.box = &quot;bento/ubuntu-18.04&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.box_version =&#x27;201912.14.0&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.hostname = &#x27;k8s-dev&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.define vm_name = &#x27;k8s&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.provision &quot;shell&quot;, privileged: false, inline: &lt;&lt;-SHELL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set -e -x -u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    export DEBIAN_FRONTEND=noninteractive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #change the source.list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get install -y vim git cmake build-essential tcpdump tig jq socat bash-completion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Install Docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    export DOCKER_VERSION=&quot;5:19.03.5~3-0~ubuntu-bionic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get install -y docker-ce=${DOCKER_VERSION}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo usermod -aG docker $USER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #Disable swap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #https://github.com/kubernetes/kubernetes/issues/53533</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo swapoff -a &amp;&amp; sudo sysctl -w vm.swappiness=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo sed &#x27;/vagrant--vg-swap/d&#x27; -i /etc/fstab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot; | sudo tee --append /etc/apt/sources.list.d/kubernetes.list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo apt-get install -y kubelet kubeadm kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo kubeadm init --pod-network-cidr=10.244.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p $HOME/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &#x27;source &lt;(kubectl completion bash)&#x27; &gt;&gt;~/.bashrc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SHELL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.network :private_network, ip: &quot;172.17.8.111&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.vm.provider :virtualbox do |v|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      v.customize [&quot;modifyvm&quot;, :id, &quot;--cpus&quot;, 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      v.customize [&quot;modifyvm&quot;, :id, &quot;--memory&quot;, 4096]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      v.customize [&#x27;modifyvm&#x27;, :id, &#x27;--nicpromisc1&#x27;, &#x27;allow-all&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>How Kubeadm Works</h1><p>為了部署一個 Pod 到 Kubernetes 節點上，其中牽扯了多個元件，從 API Server, Scheduler, Controller 到節點上的 kubelet, Container Runtime。</p><p>然而對於 Scheduler/Controller/API Server 這三個核心元件說，到底該怎麼建制以及維護？</p><ol><li>Native Application, 直接運行三個不同的 Binary 執行檔案<ul><li>可透過 systemd 來包裝這些應用程式</li></ul></li><li>透過已經包裝好的 Container Image 來執行這三個服務</li></ol><p>以 <code>Kubeadm</code> 為範例，其先透過 <code>systemd</code> 的方式來管理 <code>kubelet</code>，確保 <code>kubelet</code> 這個 daemon 本身可以被監控，如果有問題會自動重新起動，甚至重新開機後都可以滿足叫起來提供服務。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ systemctl status kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">● kubelet.service - kubelet: The Kubernetes Node Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Drop-In: /etc/systemd/system/kubelet.service.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           └─10-kubeadm.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Active: active (running) since Tue 2020-03-10 04:42:30 UTC; 1h 20min ago</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Docs: https://kubernetes.io/docs/home/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Main PID: 646 (kubelet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tasks: 21 (limit: 4659)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   CGroup: /system.slice/kubelet.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           └─646 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kub</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至於上述三個元件本身都有相關的容器映像檔，其實最簡單的方式就是於節點上直接透過 Container Runtime 去運行這三個節點即可。</p><p>可以看到安裝完畢 kubeadm 的環境後，系統上都有這些相關的 container image.</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ docker images | grep k8s.gcr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s.gcr.io/kube-proxy                v1.17.3             ae853e93800d        3 weeks ago         116MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s.gcr.io/kube-controller-manager   v1.17.3             b0f1517c1f4b        3 weeks ago         161MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s.gcr.io/kube-apiserver            v1.17.3             90d27391b780        3 weeks ago         171MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s.gcr.io/kube-scheduler            v1.17.3             d109c0821a2b        3 weeks ago         94.4MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s.gcr.io/coredns                   1.6.5               70f311871ae1        4 months ago        41.6MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s.gcr.io/etcd                      3.4.3-0             303ce5db0e90        4 months ago        288MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s.gcr.io/pause                     3.1                 da86e6ba6ca1        2 years ago         742kB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>為了能夠運行起整個 <code>Kubernetes</code>, 只要透過(以範例來說) <strong>docker start</strong> 的方式並且給予相關的參數，就能夠將整個 API-Server/Controller/Schduler 運行起來搭建一個 Kubernetes 叢集。</p><p>然而實際上你透過下列指令你卻會發現 <code>kube-system</code> 中卻有這三個容器的存在</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl -n kube-system get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">coredns-6955765f44-gdvrd          1/1     Running   1          15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">coredns-6955765f44-p4wj2          1/1     Running   1          15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-k8s-dev                      1/1     Running   1          15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-apiserver-k8s-dev            1/1     Running   1          15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-controller-manager-k8s-dev   1/1     Running   1          15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-flannel-ds-amd64-k2w8g       1/1     Running   1          15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-proxy-6nnrt                  1/1     Running   1          15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-scheduler-k8s-dev            1/1     Running   1          15d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>更特別的是，由下列幾種方式可以推論出基本上沒有使用更上層的管理 <strong>Deployment</strong>, <strong>ReplicaSet</strong>, <strong>DaemonSet</strong>, <strong>StatefulSet</strong>, <strong>ReplicatController</strong></p><ol><li>Pod 的命名規則</li><li>Pod 裡面的 ownerReference</li></ol><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl -n kube-system get pod kube-scheduler-k8s-dev -o json | jq &#x27;.metadata.ownerReferences&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;apiVersion&quot;: &quot;v1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;controller&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;kind&quot;: &quot;Node&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;k8s-dev&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;uid&quot;: &quot;b8755102-968b-41ac-a923-0e2cceacaf03&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>kubectl -n kube-system get all</li></ol><p>對一個沒有任何更高階的 <strong>Controller</strong> 管理的 <strong>Pod</strong> 來說，你如果嘗試將這些 <strong>Pod</strong> 移除，你會發現這些 <strong>Pod</strong> 都會自己重生</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl -n kube-system get pods -l component=kube-controller-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-controller-manager-k8s-dev   1/1     Running   1          15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl -n kube-system delete pod kube-controller-manager-k8s-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod &quot;kube-controller-manager-k8s-dev&quot; deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl -n kube-system get pods -l component=kube-controller-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-controller-manager-k8s-dev   0/1     Pending   0          3s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但是如果你自己創立一個 <strong>pod</strong> 並且刪除，就真的完全刪除不會重啟。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No resources found in default namespace.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl run --generator=run-pod/v1 nginx --image=nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/nginx created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    READY   STATUS              RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   0/1     ContainerCreating   0          3s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   1/1     Running   0          6s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get pods nginx -o json | jq &#x27;.metadata.ownerReferences&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl delete pod nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod &quot;nginx&quot; deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No resources found in default namespace.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No resources found in default namespace.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這其中的奧妙就在於 <strong>ownerReferences</strong>，自行創立的 <strong>pod</strong> 是完全空的，但是 <strong>kubeadm</strong> 裡面的 <strong>API Server/Controller/Scheduler</strong> 卻是有資料，並且資料是</p><div class="language-json= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;apiVersion&quot;: &quot;v1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;controller&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;kind&quot;: &quot;Node&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;k8s-dev&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;uid&quot;: &quot;b8755102-968b-41ac-a923-0e2cceacaf03&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其實這邊已經透漏出了玄機，這些 <strong>Pod</strong> 是由 <strong>節點Node</strong> 本身去維護的，本身不依賴任何我們到的 workload 型態。 節點取代了過往的 <strong>Kubernetes Controller</strong> 去確保三個核心功能的 Pod 必須活者</p><p>而這個用法就是所謂的 Static Pod</p><h1>Static Pod</h1><p>相對於透過 <strong>Kubernetess</strong> 控制平面來管理這些 <strong>Pod</strong>, <strong>Static Pod</strong> 有一些特性</p><ol><li>沒有 Schedule 的概念，就是固定於該節點運行</li><li>由 Kubelet 去進行監控並且管理，一旦該 Pod 結束則會重新啟動</li><li>Kubelet 本身會 Mirror 該 Pod 的資訊，所以才可以透過 kubectl 等相關資訊去看到</li></ol><p>其中如果(3)的部分可以參閱 <a href="https://github.com/kubernetes/kubernetes/blob/v1.17.3/pkg/kubelet/kubelet.go#L1638" target="_blank" rel="noopener noreferrer">kubelet 原始碼</a></p><div class="language-golang= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    // Create Mirror Pod for Static Pod if it doesn&#x27;t already exist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if kubetypes.IsStaticPod(pod) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        podFullName := kubecontainer.GetPodFullName(pod)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deleted := false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if mirrorPod != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if mirrorPod.DeletionTimestamp != nil || !kl.podManager.IsMirrorPodOf(mirrorPod, pod) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // The mirror pod is semantically different from the static pod. Remove</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // it. The mirror pod will get recreated later.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                klog.Infof(&quot;Trying to delete pod %s %v&quot;, podFullName, mirrorPod.ObjectMeta.UID)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                var err error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                deleted, err = kl.podManager.DeleteMirrorPod(podFullName, &amp;mirrorPod.ObjectMeta.UID)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if deleted {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    klog.Warningf(&quot;Deleted mirror pod %q because it is outdated&quot;, format.Pod(mirrorPod))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    klog.Errorf(&quot;Failed deleting mirror pod %q: %v&quot;, format.Pod(mirrorPod), err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if mirrorPod == nil || deleted {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            node, err := kl.GetNode()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if err != nil || node.DeletionTimestamp != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                klog.V(4).Infof(&quot;No need to create a mirror pod, since node %q has been removed from the cluster&quot;, kl.nodeName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                klog.V(4).Infof(&quot;Creating a mirror pod for static pod %q&quot;, format.Pod(pod))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if err := kl.podManager.CreateMirrorPod(pod); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    klog.Errorf(&quot;Failed creating a mirror pod for %q: %v&quot;, format.Pod(pod), err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>對於 Kubelet 來說，其本身有一個設定叫做 <code>staticPodPath</code>, 這是一個資料夾，只要放到該資料夾下的檔案都會被 <strong>kubelet</strong> 用來創立 <strong>static pod</strong>.</p><p>至於 <strong>Kubelet</strong> 創造 <strong>Pod</strong> 的方式其實還是遵循 <strong>Kubernetes</strong> 的走法，並非直接使用 <strong>docker start</strong>(舉例) 來創立。這部分是為了讓所有的 <strong>Container</strong> 操作全部都經由 <strong>Container Runtime Interface</strong> 來管理，進而提供更好的相容性。</p><h1>Hands-on</h1><p>接下來我們就動手觀察一下相關的參數，首先根據剛剛 <strong>systemd</strong> 的提示，我們知道用來控管 <strong>kubelet</strong> 的啟動檔案於 <strong>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</strong></p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EnvironmentFile=-/etc/default/kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>裡面要注意的是 <strong>KUBELET_CONFIG_ARGS</strong> 這個變數，裡面使用了 <strong>--config=/var/lib/kubelet/config.yaml</strong> 來指名 <strong>kubelet</strong> 的參數檔案</p><p>因此接下來看一下其內容</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo cat  /var/lib/kubelet/config.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubelet.config.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authentication:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  anonymous:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  webhook:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cacheTTL: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  x509:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientCAFile: /etc/kubernetes/pki/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authorization:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode: Webhook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  webhook:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cacheAuthorizedTTL: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cacheUnauthorizedTTL: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterDNS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 10.96.0.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterDomain: cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpuManagerReconcilePeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">evictionPressureTransitionPeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fileCheckFrequency: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">healthzBindAddress: 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">healthzPort: 10248</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">httpCheckFrequency: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageMinimumGCAge: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: KubeletConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nodeStatusReportFrequency: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nodeStatusUpdateFrequency: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rotateCertificates: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runtimeRequestTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">staticPodPath: /etc/kubernetes/manifests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">streamingConnectionIdleTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syncFrequency: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">volumeStatsAggPeriod: 0s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中吸引我們注意的是  <strong>staticPodPath</strong> 這個參數，接下來看一下該資料夾的位置</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ sudo ls /etc/kubernetes/manifests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到裡面放了四個 <strong>yaml</strong> 檔案(包含 etcd)，如果打開這些 <strong>yaml</strong> 就會是我們所熟悉的 <strong>Kubernetes</strong> 格式了。</p><p>如果這時候隨便放入一個 <strong>yaml</strong> 到該資料夾中，會發生什麼事情?</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF | sudo tee /etc/kubernetes/manifests/static-debug.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: static-debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: hwchiu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: hwchiu/netutils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get  pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                   READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static-debug-k8s-dev   1/1     Running   0          27s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl delete pod static-debug-k8s-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod &quot;static-debug-k8s-dev&quot; deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get  pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                   READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static-debug-k8s-dev   0/1     Pending   0          1s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ kubectl get  pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                   READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static-debug-k8s-dev   1/1     Running   0          3s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊可以看到馬上就會產生對應的 <strong>Pod</strong> 並且也獲得了自動重啓的能力。</p><p>最後！ 我們透過 <strong>docker  ps</strong> 觀察一下</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vagrant@k8s-dev:~$ docker ps | grep kube-controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5f16cb76460f        b0f1517c1f4b           &quot;kube-controller-man…&quot;   2 hours ago         Up 2 hours                              k8s_kube-controller-manager_kube-controller-manager-k8s-dev_kube-system_25245994bd78f09602b6f5c3e5d2246c_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a94f104316af        k8s.gcr.io/pause:3.1   &quot;/pause&quot;                 2 hours ago         Up 2 hours                              k8s_POD_kube-controller-manager-k8s-dev_kube-system_25245994bd78f09602b6f5c3e5d2246c_1vagrant@k8s-dev:~$ docker ps | grep kube-controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5f16cb76460f        b0f1517c1f4b           &quot;kube-controller-man…&quot;   2 hours ago         Up 2 hours                              k8s_kube-controller-manager_kube-controller-manager-k8s-dev_kube-system_25245994bd78f09602b6f5c3e5d2246c_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a94f104316af        k8s.gcr.io/pause:3.1   &quot;/pause&quot;                 2 hours ago         Up 2 hours                              k8s_POD_kube-controller-manager-k8s-dev_kube-system_25245994bd78f09602b6f5c3e5d2246c_1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到針對 <strong>kube-controller-manager</strong>  這個 <strong>Pod</strong> 來說，其實背後也是有 <strong>Pause Container</strong> 作為整個 <strong>Pod</strong> 的沙盒，這也證明了這些 <strong>Static Pod</strong> 的創建也是基於 <strong>CRI</strong> 的標準所創立的，並非是直接透過 <strong>docker command</strong> 來創立。</p><ul><li>CRI 內的基本單位都是 Pod, 而非 Container, 有興趣的可以參考他們的 gRPC 介面</li></ul><p>另外，其實 <strong>kubeadm</strong> 的安裝過程就已經透露出相關資訊</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W0310 06:57:46.902862    2798 manifests.go:214] the default kube-apiserver authorization-mode is &quot;Node,RBAC&quot;; using &quot;Node,RBAC&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W0310 06:57:46.903651    2798 manifests.go:214] the default kube-apiserver authorization-mode is &quot;Node,RBAC&quot;; using &quot;Node,RBAC&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[etcd] Creating static Pod manifest for local etcd in &quot;/etc/kubernetes/manifests&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ts&quot;. This can take up to 4m0s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Summary</h1><p>這次我們探討了關於 <strong>Static Pod</strong> 的概念，雖然實際部署上比較少這樣使用，但是透過這次的探討我們可以更了解 <strong>Kubeadm</strong> 是如何安裝 <strong>Kubernetes</strong> 環境，
並且也學習到了一些 <strong>Kubernetes</strong> 本身的特性。</p><h1>課程分享</h1><p>最後，我目前於 Hiskio 上面有開設一門 Kubernetes 入門篇的課程，裡面會探討運算/網路/儲存三個最重要的平台資源，此外對於 CRI/CNI/CSI 也都有簡單的介紹，主要會基於 <strong>Kubernetes</strong> 本身的設計原理及各資源的用法與情境去介紹。
如果本身已經很熟練的使用 Kubernetes 於環境中就不太適合這門課程，主要是給想要踏入到 Kubernetes 世界中的朋友，有興趣的幫忙捧場或推廣
線上課程詳細資訊: <a href="https://course.hwchiu.com/" target="_blank" rel="noopener noreferrer">https://course.hwchiu.com/</a></p><h1>Reference</h1><ul><li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/</a></li><li><a href="https://github.com/kubernetes/kubernetes/blob/v1.17.3/pkg/kubelet/kubelet.go#L1637-L1638" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/blob/v1.17.3/pkg/kubelet/kubelet.go#L1637-L1638</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/container">Container</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">Linux</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/techPost/2020/kubernetes-duplicate-pod-ip"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Kubernetes - IP 重複奇遇記</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/2019"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">2019</div></a></nav></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a31dc44e.js"></script>
<script src="/assets/js/main.ff86d575.js"></script>
</body>
</html>