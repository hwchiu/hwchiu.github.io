<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-techPost/2018/kubernetes-service-iiii" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">[Kubernetes] How to Implement Kubernetes Service - SessionAffinity | hwchiu learning note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hwchiu.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hwchiu.com/docs/techPost/2018/kubernetes-service-iiii"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[Kubernetes] How to Implement Kubernetes Service - SessionAffinity | hwchiu learning note"><meta data-rh="true" name="description" content="在前述中我們已經學過了什麼是 kubernetes service 以及如何實現 ClusterIP/NodePort 等 service 類型. 透過對 iptables 的探討與研究. 接下來要研究的則是 Service 裡面的一個參數, 叫做 SessionAffinity, 所謂的連線親和力, 透過該參數的設定,希望能夠讓符合特定條件的連線最後都會選用到相同的後端應用程式,目前有支援的選項是 ClinetIP, 這意味者只要連線的來源 IP 地址是相同的,最後都會被導向到相同的容器應用程式. 然而這部分到底是如何實現的, 本文會先介紹什麼叫做 Connection. 並且介紹 SessionAffinity 的使用方式以及使用後的結果. 最後一樣透過相同的思路, 藉由研究 iptables 的規則來學習到 SessionAffinity 要如何完成, 同時也可以學習到 iptables 衆多靈活的使用方式."><meta data-rh="true" property="og:description" content="在前述中我們已經學過了什麼是 kubernetes service 以及如何實現 ClusterIP/NodePort 等 service 類型. 透過對 iptables 的探討與研究. 接下來要研究的則是 Service 裡面的一個參數, 叫做 SessionAffinity, 所謂的連線親和力, 透過該參數的設定,希望能夠讓符合特定條件的連線最後都會選用到相同的後端應用程式,目前有支援的選項是 ClinetIP, 這意味者只要連線的來源 IP 地址是相同的,最後都會被導向到相同的容器應用程式. 然而這部分到底是如何實現的, 本文會先介紹什麼叫做 Connection. 並且介紹 SessionAffinity 的使用方式以及使用後的結果. 最後一樣透過相同的思路, 藉由研究 iptables 的規則來學習到 SessionAffinity 要如何完成, 同時也可以學習到 iptables 衆多靈活的使用方式."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hwchiu.com/docs/techPost/2018/kubernetes-service-iiii"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/techPost/2018/kubernetes-service-iiii" hreflang="en"><link data-rh="true" rel="alternate" href="https://hwchiu.com/docs/techPost/2018/kubernetes-service-iiii" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="hwchiu learning note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="hwchiu learning note Atom Feed"><link rel="stylesheet" href="/assets/css/styles.d69aff92.css">
<link rel="preload" href="/assets/js/runtime~main.66f04512.js" as="script">
<link rel="preload" href="/assets/js/main.65098930.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Hwchiu" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HWCHIU 學習筆記</b></a><a class="navbar__item navbar__link" href="/about">我是誰</a><a class="navbar__item navbar__link" href="/">短篇筆記</a><a class="navbar__item navbar__link" href="/tags">短篇筆記-分類</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/2023">長篇技術文</a><a class="navbar__item navbar__link" href="/docs/tags">長篇技術文-分類</a><a class="navbar__item navbar__link" href="/course">線上課程</a><a class="navbar__item navbar__link" href="/public_sharing">演講紀錄</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hwchiu/docusaurus-blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2023">2023</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2022">2022</a><button aria-label="Toggle the collapsible sidebar category &#x27;2022&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2021">2021</a><button aria-label="Toggle the collapsible sidebar category &#x27;2021&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2020">2020</a><button aria-label="Toggle the collapsible sidebar category &#x27;2020&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2019">2019</a><button aria-label="Toggle the collapsible sidebar category &#x27;2019&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/2018">2018</a><button aria-label="Toggle the collapsible sidebar category &#x27;2018&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/cert-manager">Automatically Renew Your Certificated in kubernetes by Cert-Manager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/cni-compare">常見 CNI (Container Network Interface) Plugin 介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/cni-questions">CNI 常見問題整理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/gpu-gke">Install GPU in GKE(Google Kubernetes Engine)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/introduce-cni-i">[Container Network Interface] Bridge Network In Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/introduce-cni-ii">[Container Network Interface] CNI Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/introduce-cni-iii">[Container Network Interface] Implement Your CNI In Golang</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/k8s-security-11tips-i">11個保護你 Kubernetes 集群的技巧與觀念(上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/k8s-security-11tips-ii">11個保護你 Kubernetes 集群的技巧與觀念(下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/kubernetes-dns-ii">[Kubernetes] DNS Setting When DnsPolicy Is Default</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/kubernetes-dns-iii">[Kubernetes] DNS Setting with Dockerd(原始碼分析上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/kubernetes-dns-iiii">[Kubernetes] DNS Setting with Dockerd(原始碼分析下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/kubernetes-dns">[Kubernetes] DNS setting in your Pod</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/kubernetes-fedora">Install the kubernetes as single node in Fedora 28</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/kubernetes-service-i">[Kubernetes] What Is Service?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/kubernetes-service-ii">[Kubernetes] How to Implement Kubernetes Service - ClusterIP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/kubernetes-service-iii">[Kubernetes] How to Implement Kubernetes Service - NodePort</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/techPost/2018/kubernetes-service-iiii">[Kubernetes] How to Implement Kubernetes Service - SessionAffinity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/kubernetes-storage-i">Kubernetes X Storage (I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/kubernetes-storage-ii">NFS 於 Kubernetes 內的各種應用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/mgo-aggregate">[Golang] aggregate in mongo</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/netfilter-eiptables-i">[netfilter] Introduction to ebtables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/netfilter-eiptables-ii">[netfilter] Introduction to iptables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/netfilter-eiptables-iii">[netfilter] Dig Into Docker Bridge Network By iptables/ebtables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/paper-tensorflow-with-rdma">[論文導讀] - Towards Zero Copy Dataflows using RDMA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/tools-ncdu">NCurses Disk Usage(ncdu)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/travisci-k8s">使用 Travis CI 為你的 Kubernetes 應用程式打造自動化測試</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/techPost/2018/travisci-step-job-stage">[DevOps] Travis CI - Step/Job/Stage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2017">2017</a><button aria-label="Toggle the collapsible sidebar category &#x27;2017&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2016">2016</a><button aria-label="Toggle the collapsible sidebar category &#x27;2016&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2015">2015</a><button aria-label="Toggle the collapsible sidebar category &#x27;2015&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2014">2014</a><button aria-label="Toggle the collapsible sidebar category &#x27;2014&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/2013">2013</a><button aria-label="Toggle the collapsible sidebar category &#x27;2013&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/2018"><span itemprop="name">2018</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">[Kubernetes] How to Implement Kubernetes Service - SessionAffinity</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Preface</h1><p>本文章是屬於 <code>kubernetes</code> service 系列文之一，該系列文希望能夠與大家討論下量兩個觀念</p><ol><li>什麼是 <code>Kubernetes Service</code>, 為什麼我們需要它？ 它能夠幫忙解決什麼問題</li><li><code>Kubernetes Service</code> 是怎麼實現的?， 讓我們用 iptables 來徹徹底底的理解他</li></ol><p>相關文章:
<a href="https://www.hwchiu.com/kubernetes-service-i.html" target="_blank" rel="noopener noreferrer">[Kubernetes] What is Service</a>
<a href="https://www.hwchiu.com/kubernetes-service-ii.html" target="_blank" rel="noopener noreferrer">[Kubernetes] How To Implement Kubernetes Service - ClusterIP</a>
<a href="https://www.hwchiu.com/kubernetes-service-iii.html" target="_blank" rel="noopener noreferrer">[Kubernetes] How To Implement Kubernetes Service - NodePort</a></p><p>本文銜接前續文章，繼續透過對 <code>iptables</code> 的分析來研究 <code>kubernetes service</code> 中 <code>SessionAffinity</code> 的實作原理。</p><h1>What Is Connection</h1><p>在我們開始討論 <code>SessionAffinity</code> 之前，我們要先來討論一下，什麼叫做 <code>Connection</code>, 並且透過對 <code>Connection</code> 的瞭解，我們會更容易的理解到底 <code>SessionAffinity</code>  想要解決的問題。</p><p>這邊我們使用下列的圖示來說明到底什麼是 <code>Connection</code></p><p><img loading="lazy" src="https://i.imgur.com/C18G0Ym.png" alt="Imgur" class="img_ev3q"></p><p>這個範例中，我們有一個 <code>kubernetes</code> 叢集，其透過 <code>kubernetes service(NodePort)</code> 的方式將內部的 <code>Nginx</code> 服務讓外界能夠存取。</p><p>此時，在外部我們有兩台機器想要存取這些 <code>Nginx</code> 服務，其中第一台機器 <strong>Host1</strong> 上面有一個 <code>Client Application</code>, 透過 <code>kubernetes service</code> 的功用，其最後存取到了<code>Nginx1</code> 這個容器。
而第二台機器 <strong>Host2</strong> 上面則有兩個 <code>Client Application</code>, 其分別對應到的是 <code>Nginx2</code> 以及 <code>Nginx3</code> 這兩個容器。</p><p>首先，本文中所有提到的 <code>Connection</code> 代表的就是如上圖所示的 <code>ClientApp</code> 到 <code>Nginx</code> 的連線，所以上述的範例總共有三個 <code>Connection</code>.</p><p>這邊我們先思考一個問題，針對圖中 <code>ConnectionA</code> 來討論一下，該 <code>ConnectionA</code> 中所有的來回請求回應，都會走到 <code>Nginx1</code> 嘛?
這些所謂的請求回應，實際是都是網際網路世界中的封包，每個封包一旦到達 <code>Kubernetes </code> 叢集內就會遇到 <code>iptaables</code> 規則的處理。
在這個情況下，我們如何保證該 <code>ConnectionA</code> 裡面的所有封包都可以送達到同一個 <code>Nginx1</code> 也就是所謂的 <code>EndPoints</code>.</p><p>這個問題其實已經解決了，是透過 <code>iptables</code> 解決的。
這個原理沒有辦法一言兩語解決，我之後若有時間會寫相關的文章介紹這邊的原理與實現。
這邊只要知道其方法是倚賴 <code>Linux Kernel</code> 裡面相關的技術去提供類似 <code>Cache</code> 的機制，確保相同的 <code>Connection</code> 內所有的來回封包都會執行相同的 <code>SNAT/DNAT</code>.</p><p>有興趣的讀者可以使用下列關鍵字去搜尋相關文章，不然就是等我哪天有時間在來仔細介紹這邊的概念lol</p><ol><li>netfilter</li><li>conntrack</li><li>DNAT/SNAT</li></ol><h1>What Is SessionAffinity</h1><p>假如相同 <code>Connection</code> 內的封包都已經可以保證連接到相同的 <code>Endpoints</code> 了，那到底什麼是 <code>SessionAffinity</code>?</p><p>換個角度來說，我們有沒有辦法讓建立的新 <code>Connection</code> 都連接到相同的 <code>Endpoints</code> ?</p><p>這個問題就是 <code>SessionAffinity</code> 想要解決並處理的，透過一種機制，讓不同的 <code>Client Application</code> 所建立新的 <code>Connection</code> 最後都會連接到相同的 <code>EndPoints</code>.</p><p>以上圖的範例來說，有沒有可能讓 <code>Connection A,B,C</code> 都連接到相同的 <code>EndPoints</code>?</p><h1>Configuration</h1><p>首先，我們先來看一下 <code>Kubernetes</code> 裡面定義的 <code>SessionAffinity</code> 要怎麼使用
目前總共有兩種類型可以選擇</p><ol><li>None</li><li>ClientIP</li></ol><p>第一種 <code>None</code> 其實就是什麼都不做，針對每一條新的<code>Connection</code>都不去採去任何動作，基本上就是每條<code>Connection</code>都看運氣來選擇最後選擇到哪一個 <code>Endpoints</code>.</p><p>第二種 <code>ClientIP</code> 則是真的有事情要做了，就如同字面上的意思，<code>Client IP</code>.
目的很簡單，對於每一條新建立的 <code>Connection</code>, 若其 <code>Client IP</code> 地址相同，就導到相同的 <code>Endpoints</code> 去使用。</p><p>所以回到剛剛上述的問題
以上圖的範例來說，有沒有可能讓 <code>Connection A,B,C</code> 都連接到相同的 <code>EndPoints</code>?
按照目前 <code>kubernetes</code> 的設計，上述的答案是在最簡單的網路架構下，只能夠確保 <strong>Host2</strong> 上面所建立的所有 <strong>Connection</strong> 都可以連接到相同的 <strong>Endpoints</strong>.</p><p>這邊假設這些 Host 都有自己的公開 <code>IP</code> 地址，不考慮任何 <code>SNAT</code> 的效果。</p><h1>How It Works</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setup">Setup<a href="#setup" class="hash-link" aria-label="Direct link to Setup" title="Direct link to Setup">​</a></h2><p>接下來，我們繼續使用<a href="https://github.com/hwchiu/kubeDemo" target="_blank" rel="noopener noreferrer">kubeDemo</a>來進行相關的服務部屬以及<code>iptables</code>規則研究。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:01:37:28 [~/go/src/github.com/hwchiu/kubeDemo/services](master)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$kubectl apply -f service/nginx-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-affinity.yml  nginx-cluster.yml   nginx-node.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:01:37:28 [~/go/src/github.com/hwchiu/kubeDemo/services](master)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$kubectl apply -f service/nginx-affinity.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/k8s-nginx-affinity created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我們用下列指令確認一下剛剛部屬的 <code>kubernetes service</code> 是否真的有設定 <code>sessionAffinity</code></p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vortex-dev:01:40:58 [~/go/src/github.com/hwchiu/kubeDemo/services](master)vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$kubectl get service k8s-nginx-affinity -o jsonpath=&#x27;{.spec.sessionAffinity}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClientIP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iptables">IPTABLES<a href="#iptables" class="hash-link" aria-label="Direct link to IPTABLES" title="Direct link to IPTABLES">​</a></h2><p>按照慣例，最簡單的觀察方式就是直接觀察 <code>iptables</code> 的規則，這邊直接透過 <code>k8s-ngins-affinity</code> 這個關鍵字來查詢所有相關的規則</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo iptables-save | grep k8s-nginx-affinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-HDMJEKA4BFKBU6OK -s 10.244.0.145/32 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -j KUBE-MARK-MASQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-HDMJEKA4BFKBU6OK -p tcp -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --set --name KUBE-SEP-HDMJEKA4BFKBU6OK --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.244.0.145:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-Q5HAFBJX4HVXF6EM -s 10.244.0.144/32 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -j KUBE-MARK-MASQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-Q5HAFBJX4HVXF6EM -p tcp -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --set --name KUBE-SEP-Q5HAFBJX4HVXF6EM --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.244.0.144:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-YFKOY7G33LWKGTLC -s 10.244.0.143/32 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -j KUBE-MARK-MASQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-YFKOY7G33LWKGTLC -p tcp -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --set --name KUBE-SEP-YFKOY7G33LWKGTLC --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.244.0.143:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.109.59.245/32 -p tcp -m comment --comment &quot;default/k8s-nginx-affinity: cluster IP&quot; -m tcp --dport 80 -j KUBE-MARK-MASQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SERVICES -d 10.109.59.245/32 -p tcp -m comment --comment &quot;default/k8s-nginx-affinity: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-UBXGHWUUHMMRNNE6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-YFKOY7G33LWKGTLC --mask 255.255.255.255 --rsource -j KUBE-SEP-YFKOY7G33LWKGTLC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-Q5HAFBJX4HVXF6EM --mask 255.255.255.255 --rsource -j KUBE-SEP-Q5HAFBJX4HVXF6EM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-HDMJEKA4BFKBU6OK --mask 255.255.255.255 --rsource -j KUBE-SEP-HDMJEKA4BFKBU6OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-YFKOY7G33LWKGTLC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-Q5HAFBJX4HVXF6EM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -j KUBE-SEP-HDMJEKA4BFKBU6OK</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>稍微看了一下可以發現規則數量變多了，每個 <code>Endpoints</code> 本身多出兩條的規則出來，所以此範例中因為有三個<code>Endpoints</code>，所以總共會多出六條新的規則。</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-HDMJEKA4BFKBU6OK -p tcp -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --set --name KUBE-SEP-HDMJEKA4BFKBU6OK --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.244.0.145:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-Q5HAFBJX4HVXF6EM -p tcp -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --set --name KUBE-SEP-Q5HAFBJX4HVXF6EM --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.244.0.144:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-YFKOY7G33LWKGTLC -p tcp -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --set --name KUBE-SEP-YFKOY7G33LWKGTLC --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.244.0.143:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-YFKOY7G33LWKGTLC --mask 255.255.255.255 --rsource -j KUBE-SEP-YFKOY7G33LWKGTLC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-Q5HAFBJX4HVXF6EM --mask 255.255.255.255 --rsource -j KUBE-SEP-Q5HAFBJX4HVXF6EM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-HDMJEKA4BFKBU6OK --mask 255.255.255.255 --rsource -j KUBE-SEP-HDMJEKA4BFKBU6OK</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在我們開始研究這些規則之前，我們還是要先來問自己一句話
<strong>如果是我們自己來實作這個功能，我們會怎麼實作?</strong></p><p>假設需求就是 <code>ClientIP</code> ，相同來源<code>IP</code>地址所建立的新連線都要分配到相同的 <code>EndPoints</code> 來使用
直覺下，我們可以用類似 <code>Cache</code> 的概念來完成這個功能，其流程如下</p><ol><li>收到新的連線請求, 檢查該來源<code>IP</code>地址是否存在 <code>Cache</code> 中</li><li>若存在，直接使用該 <code>Cache</code> 內關於的目標 <code>Endpoints</code> 來使用</li><li>若不存在，則嘗試從 <code>EndPoints</code> 內挑選出一個目標，並且將結果記錄到 <code>Cache</code> 之中.</li></ol><p>所以可以將該 <code>cache</code> 分成 <code>Read/Wrtie</code> 兩個功能面向來看待，以下圖來表示</p><p><img loading="lazy" src="https://i.imgur.com/r6Yr1eI.png" alt="Imgur" class="img_ev3q"></p><p>上述的流程看起來滿直觀且合理的，但是這些流程在 <code>iptables</code> 的規則中到底要怎麼完成?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="recent-modules">recent modules<a href="#recent-modules" class="hash-link" aria-label="Direct link to recent modules" title="Direct link to recent modules">​</a></h2><p>我們將前面6條新規則縮減到兩條來單獨觀察就好<strong>(因為每個EndPoints會有兩條)</strong></p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-HDMJEKA4BFKBU6OK -p tcp -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --set --name KUBE-SEP-HDMJEKA4BFKBU6OK --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.244.0.145:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-HDMJEKA4BFKBU6OK --mask 255.255.255.255 --rsource -j KUBE-SEP-HDMJEKA4BFKBU6OK</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>為了加深各位的印象並且能夠順利的解讀 <code>ClusterIP</code> 的原理，需要再次複習一下這張圖片，並且確保知道下圖中各個項目的含意。
<img loading="lazy" src="https://i.imgur.com/9amwybH.png" alt="Imgur" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="save">Save<a href="#save" class="hash-link" aria-label="Direct link to Save" title="Direct link to Save">​</a></h3><p>首先我們觀察第一條規則，其位於 <code>KUBE-SEP</code> 這個位置，這個其實就是真正執行 <code>DNAT</code> 的 <code>custom  chain</code>.
這邊做的事情與我們假想的流程完全一致, 當選出欲使用的 <code>Endoints</code> 並進行 <code>DNAT</code> 轉換之時，順便將該結果記錄到 <code>Cache</code> 內。
<strong>若不存在，則嘗試從 <code>EndPoints</code> 內挑選出一個目標，並且將結果記錄到 <code>Cache</code> 之中.</strong></p><p>我們來仔細看一下這條規則</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SEP-HDMJEKA4BFKBU6OK -p tcp -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --set --name KUBE-SEP-HDMJEKA4BFKBU6OK --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.244.0.145:80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>裡面新增加的部份則是</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-m recent --set --name KUBE-SEP-HDMJEKA4BFKBU6OK --mask 255.255.255.255 --rsource</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊我們要介紹一個新的 <code>iptables</code> 的擴充模組 <strong>recent</strong>. 但是礙於篇幅沒有辦法詳細介紹其所有用法以及原理。
我們可以將 <code>recent</code> 想成他提供一個簡單的類似 <code>key/value</code> 的 <code>cache</code> 機制，同時支援 <strong>Read/Write</strong> 等操作來存取該 <code>Cache</code>.</p><p>這邊就針對這參數進行一個簡單的介紹</p><ol><li>-m recent: 使用擴充模組 <code>recent</code></li><li>--set: 這次的行為想要進行儲存的動作，將某些 <code>key/value</code> 寫進到 <code>recent cache</code> 內</li><li>--name KUBE-SEP-XXXXXXXX: 這邊對應的就是存到 <code>cache</code> 內的 <code>Value</code>.</li><li>--mask 255.255.255.255: 這個搭配下一個參數使用</li><li>--rsource: 這邊代表是的我要用什麼當做 <code>key</code>, 這邊使用的是 <code>souruce</code> 就是所謂的封包來源<code>IP</code>地址,既然有<code>IP</code>地址，就可以搭配前面的<code>mask</code>來調整<code>IP</code>位址的範圍，這個範例中就是<strong>/32</strong>的設定，意味<code>IP</code>要完全一樣才行。</li></ol><p>所以歸納一下，若今天已經選定了一個<code>Endpoints</code>要來使用，首先會先跳到屬於該 <code>Endpoints</code> 專屬於的 <code>custom chani</code> <strong>KUBE-SEP-HDMJEKA4BFKBU6OK</strong>.
在進行 <code>DNAT</code> 之前，會先透過 <code>recent cache</code> 的方式去紀錄下列的對映關係</p><p><strong>[來源IP地址]<!-- --> =&gt; KUBE-SEP-HDMJEKA4BFKBU6OK</strong></p><p>將上述的概念重新整理，目前的已知拼圖如下</p><p><img loading="lazy" src="https://i.imgur.com/p9Cff8e.png" alt="Imgur" class="img_ev3q"></p><p>另外，之前有提到過 <code>iptables</code> 的每個指令都是<code>符合特定規則</code>，執行<code>特定行為</code>.
所以其實 <code>recent</code> 模組內關於 <code>Set/Write</code> 相關的操作永遠都是回傳<code>符合</code>，讓上層的規則可以繼續往下執行。
畢竟針對 <code>Set/Write</code> 這類型操作本身就沒有要比對任何東西，只是被拿來進行其他的操作而已。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="read">Read<a href="#read" class="hash-link" aria-label="Direct link to Read" title="Direct link to Read">​</a></h3><p>看完了第一題規則後，接下來來看一下最後一條，其實也就是第二條規則</p><div class="language-bash= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-A KUBE-SVC-UBXGHWUUHMMRNNE6 -m comment --comment &quot;default/k8s-nginx-affinity:&quot; -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-HDMJEKA4BFKBU6OK --mask 255.255.255.255 --rsource -j KUBE-SEP-HDMJEKA4BFKBU6OK</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這條規則其實就是 <code>Cache</code> 裡面關於 <code>Read</code> 的操作，但是這邊有一個點要注意，因為 <code>iptables</code> 的規則就是一條一條根據<code>比對條件</code>來判斷要不要執行<code>特定行為</code>.
所以這邊沒有辦法用程式化的方式去從 <code>Cache</code> 裡面取得對應的 <code>EndPoints</code> 名稱。</p><p>我們先記住，該 <code>recent</code> 提供的方式是詢問請問該<code>Key</code>有沒有資料，有的話是不是這個<code>Value</code>。
在這種情況下，我們可以想像一下其運作原理。</p><p>針對每一條 <code>KUBE-SVC-XXX</code> 裡面的規則，依序每個 <code>EndPoints</code> 執行下列操作</p><ol><li>請問<code>Cachue</code>裡面有沒有 <code>來源IP位址</code> =&gt; <code>當前EndPoints</code> 的紀錄? 有的話就直接跳到對應的 <code>Endooints</code> 的<code>custom chain</code>去執行<code>DNAT</code>.</li><li>如果沒有的話，嘗試第二個 <code>Endpoints</code></li><li>所有的 <code>Endpoints</code> 嘗試後都沒有結果，那就透過機率的方式選擇一個可用的 <code>Endpoints</code></li></ol><p>有了這些概念後，我們從參數的部分來直接看一下 <code>iptables</code> 實際上的下法</p><ol><li>-m:recent 使用擴充模組 <code>recent</code></li><li>--rcheck: 這邊我們執行 <code>READ</code> 的指令，要檢查 <code>cache</code> 內是否有對應的 <code>key/value</code></li><li>--name: <code>value</code>, 就是 <code>Endpoints</code> 對應到的 <code>custom-chain name</code></li><li>--rsouce/--mask: <code>key</code>, 封包的來源 <code>IP</code></li><li>--seconds: 每個 <code>cache</code> 內的記錄都會有一個過期的時間，這個時間的意思是只有上次設定該 <code>ket/value</code> 的時間距離現在<code>N</code>秒內的才算數，已這個範例來說就是 <code>10800秒</code> 內的 <code>cache</code> 記錄才算數，如果是超過 <code>10800秒</code> 前記錄的，就當失效。</li><li>--reap: 這個是指每次查詢的時候，會將已經超過<code>有效時間</code> 的規則一併清除。</li></ol><p>把這整個流程全部重新組合後，我們用下面的這張圖來描述關於整個 <code>SessionAffinity</code> 的概念與實作
<code>seconds</code> 相關的概念我就沒有加入到該圖片中了，因為篇幅有限，針對主要觀念去描述即可。</p><p><img loading="lazy" src="https://i.imgur.com/bKvZgw4.png" alt="Imgur" class="img_ev3q"></p><h1>Summary</h1><p>看到這邊，我們大概瞭解如何透過 <code>iptables</code> 的功能來達成 <code>SessionAffinity:ClientIP</code> 的功能，透過 <code>iptables</code> 的擴充模組 <code>recent</code> 提供類似 <code>key/value</code> 的 <code>cache</code> 機制來紀錄 <code>來源IP地址</code> 與 <code>Endpoints</code> 的關係。</p><p>如果對於 <code>iptables</code> 擴充模組有興趣的讀者，之後我會撰寫一些文章介紹 <code>iptables</code> 的架構以及如何自己撰寫一個 <code>iptables</code> 的擴充模組。</p><p>最後我們將本篇文章所學的概念與一直以來使用的關係圖給整合起來，當設定 <code>SessionAffinity</code> 時，我們會在<code>KUBE-SVC</code> 嘗試透過 <code>Recent/Cache</code> 的方式找到是否有使用過的 <code>Endpoints</code>
之後再真正執行 <code>DNAT</code> 的 <code>KUBE-SEP-XXXX</code> 時會不停的更新 <code>Recent/Cache</code> 內的資料以及時間，避免該筆資料過期。</p><p><img loading="lazy" src="https://i.imgur.com/NP5xsGg.png" alt="Imgur" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">Linux</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/iptables">iptables</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/network">Network</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/techPost/2018/kubernetes-service-iii"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">[Kubernetes] How to Implement Kubernetes Service - NodePort</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/techPost/2018/kubernetes-storage-i"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Kubernetes X Storage (I)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#setup" class="table-of-contents__link toc-highlight">Setup</a></li><li><a href="#iptables" class="table-of-contents__link toc-highlight">IPTABLES</a></li><li><a href="#recent-modules" class="table-of-contents__link toc-highlight">recent modules</a><ul><li><a href="#save" class="table-of-contents__link toc-highlight">Save</a></li><li><a href="#read" class="table-of-contents__link toc-highlight">Read</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">其他資源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hwchiu.medium.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文部落格<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/technologynoteniu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook Page(矽谷牛耕田筆記)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/hw_chiu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/hung-wei-chiu-52561494/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Cloud Native Taiwan User Group(CNTUG)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@cloudnativetaiwanusergroup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/groups/298183320685010" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/cloud-native-taiwan-user-group/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 hwchiu. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.66f04512.js"></script>
<script src="/assets/js/main.65098930.js"></script>
</body>
</html>