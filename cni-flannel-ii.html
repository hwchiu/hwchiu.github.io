<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0-rc1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.hwchiu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本篇文章針對 flannel 如何管理 IP 地址的事情進行探討與研究，許多人初次使用 kubeadm 安裝 flannel 的時候都曾經因為忘記加上 --pod-net-cidr 等參數導致安裝失敗，而這篇文章就會來探討這個參數的意義，為什麼需要這個參數，同時搭配前述已經分享過的 IPAM 管理，來重新仔細觀察 flannel 的運作過程">
<meta property="og:type" content="article">
<meta property="og:title" content="CNI - Flannel - IP 管理篇">
<meta property="og:url" content="https://www.hwchiu.com/cni-flannel-ii.html">
<meta property="og:site_name" content="Hwchiu Learning Note">
<meta property="og:description" content="本篇文章針對 flannel 如何管理 IP 地址的事情進行探討與研究，許多人初次使用 kubeadm 安裝 flannel 的時候都曾經因為忘記加上 --pod-net-cidr 等參數導致安裝失敗，而這篇文章就會來探討這個參數的意義，為什麼需要這個參數，同時搭配前述已經分享過的 IPAM 管理，來重新仔細觀察 flannel 的運作過程">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/HHKDtsL.png">
<meta property="article:published_time" content="2019-09-29T20:44:27.000Z">
<meta property="article:modified_time" content="2023-06-23T05:16:12.605Z">
<meta property="article:author" content="Hwchiu">
<meta property="article:tag" content="Network">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="CNI">
<meta property="article:tag" content="Flannel">
<meta property="article:tag" content="ITHOME">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/HHKDtsL.png">


<link rel="canonical" href="https://www.hwchiu.com/cni-flannel-ii.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.hwchiu.com/cni-flannel-ii.html","path":"cni-flannel-ii.html","title":"CNI - Flannel - IP 管理篇"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CNI - Flannel - IP 管理篇 | Hwchiu Learning Note</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-54006186-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-54006186-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hwchiu Learning Note</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">kubernetes, sdn, linux,devops</p>
      <img class="custom-logo-image" src="/uploads/hwchiu.jpg" alt="Hwchiu Learning Note">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%92%B0%E5%A2%83%E5%BB%BA%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">環境建置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubeadm"><span class="nav-number">3.</span> <span class="nav-text">Kubeadm</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Workflow"><span class="nav-number">3.1.</span> <span class="nav-text">Workflow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubeadm"><span class="nav-number">3.2.</span> <span class="nav-text">kubeadm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod-Flannel"><span class="nav-number">3.3.</span> <span class="nav-text">Pod Flannel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CNI-Flannel"><span class="nav-number">3.4.</span> <span class="nav-text">CNI Flannel</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary"><span class="nav-number">4.</span> <span class="nav-text">Summary</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%83%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">參考</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%80%8B%E4%BA%BA%E8%B3%87%E8%A8%8A"><span class="nav-number">6.</span> <span class="nav-text">個人資訊</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hwchiu"
      src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">Hwchiu</p>
  <div class="site-description" itemprop="description">kubernetes/SDN/DevOps</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">344</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">115</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hwchiu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hwchiu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:sppsorrg@gmail.com" title="E-Mail → mailto:sppsorrg@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/hw_chiu" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;hw_chiu" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/technologynoteniu" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;technologynoteniu" rel="noopener me" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/channel/UCoYY8K9fbfDtTY7m68UCATA/videos" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCoYY8K9fbfDtTY7m68UCATA&#x2F;videos" rel="noopener me" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/hwchiu" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;hwchiu" rel="noopener me" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.hwchiu.com/cni-flannel-ii.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="Hwchiu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hwchiu Learning Note">
      <meta itemprop="description" content="kubernetes/SDN/DevOps">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="CNI - Flannel - IP 管理篇 | Hwchiu Learning Note">
      <meta itemprop="description" content="本篇文章針對 flannel 如何管理 IP 地址的事情進行探討與研究，許多人初次使用 kubeadm 安裝 flannel 的時候都曾經因為忘記加上 --pod-net-cidr 等參數導致安裝失敗，而這篇文章就會來探討這個參數的意義，為什麼需要這個參數，同時搭配前述已經分享過的 IPAM 管理，來重新仔細觀察 flannel 的運作過程">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CNI - Flannel - IP 管理篇
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-30 04:44:27" itemprop="dateCreated datePublished" datetime="2019-09-30T04:44:27+08:00">2019-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-23 13:16:12" itemprop="dateModified" datetime="2023-06-23T13:16:12+08:00">2023-06-23</time>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">本篇文章針對 flannel 如何管理 IP 地址的事情進行探討與研究，許多人初次使用 kubeadm 安裝 flannel 的時候都曾經因為忘記加上 --pod-net-cidr 等參數導致安裝失敗，而這篇文章就會來探討這個參數的意義，為什麼需要這個參數，同時搭配前述已經分享過的 IPAM 管理，來重新仔細觀察 flannel 的運作過程</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前篇文章我們探討了 <strong>flannel</strong> 的安裝過程，包含了相關的 <strong>RBAC&#x2F;PSP</strong> 安全性設定，放置相關設定檔案的 <strong>ConfigMap</strong> 以及最後運行整個運算邏輯的 <strong>DaemonSet</strong>。</p>
<p>接下來本篇文章將來探討 <strong>flannel</strong> 是怎麼處理 <strong>IP</strong>分配的問題。</p>
<h1 id="環境建置"><a href="#環境建置" class="headerlink" title="環境建置"></a>環境建置</h1><p>為了搭建一個擁有三個節點的 kubernetes cluster，我認為直接使用 <strong>kubernetes-dind-cluster</strong> 是個滿不錯的選擇，可以快速搭建環境，又有多節點。</p>
<p>或是也可以土法煉鋼繼續使用 <strong>kubeadm</strong> 的方式創建多節點的 kubernetes cluster， 這部分並沒有特別規定，總之能搭建起來即可。</p>
<p>此外相關的版本資訊方面</p>
<ul>
<li>kubernetes version:v1.15.4</li>
<li>flannel: 使用<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml">官方安裝 Yaml</a></li>
<li>kubeadm 安裝過程使用的參數 <strong>–pod-network-cidr&#x3D;10.244.0.0&#x2F;16</strong></li>
</ul>
<h1 id="Kubeadm"><a href="#Kubeadm" class="headerlink" title="Kubeadm"></a>Kubeadm</h1><p>所有使用 <strong>kubeadm</strong> 安裝過 <strong>flannel</strong> 都遇過需要設定 <strong>–pod-network-cidr</strong> 的情況，但是到底這個參數背後做了什麼，以及為什麼 <strong>flannel</strong> 會需要這個參數? 接下來就來研究一下</p>
<h2 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h2><p>直接先講結論，從結論講起再來講流程會比較清楚。</p>
<ol>
<li><strong>kubernetes</strong> 會針對每個 <strong>node</strong> 去標示一個名為 <strong>PodCIDR</strong> 的值，代表該 <strong>Node</strong> 可以使用的網段是什麼，</li>
<li><strong>flannel</strong> 的 Pod 會去讀取該資訊，並且將該資訊寫道 <strong>&#x2F;run&#x2F;flannel&#x2F;subnet.env</strong> 的這個檔案中</li>
<li><strong>flannel CNI</strong> 收到任何創建 <strong>Pod</strong> 的請求時，會去讀取 <strong>&#x2F;run&#x2F;flannel&#x2F;subnet.env</strong> 的資訊，並且將其內容轉換最後呼叫 <strong>host-local</strong> 這隻 <strong>IPAM CNI</strong>，來取得可以用的 <strong>IP</strong> 並且設定到 <strong>POD</strong> 身上</li>
</ol>
<p>相關檔案驗證</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe nodes | grep PodCIDR</span><br><span class="line">PodCIDR:                     10.244.0.0/24</span><br><span class="line">PodCIDR:                     10.244.1.0/24</span><br><span class="line">PodCIDR:                     10.244.2.0/24</span><br><span class="line"></span><br><span class="line">$ sudo <span class="built_in">cat</span> /run/flannel/subnet.env</span><br><span class="line">FLANNEL_NETWORK=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.0.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">$ sudo <span class="built_in">ls</span> /var/lib/cni/networks/cbr0</span><br><span class="line">10.244.0.2  10.244.0.3  10.244.0.8  last_reserved_ip.0  lock</span><br><span class="line"></span><br><span class="line">$ sudo <span class="built_in">cat</span> /var/lib/cni/networks/cbr0/10.244.0.8</span><br><span class="line">2d39d5afb81e56314a7fd6bdd57c9ccf6d02c32b556273cfb6b9bb8a248c851b</span><br><span class="line"></span><br><span class="line">$ sudo docker ps  --no-trunc | grep $(sudo <span class="built_in">cat</span> /var/lib/cni/networks/cbr0/10.244.0.8)</span><br><span class="line">2d39d5afb81e56314a7fd6bdd57c9ccf6d02c32b556273cfb6b9bb8a248c851b   k8s.gcr.io/pause:3.1 <span class="string">&quot;/pause&quot;</span> Up 4 hours  k8s_POD_k8s-udpserver-6576555bcb-7h8jh_default_87196597-ccda-4643-ac5d-85343a3b6c90_0</span><br></pre></td></tr></table></figure>

<p>先根據上面的指令解釋一下每個的含義，接下來再來研究其流程</p>
<ol>
<li>透過 <strong>kubectl describe node</strong> 可以觀察到每個節點上都有一個 <strong>PodCIDR</strong> 的欄位，代表的是該節點可以使用的網段</li>
<li>由於我的節點是對應到的 <strong>PodCIDR</strong> 是 <strong>10.244.0.0&#x2F;24</strong>，接下來去觀察  <strong>&#x2F;run&#x2F;flannel&#x2F;subnet.env</strong>，確認裡面的數值一致。</li>
<li>接下來由於我的系統上有跑過一些 <strong>Pod</strong>，這些 <strong>Pod</strong> 形成的過程中會呼叫 <strong>flannel CNI</strong> 來處理，而該 <strong>CNI</strong> 最後會再輾轉呼叫 <strong>host-local IPAM CNI</strong> 來處理，所以就會在這邊看到有 <strong>host-local</strong> 的產物</li>
<li>由於前篇介紹 <strong>IPAM</strong> 的文章有介紹過 <strong>host-local</strong> 的運作，該檔案的內容則是對應的 <strong>CONTAINER_ID</strong>，因此這邊得到的也是 <strong>CONTAINER_ID</strong></li>
<li>最後則是透過 <strong>docker</strong> 指令去尋該 <strong>CONTAINER_ID</strong>，最後就看到對應到的不是真正運行的 <strong>Pod</strong>，而是先前介紹過的 <strong>Infrastructure Container: Pause</strong></li>
</ol>
<p>接下來就是細談上述的流程</p>
<h2 id="kubeadm"><a href="#kubeadm" class="headerlink" title="kubeadm"></a>kubeadm</h2><p>首先是 <strong>kubeadm</strong> 與 <strong>controller-manager</strong> 兩者的關係，當我們透過 <strong>–pod-network-cidr</strong> 去初始化 <strong>kubeadm</strong> 後，其創造出來的 <strong>controller-manager</strong> 就會自帶三個參數</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root     20459  0.8  2.4 217504 100076 ?       Ssl  05:22   0:36 kube-controller-manager</span><br><span class="line">--authentication-kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">--authorization-kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">--bind-address=127.0.0.1</span><br><span class="line">--client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">--cluster-cidr=10.244.0.0/16</span><br><span class="line">--node-cidr-mask-size=24</span><br><span class="line">--allocate-node-cidrs=<span class="literal">true</span></span><br><span class="line">--cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">--cluster-signing-key-file=/etc/kubernetes/pki/ca.key</span><br><span class="line">--controllers=*,bootstrapsigner,tokencleaner</span><br><span class="line">--kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">--leader-elect=<span class="literal">true</span></span><br><span class="line">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">--root-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">--service-account-private-key-file=/etc/kubernetes/pki/sa.key</span><br><span class="line">--use-service-account-credentials=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>裡面的參數過多，直接挑出重點就是</p>
<ul>
<li>–cluster-cidr&#x3D;10.244.0.0&#x2F;16</li>
<li>–allocate-node-cidrs&#x3D;true</li>
<li>–node-cidr-mask-size&#x3D;24</li>
</ul>
<p>這邊就標明的整個 <strong>cluster network</strong> 會使用的網段，除了 <strong>cidr</strong> 大網段之外還透過 <strong>node-cide–mask</strong> 去標示寫網段，所以根據上述的範例，這個節點的數量不能超過255台節點，不然就沒有足夠的 <strong>可用網段</strong>去分配了。</p>
<p>此外很有趣的一點是，這邊的運作邏輯再 <strong>controller-manager</strong> 內被稱為 <strong>nodeipam</strong>，也就是今天 <strong>kubernetes</strong> 自己跳下來幫忙做 <strong>IPAM</strong> 的工作，幫忙分配 <strong>IP&#x2F;Subnet</strong>，只是單位是以 <strong>Node</strong> 為基準，不是以 <strong>Pod</strong>。</p>
<p>根據 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/103e926604de6f79161b78af3e792d0ed282bc06/pkg/controller/nodeipam/ipam/controller_legacyprovider.go#L65">GitHub Controler</a> 可以看到當 <strong>Controller Manager</strong> 物件被創造的時候會根據上述的參數去產生一個名為 <strong>cidrset</strong> 的物件</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line">set, err := cidrset.NewCIDRSet(clusterCIDR, nodeCIDRMaskSize)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>而 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/a3ccea9d8743f2ff82e41b6c2af6dc2c41dc7b10/pkg/controller/nodeipam/ipam/cidrset/cidr_set.go#L31">CIDRSet</a> 的結構如下</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CidrSet <span class="keyword">struct</span> &#123;</span><br><span class="line">	sync.Mutex</span><br><span class="line">	clusterCIDR     *net.IPNet</span><br><span class="line">	clusterIP       net.IP</span><br><span class="line">	clusterMaskSize <span class="type">int</span></span><br><span class="line">	maxCIDRs        <span class="type">int</span></span><br><span class="line">	nextCandidate   <span class="type">int</span></span><br><span class="line">	used            big.Int</span><br><span class="line">	subNetMaskSize  <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基本上就是定義了 <strong>subnet</strong> 相關的所有變數，接下來裡面有一個函式叫做 <strong>allocateRange</strong>，顧名思義就是要出一塊可以用的網段</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/a3ccea9d8743f2ff82e41b6c2af6dc2c41dc7b10/pkg/controller/nodeipam/ipam/sync/sync.go#L314"></a></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(op *updateOp)</span></span> allocateRange(ctx context.Context, sync *NodeSync, node *v1.Node) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> sync.mode != SyncFromCluster &#123;</span><br><span class="line">		sync.kubeAPI.EmitNodeWarningEvent(node.Name, InvalidModeEvent,</span><br><span class="line">			<span class="string">&quot;Cannot allocate CIDRs in mode %q&quot;</span>, sync.mode)</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;controller cannot allocate CIDRS in mode %q&quot;</span>, sync.mode)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cidrRange, err := sync.set.AllocateNext()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If addAlias returns a hard error, cidrRange will be leaked as there</span></span><br><span class="line">	<span class="comment">// is no durable record of the range. The missing space will be</span></span><br><span class="line">	<span class="comment">// recovered on the next restart of the controller.</span></span><br><span class="line">	<span class="keyword">if</span> err := sync.cloudAlias.AddAlias(ctx, node.Name, cidrRange); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Errorf(<span class="string">&quot;Could not add alias %v for node %q: %v&quot;</span>, cidrRange, node.Name, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := sync.kubeAPI.UpdateNodePodCIDR(ctx, node, cidrRange); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Errorf(<span class="string">&quot;Could not update node %q PodCIDR to %v: %v&quot;</span>, node.Name, cidrRange, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := sync.kubeAPI.UpdateNodeNetworkUnavailable(node.Name, <span class="literal">false</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Errorf(<span class="string">&quot;Could not update node NetworkUnavailable status to false: %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;Allocated PodCIDR %v for node %q&quot;</span>, cidrRange, node.Name)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>裡面最重要的就是呼叫 <strong>UpdateNodePodCIDR</strong> 這個函式來進行最後的更新</p>
<p>根據其<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/103e926604de6f79161b78af3e792d0ed282bc06/pkg/controller/nodeipam/ipam/adapter.go#L94">原始碼</a></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *adapter)</span></span> UpdateNodePodCIDR(ctx context.Context, node *v1.Node, cidrRange *net.IPNet) <span class="type">error</span> &#123;</span><br><span class="line">	patch := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;apiVersion&quot;</span>: node.APIVersion,</span><br><span class="line">		<span class="string">&quot;kind&quot;</span>:       node.Kind,</span><br><span class="line">		<span class="string">&quot;metadata&quot;</span>:   <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: node.Name&#125;,</span><br><span class="line">		<span class="string">&quot;spec&quot;</span>:       <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;podCIDR&quot;</span>: cidrRange.String()&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	bytes, err := json.Marshal(patch)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_, err = a.k8s.CoreV1().Nodes().Patch(node.Name, types.StrategicMergePatchType, bytes)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到最後會在 <strong>spec</strong>下面產生一個名稱為 <strong>podCIDR</strong> 的內容，且其數值就是分配後的網段(cidrRange.String())。</p>
<p>這部分可以透過 <strong>kubectl get nodes xxxx -o yaml</strong> 來驗證</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes k8s-dev -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Node</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    flannel.alpha.coreos.com/backend-data: <span class="string">&#x27;&#123;&quot;VtepMAC&quot;:&quot;3e:94:52:9b:7e:d9&quot;&#125;&#x27;</span></span><br><span class="line">    flannel.alpha.coreos.com/backend-type: vxlan</span><br><span class="line">    flannel.alpha.coreos.com/kube-subnet-manager: <span class="string">&quot;true&quot;</span></span><br><span class="line">    flannel.alpha.coreos.com/public-ip: 10.0.2.15</span><br><span class="line">    kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock</span><br><span class="line">    node.alpha.kubernetes.io/ttl: <span class="string">&quot;0&quot;</span></span><br><span class="line">    volumes.kubernetes.io/controller-managed-attach-detach: <span class="string">&quot;true&quot;</span></span><br><span class="line">  creationTimestamp: <span class="string">&quot;2019-09-23T05:21:46Z&quot;</span></span><br><span class="line">  labels:</span><br><span class="line">    beta.kubernetes.io/arch: amd64</span><br><span class="line">    beta.kubernetes.io/os: linux</span><br><span class="line">    kubernetes.io/arch: amd64</span><br><span class="line">    kubernetes.io/hostname: k8s-dev</span><br><span class="line">    kubernetes.io/os: linux</span><br><span class="line">    node-role.kubernetes.io/master: <span class="string">&quot;&quot;</span></span><br><span class="line">  name: k8s-dev</span><br><span class="line">  resourceVersion: <span class="string">&quot;57899&quot;</span></span><br><span class="line">  selfLink: /api/v1/nodes/k8s-dev</span><br><span class="line">  uid: cd8fadc0-e58c-4509-9056-3a06bdb8440f</span><br><span class="line">spec:</span><br><span class="line">  podCIDR: 10.244.0.0/24</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="Pod-Flannel"><a href="#Pod-Flannel" class="headerlink" title="Pod Flannel"></a>Pod Flannel</h2><p>鏡頭一轉，我們來看當 <strong>flannel</strong> 部署的 <strong>Pod</strong> 運行起來後會做什麼事情。<br>前文有提過，預設的安裝設定檔案中會使得 <strong>flannel</strong> 使用 <strong>kubernetes API</strong> 來存取資訊，這同時也意味其 <strong>subnet manager</strong> 會使用 <strong>kubernetes API</strong> 來完成，這部分的程式碼都在<a target="_blank" rel="noopener" href="https://github.com/coreos/flannel/tree/master/subnet/kube">這</a></p>
<p>其中要特別注意的一個函式<a target="_blank" rel="noopener" href="https://github.com/coreos/flannel/blob/master/subnet/kube/kube.go#L222">AcquireLease</a><br>可以看到裡面嘗試針對 <strong>node</strong> 底下的 <strong>sped.PodCIDR</strong> 去存取，並且透過 <strong>net.ParseCIDR</strong> 的方式去解讀。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">	<span class="keyword">if</span> n.Spec.PodCIDR == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;node %q pod cidr not assigned&quot;</span>, ksm.nodeName)</span><br><span class="line">	&#125;</span><br><span class="line">	bd, err := attrs.BackendData.MarshalJSON()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	_, cidr, err := net.ParseCIDR(n.Spec.PodCIDR)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


<p>接下來於主要的 <strong>main.go</strong> 這邊會在呼叫 <strong>WriteSubnetFile</strong> 把相關的結果寫到檔案內，最後大家就可以到 <strong>&#x2F;run&#x2F;flannel&#x2F;subnet.env</strong> 去得到相關資訊。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteSubnetFile</span><span class="params">(path <span class="type">string</span>, nw ip.IP4Net, ipMasq <span class="type">bool</span>, bn backend.Network)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	dir, name := filepath.Split(path)</span><br><span class="line">	os.MkdirAll(dir, <span class="number">0755</span>)</span><br><span class="line"></span><br><span class="line">	tempFile := filepath.Join(dir, <span class="string">&quot;.&quot;</span>+name)</span><br><span class="line">	f, err := os.Create(tempFile)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Write out the first usable IP by incrementing</span></span><br><span class="line">	<span class="comment">// sn.IP by one</span></span><br><span class="line">	sn := bn.Lease().Subnet</span><br><span class="line">	sn.IP += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	fmt.Fprintf(f, <span class="string">&quot;FLANNEL_NETWORK=%s\n&quot;</span>, nw)</span><br><span class="line">	fmt.Fprintf(f, <span class="string">&quot;FLANNEL_SUBNET=%s\n&quot;</span>, sn)</span><br><span class="line">	fmt.Fprintf(f, <span class="string">&quot;FLANNEL_MTU=%d\n&quot;</span>, bn.MTU())</span><br><span class="line">	_, err = fmt.Fprintf(f, <span class="string">&quot;FLANNEL_IPMASQ=%v\n&quot;</span>, ipMasq)</span><br><span class="line">	f.Close()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// rename(2) the temporary file to the desired location so that it becomes</span></span><br><span class="line">	<span class="comment">// atomically visible with the contents</span></span><br><span class="line">	<span class="keyword">return</span> os.Rename(tempFile, path)</span><br><span class="line">	<span class="comment">//TODO - is this safe? What if it&#x27;s not on the same FS?</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CNI-Flannel"><a href="#CNI-Flannel" class="headerlink" title="CNI Flannel"></a>CNI Flannel</h2><p>話題一轉，我們來看最後一個步驟，當 <strong>CRI</strong> 決定創建 <strong>POD</strong> 並且準備好相關環參數呼叫 <strong>CNI</strong> 後的運作。</p>
<p>這邊要額外提醒， <strong>flannel</strong> 的程式碼分兩的地方存放</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/coreos/flannel">CoreOS - Pod</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins/tree/master/plugins/meta/flannel">ContainetNetworking - CNI</a></li>
</ol>
<p>同時這也可以解釋為什麼一開始安裝好 <strong>kubernetes</strong> 後，系統內就有 <strong>flannel CNI</strong> 的執行檔案了，因為被放在官方的 <strong>repo</strong> 裡面。</p>
<p>我們先來看創建 <strong>POD</strong> 的時候 <strong>Flannel CNI</strong> 會做的<a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins/blob/master/plugins/meta/flannel/flannel.go#L186-L216">事情</a></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	defaultSubnetFile = <span class="string">&quot;/run/flannel/subnet.env&quot;</span></span><br><span class="line">	defaultDataDir    = <span class="string">&quot;/var/lib/cni/flannel&quot;</span></span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cmdAdd</span><span class="params">(args *skel.CmdArgs)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	n, err := loadFlannelNetConf(args.StdinData)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fenv, err := loadFlannelSubnetEnv(n.SubnetFile)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> n.Delegate == <span class="literal">nil</span> &#123;</span><br><span class="line">		n.Delegate = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> hasKey(n.Delegate, <span class="string">&quot;type&quot;</span>) &amp;&amp; !isString(n.Delegate[<span class="string">&quot;type&quot;</span>]) &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;&#x27;delegate&#x27; dictionary, if present, must have (string) &#x27;type&#x27; field&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> hasKey(n.Delegate, <span class="string">&quot;name&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;&#x27;delegate&#x27; dictionary must not have &#x27;name&#x27; field, it&#x27;ll be set by flannel&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> hasKey(n.Delegate, <span class="string">&quot;ipam&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;&#x27;delegate&#x27; dictionary must not have &#x27;ipam&#x27; field, it&#x27;ll be set by flannel&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> n.RuntimeConfig != <span class="literal">nil</span> &#123;</span><br><span class="line">		n.Delegate[<span class="string">&quot;runtimeConfig&quot;</span>] = n.RuntimeConfig</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> doCmdAdd(args, n, fenv)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有個常見且習慣的名稱 <strong>cmdAdd</strong>，裡面可以看到呼叫了 <strong>loadFlannelSubnetEnv</strong>，其中若使用者沒有特別設定的話，預設的 <strong>SubnetFile</strong> 就是 <strong>defaultSubnetFile</strong>，如上面示，其值為 <strong>&#x2F;run&#x2F;flannel&#x2F;subnet.env</strong>。</p>
<p>接者該<a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins/blob/master/plugins/meta/flannel/flannel.go#L186-L216">函式</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">func loadFlannelSubnetEnv(fn string) (*subnetEnv, error) &#123;</span><br><span class="line">	f, err := os.Open(fn)</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		<span class="built_in">return</span> nil, err</span><br><span class="line">	&#125;</span><br><span class="line">	defer f.Close()</span><br><span class="line"></span><br><span class="line">	se := &amp;subnetEnv&#123;&#125;</span><br><span class="line"></span><br><span class="line">	s := bufio.NewScanner(f)</span><br><span class="line">	<span class="keyword">for</span> s.<span class="function"><span class="title">Scan</span></span>() &#123;</span><br><span class="line">		parts := strings.SplitN(s.Text(), <span class="string">&quot;=&quot;</span>, 2)</span><br><span class="line">		switch parts[0] &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;FLANNEL_NETWORK&quot;</span>:</span><br><span class="line">			_, se.nw, err = net.ParseCIDR(parts[1])</span><br><span class="line">			<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">				<span class="built_in">return</span> nil, err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;FLANNEL_SUBNET&quot;</span>:</span><br><span class="line">			_, se.sn, err = net.ParseCIDR(parts[1])</span><br><span class="line">			<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">				<span class="built_in">return</span> nil, err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;FLANNEL_MTU&quot;</span>:</span><br><span class="line">			mtu, err := strconv.ParseUint(parts[1], 10, 32)</span><br><span class="line">			<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">				<span class="built_in">return</span> nil, err</span><br><span class="line">			&#125;</span><br><span class="line">			se.mtu = new(uint)</span><br><span class="line">			*se.mtu = uint(mtu)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;FLANNEL_IPMASQ&quot;</span>:</span><br><span class="line">			ipmasq := parts[1] == <span class="string">&quot;true&quot;</span></span><br><span class="line">			se.ipmasq = &amp;ipmasq</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := s.Err(); err != nil &#123;</span><br><span class="line">		<span class="built_in">return</span> nil, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> m := se.missing(); m != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="built_in">return</span> nil, fmt.Errorf(<span class="string">&quot;%v is missing %v&quot;</span>, fn, m)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">return</span> se, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就會去讀取該檔案，並且整理成一個 <strong>subnetEnv</strong> 的物件格式，一切都處理完畢後，就會透過 <strong>CNI</strong> 內建的函式去呼叫其他的 <strong>CNI</strong> 來處理</p>
<p>可以再<a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins/blob/master/plugins/meta/flannel/flannel_linux.go#L31">doCmdAdd</a> 這個函式看到最後塞了一個 <strong>ipam</strong> 的字典資訊進去，然後裡面設定了 <strong>host-local</strong> 會用到的所有參數。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doCmdAdd</span><span class="params">(args *skel.CmdArgs, n *NetConf, fenv *subnetEnv)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	n.Delegate[<span class="string">&quot;name&quot;</span>] = n.Name</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !hasKey(n.Delegate, <span class="string">&quot;type&quot;</span>) &#123;</span><br><span class="line">		n.Delegate[<span class="string">&quot;type&quot;</span>] = <span class="string">&quot;bridge&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !hasKey(n.Delegate, <span class="string">&quot;ipMasq&quot;</span>) &#123;</span><br><span class="line">		<span class="comment">// if flannel is not doing ipmasq, we should</span></span><br><span class="line">		ipmasq := !*fenv.ipmasq</span><br><span class="line">		n.Delegate[<span class="string">&quot;ipMasq&quot;</span>] = ipmasq</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !hasKey(n.Delegate, <span class="string">&quot;mtu&quot;</span>) &#123;</span><br><span class="line">		mtu := fenv.mtu</span><br><span class="line">		n.Delegate[<span class="string">&quot;mtu&quot;</span>] = mtu</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> n.Delegate[<span class="string">&quot;type&quot;</span>].(<span class="type">string</span>) == <span class="string">&quot;bridge&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> !hasKey(n.Delegate, <span class="string">&quot;isGateway&quot;</span>) &#123;</span><br><span class="line">			n.Delegate[<span class="string">&quot;isGateway&quot;</span>] = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> n.CNIVersion != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		n.Delegate[<span class="string">&quot;cniVersion&quot;</span>] = n.CNIVersion</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	n.Delegate[<span class="string">&quot;ipam&quot;</span>] = <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;type&quot;</span>:   <span class="string">&quot;host-local&quot;</span>,</span><br><span class="line">		<span class="string">&quot;subnet&quot;</span>: fenv.sn.String(),</span><br><span class="line">		<span class="string">&quot;routes&quot;</span>: []types.Route&#123;</span><br><span class="line">			&#123;</span><br><span class="line">				Dst: *fenv.nw,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> delegateAdd(args.ContainerID, n.DataDir, n.Delegate)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個檔案其實也無形透露了， <strong>flannel</strong> 最後其實是產生一個使用 <strong>bridge</strong> 作為主體 <strong>CNI</strong> 且 <strong>IPAM</strong> 使用 <strong>host-local</strong> 的設定檔案。<br>這也是我之前所說的這些由官方維護的基本功能解決方案，不論是基於提供網路功能的，或是 <strong>IPAM</strong> 相關的套件都會給受到其他的套件反覆使用而組合出更強大的功能。</p>
<p>一旦當 <strong>host-local</strong> 處理結束後，就會再 <strong>&#x2F;var&#x2F;run&#x2F;cni&#x2F;cbr0&#x2F;networks</strong> 看到一系列由 <strong>host-local</strong> 所維護的正在使用 IP 清單。</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p><strong>flannel</strong> 本身並不處理 <strong>Linux Bridge</strong> 的設定以及 <strong>IPAM</strong> 相關的設定，反而是透過更上層的辦法去處理設定檔案的問題，確保每一台機器上面 <strong>host-local</strong> 看到的網段都不同，而 <strong>host-local</strong> 則專注於對每個網段都能夠不停的產生出唯一不被使用的 <strong>IP</strong> 地址。</p>
<p>這種分工合作的辦法也是現在軟體開發與整合的模式，隨者效能與功能愈來愈強大，很難有一個軟體可以涵括所有領域的功能，適度的合作與整合才有辦法打造出更好的解決方案。</p>
<p>本篇我們大概理解了 <strong>flannel</strong> 是如何處理 <strong>IP</strong> 分配的問題，透過 <strong>kubernetes nodeIPAM</strong> 的設計，以及 <strong>CNI Host-local IPAM</strong> 的處理來完成。</p>
<p>最後使用下圖來作為一個總結</p>
<p><img src="https://i.imgur.com/HHKDtsL.png"></p>
<h1 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/coreos/flannel/blob/443d773037ac0f3b8a996a6de018b903b6a58c62/Documentation/kubernetes.md">https://github.com/coreos/flannel/blob/443d773037ac0f3b8a996a6de018b903b6a58c62/Documentation/kubernetes.md</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/coreos/flannel">https://github.com/coreos/flannel</a></li>
</ul>
<h1 id="個人資訊"><a href="#個人資訊" class="headerlink" title="個人資訊"></a>個人資訊</h1><p>我目前於 Hiskio 平台上面有開設 Kubernetes 相關課程，歡迎有興趣的人參考並分享，裡面有我從底層到實戰中對於 Kubernetes 的各種想法</p>
<p>線上課程詳細資訊: <a target="_blank" rel="noopener" href="https://course.hwchiu.com/">https://course.hwchiu.com/</a><br>另外，歡迎按讚加入我個人的粉絲專頁，裡面會定期分享各式各樣的文章，有的是翻譯文章，也有部分是原創文章，主要會聚焦於 CNCF 領域<br><a target="_blank" rel="noopener" href="https://www.facebook.com/technologynoteniu">https://www.facebook.com/technologynoteniu</a></p>
<p>如果有使用 Telegram 的也可以訂閱下列頻道來，裡面我會定期推播通知各類文章<br><a target="_blank" rel="noopener" href="https://t.me/technologynote">https://t.me/technologynote</a></p>
<p>你的捐款將給予我文章成長的動力</p>
<script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="hwchiu" data-color="#000000" data-emoji=""  data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#fff" data-font-color="#fff" data-coffee-color="#fd0" ></script>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/hw_chiu">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/technologynote">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Network/" rel="tag"># Network</a>
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
              <a href="/tags/CNI/" rel="tag"># CNI</a>
              <a href="/tags/Flannel/" rel="tag"># Flannel</a>
              <a href="/tags/ITHOME/" rel="tag"># ITHOME</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/cni-flannel-i.html" rel="prev" title="CNI - Flannel - 安裝設定篇">
                  <i class="fa fa-chevron-left"></i> CNI - Flannel - 安裝設定篇
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/cni-flannel-iii.html" rel="next" title="CNI - Flannel - VXLAN 封包運作篇">
                  CNI - Flannel - VXLAN 封包運作篇 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hwchiu</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"hwchiu/blog-comment","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
