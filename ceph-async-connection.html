<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.0.0-rc1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.hwchiu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="AsyncConnection 此物件代表整個 connection，裡面提供了收送(Write&#x2F;Read)兩個主要介面供應用層(OSD&#x2F;MON等)使用外，裡面也處理了整個 Ceph Node收送封包的邏輯處理，這部分比較像是一個 **finite state machine(FSM)**，當前狀態是什麼時候，收到的封包是什麼，就切換到什麼狀態來處理。每個 AsyncConne">
<meta property="og:type" content="article">
<meta property="og:title" content="Ceph Network - AsyncConnection">
<meta property="og:url" content="https://www.hwchiu.com/ceph-async-connection.html">
<meta property="og:site_name" content="Hwchiu Learning Note">
<meta property="og:description" content="AsyncConnection 此物件代表整個 connection，裡面提供了收送(Write&#x2F;Read)兩個主要介面供應用層(OSD&#x2F;MON等)使用外，裡面也處理了整個 Ceph Node收送封包的邏輯處理，這部分比較像是一個 **finite state machine(FSM)**，當前狀態是什麼時候，收到的封包是什麼，就切換到什麼狀態來處理。每個 AsyncConne">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-05-30T22:50:49.000Z">
<meta property="article:modified_time" content="2023-06-23T05:16:12.601Z">
<meta property="article:author" content="Hwchiu">
<meta property="article:tag" content="Network">
<meta property="article:tag" content="SourceCode">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Ceph">
<meta property="article:tag" content="SDS">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.hwchiu.com/ceph-async-connection.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.hwchiu.com/ceph-async-connection.html","path":"ceph-async-connection.html","title":"Ceph Network - AsyncConnection"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Ceph Network - AsyncConnection | Hwchiu Learning Note</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-54006186-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-54006186-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hwchiu Learning Note</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">kubernetes, sdn, linux,devops</p>
      <img class="custom-logo-image" src="/uploads/hwchiu.jpg" alt="Hwchiu Learning Note">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Accept"><span class="nav-number">1.</span> <span class="nav-text">Accept</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Process"><span class="nav-number">2.</span> <span class="nav-text">Process</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-ACCEPTING"><span class="nav-number">2.1.</span> <span class="nav-text">STATE_ACCEPTING</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-ACCEPTING-WAIT-BANNER-ADDR"><span class="nav-number">2.2.</span> <span class="nav-text">STATE_ACCEPTING_WAIT_BANNER_ADDR</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-ACCEPTING-WAIT-CONNECT-MSG"><span class="nav-number">2.3.</span> <span class="nav-text">STATE_ACCEPTING_WAIT_CONNECT_MSG</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-ACCEPTING-WAIT-CONNECT-MSG-AUTH"><span class="nav-number">2.4.</span> <span class="nav-text">STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-ACCEPTING-WAIT-SEQ"><span class="nav-number">2.5.</span> <span class="nav-text">STATE_ACCEPTING_WAIT_SEQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-ACCEPTING-READY"><span class="nav-number">2.6.</span> <span class="nav-text">STATE_ACCEPTING_READY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-OPEN"><span class="nav-number">2.7.</span> <span class="nav-text">STATE_OPEN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-OPEN-MESSAGE-HEADER"><span class="nav-number">2.8.</span> <span class="nav-text">STATE_OPEN_MESSAGE_HEADER</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-OPEN-MESSAGE-THROTTLE-MESSAGE"><span class="nav-number">2.9.</span> <span class="nav-text">STATE_OPEN_MESSAGE_THROTTLE_MESSAGE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-OPEN-MESSAGE-THROTTLE-BYTES"><span class="nav-number">2.10.</span> <span class="nav-text">STATE_OPEN_MESSAGE_THROTTLE_BYTES;</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-OPEN-MESSAGE-THROTTLE-DISPATCH-QUEUE"><span class="nav-number">2.11.</span> <span class="nav-text">STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-OPEN-MESSAGE-READ-FRONT"><span class="nav-number">2.12.</span> <span class="nav-text">STATE_OPEN_MESSAGE_READ_FRONT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-OPEN-MESSAGE-READ-MIDDLE"><span class="nav-number">2.13.</span> <span class="nav-text">STATE_OPEN_MESSAGE_READ_MIDDLE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-OPEN-MESSAGE-READ-DATA-PREPARE"><span class="nav-number">2.14.</span> <span class="nav-text">STATE_OPEN_MESSAGE_READ_DATA_PREPARE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-OPEN-MESSAGE-READ-DATA"><span class="nav-number">2.15.</span> <span class="nav-text">STATE_OPEN_MESSAGE_READ_DATA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-OPEN-MESSAGE-READ-FOOTER-AND-DISPATCH"><span class="nav-number">2.16.</span> <span class="nav-text">STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Connect"><span class="nav-number">3.</span> <span class="nav-text">Connect</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#connect"><span class="nav-number">4.</span> <span class="nav-text">_connect</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-CONNECTING"><span class="nav-number">4.1.</span> <span class="nav-text">STATE_CONNECTING</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-CONNECTING-RE"><span class="nav-number">4.2.</span> <span class="nav-text">STATE_CONNECTING_RE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-CONNECTING-WAIT-BANNER-AND-IDENTIFY"><span class="nav-number">4.3.</span> <span class="nav-text">STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-CONNECTING-SEND-CONNECT-MSG"><span class="nav-number">4.4.</span> <span class="nav-text">STATE_CONNECTING_SEND_CONNECT_MSG</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-CONNECTING-WAIT-CONNECT-REPLY"><span class="nav-number">4.5.</span> <span class="nav-text">STATE_CONNECTING_WAIT_CONNECT_REPLY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-CONNECTING-WAIT-CONNECT-REPLY-AUTH"><span class="nav-number">4.6.</span> <span class="nav-text">STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATE-CONNECTING-READY"><span class="nav-number">4.7.</span> <span class="nav-text">STATE_CONNECTING_READY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#handle-connect-reply"><span class="nav-number">4.8.</span> <span class="nav-text">handle_connect_reply</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#handle-connect-msg"><span class="nav-number">4.9.</span> <span class="nav-text">handle_connect_msg</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary"><span class="nav-number">5.</span> <span class="nav-text">Summary</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hwchiu"
      src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">Hwchiu</p>
  <div class="site-description" itemprop="description">kubernetes/SDN/DevOps</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">349</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">115</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hwchiu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hwchiu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:sppsorrg@gmail.com" title="E-Mail → mailto:sppsorrg@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/hw_chiu" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;hw_chiu" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/technologynoteniu" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;technologynoteniu" rel="noopener me" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/channel/UCoYY8K9fbfDtTY7m68UCATA/videos" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCoYY8K9fbfDtTY7m68UCATA&#x2F;videos" rel="noopener me" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/hwchiu" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;hwchiu" rel="noopener me" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.hwchiu.com/ceph-async-connection.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="Hwchiu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hwchiu Learning Note">
      <meta itemprop="description" content="kubernetes/SDN/DevOps">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Ceph Network - AsyncConnection | Hwchiu Learning Note">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Ceph Network - AsyncConnection
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-05-31 06:50:49" itemprop="dateCreated datePublished" datetime="2017-05-31T06:50:49+08:00">2017-05-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-23 13:16:12" itemprop="dateModified" datetime="2023-06-23T13:16:12+08:00">2023-06-23</time>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>AsyncConnection 此物件代表整個 connection，裡面提供了收送(Write&#x2F;Read)兩個主要介面供應用層(OSD&#x2F;MON等)使用外，裡面也處理了整個 <strong>Ceph Node</strong>收送封包的邏輯處理，這部分比較像是一個 **finite state machine(FSM)**，當前狀態是什麼時候，收到的封包是什麼，就切換到什麼狀態來處理。<br>每個 AsyncConnection 會像底層的 <strong>Event Engine</strong>註冊一個 <strong>call back function</strong>，當該 <strong>connection</strong> 接收到封包後，就會觸發該 <strong>function</strong>，而此 <strong>function</strong>就是 <strong>Process</strong>，所以接下來會從此 function 當作下手點，主要研究雙方連線建立的過程，特別是從 <strong>Service side</strong> 去觀察 <strong>Accept</strong> 封包後的流程。</p>
<span id="more"></span>


<h1 id="Accept"><a href="#Accept" class="headerlink" title="Accept"></a>Accept</h1><ul>
<li>當 <strong>Server Side</strong> 呼叫此 <strong>function</strong>後，就會開始等待 <strong>client</strong>來連線。</li>
<li>將 socket 跟 addr 都記錄下來，並且將狀態改成 <strong>STATE_ACCEPTING</strong></li>
<li>發送一個 external event(read_handler) 給 eventCenter<ul>
<li>此 read_handler 就是 <code>process</code>，會一直根據當前 state 的狀態來進行各種處理</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1866</span> <span class="function"><span class="type">void</span> <span class="title">AsyncConnection::accept</span><span class="params">(ConnectedSocket socket, <span class="type">entity_addr_t</span> &amp;addr)</span></span></span><br><span class="line"><span class="function">1867 </span>&#123;</span><br><span class="line"><span class="number">1868</span>   <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; sd=&quot;</span> &lt;&lt; socket.<span class="built_in">fd</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">1869</span>   <span class="built_in">assert</span>(socket.<span class="built_in">fd</span>() &gt;= <span class="number">0</span>);</span><br><span class="line"><span class="number">1870</span></span><br><span class="line"><span class="number">1871</span>   <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">l</span><span class="params">(lock)</span></span>;</span><br><span class="line"><span class="number">1872</span>   cs = std::<span class="built_in">move</span>(socket);</span><br><span class="line"><span class="number">1873</span>   socket_addr = addr;</span><br><span class="line"><span class="number">1874</span>   state = STATE_ACCEPTING;</span><br><span class="line"><span class="number">1875</span>   <span class="comment">// rescheduler connection in order to avoid lock dep</span></span><br><span class="line"><span class="number">1876</span>   center-&gt;<span class="built_in">dispatch_event_external</span>(read_handler);</span><br><span class="line"><span class="number">1877</span> &#125;</span><br></pre></td></tr></table></figure>

<h1 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h1><p>當<strong>AsyncConnection</strong>有收到任何封包時，就會呼叫這個 <strong>function</strong>，我們這邊假設我們是 <strong>Server Side</strong>，然後當前 <strong>Socket</strong> 處於一種 <strong>Accepting</strong> 的狀態，在此狀態下收到連線的封包後，會怎麼處理。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0329</span> <span class="function"><span class="type">void</span> <span class="title">AsyncConnection::process</span><span class="params">()</span></span></span><br><span class="line"><span class="function">0330 </span>&#123;</span><br><span class="line"><span class="number">0331</span>   <span class="type">ssize_t</span> r = <span class="number">0</span>;</span><br><span class="line"><span class="number">0332</span>   <span class="type">int</span> prev_state = state;</span><br><span class="line"><span class="number">0333</span> <span class="meta">#<span class="keyword">if</span> defined(WITH_LTTNG) &amp;&amp; defined(WITH_EVENTTRACE)</span></span><br><span class="line"><span class="number">0334</span>   <span class="type">utime_t</span> ltt_recv_stamp = <span class="built_in">ceph_clock_now</span>();</span><br><span class="line"><span class="number">0335</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">0336</span>   <span class="type">bool</span> need_dispatch_writer = <span class="literal">false</span>;</span><br><span class="line"><span class="number">0337</span>   <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">l</span><span class="params">(lock)</span></span>;</span><br><span class="line"><span class="number">0338</span>   last_active = ceph::coarse_mono_clock::<span class="built_in">now</span>();</span><br><span class="line"><span class="number">0339</span>   <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="number">0340</span>     <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; prev state is &quot;</span> &lt;&lt; <span class="built_in">get_state_name</span>(prev_state) &lt;&lt; dendl;</span><br><span class="line"><span class="number">0341</span>     prev_state = state;</span><br><span class="line"><span class="number">0342</span>     <span class="keyword">switch</span> (state) &#123;</span><br><span class="line"><span class="number">0343</span>       <span class="keyword">case</span> STATE_OPEN:</span><br><span class="line">....</span><br><span class="line"><span class="number">0837</span>       <span class="keyword">default</span>:</span><br><span class="line"><span class="number">0838</span>         &#123;</span><br><span class="line"><span class="number">0839</span>           <span class="keyword">if</span> (_process_connection() &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">0840</span>             <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0841</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0842</span>         &#125;</span><br><span class="line"><span class="number">0843</span>     &#125;</span><br><span class="line"><span class="number">0844</span>   &#125; <span class="keyword">while</span> (prev_state != state);</span><br><span class="line"><span class="number">0845</span></span><br><span class="line"><span class="number">0846</span>   <span class="keyword">if</span> (need_dispatch_writer &amp;&amp; <span class="built_in">is_connected</span>())</span><br><span class="line"><span class="number">0847</span>     center-&gt;<span class="built_in">dispatch_event_external</span>(write_handler);</span><br><span class="line"><span class="number">0848</span>   <span class="keyword">return</span>;</span><br><span class="line"><span class="number">0849</span></span><br><span class="line"><span class="number">0850</span>  fail:</span><br><span class="line"><span class="number">0851</span>   <span class="built_in">fault</span>();</span><br><span class="line"><span class="number">0852</span> &#125;</span><br></pre></td></tr></table></figure>
<p>基本上就是跑一個大迴圈，根據當前狀態處理不同的事情，直到狀態已經穩定 **(prev_state &#x3D;&#x3D; state)**， 如果不符合大部分的 State，則呼叫 <code>_process_connection</code> 來處理，譬如 <strong>STATE_ACCEPTING</strong>。<br>一旦建立 <strong>Server Socket</strong>時並且開始透過 <strong>Accept</strong> 等待連線時，狀態則初始化為 <strong>STATE_ACCEPTING</strong>，所以接下來就從這個狀態開始往下研究。</p>
<h2 id="STATE-ACCEPTING"><a href="#STATE-ACCEPTING" class="headerlink" title="STATE_ACCEPTING"></a>STATE_ACCEPTING</h2><ul>
<li>因為先前切換到此狀態時，是透過 <strong>external event</strong> 呼叫的(只會執行一次)，所以這邊要將該 <strong>readable event handler (process)</strong> 正式的丟給 <strong>event center</strong> 一次</li>
<li>接下來要發送一些訊息到對面去，這邊需要下列資訊<ul>
<li>CEPH_BANNER</li>
<li>Addr + Port</li>
</ul>
</li>
<li>呼叫 try_send 去發送訊息<ul>
<li>若成功 (r &#x3D;&#x3D; 0), 狀態切換到 <strong>STATE_ACCEPTING_WAIT_BANNER_ADDR</strong></li>
<li>若失敗 (r &gt; 0),狀態切換到 <strong>STATE_WAIT_SEND</strong>，並且使用一個 <strong>strate_after_send</strong> 的變數來記住當成功送出後要切換成什麼狀態</li>
<li>若失敗 (r &lt; 0),真的失敗了，就當作失敗處理。</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1215</span>     <span class="keyword">case</span> STATE_ACCEPTING:</span><br><span class="line"><span class="number">1216</span>       &#123;</span><br><span class="line"><span class="number">1217</span>         bufferlist bl;</span><br><span class="line"><span class="number">1218</span>         center-&gt;<span class="built_in">create_file_event</span>(cs.<span class="built_in">fd</span>(), EVENT_READABLE, read_handler);</span><br><span class="line"><span class="number">1219</span></span><br><span class="line"><span class="number">1220</span>         bl.<span class="built_in">append</span>(CEPH_BANNER, <span class="built_in">strlen</span>(CEPH_BANNER));</span><br><span class="line"><span class="number">1221</span></span><br><span class="line"><span class="number">1222</span>         ::<span class="built_in">encode</span>(async_msgr-&gt;<span class="built_in">get_myaddr</span>(), bl, <span class="number">0</span>); <span class="comment">// legacy</span></span><br><span class="line"><span class="number">1223</span>         port = async_msgr-&gt;<span class="built_in">get_myaddr</span>().<span class="built_in">get_port</span>();</span><br><span class="line"><span class="number">1224</span>         ::<span class="built_in">encode</span>(socket_addr, bl, <span class="number">0</span>); <span class="comment">// legacy</span></span><br><span class="line"><span class="number">1225</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; sd=&quot;</span> &lt;&lt; cs.<span class="built_in">fd</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; socket_addr &lt;&lt; dendl;</span><br><span class="line"><span class="number">1226</span></span><br><span class="line"><span class="number">1227</span>         r = <span class="built_in">try_send</span>(bl);</span><br><span class="line"><span class="number">1228</span>         <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1229</span>           state = STATE_ACCEPTING_WAIT_BANNER_ADDR;</span><br><span class="line"><span class="number">1230</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; write banner and addr done: &quot;</span></span><br><span class="line"><span class="number">1231</span>             &lt;&lt; <span class="built_in">get_peer_addr</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">1232</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1233</span>           state = STATE_WAIT_SEND;</span><br><span class="line"><span class="number">1234</span>           state_after_send = STATE_ACCEPTING_WAIT_BANNER_ADDR;</span><br><span class="line"><span class="number">1235</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; wait for write banner and addr: &quot;</span></span><br><span class="line"><span class="number">1236</span>                               &lt;&lt; <span class="built_in">get_peer_addr</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">1237</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1238</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">1239</span>         &#125;</span><br><span class="line"><span class="number">1240</span></span><br><span class="line"><span class="number">1241</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1242</span>       &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-ACCEPTING-WAIT-BANNER-ADDR"><a href="#STATE-ACCEPTING-WAIT-BANNER-ADDR" class="headerlink" title="STATE_ACCEPTING_WAIT_BANNER_ADDR"></a>STATE_ACCEPTING_WAIT_BANNER_ADDR</h2><ul>
<li>讀取對方的封包的資訊(代表 Client Side 也必須要發送相關訊息)<ul>
<li>CEPH_BANNER</li>
<li>Addr + Port</li>
</ul>
</li>
<li>比較 banner 資訊</li>
<li>若對方不知道自己的 addr，則透過 socket 的資訊取得並且記錄下來</li>
<li>狀態改成 <strong>STATE_ACCEPTING_WAIT_CONNECT_MSG</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1243</span>     <span class="keyword">case</span> STATE_ACCEPTING_WAIT_BANNER_ADDR:</span><br><span class="line"><span class="number">1244</span>       &#123;</span><br><span class="line"><span class="number">1245</span>         bufferlist addr_bl;</span><br><span class="line"><span class="number">1246</span>         <span class="type">entity_addr_t</span> peer_addr;</span><br><span class="line"><span class="number">1247</span></span><br><span class="line"><span class="number">1248</span>         r = <span class="built_in">read_until</span>(<span class="built_in">strlen</span>(CEPH_BANNER) + <span class="built_in">sizeof</span>(ceph_entity_addr), state_buffer);</span><br><span class="line"><span class="number">1249</span>         <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1250</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read peer banner and addr failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1251</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">1252</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1253</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1254</span>         &#125;</span><br><span class="line"><span class="number">1255</span></span><br><span class="line"><span class="number">1256</span>         <span class="keyword">if</span> (<span class="built_in">memcmp</span>(state_buffer, CEPH_BANNER, <span class="built_in">strlen</span>(CEPH_BANNER))) &#123;</span><br><span class="line"><span class="number">1257</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; accept peer sent bad banner &#x27;&quot;</span> &lt;&lt; state_buffer</span><br><span class="line"><span class="number">1258</span>                                     &lt;&lt; <span class="string">&quot;&#x27; (should be &#x27;&quot;</span> &lt;&lt; CEPH_BANNER &lt;&lt; <span class="string">&quot;&#x27;)&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1259</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">1260</span>         &#125;</span><br><span class="line"><span class="number">1261</span></span><br><span class="line"><span class="number">1262</span>         addr_bl.<span class="built_in">append</span>(state_buffer+<span class="built_in">strlen</span>(CEPH_BANNER), <span class="built_in">sizeof</span>(ceph_entity_addr));</span><br><span class="line"><span class="number">1263</span>         &#123;</span><br><span class="line"><span class="number">1264</span>           bufferlist::iterator ti = addr_bl.<span class="built_in">begin</span>();</span><br><span class="line"><span class="number">1265</span>           ::<span class="built_in">decode</span>(peer_addr, ti);</span><br><span class="line"><span class="number">1266</span>         &#125;</span><br><span class="line"><span class="number">1267</span></span><br><span class="line"><span class="number">1268</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; accept peer addr is &quot;</span> &lt;&lt; peer_addr &lt;&lt; dendl;</span><br><span class="line"><span class="number">1269</span>         <span class="keyword">if</span> (peer_addr.<span class="built_in">is_blank_ip</span>()) &#123;</span><br><span class="line"><span class="number">1270</span>           <span class="comment">// peer apparently doesn&#x27;t know what ip they have; figure it out for them.</span></span><br><span class="line"><span class="number">1271</span>           <span class="type">int</span> port = peer_addr.<span class="built_in">get_port</span>();</span><br><span class="line"><span class="number">1272</span>           peer_addr.u = socket_addr.u;</span><br><span class="line"><span class="number">1273</span>           peer_addr.<span class="built_in">set_port</span>(port);</span><br><span class="line"><span class="number">1274</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">0</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; accept peer addr is really &quot;</span> &lt;&lt; peer_addr</span><br><span class="line"><span class="number">1275</span>                              &lt;&lt; <span class="string">&quot; (socket is &quot;</span> &lt;&lt; socket_addr &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1276</span>         &#125;</span><br><span class="line"><span class="number">1277</span>         <span class="built_in">set_peer_addr</span>(peer_addr);  <span class="comment">// so that connection_state gets set up</span></span><br><span class="line"><span class="number">1278</span>         state = STATE_ACCEPTING_WAIT_CONNECT_MSG;</span><br><span class="line"><span class="number">1279</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1280</span>       &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-ACCEPTING-WAIT-CONNECT-MSG"><a href="#STATE-ACCEPTING-WAIT-CONNECT-MSG" class="headerlink" title="STATE_ACCEPTING_WAIT_CONNECT_MSG"></a>STATE_ACCEPTING_WAIT_CONNECT_MSG</h2><ul>
<li>讀取 connect_msg 大小的資料,並且存放到 <strong>AsyncConnection</strong> 的成員 <strong>connect_msg</strong>中，該結構如下，紀錄了如 <strong>feature</strong>, <strong>type</strong> 等資訊。</li>
<li>最後將狀態轉換成 **<br>**<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0099</span> <span class="keyword">struct</span> <span class="title class_">ceph_msg_connect</span> &#123;</span><br><span class="line"><span class="number">0100</span>     __le64 features;     <span class="comment">/* supported feature bits */</span></span><br><span class="line"><span class="number">0101</span>     __le32 host_type;    <span class="comment">/* CEPH_ENTITY_TYPE_* */</span></span><br><span class="line"><span class="number">0102</span>     __le32 global_seq;   <span class="comment">/* count connections initiated by this host */</span></span><br><span class="line"><span class="number">0103</span>     __le32 connect_seq;  <span class="comment">/* count connections initiated in this session */</span></span><br><span class="line"><span class="number">0104</span>     __le32 protocol_version;</span><br><span class="line"><span class="number">0105</span>     __le32 authorizer_protocol;</span><br><span class="line"><span class="number">0106</span>     __le32 authorizer_len;</span><br><span class="line"><span class="number">0107</span>     __u8  flags;         <span class="comment">/* CEPH_MSG_CONNECT_* */</span></span><br><span class="line"><span class="number">0108</span> &#125; __attribute__ ((packed));</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1282</span>     <span class="keyword">case</span> STATE_ACCEPTING_WAIT_CONNECT_MSG:</span><br><span class="line"><span class="number">1283</span>       &#123;</span><br><span class="line"><span class="number">1284</span>         r = <span class="built_in">read_until</span>(<span class="built_in">sizeof</span>(connect_msg), state_buffer);</span><br><span class="line"><span class="number">1285</span>         <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1286</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read connect msg failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1287</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">1288</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1289</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1290</span>         &#125;</span><br><span class="line"><span class="number">1291</span></span><br><span class="line"><span class="number">1292</span>         connect_msg = *((ceph_msg_connect*)state_buffer);</span><br><span class="line"><span class="number">1293</span>         state = STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH;</span><br><span class="line"><span class="number">1294</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1295</span>       &#125;</span><br></pre></td></tr></table></figure>


<h2 id="STATE-ACCEPTING-WAIT-CONNECT-MSG-AUTH"><a href="#STATE-ACCEPTING-WAIT-CONNECT-MSG-AUTH" class="headerlink" title="STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH"></a>STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH</h2><ul>
<li>根據之前讀取到的 <strong>connect_msg</strong> 來操作</li>
<li>如果對方有設定 authorizer_len 的話，則在額外讀取 authorizer 相關的資訊</li>
<li>設定 peer 的 host type</li>
<li>根據 host type，取得對應的 policy</li>
<li>呼叫 handle_connect_msg 處理該 connection_msg</li>
<li>最後確認狀態已經不是本來的 <strong>STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH</strong><ul>
<li>狀態理論上要因為呼叫了 <strong>handle_connect_msg</strong> 而變換，正常來說要變成 <strong>STATE_ACCEPTING_WAIT_SEQ</strong><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1297</span>     <span class="keyword">case</span> STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH:</span><br><span class="line"><span class="number">1298</span>       &#123;</span><br><span class="line"><span class="number">1299</span>         bufferlist authorizer_reply;</span><br><span class="line"><span class="number">1300</span></span><br><span class="line"><span class="number">1301</span>         <span class="keyword">if</span> (connect_msg.authorizer_len) &#123;</span><br><span class="line"><span class="number">1302</span>           <span class="keyword">if</span> (!authorizer_buf.<span class="built_in">length</span>())</span><br><span class="line"><span class="number">1303</span>             authorizer_buf.<span class="built_in">push_back</span>(buffer::<span class="built_in">create</span>(connect_msg.authorizer_len));</span><br><span class="line"><span class="number">1304</span></span><br><span class="line"><span class="number">1305</span>           r = <span class="built_in">read_until</span>(connect_msg.authorizer_len, authorizer_buf.<span class="built_in">c_str</span>());</span><br><span class="line"><span class="number">1306</span>           <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1307</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read connect authorizer failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1308</span>             <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">1309</span>           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1310</span>             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1311</span>           &#125;</span><br><span class="line"><span class="number">1312</span>         &#125;</span><br><span class="line"><span class="number">1313</span></span><br><span class="line"><span class="number">1314</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; accept got peer connect_seq &quot;</span></span><br><span class="line"><span class="number">1315</span>                              &lt;&lt; connect_msg.connect_seq &lt;&lt; <span class="string">&quot; global_seq &quot;</span></span><br><span class="line"><span class="number">1316</span>                              &lt;&lt; connect_msg.global_seq &lt;&lt; dendl;</span><br><span class="line"><span class="number">1317</span>         <span class="built_in">set_peer_type</span>(connect_msg.host_type);</span><br><span class="line"><span class="number">1318</span>         policy = async_msgr-&gt;<span class="built_in">get_policy</span>(connect_msg.host_type);</span><br><span class="line"><span class="number">1319</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; accept of host_type &quot;</span> &lt;&lt; connect_msg.host_type</span><br><span class="line"><span class="number">1320</span>                                    &lt;&lt; <span class="string">&quot;, policy.lossy=&quot;</span> &lt;&lt; policy.lossy &lt;&lt; <span class="string">&quot; policy.server=&quot;</span></span><br><span class="line"><span class="number">1321</span>                                    &lt;&lt; policy.server &lt;&lt; <span class="string">&quot; policy.standby=&quot;</span> &lt;&lt; policy.standby</span><br><span class="line"><span class="number">1322</span>                                    &lt;&lt; <span class="string">&quot; policy.resetcheck=&quot;</span> &lt;&lt; policy.resetcheck &lt;&lt; dendl;</span><br><span class="line"><span class="number">1323</span></span><br><span class="line"><span class="number">1324</span>         r = <span class="built_in">handle_connect_msg</span>(connect_msg, authorizer_buf, authorizer_reply);</span><br><span class="line"><span class="number">1325</span>         <span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">1326</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">1327</span></span><br><span class="line"><span class="number">1328</span>         <span class="comment">// state is changed by &quot;handle_connect_msg&quot;</span></span><br><span class="line"><span class="number">1329</span>         <span class="built_in">assert</span>(state != STATE_ACCEPTING_WAIT_CONNECT_MSG_AUTH);</span><br><span class="line"><span class="number">1330</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1331</span>       &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="STATE-ACCEPTING-WAIT-SEQ"><a href="#STATE-ACCEPTING-WAIT-SEQ" class="headerlink" title="STATE_ACCEPTING_WAIT_SEQ"></a>STATE_ACCEPTING_WAIT_SEQ</h2><ul>
<li>從對面讀取其使用的 seq</li>
<li>呼叫 discard_requeued_up_to 來處理，根據當前收到的 seq 來做條件<ul>
<li>將 <strong>out_q</strong> 一些不符合條件的成員都移除</li>
</ul>
</li>
<li>狀態改成 <strong>STATE_ACCEPTING_READY</strong></li>
<li><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1333</span>     <span class="keyword">case</span> STATE_ACCEPTING_WAIT_SEQ:</span><br><span class="line"><span class="number">1334</span>       &#123;</span><br><span class="line"><span class="number">1335</span>         <span class="type">uint64_t</span> newly_acked_seq;</span><br><span class="line"><span class="number">1336</span>         r = <span class="built_in">read_until</span>(<span class="built_in">sizeof</span>(newly_acked_seq), state_buffer);</span><br><span class="line"><span class="number">1337</span>         <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1338</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read ack seq failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1339</span>           <span class="keyword">goto</span> fail_registered;</span><br><span class="line"><span class="number">1340</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1341</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1342</span>         &#125;</span><br><span class="line"><span class="number">1343</span></span><br><span class="line"><span class="number">1344</span>         newly_acked_seq = *((<span class="type">uint64_t</span>*)state_buffer);</span><br><span class="line"><span class="number">1345</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">2</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; accept get newly_acked_seq &quot;</span> &lt;&lt; newly_acked_seq &lt;&lt; dendl;</span><br><span class="line"><span class="number">1346</span>         <span class="built_in">discard_requeued_up_to</span>(newly_acked_seq);</span><br><span class="line"><span class="number">1347</span>         state = STATE_ACCEPTING_READY;</span><br><span class="line"><span class="number">1348</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1349</span>       &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="STATE-ACCEPTING-READY"><a href="#STATE-ACCEPTING-READY" class="headerlink" title="STATE_ACCEPTING_READY"></a>STATE_ACCEPTING_READY</h2><ul>
<li>清空 <strong>connect_msg</strong></li>
<li>狀態改成 <strong>STATE_OPEN</strong></li>
<li>如果當前 queue 內有資料(也許是先前 existing connection產生的?)，馬上送一個 write_handler 將其處理完畢</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1351</span>     <span class="keyword">case</span> STATE_ACCEPTING_READY:</span><br><span class="line"><span class="number">1352</span>       &#123;</span><br><span class="line"><span class="number">1353</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; accept done&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1354</span>         state = STATE_OPEN;</span><br><span class="line"><span class="number">1355</span>         <span class="built_in">memset</span>(&amp;connect_msg, <span class="number">0</span>, <span class="built_in">sizeof</span>(connect_msg));</span><br><span class="line"><span class="number">1356</span></span><br><span class="line"><span class="number">1357</span>         <span class="keyword">if</span> (delay_state)</span><br><span class="line"><span class="number">1358</span>           <span class="built_in">assert</span>(delay_state-&gt;<span class="built_in">ready</span>());</span><br><span class="line"><span class="number">1359</span>         <span class="comment">// make sure no pending tick timer</span></span><br><span class="line"><span class="number">1360</span>         <span class="keyword">if</span> (last_tick_id)</span><br><span class="line"><span class="number">1361</span>           center-&gt;<span class="built_in">delete_time_event</span>(last_tick_id);</span><br><span class="line"><span class="number">1362</span>         last_tick_id = center-&gt;<span class="built_in">create_time_event</span>(inactive_timeout_us, tick_handler);</span><br><span class="line"><span class="number">1363</span></span><br><span class="line"><span class="number">1364</span>         write_lock.<span class="built_in">lock</span>();</span><br><span class="line"><span class="number">1365</span>         can_write = WriteStatus::CANWRITE;</span><br><span class="line"><span class="number">1366</span>         <span class="keyword">if</span> (<span class="built_in">is_queued</span>())</span><br><span class="line"><span class="number">1367</span>           center-&gt;<span class="built_in">dispatch_event_external</span>(write_handler);</span><br><span class="line"><span class="number">1368</span>         write_lock.<span class="built_in">unlock</span>();</span><br><span class="line"><span class="number">1369</span>         <span class="built_in">maybe_start_delay_thread</span>();</span><br><span class="line"><span class="number">1370</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1371</span>       &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-OPEN"><a href="#STATE-OPEN" class="headerlink" title="STATE_OPEN"></a>STATE_OPEN</h2><ul>
<li>讀取 TAG，根據 TAG 不同的數值執行不同的事情<ul>
<li>CEPH_MSGR_TAG_MSG: 代表有訊息近來，故將狀態切換成 STATE_OPEN_MESSAGE_HEADER<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0343</span>       <span class="keyword">case</span> STATE_OPEN:</span><br><span class="line"><span class="number">0344</span>         &#123;</span><br><span class="line"><span class="number">0345</span>           <span class="type">char</span> tag = <span class="number">-1</span>;</span><br><span class="line"><span class="number">0346</span>           r = <span class="built_in">read_until</span>(<span class="built_in">sizeof</span>(tag), &amp;tag);</span><br><span class="line"><span class="number">0347</span>           <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0348</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read tag failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0349</span>             <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0350</span>           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0351</span>             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0352</span>           &#125;</span><br><span class="line"><span class="number">0353</span></span><br><span class="line"><span class="number">0354</span>           <span class="keyword">if</span> (tag == CEPH_MSGR_TAG_KEEPALIVE) &#123;</span><br><span class="line"><span class="number">0355</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; got KEEPALIVE&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0356</span>             <span class="built_in">set_last_keepalive</span>(<span class="built_in">ceph_clock_now</span>());</span><br><span class="line"><span class="number">0357</span>           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag == CEPH_MSGR_TAG_KEEPALIVE2) &#123;</span><br><span class="line"><span class="number">0358</span>             state = STATE_OPEN_KEEPALIVE2;</span><br><span class="line"><span class="number">0359</span>           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag == CEPH_MSGR_TAG_KEEPALIVE2_ACK) &#123;</span><br><span class="line"><span class="number">0360</span>             state = STATE_OPEN_KEEPALIVE2_ACK;</span><br><span class="line"><span class="number">0361</span>           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag == CEPH_MSGR_TAG_ACK) &#123;</span><br><span class="line"><span class="number">0362</span>             state = STATE_OPEN_TAG_ACK;</span><br><span class="line"><span class="number">0363</span>           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag == CEPH_MSGR_TAG_MSG) &#123;</span><br><span class="line"><span class="number">0364</span>             state = STATE_OPEN_MESSAGE_HEADER;</span><br><span class="line"><span class="number">0365</span>           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag == CEPH_MSGR_TAG_CLOSE) &#123;</span><br><span class="line"><span class="number">0366</span>             state = STATE_OPEN_TAG_CLOSE;</span><br><span class="line"><span class="number">0367</span>           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0368</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">0</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; bad tag &quot;</span> &lt;&lt; (<span class="type">int</span>)tag &lt;&lt; dendl;</span><br><span class="line"><span class="number">0369</span>             <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0370</span>           &#125;</span><br><span class="line"><span class="number">0371</span></span><br><span class="line"><span class="number">0372</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0373</span>         &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="STATE-OPEN-MESSAGE-HEADER"><a href="#STATE-OPEN-MESSAGE-HEADER" class="headerlink" title="STATE_OPEN_MESSAGE_HEADER"></a>STATE_OPEN_MESSAGE_HEADER</h2><ul>
<li>根據 feature 的值，決定要走新版還是舊版的 header</li>
<li>讀取 header 大小的資料，然後將需要的資料都抓出來記錄下來。</li>
<li>驗證對方送來資料的 CRC 是否正確</li>
<li>將相關資料給 reset (這些結構都跟 header 有關)<ul>
<li>data_buf</li>
<li>front</li>
<li>middle</li>
<li>data</li>
</ul>
</li>
<li>記錄收到時間的時間戳</li>
<li>將狀態改變成 <strong>STATE_OPEN_MESSAGE_THROTTLE_MESSAGE</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0435</span>       <span class="keyword">case</span> STATE_OPEN_MESSAGE_HEADER:</span><br><span class="line"><span class="number">0436</span>         &#123;</span><br><span class="line"><span class="number">0437</span> <span class="meta">#<span class="keyword">if</span> defined(WITH_LTTNG) &amp;&amp; defined(WITH_EVENTTRACE)</span></span><br><span class="line"><span class="number">0438</span>           ltt_recv_stamp = <span class="built_in">ceph_clock_now</span>();</span><br><span class="line"><span class="number">0439</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">0440</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; begin MSG&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0441</span>           ceph_msg_header header;</span><br><span class="line"><span class="number">0442</span>           ceph_msg_header_old oldheader;</span><br><span class="line"><span class="number">0443</span>           __u32 header_crc = <span class="number">0</span>;</span><br><span class="line"><span class="number">0444</span>           <span class="type">unsigned</span> len;</span><br><span class="line"><span class="number">0445</span>           <span class="keyword">if</span> (<span class="built_in">has_feature</span>(CEPH_FEATURE_NOSRCADDR))</span><br><span class="line"><span class="number">0446</span>             len = <span class="built_in">sizeof</span>(header);</span><br><span class="line"><span class="number">0447</span>           <span class="keyword">else</span></span><br><span class="line"><span class="number">0448</span>             len = <span class="built_in">sizeof</span>(oldheader);</span><br><span class="line"><span class="number">0449</span></span><br><span class="line"><span class="number">0450</span>           r = <span class="built_in">read_until</span>(len, state_buffer);</span><br><span class="line"><span class="number">0451</span>           <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0452</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read message header failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0453</span>             <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0454</span>           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0455</span>             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0456</span>           &#125;</span><br><span class="line"><span class="number">0457</span></span><br><span class="line"><span class="number">0458</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; got MSG header&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0459</span></span><br><span class="line"><span class="number">0460</span>           <span class="keyword">if</span> (<span class="built_in">has_feature</span>(CEPH_FEATURE_NOSRCADDR)) &#123;</span><br><span class="line"><span class="number">0461</span>             header = *((ceph_msg_header*)state_buffer);</span><br><span class="line"><span class="number">0462</span>             <span class="keyword">if</span> (msgr-&gt;crcflags &amp; MSG_CRC_HEADER)</span><br><span class="line"><span class="number">0463</span>               header_crc = <span class="built_in">ceph_crc32c</span>(<span class="number">0</span>, (<span class="type">unsigned</span> <span class="type">char</span> *)&amp;header,</span><br><span class="line"><span class="number">0464</span>                                        <span class="built_in">sizeof</span>(header) - <span class="built_in">sizeof</span>(header.crc));</span><br><span class="line"><span class="number">0465</span>           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0466</span>             oldheader = *((ceph_msg_header_old*)state_buffer);</span><br><span class="line"><span class="number">0467</span>             <span class="comment">// this is fugly</span></span><br><span class="line"><span class="number">0468</span>             <span class="built_in">memcpy</span>(&amp;header, &amp;oldheader, <span class="built_in">sizeof</span>(header));</span><br><span class="line"><span class="number">0469</span>             header.src = oldheader.src.name;</span><br><span class="line"><span class="number">0470</span>             header.reserved = oldheader.reserved;</span><br><span class="line"><span class="number">0471</span>             <span class="keyword">if</span> (msgr-&gt;crcflags &amp; MSG_CRC_HEADER) &#123;</span><br><span class="line"><span class="number">0472</span>               header.crc = oldheader.crc;</span><br><span class="line"><span class="number">0473</span>               header_crc = <span class="built_in">ceph_crc32c</span>(<span class="number">0</span>, (<span class="type">unsigned</span> <span class="type">char</span> *)&amp;oldheader, <span class="built_in">sizeof</span>(oldheader) - <span class="built_in">sizeof</span>(oldheader.crc));</span><br><span class="line"><span class="number">0474</span>             &#125;</span><br><span class="line"><span class="number">0475</span>           &#125;</span><br><span class="line"><span class="number">0476</span></span><br><span class="line"><span class="number">0477</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; got envelope type=&quot;</span> &lt;&lt; header.type</span><br><span class="line"><span class="number">0478</span>                               &lt;&lt; <span class="string">&quot; src &quot;</span> &lt;&lt; <span class="built_in">entity_name_t</span>(header.src)</span><br><span class="line"><span class="number">0479</span>                               &lt;&lt; <span class="string">&quot; front=&quot;</span> &lt;&lt; header.front_len</span><br><span class="line"><span class="number">0480</span>                               &lt;&lt; <span class="string">&quot; data=&quot;</span> &lt;&lt; header.data_len</span><br><span class="line"><span class="number">0481</span>                               &lt;&lt; <span class="string">&quot; off &quot;</span> &lt;&lt; header.data_off &lt;&lt; dendl;</span><br><span class="line"><span class="number">0482</span></span><br><span class="line"><span class="number">0483</span>           <span class="comment">// verify header crc</span></span><br><span class="line"><span class="number">0484</span>           <span class="keyword">if</span> (msgr-&gt;crcflags &amp; MSG_CRC_HEADER &amp;&amp; header_crc != header.crc) &#123;</span><br><span class="line"><span class="number">0485</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct,<span class="number">0</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; got bad header crc &quot;</span></span><br><span class="line"><span class="number">0486</span>                                      &lt;&lt; header_crc &lt;&lt; <span class="string">&quot; != &quot;</span> &lt;&lt; header.crc &lt;&lt; dendl;</span><br><span class="line"><span class="number">0487</span>             <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0488</span>           &#125;</span><br><span class="line"><span class="number">0489</span></span><br><span class="line"><span class="number">0490</span>           <span class="comment">// Reset state</span></span><br><span class="line"><span class="number">0491</span>           data_buf.<span class="built_in">clear</span>();</span><br><span class="line"><span class="number">0492</span>           front.<span class="built_in">clear</span>();</span><br><span class="line"><span class="number">0493</span>           middle.<span class="built_in">clear</span>();</span><br><span class="line"><span class="number">0494</span>           data.<span class="built_in">clear</span>();</span><br><span class="line"><span class="number">0495</span>           recv_stamp = <span class="built_in">ceph_clock_now</span>();</span><br><span class="line"><span class="number">0496</span>           current_header = header;</span><br><span class="line"><span class="number">0497</span>           state = STATE_OPEN_MESSAGE_THROTTLE_MESSAGE;</span><br><span class="line"><span class="number">0498</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0499</span>         &#125;</span><br></pre></td></tr></table></figure>


<h2 id="STATE-OPEN-MESSAGE-THROTTLE-MESSAGE"><a href="#STATE-OPEN-MESSAGE-THROTTLE-MESSAGE" class="headerlink" title="STATE_OPEN_MESSAGE_THROTTLE_MESSAGE"></a>STATE_OPEN_MESSAGE_THROTTLE_MESSAGE</h2><ul>
<li>在 Policy 中有兩個關於 Throttle 的變數<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0085</span>     <span class="comment">/**</span></span><br><span class="line"><span class="comment">0086      *  The throttler is used to limit how much data is held by Messages from</span></span><br><span class="line"><span class="comment">0087      *  the associated Connection(s). When reading in a new Message, the Messenger</span></span><br><span class="line"><span class="comment">0088      *  will call throttler-&gt;throttle() for the size of the new Message.</span></span><br><span class="line"><span class="comment">0089      */</span></span><br><span class="line"><span class="number">0090</span>     Throttle *throttler_bytes;</span><br><span class="line"><span class="number">0091</span>     Throttle *throttler_messages;</span><br></pre></td></tr></table></figure></li>
<li>這個 function 檢查是否有 <strong>throttle</strong> 訊息的數量限制，若有限制且超過上限，則建立一個 time event，並儲存下來。</li>
<li>最後將狀態切換到 <strong>STATE_OPEN_MESSAGE_THROTTLE_BYTES</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0501</span>       <span class="keyword">case</span> STATE_OPEN_MESSAGE_THROTTLE_MESSAGE:</span><br><span class="line"><span class="number">0502</span>         &#123;</span><br><span class="line"><span class="number">0503</span>           <span class="keyword">if</span> (policy.throttler_messages) &#123;</span><br><span class="line"><span class="number">0504</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; wants &quot;</span> &lt;&lt; <span class="number">1</span> &lt;&lt; <span class="string">&quot; message from policy throttler &quot;</span></span><br><span class="line"><span class="number">0505</span>                                        &lt;&lt; policy.throttler_messages-&gt;<span class="built_in">get_current</span>() &lt;&lt; <span class="string">&quot;/&quot;</span></span><br><span class="line"><span class="number">0506</span>                                        &lt;&lt; policy.throttler_messages-&gt;<span class="built_in">get_max</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">0507</span>             <span class="keyword">if</span> (!policy.throttler_messages-&gt;<span class="built_in">get_or_fail</span>()) &#123;</span><br><span class="line"><span class="number">0508</span>               <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; wants 1 message from policy throttle &quot;</span></span><br><span class="line"><span class="number">0509</span>                                          &lt;&lt; policy.throttler_messages-&gt;<span class="built_in">get_current</span>() &lt;&lt; <span class="string">&quot;/&quot;</span></span><br><span class="line"><span class="number">0510</span>                                          &lt;&lt; policy.throttler_messages-&gt;<span class="built_in">get_max</span>() &lt;&lt; <span class="string">&quot; failed, just wait.&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0511</span>               <span class="comment">// following thread pool deal with th full message queue isn&#x27;t a</span></span><br><span class="line"><span class="number">0512</span>               <span class="comment">// short time, so we can wait a ms.</span></span><br><span class="line"><span class="number">0513</span>               <span class="keyword">if</span> (register_time_events.<span class="built_in">empty</span>())</span><br><span class="line"><span class="number">0514</span>                 register_time_events.<span class="built_in">insert</span>(center-&gt;<span class="built_in">create_time_event</span>(<span class="number">1000</span>, wakeup_handler));</span><br><span class="line"><span class="number">0515</span>               <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0516</span>             &#125;</span><br><span class="line"><span class="number">0517</span>           &#125;</span><br><span class="line"><span class="number">0518</span></span><br><span class="line"><span class="number">0519</span>           state = STATE_OPEN_MESSAGE_THROTTLE_BYTES;</span><br><span class="line"><span class="number">0520</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0521</span>         &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-OPEN-MESSAGE-THROTTLE-BYTES"><a href="#STATE-OPEN-MESSAGE-THROTTLE-BYTES" class="headerlink" title="STATE_OPEN_MESSAGE_THROTTLE_BYTES;"></a>STATE_OPEN_MESSAGE_THROTTLE_BYTES;</h2><ul>
<li>從 <strong>connection</strong> 讀取資料，分別對應到 header 中的三個成員<ul>
<li>front</li>
<li>middle</li>
<li>data</li>
</ul>
</li>
<li>此 function 則是檢查 throttle 訊息的 bytes 數量，若數量超過上限，也是建議一個 time event並存下來，待之後處理</li>
<li>最後將狀態切換到 <strong>STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0523</span>       <span class="keyword">case</span> STATE_OPEN_MESSAGE_THROTTLE_BYTES:</span><br><span class="line"><span class="number">0524</span>         &#123;</span><br><span class="line"><span class="number">0525</span>           cur_msg_size = current_header.front_len + current_header.middle_len + current_header.data_len;</span><br><span class="line"><span class="number">0526</span>           <span class="keyword">if</span> (cur_msg_size) &#123;</span><br><span class="line"><span class="number">0527</span>             <span class="keyword">if</span> (policy.throttler_bytes) &#123;</span><br><span class="line"><span class="number">0528</span>               <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; wants &quot;</span> &lt;&lt; cur_msg_size &lt;&lt; <span class="string">&quot; bytes from policy throttler &quot;</span></span><br><span class="line"><span class="number">0529</span>                                          &lt;&lt; policy.throttler_bytes-&gt;<span class="built_in">get_current</span>() &lt;&lt; <span class="string">&quot;/&quot;</span></span><br><span class="line"><span class="number">0530</span>                                          &lt;&lt; policy.throttler_bytes-&gt;<span class="built_in">get_max</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">0531</span>               <span class="keyword">if</span> (!policy.throttler_bytes-&gt;<span class="built_in">get_or_fail</span>(cur_msg_size)) &#123;</span><br><span class="line"><span class="number">0532</span>                 <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; wants &quot;</span> &lt;&lt; cur_msg_size &lt;&lt; <span class="string">&quot; bytes from policy throttler &quot;</span></span><br><span class="line"><span class="number">0533</span>                                            &lt;&lt; policy.throttler_bytes-&gt;<span class="built_in">get_current</span>() &lt;&lt; <span class="string">&quot;/&quot;</span></span><br><span class="line"><span class="number">0534</span>                                            &lt;&lt; policy.throttler_bytes-&gt;<span class="built_in">get_max</span>() &lt;&lt; <span class="string">&quot; failed, just wait.&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0535</span>                 <span class="comment">// following thread pool deal with th full message queue isn&#x27;t a</span></span><br><span class="line"><span class="number">0536</span>                 <span class="comment">// short time, so we can wait a ms.</span></span><br><span class="line"><span class="number">0537</span>                 <span class="keyword">if</span> (register_time_events.<span class="built_in">empty</span>())</span><br><span class="line"><span class="number">0538</span>                   register_time_events.<span class="built_in">insert</span>(center-&gt;<span class="built_in">create_time_event</span>(<span class="number">1000</span>, wakeup_handler));</span><br><span class="line"><span class="number">0539</span>                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0540</span>               &#125;</span><br><span class="line"><span class="number">0541</span>             &#125;</span><br><span class="line"><span class="number">0542</span>           &#125;</span><br><span class="line"><span class="number">0543</span></span><br><span class="line"><span class="number">0544</span>           state = STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE;</span><br><span class="line"><span class="number">0545</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0546</span>         &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-OPEN-MESSAGE-THROTTLE-DISPATCH-QUEUE"><a href="#STATE-OPEN-MESSAGE-THROTTLE-DISPATCH-QUEUE" class="headerlink" title="STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE"></a>STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE</h2><ul>
<li>如果剛剛有在 <strong>STATE_OPEN_MESSAGE_THROTTLE_BYTES</strong> 讀取到 front&#x2F;middle&#x2F;data 的資料的話，則這邊要確認 disaptch 本身的 throttle 有沒有超過，若超過也是送一個 time event 待稍後再來重新試試看</li>
<li>紀錄 throttle 的時間戳</li>
<li>狀態切換成 <strong>STATE_OPEN_MESSAGE_READ_FRONT</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0548</span>       <span class="keyword">case</span> STATE_OPEN_MESSAGE_THROTTLE_DISPATCH_QUEUE:</span><br><span class="line"><span class="number">0549</span>         &#123;</span><br><span class="line"><span class="number">0550</span>           <span class="keyword">if</span> (cur_msg_size) &#123;</span><br><span class="line"><span class="number">0551</span>             <span class="keyword">if</span> (!dispatch_queue-&gt;dispatch_throttler.<span class="built_in">get_or_fail</span>(cur_msg_size)) &#123;</span><br><span class="line"><span class="number">0552</span>               <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; wants &quot;</span> &lt;&lt; cur_msg_size &lt;&lt; <span class="string">&quot; bytes from dispatch throttle &quot;</span></span><br><span class="line"><span class="number">0553</span>                                          &lt;&lt; dispatch_queue-&gt;dispatch_throttler.<span class="built_in">get_current</span>() &lt;&lt; <span class="string">&quot;/&quot;</span></span><br><span class="line"><span class="number">0554</span>                                          &lt;&lt; dispatch_queue-&gt;dispatch_throttler.<span class="built_in">get_max</span>() &lt;&lt; <span class="string">&quot; failed, just wait.&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0555</span>               <span class="comment">// following thread pool deal with th full message queue isn&#x27;t a</span></span><br><span class="line"><span class="number">0556</span>               <span class="comment">// short time, so we can wait a ms.</span></span><br><span class="line"><span class="number">0557</span>               <span class="keyword">if</span> (register_time_events.<span class="built_in">empty</span>())</span><br><span class="line"><span class="number">0558</span>                 register_time_events.<span class="built_in">insert</span>(center-&gt;<span class="built_in">create_time_event</span>(<span class="number">1000</span>, wakeup_handler));</span><br><span class="line"><span class="number">0559</span>               <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0560</span>             &#125;</span><br><span class="line"><span class="number">0561</span>           &#125;</span><br><span class="line"><span class="number">0562</span></span><br><span class="line"><span class="number">0563</span>           throttle_stamp = <span class="built_in">ceph_clock_now</span>();</span><br><span class="line"><span class="number">0564</span>           state = STATE_OPEN_MESSAGE_READ_FRONT;</span><br><span class="line"><span class="number">0565</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0566</span>         &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-OPEN-MESSAGE-READ-FRONT"><a href="#STATE-OPEN-MESSAGE-READ-FRONT" class="headerlink" title="STATE_OPEN_MESSAGE_READ_FRONT"></a>STATE_OPEN_MESSAGE_READ_FRONT</h2><ul>
<li>接下來就是開始讀取真正的封包資料了，主要是分成三個部分<ul>
<li>front</li>
<li>middle</li>
<li>data</li>
</ul>
</li>
<li>讀取前段資料，將內容先放到本身的 front 變數中</li>
<li>將狀態切成 <strong>STATE_OPEN_MESSAGE_READ_MIDDLE</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0568</span>       <span class="keyword">case</span> STATE_OPEN_MESSAGE_READ_FRONT:</span><br><span class="line"><span class="number">0569</span>         &#123;</span><br><span class="line"><span class="number">0570</span>           <span class="comment">// read front</span></span><br><span class="line"><span class="number">0571</span>           <span class="type">unsigned</span> front_len = current_header.front_len;</span><br><span class="line"><span class="number">0572</span>           <span class="keyword">if</span> (front_len) &#123;</span><br><span class="line"><span class="number">0573</span>             <span class="keyword">if</span> (!front.<span class="built_in">length</span>())</span><br><span class="line"><span class="number">0574</span>               front.<span class="built_in">push_back</span>(buffer::<span class="built_in">create</span>(front_len));</span><br><span class="line"><span class="number">0575</span></span><br><span class="line"><span class="number">0576</span>             r = <span class="built_in">read_until</span>(front_len, front.<span class="built_in">c_str</span>());</span><br><span class="line"><span class="number">0577</span>             <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0578</span>               <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read message front failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0579</span>               <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0580</span>             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0581</span>               <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0582</span>             &#125;</span><br><span class="line"><span class="number">0583</span></span><br><span class="line"><span class="number">0584</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; got front &quot;</span> &lt;&lt; front.<span class="built_in">length</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">0585</span>           &#125;</span><br><span class="line"><span class="number">0586</span>           state = STATE_OPEN_MESSAGE_READ_MIDDLE;</span><br><span class="line"><span class="number">0587</span>         &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-OPEN-MESSAGE-READ-MIDDLE"><a href="#STATE-OPEN-MESSAGE-READ-MIDDLE" class="headerlink" title="STATE_OPEN_MESSAGE_READ_MIDDLE"></a>STATE_OPEN_MESSAGE_READ_MIDDLE</h2><ul>
<li>讀取中段資料，將內容先放到本身的 middle 變數中</li>
<li>將狀態切成 <strong>STATE_OPEN_MESSAGE_READ_DATA_PREPARE</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0589</span>       <span class="keyword">case</span> STATE_OPEN_MESSAGE_READ_MIDDLE:</span><br><span class="line"><span class="number">0590</span>         &#123;</span><br><span class="line"><span class="number">0591</span>           <span class="comment">// read middle</span></span><br><span class="line"><span class="number">0592</span>           <span class="type">unsigned</span> middle_len = current_header.middle_len;</span><br><span class="line"><span class="number">0593</span>           <span class="keyword">if</span> (middle_len) &#123;</span><br><span class="line"><span class="number">0594</span>             <span class="keyword">if</span> (!middle.<span class="built_in">length</span>())</span><br><span class="line"><span class="number">0595</span>               middle.<span class="built_in">push_back</span>(buffer::<span class="built_in">create</span>(middle_len));</span><br><span class="line"><span class="number">0596</span></span><br><span class="line"><span class="number">0597</span>             r = <span class="built_in">read_until</span>(middle_len, middle.<span class="built_in">c_str</span>());</span><br><span class="line"><span class="number">0598</span>             <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0599</span>               <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read message middle failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0600</span>               <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0601</span>             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0602</span>               <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0603</span>             &#125;</span><br><span class="line"><span class="number">0604</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; got middle &quot;</span> &lt;&lt; middle.<span class="built_in">length</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">0605</span>           &#125;</span><br><span class="line"><span class="number">0606</span></span><br><span class="line"><span class="number">0607</span>           state = STATE_OPEN_MESSAGE_READ_DATA_PREPARE;</span><br><span class="line"><span class="number">0608</span>         &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-OPEN-MESSAGE-READ-DATA-PREPARE"><a href="#STATE-OPEN-MESSAGE-READ-DATA-PREPARE" class="headerlink" title="STATE_OPEN_MESSAGE_READ_DATA_PREPARE"></a>STATE_OPEN_MESSAGE_READ_DATA_PREPARE</h2><ul>
<li>準備好 buffer 供之後讀取 data 用，其中 data 部分除了長度外，還有 <strong>offset</strong> 也要處理</li>
<li>這邊還不會讀取資料，只是會根據讀出來的空間長度預先配置一個空間供之後讀取資料使用</li>
<li>將狀態切成 STATE_OPEN_MESSAGE_READ_DATA</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0610</span>       <span class="keyword">case</span> STATE_OPEN_MESSAGE_READ_DATA_PREPARE:</span><br><span class="line"><span class="number">0611</span>         &#123;</span><br><span class="line"><span class="number">0612</span>           <span class="comment">// read data</span></span><br><span class="line"><span class="number">0613</span>           <span class="type">unsigned</span> data_len = <span class="built_in">le32_to_cpu</span>(current_header.data_len);</span><br><span class="line"><span class="number">0614</span>           <span class="type">unsigned</span> data_off = <span class="built_in">le32_to_cpu</span>(current_header.data_off);</span><br><span class="line"><span class="number">0615</span>           <span class="keyword">if</span> (data_len) &#123;</span><br><span class="line"><span class="number">0616</span>             <span class="comment">// get a buffer</span></span><br><span class="line"><span class="number">0617</span>             map&lt;<span class="type">ceph_tid_t</span>,pair&lt;bufferlist,<span class="type">int</span>&gt; &gt;::iterator p = rx_buffers.<span class="built_in">find</span>(current_header.tid);</span><br><span class="line"><span class="number">0618</span>             <span class="keyword">if</span> (p != rx_buffers.<span class="built_in">end</span>()) &#123;</span><br><span class="line"><span class="number">0619</span>               <span class="built_in">ldout</span>(async_msgr-&gt;cct,<span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; seleting rx buffer v &quot;</span> &lt;&lt; p-&gt;second.second</span><br><span class="line"><span class="number">0620</span>                                   &lt;&lt; <span class="string">&quot; at offset &quot;</span> &lt;&lt; data_off</span><br><span class="line"><span class="number">0621</span>                                   &lt;&lt; <span class="string">&quot; len &quot;</span> &lt;&lt; p-&gt;second.first.<span class="built_in">length</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">0622</span>               data_buf = p-&gt;second.first;</span><br><span class="line"><span class="number">0623</span>               <span class="comment">// make sure it&#x27;s big enough</span></span><br><span class="line"><span class="number">0624</span>               <span class="keyword">if</span> (data_buf.<span class="built_in">length</span>() &lt; data_len)</span><br><span class="line"><span class="number">0625</span>                 data_buf.<span class="built_in">push_back</span>(buffer::<span class="built_in">create</span>(data_len - data_buf.<span class="built_in">length</span>()));</span><br><span class="line"><span class="number">0626</span>               data_blp = data_buf.<span class="built_in">begin</span>();</span><br><span class="line"><span class="number">0627</span>             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0628</span>               <span class="built_in">ldout</span>(async_msgr-&gt;cct,<span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; allocating new rx buffer at offset &quot;</span> &lt;&lt; data_off &lt;&lt; dendl;</span><br><span class="line"><span class="number">0629</span>               <span class="built_in">alloc_aligned_buffer</span>(data_buf, data_len, data_off);</span><br><span class="line"><span class="number">0630</span>               data_blp = data_buf.<span class="built_in">begin</span>();</span><br><span class="line"><span class="number">0631</span>             &#125;</span><br><span class="line"><span class="number">0632</span>           &#125;</span><br><span class="line"><span class="number">0633</span></span><br><span class="line"><span class="number">0634</span>           msg_left = data_len;</span><br><span class="line"><span class="number">0635</span>           state = STATE_OPEN_MESSAGE_READ_DATA;</span><br><span class="line"><span class="number">0636</span>         &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-OPEN-MESSAGE-READ-DATA"><a href="#STATE-OPEN-MESSAGE-READ-DATA" class="headerlink" title="STATE_OPEN_MESSAGE_READ_DATA"></a>STATE_OPEN_MESSAGE_READ_DATA</h2><ul>
<li>透過一個迴圈嘗試將資料讀取出來並且放到之前所預先配置的空間 <strong>DATA</strong></li>
<li>最後狀態切換到 <strong>STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0638</span>       <span class="keyword">case</span> STATE_OPEN_MESSAGE_READ_DATA:</span><br><span class="line"><span class="number">0639</span>         &#123;</span><br><span class="line"><span class="number">0640</span>           <span class="keyword">while</span> (msg_left &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0641</span>             bufferptr bp = data_blp.<span class="built_in">get_current_ptr</span>();</span><br><span class="line"><span class="number">0642</span>             <span class="type">unsigned</span> read = <span class="built_in">MIN</span>(bp.<span class="built_in">length</span>(), msg_left);</span><br><span class="line"><span class="number">0643</span>             r = <span class="built_in">read_until</span>(read, bp.<span class="built_in">c_str</span>());</span><br><span class="line"><span class="number">0644</span>             <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0645</span>               <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read data error &quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0646</span>               <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0647</span>             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0648</span>               <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0649</span>             &#125;</span><br><span class="line"><span class="number">0650</span></span><br><span class="line"><span class="number">0651</span>             data_blp.<span class="built_in">advance</span>(read);</span><br><span class="line"><span class="number">0652</span>             data.<span class="built_in">append</span>(bp, <span class="number">0</span>, read);</span><br><span class="line"><span class="number">0653</span>             msg_left -= read;</span><br><span class="line"><span class="number">0654</span>           &#125;</span><br><span class="line"><span class="number">0655</span></span><br><span class="line"><span class="number">0656</span>           <span class="keyword">if</span> (msg_left &gt; <span class="number">0</span>)</span><br><span class="line"><span class="number">0657</span>             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0658</span></span><br><span class="line"><span class="number">0659</span>           state = STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH;</span><br><span class="line"><span class="number">0660</span>         &#125;</span><br><span class="line"><span class="number">0661</span></span><br></pre></td></tr></table></figure>

<h2 id="STATE-OPEN-MESSAGE-READ-FOOTER-AND-DISPATCH"><a href="#STATE-OPEN-MESSAGE-READ-FOOTER-AND-DISPATCH" class="headerlink" title="STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH"></a>STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH</h2><ul>
<li><p>這個 function 比較長，不過可以說是最後一步驟了。</p>
</li>
<li><p>跟 header 一樣，根據 <strong>feature</strong> 決定使用新舊版本的 <strong>footer</strong> 格式</p>
</li>
<li><p>讀取 footer 的資料，如各區段的CRC等</p>
</li>
<li><p>透過 decode_message 此 function，將收集到的 (front, middle, data, footer.etc) 組合成一個完整的 <strong>message</strong> 格式的封包</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0270</span> <span class="function">Message *<span class="title">decode_message</span><span class="params">(CephContext *cct, <span class="type">int</span> crcflags,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="number">0271</span>                         ceph_msg_header&amp; header,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="number">0272</span>                         ceph_msg_footer&amp; footer,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="number">0273</span>                         bufferlist&amp; front, bufferlist&amp; middle,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="number">0274</span>                         bufferlist&amp; data)</span></span></span><br><span class="line"><span class="function">....</span></span><br><span class="line"><span class="function">0315   <span class="comment">// make message</span></span></span><br><span class="line"><span class="function">0316   Message *m </span>= <span class="number">0</span>;</span><br><span class="line"><span class="number">0317</span>   <span class="type">int</span> type = header.type;</span><br><span class="line"><span class="number">0318</span>   <span class="keyword">switch</span> (type) &#123;</span><br><span class="line"><span class="number">0319</span></span><br><span class="line"><span class="number">0320</span>     <span class="comment">// -- with payload --</span></span><br><span class="line"><span class="number">0321</span></span><br><span class="line"><span class="number">0322</span>   <span class="keyword">case</span> MSG_PGSTATS:</span><br><span class="line"><span class="number">0323</span>     m = <span class="keyword">new</span> MPGStats;</span><br><span class="line"><span class="number">0324</span>     <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0325</span>   <span class="keyword">case</span> MSG_PGSTATSACK:</span><br><span class="line"><span class="number">0326</span>     m = <span class="keyword">new</span> MPGStatsAck;</span><br><span class="line"><span class="number">0327</span>     <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0328</span></span><br><span class="line"><span class="number">0329</span>   <span class="keyword">case</span> CEPH_MSG_STATFS:</span><br><span class="line"><span class="number">0330</span>     m = <span class="keyword">new</span> MStatfs;</span><br><span class="line"><span class="number">0331</span>     <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0332</span>   <span class="keyword">case</span> CEPH_MSG_STATFS_REPLY:</span><br><span class="line"><span class="number">0333</span>     m = <span class="keyword">new</span> MStatfsReply;</span><br><span class="line"><span class="number">0334</span>     <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0335</span>   <span class="keyword">case</span> MSG_GETPOOLSTATS:</span><br><span class="line"><span class="number">0336</span>     m = <span class="keyword">new</span> MGetPoolStats;</span><br><span class="line"><span class="number">0337</span>     <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0338</span>   <span class="keyword">case</span> MSG_GETPOOLSTATSREPLY:</span><br><span class="line"><span class="number">0339</span>     m = <span class="keyword">new</span> MGetPoolStatsReply;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>針對該 message 設定一些相關屬性</p>
<ul>
<li>byte_throttler</li>
<li>message_throttler</li>
<li>dispatch_throttle_size</li>
<li>recv_stamp</li>
<li>throttle_stamp</li>
<li>recv_complete_stamp</li>
</ul>
</li>
<li><p>針對 sequence 進行一些判斷，當前的 message 可能中間有遺漏，或是很久以前的 message</p>
</li>
<li><p>將該 messaged 的 sequence 當作目前最後一個收到 sequence</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0765</span>           <span class="comment">// note last received message.</span></span><br><span class="line"><span class="number">0766</span>           in_seq.<span class="built_in">set</span>(message-&gt;<span class="built_in">get_seq</span>());</span><br></pre></td></tr></table></figure></li>
<li><p>將狀態改成 STATE_OPEN</p>
</li>
<li><p>將本訊息塞入到 dispatch_queue 內，供應用層去處理</p>
</li>
<li><p>到這邊就結束了，接下來 <strong>AsyncManager</strong> 去定期去檢查 <strong>dispatch_queue</strong>，當有封包進來後，就會將該封包送給所有註冊的 <strong>Dispatcher</strong> 去處理。</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0662</span>       <span class="keyword">case</span> STATE_OPEN_MESSAGE_READ_FOOTER_AND_DISPATCH:</span><br><span class="line"><span class="number">0663</span>         &#123;</span><br><span class="line"><span class="number">0664</span>           ceph_msg_footer footer;</span><br><span class="line"><span class="number">0665</span>           ceph_msg_footer_old old_footer;</span><br><span class="line"><span class="number">0666</span>           <span class="type">unsigned</span> len;</span><br><span class="line"><span class="number">0667</span>           <span class="comment">// footer</span></span><br><span class="line"><span class="number">0668</span>           <span class="keyword">if</span> (<span class="built_in">has_feature</span>(CEPH_FEATURE_MSG_AUTH))</span><br><span class="line"><span class="number">0669</span>             len = <span class="built_in">sizeof</span>(footer);</span><br><span class="line"><span class="number">0670</span>           <span class="keyword">else</span></span><br><span class="line"><span class="number">0671</span>             len = <span class="built_in">sizeof</span>(old_footer);</span><br><span class="line"><span class="number">0672</span></span><br><span class="line"><span class="number">0673</span>           r = <span class="built_in">read_until</span>(len, state_buffer);</span><br><span class="line"><span class="number">0674</span>           <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0675</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read footer data error &quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0676</span>             <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0677</span>           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0678</span>             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0679</span>           &#125;</span><br><span class="line"><span class="number">0680</span></span><br><span class="line"><span class="number">0681</span>           <span class="keyword">if</span> (<span class="built_in">has_feature</span>(CEPH_FEATURE_MSG_AUTH)) &#123;</span><br><span class="line"><span class="number">0682</span>             footer = *((ceph_msg_footer*)state_buffer);</span><br><span class="line"><span class="number">0683</span>           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0684</span>             old_footer = *((ceph_msg_footer_old*)state_buffer);</span><br><span class="line"><span class="number">0685</span>             footer.front_crc = old_footer.front_crc;</span><br><span class="line"><span class="number">0686</span>             footer.middle_crc = old_footer.middle_crc;</span><br><span class="line"><span class="number">0687</span>             footer.data_crc = old_footer.data_crc;</span><br><span class="line"><span class="number">0688</span>             footer.sig = <span class="number">0</span>;</span><br><span class="line"><span class="number">0689</span>             footer.flags = old_footer.flags;</span><br><span class="line"><span class="number">0690</span>           &#125;</span><br><span class="line"><span class="number">0691</span>           <span class="type">int</span> aborted = (footer.flags &amp; CEPH_MSG_FOOTER_COMPLETE) == <span class="number">0</span>;</span><br><span class="line"><span class="number">0692</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; aborted = &quot;</span> &lt;&lt; aborted &lt;&lt; dendl;</span><br><span class="line"><span class="number">0693</span>           <span class="keyword">if</span> (aborted) &#123;</span><br><span class="line"><span class="number">0694</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">0</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; got &quot;</span> &lt;&lt; front.<span class="built_in">length</span>() &lt;&lt; <span class="string">&quot; + &quot;</span> &lt;&lt; middle.<span class="built_in">length</span>() &lt;&lt; <span class="string">&quot; + &quot;</span> &lt;&lt; data.<span class="built_in">length</span>()</span><br><span class="line"><span class="number">0695</span>                                 &lt;&lt; <span class="string">&quot; byte message.. ABORTED&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0696</span>             <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0697</span>           &#125;</span><br><span class="line"><span class="number">0698</span></span><br><span class="line"><span class="number">0699</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; got &quot;</span> &lt;&lt; front.<span class="built_in">length</span>() &lt;&lt; <span class="string">&quot; + &quot;</span> &lt;&lt; middle.<span class="built_in">length</span>()</span><br><span class="line"><span class="number">0700</span>                               &lt;&lt; <span class="string">&quot; + &quot;</span> &lt;&lt; data.<span class="built_in">length</span>() &lt;&lt; <span class="string">&quot; byte message&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0701</span>           Message *message = <span class="built_in">decode_message</span>(async_msgr-&gt;cct, async_msgr-&gt;crcflags, current_header, footer,</span><br><span class="line"><span class="number">0702</span>                                             front, middle, data, <span class="keyword">this</span>);</span><br><span class="line"><span class="number">0703</span>           <span class="keyword">if</span> (!message) &#123;</span><br><span class="line"><span class="number">0704</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; decode message failed &quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0705</span>             <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0706</span>           &#125;</span><br><span class="line"><span class="number">0707</span></span><br><span class="line"><span class="number">0708</span>           <span class="comment">//</span></span><br><span class="line"><span class="number">0709</span>           <span class="comment">//  Check the signature if one should be present.  A zero return indicates success. PLR</span></span><br><span class="line"><span class="number">0710</span>           <span class="comment">//</span></span><br><span class="line"><span class="number">0711</span></span><br><span class="line"><span class="number">0712</span>           <span class="keyword">if</span> (session_security.<span class="built_in">get</span>() == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="number">0713</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; no session security set&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0714</span>           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0715</span>             <span class="keyword">if</span> (session_security-&gt;<span class="built_in">check_message_signature</span>(message)) &#123;</span><br><span class="line"><span class="number">0716</span>               <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">0</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; Signature check failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0717</span>               message-&gt;<span class="built_in">put</span>();</span><br><span class="line"><span class="number">0718</span>               <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0719</span>             &#125;</span><br><span class="line"><span class="number">0720</span>           &#125;</span><br><span class="line"><span class="number">0721</span>           message-&gt;<span class="built_in">set_byte_throttler</span>(policy.throttler_bytes);</span><br><span class="line"><span class="number">0722</span>           message-&gt;<span class="built_in">set_message_throttler</span>(policy.throttler_messages);</span><br><span class="line"><span class="number">0723</span></span><br><span class="line"><span class="number">0724</span>           <span class="comment">// store reservation size in message, so we don&#x27;t get confused</span></span><br><span class="line"><span class="number">0725</span>           <span class="comment">// by messages entering the dispatch queue through other paths.</span></span><br><span class="line"><span class="number">0726</span>           message-&gt;<span class="built_in">set_dispatch_throttle_size</span>(cur_msg_size);</span><br><span class="line"><span class="number">0727</span></span><br><span class="line"><span class="number">0728</span>           message-&gt;<span class="built_in">set_recv_stamp</span>(recv_stamp);</span><br><span class="line"><span class="number">0729</span>           message-&gt;<span class="built_in">set_throttle_stamp</span>(throttle_stamp);</span><br><span class="line"><span class="number">0730</span>           message-&gt;<span class="built_in">set_recv_complete_stamp</span>(<span class="built_in">ceph_clock_now</span>());</span><br><span class="line"><span class="number">0731</span></span><br><span class="line"><span class="number">0732</span>           <span class="comment">// check received seq#.  if it is old, drop the message.</span></span><br><span class="line"><span class="number">0733</span>           <span class="comment">// note that incoming messages may skip ahead.  this is convenient for the client</span></span><br><span class="line"><span class="number">0734</span>           <span class="comment">// side queueing because messages can&#x27;t be renumbered, but the (kernel) client will</span></span><br><span class="line"><span class="number">0735</span>           <span class="comment">// occasionally pull a message out of the sent queue to send elsewhere.  in that case</span></span><br><span class="line"><span class="number">0736</span>           <span class="comment">// it doesn&#x27;t matter if we &quot;got&quot; it or not.</span></span><br><span class="line"><span class="number">0737</span>           <span class="type">uint64_t</span> cur_seq = in_seq.<span class="built_in">read</span>();</span><br><span class="line"><span class="number">0738</span>           <span class="keyword">if</span> (message-&gt;<span class="built_in">get_seq</span>() &lt;= cur_seq) &#123;</span><br><span class="line"><span class="number">0739</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct,<span class="number">0</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; got old message &quot;</span></span><br><span class="line"><span class="number">0740</span>                     &lt;&lt; message-&gt;<span class="built_in">get_seq</span>() &lt;&lt; <span class="string">&quot; &lt;= &quot;</span> &lt;&lt; cur_seq &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; message &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; *message</span><br><span class="line"><span class="number">0741</span>                     &lt;&lt; <span class="string">&quot;, discarding&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0742</span>             message-&gt;<span class="built_in">put</span>();</span><br><span class="line"><span class="number">0743</span>             <span class="keyword">if</span> (<span class="built_in">has_feature</span>(CEPH_FEATURE_RECONNECT_SEQ) &amp;&amp; async_msgr-&gt;cct-&gt;_conf-&gt;ms_die_on_old_message)</span><br><span class="line"><span class="number">0744</span>               <span class="built_in">assert</span>(<span class="number">0</span> == <span class="string">&quot;old msgs despite reconnect_seq feature&quot;</span>);</span><br><span class="line"><span class="number">0745</span>             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0746</span>           &#125;</span><br><span class="line"><span class="number">0747</span>           <span class="keyword">if</span> (message-&gt;<span class="built_in">get_seq</span>() &gt; cur_seq + <span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">0748</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">0</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; missed message?  skipped from seq &quot;</span></span><br><span class="line"><span class="number">0749</span>                                       &lt;&lt; cur_seq &lt;&lt; <span class="string">&quot; to &quot;</span> &lt;&lt; message-&gt;<span class="built_in">get_seq</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">0750</span>             <span class="keyword">if</span> (async_msgr-&gt;cct-&gt;_conf-&gt;ms_die_on_skipped_message)</span><br><span class="line"><span class="number">0751</span>               <span class="built_in">assert</span>(<span class="number">0</span> == <span class="string">&quot;skipped incoming seq&quot;</span>);</span><br><span class="line"><span class="number">0752</span>           &#125;</span><br><span class="line"><span class="number">0753</span></span><br><span class="line"><span class="number">0754</span>           message-&gt;<span class="built_in">set_connection</span>(<span class="keyword">this</span>);</span><br><span class="line"><span class="number">0755</span></span><br><span class="line"><span class="number">0756</span> <span class="meta">#<span class="keyword">if</span> defined(WITH_LTTNG) &amp;&amp; defined(WITH_EVENTTRACE)</span></span><br><span class="line"><span class="number">0757</span>           <span class="keyword">if</span> (message-&gt;<span class="built_in">get_type</span>() == CEPH_MSG_OSD_OP || message-&gt;<span class="built_in">get_type</span>() == CEPH_MSG_OSD_OPREPLY) &#123;</span><br><span class="line"><span class="number">0758</span>             <span class="type">utime_t</span> ltt_processed_stamp = <span class="built_in">ceph_clock_now</span>();</span><br><span class="line"><span class="number">0759</span>             <span class="type">double</span> usecs_elapsed = (ltt_processed_stamp.<span class="built_in">to_nsec</span>()-ltt_recv_stamp.<span class="built_in">to_nsec</span>())/<span class="number">1000</span>;</span><br><span class="line"><span class="number">0760</span>             ostringstream buf;</span><br><span class="line"><span class="number">0761</span>             <span class="keyword">if</span> (message-&gt;<span class="built_in">get_type</span>() == CEPH_MSG_OSD_OP)</span><br><span class="line"><span class="number">0762</span>               <span class="built_in">OID_ELAPSED_WITH_MSG</span>(message, usecs_elapsed, <span class="string">&quot;TIME_TO_DECODE_OSD_OP&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="number">0763</span>             <span class="keyword">else</span></span><br><span class="line"><span class="number">0764</span>               <span class="built_in">OID_ELAPSED_WITH_MSG</span>(message, usecs_elapsed, <span class="string">&quot;TIME_TO_DECODE_OSD_OPREPLY&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="number">0765</span>           &#125;</span><br><span class="line"><span class="number">0766</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">0767</span></span><br><span class="line"><span class="number">0768</span>           <span class="comment">// note last received message.</span></span><br><span class="line"><span class="number">0769</span>           in_seq.<span class="built_in">set</span>(message-&gt;<span class="built_in">get_seq</span>());</span><br><span class="line"><span class="number">0770</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">5</span>) &lt;&lt; <span class="string">&quot; rx &quot;</span> &lt;&lt; message-&gt;<span class="built_in">get_source</span>() &lt;&lt; <span class="string">&quot; seq &quot;</span></span><br><span class="line"><span class="number">0771</span>                                     &lt;&lt; message-&gt;<span class="built_in">get_seq</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; message</span><br><span class="line"><span class="number">0772</span>                                     &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; *message &lt;&lt; dendl;</span><br><span class="line"><span class="number">0773</span></span><br><span class="line"><span class="number">0774</span>           <span class="keyword">if</span> (!policy.lossy) &#123;</span><br><span class="line"><span class="number">0775</span>             ack_left.<span class="built_in">inc</span>();</span><br><span class="line"><span class="number">0776</span>             need_dispatch_writer = <span class="literal">true</span>;</span><br><span class="line"><span class="number">0777</span>           &#125;</span><br><span class="line"><span class="number">0778</span>           state = STATE_OPEN;</span><br><span class="line"><span class="number">0779</span></span><br><span class="line"><span class="number">0780</span>           logger-&gt;<span class="built_in">inc</span>(l_msgr_recv_messages);</span><br><span class="line"><span class="number">0781</span>           logger-&gt;<span class="built_in">inc</span>(l_msgr_recv_bytes, cur_msg_size + <span class="built_in">sizeof</span>(ceph_msg_header) + <span class="built_in">sizeof</span>(ceph_msg_footer));</span><br><span class="line"><span class="number">0782</span></span><br><span class="line"><span class="number">0783</span>           async_msgr-&gt;<span class="built_in">ms_fast_preprocess</span>(message);</span><br><span class="line"><span class="number">0784</span>           <span class="keyword">if</span> (delay_state) &#123;</span><br><span class="line"><span class="number">0785</span>             <span class="type">utime_t</span> release = message-&gt;<span class="built_in">get_recv_stamp</span>();</span><br><span class="line"><span class="number">0786</span>             <span class="type">double</span> delay_period = <span class="number">0</span>;</span><br><span class="line"><span class="number">0787</span>             <span class="keyword">if</span> (<span class="built_in">rand</span>() % <span class="number">10000</span> &lt; async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_delay_probability * <span class="number">10000.0</span>) &#123;</span><br><span class="line"><span class="number">0788</span>               delay_period = async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_delay_max * (<span class="type">double</span>)(<span class="built_in">rand</span>() % <span class="number">10000</span>) / <span class="number">10000.0</span>;</span><br><span class="line"><span class="number">0789</span>               release += delay_period;</span><br><span class="line"><span class="number">0790</span>               <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; <span class="string">&quot;queue_received will delay until &quot;</span> &lt;&lt; release &lt;&lt; <span class="string">&quot; on &quot;</span></span><br><span class="line"><span class="number">0791</span>                                         &lt;&lt; message &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; *message &lt;&lt; dendl;</span><br><span class="line"><span class="number">0792</span>             &#125;</span><br><span class="line"><span class="number">0793</span>             delay_state-&gt;<span class="built_in">queue</span>(delay_period, release, message);</span><br><span class="line"><span class="number">0794</span>           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (async_msgr-&gt;<span class="built_in">ms_can_fast_dispatch</span>(message)) &#123;</span><br><span class="line"><span class="number">0795</span>             lock.<span class="built_in">unlock</span>();</span><br><span class="line"><span class="number">0796</span>             dispatch_queue-&gt;<span class="built_in">fast_dispatch</span>(message);</span><br><span class="line"><span class="number">0797</span>             lock.<span class="built_in">lock</span>();</span><br><span class="line"><span class="number">0798</span>           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0799</span>             dispatch_queue-&gt;<span class="built_in">enqueue</span>(message, message-&gt;<span class="built_in">get_priority</span>(), conn_id);</span><br><span class="line"><span class="number">0800</span>           &#125;</span><br><span class="line"><span class="number">0801</span></span><br><span class="line"><span class="number">0802</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0803</span>         &#125;</span><br><span class="line"><span class="number">0804</span></span><br></pre></td></tr></table></figure>

<p>上述已經大概跑完了整個 <strong>Accept</strong> 的流程，當然此流程中是確保沒有任何錯誤，一切都是順利往下進行的。<br>接下來來探討若 <strong>Client</strong> 想要連線，則會怎麼處理。</p>
<h1 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h1><ul>
<li>當 AsyncMessager 創立 AsyncConnection時，就會先呼叫此 function 進行連線了，後續若有訊息發送時，會透過 <code>_connect</code>重新連線。</li>
<li>設定 peer 的 addr以及 policy</li>
<li>呼叫 _connect 完成最後的連線步驟<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0200</span>   <span class="function"><span class="type">void</span> <span class="title">connect</span><span class="params">(<span class="type">const</span> <span class="type">entity_addr_t</span>&amp; addr, <span class="type">int</span> type)</span> </span>&#123;</span><br><span class="line"><span class="number">0201</span>     <span class="built_in">set_peer_type</span>(type);</span><br><span class="line"><span class="number">0202</span>     <span class="built_in">set_peer_addr</span>(addr);</span><br><span class="line"><span class="number">0203</span>     policy = msgr-&gt;<span class="built_in">get_policy</span>(type);</span><br><span class="line"><span class="number">0204</span>     _connect();</span><br><span class="line"><span class="number">0205</span>   &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="connect"><a href="#connect" class="headerlink" title="_connect"></a>_connect</h1><ul>
<li>將狀態設定為 <strong>STATE_CONNECTING</strong>，接下來就將 <strong>read_handler</strong> 送給 <strong>Event Engine</strong>去處理，由於是透過 <strong>external event</strong>，所以則會馬上執行 <strong>read_handler</strong>，也就是 <strong>process</strong>。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1856</span> <span class="type">void</span> AsyncConnection::_connect()</span><br><span class="line"><span class="number">1857</span> &#123;</span><br><span class="line"><span class="number">1858</span>   <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; csq=&quot;</span> &lt;&lt; connect_seq &lt;&lt; dendl;</span><br><span class="line"><span class="number">1859</span></span><br><span class="line"><span class="number">1860</span>   state = STATE_CONNECTING;</span><br><span class="line"><span class="number">1861</span>   <span class="comment">// rescheduler connection in order to avoid lock dep</span></span><br><span class="line"><span class="number">1862</span>   <span class="comment">// may called by external thread(send_message)</span></span><br><span class="line"><span class="number">1863</span>   center-&gt;<span class="built_in">dispatch_event_external</span>(read_handler);</span><br><span class="line"><span class="number">1864</span> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="STATE-CONNECTING"><a href="#STATE-CONNECTING" class="headerlink" title="STATE_CONNECTING"></a>STATE_CONNECTING</h2><ul>
<li>檢查 cs 此變數，如果之前有連線過，則關閉先前的連線<ul>
<li>同時也先刪除之前的 event</li>
</ul>
</li>
<li>呼叫 worker 跟對方的 socket 去連線</li>
<li>創造一個 read_handler 的 event，來處理接下來收到封包的行為<ul>
<li>read_handler 就是 process</li>
</ul>
</li>
<li>狀態切換成 STATE_CONNECTING_RE</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0870</span>     <span class="keyword">case</span> STATE_CONNECTING:</span><br><span class="line"><span class="number">0871</span>       &#123;</span><br><span class="line"><span class="number">0872</span>         <span class="built_in">assert</span>(!policy.server);</span><br><span class="line"><span class="number">0873</span></span><br><span class="line"><span class="number">0874</span>         <span class="comment">// reset connect state variables</span></span><br><span class="line"><span class="number">0875</span>         got_bad_auth = <span class="literal">false</span>;</span><br><span class="line"><span class="number">0876</span>         <span class="keyword">delete</span> authorizer;</span><br><span class="line"><span class="number">0877</span>         authorizer = <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">0878</span>         authorizer_buf.<span class="built_in">clear</span>();</span><br><span class="line"><span class="number">0879</span>         <span class="built_in">memset</span>(&amp;connect_msg, <span class="number">0</span>, <span class="built_in">sizeof</span>(connect_msg));</span><br><span class="line"><span class="number">0880</span>         <span class="built_in">memset</span>(&amp;connect_reply, <span class="number">0</span>, <span class="built_in">sizeof</span>(connect_reply));</span><br><span class="line"><span class="number">0881</span></span><br><span class="line"><span class="number">0882</span>         global_seq = async_msgr-&gt;<span class="built_in">get_global_seq</span>();</span><br><span class="line"><span class="number">0883</span>         <span class="comment">// close old socket.  this is safe because we stopped the reader thread above.</span></span><br><span class="line"><span class="number">0884</span>         <span class="keyword">if</span> (cs) &#123;</span><br><span class="line"><span class="number">0885</span>           center-&gt;<span class="built_in">delete_file_event</span>(cs.<span class="built_in">fd</span>(), EVENT_READABLE|EVENT_WRITABLE);</span><br><span class="line"><span class="number">0886</span>           cs.<span class="built_in">close</span>();</span><br><span class="line"><span class="number">0887</span>         &#125;</span><br><span class="line"><span class="number">0888</span></span><br><span class="line"><span class="number">0889</span>         SocketOptions opts;</span><br><span class="line"><span class="number">0890</span>         opts.priority = async_msgr-&gt;<span class="built_in">get_socket_priority</span>();</span><br><span class="line"><span class="number">0891</span>         opts.connect_bind_addr = msgr-&gt;<span class="built_in">get_myaddr</span>();</span><br><span class="line"><span class="number">0892</span>         r = worker-&gt;<span class="built_in">connect</span>(<span class="built_in">get_peer_addr</span>(), opts, &amp;cs);</span><br><span class="line"><span class="number">0893</span>         <span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">0894</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0895</span></span><br><span class="line"><span class="number">0896</span>         center-&gt;<span class="built_in">create_file_event</span>(cs.<span class="built_in">fd</span>(), EVENT_READABLE, read_handler);</span><br><span class="line"><span class="number">0897</span>         state = STATE_CONNECTING_RE;</span><br><span class="line"><span class="number">0898</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0899</span>       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="STATE-CONNECTING-RE"><a href="#STATE-CONNECTING-RE" class="headerlink" title="STATE_CONNECTING_RE"></a>STATE_CONNECTING_RE</h2><ul>
<li>檢查當前 connectionSocket 連線狀態，本身若發現沒有連線則會自己重新連線<ul>
<li>r &lt; 0, 連線依然失敗，則判定有問題， goto 離開</li>
<li>r &#x3D;&#x3D; 1, 成功，不做事情</li>
<li>r &#x3D;&#x3D; 0, 重連過程中有出現錯誤，可能是 EINPROGRESS  或是 EALREADY。</li>
</ul>
</li>
<li>嘗試送出 CEPH_BANNER</li>
<li>若成功，狀態切換成 <strong>STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY</strong></li>
<li>若失敗，狀態切換成 <strong>STATE_WAIT_SEND</strong>，待之後重送後再處理。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0055</span>   <span class="function"><span class="type">int</span> <span class="title">is_connected</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"><span class="number">0056</span>     <span class="keyword">if</span> (connected)</span><br><span class="line"><span class="number">0057</span>       <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="number">0058</span></span><br><span class="line"><span class="number">0059</span>     <span class="type">int</span> r = handler.<span class="built_in">reconnect</span>(sa, _fd);</span><br><span class="line"><span class="number">0060</span>     <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0061</span>       connected = <span class="literal">true</span>;</span><br><span class="line"><span class="number">0062</span>       <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="number">0063</span>     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0064</span>       <span class="keyword">return</span> r;</span><br><span class="line"><span class="number">0065</span>     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0066</span>       <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">0067</span>     &#125;</span><br><span class="line"><span class="number">0068</span>   &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0901</span>     <span class="keyword">case</span> STATE_CONNECTING_RE:</span><br><span class="line"><span class="number">0902</span>       &#123;</span><br><span class="line"><span class="number">0903</span>         r = cs.<span class="built_in">is_connected</span>();</span><br><span class="line"><span class="number">0904</span>         <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0905</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; reconnect failed &quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0906</span>           <span class="keyword">if</span> (r == -ECONNREFUSED) &#123;</span><br><span class="line"><span class="number">0907</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">2</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connection refused!&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0908</span>             dispatch_queue-&gt;<span class="built_in">queue_refused</span>(<span class="keyword">this</span>);</span><br><span class="line"><span class="number">0909</span>           &#125;</span><br><span class="line"><span class="number">0910</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0911</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0912</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; nonblock connect inprogress&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0913</span>           <span class="keyword">if</span> (async_msgr-&gt;<span class="built_in">get_stack</span>()-&gt;<span class="built_in">nonblock_connect_need_writable_event</span>())</span><br><span class="line"><span class="number">0914</span>             center-&gt;<span class="built_in">create_file_event</span>(cs.<span class="built_in">fd</span>(), EVENT_WRITABLE, read_handler);</span><br><span class="line"><span class="number">0915</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0916</span>         &#125;</span><br><span class="line"><span class="number">0917</span></span><br><span class="line"><span class="number">0918</span>         center-&gt;<span class="built_in">delete_file_event</span>(cs.<span class="built_in">fd</span>(), EVENT_WRITABLE);</span><br><span class="line"><span class="number">0919</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect successfully, ready to send banner&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0920</span></span><br><span class="line"><span class="number">0921</span>         bufferlist bl;</span><br><span class="line"><span class="number">0922</span>         bl.<span class="built_in">append</span>(CEPH_BANNER, <span class="built_in">strlen</span>(CEPH_BANNER));</span><br><span class="line"><span class="number">0923</span>         r = <span class="built_in">try_send</span>(bl);</span><br><span class="line"><span class="number">0924</span>         <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0925</span>           state = STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY;</span><br><span class="line"><span class="number">0926</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect write banner done: &quot;</span></span><br><span class="line"><span class="number">0927</span>                                      &lt;&lt; <span class="built_in">get_peer_addr</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">0928</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0929</span>           state = STATE_WAIT_SEND;</span><br><span class="line"><span class="number">0930</span>           state_after_send = STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY;</span><br><span class="line"><span class="number">0931</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect wait for write banner: &quot;</span></span><br><span class="line"><span class="number">0932</span>                                &lt;&lt; <span class="built_in">get_peer_addr</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">0933</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0934</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0935</span>         &#125;</span><br><span class="line"><span class="number">0936</span></span><br><span class="line"><span class="number">0937</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0938</span>       &#125;</span><br><span class="line"><span class="number">0223</span> &#125;</span><br></pre></td></tr></table></figure>


<h2 id="STATE-CONNECTING-WAIT-BANNER-AND-IDENTIFY"><a href="#STATE-CONNECTING-WAIT-BANNER-AND-IDENTIFY" class="headerlink" title="STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY"></a>STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY</h2><ul>
<li>讀取 SERVER 端送來的資訊<ul>
<li>CEPH_BANNER</li>
<li>Address (Server本身，以及Server看到的 Client)，所以有兩份。</li>
</ul>
</li>
<li>比較兩邊的 CEPH_BANNER</li>
<li>比較 peer addr (server address)<ul>
<li>我自己 socket 看到的</li>
<li>對方送過來的</li>
</ul>
</li>
<li>將自己的 address 送給 server</li>
<li>若成功，將狀態切換成 <strong>STATE_CONNECTING_SEND_CONNECT_MSG</strong></li>
<li>若失敗，將狀態切換成 <strong>STATE_WAIT_SEND</strong>，之後再處理。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0940</span>     <span class="keyword">case</span> STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY:</span><br><span class="line"><span class="number">0941</span>       &#123;</span><br><span class="line"><span class="number">0942</span>         <span class="type">entity_addr_t</span> paddr, peer_addr_for_me;</span><br><span class="line"><span class="number">0943</span>         bufferlist myaddrbl;</span><br><span class="line"><span class="number">0944</span>         <span class="type">unsigned</span> banner_len = <span class="built_in">strlen</span>(CEPH_BANNER);</span><br><span class="line"><span class="number">0945</span>         <span class="type">unsigned</span> need_len = banner_len + <span class="built_in">sizeof</span>(ceph_entity_addr)*<span class="number">2</span>;</span><br><span class="line"><span class="number">0946</span>         r = <span class="built_in">read_until</span>(need_len, state_buffer);</span><br><span class="line"><span class="number">0947</span>         <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0948</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read banner and identify addresses failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0949</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0950</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0951</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0952</span>         &#125;</span><br><span class="line"><span class="number">0953</span></span><br><span class="line"><span class="number">0954</span>         <span class="keyword">if</span> (<span class="built_in">memcmp</span>(state_buffer, CEPH_BANNER, banner_len)) &#123;</span><br><span class="line"><span class="number">0955</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">0</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect protocol error (bad banner) on peer &quot;</span></span><br><span class="line"><span class="number">0956</span>                                     &lt;&lt; <span class="built_in">get_peer_addr</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">0957</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0958</span>         &#125;</span><br><span class="line"><span class="number">0959</span></span><br><span class="line"><span class="number">0960</span>         bufferlist bl;</span><br><span class="line"><span class="number">0961</span>         bl.<span class="built_in">append</span>(state_buffer+banner_len, <span class="built_in">sizeof</span>(ceph_entity_addr)*<span class="number">2</span>);</span><br><span class="line"><span class="number">0962</span>         bufferlist::iterator p = bl.<span class="built_in">begin</span>();</span><br><span class="line"><span class="number">0963</span>         <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">0964</span>           ::<span class="built_in">decode</span>(paddr, p);</span><br><span class="line"><span class="number">0965</span>           ::<span class="built_in">decode</span>(peer_addr_for_me, p);</span><br><span class="line"><span class="number">0966</span>         &#125; <span class="built_in">catch</span> (<span class="type">const</span> buffer::error&amp; e) &#123;</span><br><span class="line"><span class="number">0967</span>           <span class="built_in">lderr</span>(async_msgr-&gt;cct) &lt;&lt; __func__ &lt;&lt;  <span class="string">&quot; decode peer addr failed &quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0968</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0969</span>         &#125;</span><br><span class="line"><span class="number">0970</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt;  <span class="string">&quot; connect read peer addr &quot;</span></span><br><span class="line"><span class="number">0971</span>                              &lt;&lt; paddr &lt;&lt; <span class="string">&quot; on socket &quot;</span> &lt;&lt; cs.<span class="built_in">fd</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">0972</span>         <span class="keyword">if</span> (peer_addr != paddr) &#123;</span><br><span class="line"><span class="number">0973</span>           <span class="keyword">if</span> (paddr.<span class="built_in">is_blank_ip</span>() &amp;&amp; peer_addr.<span class="built_in">get_port</span>() == paddr.<span class="built_in">get_port</span>() &amp;&amp;</span><br><span class="line"><span class="number">0974</span>               peer_addr.<span class="built_in">get_nonce</span>() == paddr.<span class="built_in">get_nonce</span>()) &#123;</span><br><span class="line"><span class="number">0975</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">0</span>) &lt;&lt; __func__ &lt;&lt;  <span class="string">&quot; connect claims to be &quot;</span> &lt;&lt; paddr</span><br><span class="line"><span class="number">0976</span>                                 &lt;&lt; <span class="string">&quot; not &quot;</span> &lt;&lt; peer_addr</span><br><span class="line"><span class="number">0977</span>                                 &lt;&lt; <span class="string">&quot; - presumably this is the same node!&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0978</span>           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0979</span>             <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">0</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect claims to be &quot;</span></span><br><span class="line"><span class="number">0980</span>                                 &lt;&lt; paddr &lt;&lt; <span class="string">&quot; not &quot;</span> &lt;&lt; peer_addr &lt;&lt; <span class="string">&quot; - wrong node!&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">0981</span>             <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">0982</span>           &#125;</span><br><span class="line"><span class="number">0983</span>         &#125;</span><br><span class="line"><span class="number">0984</span></span><br><span class="line"><span class="number">0985</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect peer addr for me is &quot;</span> &lt;&lt; peer_addr_for_me &lt;&lt; dendl;</span><br><span class="line"><span class="number">0986</span>         lock.<span class="built_in">unlock</span>();</span><br><span class="line"><span class="number">0987</span>         async_msgr-&gt;<span class="built_in">learned_addr</span>(peer_addr_for_me);</span><br><span class="line"><span class="number">0988</span>         <span class="keyword">if</span> (async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_internal_delays) &#123;</span><br><span class="line"><span class="number">0989</span>           <span class="keyword">if</span> (<span class="built_in">rand</span>() % async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_socket_failures == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">0990</span>             <span class="built_in">ldout</span>(msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; sleep for &quot;</span></span><br><span class="line"><span class="number">0991</span>                                  &lt;&lt; async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_internal_delays &lt;&lt; dendl;</span><br><span class="line"><span class="number">0992</span>             <span class="type">utime_t</span> t;</span><br><span class="line"><span class="number">0993</span>             t.<span class="built_in">set_from_double</span>(async_msgr-&gt;cct-&gt;_conf-&gt;ms_inject_internal_delays);</span><br><span class="line"><span class="number">0994</span>             t.<span class="built_in">sleep</span>();</span><br><span class="line"><span class="number">0995</span>           &#125;</span><br><span class="line"><span class="number">0996</span>         &#125;</span><br><span class="line"><span class="number">0997</span></span><br><span class="line"><span class="number">0998</span>         lock.<span class="built_in">lock</span>();</span><br><span class="line"><span class="number">0999</span>         <span class="keyword">if</span> (state != STATE_CONNECTING_WAIT_BANNER_AND_IDENTIFY) &#123;</span><br><span class="line"><span class="number">1000</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; state changed while learned_addr, mark_down or &quot;</span></span><br><span class="line"><span class="number">1001</span>                                     &lt;&lt; <span class="string">&quot; replacing must be happened just now&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1002</span>           <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">1003</span>         &#125;</span><br><span class="line"><span class="number">1004</span></span><br><span class="line"><span class="number">1005</span>         ::<span class="built_in">encode</span>(async_msgr-&gt;<span class="built_in">get_myaddr</span>(), myaddrbl, <span class="number">0</span>); <span class="comment">// legacy</span></span><br><span class="line"><span class="number">1006</span>         r = <span class="built_in">try_send</span>(myaddrbl);</span><br><span class="line"><span class="number">1007</span>         <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1008</span>           state = STATE_CONNECTING_SEND_CONNECT_MSG;</span><br><span class="line"><span class="number">1009</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect sent my addr &quot;</span></span><br><span class="line"><span class="number">1010</span>               &lt;&lt; async_msgr-&gt;<span class="built_in">get_myaddr</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">1011</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1012</span>           state = STATE_WAIT_SEND;</span><br><span class="line"><span class="number">1013</span>           state_after_send = STATE_CONNECTING_SEND_CONNECT_MSG;</span><br><span class="line"><span class="number">1014</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect send my addr done: &quot;</span></span><br><span class="line"><span class="number">1015</span>               &lt;&lt; async_msgr-&gt;<span class="built_in">get_myaddr</span>() &lt;&lt; dendl;</span><br><span class="line"><span class="number">1016</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1017</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">2</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect couldn&#x27;t write my addr, &quot;</span></span><br><span class="line"><span class="number">1018</span>               &lt;&lt; <span class="built_in">cpp_strerror</span>(r) &lt;&lt; dendl;</span><br><span class="line"><span class="number">1019</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">1020</span>         &#125;</span><br><span class="line"><span class="number">1021</span></span><br><span class="line"><span class="number">1022</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1023</span>       &#125;</span><br></pre></td></tr></table></figure>


<h2 id="STATE-CONNECTING-SEND-CONNECT-MSG"><a href="#STATE-CONNECTING-SEND-CONNECT-MSG" class="headerlink" title="STATE_CONNECTING_SEND_CONNECT_MSG"></a>STATE_CONNECTING_SEND_CONNECT_MSG</h2><ul>
<li>設定 <strong>connect_msg</strong> 的資訊<ul>
<li>如同之前所述，包含 <strong>featrue</strong>, <strong>type</strong>等。</li>
</ul>
</li>
<li>將該 <strong>connect_msg</strong> 的資訊封裝起來到 <strong>bl</strong>變數中，透過 <strong>try_send</strong>送出</li>
<li>若成功則將狀態切換到 <strong>STATE_CONNECTING_WAIT_CONNECT_REPLY</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1025</span>     <span class="keyword">case</span> STATE_CONNECTING_SEND_CONNECT_MSG:</span><br><span class="line"><span class="number">1026</span>       &#123;</span><br><span class="line"><span class="number">1027</span>         <span class="keyword">if</span> (!got_bad_auth) &#123;</span><br><span class="line"><span class="number">1028</span>           <span class="keyword">delete</span> authorizer;</span><br><span class="line"><span class="number">1029</span>           authorizer = async_msgr-&gt;<span class="built_in">get_authorizer</span>(peer_type, <span class="literal">false</span>);</span><br><span class="line"><span class="number">1030</span>         &#125;</span><br><span class="line"><span class="number">1031</span>         bufferlist bl;</span><br><span class="line"><span class="number">1032</span></span><br><span class="line"><span class="number">1033</span>         connect_msg.features = policy.features_supported;</span><br><span class="line"><span class="number">1034</span>         connect_msg.host_type = async_msgr-&gt;<span class="built_in">get_myinst</span>().name.<span class="built_in">type</span>();</span><br><span class="line"><span class="number">1035</span>         connect_msg.global_seq = global_seq;</span><br><span class="line"><span class="number">1036</span>         connect_msg.connect_seq = connect_seq;</span><br><span class="line"><span class="number">1037</span>         connect_msg.protocol_version = async_msgr-&gt;<span class="built_in">get_proto_version</span>(peer_type, <span class="literal">true</span>);</span><br><span class="line"><span class="number">1038</span>         connect_msg.authorizer_protocol = authorizer ? authorizer-&gt;protocol : <span class="number">0</span>;</span><br><span class="line"><span class="number">1039</span>         connect_msg.authorizer_len = authorizer ? authorizer-&gt;bl.<span class="built_in">length</span>() : <span class="number">0</span>;</span><br><span class="line"><span class="number">1040</span>         <span class="keyword">if</span> (authorizer)</span><br><span class="line"><span class="number">1041</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt;  <span class="string">&quot; connect_msg.authorizer_len=&quot;</span></span><br><span class="line"><span class="number">1042</span>                                      &lt;&lt; connect_msg.authorizer_len &lt;&lt; <span class="string">&quot; protocol=&quot;</span></span><br><span class="line"><span class="number">1043</span>                                      &lt;&lt; connect_msg.authorizer_protocol &lt;&lt; dendl;</span><br><span class="line"><span class="number">1044</span>         connect_msg.flags = <span class="number">0</span>;</span><br><span class="line"><span class="number">1045</span>         <span class="keyword">if</span> (policy.lossy)</span><br><span class="line"><span class="number">1046</span>           connect_msg.flags |= CEPH_MSG_CONNECT_LOSSY;  <span class="comment">// this is fyi, actually, server decides!</span></span><br><span class="line"><span class="number">1047</span>         bl.<span class="built_in">append</span>((<span class="type">char</span>*)&amp;connect_msg, <span class="built_in">sizeof</span>(connect_msg));</span><br><span class="line"><span class="number">1048</span>         <span class="keyword">if</span> (authorizer) &#123;</span><br><span class="line"><span class="number">1049</span>           bl.<span class="built_in">append</span>(authorizer-&gt;bl.<span class="built_in">c_str</span>(), authorizer-&gt;bl.<span class="built_in">length</span>());</span><br><span class="line"><span class="number">1050</span>         &#125;</span><br><span class="line"><span class="number">1051</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect sending gseq=&quot;</span> &lt;&lt; global_seq &lt;&lt; <span class="string">&quot; cseq=&quot;</span></span><br><span class="line"><span class="number">1052</span>             &lt;&lt; connect_seq &lt;&lt; <span class="string">&quot; proto=&quot;</span> &lt;&lt; connect_msg.protocol_version &lt;&lt; dendl;</span><br><span class="line"><span class="number">1053</span></span><br><span class="line"><span class="number">1054</span>         r = <span class="built_in">try_send</span>(bl);</span><br><span class="line"><span class="number">1055</span>         <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1056</span>           state = STATE_CONNECTING_WAIT_CONNECT_REPLY;</span><br><span class="line"><span class="number">1057</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct,<span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect wrote (self +) cseq, waiting for reply&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1058</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1059</span>           state = STATE_WAIT_SEND;</span><br><span class="line"><span class="number">1060</span>           state_after_send = STATE_CONNECTING_WAIT_CONNECT_REPLY;</span><br><span class="line"><span class="number">1061</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; continue send reply &quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1062</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1063</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">2</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect couldn&#x27;t send reply &quot;</span></span><br><span class="line"><span class="number">1064</span>               &lt;&lt; <span class="built_in">cpp_strerror</span>(r) &lt;&lt; dendl;</span><br><span class="line"><span class="number">1065</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">1066</span>         &#125;</span><br><span class="line"><span class="number">1067</span></span><br><span class="line"><span class="number">1068</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1069</span>       &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-CONNECTING-WAIT-CONNECT-REPLY"><a href="#STATE-CONNECTING-WAIT-CONNECT-REPLY" class="headerlink" title="STATE_CONNECTING_WAIT_CONNECT_REPLY"></a>STATE_CONNECTING_WAIT_CONNECT_REPLY</h2><ul>
<li>從 <strong>Server</strong> 端讀取資料，將資料放到 <strong>state_buffer</strong>，此資料的格式為 <strong>ceph_msg_connect_reply</strong><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0110</span> <span class="keyword">struct</span> <span class="title class_">ceph_msg_connect_reply</span> &#123;</span><br><span class="line"><span class="number">0111</span>     __u8 tag;</span><br><span class="line"><span class="number">0112</span>     __le64 features;     <span class="comment">/* feature bits for this session */</span></span><br><span class="line"><span class="number">0113</span>     __le32 global_seq;</span><br><span class="line"><span class="number">0114</span>     __le32 connect_seq;</span><br><span class="line"><span class="number">0115</span>     __le32 protocol_version;</span><br><span class="line"><span class="number">0116</span>     __le32 authorizer_len;</span><br><span class="line"><span class="number">0117</span>     __u8 flags;</span><br><span class="line"><span class="number">0118</span> &#125; __attribute__ ((packed));</span><br></pre></td></tr></table></figure></li>
<li>將此資訊記錄下來後，狀態切換成 <strong>STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1071</span>     <span class="keyword">case</span> STATE_CONNECTING_WAIT_CONNECT_REPLY:</span><br><span class="line"><span class="number">1072</span>       &#123;</span><br><span class="line"><span class="number">1073</span>         r = <span class="built_in">read_until</span>(<span class="built_in">sizeof</span>(connect_reply), state_buffer);</span><br><span class="line"><span class="number">1074</span>         <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1075</span>           <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; read connect reply failed&quot;</span> &lt;&lt; dendl;</span><br><span class="line"><span class="number">1076</span>           <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="number">1077</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1078</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1079</span>         &#125;</span><br><span class="line"><span class="number">1080</span></span><br><span class="line"><span class="number">1081</span>         connect_reply = *((ceph_msg_connect_reply*)state_buffer);</span><br><span class="line"><span class="number">1082</span></span><br><span class="line"><span class="number">1083</span>         <span class="built_in">ldout</span>(async_msgr-&gt;cct, <span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; connect got reply tag &quot;</span> &lt;&lt; (<span class="type">int</span>)connect_reply.tag</span><br><span class="line"><span class="number">1084</span>                              &lt;&lt; <span class="string">&quot; connect_seq &quot;</span> &lt;&lt; connect_reply.connect_seq &lt;&lt; <span class="string">&quot; global_seq &quot;</span></span><br><span class="line"><span class="number">1085</span>                              &lt;&lt; connect_reply.global_seq &lt;&lt; <span class="string">&quot; proto &quot;</span> &lt;&lt; connect_reply.protocol_version</span><br><span class="line"><span class="number">1086</span>                              &lt;&lt; <span class="string">&quot; flags &quot;</span> &lt;&lt; (<span class="type">int</span>)connect_reply.flags &lt;&lt; <span class="string">&quot; features &quot;</span></span><br><span class="line"><span class="number">1087</span>                              &lt;&lt; connect_reply.features &lt;&lt; dendl;</span><br><span class="line"><span class="number">1088</span>         state = STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH;</span><br><span class="line"><span class="number">1089</span></span><br><span class="line"><span class="number">1090</span>         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">1091</span>       &#125;</span><br></pre></td></tr></table></figure>


<h2 id="STATE-CONNECTING-WAIT-CONNECT-REPLY-AUTH"><a href="#STATE-CONNECTING-WAIT-CONNECT-REPLY-AUTH" class="headerlink" title="STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH"></a>STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH</h2><ul>
<li>若前述回傳的 <strong>ceph_msg_connect_reply</strong> 有 <strong>authorizer</strong> 的資訊，則進行額外處理。</li>
<li>最後呼叫 <code>handle_connect_reply</code> 進行處理<ul>
<li>理論上 <strong>handle_connect_reply</strong> 會改變當前狀態，最後變成 <strong>STATE_CONNECTING_READY</strong></li>
</ul>
</li>
<li>上述處理完畢後，狀態必須要改變，若沒有代表有問題，直接 <strong>Assert</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1093     case STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH:</span><br><span class="line">1094       &#123;</span><br><span class="line">1095         bufferlist authorizer_reply;</span><br><span class="line">1096         if (connect_reply.authorizer_len) &#123;</span><br><span class="line">1097           ldout(async_msgr-&gt;cct, 10) &lt;&lt; __func__ &lt;&lt; &quot; reply.authorizer_len=&quot; &lt;&lt; connect_reply.authorizer_len &lt;&lt; dendl;</span><br><span class="line">1098           assert(connect_reply.authorizer_len &lt; 4096);</span><br><span class="line">1099           r = read_until(connect_reply.authorizer_len, state_buffer);</span><br><span class="line">1100           if (r &lt; 0) &#123;</span><br><span class="line">1101             ldout(async_msgr-&gt;cct, 1) &lt;&lt; __func__ &lt;&lt; &quot; read connect reply authorizer failed&quot; &lt;&lt; dendl;</span><br><span class="line">1102             goto fail;</span><br><span class="line">1103           &#125; else if (r &gt; 0) &#123;</span><br><span class="line">1104             break;</span><br><span class="line">1105           &#125;</span><br><span class="line">1106</span><br><span class="line">1107           authorizer_reply.append(state_buffer, connect_reply.authorizer_len);</span><br><span class="line">1108           bufferlist::iterator iter = authorizer_reply.begin();</span><br><span class="line">1109           if (authorizer &amp;&amp; !authorizer-&gt;verify_reply(iter)) &#123;</span><br><span class="line">1110             ldout(async_msgr-&gt;cct, 0) &lt;&lt; __func__ &lt;&lt; &quot; failed verifying authorize reply&quot; &lt;&lt; dendl;</span><br><span class="line">1111             goto fail;</span><br><span class="line">1112           &#125;</span><br><span class="line">1113         &#125;</span><br><span class="line">1114         r = handle_connect_reply(connect_msg, connect_reply);</span><br><span class="line">1115         if (r &lt; 0)</span><br><span class="line">1116           goto fail;</span><br><span class="line">1117</span><br><span class="line">1118         // state must be changed!</span><br><span class="line">1119         assert(state != STATE_CONNECTING_WAIT_CONNECT_REPLY_AUTH);</span><br><span class="line">1120         break;</span><br><span class="line">1121       &#125;</span><br></pre></td></tr></table></figure>

<h2 id="STATE-CONNECTING-READY"><a href="#STATE-CONNECTING-READY" class="headerlink" title="STATE_CONNECTING_READY"></a>STATE_CONNECTING_READY</h2><ul>
<li>這邊有個有趣的註解 **&#x2F;&#x2F; hooray!**，代表到這一步連線基本上已經完成了，剩下最後一步驟就結束了。</li>
<li>對 dispatch_queue 設定當前 connection<ul>
<li>dispatch_queue 這邊有兩種類型，一種是存放 message，一種則是 Type + Connection，這邊屬於第二種</li>
<li>在 dispatch_queue 的 loop 中，會針對這兩種去處理，若是 messag 的，則直接將此訊息丟給所有註冊的 dispatcher，反之則根據 type 執行不同的任務</li>
<li>這邊放入的是 D_CONNECT 的 event，所以之後會執行 <code>ms_deliver_handle_connect</code> 這支 function。</li>
<li>接者這支 function 則是會通知所有 dispathcer 目前有新的連線到來，呼叫對應的 <code>ms_handle_connect</code>來處理</li>
</ul>
</li>
<li>呼叫 AsyncMessegner 內的 <strong>ms_deliver_handle_fast_connect</strong><ul>
<li>fast_connect 相對於 connect 是更早會處理的函式，底層可確保此 function 一定會在有任何 message 被處理前先呼叫。</li>
</ul>
</li>
<li>如果當前 queue 內有訊息，這時候再發送一個外部的 write_handler把queue給清空。<ul>
<li>可能是由於先前的 try_send 沒有成功</li>
</ul>
</li>
<li>到這邊後，連線就完成了，可以開始供應用層各種發送訊息了。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1163</span>     <span class="keyword">case</span> STATE_CONNECTING_READY:</span><br><span class="line"><span class="number">1164</span>       &#123;</span><br><span class="line"><span class="number">1165</span>         <span class="comment">// hooray!</span></span><br><span class="line"><span class="number">1166</span>         peer_global_seq = connect_reply.global_seq;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0155</span>     <span class="keyword">while</span> (!mqueue.<span class="built_in">empty</span>()) &#123;</span><br><span class="line"><span class="number">0156</span>       QueueItem qitem = mqueue.<span class="built_in">dequeue</span>();</span><br><span class="line"><span class="number">0157</span>       <span class="keyword">if</span> (!qitem.<span class="built_in">is_code</span>())</span><br><span class="line"><span class="number">0158</span>         <span class="built_in">remove_arrival</span>(qitem.<span class="built_in">get_message</span>());</span><br><span class="line"><span class="number">0159</span>       lock.<span class="built_in">Unlock</span>();</span><br><span class="line"><span class="number">0160</span></span><br><span class="line"><span class="number">0161</span>       <span class="keyword">if</span> (qitem.<span class="built_in">is_code</span>()) &#123;</span><br><span class="line"><span class="number">0162</span>         <span class="keyword">if</span> (cct-&gt;_conf-&gt;ms_inject_internal_delays &amp;&amp;</span><br><span class="line"><span class="number">0163</span>             cct-&gt;_conf-&gt;ms_inject_delay_probability &amp;&amp;</span><br><span class="line"><span class="number">0164</span>             (<span class="built_in">rand</span>() % <span class="number">10000</span>)/<span class="number">10000.0</span> &lt; cct-&gt;_conf-&gt;ms_inject_delay_probability) &#123;</span><br><span class="line"><span class="number">0165</span>           <span class="type">utime_t</span> t;</span><br><span class="line"><span class="number">0166</span>           t.<span class="built_in">set_from_double</span>(cct-&gt;_conf-&gt;ms_inject_internal_delays);</span><br><span class="line"><span class="number">0167</span>           <span class="built_in">ldout</span>(cct, <span class="number">1</span>) &lt;&lt; <span class="string">&quot;DispatchQueue::entry  inject delay of &quot;</span> &lt;&lt; t</span><br><span class="line"><span class="number">0168</span>                         &lt;&lt; dendl;</span><br><span class="line"><span class="number">0169</span>           t.<span class="built_in">sleep</span>();</span><br><span class="line"><span class="number">0170</span>         &#125;</span><br><span class="line"><span class="number">0171</span>         <span class="keyword">switch</span> (qitem.<span class="built_in">get_code</span>()) &#123;</span><br><span class="line"><span class="number">0172</span>         <span class="keyword">case</span> D_BAD_REMOTE_RESET:</span><br><span class="line"><span class="number">0173</span>           msgr-&gt;<span class="built_in">ms_deliver_handle_remote_reset</span>(qitem.<span class="built_in">get_connection</span>());</span><br><span class="line"><span class="number">0174</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0175</span>         <span class="keyword">case</span> D_CONNECT:</span><br><span class="line"><span class="number">0176</span>           msgr-&gt;<span class="built_in">ms_deliver_handle_connect</span>(qitem.<span class="built_in">get_connection</span>());</span><br><span class="line"><span class="number">0177</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0178</span>         <span class="keyword">case</span> D_ACCEPT:</span><br><span class="line"><span class="number">0179</span>           msgr-&gt;<span class="built_in">ms_deliver_handle_accept</span>(qitem.<span class="built_in">get_connection</span>());</span><br><span class="line"><span class="number">0180</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0181</span>         <span class="keyword">case</span> D_BAD_RESET:</span><br><span class="line"><span class="number">0182</span>           msgr-&gt;<span class="built_in">ms_deliver_handle_reset</span>(qitem.<span class="built_in">get_connection</span>());</span><br><span class="line"><span class="number">0183</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0184</span>         <span class="keyword">case</span> D_CONN_REFUSED:</span><br><span class="line"><span class="number">0185</span>           msgr-&gt;<span class="built_in">ms_deliver_handle_refused</span>(qitem.<span class="built_in">get_connection</span>());</span><br><span class="line"><span class="number">0186</span>           <span class="keyword">break</span>;</span><br><span class="line"><span class="number">0187</span>         <span class="keyword">default</span>:</span><br><span class="line"><span class="number">0188</span>           <span class="built_in">ceph_abort</span>();</span><br><span class="line"><span class="number">0189</span>         &#125;</span><br><span class="line"><span class="number">0190</span>       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0191</span>         Message *m = qitem.<span class="built_in">get_message</span>();</span><br><span class="line"><span class="number">0192</span>         <span class="keyword">if</span> (stop) &#123;</span><br><span class="line"><span class="number">0193</span>           <span class="built_in">ldout</span>(cct,<span class="number">10</span>) &lt;&lt; <span class="string">&quot; stop flag set, discarding &quot;</span> &lt;&lt; m &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; *m &lt;&lt; dendl;</span><br><span class="line"><span class="number">0194</span>           m-&gt;<span class="built_in">put</span>();</span><br><span class="line"><span class="number">0195</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">0196</span>           <span class="type">uint64_t</span> msize = <span class="built_in">pre_dispatch</span>(m);</span><br><span class="line"><span class="number">0197</span>           msgr-&gt;<span class="built_in">ms_deliver_dispatch</span>(m);</span><br><span class="line"><span class="number">0198</span>           <span class="built_in">post_dispatch</span>(m, msize);</span><br><span class="line"><span class="number">0199</span>         &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0610</span>   <span class="comment">/**</span></span><br><span class="line"><span class="comment">0611    * Notify each Dispatcher of a new Connection. Call</span></span><br><span class="line"><span class="comment">0612    * this function whenever a new Connection is initiated or</span></span><br><span class="line"><span class="comment">0613    * reconnects.</span></span><br><span class="line"><span class="comment">0614    *</span></span><br><span class="line"><span class="comment">0615    * @param con Pointer to the new Connection.</span></span><br><span class="line"><span class="comment">0616    */</span></span><br><span class="line"><span class="number">0617</span>   <span class="function"><span class="type">void</span> <span class="title">ms_deliver_handle_connect</span><span class="params">(Connection *con)</span> </span>&#123;</span><br><span class="line"><span class="number">0618</span>     <span class="keyword">for</span> (list&lt;Dispatcher*&gt;::iterator p = dispatchers.<span class="built_in">begin</span>();</span><br><span class="line"><span class="number">0619</span>          p != dispatchers.<span class="built_in">end</span>();</span><br><span class="line"><span class="number">0620</span>          ++p)</span><br><span class="line"><span class="number">0621</span>       (*p)-&gt;<span class="built_in">ms_handle_connect</span>(con);</span><br><span class="line"><span class="number">0622</span>   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0110</span>   <span class="comment">/**</span></span><br><span class="line"><span class="comment">0111    * This function will be called synchronously whenever a Connection is</span></span><br><span class="line"><span class="comment">0112    * newly-created or reconnects in the Messenger, if you support fast</span></span><br><span class="line"><span class="comment">0113    * dispatch. It is guaranteed to be called before any messages are</span></span><br><span class="line"><span class="comment">0114    * dispatched.</span></span><br><span class="line"><span class="comment">0115    *</span></span><br><span class="line"><span class="comment">0116    * @param con The new Connection which has been established. You are not</span></span><br><span class="line"><span class="comment">0117    * granted a reference to it -- take one if you need one!</span></span><br><span class="line"><span class="comment">0118    */</span></span><br><span class="line"><span class="number">0119</span>   <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">ms_handle_fast_connect</span><span class="params">(Connection *con)</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<p>上述在 <strong>Accpeting</strong> 或者是 <strong>Connecting</strong> 的過程中，會透過下列兩個方式做一些深層的處理，這些處理同時會改變當前狀態，這邊就簡單大致上看過而已。</p>
<h2 id="handle-connect-reply"><a href="#handle-connect-reply" class="headerlink" title="handle_connect_reply"></a>handle_connect_reply</h2><ul>
<li>根據 reply 內的 tag 類型來執行各種不同事情, 大部分都是錯誤相關的處理，若一切都正常的話，則會是<code>CEPH_MSGR_TAG_READY</code>，此時會將狀態切換成 STATE_CONNECTING_READY<ul>
<li>CEPH_MSGR_TAG_FEATURES</li>
<li>CEPH_MSGR_TAG_BADPROTOVER</li>
<li>CEPH_MSGR_TAG_BADAUTHORIZER</li>
<li>CEPH_MSGR_TAG_RESETSESSION</li>
<li>CEPH_MSGR_TAG_RETRY_GLOBAL</li>
<li>CEPH_MSGR_TAG_RETRY_SESSION</li>
<li>CEPH_MSGR_TAG_WAIT</li>
<li>CEPH_MSGR_TAG_SEQ</li>
<li>CEPH_MSGR_TAG_READY</li>
</ul>
</li>
</ul>
<h2 id="handle-connect-msg"><a href="#handle-connect-msg" class="headerlink" title="handle_connect_msg"></a>handle_connect_msg</h2><ul>
<li>根據 peer type 取得對應的 proto_version，放到 ceph_msg_connect_reply 的變數中<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0671</span>       <span class="keyword">case</span> CEPH_ENTITY_TYPE_OSD: <span class="keyword">return</span> CEPH_OSDC_PROTOCOL;</span><br><span class="line"><span class="number">0672</span>       <span class="keyword">case</span> CEPH_ENTITY_TYPE_MDS: <span class="keyword">return</span> CEPH_MDSC_PROTOCOL;</span><br><span class="line"><span class="number">0673</span>       <span class="keyword">case</span> CEPH_ENTITY_TYPE_MON: <span class="keyword">return</span> CEPH_MONC_PROTOCOL;</span><br></pre></td></tr></table></figure></li>
<li>若兩邊的 proto_version 不一致，則呼叫 <code>_reply_aceept</code> 去處理。</li>
<li>若對方有要使用 cephX<ul>
<li>根據不同的 protocol type (OSD&#x2F;MDS&#x2F;MOM) 進行不同的處理</li>
</ul>
</li>
<li>檢查兩邊的 feature set 是否滿足彼此，若有問題則呼叫 <code>_reply_accept</code> 去處理</li>
<li>進行用戶驗證，失敗則呼叫 <code>_reply_accept</code></li>
<li>若以前 peer addr 曾經有 connection 存在過，這時候就要進行一些處理，主要的處理都是基於兩個變數來決定，global_seq 以及 connect_seq<ul>
<li>global_seq 代表的是這個host已經建立過多少條 connection</li>
<li>connect_seq 代表的是這個 session建立過多少條 connection</li>
</ul>
</li>
<li>某些情況下，會嘗試捨棄舊有的 connection 並建立新的 connection 來使用</li>
<li>某些情況則是會繼續使用舊有的 connection，然後把一些新的資訊賦予到舊有 connection 的成員中</li>
<li>呼叫 accept_conn 將連線給記錄下來放到 conns 中，並且從 accepting_conns 中移除，</li>
<li>最後則將狀態改成 STATE_ACCEPTING_WAIT_SEQ</li>
</ul>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>此 <strong>AsyncConnection</strong> 內容眾多，目前先主要觀察到整個建立連線的步驟，包含了 <strong>Accept</strong> 以及 <strong>connect</strong> 。<br>有機會再來把 <strong>read&#x2F;write</strong> 相關的介面也都看一次，到時候可以更瞭解整體收送的行為。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/hw_chiu">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/technologynote">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Network/" rel="tag"># Network</a>
              <a href="/tags/SourceCode/" rel="tag"># SourceCode</a>
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/Ceph/" rel="tag"># Ceph</a>
              <a href="/tags/SDS/" rel="tag"># SDS</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/docker-hexo-ii.html" rel="prev" title="Docker image for Hexo (二)">
                  <i class="fa fa-chevron-left"></i> Docker image for Hexo (二)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blktrace-example.html" rel="next" title="Blktrace, Blkparse and Fio example">
                  Blktrace, Blkparse and Fio example <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hwchiu</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"hwchiu/blog-comment","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
