"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[71222],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>m});var a=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var c=a.createContext({}),s=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},d=function(e){var n=s(e.components);return a.createElement(c.Provider,{value:n},e.children)},p="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},k=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,c=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),p=s(t),k=i,m=p["".concat(c,".").concat(k)]||p[k]||u[k]||r;return t?a.createElement(m,o(o({ref:n},d),{},{components:t})):a.createElement(m,o({ref:n},d))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,o=new Array(r);o[0]=k;var l={};for(var c in n)hasOwnProperty.call(n,c)&&(l[c]=n[c]);l.originalType=e,l[p]="string"==typeof e?e:i,o[1]=l;for(var s=2;s<r;s++)o[s]=t[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}k.displayName="MDXCreateElement"},95602:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var a=t(87462),i=(t(67294),t(3905));const r={title:"Kubernetes & CRI (II) - containerd",sidebar_position:5,date:new Date("2019-09-21T07:12:36.000Z"),tags:["Kubernetes","CRI","Container","iThome"],description:"\u672c\u6587\u4ecb\u7d39\u4e86 `containerd \u7684\u6982\u5ff5\uff0c\u4e26\u4e14\u5617\u8a66\u5efa\u7f6e\u4e00\u500b\u57fa\u65bc containerd \u7684 kubernetes cluster, \u8b93\u5927\u5bb6\u9ad4\u9a57\u770b\u770b\u4f48\u6a01 docker \u4e5f\u53ef\u4ee5\u904b\u884c kubernetes \u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u540c\u6642\u4e5f\u53ef\u4ee5\u5b78\u7fd2\u5230\u662f\u5982\u4f55\u900f\u904e\u8a2d\u5b9a\u4f86\u6539\u8b8a kubernetes \u9019\u4e00\u9023\u4e32\u7684\u884c\u70ba\u7684\u3002"},o="\u524d\u8a00",l={unversionedId:"techPost/2019/iThome_Challenge/k8s-cri-ii",id:"techPost/2019/iThome_Challenge/k8s-cri-ii",title:"Kubernetes & CRI (II) - containerd",description:"\u672c\u6587\u4ecb\u7d39\u4e86 `containerd \u7684\u6982\u5ff5\uff0c\u4e26\u4e14\u5617\u8a66\u5efa\u7f6e\u4e00\u500b\u57fa\u65bc containerd \u7684 kubernetes cluster, \u8b93\u5927\u5bb6\u9ad4\u9a57\u770b\u770b\u4f48\u6a01 docker \u4e5f\u53ef\u4ee5\u904b\u884c kubernetes \u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u540c\u6642\u4e5f\u53ef\u4ee5\u5b78\u7fd2\u5230\u662f\u5982\u4f55\u900f\u904e\u8a2d\u5b9a\u4f86\u6539\u8b8a kubernetes \u9019\u4e00\u9023\u4e32\u7684\u884c\u70ba\u7684\u3002",source:"@site/docs/techPost/2019/iThome_Challenge/k8s-cri-ii.md",sourceDirName:"techPost/2019/iThome_Challenge",slug:"/techPost/2019/iThome_Challenge/k8s-cri-ii",permalink:"/docs/techPost/2019/iThome_Challenge/k8s-cri-ii",draft:!1,tags:[{label:"Kubernetes",permalink:"/docs/tags/kubernetes"},{label:"CRI",permalink:"/docs/tags/cri"},{label:"Container",permalink:"/docs/tags/container"},{label:"iThome",permalink:"/docs/tags/i-thome"}],version:"current",sidebarPosition:5,frontMatter:{title:"Kubernetes & CRI (II) - containerd",sidebar_position:5,date:"2019-09-21T07:12:36.000Z",tags:["Kubernetes","CRI","Container","iThome"],description:"\u672c\u6587\u4ecb\u7d39\u4e86 `containerd \u7684\u6982\u5ff5\uff0c\u4e26\u4e14\u5617\u8a66\u5efa\u7f6e\u4e00\u500b\u57fa\u65bc containerd \u7684 kubernetes cluster, \u8b93\u5927\u5bb6\u9ad4\u9a57\u770b\u770b\u4f48\u6a01 docker \u4e5f\u53ef\u4ee5\u904b\u884c kubernetes \u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u540c\u6642\u4e5f\u53ef\u4ee5\u5b78\u7fd2\u5230\u662f\u5982\u4f55\u900f\u904e\u8a2d\u5b9a\u4f86\u6539\u8b8a kubernetes \u9019\u4e00\u9023\u4e32\u7684\u884c\u70ba\u7684\u3002"},sidebar:"techPost",previous:{title:"Kubernetes & CRI (I)",permalink:"/docs/techPost/2019/iThome_Challenge/k8s-cri-i"},next:{title:"Container Runtime - CRI-O",permalink:"/docs/techPost/2019/iThome_Challenge/k8s-cri-o"}},c={},s=[{value:"\u74b0\u5883\u9700\u6c42",id:"\u74b0\u5883\u9700\u6c42",level:2},{value:"\u74b0\u5883\u5b89\u88dd",id:"\u74b0\u5883\u5b89\u88dd",level:2},{value:"Ansible \u7248\u672c",id:"ansible-\u7248\u672c",level:3},{value:"\u624b\u52d5\u5b89\u88dd\u7248\u672c",id:"\u624b\u52d5\u5b89\u88dd\u7248\u672c",level:3},{value:"Kubernetes Cluster",id:"kubernetes-cluster",level:2},{value:"Containerd",id:"containerd",level:2},{value:"Docker",id:"docker",level:2}],d={toc:s},p="wrapper";function u(e){let{components:n,...t}=e;return(0,i.kt)(p,(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"\u524d\u8a00"},"\u524d\u8a00"),(0,i.kt)("p",null,"\u524d\u7bc7\u6587\u7ae0\u4e2d\u8ddf\u5927\u5bb6\u63a2\u8a0e\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u5167\u95dc\u65bc\u5bb9\u5668\u904b\u884c\u6a19\u6e96\u5316\u7684\u67b6\u69cb\uff0c\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"Container Runtime Interface")," \u8207\u5404\u5f0f\u5404\u6a23\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"Container Runtime")," \u89e3\u6c7a\u65b9\u6848\u6e9d\u901a\uff0c\u53ef\u4ee5\u8b93 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u672c\u8eab\u53ea\u9700\u8981\u5c08\u6ce8\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"kubelet")," \u4ee5\u53ca ",(0,i.kt)("inlineCode",{parentName:"p"},"CRI \u6a19\u6e96")," \u7684\u4e92\u52d5\uff0c\u7b2c\u4e09\u65b9\u958b\u767c\u8005\u5247\u53ef\u4ee5\u6839\u64da\u9700\u6c42\u958b\u767c\u51fa\u5404\u5f0f\u5404\u6a23\u4e0d\u540c\u7684\u7522\u54c1\uff0c\u53ea\u8981\u80fd\u5920\u6eff\u8db3 ",(0,i.kt)("inlineCode",{parentName:"p"},"CRI \u6a19\u6e96")," \u5373\u53ef\u3002"),(0,i.kt)("p",null,"\u5c31\u6211\u6240\u77e5\uff0c\u76ee\u524d\u76f8\u5bb9\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"CRI")," \u7684\u89e3\u6c7a\u65b9\u6848\u53ef\u6839\u64da\u5176\u67b6\u69cb\u5206\u6210\u4e09\u5927\u985e\uff0c\u5206\u5225\u662f"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u771f\u7684\u662f\u8f15\u91cf\u7d1a\u865b\u64ec\u5316\u7684\u5bb9\u5668"),(0,i.kt)("li",{parentName:"ul"},"\u80cc\u5f8c\u662f\u865b\u64ec\u6a5f\u5668\uff0c\u4f46\u662f\u537b\u904b\u4f5c\u8d77\u4f86\u50cf\u8f15\u91cf\u7d1a\u865b\u64ec\u5316\u7684\u5bb9\u5668"),(0,i.kt)("li",{parentName:"ul"},"\u771f\u7684\u662f\u50b3\u7d71\u865b\u64ec\u6a5f\u5668")),(0,i.kt)("p",null,"\u63a5\u4e0b\u4f86\u7684\u6578\u7bc7\u6587\u7ae0\u6703\u6839\u64da\u6bcf\u500b\u985e\u5225\u8a73\u7d30\u4ecb\u7d39\u4e00\u7a2e\u89e3\u6c7a\u65b9\u6848\uff0c\u4e26\u63a2\u8a0e\u8a2d\u8a08\u7406\u5ff5\u8207\u67b6\u69cb\uff0c\u8207\u6b64\u540c\u6642\u5927\u5bb6\u4e5f\u53ef\u4ee5\u601d\u8003\u81ea\u5df1\u7684\u74b0\u5883\u662f\u4e0d\u662f\u6709\u53ef\u80fd\u53ef\u4ee5\u642d\u8f09\u5176\u4ed6\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u800c\u975e\u6c38\u9060\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"Docker")," ?"),(0,i.kt)("p",null,"\u672c\u7bc7\u6703\u5148\u900f\u904e\u4e00\u500b\u7c21\u55ae\u7684\u74b0\u5883\u5be6\u9a57\u4f86\u5e36\u904e\u5982\u4f55\u5efa\u7f6e\u4e00\u500b\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u74b0\u5883\uff0c\u53ef\u4ee5\u9ad4\u9a57\u5230\u4e0d\u5b89\u88dd ",(0,i.kt)("inlineCode",{parentName:"p"},"docker")," \u4e5f\u53ef\u4ee5\u904b\u884c\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u53e2\u96c6\uff0c \u540c\u6642\u4e4b\u5f8c\u82e5\u5b89\u88dd\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"docker")," \u4e5f\u53ef\u4ee5\u89c0\u5bdf\u5230\u662f\u5426\u771f\u7684\u5982\u4e0a\u7bc7\u6587\u7ae0\u6240\u8aaa\uff0c ",(0,i.kt)("inlineCode",{parentName:"p"},"docker")," \u8207 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u672c\u8eab\u5275\u9020\u51fa\u4f86\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"container")," \u662f\u4e92\u76f8\u4e0d\u5e72\u6d89\u7684\u3002"),(0,i.kt)("h1",{id:"\u74b0\u5883\u5efa\u7f6e"},"\u74b0\u5883\u5efa\u7f6e"),(0,i.kt)("p",null,"\u63a5\u4e0b\u4f86\u7684\u5efa\u7f6e\u74b0\u5883\u8207\u6b65\u9a5f\u662f\u53c3\u8003 ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/containerd/cri/tree/master/contrib/ansible"},"Containerd GitHub")," \u6fc3\u7e2e\u7684\u3002"),(0,i.kt)("h2",{id:"\u74b0\u5883\u9700\u6c42"},"\u74b0\u5883\u9700\u6c42"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"OS: Ubuntu 16.04",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"18.04 \u6703\u56e0\u70ba ",(0,i.kt)("inlineCode",{parentName:"li"},"kubernetes deb")," \u76f8\u95dc\u7684\u554f\u984c\u5c0e\u81f4\u5957\u4ef6\u66f4\u65b0\u5931\u6557\uff0c\u5efa\u8b70\u5148\u57fa\u65bc ",(0,i.kt)("inlineCode",{parentName:"li"},"16.04")," \u6e2c\u8a66\u5373\u53ef"))),(0,i.kt)("li",{parentName:"ul"},"Python: 2.7+"),(0,i.kt)("li",{parentName:"ul"},"Ansible: 2.4+",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"\u6709\u6c92\u6709\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"ansible")," \u90fd\u7121\u6240\u8b02\uff0c\u56e0\u70ba\u6211\u5011\u6703\u62c6\u89e3\u88e1\u9762\u7684\u6b65\u9a5f\uff0c\u53bb\u770b\u770b\u5168\u90e8\u7684\u5b89\u88dd\u6b65\u9a5f"),(0,i.kt)("li",{parentName:"ul"})))),(0,i.kt)("h2",{id:"\u74b0\u5883\u5b89\u88dd"},"\u74b0\u5883\u5b89\u88dd"),(0,i.kt)("p",null,"\u74b0\u5883\u7684\u90e8\u5206\u53ea\u6709\u5305\u62ec ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u7684\u76f8\u4f9d\u5957\u4ef6\uff0c\u4e26\u4e0d\u5305\u542b ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u53e2\u96c6\u672c\u8eab\uff0c\u4f46\u662f\u6709\u5305\u542b ",(0,i.kt)("inlineCode",{parentName:"p"},"kubeadm"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"kubelet")," \u76f8\u95dc\u5957\u4ef6\u3002"),(0,i.kt)("h3",{id:"ansible-\u7248\u672c"},"Ansible \u7248\u672c"),(0,i.kt)("p",null,"\u57fa\u672c\u4e0a\u5b98\u65b9\u6587\u4ef6\u5df2\u7d93\u5c07\u76f8\u95dc\u7684\u6b65\u9a5f\u90fd\u5efa\u7f6e\u5b8c\u7562\uff0c\u672c\u8eab\u53ea\u9700\u8981\u6e96\u5099 ",(0,i.kt)("inlineCode",{parentName:"p"},"hosts")," \u7684\u6a94\u6848\u5373\u53ef\uff0c\u8a72 ",(0,i.kt)("inlineCode",{parentName:"p"},"ansible playbook")," \u652f\u63f4 ",(0,i.kt)("inlineCode",{parentName:"p"},"Ubuntu")," \u4ee5\u53ca ",(0,i.kt)("inlineCode",{parentName:"p"},"CentOS")," \u5169\u5957\u767c\u884c\u7248\u672c\u3002"),(0,i.kt)("p",null,"\u9996\u5148\u5728 ",(0,i.kt)("inlineCode",{parentName:"p"},"ansible host")," \u57f7\u884c\u4e0b\u5217\u6307\u4ee4\u6293\u53d6\u76f8\u95dc\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"ansible-playbook")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"git clone https://github.com/containerd/cri\ncd ./cri/contrib/ansible\n")),(0,i.kt)("p",null,"\u63a5\u4e0b\u4f86\u6839\u64da\u9700\u6c42\u7522\u751f\u5c0d\u61c9\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"hosts")," \u6a94\u6848\uff0c\u88e1\u9762\u653e\u7f6e\u8981\u88ab\u5b89\u88dd\u7684\u6a5f\u5668\uff0c\u6216\u662f\u76f4\u63a5\u63a1\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"localhost")," \u7684\u65b9\u5f0f\u518d\u672c\u6a5f\u904b\u884c\u8a72 ",(0,i.kt)("inlineCode",{parentName:"p"},"playbook")," \u5373\u53ef\u3002\n\u9019\u90e8\u5206\u6bd4\u8f03\u5c6c\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"ansible")," \u7684\u65b9\u5f0f\uff0c\u4e0d\u719f\u6089\u7684\u8b80\u8005\u53ef\u4ee5\u81ea\u884c\u5c0b\u627e\u8cc7\u6e90\u770b\u770b\u5982\u4f55\u904b\u884c\uff0c\u6216\u662f\u653e\u68c4\u63a1\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"ansible"),", \u800c\u662f\u9010\u689d\u9010\u689d\u7684\u81ea\u884c\u5b89\u88dd"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"ansible-playbook -i hosts cri-containerd.yaml\n")),(0,i.kt)("p",null,"\u9806\u5229\u8dd1\u5b8c\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u4e0b\u5716\u7684\u7d50\u679c"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"...\nTASK [Create a directory for cni binary] ***********************************************************************************************************************************$\nchanged: [localhost]\n\nTASK [Create a directory for cni config files] *****************************************************************************************************************************$\nchanged: [localhost]\n\nTASK [Create a directory for containerd config] ****************************************************************************************************************************$\nchanged: [localhost]\n\nTASK [Start Containerd] ****************************************************************************************************************************************************$changed: [localhost]\n\nTASK [Load br_netfilter kernel module] *************************************************************************************************************************************$\nchanged: [localhost]\n\nTASK [Set bridge-nf-call-iptables] *****************************************************************************************************************************************$\nchanged: [localhost]\n\nTASK [Set ip_forward] ******************************************************************************************************************************************************$\nchanged: [localhost]\n\nTASK [Check kubelet args in kubelet config] ********************************************************************************************************************************$\nchanged: [localhost]\n\nTASK [Add runtime args in kubelet conf] ************************************************************************************************************************************$\nskipping: [localhost]\n\nTASK [Start Kubelet] *******************************************************************************************************************************************************$\nchanged: [localhost]\n\nTASK [Pre-pull pause container image] **************************************************************************************************************************************$\nchanged: [localhost]\n\nPLAY RECAP ******************************************************************************************************************************************************************\n...\n\n")),(0,i.kt)("h3",{id:"\u624b\u52d5\u5b89\u88dd\u7248\u672c"},"\u624b\u52d5\u5b89\u88dd\u7248\u672c"),(0,i.kt)("p",null,"\u5982\u679c\u4e0d\u60f3\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"ansible")," \u4e00\u9375\u5b89\u88dd\u5b8c\u7562\uff0c\u63a5\u4e0b\u4f86\u900f\u904e\u62c6\u89e3\u8a72 ",(0,i.kt)("inlineCode",{parentName:"p"},"ansible playbook")," \u5c31\u53ef\u4ee5\u77e5\u9053\u5be6\u969b\u4e0a\u8981\u505a\u54ea\u4e9b\u6b65\u9a5f\u4f86\u5efa\u7f6e ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u7684\u74b0\u5883\u3002"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u8b80\u53d6\u4e0b\u5217\u8b8a\u6578 ",(0,i.kt)("inlineCode",{parentName:"li"},"var/vars.yaml"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"- containerd_release_version: 1.1.0-rc.0\n- cni_bin_dir: /opt/cni/bin/\n- cni_conf_dir: /etc/cni/net.d/\n")),"\u7b2c\u4e00\u500b\u6307\u660e ",(0,i.kt)("inlineCode",{parentName:"li"},"containerd")," \u7684\u7248\u672c\u5f8c\uff0c\u5f8c\u7e8c\u5169\u500b\u8b8a\u6578\u5247\u662f ",(0,i.kt)("inlineCode",{parentName:"li"},"CNI (Container Network Interface)")," \u6703\u7528\u5230\u7684\u8def\u5f91\uff0c\u4e4b\u5f8c\u7684\u6587\u7ae0\u6703\u7d30\u90e8\u63a2\u8a0e ",(0,i.kt)("inlineCode",{parentName:"li"},"CNI")," \u7684\u8a2d\u8a08\u8207\u4f7f\u7528\u3002"),(0,i.kt)("li",{parentName:"ol"},"\u6839\u64da\u767c\u884c\u7248\u672c\u8b80\u53d6\u4e0d\u540c\u7684\u6a94\u6848\u4f86\u5b89\u88dd\u76f8\u95dc\u5957\u4ef6 (Ubuntu \u70ba\u7bc4\u4f8b)",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"unzip"),(0,i.kt)("li",{parentName:"ul"},"tar"),(0,i.kt)("li",{parentName:"ul"},"apt-transport-https"),(0,i.kt)("li",{parentName:"ul"},"btrfs-tools"),(0,i.kt)("li",{parentName:"ul"},"libseccomp2"),(0,i.kt)("li",{parentName:"ul"},"socat"),(0,i.kt)("li",{parentName:"ul"},"util-linux"))),(0,i.kt)("li",{parentName:"ol"},"\u5b89\u88dd ",(0,i.kt)("inlineCode",{parentName:"li"},"kubernetes")," \u6703\u7528\u5230\u7684\u76f8\u95dc\u5de5\u5177",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"kubelet"),(0,i.kt)("li",{parentName:"ul"},"kubeadm"),(0,i.kt)("li",{parentName:"ul"},"kubectl"))),(0,i.kt)("li",{parentName:"ol"},"\u5b89\u88dd ",(0,i.kt)("inlineCode",{parentName:"li"},"containerd")," \u6703\u7528\u5230\u7684\u76f8\u95dc\u5de5\u5177",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"cri-containerd"),(0,i.kt)("li",{parentName:"ul"},"\u4f86\u6e90\u7db2\u5740\u662f ",(0,i.kt)("a",{parentName:"li",href:"https://storage.googleapis.com/cri-containerd-release"},"https://storage.googleapis.com/cri-containerd-release"),", \u9ede\u9032\u53bb\u53ef\u4ee5\u770b\u5230\u5404\u7a2e\u4e0d\u540c\u7248\u672c\u7684 ",(0,i.kt)("inlineCode",{parentName:"li"},"cri-containerd"),"."),(0,i.kt)("li",{parentName:"ul"},"\u89e3\u58d3\u7e2e\u8a72\u5b89\u88dd\u6a94\u6848\u5f8c\u53ef\u4ee5\u770b\u5230\u6709\u4e0b\u5217\u5167\u5bb9\uff0c\u5305\u542b\u4e86 ",(0,i.kt)("inlineCode",{parentName:"li"},"systemd")," \u7684\u8a2d\u5b9a\uff0c\u76f8\u95dc\u7684\u57f7\u884c\u6a94\u6848\u3002")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"./\n./opt/\n./opt/containerd/\n./opt/containerd/cluster/\n./opt/containerd/cluster/gce/\n./opt/containerd/cluster/gce/cloud-init/\n./opt/containerd/cluster/gce/cloud-init/node.yaml\n./opt/containerd/cluster/gce/cloud-init/master.yaml\n./opt/containerd/cluster/gce/configure.sh\n./opt/containerd/cluster/gce/env\n./opt/containerd/cluster/version\n./opt/containerd/cluster/health-monitor.sh\n./usr/\n./usr/local/\n./usr/local/sbin/\n./usr/local/sbin/runc\n./usr/local/bin/\n./usr/local/bin/crictl\n./usr/local/bin/containerd\n./usr/local/bin/containerd-stress\n./usr/local/bin/critest\n./usr/local/bin/containerd-release\n./usr/local/bin/containerd-shim\n./usr/local/bin/ctr\n./etc/\n./etc/systemd/\n./etc/systemd/system/\n./etc/systemd/system/containerd.service\n./etc/crictl.yaml\n")),(0,i.kt)("ol",{start:7},(0,i.kt)("li",{parentName:"ol"},"\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"li"},"systemd")," \u555f\u52d5 ",(0,i.kt)("inlineCode",{parentName:"li"},"containerd")),(0,i.kt)("li",{parentName:"ol"},"\u8a2d\u5b9a ",(0,i.kt)("inlineCode",{parentName:"li"},"netfilter")," \u76f8\u95dc\u8a2d\u5b9a\uff0c\u8b93 ",(0,i.kt)("inlineCode",{parentName:"li"},"kernel")," \u555f\u52d5\u76f8\u95dc\u529f\u80fd",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"- br_netfilter -> bridge \u5c64\u7d1a\u555f\u52d5 netfilter (ebtables)\n- bridge-nf-call-iptables -> bridge \u5c64\u7d1a\u4e5f\u6703\u53bb\u547c\u53eb iptables \u8655\u7406\n- ip_forward -> \u8f49\u767c ip \u5c01\u5305\n")),"\u9019\u4e9b\u529f\u80fd\u57fa\u672c\u4e0a\u4ee5\u524d\u5b89\u88dd ",(0,i.kt)("inlineCode",{parentName:"li"},"docker")," \u7684\u6642\u5019\u90fd\u6703\u5e6b\u5fd9\u8655\u7406\uff0c\u6240\u4ee5\u57fa\u672c\u4e0a\u90fd\u4e0d\u6703\u7279\u5225\u6ce8\u610f\u5230"),(0,i.kt)("li",{parentName:"ol"},"\u63a5\u4e0b\u4f86\u5c31\u662f\u91cd\u982d\u6232\u4e86\uff0c\u5982\u4f55\u8b93 ",(0,i.kt)("inlineCode",{parentName:"li"},"kubernetes")," \u77e5\u9053\u8981\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"containerd")," \u4f5c\u70ba\u5176 ",(0,i.kt)("inlineCode",{parentName:"li"},"Container Runtime")," \u800c\u975e\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"dockershim")," \u4f86\u929c\u63a5 ",(0,i.kt)("inlineCode",{parentName:"li"},"docker"),".\n\u6839\u64da ",(0,i.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/"},"\u5b98\u65b9\u6587\u4ef6"),"\uff0c ",(0,i.kt)("inlineCode",{parentName:"li"},"kubelet")," \u88e1\u9762\u6709\u4e0b\u5217\u7684\u53c3\u6578\u53ef\u4ee5\u8a2d\u5b9a",(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},"--container-runtime string\nThe container runtime to use. Possible values: 'docker', 'remote', 'rkt(deprecated)'. (default \"docker\")\n--container-runtime-endpoint string\n","[Experimental]"," The endpoint of remote runtime service. Currently unix socket is supported on Linux, and tcp is supported on windows.")))),(0,i.kt)("p",null,"\u5176\u4e2d ",(0,i.kt)("inlineCode",{parentName:"p"},"container-runtime")," \u53ef\u4ee5\u4f7f\u7528\u4e09\u7a2e\u4f86\u8655\u7406\uff0c\u5206\u5225\u662f\u5167\u5efa\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"docker"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"rkt")," \u4ee5\u53ca\u5ba2\u88fd\u5316\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"remote"),".\n\u7576\u4e0a\u8ff0\u9078\u64c7\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"remote")," \u5f8c\uff0c\u4e5f\u5fc5\u9808\u8981\u4e00\u8d77\u8a2d\u5b9a ",(0,i.kt)("inlineCode",{parentName:"p"},"container-runtime-endpoint")," \u544a\u8a34 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubelet")," \u9019\u6642\u5019\u8981\u600e\u9ebc\u8ddf\u975e\u5167\u5efa\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"container runtime")," \u6e9d\u901a\u3002"),(0,i.kt)("p",null,"\u56e0\u6b64\u5b89\u88dd\u904e\u7a0b\u4e2d\uff0c\u8a72 ",(0,i.kt)("inlineCode",{parentName:"p"},"ansible playbook")," \u5c31\u6703\u5617\u8a66\u4fee\u6539 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubelet")," \u7684\u555f\u52d5\u53c3\u6578\uff0c\u9019\u90e8\u5206\u56e0\u70ba\u6574\u500b\u5b89\u88dd\u904e\u7a0b\u90fd\u662f\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"kubeadm")," \u53bb\u67b6\u8a2d ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes cluster"),", \u6240\u4ee5\u6700\u5f8c\u662f\u4fee\u6539 ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/systemd/system/kubelet.service.d/10-kubeadm.conf")," \u9019\u500b\u6a94\u6848. \u95dc\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"kubeadm")," \u8207 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubelet")," \u5f7c\u6b64\u4e4b\u9593\u7684\u8a2d\u5b9a\u904e\u7a0b\u53ef\u4ee5\u53c3\u8003\u4e0b\u5217\u6587\u7ae0 ",(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/kubelet-integration/#the-kubelet-drop-in-file-for-systemd"},"kubeadm/kubelet-integration")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},'vagrant@k8s-dev:~$ sudo cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n# Note: This dropin only works with kubeadm and kubelet v1.11+\n[Service]\nEnvironment="KUBELET_EXTRA_ARGS= --runtime-cgroups=/system.slice/containerd.service --container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock"\nEnvironment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"\nEnvironment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"\n# This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically\nEnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env\n# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use\n# the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.\nEnvironmentFile=-/etc/default/kubelet\nExecStart=\nExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS\n')),(0,i.kt)("p",null,"\u7576\u6211\u5011\u5be6\u969b\u89c0\u5bdf\u9019\u500b\u6a94\u6848\uff0c\u53ef\u4ee5\u767c\u73fe\u88e1\u9762\u95dc\u65bc\u74b0\u5883\u8b8a\u6578\u7684\u90e8\u5206\u52a0\u5165\u4e86\u4e0b\u5217\u9078\u9805\uff0c\u9019\u6642\u5019\u6211\u5011\u5c31\u660e\u77ad\u5230\u5e95 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u4e4b\u5f8c\u662f\u5982\u4f55\u8ddf ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u6e9d\u901a\u7684\n",(0,i.kt)("inlineCode",{parentName:"p"},'--container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock"')),(0,i.kt)("ol",{start:10},(0,i.kt)("li",{parentName:"ol"},"\u6700\u5f8c\u5c31\u662f\u555f\u52d5 ",(0,i.kt)("inlineCode",{parentName:"li"},"kubelet")," \u5c07\u57fa\u672c\u7684\u670d\u52d9\u8d77\u4f86")),(0,i.kt)("h2",{id:"kubernetes-cluster"},"Kubernetes Cluster"),(0,i.kt)("p",null,"\u4e00\u5207\u90fd\u6e96\u5099\u5c31\u7dd2\u5f8c\uff0c\u63a5\u4e0b\u4f86\u975e\u5e38\u7c21\u55ae\u7684\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"kubeadm")," \u7684\u65b9\u5f0f\u4f86\u5275\u5efa ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes cluster"),".\n\u9019\u500b\u7bc4\u4f8b\u4e2d\u6211\u63a1\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"flannel")," \u4f5c\u70ba CNI, \u4e4b\u5f8c\u4e5f\u6703\u6709\u6587\u7ae0\u8a73\u7d30\u4ecb\u7d39 ",(0,i.kt)("inlineCode",{parentName:"p"},"Flannel")," \u7684\u904b\u4f5c\u539f\u7406\u3002"),(0,i.kt)("p",null,"\u4f9d\u5e8f\u57f7\u884c\u4e0b\u5217\u6307\u4ee4\u5c07 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes cluster")," \u7d66\u5efa\u7acb\u8d77\u4f86\uff0c\u4e26\u5b89\u88dd ",(0,i.kt)("inlineCode",{parentName:"p"},"CNI")," \u540c\u6642\u4e5f\u6253\u958b\n",(0,i.kt)("inlineCode",{parentName:"p"},"taint")," \u8b93 ",(0,i.kt)("inlineCode",{parentName:"p"},"master node")," \u4e5f\u53ef\u4ee5\u90e8\u7f72 ",(0,i.kt)("inlineCode",{parentName:"p"},"Pod"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"sudo swapoff -a && sudo sysctl -w vm.swappiness=0\nsudo kubeadm init --pod-network-cidr=10.244.0.0/16\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\nkubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml\nkubectl taint nodes --all node-role.kubernetes.io/master-\n")),(0,i.kt)("p",null,"\u9019\u6642\u5019\u4f7f\u7528\u7c21\u55ae\u7684\u5de5\u5177\u78ba\u8a8d ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u6709\u6b63\u5e38\u8d77\u4f86\u5373\u53ef"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~/cri/contrib/ansible$ kubectl get pods --all-namespaces\nNAMESPACE     NAME                          READY   STATUS    RESTARTS   AGE\nkube-system   coredns-5c98db65d4-ghzpl      0/1     Running   0          26s\nkube-system   coredns-5c98db65d4-thsdq      0/1     Running   0          26s\nkube-system   kube-flannel-ds-amd64-ztqgs   1/1     Running   0          14s\nkube-system   kube-proxy-jfs66              1/1     Running   0          26s\n")),(0,i.kt)("h1",{id:"\u89c0\u5bdf"},"\u89c0\u5bdf"),(0,i.kt)("h2",{id:"containerd"},"Containerd"),(0,i.kt)("p",null,"\u63a5\u4e0b\u4f86\u6211\u5011\u8981\u900f\u904e\u4e0d\u540c\u7684\u5de5\u5177\u4f86\u89c0\u5bdf\u7576\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u4f5c\u70ba\u90e8\u7f72\u6642\u6709\u4ec0\u9ebc\u4e0d\u540c"),(0,i.kt)("p",null,"\u7531\u65bc\u6b64\u6642\u6211\u5011\u4e0d\u662f\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"docker")," \u4f86\u7ba1\u7406\u6574\u500b ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u5e95\u5c64\u9700\u8981\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"container"),"\uff0c\u800c\u662f\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"kubelet & CRI & containerd")," \u4f86\u7ba1\u7406\u3002\n\u6240\u4ee5\u9019\u6642\u5019\u5c31\u4e0d\u80fd\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"docker ps")," \u6216\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"docker images")," \u7b49\u6307\u4ee4\u4f86\u770b\u76f8\u95dc\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"container")," \u8cc7\u6e90\uff0c\u53d6\u800c\u4ee3\u4e4b\u7684\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"crictl")," \u9019\u500b\u5728\u524d\u9762\u6b65\u9a5f\u4f34\u96a8 ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u4e00\u8d77\u5b89\u88dd\u5230\u7cfb\u7d71\u5167\u7684\u5de5\u5177\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},'vagrant@k8s-dev:~/cri/contrib/ansible$ crictl\nNAME:\n   crictl - client for CRI\n\nUSAGE:\n   crictl [global options] command [command options] [arguments...]\n\nVERSION:\n   1.0.0-beta.0\n\nCOMMANDS:\n     attach        Attach to a running container\n     create        Create a new container\n     exec          Run a command in a running container\n     version       Display runtime version information\n     images        List images\n     inspect       Display the status of one or more containers\n     inspecti      Return the status of one ore more images\n     inspectp      Display the status of one or more pod sandboxes\n     logs          Fetch the logs of a container\n     port-forward  Forward local port to a pod sandbox\n     ps            List containers\n     pull          Pull an image from a registry\n     runp          Run a new pod sandbox\n     rm            Remove one or more containers\n     rmi           Remove one or more images\n     rmp           Remove one or more pod sandboxes\n     pods          List pod sandboxes\n     start         Start one or more created containers\n     info          Display information of the container runtime\n     stop          Stop one or more running containers\n     stopp         Stop one or more running pod sandboxes\n     update        Update one or more running containers\n     config        Get and set crictl options\n     stats         List container(s) resource usage statistics\n     completion    Output bash shell completion code\n     help, h       Shows a list of commands or help for one command\n\nGLOBAL OPTIONS:\n   --config value, -c value            Location of the client config file (default: "/etc/crictl.yaml") [$CRI_CONFIG_FILE]\n   --debug, -D                         Enable debug mode\n   --image-endpoint value, -i value    Endpoint of CRI image manager service [$IMAGE_SERVICE_ENDPOINT]\n   --runtime-endpoint value, -r value  Endpoint of CRI container runtime service (default: "unix:///var/run/dockershim.sock") [$CONTAINER_RUNTIME_ENDPOINT]\n   --timeout value, -t value           Timeout of connecting to the server (default: 10s)\n   --help, -h                          show help\n   --version, -v                       print the version\n\n')),(0,i.kt)("p",null,"\u8aaa\u660e\u975e\u5e38\u7c21\u55ae\uff0c\u5c31\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"CRI")," \u547d\u4ee4\u5217\uff0c\u5176\u9810\u8a2d\u7684\u8a2d\u5b9a\u6a94\u6848\u4f4d\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/crictl.yaml")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~/cri/contrib/ansible$ cat /etc/crictl.yaml\nruntime-endpoint: /run/containerd/containerd.sock\n")),(0,i.kt)("p",null,"\u6240\u4ee5\u63a5\u4e0b\u4f86\u547c\u53eb\u7684\u4efb\u4f55 ",(0,i.kt)("inlineCode",{parentName:"p"},"crictl")," \u6307\u4ee4\u90fd\u6703\u8ddf ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u4e92\u52d5\u4f86\u53d6\u5f97\u56de\u61c9\uff0c\u6211\u5011\u5c31\u6839\u64da\u4e0a\u9762\u7684\u63d0\u793a\u4f86\u8a66\u8a66\u770b\u5404\u7a2e\u6307\u4ee4"),(0,i.kt)("p",null,"\u57fa\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes POD")," \u6982\u5ff5\u7684\u8cc7\u6e90\u986f\u793a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~/cri/contrib/ansible$ sudo crictl pods                                                                                                PODSANDBOX ID       CREATED             STATE               NAME                              NAMESPACE           ATTEMPT\n4ed054a456e96       17 minutes ago      SANDBOX_READY       coredns-5c98db65d4-ghzpl          kube-system         0                                    c5209a01e0936       17 minutes ago      SANDBOX_READY       coredns-5c98db65d4-thsdq          kube-system         0\n0a771e9912232       18 minutes ago      SANDBOX_READY       kube-flannel-ds-amd64-ztqgs       kube-system         0\n0642c904298c8       18 minutes ago      SANDBOX_READY       kube-proxy-jfs66                  kube-system         0\n46039553a0fcc       18 minutes ago      SANDBOX_READY       kube-scheduler-k8s-dev            kube-system         0\nec6d7cde198cc       18 minutes ago      SANDBOX_READY       kube-controller-manager-k8s-dev   kube-system         0\nbe0bc17da244d       18 minutes ago      SANDBOX_READY       etcd-k8s-dev                      kube-system         0\n490d8b240d8ca       18 minutes ago      SANDBOX_READY       kube-apiserver-k8s-dev            kube-system         0\n")),(0,i.kt)("p",null,"\u76f8\u95dc\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"container images"),", \u9019\u4e9b ",(0,i.kt)("inlineCode",{parentName:"p"},"images")," \u518d\u4e4b\u524d\u90fd\u662f\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"docker pull")," \u7b49\u65b9\u5f0f\u5b89\u88dd\uff0c\u5982\u4eca\u6211\u5011\u7cfb\u7d71\u5167\u5b8c\u5168\u4e0d\u88dd ",(0,i.kt)("inlineCode",{parentName:"p"},"docker")," \u4e5f\u662f\u53ef\u4ee5\u4f7f\u7528\uff0c\u9019\u4e00\u5207\u90fd\u662f\u4ef0\u8cf4 ",(0,i.kt)("inlineCode",{parentName:"p"},"OCI")," \u6a19\u6e96\u7684\u5236\u5b9a\u5916\u52a0 ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u7684\u5e6b\u5fd9\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~/cri/contrib/ansible$ sudo crictl images\nIMAGE                                TAG                 IMAGE ID            SIZE\nk8s.gcr.io/coredns                   1.3.1               eb516548c180f       12.3MB\nk8s.gcr.io/etcd                      3.3.10              2c4adeb21b4ff       76.2MB\nk8s.gcr.io/kube-apiserver            v1.15.3             5eb2d3fc7a44e       49.3MB\nk8s.gcr.io/kube-controller-manager   v1.15.3             e77c31de55475       47.8MB\nk8s.gcr.io/kube-proxy                v1.15.3             232b5c7931462       30.1MB\nk8s.gcr.io/kube-scheduler            v1.15.3             703f9c69a5d57       29.9MB\nk8s.gcr.io/pause                     3.1                 da86e6ba6ca19       317kB\nquay.io/coreos/flannel               v0.11.0-amd64       8a9c4ced3ff92       16.9MB\nvagrant@k8s-dev:~/cri/contrib/ansible$ sudo crictl ps\n")),(0,i.kt)("p",null,"\u63a5\u4e0b\u4f86\u770b\u770b\u904b\u884c\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"container"),", \u5176\u7d50\u679c\u8ddf ",(0,i.kt)("inlineCode",{parentName:"p"},"docker ps")," \u975e\u5e38\u76f8\u4f3c\uff0c\u4f7f\u7528\u8d77\u4f86\u5e7e\u4e4e\u6c92\u6709\u4efb\u4f55\u9055\u548c\u611f\uff0c\u6211\u89ba\u5f97\u8a2d\u5b9a ",(0,i.kt)("inlineCode",{parentName:"p"},"alias docker=crictl")," \u90fd\u4e0d\u6703\u6709\u4ec0\u9ebc\u932f\u89ba?"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~/cri/contrib/ansible$ sudo crictl ps\nCONTAINER ID        IMAGE                                                                     CREATED             STATE               NAME\n         ATTEMPT\n1cf00f473d03a       sha256:eb516548c180f8a6e0235034ccee2428027896af16a509786da13022fe95fe8c   19 minutes ago      CONTAINER_RUNNING   coredns\n         0\n221b815ca1f56       sha256:eb516548c180f8a6e0235034ccee2428027896af16a509786da13022fe95fe8c   19 minutes ago      CONTAINER_RUNNING   coredns\n         0\nf35552b98abc1       sha256:8a9c4ced3ff92c63c446d55c2353c42410c78b497a0483d4048e8d30ebe37058   19 minutes ago      CONTAINER_RUNNING   kube-flannel\n         0\n8eafd7980b1d3       sha256:232b5c79314628fbc788319e2dff191f4d08e38962e42ebd31b55b52fecd70ec   19 minutes ago      CONTAINER_RUNNING   kube-proxy\n         0\nfeb2ed1caa423       sha256:2c4adeb21b4ff8ed3309d0e42b6b4ae39872399f7b37e0856e673b13c4aba13d   20 minutes ago      CONTAINER_RUNNING   etcd\n         0\n00be90f2a7ac0       sha256:703f9c69a5d578378a022dc75d0c242d599422a1b7cc9cf5279b49d39dc7ca08   20 minutes ago      CONTAINER_RUNNING   kube-scheduler\n         0\ne16c5a24ff09d       sha256:e77c31de554758f3f03e78e124a914b7d86de7d7cf3d677c9b720efb90a833f9   20 minutes ago      CONTAINER_RUNNING   kube-controller-m\nanager   0\nfbe374eb60712       sha256:5eb2d3fc7a44e3a8399256d4b60153a1a59165e70334a1c290fcbd33a9a9d8a7   20 minutes ago      CONTAINER_RUNNING   kube-apiserver\n         0\n")),(0,i.kt)("p",null,"\u9664\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"container")," \u672c\u8eab\u7684\u7ba1\u7406\u5916\uff0c\u6211\u5011\u4f86\u770b\u4e00\u4e0b\u7cfb\u7d71\u5167\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5f0f, \u53ef\u4ee5\u89c0\u5bdf\u5230\u7cfb\u7d71\u4e0a\u6709\u4e00\u500b ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u6b63\u5728\u904b\u884c\uff0c\u540c\u6642 ",(0,i.kt)("inlineCode",{parentName:"p"},"kuberlet")," \u5167\u95dc\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"container-runtime")," \u7684\u53c3\u6578\u6709\u88ab\u4fee\u6539\u3002"),(0,i.kt)("p",null,"\u6b64\u5916\u5c0d\u65bc\u6bcf\u500b\u904b\u4f5c\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"container"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"containetd")," \u90fd\u6703\u7522\u751f\u4e00\u500b ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd-shim")," \u4f86\u904b\u4f5c\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~/cri/contrib/ansible$ ps -axo command | grep containerd\n/usr/local/bin/containerd\n\n/usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/conf\nig.yaml --container-runtime=remote --container-runtime-endpoint=/run/containerd/containerd.sock --runtime-cgroups=/system.slice/containerd.service --co\nntainer-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock\n\ncontainerd-shim -namespace k8s.io -workdir /var/lib/containerd/io.containerd.runtime.v1.linux/k8s.io/490d8b240d8ca4c0df7d8440c5002ca795bddb989fb8bc6de2\n0da78394eb8ce6 -address /run/containerd/containerd.sock -containerd-binary /usr/local/bin/containerd\n...\n.....\n")),(0,i.kt)("h2",{id:"docker"},"Docker"),(0,i.kt)("p",null,"\u70ba\u4e86\u9a57\u8b49\u4e4b\u524d\u8aaa\u660e\u662f\u5426 ",(0,i.kt)("inlineCode",{parentName:"p"},"dockerd")," \u8207 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubelet")," \u5171\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u4f46\u662f\u5f7c\u6b64\u8cc7\u6e90\u662f\u4e92\u76f8\u9694\u96e2\u7684\uff0c\u9019\u6642\u5019\u6211\u5011\u4f86\u5b89\u88dd\u4e00\u4e0b ",(0,i.kt)("inlineCode",{parentName:"p"},"docker")," \u4e26\u4e14\u65bc\u80cc\u666f\u904b\u884c\u4e00\u500b ",(0,i.kt)("inlineCode",{parentName:"p"},"container")," \u8a66\u8a66\u770b"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"sudo docker run -d hwchiu/netutils\n")),(0,i.kt)("p",null,"\u63a5\u4e0b\u4f86\u6211\u5011\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"docker")," \u6307\u4ee4\u91dd\u5c0d\u4e0a\u8ff0\u7684\u64cd\u4f5c\u90fd\u9032\u884c\u4e00\u6b21\uff0c\u4f86\u6bd4\u8f03\u770b\u770b"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},'vagrant@k8s-dev:~$ sudo docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nhwchiu/netutils     latest              a0d1dad34d58        13 months ago       222MB\nvagrant@k8s-dev:~$ sudo docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\n320b653e39d8        hwchiu/netutils     "/bin/bash ./entrypo\u2026"   15 minutes ago      Up 15 minutes                           inspiring_haslett\n')),(0,i.kt)("p",null,"\u975e\u5e38\u4e7e\u6de8\u7c21\u55ae\uff0c\u5b8c\u5168\u770b\u4e0d\u5230\u4efb\u4f55 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u7528\u5230\u7684\u5bb9\u5668\u8cc7\u6e90\uff0c\u6b64\u5916\u6211\u5011\u518d\u5ea6\u900f\u904e \uff40",(0,i.kt)("inlineCode",{parentName:"p"},"ps")," \u89c0\u5bdf"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\n\ncontainerd-shim -namespace moby -workdir /var/lib/containerd/io.containerd.runtime.v1.linux/moby/320b653e39d8164e3033f1eec079c7772a10e703d24bb7f39f7bdf26fe084fe5 -address /run/containerd/containerd.sock -containerd-binary /usr/local/bin/containerd -runtime-root /var/run/docker/runtime-runc\n\n")),(0,i.kt)("p",null,"\u9996\u5148\uff0c\u53ef\u4ee5\u770b\u5230 ",(0,i.kt)("inlineCode",{parentName:"p"},"dockerd")," \u9019\u6642\u5019\u4e5f\u900f\u904e\u53c3\u6578\u7684\u65b9\u5f0f\u53bb\u9023\u63a5 ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd"),", \u53e6\u5916\u53ef\u4ee5\u770b\u5230\u91dd\u5c0d\u6211\u4e0a\u8ff0\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"docker image")," \u6240\u7522\u751f\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd-shim")," \u8207 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u7522\u751f\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd-shim")," \u6709\u660e\u986f\u7684\u53c3\u6578\u4e0d\u540c"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"-namespace moby v.s k8s.io"),(0,i.kt)("li",{parentName:"ol"},"workdir \u4e0d\u540c"),(0,i.kt)("li",{parentName:"ol"},"-runtime-root /var/run/docker/runtime-runc")),(0,i.kt)("p",null,"\u6b64\u5916\u6211\u5011\u4e5f\u53ef\u4ee5\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd cli(ctr) and containerd")," \u4f86\u89c0\u5bdf\u66f4\u591a\u6709\u8da3\u7684\u8cc7\u8a0a"),(0,i.kt)("p",null,"\u9996\u5148\u53ef\u4ee5\u770b\u5230\u5c0d\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u7684\u78ba\u6709\u4e0d\u540c\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"namespace"),"\uff0c\u4e5f\u7684\u78ba\u5982\u4e0a\u9762\u6240\u89c0\u5bdf\u5230\u7684\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"moby")," \u8207 ",(0,i.kt)("inlineCode",{parentName:"p"},"k8s.io")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ sudo ctr namespaces ls\nNAME   LABELS\nk8s.io\nmoby\n")),(0,i.kt)("p",null,"\u6b64\u5916\u6211\u5011\u4e5f\u53ef\u4ee5\u770b\u5230\u4e0d\u5c11\u95dc\u65bc containerd \u9810\u8a2d\u7684\u8a2d\u5b9a\uff0c\u9810\u8a2d\u60c5\u6cc1\u4e0b ",(0,i.kt)("inlineCode",{parentName:"p"},"linux")," \u74b0\u5883\u4e2d\u90fd\u662f\u63a1\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"runc")," \u4f5c\u70ba ",(0,i.kt)("inlineCode",{parentName:"p"},"OCI Runtime Spec")," \u7684\u89e3\u6c7a\u65b9\u6848\u3002\n\u800c ",(0,i.kt)("inlineCode",{parentName:"p"},"kubelet")," \u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"CRI")," \u8207 ",(0,i.kt)("inlineCode",{parentName:"p"},"docker")," \u6700\u5f8c\u9078\u64c7\u90fd\u662f\u6703\u63a1\u53d6 ",(0,i.kt)("inlineCode",{parentName:"p"},"plugin.linux")," \u7684\u8a2d\u5b9a\uff0c\u6240\u4ee5\u5169\u8005\u80cc\u5f8c\u6700\u5f8c\u90fd\u662f\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"runc")," \u4f86\u5275\u5efa ",(0,i.kt)("inlineCode",{parentName:"p"},"Container"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},'sudo containerd config default\n...\n  [plugins.cri]\n    stream_server_address = ""\n    stream_server_port = "10010"\n    enable_selinux = false\n    sandbox_image = "k8s.gcr.io/pause:3.1"\n    stats_collect_period = 10\n    systemd_cgroup = false\n    [plugins.cri.containerd]\n      snapshotter = "overlayfs"\n      [plugins.cri.containerd.default_runtime]\n        runtime_type = "io.containerd.runtime.v1.linux"\n        runtime_engine = ""\n        runtime_root = ""\n      [plugins.cri.containerd.untrusted_workload_runtime]\n        runtime_type = ""\n        runtime_engine = ""\n        runtime_root = ""\n...\n  [plugins.linux]\n    shim = "containerd-shim"\n    runtime = "runc"\n    runtime_root = ""\n    no_shim = false\n    shim_debug = false\n...\n\n')),(0,i.kt)("h1",{id:"summary"},"Summary"),(0,i.kt)("p",null,"\u672c\u6587\u4e2d\u6211\u5011\u7c21\u8ff0\u4e86\u5982\u4f55\u5efa\u7f6e\u4e00\u5957\u57fa\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"containerd")," \u800c\u975e ",(0,i.kt)("inlineCode",{parentName:"p"},"docker")," \u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes cluster"),", \u4e26\u4e14\u900f\u904e\u76f8\u95dc\u6307\u4ee4\u8207\u5de5\u5177\u4f86\u89c0\u5bdf\u5728\u6b64\u8a2d\u5b9a\u4e0b\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes"),",",(0,i.kt)("inlineCode",{parentName:"p"},"containerd"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"dockerd")," \u7b49\u5f7c\u6b64\u7684\u4ea4\u4e92\u95dc\u4fc2\uff0c\u53ef\u4ee5\u66f4\u52a0\u6df1\u5c0d\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"CRI, OCI")," \u7b49\u6982\u5ff5\u7684\u7406\u89e3\u3002"),(0,i.kt)("p",null,"kubelet -> containerd -> containetrd-shin(k8s.io) -> runc"),(0,i.kt)("p",null,"docker client -> docker enginer -> containerd -> containerd-shim(moby) -> runc"))}u.isMDXComponent=!0}}]);