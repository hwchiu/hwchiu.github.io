"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[99972],{3905:(t,e,n)=>{n.d(e,{Zo:()=>u,kt:()=>d});var r=n(67294);function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function p(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function o(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?p(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function l(t,e){if(null==t)return{};var n,r,a=function(t,e){if(null==t)return{};var n,r,a={},p=Object.keys(t);for(r=0;r<p.length;r++)n=p[r],e.indexOf(n)>=0||(a[n]=t[n]);return a}(t,e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(t);for(r=0;r<p.length;r++)n=p[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}var s=r.createContext({}),i=function(t){var e=r.useContext(s),n=e;return t&&(n="function"==typeof t?t(e):o(o({},e),t)),n},u=function(t){var e=i(t.components);return r.createElement(s.Provider,{value:e},t.children)},k="mdxType",m={inlineCode:"code",wrapper:function(t){var e=t.children;return r.createElement(r.Fragment,{},e)}},c=r.forwardRef((function(t,e){var n=t.components,a=t.mdxType,p=t.originalType,s=t.parentName,u=l(t,["components","mdxType","originalType","parentName"]),k=i(n),c=a,d=k["".concat(s,".").concat(c)]||k[c]||m[c]||p;return n?r.createElement(d,o(o({ref:e},u),{},{components:n})):r.createElement(d,o({ref:e},u))}));function d(t,e){var n=arguments,a=e&&e.mdxType;if("string"==typeof t||a){var p=n.length,o=new Array(p);o[0]=c;var l={};for(var s in e)hasOwnProperty.call(e,s)&&(l[s]=e[s]);l.originalType=t,l[k]="string"==typeof t?t:a,o[1]=l;for(var i=2;i<p;i++)o[i]=n[i];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},31049:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>p,metadata:()=>l,toc:()=>i});var r=n(87462),a=(n(67294),n(3905));const p={title:"Linux NAT Masquerade \u7814\u7a76(\u4e0b)",keywords:["linux","iptables nat"],date:new Date("2020-01-02T05:38:43.000Z"),tags:["Network","Linux","iptables"],description:"\u672c\u7bc7\u6587\u7ae0\u900f\u904e\u4fee\u6539 MASQUERADE Kernel Module \u539f\u59cb\u78bc\u7684\u65b9\u5f0f\u4f86\u89c0\u5bdf\u7cfb\u7d71\u7684\u8b8a\u5316\uff0c\u5c08\u6ce8\u65bc\u7576 NAT \u529f\u80fd\u57f7\u884c\u524d\u5f8c\uff0c conntrack \u9019\u500b\u7d50\u69cb\u7684\u6539\u8b8a\u3002\u900f\u904e\u4e0d\u540c\u7684\u5be6\u9a57\u8207\u74b0\u5883\u4f86\u89c0\u5bdf 1)\u591a\u91cd IP \u7684\u60c5\u6cc1\u4e0b\u600e\u9078\u64c7 2)\u6307\u5b9a\u4e0d\u540c\u53c3\u6578\u6642\uff0c\u9023\u63a5\u57e0\u7684\u8b8a\u5316\u3002\u6b64\u5916\u70ba\u4e86\u7c21\u5316\u6574\u9ad4\u64cd\u4f5c\u904e\u7a0b\uff0c\u5c07\u6574\u500b\u5be6\u9a57\u74b0\u5883\u90fd\u900f\u904e Vagrant \u6253\u5305\u6210\u70ba\u4e00\u500b\u53ef\u91cd\u8907\u57f7\u884c\u7684\u74b0\u5883\uff0c\u4e26\u4e14\u4e5f\u6e96\u5099\u597d\u53ef\u4ee5\u7de8\u8b6f Kernel Module \u7684\u74b0\u5883\u8207\u6307\u4ee4\u3002"},o="Preface",l={unversionedId:"techPost/2020/iptables-masquerade-handson",id:"techPost/2020/iptables-masquerade-handson",title:"Linux NAT Masquerade \u7814\u7a76(\u4e0b)",description:"\u672c\u7bc7\u6587\u7ae0\u900f\u904e\u4fee\u6539 MASQUERADE Kernel Module \u539f\u59cb\u78bc\u7684\u65b9\u5f0f\u4f86\u89c0\u5bdf\u7cfb\u7d71\u7684\u8b8a\u5316\uff0c\u5c08\u6ce8\u65bc\u7576 NAT \u529f\u80fd\u57f7\u884c\u524d\u5f8c\uff0c conntrack \u9019\u500b\u7d50\u69cb\u7684\u6539\u8b8a\u3002\u900f\u904e\u4e0d\u540c\u7684\u5be6\u9a57\u8207\u74b0\u5883\u4f86\u89c0\u5bdf 1)\u591a\u91cd IP \u7684\u60c5\u6cc1\u4e0b\u600e\u9078\u64c7 2)\u6307\u5b9a\u4e0d\u540c\u53c3\u6578\u6642\uff0c\u9023\u63a5\u57e0\u7684\u8b8a\u5316\u3002\u6b64\u5916\u70ba\u4e86\u7c21\u5316\u6574\u9ad4\u64cd\u4f5c\u904e\u7a0b\uff0c\u5c07\u6574\u500b\u5be6\u9a57\u74b0\u5883\u90fd\u900f\u904e Vagrant \u6253\u5305\u6210\u70ba\u4e00\u500b\u53ef\u91cd\u8907\u57f7\u884c\u7684\u74b0\u5883\uff0c\u4e26\u4e14\u4e5f\u6e96\u5099\u597d\u53ef\u4ee5\u7de8\u8b6f Kernel Module \u7684\u74b0\u5883\u8207\u6307\u4ee4\u3002",source:"@site/docs/techPost/2020/iptables-masquerade-handson.md",sourceDirName:"techPost/2020",slug:"/techPost/2020/iptables-masquerade-handson",permalink:"/docs/techPost/2020/iptables-masquerade-handson",draft:!1,tags:[{label:"Network",permalink:"/docs/tags/network"},{label:"Linux",permalink:"/docs/tags/linux"},{label:"iptables",permalink:"/docs/tags/iptables"}],version:"current",frontMatter:{title:"Linux NAT Masquerade \u7814\u7a76(\u4e0b)",keywords:["linux","iptables nat"],date:"2020-01-02T05:38:43.000Z",tags:["Network","Linux","iptables"],description:"\u672c\u7bc7\u6587\u7ae0\u900f\u904e\u4fee\u6539 MASQUERADE Kernel Module \u539f\u59cb\u78bc\u7684\u65b9\u5f0f\u4f86\u89c0\u5bdf\u7cfb\u7d71\u7684\u8b8a\u5316\uff0c\u5c08\u6ce8\u65bc\u7576 NAT \u529f\u80fd\u57f7\u884c\u524d\u5f8c\uff0c conntrack \u9019\u500b\u7d50\u69cb\u7684\u6539\u8b8a\u3002\u900f\u904e\u4e0d\u540c\u7684\u5be6\u9a57\u8207\u74b0\u5883\u4f86\u89c0\u5bdf 1)\u591a\u91cd IP \u7684\u60c5\u6cc1\u4e0b\u600e\u9078\u64c7 2)\u6307\u5b9a\u4e0d\u540c\u53c3\u6578\u6642\uff0c\u9023\u63a5\u57e0\u7684\u8b8a\u5316\u3002\u6b64\u5916\u70ba\u4e86\u7c21\u5316\u6574\u9ad4\u64cd\u4f5c\u904e\u7a0b\uff0c\u5c07\u6574\u500b\u5be6\u9a57\u74b0\u5883\u90fd\u900f\u904e Vagrant \u6253\u5305\u6210\u70ba\u4e00\u500b\u53ef\u91cd\u8907\u57f7\u884c\u7684\u74b0\u5883\uff0c\u4e26\u4e14\u4e5f\u6e96\u5099\u597d\u53ef\u4ee5\u7de8\u8b6f Kernel Module \u7684\u74b0\u5883\u8207\u6307\u4ee4\u3002"},sidebar:"techPost",previous:{title:"\u521d\u63a2 IPTABLES \u6d41\u52d5\u4e4b\u8def - \u4ee5 Docker \u70ba\u7bc4\u4f8b",permalink:"/docs/techPost/2020/iptables-1"},next:{title:"IPvS \u5b78\u7fd2\u624b\u518a(\u4e00)",permalink:"/docs/techPost/2020/ipvs-1"}},s={},i=[{value:"\u8a2d\u5b9a\u74b0\u5883",id:"\u8a2d\u5b9a\u74b0\u5883",level:2},{value:"\u4fee\u6539\u7a0b\u5f0f\u78bc",id:"\u4fee\u6539\u7a0b\u5f0f\u78bc",level:2},{value:"Conntrack",id:"conntrack",level:2},{value:"\u7d50\u679c\u89c0\u5bdf",id:"\u7d50\u679c\u89c0\u5bdf",level:2},{value:"\u74b0\u5883\u4ecb\u7d39",id:"\u74b0\u5883\u4ecb\u7d39",level:2},{value:"\u9023\u63a5\u57e0\u89c0\u5bdf",id:"\u9023\u63a5\u57e0\u89c0\u5bdf",level:2},{value:"\u8a2d\u5b9a iptables",id:"\u8a2d\u5b9a-iptables",level:3},{value:"\u6e2c\u8a66\u6d41\u91cf",id:"\u6e2c\u8a66\u6d41\u91cf",level:3},{value:"\u89c0\u5bdf\u7d50\u679c",id:"\u89c0\u5bdf\u7d50\u679c",level:3},{value:"IP \u9078\u64c7\u89c0\u5bdf",id:"ip-\u9078\u64c7\u89c0\u5bdf",level:2},{value:"\u8a2d\u5b9aIP",id:"\u8a2d\u5b9aip",level:3},{value:"\u6e2c\u8a66\u6d41\u91cf",id:"\u6e2c\u8a66\u6d41\u91cf-1",level:3}],u={toc:i},k="wrapper";function m(t){let{components:e,...n}=t;return(0,a.kt)(k,(0,r.Z)({},u,n,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"preface"},"Preface"),(0,a.kt)("p",null,"\u672c\u7bc7\u6587\u7ae0\u929c\u63a5\u4e0a\u7bc7 ",(0,a.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/iptables-masquerade.html"},"Linux NAT Masquerade \u7814\u7a76(\u4e0a)"),"\uff0c\u900f\u904e\u4e0d\u540c\u7684\u65b9\u5f0f\u4f86\u89c0\u5bdf ",(0,a.kt)("strong",{parentName:"p"},"MASQUERADE")," \u7684\u904b\u4f5c\u7d50\u679c\u3002"),(0,a.kt)("p",null,"\u76f8\u8f03\u65bc\u4e0a\u7bc7\u6587\u7ae0\u662f\u900f\u904e\u89c0\u5bdf\u539f\u59cb\u78bc\u7684\u65b9\u5f0f\u4f86\u5b78\u7fd2\u904e\u7a0b\uff0c\u672c\u7bc7\u6587\u7ae0\u5617\u8a66\u65bc\u76f4\u63a5\u4fee\u6539\u76f8\u95dc\u7a0b\u5f0f\u78bc\u7684\u65b9\u5f0f\u4f86\u89c0\u5bdf\u6700\u5f8c\u9078\u64c7\u7684\u7d50\u679c"),(0,a.kt)("p",null,"\u70ba\u4e86\u5e0c\u671b\u8b93\u6574\u500b\u6e2c\u8a66\u74b0\u5883\u662f\u7c21\u55ae\u4e14\u53ef\u91cd\u8907\u57f7\u884c\u7684\uff0c\u6240\u4ee5\u6c7a\u5b9a\u4f7f\u7528 ",(0,a.kt)("strong",{parentName:"p"},"Vagrant")," \u4f86\u5305\u88dd\u6574\u500b\u74b0\u5883\uff0c\u4e26\u4e14\u9650\u5236\u4f7f\u7528\u7684\u8edf\u9ad4\u7248\u672c\uff0c\u8b6c\u5982 ",(0,a.kt)("strong",{parentName:"p"},"Ubuntu"),", ",(0,a.kt)("strong",{parentName:"p"},"Linux Kernel")," \u7b49"),(0,a.kt)("p",null,"\u6b64\u5916\u7531\u65bc ",(0,a.kt)("strong",{parentName:"p"},"MASQUERADE")," \u672c\u8eab\u4f7f\u7528\u5230\u7684\u51fd\u6578\u727d\u626f\u5230 ",(0,a.kt)("strong",{parentName:"p"},"Kernel Module")," \u4ee5\u53ca ",(0,a.kt)("strong",{parentName:"p"},"Linux Kernel"),"\uff0c\u6240\u4ee5\u5728\u5efa\u7f6e\u74b0\u5883\u7684\u6642\u5019\u5176\u5be6\u6709\u9ede\u9ebb\u7169\u3002\n\u5c0d\u65bc ",(0,a.kt)("strong",{parentName:"p"},"Kernel Module")," \u4f86\u8aaa\u76f8\u5c0d\u7c21\u55ae\uff0c\u53ea\u8981\u6e96\u5099\u597d\u76f8\u95dc\u7684\u74b0\u5883\u652f\u63f4\u7de8\u8b6f\uff0c\u6700\u5f8c\u91cd\u65b0\u5b89\u88dd\u76f8\u95dc\u7684 ",(0,a.kt)("strong",{parentName:"p"},"Kernel Module")," \u5373\u53ef\u3002\n\u4f46\u662f\u6574\u500b ",(0,a.kt)("strong",{parentName:"p"},"Linux Kernel")," \u60f3\u5230\u9084\u8981\u5168\u90e8\u7de8\u8b6f\u4e26\u4e14\u5b89\u88dd\u5c31\u89ba\u5f97\u9ebb\u7169\uff0c\u6240\u4ee5\u5f8c\u4f86\u6c7a\u5b9a\u55ae\u7d14\u91dd\u5c0d ",(0,a.kt)("strong",{parentName:"p"},"Kernel Module")," \u7684\u90e8\u5206\u53bb\u4fee\u6539\uff0c\u56e0\u6b64\u80fd\u5920\u89c0\u5bdf\u5230\u7684\u90e8\u5206\u4e5f\u6703\u88ab\u53d7\u9650\uff0c\u6c92\u6709\u8fa6\u6cd5\u592a\u7d30\u90e8\u7684\u91dd\u5c0d\u524d\u6587\u7684\u6bcf\u500b\u51fd\u5f0f\u53bb\u89c0\u5bdf\u3002"),(0,a.kt)("h1",{id:"\u74b0\u5883\u8a2d\u5b9a"},"\u74b0\u5883\u8a2d\u5b9a"),(0,a.kt)("p",null,"\u672c\u7bc7\u6587\u7ae0\u7684\u74b0\u5883\u53ef\u900f\u904e ",(0,a.kt)("strong",{parentName:"p"},"Vagrant")," \u9032\u884c\u8a2d\u5b9a\uff0c\u76f8\u95dc\u5167\u5bb9\u90fd\u5b58\u653e\u65bc\u6b64 ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/hwchiu/network-study/tree/master/iptables/masquerade"},"hwchiu/network-study")," \u5c08\u6848\u5167\u3002"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Ubuntu: 18.04"),(0,a.kt)("li",{parentName:"ul"},"Linux Kernel: 4.15")),(0,a.kt)("h2",{id:"\u8a2d\u5b9a\u74b0\u5883"},"\u8a2d\u5b9a\u74b0\u5883"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/hwchiu/network-study\npushd network-study/iptables/masquerade\nvagrant up\n")),(0,a.kt)("p",null,"\u900f\u904e\u4e0a\u8ff0\u65b9\u5f0f\u5373\u53ef\u9032\u5165\u5230\u6e2c\u8a66\u74b0\u5883\u4e2d"),(0,a.kt)("h1",{id:"\u89c0\u5bdf\u5be6\u4f5c"},"\u89c0\u5bdf\u5be6\u4f5c"),(0,a.kt)("p",null,"\u9019\u6b21\u7684\u89c0\u5bdf\u8457\u91cd\u65bc ",(0,a.kt)("strong",{parentName:"p"},"Kernel Module")," \u7684\u90e8\u5206\uff0c\u6240\u4ee5\u4e3b\u8981\u662f\u91dd\u5c0d ",(0,a.kt)("inlineCode",{parentName:"p"},"ipt_MASQUERADE.c")," \u9019\u500b\u6a94\u6848\uff0c\u91dd\u5c0d\u9019\u6a94\u6848\u6211\u9032\u884c\u4e86\u4e00\u4e9b\u4fee\u6539\uff0c\u4e3b\u8981\u662f\u589e\u52a0\u4e00\u500b\u8f38\u51fa\u76f8\u95dc\u8cc7\u8a0a\u7684\u51fd\u5f0f\uff0c\u4e26\u4e14\u6839\u64da ",(0,a.kt)("strong",{parentName:"p"},"NAT")," \u547c\u53eb\u524d\u5f8c\u4f86\u547c\u53eb\u8a72\u51fd\u5f0f\u8f38\u51fa"),(0,a.kt)("h2",{id:"\u4fee\u6539\u7a0b\u5f0f\u78bc"},"\u4fee\u6539\u7a0b\u5f0f\u78bc"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-c++"},' static unsigned int\n masquerade_tg(struct sk_buff *skb, const struct xt_action_param *par)\n {\n+       unsigned int ret =0;\n        struct nf_nat_range range;\n        const struct nf_nat_ipv4_multi_range_compat *mr;\n\n@@ -71,13 +70,8 @@ masquerade_tg(struct sk_buff *skb, const struct xt_action_param *par)\n        range.min_proto = mr->range[0].min;\n        range.max_proto = mr->range[0].max;\n\n+       printk("before nat\\n");\n+       show_status(skb, par);\n+       ret = nf_nat_masquerade_ipv4(skb, xt_hooknum(par), &range,\n-       return nf_nat_masquerade_ipv4(skb, xt_hooknum(par), &range,\n                                      xt_out(par));\n+       printk("after nat\\n");\n+       show_status(skb, par);\n+       return ret;\n }\n')),(0,a.kt)("p",null,"\u6700\u4e3b\u8981\u7684\u4fee\u6539\u5c31\u662f\u57f7\u884c ",(0,a.kt)("strong",{parentName:"p"},"nf_nat_masquerade_ipv4")," \u524d\u5f8c\u53bb\u547c\u53eb ",(0,a.kt)("strong",{parentName:"p"},"show_status")," \u4f86\u8f38\u51fa\u76f8\u95dc\u8cc7\u8a0a\u3002"),(0,a.kt)("h2",{id:"conntrack"},"Conntrack"),(0,a.kt)("p",null,"\u5f80\u4e0b\u7e7c\u7e8c\u8b1b\u4e4b\u524d\uff0c\u5148\u7a0d\u5fae\u7c21\u55ae\u63d0\u4e00\u4e0b ",(0,a.kt)("strong",{parentName:"p"},"Conntrack")," \u7684\u6982\u5ff5\uff0c\u5c0d\u65bc\u6bcf\u4e00\u689d",(0,a.kt)("strong",{parentName:"p"},"\u7db2\u8def\u9023\u7dda"),", Linux Kernel \u90fd\u6703\u7528 ",(0,a.kt)("strong",{parentName:"p"},"Conntrack")," \u9019\u500b\u7d50\u69cb\u53bb\u7d00\u9304\u8a72\u9023\u7dda\u7684\u8cc7\u8a0a\u3002\n\u6bcf\u4e00\u689d\u7db2\u8def\u9023\u7dda\u90fd\u4ee3\u8868\u8005\u96d9\u5411\u7684\u50b3\u8f38\u65b9\u5411\uff0c\u9019\u908a\u4e0d\u7ba1\u662f TCP/UDP \u90fd\u4eab\u6709\u9019\u985e\u578b\u7d50\u69cb\u7684\u7d00\u9304\uff0c\u4ee5\u4e0b\u5716\u70ba\u4f8b"),(0,a.kt)("p",null,"\u6bcf\u500b ",(0,a.kt)("strong",{parentName:"p"},"\u7bc0\u9ede")," \u90fd\u6703\u6709\u4e00\u4efd\u5c6c\u65bc\u81ea\u5df1\u7684 ",(0,a.kt)("strong",{parentName:"p"},"conntrack")," \u7d00\u9304\uff0c\u800c\u6bcf\u500b ",(0,a.kt)("strong",{parentName:"p"},"conntrack")," \u90fd\u6703\u6709",(0,a.kt)("strong",{parentName:"p"},"Original"),",",(0,a.kt)("strong",{parentName:"p"},"Reply")," \u5169\u500b\u65b9\u5411\u7684\u7d00\u9304\u3002"),(0,a.kt)("p",null,"\u6700\u7c21\u55ae\u7684\u60c5\u6cc1\u4e0b\uff0c ",(0,a.kt)("strong",{parentName:"p"},"Original")," \u4ee5\u53ca ",(0,a.kt)("strong",{parentName:"p"},"Reply")," \u5b8c\u5168\u985b\u5012\u7684\uff0c\u5c31\u662f ",(0,a.kt)("strong",{parentName:"p"},"Original")," \u7684\u4f86\u6e90\u7aef\u76f8\u540c\u65bc ",(0,a.kt)("strong",{parentName:"p"},"Reply")," \u7684\u76ee\u7684\u7aef\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/ei2eOSL.png",alt:null})),(0,a.kt)("h2",{id:"\u7d50\u679c\u89c0\u5bdf"},"\u7d50\u679c\u89c0\u5bdf"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-c++"},'\nstatic void show_status(struct sk_buff *skb, const struct xt_action_param *par)\n{\n    struct nf_conn *ct;\n    struct nf_conntrack_tuple *tuple;\n    enum ip_conntrack_info ctinfo;\n\n    ct = nf_ct_get(skb, &ctinfo);\n    tuple = &(ct->tuplehash[IP_CT_DIR_ORIGINAL].tuple);\n    printk("ORIGINAL: outgoing interface: %s, src-ipv4:%pI4, src-port:%u, dst-ipv4:%pI4, dst-port:%u\\n", xt_out(par)->name, (void*)&tuple->src.u3.ip, ntohs(tuple->src.u.tcp.port),(void*)&tuple->dst.u3.ip, ntohs(tuple->dst.u.tcp.port));\n\n    tuple = &(ct->tuplehash[IP_CT_DIR_REPLY].tuple);\n    printk("REPLY: outgoing interface: %s, src-ipv4:%pI4, src-port:%u, dst-ipv4:%pI4, dst-port:%u\\n", xt_out(par)->name, (void*)&tuple->src.u3.ip, ntohs(tuple->src.u.tcp.port),(void*)&tuple->dst.u3.ip, ntohs(tuple->dst.u.tcp.port));\n    return;\n}\n')),(0,a.kt)("p",null,"\u800c ",(0,a.kt)("strong",{parentName:"p"},"show_status")," \u672c\u8eab\u5247\u662f\u6703\u53bb\u8f38\u51fa\uff0c",(0,a.kt)("strong",{parentName:"p"},"conntrack")," \u7684\u5169\u500b\u65b9\u5411\uff0c\u4e5f\u5c31\u662f\u6240\u8b02\u7684 ",(0,a.kt)("strong",{parentName:"p"},"ORIGINAL")," \u4ee5\u53ca ",(0,a.kt)("strong",{parentName:"p"},"REPLY"),"\u3002\n\u8f38\u51fa\u7684\u5167\u5bb9\u6982\u62ec\u4e86"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u5c01\u5305\u51fa\u53bb\u7684\u7db2\u5361"),(0,a.kt)("li",{parentName:"ol"},"\u8a72 ",(0,a.kt)("strong",{parentName:"li"},"conntrack")," \u8a18\u9304\u5230\u7684\u4f86\u6e90 ",(0,a.kt)("strong",{parentName:"li"},"IP"),"\u4ee5\u53ca\u4f86\u6e90\u9023\u63a5\u57e0"),(0,a.kt)("li",{parentName:"ol"},"\u8a72 ",(0,a.kt)("strong",{parentName:"li"},"conntrack")," \u8a18\u9304\u5230\u7684\u76ee\u6a19 ",(0,a.kt)("strong",{parentName:"li"},"IP"),"\u4ee5\u53ca\u76ee\u6a19\u9023\u63a5\u57e0")),(0,a.kt)("p",null,"\u6240\u4ee5\u6211\u5011\u771f\u6b63\u89c0\u5bdf\u7684\u5167\u5bb9\u5c31\u662f\n",(0,a.kt)("strong",{parentName:"p"},"\u57f7\u884c NAT \u524d\u5f8c Conntrack \u7684\u8b8a\u5316")),(0,a.kt)("h1",{id:"\u5be6\u9a57"},"\u5be6\u9a57"),(0,a.kt)("h2",{id:"\u74b0\u5883\u4ecb\u7d39"},"\u74b0\u5883\u4ecb\u7d39"),(0,a.kt)("p",null,"\u672c\u6587\u7ae0\u7684\u6240\u6709\u74b0\u5883\u90fd\u5df2\u7d93\u900f\u904e ",(0,a.kt)("strong",{parentName:"p"},"Vagrant")," \u4f86\u5efa\u7acb\u4e00\u500b\u7368\u7acb\u4e14\u53ef\u91cd\u8907\u7684\u74b0\u5883\uff0c\u4e3b\u8981\u7684",(0,a.kt)("a",{parentName:"p",href:"https://github.com/hwchiu/network-study/blob/master/iptables/masquerade/Vagrantfile"},"\u908f\u8f2f"),"\u662f"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u5b89\u88dd Linux Kernel header"),(0,a.kt)("li",{parentName:"ol"},"\u4e0b\u8f09\u4fee\u6539\u5f8c\u7684 kernel module \u539f\u59cb\u78bc"),(0,a.kt)("li",{parentName:"ol"},"\u7de8\u8b6f\u8a72 Kernel module \u4e26\u4e14\u5b89\u88dd"),(0,a.kt)("li",{parentName:"ol"},"\u5b89\u88dd Docker \u6e96\u5099\u6e2c\u8a66\u74b0\u5883")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'    # Install modified kernel module\n    git clone https://github.com/hwchiu/network-study\n    sudo apt-get install -y linux-headers-$(uname -r)\n    cd network-study/iptables/masquerade/module\n    sudo make\n    sudo cp ipt_MASQUERADE.ko /lib/modules/$(uname -r)/kernel/net/ipv4/ netfilter/ipt_MASQUERADE.ko\n\n    # Install ntp\n    sudo apt-get install -y ntp\n    # Install Docker\n    export DOCKER_VERSION="18.06.3~ce~3-0~ubuntu"\n    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\n    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"\n    sudo apt-get update\n    sudo apt-get install -y docker-ce=${DOCKER_VERSION}\n\n')),(0,a.kt)("p",null,"\u4e8b\u5148\u6e96\u5099\u597d ",(0,a.kt)("strong",{parentName:"p"},"Vagrant")," \u7684\u74b0\u5883\uff0c\u53ef\u4ee5\u7528\u4e0b\u5217\u7684\u6307\u4ee4\u9032\u5165\u5230\u5be6\u9a57\u74b0\u5883"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/hwchiu/network-study\npushd network-study/iptables/masquerade\nvagrant up\nvagrant ssh\n")),(0,a.kt)("h2",{id:"\u9023\u63a5\u57e0\u89c0\u5bdf"},"\u9023\u63a5\u57e0\u89c0\u5bdf"),(0,a.kt)("p",null,"\u7b2c\u4e00\u500b\u5be6\u9a57\u5247\u662f\u89c0\u5bdf\u53c3\u6578\u7684\u904b\u4f5c\uff0c\u5373 ",(0,a.kt)("strong",{parentName:"p"},"--to-ports")," \u7684\u904b\u4f5c\u65b9\u5f0f\u5373\u7d50\u679c\uff0c\u70ba\u4e86\u5b8c\u6210\u9019\u500b\u6e2c\u8a66\uff0c\u6211\u5011\u9700\u8981\u505a\u76f8\u95dc\u7684\u64cd\u4f5c"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u522a\u9664 docker \u6240\u5b89\u88dd\u7684 iptables \u6307\u4ee4"),(0,a.kt)("li",{parentName:"ol"},"\u5b89\u88dd kernel module (\u975e\u5fc5\u8981\uff0c\u56e0\u70ba vagrant \u555f\u52d5\u6642\u5df2\u7d93\u5b89\u88dd\u5230\u7cfb\u7d71\u5167)"),(0,a.kt)("li",{parentName:"ol"},"\u91cd\u65b0\u5b89\u88dd iptables \u6307\u4ee4\uff0c\u4e26\u4e14\u8a2d\u5b9a ",(0,a.kt)("strong",{parentName:"li"},"--to-ports"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u9019\u908a\u8981\u6ce8\u610f\u7684\u662f ",(0,a.kt)("strong",{parentName:"li"},"--to-ports")," \u672c\u8eab\u53ea\u6709\u7279\u5b9a\u7684 Layer4 \u5354\u5b9a\u6709\u652f\u63f4\uff0c\u4f46\u662f ",(0,a.kt)("strong",{parentName:"li"},"DNS")," \u4e26\u4e0d\u652f\u63f4\uff0c\u6240\u4ee5\u9700\u8981\u984d\u5916\u984d\u5916\u4e00\u689d iptables \u898f\u5247\u4f86\u8655\u7406 DNS \u7684\u67e5\u8a62\u3002"))),(0,a.kt)("li",{parentName:"ol"},"\u900f\u904e ",(0,a.kt)("strong",{parentName:"li"},"docker run")," \u7684\u65b9\u5f0f\u53bb\u7522\u751f ",(0,a.kt)("strong",{parentName:"li"},"TCP")," \u5c01\u5305\uff0c\u4e26\u4e14\u89c0\u5bdf ",(0,a.kt)("strong",{parentName:"li"},"kernel")," \u7684\u8f38\u51fa\u7d50\u679c")),(0,a.kt)("h3",{id:"\u8a2d\u5b9a-iptables"},"\u8a2d\u5b9a iptables"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"pushd ~/network-study/iptables/masquerade/module/\nsudo iptables -t nat -D POSTROUTING -s 172.18.0.0/16 ! -o docker0 -j MASQUERADE || true\nsudo iptables -t nat -A POSTROUTING -s 172.18.0.0/16 -p tcp ! -o docker0 -j MASQUERADE --to-ports 55666-55680|| true\nsudo iptables -t nat -A POSTROUTING -s 172.18.0.0/16 ! -o docker0 -j MASQUERADE || true\n")),(0,a.kt)("p",null,"\u5982\u679c\u4eca\u5929\u81ea\u5df1\u6709\u4efb\u4f55\u4fee\u6539 ",(0,a.kt)("strong",{parentName:"p"},"kernel module")," \u9700\u6c42\uff0c\u5247\u9700\u8981\u63a1\u7528\u4e0b\u5217\u65b9\u5f0f"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"pushd ~/network-study/iptables/masquerade/module/\nsudo iptables -t nat -D POSTROUTING -s 172.18.0.0/16 ! -o docker0 -j MASQUERADE || true\nmake\nsudo rmmod ipt_MASQUERADE\nsudo insmod ipt_MASQUERADE.ko\nsudo iptables -t nat -A POSTROUTING -s 172.18.0.0/16 -p tcp ! -o docker0 -j MASQUERADE --to-ports 55666-55680|| true\nsudo iptables -t nat -A POSTROUTING -s 172.18.0.0/16 ! -o docker0 -j MASQUERADE || true\n")),(0,a.kt)("p",null,"\u4e3b\u8981\u5dee\u7570\u5728\u65bc\u6211\u5011\u9700\u8981\u91cd\u65b0\u5b89\u88dd\u5efa\u5236\u5f8c\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"kernel module")," \u5230\u7cfb\u7d71\u5167"),(0,a.kt)("h3",{id:"\u6e2c\u8a66\u6d41\u91cf"},"\u6e2c\u8a66\u6d41\u91cf"),(0,a.kt)("p",null,"\u7531\u65bc\u6211\u5011\u662f\u900f\u904e ",(0,a.kt)("strong",{parentName:"p"},"docker")," \u7684\u74b0\u5883\u4f86\u4f7f\u7528 ",(0,a.kt)("strong",{parentName:"p"},"MASQUERADE"),"\uff0c\u6240\u4ee5\u96a8\u4fbf\u627e\u4e00\u500b\u53ef\u4ee5\u5c0d\u5916\u9023\u7dda\u7684 ",(0,a.kt)("strong",{parentName:"p"},"docker")," \u4f86\u6e2c\u8a66\u5373\u53ef"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'sudo docker run --rm --entrypoint "/usr/bin/wget" hwchiu/netutils google.com\n')),(0,a.kt)("h3",{id:"\u89c0\u5bdf\u7d50\u679c"},"\u89c0\u5bdf\u7d50\u679c"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"sudo dmesg -c\n")),(0,a.kt)("p",null,"\u8f38\u5165\u4e0a\u8ff0\u6307\u4ee4\u5f8c\uff0c\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4e0b\u5217\u7684\u8f38\u51fa\uff0c\u6211\u5011\u6311\u91cd\u9ede\u4f86\u770b\u5c31\u597d"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"[  371.727940] original\n[  371.727943] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:33894, dst-ipv4:8.8.8.8, dst-port:53\n[  371.727944] REPLY: outgoing interface: eth0, src-ipv4:8.8.8.8, src-port:53, dst-ipv4:172.18.0.2, dst-port:33894\n[  371.727945] after nat\n[  371.727946] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:33894, dst-ipv4:8.8.8.8, dst-port:53\n[  371.727947] REPLY: outgoing interface: eth0, src-ipv4:8.8.8.8, src-port:53, dst-ipv4:10.0.2.15, dst-port:33894\n[  371.754760] original\n[  371.754763] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:37622, dst-ipv4:216.58.200.46, dst-port:80\n[  371.754764] REPLY: outgoing interface: eth0, src-ipv4:216.58.200.46, src-port:80, dst-ipv4:172.18.0.2, dst-port:37622\n[  371.754766] after nat\n[  371.754767] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:37622, dst-ipv4:216.58.200.46, dst-port:80\n[  371.754768] REPLY: outgoing interface: eth0, src-ipv4:216.58.200.46, src-port:80, dst-ipv4:10.0.2.15, dst-port:55666\n[  371.792826] original\n[  371.792851] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:42676, dst-ipv4:8.8.8.8, dst-port:53\n[  371.792859] REPLY: outgoing interface: eth0, src-ipv4:8.8.8.8, src-port:53, dst-ipv4:172.18.0.2, dst-port:42676\n[  371.792862] after nat\n[  371.792863] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:42676, dst-ipv4:8.8.8.8, dst-port:53\n[  371.792864] REPLY: outgoing interface: eth0, src-ipv4:8.8.8.8, src-port:53, dst-ipv4:10.0.2.15, dst-port:42676\n[  371.807542] original\n[  371.807545] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:34276, dst-ipv4:172.217.160.100, dst-port:80\n[  371.807546] REPLY: outgoing interface: eth0, src-ipv4:172.217.160.100, src-port:80, dst-ipv4:172.18.0.2, dst-port:34276\n[  371.807548] after nat\n[  371.807549] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:34276, dst-ipv4:172.217.160.100, dst-port:80\n[  371.807550] REPLY: outgoing interface: eth0, src-ipv4:172.217.160.100, src-port:80, dst-ipv4:10.0.2.15, dst-port:55666\n[  371.982956] docker0: port 1(veth1cf6a5c) entered disabled state\n[  371.984851] veth96adc5c: renamed from eth0\n[  372.014944] docker0: port 1(veth1cf6a5c) entered disabled state\n[  372.016375] device veth1cf6a5c left promiscuous mode\n[  372.016378] docker0: port 1(veth1cf6a5c) entered disabled state\n")),(0,a.kt)("p",null,"\u56e0\u70ba ",(0,a.kt)("strong",{parentName:"p"},"wget")," \u6293\u53d6\u7db2\u9801\u7684\u904e\u7a0b\u4e2d\uff0c\u5305\u542b\u4e86 ",(0,a.kt)("strong",{parentName:"p"},"HTTP")," \u9023\u7dda\u4ee5\u53ca ",(0,a.kt)("strong",{parentName:"p"},"DNS")," \u67e5\u8a62\uff0c\u6240\u4ee5\u6703\u6709\u5f88\u591a\u689d ",(0,a.kt)("strong",{parentName:"p"},"conntrack")," \u7522\u751f\uff0c\u4e0d\u592a\u610f\u5916\uff0c\u6700\u5f8c\u7684 ",(0,a.kt)("strong",{parentName:"p"},"docker")," \u5247\u662f\u56e0\u70ba ",(0,a.kt)("strong",{parentName:"p"},"docker --rm")," \u8dd1\u5b8c\u5c31\u7d50\u675f\u7684\u95dc\u4fc2\uff0c\u5c0e\u81f4\u76f8\u95dc\u7684 ",(0,a.kt)("strong",{parentName:"p"},"veth")," \u88ab\u6536\u56de\u3002"),(0,a.kt)("p",null,"\u6211\u5011\u6293\u524d\u5169\u689d ",(0,a.kt)("strong",{parentName:"p"},"conntrack")," \u4f86\u770b\u5373\u53ef\uff0c\u9019\u908a\u8981\u6ce8\u610f\u6211\u5011\u7684\u53c3\u6578\u662f ",(0,a.kt)("strong",{parentName:"p"},"--to-ports 55666-55680")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"[  371.727940] before nat\n[  371.727943] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:33894,\n                dst-ipv4:8.8.8.8, dst-port:53\n[  371.727944] REPLY: outgoing interface: eth0, src-ipv4:8.8.8.8, src-port:53,\n                dst-ipv4:172.18.0.2, dst-port:33894\n[  371.727945] after nat\n[  371.727946] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:33894,\n                dst-ipv4:8.8.8.8, dst-port:53\n[  371.727947] REPLY: outgoing interface: eth0, src-ipv4:8.8.8.8, src-port:53,\n                dst-ipv4:10.0.2.15, dst-port:33894\n")),(0,a.kt)("p",null,"\u91dd\u5c0d\u7b2c\u4e00\u689d ",(0,a.kt)("strong",{parentName:"p"},"conntrack"),"\uff0c\u89c0\u5bdf\u5982\u4e0b"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Before NAT")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"ORIGINAL",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 172.18.0.2"),(0,a.kt)("li",{parentName:"ul"},"source_port: 33894"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 8.8.8.8"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 53"))),(0,a.kt)("li",{parentName:"ul"},"REPLY",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 8.8.8.8"),(0,a.kt)("li",{parentName:"ul"},"source_port: 53"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 172.18.0.2"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 33894")))),(0,a.kt)("p",null,"\u9810\u8a2d\u60c5\u6cc1\u4e0b\u7cfb\u7d71\u90fd\u6703\u5047\u8a2d ",(0,a.kt)("strong",{parentName:"p"},"ORIGINAL")," \u8ddf ",(0,a.kt)("strong",{parentName:"p"},"REPLY")," \u662f\u5b8c\u5168\u5c0d\u7a31\u7684\uff0c\u7562\u7adf\u9019\u662f\u6700\u7c21\u55ae\u7684\u6a21\u5f0f\u3002"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"After NAT")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"ORIGINAL",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 172.18.0.2"),(0,a.kt)("li",{parentName:"ul"},"source_port: 33894"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 8.8.8.8"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 53"))),(0,a.kt)("li",{parentName:"ul"},"REPLY",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 8.8.8.8"),(0,a.kt)("li",{parentName:"ul"},"source_port: 53"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 10.0.2.15"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 33894")))),(0,a.kt)("p",null,"\u9019\u908a\u53ef\u4ee5\u770b\u5230\u4e00\u65e6\u57f7\u884c ",(0,a.kt)("strong",{parentName:"p"},"NAT")," \u5f8c\uff0c ",(0,a.kt)("strong",{parentName:"p"},"ORIGINAL")," \u5b8c\u5168\u6c92\u6709\u6539\u8b8a\uff0c\u4f46\u662f ",(0,a.kt)("strong",{parentName:"p"},"REPLY")," \u88e1\u9762\u7684 ",(0,a.kt)("strong",{parentName:"p"},"destination_ip")," \u5247\u66f4\u52d5\u4e86\u3002\n\u5c0d\u65bc\u9019\u6a23\u7684\u6539\u52d5\u53ef\u4ee5\u6709\u4e0b\u5217\u7684\u89e3\u8b80\u65b9\u5f0f"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u9810\u8a2d\u60c5\u6cc1\u4e0b\uff0c ",(0,a.kt)("strong",{parentName:"li"},"MASQUERADE")," \u5c0d\u65bc ",(0,a.kt)("strong",{parentName:"li"},"DNS")," \u4e0d\u6703\u7279\u5225\u5e6b\u4f60\u6311\u9078\u9023\u63a5\u57e0\uff0c\u800c\u662f\u4f60\u672c\u4f86\u9001\u904e\u4f86\u524d\u662f\u4ec0\u9ebc\uff0c\u5c31\u662f\u4ec0\u9ebc\u3002 ",(0,a.kt)("strong",{parentName:"li"},"TCP\u4e5f\u662f\uff0c\u53ef\u4ee5\u81ea\u884c\u4fee\u6539\u898f\u5247\u53bb\u9a57\u8b49")),(0,a.kt)("li",{parentName:"ol"},"\u5c0d\u65bc ",(0,a.kt)("strong",{parentName:"li"},"Linux Kernel")," \u4f86\u8aaa\uff0c\u9019\u689d ",(0,a.kt)("strong",{parentName:"li"},"conntrack")," \u7684\u5169\u500b\u65b9\u5411\u5206\u5225\u5c0d\u61c9",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u4f86\u6e90\u5c01\u5305\u5f9e\u5bb9\u5668\u9001\u5230\u7db2\u5361"),(0,a.kt)("li",{parentName:"ul"},"\u56de\u61c9\u5c01\u5305\u5f9e\u5916\u90e8\u5230\u7db2\u5361"))),(0,a.kt)("li",{parentName:"ol"},"\u7576\u9019\u689d ",(0,a.kt)("strong",{parentName:"li"},"conntrack")," \u88ab\u78ba\u8a8d\u4e4b\u5f8c\uff0c\u63a5\u4e0b\u4f86\u6240\u6709\u5f9e ",(0,a.kt)("strong",{parentName:"li"},"ORIGINAL")," \u7684\u5c01\u5305\u5c31\u6703\u81ea\u52d5\u5730\u88ab\u4fee\u6b63\u5176 ",(0,a.kt)("strong",{parentName:"li"},"source ip"),"\uff0c\u5c31\u4e0d\u6703\u88ab ",(0,a.kt)("strong",{parentName:"li"},"iptables")," \u7684\u898f\u5247\u518d\u6b21\u57f7\u884c\u4e86\uff0c\u7b97\u662f\u4e00\u500b\u5c0f\u52a0\u901f\u3002")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"[  371.754760] before nat\n[  371.754763] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:37622,\n                dst-ipv4:216.58.200.46, dst-port:80\n[  371.754764] REPLY: outgoing interface: eth0, src-ipv4:216.58.200.46, src-port:80,\n                dst-ipv4:172.18.0.2, dst-port:37622\n[  371.754766] after nat\n[  371.754767] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:37622,\n                dst-ipv4:216.58.200.46, dst-port:80\n[  371.754768] REPLY: outgoing interface: eth0, src-ipv4:216.58.200.46, src-port:80,\n                dst-ipv4:10.0.2.15, dst-port:55666\n")),(0,a.kt)("p",null,"\u63a5\u4e0b\u4f86\u770b\u4e00\u4e0b ",(0,a.kt)("strong",{parentName:"p"},"wget")," \u6307\u4ee4\u7684\u4e3b\u9ad4\uff0c *",(0,a.kt)("em",{parentName:"p"},"HTTP")," \u9023\u7dda\u7684\u72c0\u6cc1"),(0,a.kt)("p",null,"\u91dd\u5c0d\u7b2c\u4e00\u689d ",(0,a.kt)("strong",{parentName:"p"},"conntrack"),"\uff0c\u89c0\u5bdf\u5982\u4e0b"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Before NAT")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"ORIGINAL",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 172.18.0.2"),(0,a.kt)("li",{parentName:"ul"},"source_port: 37622"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 216.58.200.46"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 80"))),(0,a.kt)("li",{parentName:"ul"},"REPLY",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 216.58.200.46"),(0,a.kt)("li",{parentName:"ul"},"source_port: 80"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 172.18.0.2"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 37622")))),(0,a.kt)("p",null,"\u9810\u8a2d\u60c5\u6cc1\u4e0b\u7cfb\u7d71\u90fd\u6703\u5047\u8a2d ",(0,a.kt)("strong",{parentName:"p"},"ORIGINAL")," \u8ddf ",(0,a.kt)("strong",{parentName:"p"},"REPLY")," \u662f\u5b8c\u5168\u5c0d\u7a31\u7684\uff0c\u7562\u7adf\u9019\u662f\u6700\u7c21\u55ae\u7684\u6a21\u5f0f\u3002"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"After NAT")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"ORIGINAL",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 172.18.0.2"),(0,a.kt)("li",{parentName:"ul"},"source_port: 37622"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 216.58.200.46"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 80"))),(0,a.kt)("li",{parentName:"ul"},"REPLY",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 216.58.200.46"),(0,a.kt)("li",{parentName:"ul"},"source_port: 53"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 10.0.2.15"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 55666")))),(0,a.kt)("p",null,"\u9019\u908a\u53ef\u4ee5\u770b\u5230\u4e00\u65e6\u57f7\u884c ",(0,a.kt)("strong",{parentName:"p"},"NAT")," \u5f8c\uff0c ",(0,a.kt)("strong",{parentName:"p"},"ORIGINAL")," \u5b8c\u5168\u6c92\u6709\u6539\u8b8a\uff0c\u4f46\u662f ",(0,a.kt)("strong",{parentName:"p"},"REPLY")," \u88e1\u9762\u7684 ",(0,a.kt)("strong",{parentName:"p"},"destination_ip")," \u4ee5\u53ca ",(0,a.kt)("strong",{parentName:"p"},"destination_port")," \u5247\u66f4\u52d5\u4e86\u3002"),(0,a.kt)("p",null,"\u9019\u908a\u7684\u89e3\u8b80\u53bb\u4e0a\u8ff0\u76f8\u540c\uff0c\u552f\u4e00\u4e0d\u540c\u7684\u662f ",(0,a.kt)("strong",{parentName:"p"},"port")," \u6700\u5f8c\u8b8a\u6210 ",(0,a.kt)("strong",{parentName:"p"},"55666"),"\uff0c\u9019\u500b\u5c31\u662f\u6211\u5011\u5148\u524d\u900f\u904e ",(0,a.kt)("strong",{parentName:"p"},"--to-ports 55666-55680")," \u53bb\u8a2d\u5b9a\u7684\u5340\u9593\u3002"),(0,a.kt)("h2",{id:"ip-\u9078\u64c7\u89c0\u5bdf"},"IP \u9078\u64c7\u89c0\u5bdf"),(0,a.kt)("p",null,"\u7b2c\u4e8c\u500b\u5be6\u9a57\u5247\u662f\u8981\u89c0\u5bdf\u5982\u679c\u7db2\u5361\u6709\u591a\u91cd ",(0,a.kt)("strong",{parentName:"p"},"IP")," \u7684\u8a71\uff0c\u6703\u600e\u9ebc\u9078\u64c7\uff0c\u70ba\u4e86\u5b8c\u6210\u9019\u500b\u6e2c\u8a66\u6211\u5011\u9700\u8981\u505a\u76f8\u95dc\u7684\u64cd\u4f5c"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u5c0d\u4e3b\u8981\u8f38\u51fa\u7db2\u5361\u65b0\u589e\u4e00\u500b\u4e0d\u540c\u7db2\u6bb5\u7684 ",(0,a.kt)("strong",{parentName:"li"},"IP")," \u5730\u5740"),(0,a.kt)("li",{parentName:"ol"},"\u900f\u904e ",(0,a.kt)("strong",{parentName:"li"},"docker run")," \u7684\u65b9\u5f0f\u53bb\u7522\u751f ",(0,a.kt)("strong",{parentName:"li"},"TCP")," \u5c01\u5305\uff0c\u4e26\u4e14\u89c0\u5bdf ",(0,a.kt)("strong",{parentName:"li"},"kernel")," \u7684\u8f38\u51fa\u7d50\u679c")),(0,a.kt)("p",null,"\u9019\u90e8\u5206\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u6cbf\u7528\u4e0a\u500b\u5be6\u9a57\u7684 ",(0,a.kt)("strong",{parentName:"p"},"iptables")," \u898f\u5247\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u984d\u5916\u8655\u7406\uff0c\u7576\u7136\u5982\u679c\u6709\u9700\u8981\u4fee\u6539 ",(0,a.kt)("strong",{parentName:"p"},"kernel module")," \u4f86\u89c0\u5bdf\u7684\u8a71\uff0c\u5c31\u9700\u8981\u9032\u884c\u4e00\u6a23\u7684\u52d5\u4f5c"),(0,a.kt)("h3",{id:"\u8a2d\u5b9aip"},"\u8a2d\u5b9aIP"),(0,a.kt)("p",null,"Vagrant \u7684\u74b0\u5883\u4e2d\uff0ceth0 \u662f\u4e3b\u8981\u7684\u5c0d\u5916\u7db2\u5361\uff0c\u6211\u5011\u5c0d\u5176\u589e\u52a0\u4e00\u500b\u4e0d\u540c\u7db2\u6bb5\u7684 ",(0,a.kt)("strong",{parentName:"p"},"IP"),"\uff0c\u540c\u6642\u4e5f\u589e\u52a0\u4e86\u4e00\u500b\u8def\u7531\u898f\u5247\uff0c\u5e0c\u671b\u9001\u5f80 ",(0,a.kt)("strong",{parentName:"p"},"1.1.1.1")," \u7684\u5c01\u5305\u6703\u5617\u8a66\u5148\u8d70\u5230 ",(0,a.kt)("strong",{parentName:"p"},"1.2.3.4")," \u53bb"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"sudo ip addr add 1.2.3.56/24 dev eth0\nsudo route add 1.1.1.1 gw 1.2.3.4 dev eth0\n")),(0,a.kt)("p",null,"\u63a5\u8005\u6211\u5011\u89c0\u5bdf\u9810\u8a2d\u7684\u8def\u7531\u8868\u8207 IP \u8a2d\u5b9a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@linux-study:~/network-study/iptables/masquerade/module$ sudo route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         10.0.2.2        0.0.0.0         UG    100    0        0 eth0\n1.1.1.1         1.2.3.4         255.255.255.255 UGH   0      0        0 eth0\n1.2.3.0         0.0.0.0         255.255.255.0   U     0      0        0 eth0\n10.0.2.0        0.0.0.0         255.255.255.0   U     0      0        0 eth0\n10.0.2.2        0.0.0.0         255.255.255.255 UH    100    0        0 eth0\n172.17.8.0      0.0.0.0         255.255.255.0   U     0      0        0 eth1\n172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0\n\nvagrant@linux-study:~/network-study/iptables/masquerade/module$ ip addr show dev eth0\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000\n    link/ether 08:00:27:c2:be:11 brd ff:ff:ff:ff:ff:ff\n    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0\n       valid_lft 81500sec preferred_lft 81500sec\n    inet 1.2.3.56/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::a00:27ff:fec2:be11/64 scope link\n       valid_lft forever preferred_lft forever\n")),(0,a.kt)("p",null,"\u9019\u908a\u53ea\u8981\u78ba\u8a8d"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"1.1.1.1/32 \u6703\u8d70 ",(0,a.kt)("strong",{parentName:"li"},"eth0")," \u4e26\u4e14 gateway \u662f 1.2.3.4"),(0,a.kt)("li",{parentName:"ol"},"1.2.3.0/24 \u6703\u8d70 ",(0,a.kt)("strong",{parentName:"li"},"eth0"),"\uff0c\u56e0\u70ba ",(0,a.kt)("strong",{parentName:"li"},"eth0")," \u672c\u8eab\u6709\u76f8\u540c\u7db2\u6bb5\u7684 ",(0,a.kt)("strong",{parentName:"li"},"IP"),"\uff0c\u56e0\u6b64\u5c31\u4e0d\u9700\u8981 ",(0,a.kt)("strong",{parentName:"li"},"gateway")," \u7684\u8655\u7406\uff0c\u76f4\u63a5\u8f49\u767c\u5373\u53ef\u3002")),(0,a.kt)("h3",{id:"\u6e2c\u8a66\u6d41\u91cf-1"},"\u6e2c\u8a66\u6d41\u91cf"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'vagrant@linux-study:~/network-study/iptables/masquerade/module$ sudo docker run --rm --entrypoint "/usr/bin/wget" hwchiu/netutils 1.1.1.1\n--2020-01-02 04:28:29--  http://1.1.1.1/\nConnecting to 1.1.1.1:80... failed: No route to host.\n')),(0,a.kt)("p",null,"\u9019\u908a\u6211\u5011\u4e0d\u9700\u8981\u8003\u616e\u76ee\u7684\u5730\u7684\u7db2\u9801\u4f3a\u670d\u5668\u662f\u5426\u771f\u7684\u5b58\u5728\uff0c\u540c\u6642\u9019\u500b\u7bc4\u4f8b\u4e2d\u4e5f\u4e0d\u8003\u616e ",(0,a.kt)("strong",{parentName:"p"},"DNS")," \u7684\u67e5\u8a62\uff0c\u6211\u5011\u76f4\u63a5\u89c0\u5bdf ",(0,a.kt)("strong",{parentName:"p"},"TCP")," \u7684\u7d50\u679c\u5373\u53ef"),(0,a.kt)("p",null,"\u6839\u64da\u524d\u7bc7\u6587\u7ae0\u7684\u63a2\u8a0e\uff0c ",(0,a.kt)("strong",{parentName:"p"},"MASQUERADE")," \u6703\u5148\u67e5\u8a62 ",(0,a.kt)("strong",{parentName:"p"},"routing table")," \u4e2d\u7684\u898f\u5247\u5f97\u5230\u8981\u9001\u51fa\u7684 ",(0,a.kt)("strong",{parentName:"p"},"next-hop"),"\u3002\u63a5\u8005\u5f9e\u76ee\u6a19\u7db2\u5361\u7684\u773e\u591a ",(0,a.kt)("strong",{parentName:"p"},"\u975e SECONDARY")," ",(0,a.kt)("strong",{parentName:"p"},"IP")," \u5730\u5740\u4e2d\u53bb\u6311\u9078\u4e00\u500b\u7b26\u5408\u7684\u4f86\u9001\u51fa\u3002"),(0,a.kt)("p",null,"\u6309\u7167\u4e0a\u8ff0\u7684\u731c\u60f3\uff0c\u6574\u500b\u904e\u7a0b\u6703"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u6839\u64da routing table, ",(0,a.kt)("inlineCode",{parentName:"li"},"1.1.1.1")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"next-hop")," \u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"1.2.3.4")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"eth0")," \u4e0a\u9762\u80fd\u5920\u7b26\u5408 ",(0,a.kt)("inlineCode",{parentName:"li"},"1.2.3.4")," \u7684 IP \u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"1.2.3.56/24"))),(0,a.kt)("p",null,"\u6240\u4ee5\u6700\u5f8c\u9810\u671f\u9001\u51fa\u53bb\u7684 ",(0,a.kt)("strong",{parentName:"p"},"IP")," \u5fc5\u9808\u662f **1.2.3.56"),(0,a.kt)("p",null,"\u63a5\u4e0b\u4f86\u89c0\u5bdf ",(0,a.kt)("inlineCode",{parentName:"p"},"1.1.1.1")," \u7684\u7d50\u679c\u4e26\u9a57\u8b49\u731c\u6e2c"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"[ 1879.823479] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:59734,\n                dst-ipv4:1.1.1.1, dst-port:80\n[ 1879.823480] REPLY: outgoing interface: eth0, src-ipv4:1.1.1.1, src-port:80,\n                dst-ipv4:172.18.0.2, dst-port:59734\n[ 1879.823482] after nat\n[ 1879.823483] ORIGINAL: outgoing interface: eth0, src-ipv4:172.18.0.2, src-port:59734,\n                dst-ipv4:1.1.1.1, dst-port:80\n[ 1879.823484] REPLY: outgoing interface: eth0, src-ipv4:1.1.1.1, src-port:80,\n                dst-ipv4:1.2.3.56, dst-port:55666\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Before NAT")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"ORIGINAL",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 172.18.0.2"),(0,a.kt)("li",{parentName:"ul"},"source_port: 59734"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 1.1.1.1"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 80"))),(0,a.kt)("li",{parentName:"ul"},"REPLY",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 1.1.1.1"),(0,a.kt)("li",{parentName:"ul"},"source_port: 80"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 172.18.0.2"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 59734")))),(0,a.kt)("p",null,"\u9810\u8a2d\u60c5\u6cc1\u4e0b\u7cfb\u7d71\u90fd\u6703\u5047\u8a2d ",(0,a.kt)("strong",{parentName:"p"},"ORIGINAL")," \u8ddf ",(0,a.kt)("strong",{parentName:"p"},"REPLY")," \u662f\u5b8c\u5168\u5c0d\u7a31\u7684\uff0c\u7562\u7adf\u9019\u662f\u6700\u7c21\u55ae\u7684\u6a21\u5f0f\u3002"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"After NAT")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"ORIGINAL",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 172.18.0.2"),(0,a.kt)("li",{parentName:"ul"},"source_port: 59734"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 1.1.1.1"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 80"))),(0,a.kt)("li",{parentName:"ul"},"REPLY",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"source_ip: 1.1.1.1"),(0,a.kt)("li",{parentName:"ul"},"source_port: 80"),(0,a.kt)("li",{parentName:"ul"},"destination_ip: 1.2.3.56"),(0,a.kt)("li",{parentName:"ul"},"destination_port: 55666")))),(0,a.kt)("p",null,"\u9019\u908a\u53ef\u4ee5\u89c0\u5bdf\u5230\u6700\u5f8c\u8f49\u63db\u7684 ",(0,a.kt)("strong",{parentName:"p"},"IP")," \u5730\u5740\u5247\u662f ",(0,a.kt)("strong",{parentName:"p"},"1.2.3.56")," \u800c\u4e0d\u662f\u6700\u521d ",(0,a.kt)("strong",{parentName:"p"},"eth0")," \u4e0a\u9762\u7684 ",(0,a.kt)("strong",{parentName:"p"},"10.0.2.15/24"),", \u4e5f\u7b97\u662f\u7a0d\u5fae\u9a57\u8b49\u4e86\u4e00\u4e0b\u591a\u91cd ",(0,a.kt)("strong",{parentName:"p"},"IP")," \u7684\u9078\u64c7\uff0c\u4e26\u975e\u55ae\u7d14\u7684\u5148\u4f86\u5f8c\u5230\uff0c\u800c\u662f\u9084\u8981\u8003\u616e\u5230\u7db2\u6bb5\u7684\u7b26\u5408\u3002"),(0,a.kt)("h1",{id:"summary"},"Summary"),(0,a.kt)("p",null,"\u672c\u7bc7\u6587\u7ae0\u900f\u904e\u4fee\u6539 ",(0,a.kt)("strong",{parentName:"p"},"MASQUERADE")," \u539f\u59cb\u78bc\u7684\u65b9\u5f0f\u4f86\u89c0\u5bdf\u5176\u904b\u4f5c\u7684\u65b9\u5f0f\uff0c\u5f97\u5230\u7684\u7d50\u8ad6\u662f \u4e0d\u8ad6\u662f ",(0,a.kt)("strong",{parentName:"p"},"SNAT")," \u6216\u662f ",(0,a.kt)("strong",{parentName:"p"},"DNAT"),"\uff0c\u5176\u6700\u5f8c\u7684\u4fee\u6539\u90fd\u9ad4\u73fe\u5728 ",(0,a.kt)("strong",{parentName:"p"},"conntrack")," \u9019\u500b\u7d50\u69cb\u4e0a\uff0c\u900f\u904e\u4fee\u6539 ",(0,a.kt)("strong",{parentName:"p"},"ORIGINAL")," \u6216\u662f ",(0,a.kt)("strong",{parentName:"p"},"REPLY")," \u5169\u500b\u65b9\u5411\u4f86\u9810\u671f\u6700\u5f8c\u770b\u5230\u7684\u5c01\u5305\u7d50\u69cb\u3002"),(0,a.kt)("p",null,"\u5c0d\u65bc ",(0,a.kt)("strong",{parentName:"p"},"MASQUERADE(TCP/DNS)")," \u4f86\u8aaa\uff0c\u9810\u8a2d\u7684\u60c5\u6cc1\u4e0b\u4e0d\u6703\u5e6b\u4f60\u4fee\u6539\u5c01\u5305\u7684\u4f86\u6e90\u9023\u7d50\u57e0\uff0c\u82e5\u6709\u9700\u8981\u4fee\u6539\u5fc5\u9808\u8981\u900f\u904e\u4e4b\u524d\u63d0\u904e\u7684\u53c3\u6578 ",(0,a.kt)("strong",{parentName:"p"},"--to-ports")," \u4ee5\u53ca ",(0,a.kt)("strong",{parentName:"p"},"--random")," \u4f86\u4fee\u6539\uff0c\u672c\u6587\u4e2d\u6c92\u6709\u7279\u5225\u63d0\u5230 ",(0,a.kt)("strong",{parentName:"p"},"--random")," \u7684\u90e8\u5206\u662f\u56e0\u70ba\u8207 ",(0,a.kt)("strong",{parentName:"p"},"--to-ports")," \u5927\u540c\u5c0f\u7570\uff0c\u81ea\u884c\u4fee\u6539\u76f8\u95dc\u6307\u4ee4\u5c31\u53ef\u4ee5\u9032\u884c\u6e2c\u8a66\u3002"))}m.isMDXComponent=!0}}]);