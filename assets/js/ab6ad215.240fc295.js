"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[96667],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>k});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),p=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(l.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=p(t),m=r,k=c["".concat(l,".").concat(m)]||c[m]||d[m]||s;return t?a.createElement(k,o(o({ref:n},u),{},{components:t})):a.createElement(k,o({ref:n},u))}));function k(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var s=t.length,o=new Array(s);o[0]=m;var i={};for(var l in n)hasOwnProperty.call(n,l)&&(i[l]=n[l]);i.originalType=e,i[c]="string"==typeof e?e:r,o[1]=i;for(var p=2;p<s;p++)o[p]=t[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},7518:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>p});var a=t(87462),r=(t(67294),t(3905));const s={title:"Container Storage Interface(CSI) - NFS \u521d\u9ad4\u9a57",sidebar_position:20,date:new Date("2019-10-05T18:10:08.000Z"),tags:["Kubernetes","CSI","Storage","iThome"],description:"\u524d\u8ff0\u5206\u4eab\u4e86\u95dc\u65bc\u4e0d\u5c11 Container Storage Interface \u7684\u4e8b\u60c5\uff0c\u63a5\u4e0b\u4f86\u6211\u5011\u76f4\u63a5\u4f7f\u7528 NFS \u4f5c\u70ba\u7bc4\u4f8b\uff0c\u4f86\u770b\u770b\u8981\u5982\u4f55\u900f\u904e CSI \u7684\u67b6\u69cb\u4f86\u639b\u8f09 NFS \u5230 kubernetes cluster \u4e2d\u4f9b\u904b\u7b97\u8cc7\u6e90\u4f7f\u7528"},o="\u524d\u8a00",i={unversionedId:"techPost/2019/iThome_Challenge/csi-nfs",id:"techPost/2019/iThome_Challenge/csi-nfs",title:"Container Storage Interface(CSI) - NFS \u521d\u9ad4\u9a57",description:"\u524d\u8ff0\u5206\u4eab\u4e86\u95dc\u65bc\u4e0d\u5c11 Container Storage Interface \u7684\u4e8b\u60c5\uff0c\u63a5\u4e0b\u4f86\u6211\u5011\u76f4\u63a5\u4f7f\u7528 NFS \u4f5c\u70ba\u7bc4\u4f8b\uff0c\u4f86\u770b\u770b\u8981\u5982\u4f55\u900f\u904e CSI \u7684\u67b6\u69cb\u4f86\u639b\u8f09 NFS \u5230 kubernetes cluster \u4e2d\u4f9b\u904b\u7b97\u8cc7\u6e90\u4f7f\u7528",source:"@site/docs/techPost/2019/iThome_Challenge/csi-nfs.md",sourceDirName:"techPost/2019/iThome_Challenge",slug:"/techPost/2019/iThome_Challenge/csi-nfs",permalink:"/docs/techPost/2019/iThome_Challenge/csi-nfs",draft:!1,tags:[{label:"Kubernetes",permalink:"/docs/tags/kubernetes"},{label:"CSI",permalink:"/docs/tags/csi"},{label:"Storage",permalink:"/docs/tags/storage"},{label:"iThome",permalink:"/docs/tags/i-thome"}],version:"current",sidebarPosition:20,frontMatter:{title:"Container Storage Interface(CSI) - NFS \u521d\u9ad4\u9a57",sidebar_position:20,date:"2019-10-05T18:10:08.000Z",tags:["Kubernetes","CSI","Storage","iThome"],description:"\u524d\u8ff0\u5206\u4eab\u4e86\u95dc\u65bc\u4e0d\u5c11 Container Storage Interface \u7684\u4e8b\u60c5\uff0c\u63a5\u4e0b\u4f86\u6211\u5011\u76f4\u63a5\u4f7f\u7528 NFS \u4f5c\u70ba\u7bc4\u4f8b\uff0c\u4f86\u770b\u770b\u8981\u5982\u4f55\u900f\u904e CSI \u7684\u67b6\u69cb\u4f86\u639b\u8f09 NFS \u5230 kubernetes cluster \u4e2d\u4f9b\u904b\u7b97\u8cc7\u6e90\u4f7f\u7528"},sidebar:"techPost",previous:{title:"Container Storage Interface \u8207 kubernetes",permalink:"/docs/techPost/2019/iThome_Challenge/csi-iii"},next:{title:"CSI \u96dc\u8ac7",permalink:"/docs/techPost/2019/iThome_Challenge/csi-other"}},l={},p=[{value:"\u5b89\u88dd\u5167\u5bb9",id:"\u5b89\u88dd\u5167\u5bb9",level:2},{value:"Controller",id:"controller",level:3},{value:"Node",id:"node",level:3},{value:"Nginx",id:"nginx",level:3},{value:"\u89c0\u5bdf",id:"\u89c0\u5bdf",level:2},{value:"CSIDriver",id:"csidriver",level:3},{value:"CSINodes",id:"csinodes",level:3},{value:"VolumeAttachments",id:"volumeattachments",level:3}],u={toc:p},c="wrapper";function d(e){let{components:n,...t}=e;return(0,r.kt)(c,(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u524d\u8a00"},"\u524d\u8a00"),(0,r.kt)("p",null,"\u672c\u6587\u6703\u900f\u904e\u4f7f\u7528 ",(0,r.kt)("strong",{parentName:"p"},"CSI")," \u7684\u65b9\u5f0f\u65bc kubernetes \u5167\u4f7f\u7528 NFS \u4f5c\u70ba\u5132\u5b58\u89e3\u6c7a\u65b9\u6848\uff0c\u4e26\u4e14\u5617\u8a66\u89c0\u5bdf\u5404\u7a2e\u8207  CSI \u6709\u95dc\u7684\u6982\u5ff5\u8207\u67b6\u69cb\uff0c\u5617\u8a66\u5c07\u5be6\u969b\u90e8\u7f72\u7684\u7d50\u679c\u8207\u524d\u7bc7\u6587\u7ae0\u63a2\u8a0e\u7684\u67b6\u69cb\u8207\u6587\u4ef6\u7d50\u5408\u3002"),(0,r.kt)("h1",{id:"nfs"},"NFS"),(0,r.kt)("p",null,"\u5148\u524d\u6211\u6709\u5beb\u904e\u4e00\u7bc7\u95dc\u65bc ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u5404\u7a2e\u7528\u6cd5\u7684\u6587\u7ae0\uff0c\u6709\u8208\u8da3\u7684\u4eba\u53ef\u4ee5\u524d\u5f80\u95b1\u8b80 ",(0,r.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/kubernetes-storage-ii.html"},"NFS \u65bc Kubernetes \u5167\u7684\u5404\u7a2e\u61c9\u7528\n"),"\n\u5728\u8a72\u7bc7\u6587\u7ae0\u88e1\u9762\u6211\u63cf\u8ff0\u4e86\u5169\u7a2e ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u7684\u7528\u6cd5\uff0c\u7b2c\u4e00\u7a2e\u5c31\u662f\u6700\u57fa\u672c\u7684\u67b6\u8a2d\u4e00\u500b ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u670d\u52d9\u5668\uff0c\u63a5\u8005\u5c07\u5176\u5206\u4eab\u51fa\u4f86\u7684\u7a7a\u9593\u76f4\u63a5\u639b\u8f09\u5230\u6b32\u4f7f\u7528\u7684 ",(0,r.kt)("strong",{parentName:"p"},"Pod"),"\uff0c\u9019\u7a2e\u60c5\u6cc1\u4e0b\u5c31\u662f ",(0,r.kt)("strong",{parentName:"p"},"NFS"),"\u670d\u52d9\u5668\u4e0a\u9762\u6709\u4ec0\u9ebc\u6a23\u7684\u8cc7\u6e90\u8207\u6a94\u6848\uff0c\u5247 ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u88e1\u9762\u770b\u5230\u7684\u4e5f\u5c31\u662f\u76f8\u540c\u7684\u8cc7\u6e90\u3002\u9019\u7a2e\u7528\u6cd5\u4e5f\u662f\u6700\u5e38\u898b\u7684\u4f7f\u7528\u65b9\u6cd5\u3002"),(0,r.kt)("p",null,"\u800c\u7b2c\u4e8c\u7a2e\u65b9\u6cd5\u5247\u662f\u5e0c\u671b\u63a1\u7528 ",(0,r.kt)("strong",{parentName:"p"},"StorageClass")," \u7684\u65b9\u5f0f\u4f86\u4f7f\u7528 ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u4f3a\u670d\u5668\uff0c\u9019\u7a2e\u60c5\u6cc1\u4e0b\u5c31\u662f ",(0,r.kt)("strong",{parentName:"p"},"NFS"),"\u670d\u52d9\u5668\u672c\u8eab\u4e5f\u662f\u6703\u5206\u4eab\u4e00\u500b\u7a7a\u9593\uff0c\u4f46\u662f\u6bcf\u6b21\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"StorageClass")," \u4ee5\u53ca ",(0,r.kt)("strong",{parentName:"p"},"PVC")," \u7d81\u5b9a\u7684\u60c5\u6cc1\u4e0b\uff0c\u6703\u5728 ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u5206\u4eab\u7684\u8cc7\u6599\u593e\u5167\u5728\u5275\u5efa\u4e00\u500b\u8cc7\u6599\u593e\uff0c\u5c08\u5c6c\u7d66\u8a72 ",(0,r.kt)("strong",{parentName:"p"},"PVC")," \u53bb\u4f7f\u7528\uff0c\u4f7f\u7528\u8d77\u4f86\u7684\u611f\u89ba\u5c31\u50cf\u662f\u52d5\u614b\u5206\u5272\u7a7a\u9593\u4e00\u6a23\uff0c\u9019\u90e8\u5206\u904e\u53bb\u662f\u4ef0\u8cf4\u984d\u5916\u7684 ",(0,r.kt)("strong",{parentName:"p"},"NFS Provisioner")," \u4f86\u5be6\u73fe\u3002"),(0,r.kt)("p",null,"\u800c\u672c\u6587\u8981\u8a0e\u8ad6\u7684\u67b6\u69cb\u5c6c\u65bc\u7b2c\u4e00\u7a2e\uff0c\u6240\u4ee5\u5230\u6642\u5019\u639b\u8f09\u7684 ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u5167\u90e8\u89c0\u770b\u5230\u7684\u8cc7\u6599\u5c31\u6703\u8207 ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u672c\u8eab\u5206\u4eab\u7684\u8cc7\u6599\u4e00\u81f4\u3002"),(0,r.kt)("h1",{id:"\u74b0\u5883\u5efa\u7f6e"},"\u74b0\u5883\u5efa\u7f6e"),(0,r.kt)("p",null,"\u672c\u6587\u74b0\u5883\u57fa\u65bc"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"kubernetes: 1.15.3"),(0,r.kt)("li",{parentName:"ol"},"CSI: 1.0.0"),(0,r.kt)("li",{parentName:"ol"},"NFS CSI Driver: ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/hwchiu/csi-driver-nfs"},"https://github.com/hwchiu/csi-driver-nfs"),"\n\u5f9e\u5b98\u65b9 fork \u904e\u4f86\uff0c\u4f46\u662f\u7a0d\u5fae\u8abf\u6574\u4e86\u4e00\u4e0b nfs \u639b\u8f09\u7684\u4f4d\u7f6e\u4ee5\u53ca\u76f8\u95dc\u7684 image tag")),(0,r.kt)("p",null,"\u4e0a\u8ff0\u7684\u74b0\u5883\u5df2\u7d93\u6574\u7406\u6210\u4e00\u500b ",(0,r.kt)("strong",{parentName:"p"},"Vagrant")," \u7684\u6a94\u6848"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ruby="},'# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nVagrant.configure("2") do |config|\n  config.vm.box = "bento/ubuntu-18.04"\n  config.vm.hostname = \'k8s-dev\'\n  config.vm.define vm_name = \'k8s\'\n\n  config.vm.provision "shell", privileged: false, inline: <<-SHELL\n    set -e -x -u\n    export DEBIAN_FRONTEND=noninteractive\n\n    #change the source.list\n    sudo apt-get update\n    sudo apt-get install -y vim git cmake build-essential tcpdump tig jq\n    # Install ntp\n    sudo apt-get install -y ntp\n    # Install Docker\n    # kubernetes official max validated version: 17.03.2~ce-0~ubuntu-xenial\n    export DOCKER_VERSION="18.06.3~ce~3-0~ubuntu"\n    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\n    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"\n    sudo apt-get update\n    sudo apt-get install -y docker-ce=${DOCKER_VERSION}\n\n    # Install Kubernetes\n    export KUBE_VERSION="1.15.3"\n    export NET_IF_NAME="enp0s8"\n    curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -\n    echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee --append /etc/apt/sources.list.d/kubernetes.list\n    sudo apt-get update\n    sudo apt-get install -y kubeadm=${KUBE_VERSION}-00 kubelet=${KUBE_VERSION}-00 kubectl=${KUBE_VERSION}-00 kubernetes-cni=0.7.5-00\n    # Disable swap\n    sudo swapoff -a && sudo sysctl -w vm.swappiness=0\n    sudo sed \'/swap.img/d\' -i /etc/fstab\n    sudo kubeadm init --kubernetes-version v${KUBE_VERSION} --apiserver-advertise-address=172.17.8.101 --pod-network-cidr=10.244.0.0/16\n    mkdir -p $HOME/.kube\n    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n    sudo chown $(id -u):$(id -g) $HOME/.kube/config\n    kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml\n    kubectl taint nodes --all node-role.kubernetes.io/master-\n\n    sudo apt-get install -qqy nfs-kernel-server\n    sudo mkdir /nfsshare\n    sudo mkdir /nfsshare/mongodb\n    sudo mkdir /nfsshare/influxdb\n    sudo mkdir /nfsshare/user\n    echo "/nfsshare *(rw,sync,no_root_squash)" | sudo tee /etc/exports\n    sudo exportfs -r\n    sudo showmount -e\n\n    git clone https://github.com/hwchiu/csi-driver-nfs.git\n    kubectl apply -f csi-driver-nfs/deploy/kubernetes/\n    kubectl apply -f csi-driver-nfs/examples/kubernetes/nginx.yaml\n  SHELL\n\n  config.vm.network :private_network, ip: "172.17.8.101"\n  config.vm.provider :virtualbox do |v|\n      v.customize ["modifyvm", :id, "--cpus", 2]\n      v.customize ["modifyvm", :id, "--memory", 4096]\n      v.customize [\'modifyvm\', :id, \'--nicpromisc1\', \'allow-all\']\n  end\nend\n')),(0,r.kt)("p",null,"\u8a72\u6a94\u6848\u6703\u81ea\u52d5\u67b6\u8a2d\u4e00\u500b\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"1.15.3")," \u7684 ",(0,r.kt)("strong",{parentName:"p"},"kubernetes cluster"),"\uff0c\u540c\u6642\u4e5f\u6703\u81ea\u52d5\u5b89\u88dd ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u4f3a\u670d\u5668\uff0c\u4e26\u4e14\u5c07\u5176\u5e95\u4e0b\u7684 ",(0,r.kt)("strong",{parentName:"p"},"/nfsshare")," \u8cc7\u6599\u593e\u5206\u4eab\u51fa\u53bb\u3002"),(0,r.kt)("p",null,"\u6b64\u5916\u4e5f\u6703\u81ea\u52d5\u90e8\u7f72 ",(0,r.kt)("strong",{parentName:"p"},"NFS CSI")," \u89e3\u6c7a\u65b9\u6848\u7684\u76f8\u95dc\u6a94\u6848\uff0c\u4e26\u4e14\u6700\u5f8c\u90e8\u7f72\u4e00\u500b\u4f7f\u7528\u8a72 ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u670d\u52d9\u7684 ",(0,r.kt)("strong",{parentName:"p"},"nginx")," \u4f5c\u70ba\u4e00\u500b\u7bc4\u4f8b\u3002"),(0,r.kt)("p",null,"\u5982\u679c\u9047\u5230\u4e0b\u5217\u932f\u8aa4\uff0c\u5c31\u9032\u5230\u6a5f\u5668\u5f8c\u91cd\u65b0\u5275\u5efa\u4e00\u6b21 ",(0,r.kt)("strong",{parentName:"p"},"nginx")," \u76f8\u95dc\u7684\u6a94\u6848\u5373\u53ef"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},'k8s: Error from server (Forbidden): error when creating "csi-driver-nfs/examples/kubernetes/nginx.yaml": pods "nginx" is forbidden: error looking up service account default/default: serviceaccount "default" not found\n####\n$ kubectl apply -f csi-driver-nfs/examples/kubernetes/nginx.yaml\n')),(0,r.kt)("h2",{id:"\u5b89\u88dd\u5167\u5bb9"},"\u5b89\u88dd\u5167\u5bb9"),(0,r.kt)("p",null,"\u63a5\u4e0b\u4f86\u6211\u5011\u4f86\u770b\u4e00\u4e0b\u525b\u525b\u5b89\u88dd\u7684\u904e\u7a0b\u5230\u5e95\u88dd\u4e86\u54ea\u4e9b\u8cc7\u6e90\u5230\u7cfb\u7d71\u4e2d\uff0c\u9019\u908a\u6211\u5011\u5c31\u5ffd\u7565\u5176\u4ed6\u8cc7\u6e90\uff0c\u5c08\u6ce8\u65bc\u8ddf\u5132\u5b58\u6709\u95dc\u7684\u8cc7\u6e90\u4e0a"),(0,r.kt)("h3",{id:"controller"},"Controller"),(0,r.kt)("p",null,"\u9996\u5148\u6211\u5011\u5148\u770b\u4e00\u4e0b\u6240\u8b02\u7684 ",(0,r.kt)("strong",{parentName:"p"},"CSI")," Controller  \u76f8\u95dc\u7684\u8a2d\u5b9a\u6a94\u6848\uff0c\u5982\u4e4b\u524d\u6240\u8ff0\uff0c\u9019\u7a2e\u60c5\u6cc1\u901a\u5e38\u6703\u4f7f\u7528 ",(0,r.kt)("strong",{parentName:"p"},"StatefulSet")," \u4f86\u8a2d\u5b9a\uff0c\u9664\u975e\u4f60\u7684 ",(0,r.kt)("strong",{parentName:"p"},"Controller")," \u672c\u8eab\u6709\u984d\u5916\u5be6\u73fe\u591a\u5be6\u4f8b\u7684\u67b6\u69cb\uff0c\u53ef\u78ba\u4fdd\u540c\u6642\u53ea\u6709\u6703\u4e00\u500b\u526f\u672c\u6b63\u5728\u904b\u884c\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},'kind: StatefulSet\napiVersion: apps/v1beta1\nmetadata:\n  name: csi-attacher-nfsplugin\nspec:\n  serviceName: "csi-attacher"\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: csi-attacher-nfsplugin\n    spec:\n      serviceAccount: csi-attacher\n      containers:\n        - name: csi-attacher\n          image: quay.io/k8scsi/csi-attacher:v1.0.1\n          args:\n            - "--v=5"\n            - "--csi-address=$(ADDRESS)"\n          env:\n            - name: ADDRESS\n              value: /csi/csi.sock\n          imagePullPolicy: "IfNotPresent"\n          volumeMounts:\n            - name: socket-dir\n              mountPath: /csi\n\n        - name: nfs\n          image: quay.io/k8scsi/nfsplugin:canary\n          args :\n            - "--nodeid=$(NODE_ID)"\n            - "--endpoint=$(CSI_ENDPOINT)"\n          env:\n            - name: NODE_ID\n              valueFrom:\n                fieldRef:\n                  fieldPath: spec.nodeName\n            - name: CSI_ENDPOINT\n              value: unix://plugin/csi.sock\n          imagePullPolicy: "IfNotPresent"\n          volumeMounts:\n            - name: socket-dir\n              mountPath: /plugin\n      volumes:\n        - name: socket-dir\n          emptyDir:\n')),(0,r.kt)("p",null,"\u8a72 ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u4e2d\u904b\u884c\u4e86\u5169\u500b ",(0,r.kt)("strong",{parentName:"p"},"Container"),"\uff0c\u5206\u5225\u662f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"quay.io/k8scsi/nfsplugin:canary"),(0,r.kt)("li",{parentName:"ol"},"quay.io/k8scsi/csi-attacher:v1.0.1")),(0,r.kt)("p",null,"\u7b2c\u4e00\u500b\u5247\u662f\u95dc\u65bc\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u6240\u5be6\u73fe\u76f8\u5bb9\u65bc ",(0,r.kt)("strong",{parentName:"p"},"CSI Controller")," \u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u800c\u7b2c\u4e8c\u500b\u5247\u662f\u7531\u5b98\u65b9\u63a8\u51fa\u4fbf\u65bc\u767c\u958b\u8005\u7684 ",(0,r.kt)("strong",{parentName:"p"},"sidecar container"),"\uff0c\u7528\u4f86\u76e3\u807d\u76f8\u95dc\u7684 kubernetes \u4e8b\u4ef6\u4e26\u4e14\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"gRPC")," \u7684\u65b9\u5f0f\u544a\u77e5\u7b2c\u4e00\u500b\u5bb9\u5668\u3002"),(0,r.kt)("p",null,"\u9019\u908a\u540c\u6642\u53ef\u4ee5\u89c0\u5bdf\u5230"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u7cfb\u7d71\u4e0a\u900f\u904e ",(0,r.kt)("strong",{parentName:"li"},"emptyDir")," \u7684\u65b9\u5f0f\u5275\u5efa\u4e86\u4e00\u500b\u7a7a\u9593\uff0c\u4e26\u4e14\u8b93\u5169\u500b ",(0,r.kt)("strong",{parentName:"li"},"container")," \u90fd\u5171\u540c\u4f7f\u7528\uff0c\u800c\u8a72\u6a94\u6848\u5247\u662f\u5176\u5be6\u80cc\u5f8c\u5c31\u662f\u5275\u5efa\u51fa\u4f86\u7684 ",(0,r.kt)("strong",{parentName:"li"},"unix://plugin/csi.sock"),"\uff0c \u56e0\u6b64\u9019\u5169\u500b ",(0,r.kt)("strong",{parentName:"li"},"container")," \u5c31\u6703\u900f\u904e\u9019\u7a2e\u65b9\u5f0f\u4f86\u9032\u884c IPC \u7684\u4ea4\u8ac7\u3002")),(0,r.kt)("h3",{id:"node"},"Node"),(0,r.kt)("p",null,"\u63a5\u4e0b\u4f86\u89c0\u5bdf\u4e00\u4e0b\u53e6\u5916\u4e00\u500b\u90e8\u7f72\uff0c\u4f7f\u7528 ",(0,r.kt)("strong",{parentName:"p"},"DaemonSet")," \u4f86\u90e8\u7f72\uff0c\u5c0d\u61c9\u7684\u5c31\u662f\u4e4b\u524d\u63d0\u5230\u7684 ",(0,r.kt)("strong",{parentName:"p"},"CSI Node")," \u670d\u52d9\uff0c\u662f\u5fc5\u9808\u6bcf\u53f0\u9700\u8981\u4f7f\u7528\u5132\u5b58\u65b9\u6848\u7684\u7bc0\u9ede\u90fd\u8981\u90e8\u7f72\u7684\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml="},'kind: DaemonSet\napiVersion: apps/v1beta2\nmetadata:\n  name: csi-nodeplugin-nfsplugin\nspec:\n  selector:\n    matchLabels:\n      app: csi-nodeplugin-nfsplugin\n  template:\n    metadata:\n      labels:\n        app: csi-nodeplugin-nfsplugin\n    spec:\n      serviceAccount: csi-nodeplugin\n      hostNetwork: true\n      containers:\n        - name: node-driver-registrar\n          image: quay.io/k8scsi/csi-node-driver-registrar:v1.0.2\n          lifecycle:\n            preStop:\n              exec:\n                command: ["/bin/sh", "-c", "rm -rf /registration/csi-nfsplugin /registration/csi-nfsplugin-reg.sock"]\n          args:\n            - --v=5\n            - --csi-address=/plugin/csi.sock\n            - --kubelet-registration-path=/var/lib/kubelet/plugins/csi-nfsplugin/csi.sock\n          env:\n            - name: KUBE_NODE_NAME\n              valueFrom:\n                fieldRef:\n                  fieldPath: spec.nodeName\n          volumeMounts:\n            - name: plugin-dir\n              mountPath: /plugin\n            - name: registration-dir\n              mountPath: /registration\n        - name: nfs\n          securityContext:\n            privileged: true\n            capabilities:\n              add: ["SYS_ADMIN"]\n            allowPrivilegeEscalation: true\n          image: quay.io/k8scsi/nfsplugin:canary\n          args :\n            - "--nodeid=$(NODE_ID)"\n            - "--endpoint=$(CSI_ENDPOINT)"\n          env:\n            - name: NODE_ID\n              valueFrom:\n                fieldRef:\n                  fieldPath: spec.nodeName\n                - name:\n            - name: CSI_ENDPOINT\n              value: unix://plugin/csi.sock\n          imagePullPolicy: "IfNotPresent"\n          volumeMounts:\n            - name: plugin-dir\n              mountPath: /plugin\n            - name: pods-mount-dir\n              mountPath: /var/lib/kubelet/pods\n              mountPropagation: "Bidirectional"\n      volumes:\n        - name: plugin-dir\n          hostPath:\n            path: /var/lib/kubelet/plugins/csi-nfsplugin\n            type: DirectoryOrCreate\n        - name: pods-mount-dir\n          hostPath:\n            path: /var/lib/kubelet/pods\n            type: Directory\n        - hostPath:\n            path: /var/lib/kubelet/plugins_registry\n            type: Directory\n          name: registration-dir\n')),(0,r.kt)("p",null,"\u8a72 ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u4e2d\u4e5f\u662f\u90e8\u7f72\u4e86\u5169\u500b ",(0,r.kt)("strong",{parentName:"p"},"Container"),"\uff0c\u5206\u5225\u662f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"quay.io/k8scsi/csi-node-driver-registrar:v1.0.2"),(0,r.kt)("li",{parentName:"ol"},"quay.io/k8scsi/nfsplugin:canary")),(0,r.kt)("p",null,"\u8ddf ",(0,r.kt)("strong",{parentName:"p"},"Controller")," \u7684\u90e8\u7f72\u4e00\u6a23\uff0c\u5176\u4e2d\u4e00\u500b\u662f\u81ea\u884c\u89e3\u6c7a\u65b9\u6848\u7684\u8a2d\u8a08\uff0c\u53e6\u5916\u4e00\u500b\u5247\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u597d\u7528\u8f14\u52a9\u5bb9\u5668\u3002"),(0,r.kt)("p",null,"\u9996\u5148\u770b\u4e00\u4e0b",(0,r.kt)("strong",{parentName:"p"},"Volume")," \u7684\u90e8\u5206\uff0c\u9019\u908a\u6709\u4e09\u500b\u8cc7\u6599\u593e\u4e26\u4e14\u90fd\u662f\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"hostpath")," \u7684\u65b9\u5f0f\u4f86\u4f7f\u7528"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"/var/lib/kubelet/plugins/csi-nfsplugin"),(0,r.kt)("li",{parentName:"ol"},"/var/lib/kubelet/pods"),(0,r.kt)("li",{parentName:"ol"},"/var/lib/kubelet/plugins_registry")),(0,r.kt)("p",null,"\u7b2c\u4e00\u500b ",(0,r.kt)("strong",{parentName:"p"},"/var/lib/kubelet/plugins/csi-nfsplugin")," \u6839\u64da\u89c0\u5bdf\u53ef\u4ee5\u767c\u73fe\u6700\u5f8c\u5176\u5be6\u662f\u7528\u4f86\u6307\u5b9a\u76f8\u95dc\u7684 ",(0,r.kt)("strong",{parentName:"p"},"unix socket"),"\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ sudo ls /var/lib/kubelet/plugins/csi-nfsplugin\ncsi.sock\n\nvagrant@k8s-dev:~$ sudo file /var/lib/kubelet/plugins/csi-nfsplugin/csi.sock\n/var/lib/kubelet/plugins/csi-nfsplugin/csi.sock: socket\n")),(0,r.kt)("p",null,"\u7b2c\u4e8c\u500b ",(0,r.kt)("strong",{parentName:"p"},"/var/lib/kubelet/pods")," \u6bd4\u8f03\u7279\u5225\uff0c\u9019\u500b\u8cc7\u6599\u593e\u662f ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u7528\u4f86\u5b58\u653e\u8ddf ",(0,r.kt)("strong",{parentName:"p"},"pod")," \u76f8\u95dc\u7684\u8cc7\u8a0a\uff0c\u5176\u4e2d\u8a72\u76ee\u9304\u5e95\u4e0b\u90fd\u662f\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"pod ID")," \u4f86\u5340\u9694\u7684\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},'vagrant@k8s-dev:~$ sudo ls /var/lib/kubelet/pods/\n16010371-22a4-4152-af23-712def2a764d  7a5a5fa4-ea62-4106-8e2e-69f3a0abf48d  8bf65cf7-a02a-4829-9fab-784355fe5ba5  af50052304877bc1d4cd4d3409c6be5a      c3aedceb2d751faeb02f85ebcec869a6      db52b7d4-c828-49d8-b899-e52be600f0b5\n28f76958a7cfb29c8091821d6746ddea      7d5d3c0a6786e517a8973fa06754cb75      9f7d3f8c-63a8-46b9-8d69-d70656caf0b7  bd4f816d-01f0-4217-a66c-27bd4893c130  c9da1474-797c-4386-acb1-f7c74cc30dbd\n\nvagrant@k8s-dev:~$ sudo docker ps | grep nginx\n2107ec8d04e1        maersk/nginx                               "nginx"                  10 hours ago        Up 10 hours                             k8s_nginx_nginx_default_8bf65cf7-a02a-4829-9fab-784355fe5ba5_0\ndad41423889e        k8s.gcr.io/pause:3.1                       "/pause"                 10 hours ago        Up 10 hours                             k8s_POD_nginx_default_8bf65cf7-a02a-4829-9fab-784355fe5ba5_0\n\nvagrant@k8s-dev:~$ sudo ls /var/lib/kubelet/pods/8bf65cf7-a02a-4829-9fab-784355fe5ba5\ncontainers  etc-hosts  plugins  volumes\nvagrant@k8s-dev:~$\n')),(0,r.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\u57fa\u65bc\u6e2c\u8a66\u7684 ",(0,r.kt)("strong",{parentName:"p"},"nginx pod")," \u5e95\u4e0b\u6709\u500b volumes \u7684\u8cc7\u6599\u593e\uff0c\u63a5\u4e0b\u4f86\u5f80\u4e0b\u53bb\u770b\u88e1\u9762\u6709\u4ec0\u9ebc\u8cc7\u8a0a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},'vagrant@k8s-dev:~$ sudo tree /var/lib/kubelet/pods/8bf65cf7-a02a-4829-9fab-784355fe5ba5/volumes\n/var/lib/kubelet/pods/8bf65cf7-a02a-4829-9fab-784355fe5ba5/volumes\n\u251c\u2500\u2500 kubernetes.io~csi\n\u2502 \u2514\u2500\u2500 data-nfsplugin\n|     \u251c\u2500\u2500 mount\n\u2502     \u2502 \u251c\u2500\u2500 influxdb\n\u2502     \u2502 \u251c\u2500\u2500 mongodb\n\u2502     \u2502 \u251c\u2500\u2500 test1\n\u2502     \u2502 \u2514\u2500\u2500 user\n\u2502     \u2514\u2500\u2500 vol_data.json\n\u2514\u2500\u2500 kubernetes.io~secret\n    \u2514\u2500\u2500 default-token-6bcvc\n        \u251c\u2500\u2500 ca.crt -> ..data/ca.crt\n        \u251c\u2500\u2500 namespace -> ..data/namespace\n        \u2514\u2500\u2500 token -> ..data/token\n\nvagrant@k8s-dev:~$ sudo cat /var/lib/kubelet/pods/8bf65cf7-a02a-4829-9fab-784355fe5ba5/volumes//kubernetes.io~csi/data-nfsplugin/vol_data.json | jq\n{\n  "attachmentID": "csi-f642ae48557f63a1f4377a265c43d6afe2e8d859837925fef2331b9e541e31a3",\n  "driverMode": "persistent",\n  "driverName": "csi-nfsplugin",\n  "nodeName": "k8s-dev",\n  "specVolID": "data-nfsplugin",\n  "volumeHandle": "data-id"\n}\n')),(0,r.kt)("p",null,"\u540c\u6642\u4e5f\u53ef\u4ee5\u770b\u5230\u4e0a\u8ff0\u7684 ",(0,r.kt)("strong",{parentName:"p"},"mount"),"  \u8cc7\u6599\u593e\u5167\u6709\u4e4b\u524d\u8a2d\u5b9a\u7684 ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u76f8\u95dc\u7684\u5206\u4eab\u8cc7\u6599\u593e\u5167\u5bb9\uff0c\u9019\u90e8\u5206\u5f15\u8d77\u6211\u7684\u597d\u5947\u5fc3\uff0c\u6240\u4ee5\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"mount")," \u518d\u6b21\u89c0\u5bdf\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ mount | grep nfsshare\n127.0.0.1:/nfsshare on /var/lib/kubelet/pods/8bf65cf7-a02a-4829-9fab-784355fe5ba5/volumes/kubernetes.io~csi/data-nfsplugin/mount type nfs4 (rw,relatime,vers=4.1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=127.0.0.1,local_lock=none,addr=127.0.0.1)\n")),(0,r.kt)("p",null,"\u5927\u6982\u53ef\u4ee5\u77ad\u89e3\u6574\u500b\u904b\u4f5c\u539f\u7406\u4e86\uff0c\u5148\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"CSI")," \u7684\u65b9\u5f0f\u628a\u76ee\u6a19\u7684\u89e3\u6c7a\u65b9\u6848\u639b\u8f09\u5230\u76f8\u95dc\u7bc0\u9ede\u4e0a\uff0c\u800c\u639b\u8f09\u7684\u5730\u9ede\u5fc5\u9808\u662f ",(0,r.kt)("strong",{parentName:"p"},"/var/lib/kubelet/pods/${pod_id}/volumes/kubernetes.io~csi/${csi_name}")," \u9019\u500b\u4f4d\u7f6e\uff0c\u7576\u9019\u908a\u8655\u7406\u5b8c\u7562\u5f8c\u3002\u4e00\u65e6 ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u958b\u59cb\u555f\u7528\u5f8c\uff0c\u5c31\u6703\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"mount namespace")," \u7684\u65b9\u5f0f\u518d\u5ea6\u7684\u628a\u9019\u500b\u7a7a\u9593\u7d66\u639b\u8f09\u5230 ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u88e1\u9762\u53bb\u4f7f\u7528\u3002"),(0,r.kt)("p",null,"\u6700\u5f8c\u7684 ",(0,r.kt)("strong",{parentName:"p"},"/var/lib/kubelet/plugins_registry")," \u770b\u540d\u7a31\u5c31\u8ddf\u8a3b\u518a\u6709\u95dc\uff0c\u7684\u78ba\u4e5f\u662f\u5c08\u9580\u7d66 ",(0,r.kt)("strong",{parentName:"p"},"Register")," \u9019\u500b\u984d\u5916\u7684\u5bb9\u5668\u4f7f\u7528\u3002\n\u6839\u64da\u8a72",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes-csi/node-driver-registrar"},"\u5c08\u6848\u8aaa\u660e")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Registration socket:\nRegisters the driver with kubelet.\nCreated by the node-driver-registrar.\nExposed on a Kubernetes node via hostpath in the Kubelet plugin registry. (typically /var/lib/kubelet/plugins_registry/$drivername.example.com-reg.sock). The hostpath volume must be mounted at /registration.")),(0,r.kt)("p",null,"\u6240\u4ee5\u53ef\u4ee5\u770b\u5230\u9019\u7b97\u662f\u4e00\u500b\u8a72\u5bb9\u5668\u7684\u6a19\u6e96\u7528\u6cd5\uff0c\u5982\u679c\u8981\u5c07\u8a72CSI\u89e3\u6c7a\u65b9\u6848\u8a3b\u518a\u5230 ",(0,r.kt)("strong",{parentName:"p"},"Node")," \u4e0a\uff0c\u5c31\u76f4\u63a5\u900f\u904e\u9019\u500b\u5bb9\u5668\u52a0\u4e0a ",(0,r.kt)("strong",{parentName:"p"},"Unix socket")," \u8207 ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u6e9d\u901a\uff0c\u5c31\u7b97\u662f\u5b8c\u6210\u8a3b\u518a\u76f8\u95dc\u7684\u529f\u80fd\u4e86\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ sudo ls /var/lib/kubelet/plugins_registry\ncsi-nfsplugin-reg.sock\nvagrant@k8s-dev:~$ sudo file /var/lib/kubelet/plugins_registry/csi-nfsplugin-reg.sock\n/var/lib/kubelet/plugins_registry/csi-nfsplugin-reg.sock: socket\n")),(0,r.kt)("p",null,"\u6839\u64da\u5b98\u65b9\u63d0\u4f9b\u7684\u53c3\u8003\u90e8\u7f72\u67b6\u69cb\u5716\n",(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/sx31Z1w.png",alt:null}),"\n\u8a72\u5716\u7bc0\u9304\u81ea",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/blog/2019/01/15/container-storage-interface-ga/"},"Recommended Mechanism for Deploying CSI Drivers on Kubernetes\n")),(0,r.kt)("p",null,"\u53ef\u4ee5\u5c0d\u61c9\u5230\u4e0a\u8ff0\u6240\u63cf\u8ff0\u7684\u90e8\u7f72\u65b9\u5f0f\u4ee5\u53ca\u76f8\u95dc\u7684 ",(0,r.kt)("strong",{parentName:"p"},"volume")," \u64cd\u4f5c\uff0c\u540c\u6642\u5c0d\u65bc\u6574\u9ad4\u7684\u904b\u4f5c\u908f\u8f2f\u6709\u66f4\u6e05\u6670\u7684\u8868\u9054\u3002"),(0,r.kt)("h3",{id:"nginx"},"Nginx"),(0,r.kt)("p",null,"\u4f5c\u70ba\u4e00\u500b\u4f7f\u7528\u8005 ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u4f86\u8aaa\uff0c\u9019\u908a\u63a1\u7528 ",(0,r.kt)("strong",{parentName:"p"},"PV/PVC")," \u9019\u7a2e\u9810\u5148\u914d\u7f6e\u7684\u65b9\u5f0f\u4f86\u4f7f\u7528\u524d\u8ff0\u90e8\u7f72\u5b8c\u7562\u7684 ",(0,r.kt)("strong",{parentName:"p"},"CSI")," \u74b0\u5883\uff0c\u5176\u4e2d\u53ea\u6709 ",(0,r.kt)("strong",{parentName:"p"},"PV")," \u7684\u90e8\u5206\u4f7f\u7528\u65b9\u5f0f\u8ddf\u904e\u5f80\u4e0d\u540c\uff0c\u5269\u4e0b\u7684 ",(0,r.kt)("strong",{parentName:"p"},"PVC/Pod")," \u90fd\u6c92\u6709\u4efb\u4f55\u8b8a\u5316\u3002"),(0,r.kt)("p",null,"\u53ef\u4ee5\u770b\u5230 ",(0,r.kt)("strong",{parentName:"p"},"PV")," \u4e4b\u4e2d\u5fc5\u9808\u8981\u63a1\u7528 ",(0,r.kt)("strong",{parentName:"p"},"csi")," \u7684\u67b6\u69cb\uff0c\u4e26\u4e14\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"volumeAttrivutes")," \u50b3\u905e\u6bcf\u500b\u89e3\u6c7a\u65b9\u6848\u9700\u8981\u7684\u53c3\u6578\u904e\u53bb\uff0c\u4ee5 ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u70ba\u7bc4\u4f8b\uff0c\u5c31\u662f\u76ee\u6a19\u4f3a\u670d\u5668\u7684 ",(0,r.kt)("strong",{parentName:"p"},"IP")," \u5730\u5740\u4ee5\u53ca\u6b32\u5206\u4eab\u7684\u8cc7\u6599\u593e\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml="},'apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: data-nfsplugin\n  labels:\n    name: data-nfsplugin\nspec:\n  accessModes:\n  - ReadWriteMany\n  capacity:\n    storage: 100Gi\n  csi:\n    driver: csi-nfsplugin\n    volumeHandle: data-id\n    volumeAttributes:\n      server: 127.0.0.1\n      share: /nfsshare\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: data-nfsplugin\nspec:\n  accessModes:\n  - ReadWriteMany\n  resources:\n    requests:\n      storage: 100Gi\n  selector:\n    matchExpressions:\n    - key: name\n      operator: In\n      values: ["data-nfsplugin"]\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx\nspec:\n  containers:\n  - image: maersk/nginx\n    imagePullPolicy: Always\n    name: nginx\n    ports:\n    - containerPort: 80\n      protocol: TCP\n    volumeMounts:\n      - mountPath: /var/www\n        name: data-nfsplugin\n  volumes:\n  - name: data-nfsplugin\n    persistentVolumeClaim:\n      claimName: data-nfsplugin\n')),(0,r.kt)("h2",{id:"\u89c0\u5bdf"},"\u89c0\u5bdf"),(0,r.kt)("p",null,"\u74b0\u5883\u90fd\u67b6\u8a2d\u5b8c\u7562\u4e4b\u5f8c\uff0c\u7b2c\u4e00\u6b65\u5148\u89c0\u5bdf ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u662f\u5426\u5982\u9810\u671f\u822c\u7684\u904b\u4f5c"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ kubectl exec nginx ls /var/www\ninfluxdb\nmongodb\nuser\n\nvagrant@k8s-dev:~$ ls /nfsshare/\ninfluxdb  mongodb  user\n\nvagrant@k8s-dev:~$ sudo touch /nfsshare/test1\n\nvagrant@k8s-dev:~$ kubectl exec nginx ls /var/www\ninfluxdb\nmongodb\ntest1\nuser\n")),(0,r.kt)("p",null,"\u770b\u8d77\u4f86\u975e\u5e38\u9806\u5229\uff0c\u57fa\u672c\u7684 ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u639b\u8f09\u5df2\u7d93\u6210\u529f\uff0c\u63a5\u4e0b\u4f86\u6211\u5011\u5c31\u8981\u4f86\u89c0\u5bdf\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"CSI")," \u7684\u74b0\u5883\u6709\u4ec0\u9ebc\u4e0d\u540c"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ kubectl api-resources | grep -i storage\ncsidrivers                                     storage.k8s.io                 false        CSIDriver\ncsinodes                                       storage.k8s.io                 false        CSINode\nstorageclasses                    sc           storage.k8s.io                 false        StorageClass\nvolumeattachments                              storage.k8s.io                 false        VolumeAttachment\n")),(0,r.kt)("p",null,"\u6211\u5011\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"kubectl api-resources")," \u53bb\u89c0\u5bdf\u7cfb\u7d71\u4e0a\u76ee\u524d\u6709\u54ea\u4e9b\u8ddf ",(0,r.kt)("strong",{parentName:"p"},"storage")," \u6709\u95dc\u7684\u8cc7\u6e90\uff0c\u767c\u73fe\u9664\u4e86\u904e\u5f80\u7684 ",(0,r.kt)("strong",{parentName:"p"},"storageclasses")," \u4e4b\u5916\uff0c\u9084\u591a\u51fa\u4e86\u4e09\u500b\u8cc7\u6e90\uff0c\u5206\u5225\u662f ",(0,r.kt)("strong",{parentName:"p"},"csidrivers"),", ",(0,r.kt)("strong",{parentName:"p"},"csinodes")," \u4ee5\u53ca ",(0,r.kt)("strong",{parentName:"p"},"volumeattachmenets"),"\u3002"),(0,r.kt)("h3",{id:"csidriver"},"CSIDriver"),(0,r.kt)("p",null,"\u975e\u5e38\u4e0d\u5e78\u7684\uff0c\u6211\u5011\u7684\u7bc4\u4f8b\u4e2d\u4e26\u6c92\u6709\u5275\u5efa\u4efb\u4f55\u8cc7\u6e90\u65bc\u9019\u500b\u7269\u4ef6\u985e\u5225\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"vagrant@k8s-dev:~$ kubectl get csidrivers\nNo resources found.\n")),(0,r.kt)("p",null,"\u6839\u64da",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes-csi.github.io/docs/csi-driver-object.html"},"\u5b98\u65b9\u958b\u767c\u6307\u5357"),"\uff0c\u88e1\u9762\u5c0d\u65bc ",(0,r.kt)("strong",{parentName:"p"},"CSIDriver")," \u7684\u63cf\u8ff0\u662f"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"The CSIDriver Kubernetes API object serves two purposes:\nSimplify driver discovery\nIf a CSI driver creates a CSIDriver object, Kubernetes users can easily discover the CSI Drivers installed on their cluster (simply by issuing kubectl get CSIDriver)\nCustomizing Kubernetes behavior\nKubernetes has a default set of behaviors when dealing with CSI Drivers (for example, it calls the Attach/Detach operations by default). This object\nallows CSI drivers to specify how Kubernetes should interact with it.")),(0,r.kt)("p",null,"\u7c21\u55ae\u4f86\u8aaa\u9019\u500b\u8cc7\u6e90\u4e0d\u4e00\u5b9a\u6703\u6709\uff0c\u4e3b\u8981\u53d6\u6c7a\u65bc ",(0,r.kt)("strong",{parentName:"p"},"CSI")," \u89e3\u6c7a\u65b9\u6848\u6709\u6c92\u6709\u8981\u5275\u5efa\uff0c\u5275\u5efa\u7684\u8a71\u63d0\u4f9b\u5169\u500b\u597d\u8655"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u4f7f\u7528\u8005\u66f4\u5bb9\u6613\u7684\u89c0\u5bdf\u5230\u7cfb\u7d71\u4e0a\u5b89\u88dd\u4e86\u54ea\u4e9b ",(0,r.kt)("strong",{parentName:"li"},"CSI")," \u89e3\u6c7a\u65b9\u6848\n\u6211\u8a8d\u70ba\u9019\u6eff\u65b9\u4fbf\u7684\uff0c\u4f46\u662f\u80fd\u5920\u5f37\u5236\u8981\u6c42\u5275\u5efa\u8a72\u7269\u4ef6\u5c31\u66f4\u68d2\u4e86"),(0,r.kt)("li",{parentName:"ol"},"\u8b93 ",(0,r.kt)("strong",{parentName:"li"},"CSI"),"\u89e3\u6c7a\u65b9\u6848\u80fd\u5920\u6709\u6a5f\u6703\u5c0d ",(0,r.kt)("strong",{parentName:"li"},"kubelet")," \u9032\u884c\u63a7\u5236\uff0c\u53bb\u7ba1\u7406\u6574\u500b ",(0,r.kt)("strong",{parentName:"li"},"CSI")," \u7684\u904b\u4f5c\u908f\u8f2f\u3002")),(0,r.kt)("p",null,"\u4e00\u500b\u5408\u6cd5\u7684\u5167\u5bb9\u53ef\u80fd\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml="},"apiVersion: storage.k8s.io/v1beta1\nkind: CSIDriver\nmetadata:\n  name: mycsidriver.example.com\nspec:\n  attachRequired: true\n  podInfoOnMount: true\n  volumeLifecycleModes: # added in Kubernetes 1.16\n  - Persistent\n  - Ephemeral\n")),(0,r.kt)("p",null,"\u5176\u4e2d ",(0,r.kt)("strong",{parentName:"p"},"volumeLifycecleModes")," \u751a\u81f3\u662f ",(0,r.kt)("strong",{parentName:"p"},"kubernetes 1.16")," \u6240\u52a0\u5165\u7684\uff0c\u6709\u8208\u8da3\u7684\u53ef\u4ee5\u81ea\u884c\u53c3\u95b1",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes-csi.github.io/docs/csi-driver-object.html#what-fields-does-the-csidriver-object-have"},"\u958b\u767c\u6307\u5357")," \u53bb\u77ad\u89e3\u6bcf\u500b\u6b04\u4f4d\u7684\u5b9a\u7fa9\u3002"),(0,r.kt)("h3",{id:"csinodes"},"CSINodes"),(0,r.kt)("p",null,"\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"kubectl describe")," \u6211\u5011\u53ef\u4ee5\u770b\u5230\u66f4\u591a\u95dc\u65bc ",(0,r.kt)("strong",{parentName:"p"},"CSINodes")," \u7684\u8cc7\u6599\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ kubectl get csinodes\nNAME      CREATED AT\nk8s-dev   2019-09-29T07:19:27Z\nvagrant@k8s-dev:~$ kubectl describe csinodes k8s-dev\nName:         k8s-dev\nNamespace:\nLabels:       <none>\nAnnotations:  <none>\nAPI Version:  storage.k8s.io/v1beta1\nKind:         CSINode\nMetadata:\n  Creation Timestamp:  2019-09-29T07:19:27Z\n  Owner References:\n    API Version:     v1\n    Kind:            Node\n    Name:            k8s-dev\n    UID:             8ed067fe-dbe7-4297-8177-c8a9da227962\n  Resource Version:  540\n  Self Link:         /apis/storage.k8s.io/v1beta1/csinodes/k8s-dev\n  UID:               1fd550dd-194a-4f20-8d41-fd1f42fbe16a\nSpec:\n  Drivers:\n    Name:           csi-nfsplugin\n    Node ID:        k8s-dev\n    Topology Keys:  <nil>\nEvents:             <none>\n")),(0,r.kt)("p",null,"\u5176\u4e2d\u6700\u91cd\u8981\u7684\u5c31\u662f ",(0,r.kt)("strong",{parentName:"p"},"spec.drivers")," \u5167\u7684\u8cc7\u6599\uff0c\u5305\u542b\u4e86"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u8a72\u89e3\u6c7a\u65b9\u6848\u7684\u540d\u7a31\uff0c\u5b9a\u7fa9\u65bc\u8a72\u89e3\u6c7a\u65b9\u6848\u5167\u7684\u7a0b\u5f0f\u78bc\u3002"),(0,r.kt)("li",{parentName:"ol"},"\u8a72\u7bc0\u9ede\u7684\u540d\u7a31\uff0c\u56e0\u70ba ",(0,r.kt)("strong",{parentName:"li"},"CSI")," \u88e1\u9762\u6709\u5f88\u591a\u7684\u4ecb\u9762\u90fd\u6703\u9700\u8981 ",(0,r.kt)("strong",{parentName:"li"},"NodeID")," \u4f86\u9032\u884c\u4e00\u4e9b\u8655\u7406\uff0c\u7279\u5225\u662f ",(0,r.kt)("strong",{parentName:"li"},"Controller")," \u7aef\u7684\u4ecb\u9762\u3002")),(0,r.kt)("p",null,"\u6839\u64da ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes-csi.github.io/docs/csi-node-object.html#what-is-the-csinode-object"},"\u5b98\u65b9\u958b\u767c\u6307\u5357")," \u5167\u7684\u63cf\u8ff0\uff0c CSINode \u6709\u4e0b\u5217\u7684\u4e8b\u9805\u8981\u6ce8\u610f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"CSI")," \u89e3\u6c7a\u65b9\u6848\u672c\u8eab\u4e0d\u9700\u8981\u81ea\u884c\u5275\u9020\uff0c\u53ea\u8981\u900f\u904e\u4e0a\u7bc7\u4ecb\u7d39\u904e\u7684\u958b\u767c\u5c0f\u5e6b\u624b - sidecar containers \u4e2d\u7684 ",(0,r.kt)("strong",{parentName:"li"},"node-device-register")," \u5c31\u6703\u81ea\u52d5\u5275\u9020\u8a72\u7269\u4ef6"),(0,r.kt)("li",{parentName:"ol"},"\u8a72\u7269\u4ef6\u5275\u7acb\u7684\u76ee\u7684\u662f\u5e0c\u671b\u63d0\u4f9b\u4e0b\u5217\u8cc7\u8a0a",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5c07 kubernetes node \u7684\u540d\u7a31\u8f49\u63db\u81f3 CSI node name"),(0,r.kt)("li",{parentName:"ul"},"\u900f\u904e\u76f8\u95dc\u7269\u4ef6\u5224\u65b7\u7279\u5b9a\u7bc0\u9ede\u4e0a\u662f\u5426\u6709\u8a3b\u518a\u76f8\u95dc\u7684 CSI \u89e3\u6c7a\u65b9\u6848")))),(0,r.kt)("h3",{id:"volumeattachments"},"VolumeAttachments"),(0,r.kt)("p",null,"\u9019\u500b\u7269\u4ef6\u662f\u7528\u4f86\u63cf\u8ff0 ",(0,r.kt)("strong",{parentName:"p"},"CSI")," \u4f7f\u7528\u904e\u7a0b\u4e2d\u53bb\u639b\u8f09 ",(0,r.kt)("strong",{parentName:"p"},"Volume")," \u7684\u76f8\u95dc\u8cc7\u8a0a\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ kubectl get volumeattachments\nNAME                                                                   ATTACHER        PV               NODE      ATTACHED   AGE\ncsi-f642ae48557f63a1f4377a265c43d6afe2e8d859837925fef2331b9e541e31a3   csi-nfsplugin   data-nfsplugin   k8s-dev   true       20m\nvagrant@k8s-dev:~$ kubectl describe volumeattachments\nName:         csi-f642ae48557f63a1f4377a265c43d6afe2e8d859837925fef2331b9e541e31a3\nNamespace:\nLabels:       <none>\nAnnotations:  <none>\nAPI Version:  storage.k8s.io/v1\nKind:         VolumeAttachment\nMetadata:\n  Creation Timestamp:  2019-09-29T07:19:49Z\n  Resource Version:    577\n  Self Link:           /apis/storage.k8s.io/v1/volumeattachments/csi-f642ae48557f63a1f4377a265c43d6afe2e8d859837925fef2331b9e541e31a3\n  UID:                 991d3c32-0d4f-43e8-bcdc-c5a5d038cd38\nSpec:\n  Attacher:   csi-nfsplugin\n  Node Name:  k8s-dev\n  Source:\n    Persistent Volume Name:  data-nfsplugin\nStatus:\n  Attached:  true\nEvents:      <none>\n")),(0,r.kt)("p",null,"\u8b6c\u5982\u5f9e ",(0,r.kt)("strong",{parentName:"p"},"spec")," \u53ef\u4ee5\u770b\u5230\u6709\u4e00\u500b\u639b\u8f09\u7684\u884c\u70ba\u662f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u900f\u904e Attacher ",(0,r.kt)("strong",{parentName:"li"},"csi-nfsplugin")," \u65bc node ",(0,r.kt)("strong",{parentName:"li"},"k8s-dev")," \u4e0a\u639b\u8f09\u4e00\u500b ",(0,r.kt)("strong",{parentName:"li"},"volume"),"\uff0c\u800c\u8a72 ",(0,r.kt)("strong",{parentName:"li"},"volume")," \u7684\u4f86\u6e90\u662f\u540d\u70ba ",(0,r.kt)("strong",{parentName:"li"},"data-nfsplugin")," \u7684 ",(0,r.kt)("strong",{parentName:"li"},"PVC")," \u6240\u5b9a\u7fa9\u7684\u3002")),(0,r.kt)("p",null,"\u9019\u4e9b\u8cc7\u8a0a\u90fd\u53ef\u4ee5\u5e6b\u5fd9\u91d0\u6e05\u8207\u78ba\u8a8d\u7576\u524d\u662f\u5426 ",(0,r.kt)("strong",{parentName:"p"},"CSI")," \u7684\u5132\u5b58\u529f\u80fd\u6709\u6b63\u5e38\u904b\u4f5c\uff0c\u6211\u89ba\u5f97\u76f8\u5c0d\u65bc\u4e4b\u524d\u55ae\u7d14\u7684 ",(0,r.kt)("strong",{parentName:"p"},"PV/PVC")," \u6709\u4f86\u5f97\u6e05\u695a\u4e00\u4e9b\u3002"),(0,r.kt)("h1",{id:"summary"},"Summary"),(0,r.kt)("p",null,"\u672c\u6587\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"CSI")," \u67b6\u69cb\u4e0b\u90e8\u7f72\u4e86\u4e00\u500b ",(0,r.kt)("strong",{parentName:"p"},"NFS")," \u7684\u5132\u5b58\u65b9\u6848\uff0c\u4e26\u4e14\u7528\u4e00\u500b ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u4f5c\u70ba\u639b\u8f09\u7684\u7bc4\u4f8b\uff0c\u4f86\u5be6\u969b\u90e8\u7f72\u7684\u6d41\u7a0b\u8207\u67b6\u69cb\uff0c\u540c\u6642\u89c0\u5bdf\u6574\u500b kubernetes \u672c\u8eab\u662f\u5426\u6709\u65b0\u589e\u52a0\u7684\u8cc7\u6e90\u8207\u5167\u5bb9\u3002"),(0,r.kt)("h1",{id:"\u53c3\u8003"},"\u53c3\u8003"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/kubernetes-csi/csi-driver-nfs"},"https://github.com/kubernetes-csi/csi-driver-nfs")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://kubernetes-csi.github.io/docs"},"https://kubernetes-csi.github.io/docs")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/kubernetes-csi/node-driver-registrar"},"https://github.com/kubernetes-csi/node-driver-registrar")),(0,r.kt)("li",{parentName:"ul"},"kubernetes.io/blog/2019/01/15/container-storage-interface-ga/")))}d.isMDXComponent=!0}}]);