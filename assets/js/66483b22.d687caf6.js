"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[24417],{3905:(e,n,t)=>{t.d(n,{Zo:()=>m,kt:()=>s});var i=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function p(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function r(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},l=Object.keys(e);for(i=0;i<l.length;i++)t=l[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(i=0;i<l.length;i++)t=l[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var o=i.createContext({}),k=function(e){var n=i.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):p(p({},n),e)),t},m=function(e){var n=k(e.components);return i.createElement(o.Provider,{value:n},e.children)},d="mdxType",N={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},C=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,l=e.originalType,o=e.parentName,m=r(e,["components","mdxType","originalType","parentName"]),d=k(t),C=a,s=d["".concat(o,".").concat(C)]||d[C]||N[C]||l;return t?i.createElement(s,p(p({ref:n},m),{},{components:t})):i.createElement(s,p({ref:n},m))}));function s(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var l=t.length,p=new Array(l);p[0]=C;var r={};for(var o in n)hasOwnProperty.call(n,o)&&(r[o]=n[o]);r.originalType=e,r[d]="string"==typeof e?e:a,p[1]=r;for(var k=2;k<l;k++)p[k]=t[k];return i.createElement.apply(null,p)}return i.createElement.apply(null,t)}C.displayName="MDXCreateElement"},72989:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>p,default:()=>N,frontMatter:()=>l,metadata:()=>r,toc:()=>k});var i=t(87462),a=(t(67294),t(3905));const l={title:"[netfilter] Introduction to iptables",date:new Date("2018-09-15T14:18:36.000Z"),tags:["Network","Netfilter","Linux","Kernel","iptables"],description:"\u900f\u904e\u77ad\u89e3 iptables \u898f\u5247\u7684\u56db\u5927\u7d44\u6210 Table/Chian/Match/Target \u4f86\u5b78\u7fd2 iptables \u7684\u898f\u5247\u542b\u7fa9\uff0c\u540c\u6642\u900f\u904e\u5716\u8868\u7684\u65b9\u5f0f\u4f86\u91d0\u6e05\u5c01\u5305\u5728 Linux Kernel \u50b3\u8f38\u904e\u7a0b\u4e2d\u53d7\u5230 iptables \u898f\u5247\u7684\u8655\u7406\u9806\u5e8f\u3002\u6700\u5f8c\u6703\u5c07 iptables \u4ee5\u53ca ebtables \u5169\u8005\u7684\u6d41\u7a0b\u5716\u6574\u5408\u5728\u4e00\u8d77\uff0c\u69cb\u5efa\u51fa\u4e00\u500b\u66f4\u5168\u9762\u7684\u5c01\u5305\u8f49\u9001\u6d41\u7a0b\u5716\uff0c\u65bc\u6b64\u6d41\u7a0b\u5716\u4e2d\u53ef\u4ee5\u89c0\u5bdf\u5230\u5c01\u5305\u5728 Routing/Bridging \u4e0d\u540c\u904e\u7a0b\u4e2d\uff0c\u662f\u5982\u4f55\u901a\u904e\u4e0d\u540c\u7684 ebtables/iptables \u898f\u5247\u7684\u8655\u7406\u3002 \u64c1\u6709\u9019\u4e9b\u8cc7\u8a0a\u80fd\u5920\u8b93\u4f60\u5c0d\u7cfb\u7d71\u4e0a\u7684 iptables/ebtables \u6709\u66f4\u5168\u9762\u6027\u7684\u7406\u89e3\u5176\u529f\u7528\u4ee5\u53ca\u767c\u751f\u6642\u6a5f"},p=void 0,r={unversionedId:"techPost/2018/netfilter-eiptables-ii",id:"techPost/2018/netfilter-eiptables-ii",title:"[netfilter] Introduction to iptables",description:"\u900f\u904e\u77ad\u89e3 iptables \u898f\u5247\u7684\u56db\u5927\u7d44\u6210 Table/Chian/Match/Target \u4f86\u5b78\u7fd2 iptables \u7684\u898f\u5247\u542b\u7fa9\uff0c\u540c\u6642\u900f\u904e\u5716\u8868\u7684\u65b9\u5f0f\u4f86\u91d0\u6e05\u5c01\u5305\u5728 Linux Kernel \u50b3\u8f38\u904e\u7a0b\u4e2d\u53d7\u5230 iptables \u898f\u5247\u7684\u8655\u7406\u9806\u5e8f\u3002\u6700\u5f8c\u6703\u5c07 iptables \u4ee5\u53ca ebtables \u5169\u8005\u7684\u6d41\u7a0b\u5716\u6574\u5408\u5728\u4e00\u8d77\uff0c\u69cb\u5efa\u51fa\u4e00\u500b\u66f4\u5168\u9762\u7684\u5c01\u5305\u8f49\u9001\u6d41\u7a0b\u5716\uff0c\u65bc\u6b64\u6d41\u7a0b\u5716\u4e2d\u53ef\u4ee5\u89c0\u5bdf\u5230\u5c01\u5305\u5728 Routing/Bridging \u4e0d\u540c\u904e\u7a0b\u4e2d\uff0c\u662f\u5982\u4f55\u901a\u904e\u4e0d\u540c\u7684 ebtables/iptables \u898f\u5247\u7684\u8655\u7406\u3002 \u64c1\u6709\u9019\u4e9b\u8cc7\u8a0a\u80fd\u5920\u8b93\u4f60\u5c0d\u7cfb\u7d71\u4e0a\u7684 iptables/ebtables \u6709\u66f4\u5168\u9762\u6027\u7684\u7406\u89e3\u5176\u529f\u7528\u4ee5\u53ca\u767c\u751f\u6642\u6a5f",source:"@site/docs/techPost/2018/netfilter-eiptables-ii.md",sourceDirName:"techPost/2018",slug:"/techPost/2018/netfilter-eiptables-ii",permalink:"/docs/techPost/2018/netfilter-eiptables-ii",draft:!1,tags:[{label:"Network",permalink:"/docs/tags/network"},{label:"Netfilter",permalink:"/docs/tags/netfilter"},{label:"Linux",permalink:"/docs/tags/linux"},{label:"Kernel",permalink:"/docs/tags/kernel"},{label:"iptables",permalink:"/docs/tags/iptables"}],version:"current",frontMatter:{title:"[netfilter] Introduction to iptables",date:"2018-09-15T14:18:36.000Z",tags:["Network","Netfilter","Linux","Kernel","iptables"],description:"\u900f\u904e\u77ad\u89e3 iptables \u898f\u5247\u7684\u56db\u5927\u7d44\u6210 Table/Chian/Match/Target \u4f86\u5b78\u7fd2 iptables \u7684\u898f\u5247\u542b\u7fa9\uff0c\u540c\u6642\u900f\u904e\u5716\u8868\u7684\u65b9\u5f0f\u4f86\u91d0\u6e05\u5c01\u5305\u5728 Linux Kernel \u50b3\u8f38\u904e\u7a0b\u4e2d\u53d7\u5230 iptables \u898f\u5247\u7684\u8655\u7406\u9806\u5e8f\u3002\u6700\u5f8c\u6703\u5c07 iptables \u4ee5\u53ca ebtables \u5169\u8005\u7684\u6d41\u7a0b\u5716\u6574\u5408\u5728\u4e00\u8d77\uff0c\u69cb\u5efa\u51fa\u4e00\u500b\u66f4\u5168\u9762\u7684\u5c01\u5305\u8f49\u9001\u6d41\u7a0b\u5716\uff0c\u65bc\u6b64\u6d41\u7a0b\u5716\u4e2d\u53ef\u4ee5\u89c0\u5bdf\u5230\u5c01\u5305\u5728 Routing/Bridging \u4e0d\u540c\u904e\u7a0b\u4e2d\uff0c\u662f\u5982\u4f55\u901a\u904e\u4e0d\u540c\u7684 ebtables/iptables \u898f\u5247\u7684\u8655\u7406\u3002 \u64c1\u6709\u9019\u4e9b\u8cc7\u8a0a\u80fd\u5920\u8b93\u4f60\u5c0d\u7cfb\u7d71\u4e0a\u7684 iptables/ebtables \u6709\u66f4\u5168\u9762\u6027\u7684\u7406\u89e3\u5176\u529f\u7528\u4ee5\u53ca\u767c\u751f\u6642\u6a5f"},sidebar:"techPost",previous:{title:"[netfilter] Introduction to ebtables",permalink:"/docs/techPost/2018/netfilter-eiptables-i"},next:{title:"[netfilter] Dig Into Docker Bridge Network By iptables/ebtables",permalink:"/docs/techPost/2018/netfilter-eiptables-iii"}},o={},k=[{value:"Preface",id:"preface",level:2},{value:"Introduction",id:"introduction",level:2},{value:"iptables",id:"iptables",level:2},{value:"Table",id:"table",level:3},{value:"Chain",id:"chain",level:3},{value:"Match",id:"match",level:3},{value:"Target",id:"target",level:3},{value:"Summary",id:"summary",level:3},{value:"Summary With Ebtables.",id:"summary-with-ebtables",level:2},{value:"Layer3",id:"layer3",level:3},{value:"Layer2",id:"layer2",level:3},{value:"Application",id:"application",level:3},{value:"Reference",id:"reference",level:2}],m={toc:k},d="wrapper";function N(e){let{components:n,...t}=e;return(0,a.kt)(d,(0,i.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"preface"},"Preface"),(0,a.kt)("p",null,"\u9019\u6b21\u60f3\u8981\u8ddf\u5927\u5bb6\u6162\u6162\u4ecb\u7d39\u7684\u5c31\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u9019\u500b\u5e38\u898b\u4e5f\u5e38\u7528\u7684\u5de5\u5177\u3002\n\u7db2\u8def\u4e0a\u5176\u5be6\u5df2\u7d93\u53ef\u4ee5\u641c\u5c0b\u5230\u975e\u5e38\u591a\u95dc\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u76f8\u95dc\u7684\u6587\u7ae0\u3002\n\u4e0d\u8ad6\u662f\u57fa\u672c\u4ecb\u7d39\uff0c\u6216\u662f\u4e00\u4e9b\u76f8\u95dc\u7528\u6cd5\uff0c\u5176\u5be6\u90fd\u6709\u6eff\u591a\u7684\u8cc7\u6e90\u53ef\u4ee5\u5b78\u7fd2\uff0c\u4e0d\u904e\u6211\u8a8d\u70ba\u9019\u4e9b\u6587\u7ae0\u90fd\u6563\u843d\u5404\u5730\uff0c\u6240\u4ee5\u60f3\u8981\u6574\u7406\u4e00\u4e0b\u9019\u4e9b\u8cc7\u8a0a\u4e26\u4e14\u7d71\u6574\u8d77\u4f86\u505a\u4e00\u500b\u4e00\u7cfb\u5217\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u6587\u7ae0\u3002"),(0,a.kt)("p",null,"\u9019\u500b\u7cfb\u5217\u6587\u7684\u5167\u5bb9\u5927\u81f4\u4e0a\u5982\u4e0b"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"iptables/ebtables \u7684\u57fa\u672c\u67b6\u69cb\u4ecb\u7d39\uff0c\u5305\u542b\u4e0b\u5217\u5404\u7a2e\u7d44\u6210\u7684\u6982\u5ff5",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Target/Chain/Table/Match"))),(0,a.kt)("li",{parentName:"ol"},"\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"docker")," \u9810\u8a2d\u7db2\u8def",(0,a.kt)("inlineCode",{parentName:"li"},"Bridge"),"\u7684\u60c5\u6cc1\u4f86\u89e3\u91cb\uff0c\u5bb9\u5668\u8207\u5916\u754c\u7db2\u8def\uff0c\u5bb9\u5668\u8207\u5bb9\u5668\u5f7c\u6b64\u4e4b\u9593\u7684\u7db2\u8def\u50b3\u8f38\uff0c\u5be6\u969b\u4e0a\u518d ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u4e2d\u5230\u5e95\u6703\u600e\u9ebc\u904b\u4f5c\uff0c\u5982\u679c\u60f3\u8981\u8655\u7406\u9019\u4e9b\u5c01\u5305\uff0c\u8a72\u600e\u9ebc\u8a2d\u5b9a\u76f8\u95dc\u898f\u5247\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u4ecb\u7d39\u76f8\u95dc ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u5e38\u898b\u7684\u4f7f\u7528\u554f\u984c"),(0,a.kt)("li",{parentName:"ol"},"\u6700\u5f8c\u5247\u662f\u6703\u8ddf\u5927\u5bb6\u4ecb\u7d39\uff0c\u5982\u4f55\u81ea\u5df1\u624b\u52d5\u64b0\u5beb\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u64f4\u5145\u6a21\u7d44\uff0c\u8b93\u4f60\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"iptables"),"\u64c1\u6709\u7368\u4e00\u7121\u4e8c\u7684\u529f\u80fd")),(0,a.kt)("p",null,"\u672c\u6587\u5ef6\u7e8c\u524d\u4e00\u7bc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u7684\u4ecb\u7d39\uff0c\u5c07\u4f7f\u7528\u76f8\u540c\u7684\u6982\u5ff5\u4f86\u95e1\u8ff0 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables(ipv4)")," \u7684\u6982\u5ff5\uff0c\u5305\u542b\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"Tarble/Chain/Match/Target")," \u7b49\u529f\u80fd\u3002"),(0,a.kt)("p",null,"\u76f8\u95dc\u7cfb\u5217\u6587\u7ae0"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.hwchiu.com/netfilter-eiptables-i.html"},"[netfilter] Introduction to ebtables")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.hwchiu.com/netfilter-eiptables-iii.html"},"[netfilter] Dig Into Docker Bridge Network By iptables/ebtables"))),(0,a.kt)("h2",{id:"introduction"},"Introduction"),(0,a.kt)("p",null,"\u70ba\u4e86\u80fd\u5920\u66f4\u5145\u5206\u7406\u89e3\u672c\u6587\u6240\u63cf\u5f0f\u7684\u5404\u500b\u89c0\u5ff5\uff0c\u5f37\u70c8\u5efa\u8b70\u5148\u95b1\u8b80",(0,a.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/netfilter-eiptables-i.html"},"\u524d\u7bc7\u6587\u7ae0")," \u4f86\u7406\u89e3\u6574\u500b\u898f\u5247\u88e1\u9762\u7684\u56db\u5927\u90e8\u5206\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"Table/Chain/Match/Target")),(0,a.kt)("p",null,"\u9019\u908a\u518d\u6b21\u505a\u500b\u5feb\u901f\u7684\u8907\u7fd2"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Table: \u76f8\u540c\u7528\u9014\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"rules")," \u6703\u653e\u5728\u76f8\u540c\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"Table")," \u4e2d\uff0c\u5e38\u898b\u7684\u6709\u7528\u4f86\u7576\u9632\u706b\u7246\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"filter"),"\uff0c\u6216\u662f\u4fee\u6539\u5c01\u5305\u5167\u5bb9\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"nat"),"."),(0,a.kt)("li",{parentName:"ul"},"Chain: \u5c01\u5305\u6bd4\u5c0d\u7684\u6642\u9593\u9ede\uff0c\u4e0d\u540c\u6642\u9593\u9ede\u4e0b\u80fd\u5920\u9032\u884c\u4e0d\u540c\u7684\u52d5\u4f5c\u3002\u9019\u610f\u5473\u6bcf\u500b",(0,a.kt)("inlineCode",{parentName:"li"},"Chain")," \u4e0b\u80fd\u5920\u642d\u914d\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"Table")," \u662f\u6709\u9650\u5236\u7684\u3002"),(0,a.kt)("li",{parentName:"ul"},"Match: \u6bcf\u500b\u898f\u5247\u90fd\u8981\u63cf\u8ff0\u7576\u524d\u898f\u5247\u5e0c\u671b\u5339\u914d\u7684\u5c01\u5305\u5167\u5bb9\uff0c\u9664\u4e86\u57fa\u672c\u7684\u6bd4\u5c0d\u6b04\u4f4d\u5916\uff0c\u9084\u53ef\u4ee5\u7528\u5404\u5f0f\u5404\u6a23\u64f4\u5145\u6a21\u7d44\u4f86\u5339\u914d\u4e0d\u540c\u7684\u5c01\u5305\u5167\u5bb9\u3002"),(0,a.kt)("li",{parentName:"ul"},"Target: \u7576\u5c01\u5305\u6bd4\u5c0d\u6210\u529f\u5f8c\uff0c\u8981\u57f7\u884c\u4ec0\u9ebc\u6a23\u7684\u52d5\u4f5c\uff0c\u4e0d\u540c\u65bc ",(0,a.kt)("inlineCode",{parentName:"li"},"Match")," \u53ef\u6bd4\u5c0d\u591a\u500b\u5167\u5bb9\uff0c\u6bcf\u500b\u898f\u5247\u90fd\u53ea\u80fd\u63a1\u7528\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"Target")," \u4f86\u63a1\u53d6\u52d5\u4f5c\u3002")),(0,a.kt)("h2",{id:"iptables"},"iptables"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684\u7528\u9014\u975e\u5e38\u7684\u5ee3\uff0c\u4ee5 ",(0,a.kt)("inlineCode",{parentName:"p"},"docker")," \u70ba\u7bc4\u4f8b\u4f86\u8aaa\uff0c\u5f9e\u57fa\u672c\u7684\u5bb9\u5668\u5c0d\u5916\u4e0a\u7db2\uff0c\u9019\u908a\u6703\u9700\u8981 ",(0,a.kt)("inlineCode",{parentName:"p"},"SNAT")," \u4f86\u8f49\u63db\u5c01\u5305\u3002\u6216\u662f\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"docker run -p 1234:80 xxxx")," \u9019\u7a2e\u65b9\u5f0f\u8b93\u5916\u754c\u80fd\u5920\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"DNAT")," \u7684\u65b9\u5f0f\u4f86\u5b58\u53d6\u5bb9\u5668\u5167\u7684\u7279\u5b9a\u9023\u63a5\u57e0\u3002"),(0,a.kt)("p",null,"\u4e0a\u8ff0\u7684\u9019\u4e9b\u986f\u800c\u6613\u898b\u7684\u64cd\u4f5c\u5be6\u969b\u4e0a\u80cc\u5f8c\u662f\u727d\u626f\u5230\u4e86\u975e\u5e38\u8907\u96dc\u7684\u5c01\u5305\u50b3\u8f38\uff0c\u70ba\u4e86\u7406\u89e3\u9019\u90e8\u4efd\uff0c\u6211\u5011\u8981\u5148\u4f86\u6aa2\u8996\u4e00\u4e0b ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u88e1\u9762\u56db\u5927\u90e8\u5206\u7684\u4ecb\u7d39"),(0,a.kt)("h3",{id:"table"},"Table"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"Table")," \u65b9\u9762\uff0c\u76ee\u524d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7e3d\u5171\u6709\u4e94\u5f35 ",(0,a.kt)("inlineCode",{parentName:"p"},"tables"),", \u5206\u5225\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"filter"),",",(0,a.kt)("inlineCode",{parentName:"p"},"nat"),",",(0,a.kt)("inlineCode",{parentName:"p"},"raw"),",",(0,a.kt)("inlineCode",{parentName:"p"},"mangle")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"security"),"."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"filter"),": \u8ddf ",(0,a.kt)("inlineCode",{parentName:"li"},"ebtables")," \u4e00\u6a23\uff0c ",(0,a.kt)("inlineCode",{parentName:"li"},"filter Table")," \u4e5f\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u7cfb\u5217\u6307\u4ee4\u7684\u9810\u8a2d table, \u7528\u4f86\u5b58\u653e\u5982 ",(0,a.kt)("inlineCode",{parentName:"li"},"ACCEPT/DROP")," \u7b49\u76f8\u95dc\u9632\u706b\u7246\u529f\u80fd\u7684\u898f\u5247\u3002"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"nat"),": \u5c31\u662f\u5982\u540c\u5176\u540d\u7a31\u4e00\u6a23\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"Network Address Translation(nat)"),"\uff0c\u5c0d\u65bc\u4f86\u6e90\u6216\u662f\u76ee\u7684\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"IP")," \u5730\u5740\u9032\u884c\u4fee\u6539\u7684\u52d5\u4f5c\u90fd\u662f\u518d\u9019\u908a\u9032\u884c\u7684\u3002\n\u5be6\u969b\u4e0a\u518d ",(0,a.kt)("inlineCode",{parentName:"li"},"Linux Kernel")," \u5167\u6709\u4e00\u5957\u53eb\u505a ",(0,a.kt)("inlineCode",{parentName:"li"},"conntrack")," \u7684\u6a5f\u5236\u53bb\u7dad\u8b77\u6240\u6709\u7d93\u904e\u672c\u6a5f\u7684\u7db2\u8def\u9023\u7dda\u3002\n\u57fa\u672c\u4e0a\u53ea\u6709\u65b0\u5efa\u7acb\u7684\u9023\u7dda\u624d\u6703\u9032\u5165\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"nat")," \u9019\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"table")," \u53bb\u8655\u7406\u3002\n\u7562\u7adf\u4ee5 ",(0,a.kt)("inlineCode",{parentName:"li"},"SNAT")," \u9019\u7a2e\u6703\u9700\u8981\u52d5\u614b\u7522\u751f\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"Port")," \u4f86\u9032\u884c\u8f49\u767c\u7684\u52d5\u4f5c\uff0c\u5176\u5be6\u6bcf\u689d\u9023\u7dda\u53ea\u8981\u9032\u884c\u4e00\u6b21\u5c31\u597d\uff0c\u5f8c\u7e8c\u8a72\u9023\u7dda\u7684\u5c01\u5305\u5c31\u8b93 ",(0,a.kt)("inlineCode",{parentName:"li"},"kernel")," \u5e6b\u4f60\u9ed8\u9ed8\u7684\u57f7\u884c\u5c31\u597d\u3002")),(0,a.kt)("p",null,"\u4e4b\u5f8c\u6709\u6a5f\u6703\u518d\u4f86\u8a0e\u8ad6\u4e00\u4e0b ",(0,a.kt)("inlineCode",{parentName:"p"},"conntrack")," \u7684\u6a5f\u5236\u8207\u67b6\u69cb\uff0c\u4ee5\u53ca\u5176\u80fd\u5920\u63d0\u4f9b\u4ec0\u9ebc\u6a23\u7684\u8cc7\u8a0a\u7d66\u7cfb\u7d71\u7ba1\u7406\u8005/\u4f7f\u7528\u8005\n3. ",(0,a.kt)("inlineCode",{parentName:"p"},"raw"),": \u9019\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"chain")," \u6bd4\u8f03\u5c11\u4f7f\u7528\uff0c\u5176\u7528\u9014\u662f\u7528\u4f86\u7279\u5225\u8655\u7406\u4e0d\u60f3\u8981\u8b93 ",(0,a.kt)("inlineCode",{parentName:"p"},"kernel"),": \u5e6b\u4f60\u7ba1\u7406 ",(0,a.kt)("inlineCode",{parentName:"p"},"conntrack")," \u7684\u5c01\u5305\u3002\n4. ",(0,a.kt)("inlineCode",{parentName:"p"},"mangle"),": \u9664\u4e86",(0,a.kt)("inlineCode",{parentName:"p"},"nat"),"\u80fd\u5920\u4fee\u6539\u5c01\u5305\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740\u5916\uff0c ",(0,a.kt)("inlineCode",{parentName:"p"},"mangle")," \u4e5f\u6703\u7528\u4f86\u9032\u884c\u4e00\u4e9b\u5c01\u5305\u7684\u4fee\u6539\u3002\u7136\u800c\u5176\u4fee\u6539\u6703\u6bd4\u8f03\u504f\u5411\u4e00\u4e9b ",(0,a.kt)("inlineCode",{parentName:"p"},"metadata")," \u6a19\u7c64\u6982\u5ff5\u7684\u6b04\u4f4d\uff0c\u8b93\u5176\u4ed6\u7684\u898f\u5247\u53ef\u4ee5\u900f\u904e\u6aa2\u8996\u9019\u4e9b\u6a19\u7c64\u4f86\u5f97\u77e5\u8a72\u5c01\u5305\u5148\u524d\u6709\u7b26\u5408\u67d0\u4e9b\u689d\u4ef6\uff0c\u85c9\u7531\u9019\u4e9b\u66f4\u591a\u7684\u689d\u4ef6\u5224\u65b7\u4f86\u6c7a\u5b9a\u8a72\u600e\u9ebc\u8655\u7406\u5c01\u5305\u3002\n\u8209\u4f8b\u4f86\u8aaa\uff0c\u518d ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u88e1\u9762\u6709\u6240\u8b02\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"mark")," \u7684\u6982\u5ff5\uff0c\u9019\u500b",(0,a.kt)("inlineCode",{parentName:"p"},"32bit"),"\u7684\u6b04\u4f4d\u4e26\u4e0d\u5c6c\u65bc OSI \u88e1\u9762\u7684\u4efb\u4f55\u4e00\u5c64\u7684\u5c01\u5305\u683c\u5f0f\uff0c\u800c\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"linux kernel")," \u88e1\u9762\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"sk_buff")," \u8a72\u63cf\u8ff0\u5c01\u5305\u7d50\u69cb\u4e2d\u81ea\u5df1\u65b0\u589e\u7684\u6b04\u4f4d\u3002"),(0,a.kt)("p",null,"\u900f\u904e\u9019\u500b\u6b04\u4f4d\u6211\u5011\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u968e\u6bb5\u53bb\u8ffd\u8e64\u76f8\u540c\u7684\u5c01\u5305\uff0c\u4f86\u9054\u5230\u66f4\u8907\u96dc\u7684\u8655\u7406\u3002"),(0,a.kt)("p",null,"\u8b6c\u5982\u518d ",(0,a.kt)("inlineCode",{parentName:"p"},"FORWRAD Chain")," \u6211\u60f3\u8981\u77e5\u9053\u9019\u500b\u5c01\u5305\u662f\u4e0d\u662f\u4e4b\u524d\u6709\u518d ",(0,a.kt)("inlineCode",{parentName:"p"},"PREROUUTING"),"  \u88ab\u8655\u7406\u904e\uff0c\u5c31\u53ef\u4ee5\u7528\u8a72 ",(0,a.kt)("inlineCode",{parentName:"p"},"mark")," \u4f86\u8655\u7406\u3002\n6. ",(0,a.kt)("inlineCode",{parentName:"p"},"security"),": \u9019\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"table")," \u66f4\u5c11\u51fa\u73fe\uff0c\u5fc5\u9808\u4f34\u96a8\u8005 ",(0,a.kt)("inlineCode",{parentName:"p"},"SELinux")," \u7684\u4f7f\u7528\u4f86\u63d0\u4f9b\u66f4\u591a\u5b89\u5168\u76f8\u95dc\u7684\u529f\u80fd\uff0c\u4e3b\u8981\u727d\u626f\u5230 ",(0,a.kt)("strong",{parentName:"p"},"Mandatory Access Control (MAC)")," \u898f\u5247\u4ee5\u53ca ",(0,a.kt)("strong",{parentName:"p"},"Discretionary Access Control (DAC)")," \u9019\u5169\u8005\u7684\u7ba1\u7406\uff0c\u6709\u8208\u8da3\u7684\u53ef\u4ee5\u770b\u770b\u6700\u521d\u7684 ",(0,a.kt)("a",{parentName:"p",href:"https://lwn.net/Articles/267140/"},"commit"),"\u3002"),(0,a.kt)("p",null,"\u4e0a\u8ff0\u88e1\u9762\uff0c\u57fa\u672c\u4e0a ",(0,a.kt)("inlineCode",{parentName:"p"},"raw/mangle/security")," \u9019\u4e09\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"table")," \u6bd4\u8f03\u5c11\u4f7f\u7528\uff0c\u6240\u4ee5\u5f8c\u7e8c\u6703\u6bd4\u8f03\u8457\u91cd\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"filter/nat")," \u9019\u5169\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"table")," \u70ba\u4e3b\u3002"),(0,a.kt)("h3",{id:"chain"},"Chain"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"Chain")," \u7684\u8a71\uff0c\u518d ",(0,a.kt)("inlineCode",{parentName:"p"},"ibtables")," \u4e2d\u7e3d\u5171\u6709\u4e94\u689d ",(0,a.kt)("inlineCode",{parentName:"p"},"chain"),"."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"PREROUTING"),": \u9019\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"Chian")," \u5c31\u662f\u5176\u540d\u7a31\u7684\u89e3\u8b80\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"Pre-Routing"),", \u518d\u5c01\u5305\u9032\u5165\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"Linux Kernel")," \u5f8c\uff0c\u4f46\u662f\u9084\u6c92\u6709\u78b0\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"Routing Decision")," \u524d\u53ef\u4ee5\u9032\u884c\u7684\u968e\u6bb5\u3002")),(0,a.kt)("p",null,"\u9019\u908a\u8209\u4e00\u500b\u73fe\u5be6\u6703\u4f7f\u7528\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"PREROUTING")," \u7684\u4f7f\u7528\u60c5\u5883\uff0c\u5f88\u591a\u4eba\u5728\u5bb6\u88e1\u53ef\u80fd\u6703\u6709\u67b6\u8a2d ",(0,a.kt)("inlineCode",{parentName:"p"},"server/nas")," \u7b49\u5404\u7a2e\u670d\u52d9\u7684\u53ef\u80fd\uff0c\u7136\u800c\u56e0\u70ba ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740\u6578\u91cf\u7684\u9650\u5236\uff0c\u9019\u4e9b\u80cc\u5f8c\u7684\u6a5f\u5668\u90fd\u6703\u4f7f\u7528\u79c1\u6709\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740\uff0c\u8b6c\u5982 ",(0,a.kt)("inlineCode",{parentName:"p"},"192.168.0.0/16"),", \u9019\u7a2e\u60c5\u6cc1\u4e0b\u70ba\u4e86\u8b93\u5916\u754c\u80fd\u5920\u9806\u5229\u7684\u5b58\u53d6\u5230\u9019\u4e9b\u5167\u90e8\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"server/nas"),"\uff0c\u5e38\u898b\u7684\u4f5c\u6cd5\u90fd\u662f\u6703\u5728\u5bb6\u88e1\u5c0d\u5916\u4e0a\u7db2\u7684\u90a3\u53f0 ",(0,a.kt)("inlineCode",{parentName:"p"},"router")," \u8a2d\u5b9a\u8b6c\u5982 ",(0,a.kt)("inlineCode",{parentName:"p"},"PortFORWARDing/\u865b\u64ec\u4f3a\u670d\u5668")," \u7b49\u529f\u80fd\uff0c \u5c07\u7279\u5b9a\u7684\u9023\u63a5\u57e0\u8f49\u767c\u5230\u5167\u90e8 ",(0,a.kt)("inlineCode",{parentName:"p"},"server")," \u7684\u79c1\u6709",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\u53ca\u9023\u63a5\u57e0\u3002"),(0,a.kt)("p",null,"\u9019\u529f\u80fd\u5be6\u969b\u4e0a\u5c31\u662f\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"PREROUTING")," \u9019\u500b\u968e\u6bb5\u6703\u9032\u884c ",(0,a.kt)("inlineCode",{parentName:"p"},"DNAT"),"\uff0c\u5c07\u5c01\u5305\u7684\u76ee\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u4f4d\u5740\u8207\u9023\u63a5\u57e0\u90fd\u8f49\u63db\u5230\u5167\u90e8",(0,a.kt)("inlineCode",{parentName:"p"},"server"),"\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\u8207\u9023\u63a5\u57e0\u3002\n\u6700\u5f8c\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"Routing Decision")," \u4f86\u5f80\u5f8c\u8f49\u767c"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"INPUT"),": \u5982\u679c\u8a72\u5c01\u5305\u6839\u64da ",(0,a.kt)("inlineCode",{parentName:"li"},"Routing Decision")," \u5f8c\u5c01\u5305\u662f\u8981\u9032\u5165\u5230\u672c\u6a5f\u7cfb\u7d71\uff0c\u8b6c\u5982\u7cfb\u7d71\u4e0a\u7684\u61c9\u7528\u7a0b\u5f0f\uff0c\u8b6c\u5982 ",(0,a.kt)("inlineCode",{parentName:"li"},"www server"),"\u3002 \u5247",(0,a.kt)("inlineCode",{parentName:"li"},"INPUT"),"\u5c31\u662f\u67e5\u8a62\u5b8c\u7562\u5230\u5c01\u5305\u88ab\u61c9\u7528\u7a0b\u5f0f\u63a5\u6536\u7684\u4e2d\u9593\u968e\u6bb5\u3002")),(0,a.kt)("p",null,"\u5982\u679c\u4eca\u5929\u6a5f\u5668\u4e0a\u67b6\u8a2d\u4e86\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"nginx server"),", \u4e26\u4e14\u807d\u518d ",(0,a.kt)("inlineCode",{parentName:"p"},"0.0.0.0:80"),". \u5247\u4efb\u4f55\u9001\u5230\u8a72\u6a5f\u5668\u7db2\u5361\u4e0a\u9762\u4e14\u9023\u63a5\u57e0\u662f",(0,a.kt)("inlineCode",{parentName:"p"},"80")," \u7684\u5c01\u5305\u6700\u5f8c\u90fd\u6703\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"INPUT chain")," \u4f86\u8655\u7406\u3002 \u6240\u4ee5\u4e5f\u53ef\u4ee5\u5728\u9019\u908a\u900f\u904e\u5176\u4ed6\u7684\u9078\u9805\u4e1f\u68c4\u6389\u4e0d\u60f3\u8981\u9023\u63a5\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"nginx server")," \u7684\u5c01\u5305\u3002"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"FORWARD"),": \u5982\u679c\u8a72\u5c01\u5305\u6839\u64da ",(0,a.kt)("inlineCode",{parentName:"li"},"Routing Decision")," \u5f8c\u5c01\u5305\u662f\u8981\u5e6b\u5fd9\u8f49\u767c\u3002\u5247",(0,a.kt)("inlineCode",{parentName:"li"},"FORWARD"),"\u5c31\u662f\u67e5\u8a62\u5b8c\u7562\u5230\u5c01\u5305\u8981\u5f9e\u7db2\u5361\u9001\u51fa\u53bb\u7684\u4e2d\u9593\u968e\u6bb5\u3002")),(0,a.kt)("p",null,"\u5be6\u969b\u4e0a\uff0c\u9810\u8a2d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"linux kernel")," \u662f\u6c92\u6709 ",(0,a.kt)("inlineCode",{parentName:"p"},"FORWARD")," \u7684\u529f\u80fd\u7684\uff0c\u5fc5\u9808\u8981\u5c07 ",(0,a.kt)("inlineCode",{parentName:"p"},"kernel")," \u95dc\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"ip_FORWARD")," \u7684\u958b\u95dc\u6253\u958b\u624d\u53ef\u4ee5\u4f7f\u7528\u3002\n\u6240\u4ee5\u624d\u6703\u770b\u5230\u5f88\u591a\u7bc7\u6587\u7ae0\u90fd\u5728\u8b1b\u89e3\u9700\u8981 ",(0,a.kt)("inlineCode",{parentName:"p"},"echo 1 > /proc/sys/net/ipv4/ip_FORWARD")," \u9019\u7a2e\u65b9\u5f0f\u6253\u958b ",(0,a.kt)("inlineCode",{parentName:"p"},"kernel")," \u5167\u95dc\u65bc\u8f49\u767c\u7684\u529f\u80fd\u3002"),(0,a.kt)("p",null,"\u8a73\u7d30\u7684\u7a0b\u5f0f\u78bc\u6709\u8208\u8da3\u53ef\u4ee5\u53c3\u8003\u4e0b\u5217\u9023\u7d50,(\u6211\u9019\u908a\u96a8\u4fbf\u627e\u4e86\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"Linux Kernel 4.3")," \u7684\u7a0b\u5f0f\u78bc)"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("a",{parentName:"li",href:"https://elixir.bootlin.com/linux/v4.3/source/net/ipv4/devinet.c#L2267"},"Read The ip_FORWARD")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("a",{parentName:"li",href:"https://elixir.bootlin.com/linux/v4.3/source/include/linux/inetdevice.h#L92"},"Check the device ip_FORWARD config")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("a",{parentName:"li",href:"https://elixir.bootlin.com/linux/v4.3/source/net/ipv4/route.c#L1761"},"Check the config to decide the routing"))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"OUTPUT"),":  \u91dd\u5c0d\u8981\u5f9e ",(0,a.kt)("inlineCode",{parentName:"li"},"Linux Kernel")," \u96e2\u958b\u7684\u5c01\u5305\u90fd\u6703\u9032\u884c\u8655\u7406\u7684\u968e\u6bb5\uff0c\u9019\u985e\u578b\u7684\u5c01\u5305\u662f\u4e3b\u6a5f\u672c\u8eab\u7522\u751f\u7684\u5c01\u5305\uff0c\u76ee\u7684\u5c31\u662f\u8981\u5f9e\u67d0\u4e9b\u7db2\u5361\u8f49\u767c\u51fa\u53bb\u3002 \u8209\u4f8b\u4f86\u8aaa\u7cfb\u7d71\u4e0a\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"nginx www server")," \u8981\u56de\u61c9\u4f7f\u7528\u8005\u7684\u9700\u6c42\uff0c\u9019\u4e9b\u56de\u61c9\u7684\u5c01\u5305\u5c31\u6703\u8d70 ",(0,a.kt)("inlineCode",{parentName:"li"},"OUTPUT chain")," \u51fa\u53bb\u3002")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"POSTROUTING"),": \u9019\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"Chian")," \u5c31\u662f\u5176\u540d\u7a31\u7684\u89e3\u8b80\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"Post-Routing"),", \u518d\u5c01\u5305\u6e96\u5099\u5f9e\u7cfb\u7d71\u51fa\u53bb\u524d\uff0c\u4f46\u662f\u9084\u6c92\u6709\u78b0\u5230\u771f\u6b63\u7684\u900f\u904e\u7db2\u5361\u9001\u51fa\u53bb\u524d\u53ef\u4ee5\u9032\u884c\u7684\u968e\u6bb5\u3002")),(0,a.kt)("p",null,"\u9019\u908a\u7e7c\u7e8c\u4f7f\u7528\u5bb6\u88e1\u67b6\u8a2d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"server/nas")," \u7576\u4f5c\u7bc4\u4f8b\uff0c\u56e0\u70ba",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\u4e0d\u5920\u7684\u554f\u984c\uff0c\u6240\u4ee5\u5167\u90e8\u9019\u4e9b",(0,a.kt)("inlineCode",{parentName:"p"},"server/nas"),"\u8981\u51fa\u53bb\u7684\u5c01\u5305\u5176",(0,a.kt)("inlineCode",{parentName:"p"},"\u4f86\u6e90IP"),"\u5730\u5740\u5fc5\u9808\u8981\u4fee\u6539\u6210\u5c0d\u5916",(0,a.kt)("inlineCode",{parentName:"p"},"Router"),"\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\u3002\n\u800c\u9019\u500b\u884c\u70ba\u6211\u5011\u7a31\u70ba\u6240\u8b02\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Source Network Address Translation (SNAT)"),"\uff0c\u800c\u9019\u500b\u64cd\u4f5c\u90fd\u662f\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"POSTROUTING")," \u9019\u908a\u53bb\u57f7\u884c\u7684\u3002"),(0,a.kt)("h3",{id:"match"},"Match"),(0,a.kt)("p",null,"\u5728\u6bd4\u5c0d\u7684\u898f\u5247\u4f86\u8aaa\uff0c ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u5c08\u81f3\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer3")," \u76f8\u95dc\u7684\u8655\u7406\uff0c\u8b6c\u5982 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u7684\u4f86\u6e90/\u76ee\u7684\u5730\u5740\uff0c\u4ee5\u53ca\u7576\u524d\u5c01\u5305\u4f7f\u7528\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"Layer4"),"\u5354\u5b9a\uff0c\u8b6c\u5982\ntcp, udp, udplite, icmp, esp, ah, sctp\u3002"),(0,a.kt)("p",null,"\u6b64\u5916\uff0c\u9664\u4e86\u5e38\u898b\u7684\u5c01\u5305\u5167\u5bb9\u5916\uff0c\u4e5f\u53ef\u4ee5\u900f\u904e",(0,a.kt)("inlineCode",{parentName:"p"},"-m"),"\u9019\u500b\u65b9\u5f0f\u53bb\u4f7f\u7528\u64f4\u5145\u6a21\u7d44\u4f86\u9054\u5230\u66f4\u9748\u6d3b\u7684\u6bd4\u5c0d\u529f\u80fd\u3002\n\u8b6c\u5982\u5e38\u898b\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"-m tcp --dport=1234")," \u9019\u500b\u984d\u5916\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"tcp")," \u6a21\u7d44\u80fd\u5920\u6aa2\u67e5 ",(0,a.kt)("inlineCode",{parentName:"p"},"TCP")," \u5c01\u5305\u88e1\u9762\u7684\u6b04\u4f4d\u3002\n\u56e0\u70ba\u539f\u751f\u7684 iptables \u53ea\u6709\u6aa2\u67e5\u5230\u6240\u8b02\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"protocol")," \u5354\u8b70\u800c\u5df2\uff0c\u4e26\u6c92\u6709\u518d\u7d30\u90e8\u7684\u53bb\u89e3\u6790\u5c01\u5305\u5167\u5bb9\uff0c\u56e0\u6b64\u82e5\u9700\u8981\u7d30\u7dfb\u5230\u8a72\u5354\u8b70\u7684\u5167\u5bb9\uff0c\u90fd\u9700\u8981\u4f9d\u8cf4\u64f4\u5145\u6a21\u7d44\u4f86\u5b8c\u6210\u3002"),(0,a.kt)("h3",{id:"target"},"Target"),(0,a.kt)("p",null,"\u5c31\u5982\u540c\u524d\u9762\u6240\u63cf\u8ff0\u7684\uff0c\u9810\u8a2d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Target")," \u5176\u5be6\u90fd\u6703\u8ddf\u5c0d\u61c9\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Table")," \u6709\u95dc\uff0c\u8b6c\u5982 ",(0,a.kt)("inlineCode",{parentName:"p"},"ACCEPT/DROP")," \u5c31\u6703\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"filter")," \u9019\u4e9b",(0,a.kt)("inlineCode",{parentName:"p"},"Table"),"."),(0,a.kt)("p",null,"\u518d ",(0,a.kt)("inlineCode",{parentName:"p"},"iptagles")," \u88e1\u9762\u6709\u56db\u500b\u9810\u8a2d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Target")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"ACCEPT: \u8a72\u5c01\u5305\u5224\u5b9a\u901a\u904e\uff0c\u76f4\u63a5\u96e2\u958b\u9019\u500b Chain."),(0,a.kt)("li",{parentName:"ol"},"DROP: \u4e1f\u68c4\u8a72\u5c01\u5305\uff0c\u76f4\u63a5\u96e2\u958b\u9019\u500b Chain."),(0,a.kt)("li",{parentName:"ol"},"QUEUE: \u53ef\u4ee5\u628a\u5c01\u5305\u5f9e ",(0,a.kt)("inlineCode",{parentName:"li"},"kernel-space")," \u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"netlink")," \u7684\u65b9\u5f0f\u9001\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"user-space")," \u53bb\u5f8c\u642d\u914d ",(0,a.kt)("inlineCode",{parentName:"li"},"DPI(Deep packet inspection)")," \u9032\u884c\u5c01\u5305\u6aa2\u6e2c\u4f86\u5224\u65b7\u7576\u524d\u5c01\u5305\u7684\u985e\u578b\u8207\u7a2e\u985e"),(0,a.kt)("li",{parentName:"ol"},"OTHER_CHAIN: \u4f7f\u7528\u8005\u53ef\u4ee5\u81ea\u5df1\u5275\u898b\u65b0\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"chain")," \u7136\u5f8c\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"-J $CHAIN_NAME")," \u7684\u65b9\u5f0f\u8b93\u5c01\u5305\u8df3\u5230\u4e0d\u540c\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"custom_chain")," \u53bb\u9032\u884c\u6bd4\u5c0d\u3002"),(0,a.kt)("li",{parentName:"ol"},"RETURN: \u76f4\u63a5\u8fd4\u56de\u4e0a\u4e00\u5c64\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"chain"),", \u901a\u5e38\u662f\u6703\u642d\u914d ",(0,a.kt)("inlineCode",{parentName:"li"},"-j $CHAIN_NAME")," \u4e00\u8d77\u4f7f\u7528\u3002")),(0,a.kt)("p",null,"\u6b64\u5916\u518d ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u6709\u975e\u5e38\u591a\u6709\u8da3\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Target")," \u53ef\u4ee5\u57f7\u884c"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"SNAT/DNAT: \u9019\u7a2e\u4fee\u6539\u5c01\u5305 ",(0,a.kt)("inlineCode",{parentName:"li"},"IP")," \u5730\u5740\u7684\u884c\u70ba"),(0,a.kt)("li",{parentName:"ol"},"NFQUEUE: \u64f4\u5145\u539f\u5148\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"QUEUE"),"\uff0c\u63d0\u4f9b\u66f4\u591a\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"queue number")," \u4f9b ",(0,a.kt)("inlineCode",{parentName:"li"},"user-space")," \u9078\u64c7\u3002"),(0,a.kt)("li",{parentName:"ol"},"log: \u55ae\u7d14\u8a18\u9304\u5c01\u5305\u8cc7\u8a0a\uff0c\u4e26\u4e14\u5f9e ",(0,a.kt)("inlineCode",{parentName:"li"},"kernel")," \u8f38\u51fa\uff0c\u53ef\u4ee5\u50ad ",(0,a.kt)("inlineCode",{parentName:"li"},"dmesg")," \u53bb\u89c0\u5bdf\u8a72\u8a18\u9304\u3002\u7531\u65bc\u8a72 ",(0,a.kt)("inlineCode",{parentName:"li"},"Target")," \u7684\u5be6\u4f5c\uff0c\u5176\u672c\u8eab\u4e26\u4e0d\u6703\u505a\u5230\u985e\u4f3c ",(0,a.kt)("inlineCode",{parentName:"li"},"ACCEPT/DROP")," \u9019\u7a2e\u99ac\u4e0a\u6c7a\u5b9a\u8a72\u5c01\u5305\u53bb\u7559\u7684\u884c\u70ba\uff0c\u800c\u662f\u6703\u7e7c\u7e8c\u8b93\u5c01\u5305\u5f80\u4e0b\u4e00\u500b\u898f\u5247\u5617\u8a66\u6bd4\u5c0d\u3002")),(0,a.kt)("p",null,"\u4e0b\u4e00\u7bc7\u6587\u7ae0\u5c31\u6703\u5927\u91cf\u4f7f\u7528\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"log")," \u9019\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"target")," \u4f86\u5e6b\u52a9\u6211\u5011\u89c0\u5bdf\u518d\u5bb9\u5668\u9593\u5c01\u5305\u50b3\u8f38\u6642\uff0c\u5230\u5e95\u6709\u54ea\u4e9b ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u6703\u88ab\u547c\u53eb\u5230\u3002"),(0,a.kt)("h3",{id:"summary"},"Summary"),(0,a.kt)("p",null,"\u6709\u4e86\u4e0a\u8ff0\u7684\u57fa\u672c\u6982\u5ff5\u5f8c\uff0c\u6211\u5011\u628a\u9019\u4e9b\u6982\u5ff5\u91cd\u65b0\u6574\u5408\u4e00\u6b21\uff0c\u5c07 ",(0,a.kt)("inlineCode",{parentName:"p"},"Table/Chain")," \u8207 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u9032\u884c\u6574\u5408\uff0c\u540c\u6642\u70ba\u4e86\u7c21\u55ae\u6e05\u695a\uff0c\u6211\u5011\u5c31\u53ea\u5c08\u6ce8\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"nat/filter")," \u9019\u5169\u5f35 ",(0,a.kt)("inlineCode",{parentName:"p"},"Table")," \u5373\u53ef\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/BFqDVwY.png",alt:"Imgur"})),(0,a.kt)("p",null,"\u9996\u5148\uff0c\u7576\u5c01\u5305\u5f9e\u7db2\u5361\u9032\u5165\u5f8c\uff0c\u9996\u5148\u6703\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"conntrack")," \u7684\u7ba1\u7406\uff0c\u8b93\u7cfb\u7d71\u5e6b\u4f60\u9032\u884c\u9023\u7dda\u8ffd\u8e64\u7684\u76f8\u95dc\u5de5\u4f5c\u3002"),(0,a.kt)("p",null,"\u9019\u908a\u7684\u8aaa\u6cd5\u90fd\u662f\u7cbe\u7c21\u7684\uff0c\u56e0\u70ba\u53bb\u6389\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"raw/mangle/security")," \u9019\u4e9b ",(0,a.kt)("inlineCode",{parentName:"p"},"Table")," \u7684\u95dc\u4fc2\uff0c\u5be6\u969b\u4e0a ",(0,a.kt)("inlineCode",{parentName:"p"},"raw")," \u672c\u8eab\u7684\u904b\u4f5c\u6703\u6bd4 ",(0,a.kt)("inlineCode",{parentName:"p"},"conntrack")," \u9084\u8981\u5feb\u3002"),(0,a.kt)("p",null,"\u63a5\u8005\u5c31\u662f\u6240\u8b02\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"PREROUTING"),", \u518d\u7cfb\u7d71\u6839\u64da\u5c01\u5305\u7684\u76ee\u7684\u5730",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\u9032\u884c\u9078\u64c7\u524d\uff0c\u6211\u5011\u53ef\u4ee5\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"PREROUTING")," \u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"DNAT")," \u7684\u65b9\u5f0f\u4fee\u6539\u5c01\u5305\u7684\u76ee\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\uff0c\u85c9\u6b64\u6539\u8b8a\u5c01\u5305\u7684\u50b3\u9001\u5c0d\u8c61\u3002"),(0,a.kt)("p",null,"\u6700\u5f8c\u5c31\u662f\u6240\u8b02\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Routing Decision")," \u4e86\uff0c\u9019\u90e8\u4efd\u6703\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"kernel")," \u5167\u900f\u904e\u67e5\u8a62 ",(0,a.kt)("inlineCode",{parentName:"p"},"routing table")," \u7684\u65b9\u5f0f"),(0,a.kt)("p",null,"\u53ef\u4ee5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"ip route"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"route")," \u7b49\u76f8\u95dc\u7684\u6307\u4ee4\u67e5\u8a62\u7cfb\u7d71\u4e0a\u7576\u524d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"routing")," \u898f\u5247\u3002"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"Routing")," \u67e5\u8a62\u5b8c\u7562\u4e4b\u5f8c\uff0c\u6703\u6709\u5169\u500b\u8d70\u5411\uff0c\u4e00\u500b\u662f\u5c07\u5c01\u5305\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"Socket")," \u7684\u65b9\u5f0f\u8b93 ",(0,a.kt)("inlineCode",{parentName:"p"},"\u4e0a\u5c64\u7684\u61c9\u7528\u7a0b\u5f0f")," \u53bb\u6536\u53d6\u5c01\u5305\uff0c\u9019\u7a2e\u60c5\u6cc1\u4e0b\u5c31\u6703\u8d70\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"INPUT chain")," \u7684\u968e\u6bb5\u8655\u7406\u3002 \u7ba1\u7406\u8005\u5c31\u53ef\u4ee5\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"INPUT")," \u9019\u908a\u5be6\u73fe\u7c21\u55ae\u7684\u9632\u706b\u7246\uff0c\u4f86\u91dd\u5c0d\u7279\u5b9a\u7684\u5c01\u5305\u7d66\u4e88\u901a\u904e\u6216\u662f\u4e1f\u68c4\u3002"),(0,a.kt)("p",null,"\u82e5\u67e5\u8a62 ",(0,a.kt)("inlineCode",{parentName:"p"},"routing")," \u5f8c\u6c7a\u5b9a\u8981\u5c07\u5c01\u5305\u8f49\u767c\u540c\u6642\u7cfb\u7d71\u4e5f\u6709\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"/proc/xxxxxx/ip_FORWARD")," \u9032\u884c\u8a2d\u5b9a\uff0c\u5247\u6b64\u6642\u5c31\u8a72\u5c01\u5305\u5c31\u6703\u958b\u59cb\u9032\u5165\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"FORWARD")," \u9019\u500b\u968e\u6bb5\u9032\u884c\u8655\u7406, \u6b64\u6642\u4e5f\u53ef\u4ee5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"filter")," \u9032\u884c\u7c21\u55ae\u7684\u9632\u706b\u7246\u904e\u6ffe\uff0c\u6c7a\u5b9a\u5c01\u5305\u7684\u53bb\u7559\u3002"),(0,a.kt)("p",null,"\u8d70\u5b8c ",(0,a.kt)("inlineCode",{parentName:"p"},"FORWARD")," \u5f8c\u5c31\u662f\u6240\u8b02\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"POSTROUTING")," \u4e86\uff0c\u9019\u908a\u53ef\u4ee5\u9032\u884c\u6240\u8b02\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"SANT"),", \u5c07\u5c01\u5305\u7684\u4f86\u6e90 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740\u4fee\u6539\u4ee5\u9806\u5229\u8b93\u8a72\u5c01\u5305\u80fd\u5920\u5efa\u7acb\u4e00\u689d\u9806\u5229\u7684\u7db2\u8def\u9023\u7dda\u3002"),(0,a.kt)("p",null,"\u5be6\u969b\u4e0a\uff0c\u518d ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684\u898f\u5247\u4e2d\uff0c\u6709\u5169\u7a2e\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"SNAT")," \u7684\u5be6\u73fe\u65b9\u6cd5\uff0c\u5206\u5225\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"-j SNAT xxx.xxx.xxx.xxx:xxx \u4ee5\u53ca -j MASQUERDAE"),"."),(0,a.kt)("p",null,"\u56e0\u70ba ",(0,a.kt)("inlineCode",{parentName:"p"},"SNAT")," \u518d\u904b\u4f5c\u7684\u6642\u5019\u5176\u5be6\u9700\u8981\u8003\u616e",(0,a.kt)("inlineCode",{parentName:"p"},"\u9023\u63a5\u57e0"),"\u7684\u8f49\u63db\uff0c\u6bcf\u4e00\u689d\u51fa\u53bb\u7684\u9023\u7dda\u90fd\u8981\u642d\u914d\u4e00\u500b",(0,a.kt)("inlineCode",{parentName:"p"},"\u9023\u63a5\u57e0"),"\u4f86\u4f5c\u70ba\u56de\u50b3\u9023\u7dda\u7684\u5339\u914d\u5c0d\u8c61\uff0c\u6240\u4ee5\u50b3\u7d71\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"SNAT Targer")," \u9700\u8981\u7279\u5225\u6307\u5b9a\u8a72\u6b21 ",(0,a.kt)("inlineCode",{parentName:"p"},"SNAT")," \u8f49\u63db\u5f8c\u7528\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\u8207\u9023\u63a5\u57e0\u3002\n\u4e0d\u904e\u9019\u7a2e\u60c5\u6cc1\u5be6\u5728\u662f\u6703\u8b93\u6574\u500b\u7cfb\u7d71\u8b8a\u5f97\u4e0d\u597d\u7528\uff0c\u6240\u4ee5\u5f8c\u4f86\u767c\u5c55\u51fa\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"MASQUERADE")," \u9019\u7a2e\u52d5\u614b ",(0,a.kt)("inlineCode",{parentName:"p"},"SNAT")," \u7684\u65b9\u5f0f\u8b93 ",(0,a.kt)("inlineCode",{parentName:"p"},"kernel")," \u81ea\u5df1\u5e6b\u4f60\u9078\u64c7\u8981\u4f7f\u7528\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u4ee5\u53ca\u9023\u63a5\u57e0\u3002"),(0,a.kt)("p",null,"\u6700\u5f8c\uff0c\u82e5\u4f7f\u7528\u8005\u7684\u7db2\u8def\u61c9\u7528\u7a0b\u5f0f\u9700\u8981\u5f80\u5916\u50b3\u9001\u5c01\u5305\uff0c\u5247\u8a72\u5c01\u5305\u6703\u5148\u9032\u5165\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"OUTPUT Chain"),", \u9019\u908a\u4e5f\u53ef\u4ee5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"filter")," \u9032\u884c\u9632\u706b\u7246\u7684\u64cd\u4f5c\u3002\n\u6700\u5f8c\u5c01\u5305\u5c31\u6703\u8d70\u5165 ",(0,a.kt)("inlineCode",{parentName:"p"},"POSTROUTING")," \u9032\u884c\u5f8c\u7e8c\u7684\u8655\u7406\u3002"),(0,a.kt)("h2",{id:"summary-with-ebtables"},"Summary With Ebtables."),(0,a.kt)("p",null,"\u524d\u8ff0\u6211\u5011\u5df2\u7d93\u770b\u5230\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684\u904b\u4f5c\u6d41\u7a0b\uff0c\u800c\u524d\u7bc7\u6587\u7ae0\u6211\u5011\u4e5f\u770b\u904e\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u7684\u904b\u4f5c\u6d41\u7a0b\u3002\n\u73fe\u5728\u6211\u5011\u9700\u8981\u5c07\u9019\u5169\u8005\u7684\u908f\u8f2f\u7d66\u7d50\u5408\uff0c\u69cb\u9020\u51fa\u4e00\u500b\u66f4\u8907\u96dc\u7684\u7db2\u8def\u7cfb\u7d71\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/9KA6I1W.png",alt:"Imgur"})),(0,a.kt)("p",null,"\u9019\u5f35\u5716\u88e1\u9762\u6211\u5011\u4f9d\u7136\u5206\u6210\u4e09\u500b\u90e8\u5206\u4f86\u770b\u5f85\uff0c\u5206\u5225\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"User-Application"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"Kernel-Space/Layer3")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"Kernel-Space/Layer2"),"."),(0,a.kt)("p",null,"\u7136\u5f8c\u5716\u4e2d\u91dd\u5c0d ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtalbes")," \u4f7f\u7528\u4e0d\u540c\u7684\u984f\u8272\u4f86\u8868\u793a\u5f7c\u6b64\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Chain/Table"),"\u3002"),(0,a.kt)("p",null,"\u63a5\u4e0b\u4f86\u8981\u4f86\u597d\u597d\u7684\u89e3\u91cb\u9019\u5f35\u5716\u7684\u6982\u5ff5\uff0c\u5728\u958b\u59cb\u524d\u6211\u5011\u5148\u6709\u4e00\u4e9b\u76f8\u95dc\u7684\u7406\u89e3\u3002"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u7121\u6240\u4e0d\u5728\uff0c\u7e31\u4f7f\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"Layer2 Bridging")," \u7684\u4e16\u754c\u4e2d\uff0c\u9084\u662f\u6703\u727d\u626f\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u7684\u904b\u4f5c\u3002(",(0,a.kt)("strong",{parentName:"li"},"\u5be6\u969b\u539f\u56e0\u6211\u4e0d\u6e05\u695a\uff0c\u4f46\u662f\u6211\u60f3\u8ddf ",(0,a.kt)("inlineCode",{parentName:"strong"},"conntrack")," \u6709\u95dc\uff0c\u4efb\u4f55\u7684\u5c01\u5305\u9023\u7dda ",(0,a.kt)("inlineCode",{parentName:"strong"},"linux kernel")," \u90fd\u60f3\u8981\u8ffd\u8e64"),", \u6b64\u5916\uff0c\u6211\u60f3\u8207\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"IP")," \u5730\u5740\u65b9\u5f0f\u53bb\u64cd\u4f5c\u7ba1\u7406\u5e73\u6613\u8fd1\u4eba\u4e5f\u6709\u95dc)"),(0,a.kt)("li",{parentName:"ol"},"\u6240\u6709\u5c01\u5305\u7684 ",(0,a.kt)("strong",{parentName:"li"},"\u8d77\u982d/\u7d42\u9ede")," \u4e00\u5b9a\u662f ",(0,a.kt)("strong",{parentName:"li"},"(\u7db2\u5361/\u61c9\u7528\u7a0b\u5f0f)"),",\u4e2d\u9593\u6703\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"Layer2")," \u4e5f\u6703\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"Layer3"),"\uff0c\u9019\u90e8\u4efd\u5b8c\u5168\u770b\u4f60",(0,a.kt)("strong",{parentName:"li"},"\u5c01\u5305\u4f86\u6e90\u7db2\u5361"),"\u8207",(0,a.kt)("strong",{parentName:"li"},"\u5c01\u5305\u76ee\u6a19\u7db2\u5361"),"\u5c6c\u65bc\u4ec0\u9ebc\u5c64\u7d1a\u800c\u6c7a\u5b9a\u600e\u9ebc\u8d70")),(0,a.kt)("p",null,"\u597d\u4e86\uff0c\u6211\u5011\u53ef\u4ee5\u597d\u597d\u7684\u4f86\u91cd\u65b0\u5be9\u8996\u9019\u5f35\u5716\uff0c\u4e00\u958b\u59cb\u6211\u5011\u5c31\u5148\u5f9e\u5c01\u5305\u7684\u9032\u5165\u9ede\uff0c\u4e5f\u5c31\u662f\u7db2\u5361\u9019\u908a\u4f86\u770b\u3002\n\u9996\u5148\u7576\u5c01\u5305\u9032\u5165\u7db2\u5361\u7684\u6642\u5019\uff0c\u6703\u5148\u9032\u5165\u6240\u8b02\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Bridge Check")," \u9019\u500b\u968e\u6bb5\uff0c\u9019\u6642\u5019\u6703\u6c7a\u5b9a\u5c01\u5305\u8981\u8d70\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer3")," \u8655\u7406\uff0c\u9084\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer2")," \u8655\u7406\u3002\u5e95\u4e0b\u6703\u91dd\u5c0d\u9019\u5169\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"Case")," \u63a2\u8a0e"),(0,a.kt)("p",null,"\u5176\u5be6\u9019\u500b\u968e\u6bb5\u975e\u5e38\u6709\u8da3\uff0c\u5404\u4f4d\u53ef\u4ee5\u60f3\u60f3\u770b\uff0c\u7576\u4f60\u770b\u5230\u4e00\u500b\u5c01\u5305\uff0c\u4f60\u600e\u9ebc\u77e5\u9053\u9019\u500b\u5c01\u5305\u5230\u5e95\u662f\u8981 ",(0,a.kt)("inlineCode",{parentName:"p"},"Routing")," \u9084\u662f\u8981 ",(0,a.kt)("inlineCode",{parentName:"p"},"Bridge"),"?\n\u5be6\u969b\u4e0a\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"Linux Kernel")," \u4f86\u8aaa\uff0c\u662f\u900f\u904e\u6240\u8b02\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"netdev_rx_handler_register")," \u4f86\u8a3b\u518a\u6bcf\u5f35\u7db2\u5361\u6536\u5230\u5c01\u5305\u5f8c\u8a72\u600e\u9ebc\u8655\u7406\u3002 \u4ee5 ",(0,a.kt)("inlineCode",{parentName:"p"},"Linux Bridge")," \u4f86\u770b\uff0c\u7576\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"brctl addif br1 xxx")," \u9019\u500b\u65b9\u5f0f\u628a ",(0,a.kt)("inlineCode",{parentName:"p"},"xxx")," \u52a0\u5165\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"br1")," \u9019\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"bridge")," \u6642\uff0c\u5c31\u6703\u628a ",(0,a.kt)("inlineCode",{parentName:"p"},"xxx")," \u9019\u500b\u7db2\u5361\u7684\u63a5\u6536\u5c01\u5305\u51fd\u5f0f\u8a2d\u5b9a\u6210 ",(0,a.kt)("inlineCode",{parentName:"p"},"bridge")," \u6709\u95dc\uff0c\u6240\u4ee5\u4e4b\u5f8c\u8fd1\u4f86\u7684\u5c01\u5305\u5c31\u6703\u8d70 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer2")," \u7684\u65b9\u5f0f\u53bb\u8dd1\uff0c\u53cd\u4e4b\u4ea6\u7136\u5176\u4ed6\u6309\u7167\u76f8\u540c\u9053\u7406\u5c31\u6703\u8d70 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer3")," \u7684\u6d41\u7a0b\u3002"),(0,a.kt)("p",null,"\u6709\u8208\u8da3\u89c0\u770b\u539f\u59cb\u78bc\u7684\u53ef\u4ee5\u53c3\u8003\u4e0b\u5217\u9023\u7d50\n",(0,a.kt)("a",{parentName:"p",href:"https://elixir.bootlin.com/linux/latest/source/net/bridge/br_if.c#L560"},"register handler function"),"\n",(0,a.kt)("a",{parentName:"p",href:"https://elixir.bootlin.com/linux/latest/source/net/bridge/br_input.c#L282"},"call ebtables")),(0,a.kt)("h3",{id:"layer3"},"Layer3"),(0,a.kt)("p",null,"\u5982\u679c\u4eca\u5929\u5c01\u5305\u8d70\u5230\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer3")," \u9019\u908a\u4f86\u8655\u7406\uff0c\u90a3\u8655\u7406\u7684\u6d41\u7a0b\u57fa\u672c\u4e0a\u5c31\u8ddf\u672c\u6587\u524d\u534a\u90e8\u5206\u63cf\u8ff0\u7684\u96f7\u540c\uff0c\u552f\u4e00\u4e0d\u540c\u9ede\u53ea\u6709\u7576\u9032\u884c\u5b8c\u7562 ",(0,a.kt)("inlineCode",{parentName:"p"},"Routing Decision")," \u5f8c\uff0c\u5728\u9078\u64c7 ",(0,a.kt)("inlineCode",{parentName:"p"},"FORWARDd")," \u7684\u968e\u6bb5\uff0c\u82e5\u8f49\u9001\u76ee\u7684\u5730\u7db2\u5361\u5c0d\u61c9\u5230\u7684\u662f\u5c6c\u65bc\u672c\u6a5f\u4e0a\u9762\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Linux Bridge")," \u7db2\u5361\uff0c\u5247\u5c01\u5305\u6700\u5f8c\u53c8\u6703\u8d70\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer2")," \u90a3\u5c64\uff0c\u5728\u9019\u60c5\u6cc1\u4e0b\u5c31\u6703\u5728\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u5f8c\u53c8\u6703\u99ac\u4e0a\u8f49\u63a5 ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables"),"\uff0c\u6700\u5f8c\u5c31\u6703\u9001\u5230\u7db2\u5361\u51fa\u53bb\u3002"),(0,a.kt)("h3",{id:"layer2"},"Layer2"),(0,a.kt)("p",null,"\u5982\u679c\u5c01\u5305\u4e00\u958b\u59cb\u9032\u5165\u9ede\u5c31\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"Linux Bridge")," \u7684\u7db2\u5361\uff0c\u9019\u6642\u5019\u53ef\u4ee5\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"brouting chain")," \u9032\u884c\u4e00\u6b21\u6aa2\u67e5\uff0c\u5982\u679c\u9019\u6642\u5019\u6709\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables"),"\u7279\u5225\u5c07\u5c01\u5305\u9001\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer3")," \u8655\u7406\u7684\u8a71\uff0c\u90a3\u6d41\u7a0b\u5c31\u6703\u5982\u540c\u4e0a\u8ff0\u4e00\u6a23\uff0c\u5f9e ",(0,a.kt)("inlineCode",{parentName:"p"},"conntrack")," \u4e00\u8def\u8d70\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"Routing Decision"),".\n\u5982\u679c\u7e7c\u7e8c\u6c7a\u5b9a\u8d70 ",(0,a.kt)("inlineCode",{parentName:"p"},"layer2")," \u4f86\u8655\u7406\u5c01\u5305\u7684\u8a71\uff0c\u90a3\u6d41\u7a0b\u5c31\u6703\u8ddf\u524d\u7bc7\u6587\u7ae0\u8b1b\u89e3 ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u6558\u8ff0\u7684\u6d41\u7a0b\u4e00\u6a23\u3002\u53ea\u662f\u9019\u908a\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f\uff0c\u5be6\u969b\u4e0a ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u4e5f\u6703\u6df7\u96dc\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"layer2")," \u7684\u8655\u7406\u904e\u7a0b\u4e2d\uff0c\u6240\u4ee5\u5728\u771f\u6b63\u9032\u884c ",(0,a.kt)("inlineCode",{parentName:"p"},"Bridge Decision")," \u524d\u4e5f\u6703\u9047\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables PREROUTING")," \u9032\u884c\u8655\u7406\u3002"),(0,a.kt)("p",null,"\u5982\u679c\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"Bridge Decision")," \u67e5\u8a62\u76ee\u6a19\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"MAC Address")," \u5f8c\u6c7a\u5b9a\u5c07\u5c01\u5305\u8f49\u9001\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"Linux Bridge")," \u672c\u8eab\u7684\u8a71\uff0c\u90a3\u6700\u5f8c\u5c31\u6703\u8d70\u5411 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer3")," \u4e0a\u5c64\u7684\u8d70\u6cd5\uff0c\u5426\u5247\u5247\u6703\u7e7c\u7e8c\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer2")," \u9019\u908a\u5c07\u5c01\u5305\u5f80\u5176\u4ed6\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Bridge Port")," \u53bb\u8f49\u767c\u3002"),(0,a.kt)("p",null,"\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"Bridge Port")," \u8f49\u767c\u7684\u904e\u7a0b\u4e2d\uff0c\u4e5f\u662f\u6703\u727d\u626f\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u76f8\u95dc\u7684\u898f\u5247\u3002\u6240\u4ee5\u82e5\u53ea\u662f\u55ae\u7d14\u7684\u5169\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"Bridge")," \u5e95\u4e0b\u7684\u5c01\u5305\u4e92\u76f8\u8f49\u50b3\u7684\u8a71\uff0c\u5176\u5be6\u4e5f\u662f\u53ef\u4ee5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u53bb\u63a7\u5236\u5c01\u5305\u8f49\u9001\uff0c\u6216\u662f\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"MAC Adddress")," \u53bb\u63a7\u5236\u5c01\u5305\u8f49\u9001\u3002"),(0,a.kt)("h3",{id:"application"},"Application"),(0,a.kt)("p",null,"\u6700\u5f8c\u4f86\u770b\uff0c\u5982\u679c\u662f\u5f9e\u672c\u6a5f\u61c9\u7528\u7a0b\u5f0f\u9001\u51fa\u53bb\u5c01\u5305\u7684\u8d70\u5411\uff0c\u9996\u5148\u5c01\u5305\u4e00\u5b9a\u6703\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer3")," \u76f8\u95dc\u7684\u8f49\u767c\uff0c\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"Routing Decision")," \u6642\u5c31\u6703\u77e5\u9053\u76ee\u7684\u5730\u7684\u7db2\u5361\u70ba\u4f55\uff0c\u5982\u679c\u76ee\u6a19\u7db2\u5361\u662f\u5c6c\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"Linux Bridge"),", \u5247\u6700\u5f8c\u8a72\u5c01\u5305\u53c8\u6703\u4e00\u8def\u8d70\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer2")," \u7684\u90e8\u4efd\uff0c\u6b64\u6642\u53c8\u53ef\u4ee5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtalbes")," \u5169\u8005\u4f86\u8655\u7406\u5c01\u5305\u3002"),(0,a.kt)("p",null,"\u5982\u679c\u76ee\u7684\u7db2\u5361\u4e0d\u662f\u4e0a\u8ff0\u7684\uff0c\u90a3\u57fa\u672c\u4e0a\u5c31\u6703\u76f4\u63a5\u8d70\u5b8c ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684\u904e\u7a0b\uff0c\u6700\u5f8c\u900f\u904e\u7db2\u5361\u8f49\u767c\u51fa\u53bb\u3002"),(0,a.kt)("p",null,"\u5176\u5be6\u6bd4\u8f03\u6b63\u78ba\u7684\u6bd4\u5c0d\u65b9\u5f0f\u61c9\u8a72\u662f\u8a72\u7db2\u5361\u672c\u8eab\u6703\u600e\u9ebc\u8655\u7406\u5c01\u5305\uff0c\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"Linux Kernel")," \u88e1\u9762\u6703\u91dd\u5c0d\u6bcf\u500b\u7db2\u5361",(0,a.kt)("strong",{parentName:"p"},"net device"),"\u53bb\u8a2d\u5b9a\u76f8\u95dc\u7684\u6536\u9001\u51fd\u5f0f\uff0c\u7576\u6709\u5c01\u5305\u8981\u5f9e\u8a72\u7db2\u5361\u9001\u51fa\u53bb\u6642\u5c31\u6703\u547c\u53eb\u5c0d\u61c9\u7684\u51fd\u5f0f\uff0c\u9019\u6642\u5019\u88e1\u9762\u5c31\u6703\u6c7a\u5b9a\u61c9\u8a72\u8981\u600e\u9ebc\u8655\u7406\u5c01\u5305\uff0c\u9032\u800c\u53bb\u547c\u53eb\u5c0d\u61c9\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtalbes")," \u76f8\u95dc\u7684\u8655\u7406\u3002\n\u6240\u4ee5\u4e00\u4e9b\u7279\u5225\u7684\u7db2\u5361\uff0c\u4e0d\u8ad6\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"IPSec/VXLan/Tun/Tap")," \u7b49\u5be6\u969b\u4e0a\u600e\u9ebc\u904b\u884c\u90fd\u9084\u662f\u8981\u770b ",(0,a.kt)("inlineCode",{parentName:"p"},"kernel")," \u5167\u771f\u6b63\u7684\u5be6\u4f5c\u4f86\u6c7a\u5b9a\u5230\u5e95\u5c01\u5305\u6703\u600e\u9ebc\u8d70\u3002"),(0,a.kt)("p",null,"\u5230\u9019\u908a\u5df2\u7d93\u5c07 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u5169\u8005\u7684\u95dc\u4fc2\u7d66\u7d50\u5408\u8d77\u4f86\uff0c\u53ef\u4ee5\u89c0\u5bdf\u5230\u5be6\u969b\u4e0a\u6703\u7d93\u904e\u7684\u898f\u5247\u662f\u975e\u5e38\u7684\u591a\u3002\n\u4e0b\u7bc7\u6587\u7ae0\u6211\u5011\u6703\u5617\u8a66\u4f7f\u7528\u771f\u6b63\u7684\u5bb9\u5668\u74b0\u5883\uff0c\u642d\u914d\u4e00\u4e9b\u64f4\u5145\u6a21\u7d44\u4f86\u5be6\u969b\u89c0\u5bdf\u9019\u4e9b\u5bb9\u5668\u4e0d\u540c\u65b9\u5411\u7684\u5c01\u5305\u50b3\u8f38\u5be6\u969b\u4e0a\u6703\u727d\u626f\u5230\u54ea\u4e9b\u76f8\u95dc\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"TABLE/CHAIN"),"."),(0,a.kt)("h2",{id:"reference"},"Reference"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://linux.die.net/man/8/ebtables"},"ebtables man page")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"http://ebtables.netfilter.org/br_fw_ia/br_fw_ia.html"},"ebtables/iptables interaction on a Linux-based bridge"))))}N.isMDXComponent=!0}}]);