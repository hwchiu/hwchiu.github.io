"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[5920],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>m});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),p=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},d=function(e){var n=p(e.components);return a.createElement(s.Provider,{value:n},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=p(t),h=r,m=c["".concat(s,".").concat(h)]||c[h]||u[h]||i;return t?a.createElement(m,o(o({ref:n},d),{},{components:t})):a.createElement(m,o({ref:n},d))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=h;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[c]="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=t[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},43831:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=t(87462),r=(t(67294),t(3905));const i={title:"[Container Network Interface] Implement Your CNI In Golang",tags:["CNI","Network","Container","Linux","Ubuntu","Golang","Kernel","Kubernetes"],date:new Date("2018-06-16T08:34:18.000Z"),description:"As we know, the kubernetes use the CNI to provide the network connectivity for its Pod unit and the cluster administrator can choose what kind of the CNI should be installed in the cluster. For example, if the only requirement is the overlay network, you can choose the flannel CNI and choose the calico CNI if you have the requirement of the BGP. In this post, we will learn how to write your own CNI in golang language. Actually, You can implement it with any language as you like."},o="Preface",l={unversionedId:"2018/introduce-cni-iii",id:"2018/introduce-cni-iii",title:"[Container Network Interface] Implement Your CNI In Golang",description:"As we know, the kubernetes use the CNI to provide the network connectivity for its Pod unit and the cluster administrator can choose what kind of the CNI should be installed in the cluster. For example, if the only requirement is the overlay network, you can choose the flannel CNI and choose the calico CNI if you have the requirement of the BGP. In this post, we will learn how to write your own CNI in golang language. Actually, You can implement it with any language as you like.",source:"@site/docs/2018/introduce-cni-iii.md",sourceDirName:"2018",slug:"/2018/introduce-cni-iii",permalink:"/docs/2018/introduce-cni-iii",draft:!1,tags:[{label:"CNI",permalink:"/docs/tags/cni"},{label:"Network",permalink:"/docs/tags/network"},{label:"Container",permalink:"/docs/tags/container"},{label:"Linux",permalink:"/docs/tags/linux"},{label:"Ubuntu",permalink:"/docs/tags/ubuntu"},{label:"Golang",permalink:"/docs/tags/golang"},{label:"Kernel",permalink:"/docs/tags/kernel"},{label:"Kubernetes",permalink:"/docs/tags/kubernetes"}],version:"current",lastUpdatedBy:"HungWei Chiu",frontMatter:{title:"[Container Network Interface] Implement Your CNI In Golang",tags:["CNI","Network","Container","Linux","Ubuntu","Golang","Kernel","Kubernetes"],date:"2018-06-16T08:34:18.000Z",description:"As we know, the kubernetes use the CNI to provide the network connectivity for its Pod unit and the cluster administrator can choose what kind of the CNI should be installed in the cluster. For example, if the only requirement is the overlay network, you can choose the flannel CNI and choose the calico CNI if you have the requirement of the BGP. In this post, we will learn how to write your own CNI in golang language. Actually, You can implement it with any language as you like."},sidebar:"techPost",previous:{title:"[Container Network Interface] CNI Introduction",permalink:"/docs/2018/introduce-cni-ii"},next:{title:"11\u500b\u4fdd\u8b77\u4f60 Kubernetes \u96c6\u7fa4\u7684\u6280\u5de7\u8207\u89c0\u5ff5(\u4e0a)",permalink:"/docs/2018/k8s-security-11tips-i"}},s={},p=[{value:"Basic CNI",id:"basic-cni",level:2},{value:"IPAM",id:"ipam",level:2},{value:"Step1",id:"step1",level:2},{value:"Step 2",id:"step-2",level:2},{value:"Step3",id:"step3",level:2},{value:"Step4",id:"step4",level:2}],d={toc:p},c="wrapper";function u(e){let{components:n,...t}=e;return(0,r.kt)(c,(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"preface"},"Preface"),(0,r.kt)("p",null,"It's a series post about the Container Network Interface and you can find other posts below.\n",(0,r.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/introduce-cni-i.html"},"[Container Network Interface] Bridge Network In Docker"),"\n",(0,r.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/introduce-cni-ii.html"},"[Container Network Interface] CNI Introduction ")),(0,r.kt)("p",null,"In this post, I will show how to write your own CNI program."),(0,r.kt)("p",null,"Container Network Interface(CNI) can be implemented by any programming languages as you like."),(0,r.kt)("p",null,"You just to follow the interface and your program can be used for every infrastructure using the CNI for their network connectivity."),(0,r.kt)("p",null,"In this tutorial, I will use the ",(0,r.kt)("inlineCode",{parentName:"p"},"golang")," to implement a simple CNI witch create a ",(0,r.kt)("inlineCode",{parentName:"p"},"Linux Bridge")," in the host and connect the container and the host itself."),(0,r.kt)("p",null,"I have create a github repo for this tutorial and you can find it on ",(0,r.kt)("a",{parentName:"p",href:"HTTPS://github.com/hwchiu/CNI_Tutorial_2018"},"hwchiu CNI_Tutorial_2018")),(0,r.kt)("h1",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"In order to help the develop to develop their own CNI, the ",(0,r.kt)("inlineCode",{parentName:"p"},"CNCF")," had setup two projects for developers."),(0,r.kt)("p",null,"Those projects are based on the golang language and provide useful libraries for the developer to control the Linux network functions, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"IP"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"network namespace"),"."),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"HTTPS://github.com/containernetworking/cni"},"ContainerNetworking/CNI")," provides the basic function for CNI implementation in golang and you can see the introduction of that project in its README"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"As well as the specification, this repository contains the Go source code of a library for integrating CNI into applications and an example command-line tool for executing CNI plugins. A separate repository contains reference plugins and a template for making new plugins.")),(0,r.kt)("p",null,"The other project ",(0,r.kt)("a",{parentName:"p",href:"HTTPS://github.com/containernetworking/plugins"},"ContainerNetwokring/Plugins")," provides some basic network functions for your CNI and it can be divided into two types."),(0,r.kt)("h2",{id:"basic-cni"},"Basic CNI"),(0,r.kt)("p",null,"It provides some basic CNI, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"Bridge"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"MacVlan"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Host Device"),".. And so on.\nYou can chain those CNI into your own CNI and combine those into a more powerful CNI."),(0,r.kt)("h2",{id:"ipam"},"IPAM"),(0,r.kt)("p",null,"IPAM (IP Address Management) provides some method to handle the IP/Route management. It provides ",(0,r.kt)("inlineCode",{parentName:"p"},"host-local"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"dhcp")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"static")," three methods now."),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},"host-local"),", you just need to provide a configuration file to describe what subnet/gateway you want to use and it will allocate a unused IP address from that subnet for your CNI.\nAnd the ",(0,r.kt)("inlineCode",{parentName:"p"},"dhcp")," will runs a ",(0,r.kt)("inlineCode",{parentName:"p"},"DHCP")," client in each container and send a ",(0,r.kt)("inlineCode",{parentName:"p"},"dhcp request")," to get a IP address from the ",(0,r.kt)("inlineCode",{parentName:"p"},"dhcp")," server."),(0,r.kt)("p",null,"In this tutorial, we will implement a ",(0,r.kt)("inlineCode",{parentName:"p"},"bridge")," CNI and explain those functions step by step."),(0,r.kt)("h1",{id:"before-we-start"},"Before We Start"),(0,r.kt)("p",null,"Before we start to implement the CNI, we must know the ",(0,r.kt)("inlineCode",{parentName:"p"},"interface"),"/",(0,r.kt)("inlineCode",{parentName:"p"},"specification")," of the ",(0,r.kt)("inlineCode",{parentName:"p"},"CNI"),"."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Your CNI will be invoked when the container is ",(0,r.kt)("inlineCode",{parentName:"li"},"ready to create or has been terminated"),".")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Allocate resources for the container, including the ",(0,r.kt)("inlineCode",{parentName:"li"},"IP address")," and the network connectivity."),(0,r.kt)("li",{parentName:"ul"},"Remove all resources you allocated before when a container has been terminated.")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"The caller will pass the following information into your CNI program")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Command (What kind of the event you should care)",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"ADD"),(0,r.kt)("li",{parentName:"ul"},"DELETE"),(0,r.kt)("li",{parentName:"ul"},"VERSION"))),(0,r.kt)("li",{parentName:"ul"},"ContainerID (The target ContainerID)"),(0,r.kt)("li",{parentName:"ul"},"NetNS (THe network namespace path of the container)"),(0,r.kt)("li",{parentName:"ul"},"IFNAME (The interface name should be created in the container)"),(0,r.kt)("li",{parentName:"ul"},"PATH (The current working PATH, you should use it to execute other CNI)"),(0,r.kt)("li",{parentName:"ul"},"STDIN (The configuration file of your CNI)")),(0,r.kt)("h1",{id:"step-by-step"},"Step By Step"),(0,r.kt)("p",null,"For each step, you can find a corresponding folder in my github repo and there's all golang files for each steps."),(0,r.kt)("h2",{id:"step1"},"Step1"),(0,r.kt)("p",null,"First, we need to provide two function for ",(0,r.kt)("inlineCode",{parentName:"p"},"ADD")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"DELETE")," event which is used to allocate/recycle resource when the container has been start/terminated."),(0,r.kt)("p",null,"We use the framework provided by the The ",(0,r.kt)("a",{parentName:"p",href:"HTTPS://github.com/containernetworking/cni"},"ContainerNetworking/CNI")," and it will encapsulate"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'Package main\n\nImport (\n    "github.com/containernetworking/cni/pkg/skel"\n    "github.com/containernetworking/cni/pkg/version"\n)\n\nfunc cmdAdd(args *skel.CmdArgs) error {\n    return nil\n}\n\nfunc cmdDel(args *skel.CmdArgs) error {\n    return nil\n}\n\nfunc main() {\n    skel.PluginMain(cmdAdd, cmdDel, version.All)\n}\n')),(0,r.kt)("p",null,"In this framework, it encapsulates all information we need into a predefined type ",(0,r.kt)("inlineCode",{parentName:"p"},"skel.CmdArgs")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"type CmdArgs struct {\n    ContainerID string\n    Netns string\n    IfName string\n    Args string\n    Path string\n    StdinData []byte\n}\n\n")),(0,r.kt)("p",null,"Use the ",(0,r.kt)("inlineCode",{parentName:"p"},"go build")," to build the binary and assume our execution file  is ",(0,r.kt)("inlineCode",{parentName:"p"},"example")," and then we should provide a basic configuration which should contains useful information for our CNI.\nMaybe we call the file ",(0,r.kt)("inlineCode",{parentName:"p"},"configuration")," its contents looks like"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "name": "mynet",\n    "BridgeName": "test",\n    "IP": "192.0.2.1/24"\n}\n')),(0,r.kt)("p",null,"Now, We can use the following command to execute our CNI program."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell=bash"},"sudo CNI_COMMAND=ADD CNI_CONTAINERID=ns1 \\\nCNI_NETNS=/var/run/netns/ns1 CNI_IFNAME=eth10 \\\nCNI_PATH=`pwd` \\\n./example < config\n")),(0,r.kt)("p",null,"For that go CNI framework, those infromation should be passed by the ",(0,r.kt)("inlineCode",{parentName:"p"},"environement")," and we can get that from the ",(0,r.kt)("inlineCode",{parentName:"p"},"CmdArgs"),"."),(0,r.kt)("p",null,"Actually, we have done the basic CNI program but it does nothing."),(0,r.kt)("p",null,"A good CNI should make a container network connectivity and assign a valid IP address to the container and we will do that in the foloowing tutorial."),(0,r.kt)("h2",{id:"step-2"},"Step 2"),(0,r.kt)("p",null,"Now, we will create a linux bridge for the container and the logical flow looks like"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Read the bridge information from the config."),(0,r.kt)("li",{parentName:"ol"},"Get the bridge name we want to use."),(0,r.kt)("li",{parentName:"ol"},"Create the bridge if it doesn't exist in the system.")),(0,r.kt)("p",null,"Since the frametwork store the config content in the ",(0,r.kt)("inlineCode",{parentName:"p"},"CmdArgs")," object as a ",(0,r.kt)("inlineCode",{parentName:"p"},"[]byte")," form. we should create a ",(0,r.kt)("inlineCode",{parentName:"p"},"structure")," to decode those ",(0,r.kt)("inlineCode",{parentName:"p"},"[]byte")," data."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'type SimpleBridge struct {\n    BridgeName string `json:"bridgeName"`\n    IP    string `json:"ip"`\n}\n')),(0,r.kt)("p",null,"and decode the config content in the ",(0,r.kt)("inlineCode",{parentName:"p"},"CmdAdd")," function."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"func cmdAdd(args *skel.CmdArgs) error {\n    sb := SimpleBridge{}\n    if err := json.Unmarshal(args.StdinData, &sb); err != nil {\n        return err\n    }\n    fmt.Println(sb)\n")),(0,r.kt)("p",null,"There're many ways for creating the Linuxu Bridge, we can use the system commadn ",(0,r.kt)("inlineCode",{parentName:"p"},"brctl addbr")," via the ",(0,r.kt)("inlineCode",{parentName:"p"},"os.Exec")," or use the ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink")," to create."),(0,r.kt)("p",null,"We choose the ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink")," method here since the ",(0,r.kt)("inlineCode",{parentName:"p"},"os.Exec")," is too easy for developer."),(0,r.kt)("p",null,"First, we should import the ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink")," package ",(0,r.kt)("inlineCode",{parentName:"p"},'"github.com/vishvananda/netlink"'),"\nand we will use the type ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink.Bridge")," to describe the bridge we want."),(0,r.kt)("p",null,"In the following example, we will do three things."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Prepare the netlink.Bridge object we want."),(0,r.kt)("li",{parentName:"ol"},"Create the Bridge"),(0,r.kt)("li",{parentName:"ol"},"Setup the Linux Bridge.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"    br := &netlink.Bridge{\n        LinkAttrs: netlink.LinkAttrs{\n            Name: sb.BridgeName,\n            MTU:  1500,\n            // Let kernel use default txqueuelen; leaving it unset\n            // means 0, and a zero-length TX queue messes up FIFO\n            // traffic shapers which use TX queue length as the\n            // default packet limit\n            TxQLen: -1,\n        },\n    }\n\n    err := netlink.LinkAdd(br)\n    if err != nil && err != syscall.EEXIST {\n        return err\n    }\n\n    if err := netlink.LinkSetUp(br); err != nil {\n        return err\n    }\n")),(0,r.kt)("p",null,"Now. The ",(0,r.kt)("inlineCode",{parentName:"p"},"CmdAdd")," function should look like below."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"func cmdAdd(args *skel.CmdArgs) error {\n    sb := SimpleBridge{}\n    if err := json.Unmarshal(args.StdinData, &sb); err != nil {\n        return err\n    }\n    fmt.Println(sb)\n\n    br := &netlink.Bridge{\n        LinkAttrs: netlink.LinkAttrs{\n            Name: sb.BridgeName,\n            MTU:  1500,\n            // Let kernel use default txqueuelen; leaving it unset\n            // means 0, and a zero-length TX queue messes up FIFO\n            // traffic shapers which use TX queue length as the\n            // default packet limit\n            TxQLen: -1,\n        },\n    }\n\n    err := netlink.LinkAdd(br)\n    if err != nil && err != syscall.EEXIST {\n        return err\n    }\n\n    if err := netlink.LinkSetUp(br); err != nil {\n        return err\n    }\n")),(0,r.kt)("p",null,"Use the aforementioned command to call the binary again and you should see the linux bridge ",(0,r.kt)("inlineCode",{parentName:"p"},"test")," has been created."),(0,r.kt)("p",null,"If youu don't have the ",(0,r.kt)("inlineCode",{parentName:"p"},"brctl")," command, use the ",(0,r.kt)("inlineCode",{parentName:"p"},"apt-get install bridge-utils to")," to install the bridge tools."),(0,r.kt)("h2",{id:"step3"},"Step3"),(0,r.kt)("p",null,"In the next step, we will creat a ",(0,r.kt)("inlineCode",{parentName:"p"},"veth")," for connecting the ",(0,r.kt)("inlineCode",{parentName:"p"},"linux")," bridge and the taget ",(0,r.kt)("inlineCode",{parentName:"p"},"container"),"."),(0,r.kt)("p",null,"The logical flow are"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Get the bridge object from the ",(0,r.kt)("inlineCode",{parentName:"li"},"Bridge")," we created before"),(0,r.kt)("li",{parentName:"ol"},"Get the namespace of the container"),(0,r.kt)("li",{parentName:"ol"},"Create a veth on the container and move the host-end veth to host ns."),(0,r.kt)("li",{parentName:"ol"},"Attach a host-end veth to linux bridge")),(0,r.kt)("p",null,"This step is more complicate then previous steps. since we will handle the ",(0,r.kt)("inlineCode",{parentName:"p"},"network namespace")," here.\nFortunately, the ",(0,r.kt)("inlineCode",{parentName:"p"},"CNI")," project has provided convenience function to handle the veth and it can cover the (3) action itom above."),(0,r.kt)("p",null,"First, we use the ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink.LinkByName")," method to lookup the ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink")," object."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'    l, err := netlink.LinkByName(sb.BridgeName)\n    if err != nil {\n        return fmt.Errorf("could not lookup %q: %v", sb.BridgeName, err)\n    }\n')),(0,r.kt)("p",null,"and the we need to make sure that object is ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink.Bridge"),", so we do the type casting."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'    newBr, ok := l.(*netlink.Bridge)\n    if !ok {\n        return fmt.Errorf("%q already exists but is not a bridge", sb.BridgeName)\n    }\n')),(0,r.kt)("p",null,"Second, since the ",(0,r.kt)("inlineCode",{parentName:"p"},"CmdArgs")," already provide the ",(0,r.kt)("inlineCode",{parentName:"p"},"network namespace ")," path of the container, we can use the method from the ",(0,r.kt)("inlineCode",{parentName:"p"},"ns")," package to load the object of the network namespace."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'import `"github.com/containernetworking/plugins/pkg/ns"`\n    netns, err := ns.GetNS(args.Netns)\n    if err != nil {\n        return err\n    }\n')),(0,r.kt)("p",null,"For each ",(0,r.kt)("inlineCode",{parentName:"p"},"NetNS")," object, it implement a function ",(0,r.kt)("inlineCode",{parentName:"p"},"Do")," which take a function as its parameter and that function's parameter is the caller's network namespace."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"do")," function will switch the network namespace to ",(0,r.kt)("inlineCode",{parentName:"p"},"NetNS")," object itself and call the function(parameter) and feed the original network namespace as parameter."),(0,r.kt)("p",null,"See the following example to learn more about ",(0,r.kt)("inlineCode",{parentName:"p"},"do")," function."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"var handler = func(hostNS ns.NetNS) error {\n    hostVeth, containerVeth, err := ip.SetupVeth(args.IfName, 1500, hostNS)\n}\n\nif err := netns.Do(handler); err != nil {\nreturn err\n}\n")),(0,r.kt)("p",null,"First , we create a function handler which calls the ",(0,r.kt)("inlineCode",{parentName:"p"},"ip.SetpuVeth")," to create a veth pair on caller's network namespace and move one side of veth pair to its third parameter(",(0,r.kt)("inlineCode",{parentName:"p"},"hostNS"),")"),(0,r.kt)("p",null,"When we call the ",(0,r.kt)("inlineCode",{parentName:"p"},"netns.Do(handler)"),", it will call the function ",(0,r.kt)("inlineCode",{parentName:"p"},"handler")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"netns's")," network namepsace and pass the caller's network namespace to the ",(0,r.kt)("inlineCode",{parentName:"p"},"function handler"),".\nWhich will result in that there will be a veth pair between the host's network namespace and ",(0,r.kt)("inlineCode",{parentName:"p"},"netns's")," netowkr namespace."),(0,r.kt)("p",null,"In order to store the information about that veth pair, we can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"current.Interface{}")," object to store the data."),(0,r.kt)("p",null,"First, we need to import the library"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'import "github.com/containernetworking/cni/pkg/types/current"\n')),(0,r.kt)("p",null,"and then create a variable represent to host side network interface in the function handler."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"hostIface := &current.Interface{}\nvar handler = func(hostNs ns.Netns) error {\n    hostVeth, _, err := ip.SetupVeth(args.IfName, 1500, hostNS)\n    if err != nil {\n        return err\n    }\n\n    hostIface.Name = hostVeth.Name\n    return nil\n}\n")),(0,r.kt)("p",null,"Now, we can get the interface name of veth pair in the host side by ",(0,r.kt)("inlineCode",{parentName:"p"},"hostIface.Name")," and then we will attach that link to the ",(0,r.kt)("inlineCode",{parentName:"p"},"Linux Bridge")," we created before."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Get the link object from the interface name by function call ",(0,r.kt)("inlineCode",{parentName:"li"},"netlink.LinkByName")),(0,r.kt)("li",{parentName:"ol"},"Connect the link to bridge by function call ",(0,r.kt)("inlineCode",{parentName:"li"},"netlink.LinkSetMaster"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"hostVeth, err := netlink.LinkByName(hostIface.Name)\nif err != nil {\n    return err\n}\n\nif err := netlink.LinkSetMaster(hostVeth, newBr); err != nil {\n    return err\n}\n\n")),(0,r.kt)("p",null,"There is one important thing we need to care is the OS thread. since we will switch the ",(0,r.kt)("inlineCode",{parentName:"p"},"netns")," to handle the namespace things.\nWe must make sure the OS won't switch the thread during the ",(0,r.kt)("inlineCode",{parentName:"p"},"namespace")," operations."),(0,r.kt)("p",null,"Use the function ",(0,r.kt)("inlineCode",{parentName:"p"},"runtime.LockOSThread()")," in the golang predefined function ",(0,r.kt)("inlineCode",{parentName:"p"},"init()"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"func init() {\n        // this ensures that main runs only on main thread (thread group leader).\n        // since namespace ops (unshare, setns) are done for a single thread, we\n        // must ensure that the goroutine does not jump from OS thread to thread\n        runtime.LockOSThread()\n}```\n\nSee the whole example program in https://github.com/hwchiu/CNI_Tutorial_2018/tree/master/tutorial/step3 and you can directly run\nthe `run.sh` in your linux machine to see the following output.\n```shell=\nReady to call the step3 example\n{test 192.0.2.1/24}\nThe CNI has been called, see the following results\nThe bridge and the veth has been attatch to\nbridge name     bridge id               STP enabled     interfaces\ntest            8000.aa6e12faa09b       no              vethff65a064\nThe interface in the netns\neth10     Link encap:Ethernet  HWaddr 7e:23:e2:e5:8f:c4\n          inet6 addr: fe80::7c23:e2ff:fee5:8fc4/64 Scope:Link\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:1 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:1 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:90 (90.0 B)  TX bytes:90 (90.0 B)\n\nlo        Link encap:Local Loopback\n          LOOPBACK  MTU:65536  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1\n          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)\n")),(0,r.kt)("p",null,"We have successfully create a linux bridge and connect to the other network namespace via the veth pair and the interface in that namepsace is ",(0,r.kt)("inlineCode",{parentName:"p"},"eth10")," which has been defiend in the config file."),(0,r.kt)("h2",{id:"step4"},"Step4"),(0,r.kt)("p",null,"In this step, we will setup the IP address into the target network namespace.\nTo make the problem easy, we had set the target IP address in the config and we can get via the ",(0,r.kt)("inlineCode",{parentName:"p"},"sp.IP")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'type SimpleBridge struct {\n        BridgeName string `json:"bridgeName"`\n        IP         string `json:"ip"`\n}\n')),(0,r.kt)("p",null,"The function we used to assign the IP address is ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink.AddrAdd"),"\nSo the workflow is"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Generate a IP object from the config."),(0,r.kt)("li",{parentName:"ol"},"Call the ",(0,r.kt)("inlineCode",{parentName:"li"},"nelink.AddrAdd")," in the target network namespace.")),(0,r.kt)("p",null,"The parameter of ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink.AddrAdd")," is ",(0,r.kt)("inlineCode",{parentName:"p"},"netlink.Addr")," and see its structure below."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"type Addr struct {\n        *net.IPNet\n        Label       string\n        Flags       int\n        Scope       int\n        Peer        *net.IPNet\n        Broadcast   net.IP\n        PreferedLft int\n        ValidLft    int\n}\n")),(0,r.kt)("p",null,"We can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"net")," package provided by official golang to generate the ",(0,r.kt)("inlineCode",{parentName:"p"},"net.IPNet")," type and its a CIDR form (IP address and the Mask)."),(0,r.kt)("p",null,"Since the IP address in our config is a string",(0,r.kt)("inlineCode",{parentName:"p"},"192.0.2.15/24"),",\nwe use the ",(0,r.kt)("inlineCode",{parentName:"p"},"net.ParseCIDR")," to parse the string and return a pointer of ",(0,r.kt)("inlineCode",{parentName:"p"},"net.IPNet")),(0,r.kt)("p",null,"So, modify the previous handler to assign the IP address when we create a veth."),(0,r.kt)("p",null,"Since the ",(0,r.kt)("inlineCode",{parentName:"p"},"net.IPNet")," object get from the ",(0,r.kt)("inlineCode",{parentName:"p"},"net.ParseCIDR")," is the ",(0,r.kt)("inlineCode",{parentName:"p"},"subnet"),"  not a ",(0,r.kt)("inlineCode",{parentName:"p"},"real IP")," addrees, we should reassign the ",(0,r.kt)("inlineCode",{parentName:"p"},"IP")," address to its IP field again."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'var handler = func(hostNS ns.NetNS) error {\n    hostVeth, containerVeth, err := ip.SetupVeth(args.IfName, 1500, hostNS)\n    if err != nil {\n        return err\n    }\n    hostIface.Name = hostVeth.Name\n\n    ipv4Addr, ipv4Net, err := net.ParseCIDR(sb.IP)\n    if err != nil {\n        return err\n    }\n\n    link, err := netlink.LinkByName(containerVeth.Name)\n    if err != nil {\n        return err\n    }\n\n    ipv4Net.IP = ipv4Addr\n\n    addr := &netlink.Addr{IPNet: ipv4Net, Label: ""}\n    if err = netlink.AddrAdd(link, addr); err != nil {\n        return err\n    }\n    return nil\n}\n\n')),(0,r.kt)("p",null,"See the whole example program in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/hwchiu/CNI_Tutorial_2018/tree/master/tutorial/step4"},"https://github.com/hwchiu/CNI_Tutorial_2018/tree/master/tutorial/step4")," and you can directly run\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"run.sh")," in your linux machine to see the following output."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"Ready to call the step4 example\n{test 192.0.2.15/24}\nThe CNI has been called, see the following results\nThe bridge and the veth has been attatch to\nbridge name     bridge id               STP enabled     interfaces\ntest            8000.a6f55b2927c0       no              vethd611bb3b\nThe interface in the netns\neth10     Link encap:Ethernet  HWaddr aa:a0:96:45:65:c5\n          inet addr:192.0.2.15  Bcast:192.0.2.255  Mask:255.255.255.0\n          inet6 addr: fe80::a8a0:96ff:fe45:65c5/64 Scope:Link\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:2 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:1 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:168 (168.0 B)  TX bytes:90 (90.0 B)\n\nlo        Link encap:Local Loopback\n          LOOPBACK  MTU:65536  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1\n          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)\n")),(0,r.kt)("p",null,"And you can see we have already set the IP address to the interface ",(0,r.kt)("inlineCode",{parentName:"p"},"eth10"),".\nYou can use the following command to mamually set the IP address to the linux bridge and use the ",(0,r.kt)("inlineCode",{parentName:"p"},"ping")," command to check the network connectiviy between the host and the target network namespace."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"sudo ifconfig test 192.0.2.1\nsudo ip netns exec ns1 ping 192.0.2.1\n")),(0,r.kt)("h1",{id:"summary"},"Summary"),(0,r.kt)("p",null,"In this tutorial, we have implemented a simple Linux Bridge CNI (only Add function) in golang."),(0,r.kt)("p",null,"We create the linux bridge and use the veth to connect the linux bridge with the target netowrk namespace.\nBesides, we also fethc the information we want from the pre-defined config file which means we can more flexible to change the behavior of your own CNI implementation."),(0,r.kt)("p",null,"To make the problem simple, we don't use any complicated method to acquire a unique address from the config but you can desing you own algorithm to do that.\nIf you want to learn more about the IP related operations, you can go to the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containernetworking/plugins/tree/master/plugins/ipam/host-local"},"host-local")," to learn more."))}u.isMDXComponent=!0}}]);