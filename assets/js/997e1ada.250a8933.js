"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[17952],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),l=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=l(e.components);return a.createElement(s.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},g=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),u=l(n),g=r,d=u["".concat(s,".").concat(g)]||u[g]||m[g]||o;return n?a.createElement(d,i(i({ref:t},c),{},{components:n})):a.createElement(d,i({ref:t},c))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=g;var p={};for(var s in t)hasOwnProperty.call(t,s)&&(p[s]=t[s]);p.originalType=e,p[u]="string"==typeof e?e:r,i[1]=p;for(var l=2;l<o;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}g.displayName="MDXCreateElement"},52911:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>o,metadata:()=>p,toc:()=>l});var a=n(87462),r=(n(67294),n(3905));const o={title:"Device Plugin - Implementation",sidebar_position:23,date:new Date("2019-10-08T15:00:26.000Z"),tags:["Kubernetes","DevicePlugin","iThome"],description:"\u672c\u7bc7\u6587\u7ae0\u6703\u5c31 device plugin \u672c\u8eab\u7684\u67b6\u69cb\u4f86\u63a2\u8a0e\u5982\u4f55\u5be6\u505a\u4e00\u500b device plugin \u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u5f9e\u5176\u6e9d\u901a\u4ecb\u9762\u5230\u904b\u4f5c\u6d41\u7a0b\u9032\u884c\u63a2\u8a0e\uff0c\u900f\u904e\u9019\u4e9b\u7406\u89e3\u8207\u8a0e\u8ad6\u6703\u5c0d device plugin \u6709\u66f4\u591a\u7684\u4e86\u89e3"},i="\u524d\u8a00",p={unversionedId:"techPost/2019/iThome_Challenge/k8s-device-plugin-implement",id:"techPost/2019/iThome_Challenge/k8s-device-plugin-implement",title:"Device Plugin - Implementation",description:"\u672c\u7bc7\u6587\u7ae0\u6703\u5c31 device plugin \u672c\u8eab\u7684\u67b6\u69cb\u4f86\u63a2\u8a0e\u5982\u4f55\u5be6\u505a\u4e00\u500b device plugin \u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u5f9e\u5176\u6e9d\u901a\u4ecb\u9762\u5230\u904b\u4f5c\u6d41\u7a0b\u9032\u884c\u63a2\u8a0e\uff0c\u900f\u904e\u9019\u4e9b\u7406\u89e3\u8207\u8a0e\u8ad6\u6703\u5c0d device plugin \u6709\u66f4\u591a\u7684\u4e86\u89e3",source:"@site/docs/techPost/2019/iThome_Challenge/k8s-device-plugin-implement.md",sourceDirName:"techPost/2019/iThome_Challenge",slug:"/techPost/2019/iThome_Challenge/k8s-device-plugin-implement",permalink:"/docs/techPost/2019/iThome_Challenge/k8s-device-plugin-implement",draft:!1,tags:[{label:"Kubernetes",permalink:"/docs/tags/kubernetes"},{label:"DevicePlugin",permalink:"/docs/tags/device-plugin"},{label:"iThome",permalink:"/docs/tags/i-thome"}],version:"current",sidebarPosition:23,frontMatter:{title:"Device Plugin - Implementation",sidebar_position:23,date:"2019-10-08T15:00:26.000Z",tags:["Kubernetes","DevicePlugin","iThome"],description:"\u672c\u7bc7\u6587\u7ae0\u6703\u5c31 device plugin \u672c\u8eab\u7684\u67b6\u69cb\u4f86\u63a2\u8a0e\u5982\u4f55\u5be6\u505a\u4e00\u500b device plugin \u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u5f9e\u5176\u6e9d\u901a\u4ecb\u9762\u5230\u904b\u4f5c\u6d41\u7a0b\u9032\u884c\u63a2\u8a0e\uff0c\u900f\u904e\u9019\u4e9b\u7406\u89e3\u8207\u8a0e\u8ad6\u6703\u5c0d device plugin \u6709\u66f4\u591a\u7684\u4e86\u89e3"},sidebar:"techPost",previous:{title:" Device Plugin - Introduction",permalink:"/docs/techPost/2019/iThome_Challenge/k8s-device-plugin"},next:{title:"Kubernetes - Device Plugin - RDMA",permalink:"/docs/techPost/2019/iThome_Challenge/k8s-device-plugin-rdma"}},s={},l=[{value:"GetDevicePluginOptions",id:"getdevicepluginoptions",level:2},{value:"ListAndWatch",id:"listandwatch",level:2},{value:"Alloocate",id:"alloocate",level:2},{value:"PreStartContainer",id:"prestartcontainer",level:2}],c={toc:l},u="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u524d\u8a00"},"\u524d\u8a00"),(0,r.kt)("p",null,"\u524d\u7bc7\u6587\u7ae0\u5df2\u7d93\u63a2\u8a0e\u4e86 ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u7684\u8a2d\u8a08\u7406\u5ff5\u4ee5\u53ca\u57fa\u672c\u4f7f\u7528\u6d41\u7a0b\uff0c\u800c\u672c\u7bc7\u6587\u7ae0\u6703\u6bd4\u8f03\u4ee5\u6280\u8853\u6027\u7684\u89d2\u5ea6\u4f86\u63a2\u8a0e\u9019\u500b\u6846\u67b6\uff0c\u8207\u6b64\u540c\u6642\u4e5f\u53ef\u4ee5\u770b\u770b\u9019\u500b\u6846\u67b6\u7684\u4f7f\u7528\u65b9\u5f0f\u8207\u524d\u8ff0\u7684 ",(0,r.kt)("strong",{parentName:"p"},"CRI/CNI/CSI")," \u9019\u4e9b\u6a19\u6e96\u7684\u4ecb\u9762\u6709\u4f55\u4e0d\u540c\u3002"),(0,r.kt)("p",null,"\u524d\u8ff0\u63d0\u5230\u904e ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u6703\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"unix socket")," \u8207 ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u9032\u884c\u6e9d\u901a\uff0c\u800c\u5be6\u969b\u4e0a\u9019\u500b\u6e9d\u901a\u7684\u90e8\u5206\u4e5f\u662f\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"gRPC + protobuf")," \u63cf\u8ff0\u7684\u4ecb\u9762\u4f86\u9032\u884c\u6e9d\u901a\uff0c\u56e0\u6b64\u5b98\u65b9\u91dd\u5c0d ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u7684\u6846\u67b6\u6709\u5b9a\u7fa9\u4e86\u4e00\u7cfb\u5217\u7684\u4ecb\u9762\uff0c\u6bcf\u500b\u89e3\u6c7a\u65b9\u6848\u90fd\u8981\u6eff\u8db3\u9019\u4e9b\u4ecb\u9762\u624d\u53ef\u4ee5\u9806\u5229\u5730\u8207 ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u6e9d\u901a\uff0c\u6700\u5f8c\u9806\u5229\u7684\u65bc kubernetes \u5167\u904b\u4f5c\u3002"),(0,r.kt)("p",null,"\u518d\u63a2\u8a0e ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u524d\uff0c\u5fc5\u9808\u8981\u5148\u91dd\u5c0d\u7248\u672c\u6709\u6240\u5171\u8b58\uff0c\u76ee\u524d\u7684 ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u672c\u8eab\u7684\u4ecb\u9762\u6709\u5169\u500b\u7248\u672c\uff0c\u5206\u5225\u662f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/apis/deviceplugin/v1alpha/api.proto"},"v1alpha")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/apis/deviceplugin/v1beta1/api.proto"},"v1beta1"))),(0,r.kt)("p",null,"\u672c\u6587\u63a2\u8a0e\u7684\u4e3b\u8981\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"v1beta1")," \u7684\u7248\u672c\u4f86\u63a2\u8a0e\u3002"),(0,r.kt)("h1",{id:"\u67b6\u69cb"},"\u67b6\u69cb"),(0,r.kt)("p",null,"\u8981\u5be6\u73fe\u4e00\u500b\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u6846\u67b6\u7684\u89e3\u6c7a\u65b9\u6848\u975e\u5e38\u7c21\u55ae\uff0c\u5c31\u662f\u5be6\u73fe\u4e00\u500b\u6eff\u8db3\u4ecb\u9762\u9700\u6c42\u7684 ",(0,r.kt)("strong",{parentName:"p"},"gRPC")," \u670d\u52d9\u5668\uff0c\u4ecb\u9762\u975e\u5e38\u7c21\u55ae\uff0c\u53ea\u6709\u56db\u500b\u51fd\u5f0f\u9700\u8981\u5be6\u73fe\u800c\u5df2\uff0c\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"service DevicePlugin {\n    // GetDevicePluginOptions returns options to be communicated with Device\n        // Manager\n    rpc GetDevicePluginOptions(Empty) returns (DevicePluginOptions) {}\n\n    // ListAndWatch returns a stream of List of Devices\n    // Whenever a Device state change or a Device disappears, ListAndWatch\n    // returns the new list\n    rpc ListAndWatch(Empty) returns (stream ListAndWatchResponse) {}\n\n    // Allocate is called during container creation so that the Device\n    // Plugin can run device specific operations and instruct Kubelet\n    // of the steps to make the Device available in the container\n    rpc Allocate(AllocateRequest) returns (AllocateResponse) {}\n\n        // PreStartContainer is called, if indicated by Device Plugin during registeration phase,\n        // before each container start. Device plugin can run device specific operations\n        // such as reseting the device before making devices available to the container\n    rpc PreStartContainer(PreStartContainerRequest) returns (PreStartContainerResponse) {}\n}\n")),(0,r.kt)("h2",{id:"getdevicepluginoptions"},"GetDevicePluginOptions"),(0,r.kt)("p",null,"\u9019\u500b\u529f\u80fd\u6eff\u7c21\u55ae\u7684\uff0c\u5c31\u662f\u56de\u50b3\u4e00\u4e9b\u95dc\u65bc\u672c ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u7684\u4e00\u4e9b\u80fd\u529b\uff0c\u76ee\u524d\u5b9a\u7fa9\u7684\u80fd\u529b\u975e\u5e38\u5c11\uff0c\u53ea\u6709\u4e00\u500b\uff0c\u5c31\u662f\u9700\u4e0d\u9700\u8981\u5bb9\u5668\u555f\u52d5\u524d\u547c\u53eb\u7684\u639b\u52fe\u9ede (pre-start-hook)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"message DevicePluginOptions {\n        // Indicates if PreStartContainer call is required before each container start\n    bool pre_start_required = 1;\n}\n\n")),(0,r.kt)("h2",{id:"listandwatch"},"ListAndWatch"),(0,r.kt)("p",null,"\u8a72\u51fd\u5f0f\u6709\u5169\u500b\u76ee\u7684"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u8b93 ",(0,r.kt)("strong",{parentName:"li"},"kubelet")," \u53bb\u5f97\u77e5\u8a72 devices \u7684\u7279\u6027\u4ee5\u53ca\u767c\u73fe\u5230\u6709\u591a\u5c11\u500b ",(0,r.kt)("strong",{parentName:"li"},"devices")),(0,r.kt)("li",{parentName:"ol"},"\u7531 ",(0,r.kt)("strong",{parentName:"li"},"device plugin")," \u4e3b\u52d5\u901a\u77e5 ",(0,r.kt)("strong",{parentName:"li"},"kubelet")," \u4efb\u4f55\u95dc\u65bc ",(0,r.kt)("strong",{parentName:"li"},"device")," \u72c0\u614b\u7684\u6539\u8b8a")),(0,r.kt)("h2",{id:"alloocate"},"Alloocate"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u518d\u5275\u5efa ",(0,r.kt)("strong",{parentName:"p"},"Pod/Container")," \u524d\u6703\u547c\u53eb\u8a72\u51fd\u5f0f\u4f86\u8655\u7406\u5982\u4f55\u4f7f\u5f97\u8a72 ",(0,r.kt)("strong",{parentName:"p"},"device")," \u53ef\u4ee5\u88ab\u5bb9\u5668\u639b\u8f09\u4f7f\u7528"),(0,r.kt)("p",null,"\u6eff\u8db3\u9019\u500b\u4ecb\u9762\u7684\u61c9\u7528\u7a0b\u5f0f\u53ef\u900f\u904e\u4e0b\u5217\u5176\u4e2d\u4e4b\u4e00\u65b9\u5f0f\u90e8\u7f72\u5230\u7bc0\u9ede\u4e0a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"kubenetes Pod"),(0,r.kt)("li",{parentName:"ol"},"\u5be6\u6a5f\u90e8\u7f72")),(0,r.kt)("p",null,"\u63a5\u8005\u900f\u904e\u8a3b\u518a\u76f8\u95dc\u7684\u51fd\u793a\u4e3b\u52d5\u901a\u77e5 ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u9700\u8981\u8a3b\u518a\u4e00\u500b\u5168\u65b0\u7684 ",(0,r.kt)("strong",{parentName:"p"},"device plugin"),"\uff0c\u5b8c\u6210\u9019\u500b\u6b65\u9a5f\u4e4b\u5f8c\uff0c\u63a5\u4e0b\u4f86 ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u5c31\u6703\u958b\u59cb\u900f\u904e\u4e0a\u8ff0\u7684\u5169\u500b ",(0,r.kt)("strong",{parentName:"p"},"gRPC")," \u4ecb\u9762\u8207\u89e3\u6c7a\u65b9\u6848\u4e92\u52d5"),(0,r.kt)("p",null,"\u6574\u500b\u904e\u7a0b\u53ef\u4ee5\u7528\u4e0b\u5716\u4f86\u89e3\u91cb\n",(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/94xAHmh.png",alt:null}),"\n\u4e0a\u5716\u7bc0\u9304\u81ea",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/device-plugin.md#device-manager-proposal"},"Device Plugin Device Manager Proposal\n")),(0,r.kt)("p",null,"\u9996\u5148\u4e00\u958b\u59cb\uff0c\u7576 ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u5b89\u88dd\u5b8c\u7562\u4e4b\u5f8c\uff0c\u6703\u547c\u53eb ",(0,r.kt)("strong",{parentName:"p"},"Register")," \u9019\u500b\u51fd\u5f0f\uff0c\u800c\u9019\u500b\u51fd\u5f0f\u6700\u91cd\u8981\u7684\u662f\u80cc\u5f8c\u5fc5\u9808\u8981\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"gRPC")," \u7684\u65b9\u5f0f\u8207 ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u6e9d\u901a\uff0c\u5c07\u672c\u89e3\u6c7a\u65b9\u6848\u7684\u76f8\u95dc\u8cc7\u8a0a\u90fd\u544a\u77e5 ",(0,r.kt)("strong",{parentName:"p"},"kubelet"),"\uff0c\u6240\u4ee5\u53ef\u4ee5\u6ce8\u610f\u5230\u9019\u908a\u662f\u55ae\u7dda\u9032\u884c\u3002"),(0,r.kt)("p",null,"\u4e00\u4f46 ",(0,r.kt)("strong",{parentName:"p"},"kubetlet")," \u63a5\u6536\u5230\u8a3b\u518a\u4e4b\u5f8c\uff0c\u63a5\u4e0b\u4f86\u5c31\u6703\u958b\u59cb\u6839\u64da\u9700\u6c42\u9032\u884c ",(0,r.kt)("strong",{parentName:"p"},"ListWatch")," \u4ee5\u53ca ",(0,r.kt)("strong",{parentName:"p"},"Alloacte")," \u5169\u500b\u7684\u547c\u53eb\uff0c\u9019\u908a\u53ef\u4ee5\u7279\u5225\u6ce8\u610f\u5230\u7684\u662f ",(0,r.kt)("strong",{parentName:"p"},"ListWatch")," \u672c\u8eab\u662f\u96d9\u5411\u4e92\u52d5\u7684\uff0c\u610f\u5473\u8005\u5169\u908a\u90fd\u6703\u6839\u64da\u9700\u6c42\u4e92\u76f8\u547c\u53eb\u5c0d\u65b9\u7684\u51fd\u5f0f\u3002\u800c ",(0,r.kt)("strong",{parentName:"p"},"Allocate")," \u5c31\u662f\u55ae\u4e00\u65b9\u5411\u7684\u3002"),(0,r.kt)("p",null,"\u672c\u5716\u7247\u96d6\u7136\u4f86\u81ea\u5b98\u65b9\u6587\u4ef6\uff0c\u4f46\u662f\u53f3\u4e0b\u65b9\u7684 ",(0,r.kt)("strong",{parentName:"p"},"Unload Drivers During Pre-Stop Hook"),"\n\u53ea\u662f\u65e9\u671f\u8a2d\u8a08\u6642\u7684\u767c\u60f3\uff0c\u7562\u7adf\u662f ",(0,r.kt)("strong",{parentName:"p"},"Proposal"),"\uff0c\u5be6\u969b\u4e0a\u9019\u500b\u9ede\u53cd\u800c\u5f88\u96e3\u505a\uff0c\u8b6c\u5982 ",(0,r.kt)("strong",{parentName:"p"},"Container crash")," \u7b97\u4e0d\u7b97 ",(0,r.kt)("strong",{parentName:"p"},"pre-stop"),"?\n\u56e0\u6b64\u4e0d\u5982\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"pre-start")," \u7684\u65b9\u3115\u78ba\u4fdd\u6bcf\u500b ",(0,r.kt)("strong",{parentName:"p"},"container")," \u555f\u52d5\u524d\u90fd\u53ef\u4ee5\u547c\u53eb\u7684\u65b9\u5f0f\u53bb ",(0,r.kt)("strong",{parentName:"p"},"reset")," \u76f8\u95dc\u8cc7\u6e90\u3002"),(0,r.kt)("h2",{id:"prestartcontainer"},"PreStartContainer"),(0,r.kt)("p",null,"\u5982\u679c\u524d\u8ff0\u7684 ",(0,r.kt)("strong",{parentName:"p"},"GetDevicePluginOptions")," \u6709\u63cf\u8ff0\u6709\u9019\u500b\u9700\u6c42\u7684\u8a71\uff0c\u90a3\u9019\u500b\u51fd\u5f0f\u5c31\u6703\u518d\u6709\u4efb\u4f55 ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u8981\u88ab\u5275\u9020\u524d\u88ab\u547c\u53eb\uff0c\u53ef\u4ee5\u7528\u4f86\u9032\u884c\u91cd\u8a2d ",(0,r.kt)("strong",{parentName:"p"},"device")," \u78ba\u4fdd\u4e0b\u500b ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u662f\u7528\u5230\u65b0\u7684\u3002"),(0,r.kt)("h1",{id:"\u8a3b\u518a"},"\u8a3b\u518a"),(0,r.kt)("p",null,"\u70ba\u4e86\u80fd\u5920\u5be6\u73fe\u8a3b\u518a\u529f\u80fd\uff0c ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u4e00\u4f46\u5275\u7acb\u7684\u6642\u5019\u5c31\u5fc5\u9808\u8981\u6709\u80fd\u529b\u8ddf ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u6e9d\u901a\uff0c\u4e26\u4e14\u901a\u904e ",(0,r.kt)("strong",{parentName:"p"},"gRPC")," \u7684\u65b9\u5f0f\u53bb\u547c\u53eb\u8a3b\u518a\u7684\u51fd\u5f0f\u3002"),(0,r.kt)("p",null,"\u800c\u76ee\u524d\u9019\u500b\u65b9\u5f0f\u90fd\u6703\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"unix socket"),"  \u7684\u65b9\u5f0f\u4f86\u6eff\u8db3\uff0c\u6b63\u5de7\u7684\u662f ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u5c31\u6709\u914d\u7f6e\u4e00\u500b\u9580\u7528\u4f86\u6e9d\u901a\u7684 ",(0,r.kt)("strong",{parentName:"p"},"unix socket"),"\uff0c\u9810\u8a2d\u60c5\u6cc1\u4e0b\u90fd\u5728 ",(0,r.kt)("strong",{parentName:"p"},"/var/lib/kubelet/device-plugins/kubelet.sock"),"\u3002\n\u4e5f\u56e0\u70ba\u9019\u500b\u539f\u56e0\uff0c\u4efb\u4f55\u5b89\u88dd ",(0,r.kt)("strong",{parentName:"p"},"device-plugin")," \u7684 ",(0,r.kt)("strong",{parentName:"p"},"yaml")," \u6a94\u6848\u5167\u90fd\u6703\u770b\u5230\u4e0b\u5217\u7684\u8a2d\u5b9a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml="},"...\n        volumeMounts:\n          - name: device-plugin\n            mountPath: /var/lib/kubelet/device-plugins\n      volumes:\n        - name: device-plugin\n          hostPath:\n            path: /var/lib/kubelet/device-plugins\n...\n")),(0,r.kt)("p",null,"\u4e00\u65e6\u9019\u689d\u8def\u901a\u4e0a\u4e4b\u5f8c\uff0c ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u5c31\u9700\u8981\u6e96\u5099\u4e00\u500b\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"RegisterRequest")," \u683c\u5f0f\u7684\u5167\u5bb9\u53bb\u9032\u884c\u8a3b\u518a\uff0c\u800c\u8a72\u683c\u5f0f\u5167\u5305\u542b\u4e86\u5e7e\u500b\u91cd\u8981\u8cc7\u8a0a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"version\n\u7576\u524d\u4f7f\u7528\u7684\u7248\u672c\u57fa\u672c\u4e0a\u53ef\u4ee5\u4f7f\u7528\u51fd\u5f0f\u5eab\u5167\u7684\u8b8a\u6578\u5373\u53ef"),(0,r.kt)("li",{parentName:"ol"},"endpoint\n\u5f8c\u7e8c\u9032\u884c ",(0,r.kt)("strong",{parentName:"li"},"ListAndWatch"),", ",(0,r.kt)("strong",{parentName:"li"},"Allocate")," \u7b49\u76f8\u95dc\u64cd\u4f5c\u4f7f\u7528\u7684 ",(0,r.kt)("strong",{parentName:"li"},"Unix-Socket"),"\u3002"),(0,r.kt)("li",{parentName:"ol"},"resoruce_name\n\u9810\u8a3b\u518a\u7684 ",(0,r.kt)("strong",{parentName:"li"},"device")," \u540d\u7a31\uff0c\u5176\u6709\u898f\u7bc4\uff0c\u901a\u5e38\u662f vendor-name/device-name"),(0,r.kt)("li",{parentName:"ol"},"DevicePluginOptions\n\u7576\u524d\u7684 device plugin \u6709\u54ea\u4e9b\u984d\u5916\u53c3\u6578\u8981\u8a2d\u5b9a\uff0c\u76ee\u524d\u53ea\u6709\u662f\u5426\u9700\u8981 ",(0,r.kt)("strong",{parentName:"li"},"pre-start-hook")," \u7684\u9078\u9805")),(0,r.kt)("p",null,"\u4e00\u65e6\u8a3b\u518a\u6210\u529f\uff0c\u4e4b\u5f8c ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u5c31\u6703\u4f7f\u7528 ",(0,r.kt)("strong",{parentName:"p"},"endpoint")," \u4e2d\u63cf\u8ff0\u7684 ",(0,r.kt)("strong",{parentName:"p"},"UNIX Socket")," \u4f86\u8207 ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u9032\u884c\u6e9d\u901a\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"message RegisterRequest {\n    // Version of the API the Device Plugin was built against\n    string version = 1;\n    // Name of the unix socket the device plugin is listening on\n    // PATH = path.Join(DevicePluginPath, endpoint)\n    string endpoint = 2;\n    // Schedulable resource name. As of now it's expected to be a DNS Label\n    string resource_name = 3;\n        // Options to be communicated with Device Manager\n        DevicePluginOptions options = 4;\n}\n")),(0,r.kt)("p",null,"\u9019\u610f\u5473\u8005\u4e00\u500b\u6709\u6548\u7684 ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u6703\u900f\u904e\u5169\u500b\u4e0d\u540c\u7684 ",(0,r.kt)("strong",{parentName:"p"},"UNIX socket")," \u4f86\u8207 ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u6e9d\u901a\uff0c\u4e00\u500b\u662f\u56fa\u5b9a\u4f4d\u7f6e\uff0c\u5c08\u9580\u7528\u4f86\u8a3b\u518a\u7684\uff0c\u53e6\u5916\u4e00\u500b\u5247\u662f\u6bcf\u500b ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u81ea\u884c\u8a2d\u5b9a\u7684\u4f4d\u7f6e\uff0c\u53ea\u8981 ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u80fd\u5920\u5b58\u53d6\u5373\u53ef\u3002"),(0,r.kt)("h1",{id:"allocate"},"Allocate"),(0,r.kt)("p",null,"\u63a5\u4e0b\u4f86\u63a2\u8a0e\u4e00\u4e0b\u6700\u91cd\u8981\u7684 ",(0,r.kt)("strong",{parentName:"p"},"Allocate")," \u7684\u51fd\u5f0f\uff0c\u4e3b\u8981\u662f\u8981\u5c0d\u9019\u500b\u51fd\u5f0f\u6709\u9ede\u5927\u6982\u7684\u77ad\u89e3\uff0c\u5247\u63a5\u4e0b\u4f86\u53bb\u770b\u4efb\u4f55\u7684 ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u89e3\u6c7a\u65b9\u6848\u90fd\u6703\u66f4\u5bb9\u6613\u7406\u89e3\u5176\u5be6\u4f5c\u908f\u8f2f\u3002"),(0,r.kt)("p",null,"\u9996\u5148\u6211\u5011\u77e5\u9053\uff0c\u4f7f\u7528\u8005\u53ef\u4ee5\u65bc ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u4e2d\u53bb\u8981\u6c42",(0,r.kt)("strong",{parentName:"p"},"\u6574\u6578\u6578\u91cf"),"\u7684 ",(0,r.kt)("strong",{parentName:"p"},"device"),"\uff0c\u7576\u9019\u4e9b\u9700\u6c42\u6700\u5f8c\u88ab ",(0,r.kt)("strong",{parentName:"p"},"kubelet")," \u8f49\u63db\u70ba\u5be6\u969b\u9700\u6c42\u9001\u5230 ",(0,r.kt)("strong",{parentName:"p"},"device plugin gRPC")," \u670d\u52d9\u5668\u6642\uff0c\u5c31\u6703\u8b8a\u6210\u4e00\u500b\u4ee5\u9663\u5217\u578b\u614b\u8868\u793a\u7684 ",(0,r.kt)("strong",{parentName:"p"},"deviceID"),"\u3002"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u672c\u8eab\u4f9d\u64da\u9019\u4e9b\u6d41\u6c34\u865f\u7684 ",(0,r.kt)("strong",{parentName:"p"},"id")," \u53bb\u5206\u914d\u5c0d\u61c9\u7684 ",(0,r.kt)("strong",{parentName:"p"},"device")," \u8cc7\u6e90\uff0c\u800c\u5206\u914d\u7684\u65b9\u5f0f\u8207\u5167\u5bb9\u90fd\u6703\u65bc\u5176\u56de\u50b3\u5c01\u5305 ",(0,r.kt)("strong",{parentName:"p"}," AllocateResponse")," \u4e2d\u8a2d\u5b9a\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"// - Allocate is expected to be called during pod creation since allocation\n//   failures for any container would result in pod startup failure.\n// - Allocate allows kubelet to exposes additional artifacts in a pod's\n//   environment as directed by the plugin.\n// - Allocate allows Device Plugin to run device specific operations on\n//   the Devices requested\nmessage AllocateRequest {\n    repeated ContainerAllocateRequest container_requests = 1;\n}\n\nmessage ContainerAllocateRequest {\n    repeated string devicesIDs = 1;\n}\n")),(0,r.kt)("p",null,"\u5f80\u4e0b\u63a2\u8a0e\u4e4b\u524d\uff0c\u5148\u4f86\u8907\u7fd2\u4e00\u9ede\u6771\u897f\uff0c\u5c31\u662f\u6240\u8b02\u7684 ",(0,r.kt)("strong",{parentName:"p"},"device")," \u5230\u5e95\u8ddf\u5bb9\u5668\u53ef\u4ee5\u600e\u9ebc\u7528?\n\u4ee5 ",(0,r.kt)("strong",{parentName:"p"},"docker")," \u70ba\u7bc4\u4f8b\uff0c\u5e38\u5e38\u4f7f\u7528 ",(0,r.kt)("strong",{parentName:"p"},"volume")," \u6703\u77e5\u9053\u53ef\u4ee5\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"-v")," \u7684\u65b9\u5f0f\u6a19\u660e\u4f86\u6e90\u8207\u76ee\u7684\u7684\u6620\u5c04\u95dc\u4fc2\uff0c\u60f3\u8981\u8907\u96dc\u4e00\u9ede\u7684\u8a2d\u5b9a\u53ef\u4ee5\u63a1\u7528 ",(0,r.kt)("strong",{parentName:"p"},"--mount")," \u4f86\u8655\u7406\u3002\n\u7136\u800c\u5c0d\u65bc ",(0,r.kt)("strong",{parentName:"p"},"device")," \u4f86\u8aaa\uff0c\u4e5f\u6709\u5c0d\u61c9\u7684\u6307\u4ee4\uff0c\u5c31\u662f ",(0,r.kt)("strong",{parentName:"p"},"--device")),(0,r.kt)("p",null,"\u53ef\u4ee5\u53c3\u8003 Docker ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/commandline/run/#add-host-device-to-container---device"},"\u5b98\u7db2\u7bc4\u4f8b")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ docker run --device=/dev/sdc:/dev/xvdc \\\n             --device=/dev/sdd --device=/dev/zero:/dev/nulo \\\n             -i -t \\\n             ubuntu ls -l /dev/{xvdc,sdd,nulo}\n\nbrw-rw---- 1 root disk 8, 2 Feb  9 16:05 /dev/xvdc\nbrw-rw---- 1 root disk 8, 3 Feb  9 16:05 /dev/sdd\ncrw-rw-rw- 1 root root 1, 5 Feb  9 16:05 /dev/nulo\n")),(0,r.kt)("p",null,"\u7531\u4e0a\u8ff0\u53ef\u4ee5\u770b\u5230\u5176\u4f7f\u7528\u65b9\u5f0f\u8207 ",(0,r.kt)("strong",{parentName:"p"},"volume(mount)")," \u76f8\u4f3c\uff0c\u90fd\u662f\u900f\u904e\u8def\u5f91\u7684\u65b9\u5f0f\u4f86\u8655\u7406\u3002\n\u6709\u4e86\u9019\u500b\u6982\u5ff5\uff0c\u63a5\u4e0b\u4f86\u5c31\u53ef\u4ee5\u770b\u4e00\u4e0b ",(0,r.kt)("strong",{parentName:"p"},"Allocate")," \u9019\u500b\u51fd\u5f0f\u7684\u56de\u50b3\u503c ",(0,r.kt)("strong",{parentName:"p"},"AllocateResponse")," \u7684\u683c\u5f0f\u3002"),(0,r.kt)("p",null,"\u9996\u5148 ",(0,r.kt)("strong",{parentName:"p"},"Request")," \u53ef\u4ee5\u8981\u6c42\u591a\u500b ",(0,r.kt)("strong",{parentName:"p"},"device"),"\uff0c\u6240\u4ee5 ",(0,r.kt)("strong",{parentName:"p"},"Response")," \u672c\u8eab\u7684\u56de\u50b3\u4e5f\u6703\u662f\u4e00\u500b\u9663\u5217\uff0c\u800c\u6bcf\u500b\u9663\u5217\u90fd\u662f\u4e00\u500b\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"ContainerAllocateResponse")," \u7684\u683c\u5f0f\u3002"),(0,r.kt)("p",null,"\u8a72\u683c\u5f0f\u4f7f\u7528\u4e86\u56db\u500b\u6b04\u4f4d\u4f86\u8f14\u52a9\uff0c\u5206\u5225\u662f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"envs"),(0,r.kt)("li",{parentName:"ol"},"mounts"),(0,r.kt)("li",{parentName:"ol"},"devices"),(0,r.kt)("li",{parentName:"ol"},"annotations")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"// AllocateResponse includes the artifacts that needs to be injected into\n// a container for accessing 'deviceIDs' that were mentioned as part of\n// 'AllocateRequest'.\n// Failure Handling:\n// if Kubelet sends an allocation request for dev1 and dev2.\n// Allocation on dev1 succeeds but allocation on dev2 fails.\n// The Device plugin should send a ListAndWatch update and fail the\n// Allocation request\nmessage AllocateResponse {\n    repeated ContainerAllocateResponse container_responses = 1;\n}\n\nmessage ContainerAllocateResponse {\n    // List of environment variable to be set in the container to access one of more devices.\n    map<string, string> envs = 1;\n    // Mounts for the container.\n    repeated Mount mounts = 2;\n    // Devices for the container.\n    repeated DeviceSpec devices = 3;\n    // Container annotations to pass to the container runtime\n    map<string, string> annotations = 4;\n}\n\n")),(0,r.kt)("p",null,"\u5176\u4e2d\u6700\u91cd\u8981\u7684\u5c31\u662f ",(0,r.kt)("strong",{parentName:"p"},"mounts")," \u4ee5\u53ca ",(0,r.kt)("strong",{parentName:"p"},"devics"),"\uff0c\u5176\u683c\u5f0f\u5982\u4e0b\uff0c\u53ef\u4ee5\u770b\u5230\u683c\u5f0f\u975e\u5e38\u985e\u4f3c\uff0c\u4e5f\u975e\u5e38\u6e05\u695a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"host_path"),(0,r.kt)("li",{parentName:"ol"},"container_path"),(0,r.kt)("li",{parentName:"ol"},"read_only/permissions")),(0,r.kt)("p",null,"\u5176\u4e2d\u524d\u9762\u5169\u500b\u8cc7\u8a0a\u662f\u4e0d\u662f\u8207\u6211\u5011\u524d\u8ff0\u7684 ",(0,r.kt)("strong",{parentName:"p"},"docekr")," \u7bc4\u4f8b\u975e\u5e38\u76f8\u4f3c\uff1f\n\u900f\u904e\u7528\u8def\u5f91\u7684\u65b9\u5f0f\u53bb\u8868\u9054\u6b32\u639b\u8f09\u5230\u76ee\u6a19\u5bb9\u5668\u5167\u7684 ",(0,r.kt)("strong",{parentName:"p"},"volume")," \u6216\u662f ",(0,r.kt)("strong",{parentName:"p"},"devices")),(0,r.kt)("p",null,"\u6240\u4ee5\u56de\u50b3\u7684\u683c\u5f0f\u53ef\u80fd\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json="},'"devics":[\n            {\n                container_path: "/dev/sda1",\n                host_path: "/dev/sda1",\n                permissoin: "rwm"\n            },\n            {\n                container_path: "/dev/sda2",\n                host_path: "/dev/sda2",\n                permissoin: "rwm"\n            },\n            {\n                container_path: "/dev/sda3",\n                host_path: "/dev/sda3",\n                permissoin: "rwm"\n            },\n    ]\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"// Mount specifies a host volume to mount into a container.\n// where device library or tools are installed on host and container\nmessage Mount {\n    // Path of the mount within the container.\n    string container_path = 1;\n    // Path of the mount on the host.\n    string host_path = 2;\n    // If set, the mount is read-only.\n    bool read_only = 3;\n}\n\n// DeviceSpec specifies a host device to mount into a container.\nmessage DeviceSpec {\n    // Path of the device within the container.\n    string container_path = 1;\n    // Path of the device on the host.\n    string host_path = 2;\n    // Cgroups permissions of the device, candidates are one or more of\n    // * r - allows container to read from the specified device.\n    // * w - allows container to write to the specified device.\n    // * m - allows container to create device files that do not yet exist.\n    string permissions = 3;\n}\n")),(0,r.kt)("p",null,"\u770b\u5230\u9019\u908a\u5c0d\u65bc ",(0,r.kt)("strong",{parentName:"p"},"Allocate")," \u5df2\u7d93\u6709\u4e00\u500b\u57fa\u672c\u7684\u6982\u5ff5\u4e86\uff0c\u5c0d\u65bc ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u7684\u89e3\u6c7a\u65b9\u6848\u4f86\u8aaa\uff0c\u6839\u64da\u9700\u6c42\u53bb\u914d\u7f6e\u9700\u8981\u7684 ",(0,r.kt)("strong",{parentName:"p"},"device"),"\uff0c\u5982\u679c\u6709\u9700\u8981\u4e5f\u53ef\u4ee5\u6e96\u5099\u76f8\u95dc\u7684 ",(0,r.kt)("strong",{parentName:"p"},"volume"),"\uff0c\u6700\u5f8c\u4e00\u8d77\u5c07\u9019\u4e9b\u8def\u5f91\u56de\u50b3\u56de\u53bb\uff0c\u9019\u6a23\u5c0d\u61c9\u7684 ",(0,r.kt)("strong",{parentName:"p"},"Pod")," \u518d\u555f\u52d5\u7684\u6642\u5019\u5c31\u6703\u900f\u904e\u985e\u4f3c ",(0,r.kt)("strong",{parentName:"p"},"docekr --device xxx --mount")," \u7684\u65b9\u5f0f\u628a\u9019\u4e9b\u8cc7\u8a0a\u90fd\u639b\u8f09\u5230\u5bb9\u5668\u5167\u4f7f\u7528\u3002"),(0,r.kt)("h1",{id:"summary"},"Summary"),(0,r.kt)("p",null,"\u672c\u6587\u900f\u904e\u5be6\u969b\u63a2\u7d22 ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u6846\u67b6\u7684\u9762\u8c8c\u4f86\u5b78\u7fd2\u5176\u89e3\u6c7a\u65b9\u6848\u6703\u600e\u9ebc\u8a2d\u8a08\uff0c\u76f8\u5c0d\u65bc ",(0,r.kt)("strong",{parentName:"p"},"CRI/CNI/CSI"),"\uff0c \u6574\u500b ",(0,r.kt)("strong",{parentName:"p"},"device plugin")," \u7684\u5167\u5bb9\u975e\u5e38\u7c21\u55ae\uff0c\u53ea\u6709\u5c11\u5c11\u56db\u500b\u4ecb\u9762\u9700\u8981\u8a2d\u8a08\uff0c\u4e5f\u56e0\u70ba\u5982\u6b64\u7684\u8a2d\u8a08\u80fd\u5920\u8b93\u7b2c\u4e09\u65b9\u89e3\u6c7a\u65b9\u6848\u7684\u4eba\u54e1\uff0c\u5c08\u5fc3\u81f4\u529b\u65bc ",(0,r.kt)("strong",{parentName:"p"},"device")," \u7684\u8655\u7406\u8207\u958b\u767c\uff0c\u5c31\u53ef\u4ee5\u5f88\u9806\u5229\u7684\u929c\u63a5\u5230 ",(0,r.kt)("strong",{parentName:"p"},"kubernetes")," \u53e2\u96c6\u904b\u7b97\u4e2d\u3002"))}m.isMDXComponent=!0}}]);