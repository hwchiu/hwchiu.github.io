"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[72883],{3905:(n,e,t)=>{t.d(e,{Zo:()=>s,kt:()=>g});var r=t(67294);function o(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function a(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function p(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?a(Object(t),!0).forEach((function(e){o(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function l(n,e){if(null==n)return{};var t,r,o=function(n,e){if(null==n)return{};var t,r,o={},a=Object.keys(n);for(r=0;r<a.length;r++)t=a[r],e.indexOf(t)>=0||(o[t]=n[t]);return o}(n,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(n);for(r=0;r<a.length;r++)t=a[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(o[t]=n[t])}return o}var i=r.createContext({}),k=function(n){var e=r.useContext(i),t=e;return n&&(t="function"==typeof n?n(e):p(p({},e),n)),t},s=function(n){var e=k(n.components);return r.createElement(i.Provider,{value:e},n.children)},d="mdxType",c={inlineCode:"code",wrapper:function(n){var e=n.children;return r.createElement(r.Fragment,{},e)}},u=r.forwardRef((function(n,e){var t=n.components,o=n.mdxType,a=n.originalType,i=n.parentName,s=l(n,["components","mdxType","originalType","parentName"]),d=k(t),u=o,g=d["".concat(i,".").concat(u)]||d[u]||c[u]||a;return t?r.createElement(g,p(p({ref:e},s),{},{components:t})):r.createElement(g,p({ref:e},s))}));function g(n,e){var t=arguments,o=e&&e.mdxType;if("string"==typeof n||o){var a=t.length,p=new Array(a);p[0]=u;var l={};for(var i in e)hasOwnProperty.call(e,i)&&(l[i]=e[i]);l.originalType=n,l[d]="string"==typeof n?n:o,p[1]=l;for(var k=2;k<a;k++)p[k]=t[k];return r.createElement.apply(null,p)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},44486:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>i,contentTitle:()=>p,default:()=>c,frontMatter:()=>a,metadata:()=>l,toc:()=>k});var r=t(87462),o=(t(67294),t(3905));const a={title:"Kubernetes - IP \u91cd\u8907\u5947\u9047\u8a18",keywords:["kubernetes","ip conflict"],tags:["CNI","Kubernetes","Network","Rancher"],description:"\u672c\u6587\u63a2\u8a0e\u4e00\u7a2e\u5099\u4efd\u5fa9\u539f\u904e\u7a0b\u4e2d\u53ef\u80fd\u6703\u767c\u751f\u7684 IP \u91cd\u8907\u554f\u984c\uff0c\u6587\u7ae0\u958b\u982d\u5148\u7528\u7c21\u55ae\u7684\u6a21\u64ec\u65b9\u5f0f\u4f86\u6a21\u64ec\u5982\u4f55\u7522\u751f IP \u91cd\u8907\u554f\u984c\uff0c\u63a5\u4e0b\u4f86\u91dd\u5c0d CNI \u7684\u904b\u4f5c\u4f86\u63a2\u8a0e\u5176\u904b\u4f5c\u6d41\u7a0b\u3002",date:new Date("2020-11-26T23:15:00.000Z")},p=void 0,l={unversionedId:"techPost/2020/kubernetes-duplicate-pod-ip",id:"techPost/2020/kubernetes-duplicate-pod-ip",title:"Kubernetes - IP \u91cd\u8907\u5947\u9047\u8a18",description:"\u672c\u6587\u63a2\u8a0e\u4e00\u7a2e\u5099\u4efd\u5fa9\u539f\u904e\u7a0b\u4e2d\u53ef\u80fd\u6703\u767c\u751f\u7684 IP \u91cd\u8907\u554f\u984c\uff0c\u6587\u7ae0\u958b\u982d\u5148\u7528\u7c21\u55ae\u7684\u6a21\u64ec\u65b9\u5f0f\u4f86\u6a21\u64ec\u5982\u4f55\u7522\u751f IP \u91cd\u8907\u554f\u984c\uff0c\u63a5\u4e0b\u4f86\u91dd\u5c0d CNI \u7684\u904b\u4f5c\u4f86\u63a2\u8a0e\u5176\u904b\u4f5c\u6d41\u7a0b\u3002",source:"@site/docs/techPost/2020/kubernetes-duplicate-pod-ip.md",sourceDirName:"techPost/2020",slug:"/techPost/2020/kubernetes-duplicate-pod-ip",permalink:"/docs/techPost/2020/kubernetes-duplicate-pod-ip",draft:!1,tags:[{label:"CNI",permalink:"/docs/tags/cni"},{label:"Kubernetes",permalink:"/docs/tags/kubernetes"},{label:"Network",permalink:"/docs/tags/network"},{label:"Rancher",permalink:"/docs/tags/rancher"}],version:"current",frontMatter:{title:"Kubernetes - IP \u91cd\u8907\u5947\u9047\u8a18",keywords:["kubernetes","ip conflict"],tags:["CNI","Kubernetes","Network","Rancher"],description:"\u672c\u6587\u63a2\u8a0e\u4e00\u7a2e\u5099\u4efd\u5fa9\u539f\u904e\u7a0b\u4e2d\u53ef\u80fd\u6703\u767c\u751f\u7684 IP \u91cd\u8907\u554f\u984c\uff0c\u6587\u7ae0\u958b\u982d\u5148\u7528\u7c21\u55ae\u7684\u6a21\u64ec\u65b9\u5f0f\u4f86\u6a21\u64ec\u5982\u4f55\u7522\u751f IP \u91cd\u8907\u554f\u984c\uff0c\u63a5\u4e0b\u4f86\u91dd\u5c0d CNI \u7684\u904b\u4f5c\u4f86\u63a2\u8a0e\u5176\u904b\u4f5c\u6d41\u7a0b\u3002",date:"2020-11-26T23:15:00.000Z"},sidebar:"techPost",previous:{title:"IPvS \u5b78\u7fd2\u624b\u518a(\u56db)",permalink:"/docs/techPost/2020/ipvs-4"},next:{title:"[Kubernetes] Static Pod \u4ecb\u7d39",permalink:"/docs/techPost/2020/kubernetes-static-pod"}},i={},k=[{value:"\u90e8\u7f72 Pods",id:"\u90e8\u7f72-pods",level:2},{value:"\u505c\u6b62\u7bc0\u9ede\u4e0a\u7684 kubelet \u4e26\u522a\u9664\u7bc0\u9ede\u4e0a\u7279\u5b9a\u8cc7\u6599\u593e",id:"\u505c\u6b62\u7bc0\u9ede\u4e0a\u7684-kubelet-\u4e26\u522a\u9664\u7bc0\u9ede\u4e0a\u7279\u5b9a\u8cc7\u6599\u593e",level:2},{value:"\u91cd\u555f\u7bc0\u9ede\u4e0a\u7684 kubelet \u4e26\u90e8\u7f72\u66f4\u591a pod \u5230\u8a72\u7bc0\u9ede\u4e0a",id:"\u91cd\u555f\u7bc0\u9ede\u4e0a\u7684-kubelet-\u4e26\u90e8\u7f72\u66f4\u591a-pod-\u5230\u8a72\u7bc0\u9ede\u4e0a",level:2},{value:"\u518d\u770b\u4e00\u6b21",id:"\u518d\u770b\u4e00\u6b21",level:2}],s={toc:k},d="wrapper";function c(n){let{components:e,...t}=n;return(0,o.kt)(d,(0,r.Z)({},s,t,{components:e,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"\u6700\u8fd1\u9047\u5230\u4e00\u500b\u6709\u8da3\u7684\u6848\u4f8b\uff0c\u8a72\u6848\u4f8b\u4e2d\uff0c\u65b0\u7522\u751f\u7684 Pod \u7372\u5f97\u7684 IP \u5730\u5740\u6703\u8ddf\u5df2\u7d93\u5b58\u5728\u7684 Pod \u76f8\u540c\u3002\n\u6700\u5f8c\u5c31\u6703\u770b\u5230\u53e2\u96c6\u4e2d\u6709\u5169\u500b Pod \u64c1\u6709\u76f8\u540c\u7684 IP \u5730\u5740\uff0c\u9032\u800c\u5c0e\u81f4\u885d\u7a81\u7136\u5f8c\u670d\u52d9\u4e0d\u80fd\u6b63\u5e38\u5b58\u53d6"),(0,o.kt)("p",null,"\u9019\u500b\u60c5\u6cc1\u4e26\u4e0d\u5e38\u898b\uff0c\u4f46\u662f\u4e00\u65e6\u767c\u751f\u6642\uff0c\u4e26\u4e0d\u662f\u5f88\u5bb9\u6613\u53ef\u4ee5\u91d0\u6e05\u9019\u500b\u554f\u984c\uff0c\u56e0\u70ba Kubernetes \u672c\u8eab\u4e26\u4e0d\u8ca0\u8cac\u9019\u4e9b IP \u7684\u767c\u653e\uff0c\u800c\u662f\u900f\u904e CNI \u4f86\u8655\u7406\uff0c\u800c Kubelet \u5247\u662f CNI \u8207 Kubernetes \u4e2d\u9593\u7684\u6e9d\u901a\u8005\u3002"),(0,o.kt)("p",null,"\u672c\u7bc7\u6587\u7ae0\u6703\u5617\u8a66\u6a21\u64ec\u4e00\u500b\u74b0\u5883\u4f86\u63a2\u8a0e\u9019\u500b\u554f\u984c\uff0c\u4e26\u4e14\u91d0\u6e05\u554f\u984c\u7684\u672c\u8cea\uff0c\u7576\u4e00\u5207\u8b0e\u5718\u90fd\u660e\u77ad\u4e4b\u6642\uff0c\u6211\u5011\u518d\u4f86\u770b\u770b\u771f\u5be6\u60c5\u6cc1\u4e0b\uff0c\u6709\u4ec0\u9ebc\u8e29\u5230\u9019\u500b\u554f\u984c\u7684\u53ef\u80fd\u6027"),(0,o.kt)("h1",{id:"\u6a21\u64ec\u74b0\u5883"},"\u6a21\u64ec\u74b0\u5883"),(0,o.kt)("p",null,"\u672c\u74b0\u5883\u6703\u63a1\u7528 ",(0,o.kt)("a",{parentName:"p",href:"https://kind.sigs.k8s.io/"},"KIND")," \u642d\u5efa\u4e00\u500b\u591a\u7bc0\u9ede\u7684 Kubernetes \u53e2\u96c6\uff0c\u4f7f\u7528\u7684\u7248\u672c\u8207\u76f8\u95dc\u8a2d\u5b9a\u6a94\u6848\u5982\u4e0b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'\u2192 kind --version\nkind version 0.9.0\n\n\u2192 cat kind.yaml\nkind: Cluster\napiVersion: kind.x-k8s.io/v1alpha4\nnodes:\n- role: control-plane\n  image: kindest/node:v1.18.8@sha256:f4bcc97a0ad6e7abaf3f643d890add7efe6ee4ab90baeb374b4f41a4c95567eb\n- role: worker\n  image: kindest/node:v1.18.8@sha256:f4bcc97a0ad6e7abaf3f643d890add7efe6ee4ab90baeb374b4f41a4c95567eb\n- role: worker\n  image: kindest/node:v1.18.8@sha256:f4bcc97a0ad6e7abaf3f643d890add7efe6ee4ab90baeb374b4f41a4c95567eb\n- role: worker\n  image: kindest/node:v1.18.8@sha256:f4bcc97a0ad6e7abaf3f643d890add7efe6ee4ab90baeb374b4f41a4c95567eb\n\n\u2192 kubectl version\nClient Version: version.Info{Major:"1", Minor:"19", GitVersion:"v1.19.4", GitCommit:"d360454c9bcd1634cf4cc52d1867af5491dc9c5f", GitTreeState:"clean", BuildDate:"2020-11-11T13:17:17Z", GoVersion:"go1.15.2", Compiler:"gc", Platform:"linux/amd64"}\nServer Version: version.Info{Major:"1", Minor:"18", GitVersion:"v1.18.8", GitCommit:"9f2892aab98fe339f3bd70e3c470144299398ace", GitTreeState:"clean", BuildDate:"2020-09-14T07:44:34Z", GoVersion:"go1.13.15", Compiler:"gc", Platform:"linux/amd64"}\n\n\u2192 kubectl get nodes\nNAME                 STATUS   ROLES    AGE   VERSION\nkind-control-plane   Ready    master   18m   v1.18.8\nkind-worker          Ready    <none>   17m   v1.18.8\nkind-worker2         Ready    <none>   17m   v1.18.8\nkind-worker3         Ready    <none>   17m   v1.18.8\n\n')),(0,o.kt)("p",null,"\u6211\u5011\u6703\u900f\u904e\u4e00\u500b deployment \u4f86\u6a21\u64ec\u5927\u91cf\u7684 pod\uff0c\u8a72\u5167\u5bb9\u5982\u4e0b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash="},"\u2192 cat debug.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: debug-pod\nspec:\n  replicas: 30\n  selector:\n    matchLabels:\n      app: debug-pod\n  template:\n    metadata:\n      labels:\n        app: debug-pod\n    spec:\n      containers:\n        - name: debug-pod\n          image: hwchiu/netutils:latest\n")),(0,o.kt)("h1",{id:"\u6a21\u64ec\u6b65\u9a5f"},"\u6a21\u64ec\u6b65\u9a5f"),(0,o.kt)("p",null,"\u8981\u6a21\u64ec\u9019\u500b\u554f\u984c\u4e0d\u6703\u592a\u56f0\u96e3\uff0c\u5206\u6210\u5e7e\u500b\u6b65\u9a5f"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u90e8\u7f72 pods"),(0,o.kt)("li",{parentName:"ol"},"\u505c\u6b62\u7bc0\u9ede\u4e0a\u7684 kubelet \u4e26\u522a\u9664\u7bc0\u9ede\u4e0a\u7279\u5b9a\u8cc7\u6599\u593e"),(0,o.kt)("li",{parentName:"ol"},"\u91cd\u555f\u7bc0\u9ede\u4e0a\u7684 kubelet \u4e26\u90e8\u7f72\u66f4\u591a pod \u5230\u8a72\u7bc0\u9ede\u4e0a")),(0,o.kt)("p",null,"\u63a5\u4e0b\u4f86\u6211\u5011\u5c31\u91dd\u5c0d\u4e0a\u8ff0\u6b65\u9a5f\u4f86\u64cd\u4f5c\uff0c\u4e26\u4e14\u4ee5\u7bc0\u9ede ",(0,o.kt)("inlineCode",{parentName:"p"},"kind-worker3")," \u4f5c\u70ba\u554f\u984c\u767c\u751f\u7684\u7bc0\u9ede"),(0,o.kt)("h2",{id:"\u90e8\u7f72-pods"},"\u90e8\u7f72 Pods"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash="},"\u2192 kubectl apply -f debug.yaml\ndeployment.apps/debug-pod created\n")),(0,o.kt)("p",null,"\u9019\u908a\u6211\u5011\u5c08\u6ce8\u89c0\u5bdf kind-worker3 \u4e0a\u9762\u6240\u6709 Pod \u7684 IP \u5373\u53ef"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash="}," \u2192 kubectl get pods -o wide | grep kind-worker3\ndebug-pod-7f9c756577-6nv7b   1/1     Running   0          3m38s   10.244.2.6    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-9l766   1/1     Running   0          3m38s   10.244.2.8    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-bg89r   1/1     Running   0          3m39s   10.244.2.9    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-hb2cr   1/1     Running   0          3m38s   10.244.2.7    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-kzkjr   1/1     Running   0          3m39s   10.244.2.3    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-ncqg8   1/1     Running   0          3m38s   10.244.2.5    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-pwk9v   1/1     Running   0          3m39s   10.244.2.2    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-twwpn   1/1     Running   0          3m39s   10.244.2.4    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-z7kmq   1/1     Running   0          3m39s   10.244.2.11   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-zgs7k   1/1     Running   0          3m38s   10.244.2.10   kind-worker3   <none>           <none>\n")),(0,o.kt)("p",null,"\u76ee\u524d\u4e0a\u9762\u7e3d\u5171\u6709 10 \u500b pod\uff0c\u6240\u6709 IP \u90fd\u4e0d\u4e00\u6a23\uff0c\u975e\u5e38\u6b63\u5e38"),(0,o.kt)("h2",{id:"\u505c\u6b62\u7bc0\u9ede\u4e0a\u7684-kubelet-\u4e26\u522a\u9664\u7bc0\u9ede\u4e0a\u7279\u5b9a\u8cc7\u6599\u593e"},"\u505c\u6b62\u7bc0\u9ede\u4e0a\u7684 kubelet \u4e26\u522a\u9664\u7bc0\u9ede\u4e0a\u7279\u5b9a\u8cc7\u6599\u593e"),(0,o.kt)("p",null,"\u5982\u540c\u524d\u9762\u6240\u8ff0\uff0c\u6211\u5011\u91dd\u5c0d kind-worker3 \u9032\u884c\u6a21\u64ec\uff0c\u56e0\u6b64\u57f7\u884c\u4e0b\u5217\u6307\u4ee4\u4f86\u505c\u6b62 ",(0,o.kt)("inlineCode",{parentName:"p"},"kubelet"),"\uff0c"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash="},"\u25cb \u2192 sudo docker exec kind-worker3 systemctl stop kubelet\n\u25cb \u2192 sudo docker exec kind-worker3 systemctl status kubelet\n\u25cf kubelet.service - kubelet: The Kubernetes Node Agent\n     Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: enabled)\n...\n")),(0,o.kt)("p",null,"\u78ba\u8a8d\u505c\u6b62\u5f8c\uff0c\u63a5\u8005\u522a\u9664\u76f8\u95dc\u8cc7\u6599\u593e"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash="},"sudo docker exec kind-worker3 rm -rf /run/cni-ipam-state\n")),(0,o.kt)("h2",{id:"\u91cd\u555f\u7bc0\u9ede\u4e0a\u7684-kubelet-\u4e26\u90e8\u7f72\u66f4\u591a-pod-\u5230\u8a72\u7bc0\u9ede\u4e0a"},"\u91cd\u555f\u7bc0\u9ede\u4e0a\u7684 kubelet \u4e26\u90e8\u7f72\u66f4\u591a pod \u5230\u8a72\u7bc0\u9ede\u4e0a"),(0,o.kt)("p",null,"\u4e0a\u8ff0\u90fd\u5b8c\u6210\u5f8c\uff0c\u6211\u5011\u91cd\u555f kubelet"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash="},"\n\u25cb \u2192 sudo docker exec kind-worker3 systemctl start kubelet\n\u25cb \u2192 sudo docker exec kind-worker3 systemctl status kubelet\n\u25cf kubelet.service - kubelet: The Kubernetes Node Agent\n     Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: enabled)\n    Drop-In: /etc/systemd/system/kubelet.service.d\n             \u2514\u250010-kubeadm.conf\n     Active: active (running) (thawing) since Fri 2020-11-27 04:04:28 UTC; 3s ago\n       Docs: http://kubernetes.io/docs/\n")),(0,o.kt)("p",null,"\u63a5\u4e0b\u4f86\u6211\u5011\u8981\u90e8\u7f72\u65b0\u7684 pod \u5230 ",(0,o.kt)("inlineCode",{parentName:"p"},"kind-worker3")," \u8eab\u4e0a\uff0c\u9019\u908a\u6211\u63a1\u53d6\u7684\u65b9\u5f0f\u662f\u900f\u904e ",(0,o.kt)("strong",{parentName:"p"},"drain")," \u7684\u6982\u5ff5\uff0c\u5c07 ",(0,o.kt)("strong",{parentName:"p"},"kind-worker")," \u4ee5\u53ca ",(0,o.kt)("strong",{parentName:"p"},"kind-worker2")," \u4e0a\u9762\u7684 pod \u90fd\u79fb\u9664\u6389\uff0c\u7136\u5f8c\u91cd\u65b0\u90e8\u7f72\u5230 ",(0,o.kt)("strong",{parentName:"p"},"kind-worker3")," \u4e0a\uff0c\u4e26\u4e14\u89c0\u5bdf\u9019\u4e9b IP"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash="},"\u25cb \u2192 kubectl drain kind-worker --ignore-daemonsets\n\u25cb \u2192 kubectl drain kind-worker2 --ignore-daemonsets\n")),(0,o.kt)("p",null,"\u63a5\u8005\u900f\u904e\u76f8\u540c\u6307\u4ee4\u89c0\u5bdf kind-worker3 \u4e0a\u9762\u7684\u6240\u6709 pod IP"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash="},"\u2192 kubectl get pods -o wide | grep kind-worker3 | sort -k 6\ndebug-pod-7f9c756577-hkhx9   1/1     Running   0          54s   10.244.2.10   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-zgs7k   1/1     Running   0          11m   10.244.2.10   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-qmjqk   1/1     Running   0          54s   10.244.2.11   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-z7kmq   1/1     Running   0          11m   10.244.2.11   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-pd6hl   1/1     Running   0          54s   10.244.2.12   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-ssmsv   1/1     Running   0          54s   10.244.2.13   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-bbx6j   1/1     Running   0          54s   10.244.2.14   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-9rn4j   1/1     Running   0          54s   10.244.2.15   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-sfwhs   1/1     Running   0          54s   10.244.2.16   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-jc8nw   1/1     Running   0          54s   10.244.2.17   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-5sb28   1/1     Running   0          54s   10.244.2.18   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-mgtzx   1/1     Running   0          54s   10.244.2.19   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-64xlq   1/1     Running   0          53s   10.244.2.20   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-jpmfk   1/1     Running   0          53s   10.244.2.21   kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-pwk9v   1/1     Running   0          11m   10.244.2.2    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-rhfk4   1/1     Running   0          71s   10.244.2.2    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-kzkjr   1/1     Running   0          11m   10.244.2.3    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-njmw6   1/1     Running   0          71s   10.244.2.3    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-l9fl8   1/1     Running   0          71s   10.244.2.4    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-twwpn   1/1     Running   0          11m   10.244.2.4    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-ncqg8   1/1     Running   0          11m   10.244.2.5    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-rshx5   1/1     Running   0          71s   10.244.2.5    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-6nv7b   1/1     Running   0          11m   10.244.2.6    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-vklgs   1/1     Running   0          71s   10.244.2.6    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-hb2cr   1/1     Running   0          11m   10.244.2.7    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-jkpbd   1/1     Running   0          54s   10.244.2.7    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-9l766   1/1     Running   0          11m   10.244.2.8    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-lr8t5   1/1     Running   0          54s   10.244.2.8    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-bg89r   1/1     Running   0          11m   10.244.2.9    kind-worker3   <none>           <none>\ndebug-pod-7f9c756577-wx4s6   1/1     Running   0          54s   10.244.2.9    kind-worker3   <none>           <none>\n")),(0,o.kt)("p",null,"\u91cd\u4e0a\u8ff0\u7684\u7d50\u679c\u53ef\u4ee5\u89c0\u5bdf\u5230 ",(0,o.kt)("strong",{parentName:"p"},"10.244.2.11")," \u4ee5\u53ca\u66f4\u4ee5\u524d\u7684(.2~.10) \u5730\u5740\u5168\u90e8\u90fd\u91cd\u8907\u4e86\u3002\n\u5230\u9019\u908a\u70ba\u6b62\uff0c\u6211\u5011\u900f\u904e\u4e00\u500b\u5947\u602a\u7684\u64cd\u4f5c\u6d41\u7a0b\u4f86\u88fd\u9020\u4e86 ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u91cd\u8907\u7684\u73fe\u8c61\uff0c\u4f46\u662f\u76ee\u524d\u9084\u6709\u5169\u500b\u554f\u984c"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u70ba\u4ec0\u9ebc\u9019\u500b\u904e\u7a0b\u6703\u5c0e\u81f4 IP \u91cd\u8907?"),(0,o.kt)("li",{parentName:"ol"},"\u9019\u500b\u904e\u7a0b\u770b\u8d77\u4f86\u5f88\u5999\uff0c\u4ec0\u9ebc\u6a23\u7684\u5be6\u969b\u60c5\u6cc1\u6703\u767c\u751f?")),(0,o.kt)("h1",{id:"\u63a2\u7a76\u554f\u984c"},"\u63a2\u7a76\u554f\u984c"),(0,o.kt)("p",null,"\u5f9e\u9019\u908a\u958b\u59cb\uff0c\u6211\u5011\u5c31\u8a8d\u771f\u5730\u53bb\u63a2\u8a0e\u9019\u500b\u554f\u984c\u7684\u672c\u8cea\uff0c\u4e00\u65e6\u7406\u89e3\u6574\u500b kubernetes \u904b\u4f5c\u6d41\u7a0b\u5f8c\uff0c\u9762\u5c0d\u9019\u500b\u554f\u984c\u5c31\u6703\u975e\u5e38\u6709\u60f3\u6cd5\u77e5\u9053\u8a72\u5f9e\u4f55\u4e0b\u624b\uff0c\u4ee5\u53ca\u53ef\u4ee5\u5f88\u5feb\u7684\u7e2e\u5c0f\u554f\u984c\u7684\u767c\u751f\u9ede"),(0,o.kt)("p",null,"\u554f\u984c\u958b\u59cb\u524d\uff0c\u6211\u5011\u8981\u5148\u6709\u4e00\u500b\u57fa\u672c\u7684\u6982\u5ff5\uff0c\u5230\u5e95 ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u5730\u5740\u662f\u600e\u9ebc\u4f86\u7684\uff1f"),(0,o.kt)("p",null,"\u5be6\u969b\u4e0a Kubernetes \u672c\u8eab\u4e26\u4e0d\u6703\u53bb\u5e6b\u5fd9\u5206\u914d\u9019\u4e9b ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u5730\u5740\uff0c\u552f\u4e8c\u6703\u505a\u5c31\u5169\u4ef6\u4e8b\u60c5"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Controller \u6703\u6839\u64da\u53c3\u6578\u8a2d\u5b9a Node \u4e0a\u7684 NodeCIDR \u7b49\u6578\u503c(\u672c\u6587\u4e0d\u8ac7)"),(0,o.kt)("li",{parentName:"ol"},"Kubelet \u5275\u5efa Pod \u6642\uff0c\u6700\u5f8c\u6703\u547c\u53eb\u8d77 CNI \u4f86\u5e6b\u5fd9\u8655\u7406")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Container Network Interface(CNI)")," \u9019\u908a\u4e0d\u8ac7\u592a\u591a\uff0c\u60f3\u8981\u77ad\u89e3\u66f4\u591a\u53ef\u4ee5\u95b1\u8b80\u6211\u4e4b\u524d\u95dc\u65bc CNI \u7684",(0,o.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/cni.html"},"\u4ecb\u7d39\u6587")),(0,o.kt)("p",null,"\u63a5\u4e0b\u4f86\u6211\u5011\u7528\u5716\u8868\u770b\u4e00\u4e0b CNI \u7684\u904b\u4f5c\u6d41\u7a0b(\u5927\u6982\u6d41\u7a0b\uff0c\u5be6\u969b\u4e0a\u5e95\u5c64\u7684\u547c\u53eb\u6709\u4e00\u9ede\u9ede\u4e0d\u4e00\u6a23)"),(0,o.kt)("p",null,"\u4e00\u958b\u59cb\uff0c ",(0,o.kt)("strong",{parentName:"p"},"kubelet")," \u6703\u5275\u9020\u4e00\u500b Pod \u7684\u6c99\u76d2\uff0c\u9019\u6642\u5019\u8a72 Pod \u9084\u6c92\u6709\u4efb\u4f55 IP \u5730\u5740\n",(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/sBiUu0E.jpg",alt:null})),(0,o.kt)("p",null,"CNI \u672c\u8eab\u6703\u8981\u8ca0\u8cac\u7d66\u4e88 Pod \u5c0d\u61c9\u7684\u7db2\u8def\u80fd\u529b\uff0c\u9019\u908a\u4e5f\u5305\u542b IP \u7684\u5206\u914d\uff0c\u9810\u8a2d\u60c5\u6cc1\u4e0b CNI \u7684\u8a2d\u5b9a\u6a94\u6848\u6703\u653e\u5728 /etc/cni/net.d\u3002"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"kubelet")," \u6703\u53bb\u8b80\u53d6 ",(0,o.kt)("strong",{parentName:"p"},"/etc/cni/net.d")," \u4f86\u5224\u65b7\u7576\u524d\u7cfb\u7d71\u4f7f\u7528\u7684 CNI \u662f\u8ab0\n",(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/Sgc0odM.jpg",alt:null})),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash="},'\u2192 docker exec kind-worker3 cat /etc/cni/net.d/10-kindnet.conflist\n\n{\n        "cniVersion": "0.3.1",\n        "name": "kindnet",\n        "plugins": [\n        {\n                "type": "ptp",\n                "ipMasq": false,\n                "ipam": {\n                        "type": "host-local",\n                        "dataDir": "/run/cni-ipam-state",\n                        "routes": [\n                                {\n                                        "dst": "0.0.0.0/0"\n                                }\n                        ],\n                        "ranges": [\n                        [\n                                {\n                                        "subnet": "10.244.2.0/24"\n                                }\n                        ]\n                ]\n                }\n                ,\n                "mtu": 1500\n\n        },\n        {\n                "type": "portmap",\n                "capabilities": {\n                        "portMappings": true\n                }\n        }\n        ]\n}\n')),(0,o.kt)("p",null,"\u4e0a\u9762\u7bc4\u4f8b\u662f ",(0,o.kt)("strong",{parentName:"p"},"kind")," \u88e1\u9762\u7684 CNI \u7684\u8a2d\u5b9a\u6a94\u6848\uff0c\u6211\u5011\u6ce8\u610f ",(0,o.kt)("strong",{parentName:"p"},"IPAM")," \u6b04\u4f4d\uff0c\u4ed6\u4f7f\u7528\u7684\u662f ",(0,o.kt)("strong",{parentName:"p"},"host-local")," \u9019\u500b\u670d\u52d9\uff0c\u4e26\u4e14\u5c07\u8cc7\u6599\u653e\u5230 ",(0,o.kt)("strong",{parentName:"p"},"/run/cni-ipam-state"),"\u3002"),(0,o.kt)("p",null,"\u6240\u4ee5 ",(0,o.kt)("strong",{parentName:"p"},"kubelet")," \u5c31\u6703\u6839\u64da\u627e\u5230\u7684\u7d50\u679c\uff0c\u53eb\u8d77 ",(0,o.kt)("strong",{parentName:"p"},"kind-net")," \u9019\u5957 CNI \u4f86\u5e6b\u5fd9\u8655\u7406\uff0c\u800c ",(0,o.kt)("strong",{parentName:"p"},"kind-net")," \u627e\u4e0a ",(0,o.kt)("strong",{parentName:"p"},"host-local")," \u4f86\u5e6b\u5fd9\u8655\u7406 IP \u5206\u914d\u554f\u984c\n",(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/zTyuUPX.jpg",alt:null})),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"host-local")," \u6703\u4f7f\u7528\u672c\u5730\u6a94\u6848 ",(0,o.kt)("strong",{parentName:"p"},"/run/cni-ipam-state/kindnet")," \u4f5c\u70ba\u672c\u5730\u8cc7\u6599\u5eab\uff0c\u7d00\u9304\u54ea\u4e9b IP \u5df2\u7d93\u4f7f\u7528\u904e\u3002\u6700\u5f8c\u6839\u64da\u641c\u5c0b\u5f9e\u88e1\u9762\u7d50\u679c\u6311\u51fa\u4e00\u500b\u9084\u6c92\u6709\u88ab\u7528\u904e\u7684 ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u5730\u5740\uff0c\u4e26\u4e14\u628a\u8a72\u7d50\u679c\u9001\u56de\u7d66 ",(0,o.kt)("strong",{parentName:"p"},"kind-net")," CNI\n",(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/daK2V1U.jpg",alt:null})),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash="},"\u25cb \u2192 docker exec kind-worker3 ls /run/cni-ipam-state/kindnet\n10.244.2.10\n10.244.2.11\n10.244.2.12\n10.244.2.13\n10.244.2.14\n10.244.2.15\n10.244.2.16\n10.244.2.17\n10.244.2.18\n10.244.2.19\n10.244.2.2\n10.244.2.20\n10.244.2.21\n10.244.2.3\n10.244.2.4\n10.244.2.5\n10.244.2.6\n10.244.2.7\n10.244.2.8\n10.244.2.9\nlast_reserved_ip.0\nlock\n")),(0,o.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\u9019\u908a\u6703\u8a18\u9304\u7576\u524d\u4f7f\u7528\u7684\u6240\u6709 ",(0,o.kt)("strong",{parentName:"p"},"CNI")," \u72c0\u614b\uff0c\u9019\u908a\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f\uff0c\u4e0d\u662f\u6bcf\u500b ",(0,o.kt)("strong",{parentName:"p"},"CNI/IPAM")," \u90fd\u662f\u8d70 ",(0,o.kt)("strong",{parentName:"p"},"host-local")," \u9019\u7a2e\u65b9\u5f0f\u3002 ",(0,o.kt)("strong",{parentName:"p"},"host-local")," \u5982\u5176\u540d\u7a31\u4e00\u6a23\uff0c\u5c31\u662f\u6bcf\u500b\u7bc0\u9ede\u7368\u7acb\u81ea\u884c\u8655\u7406\uff0c\u800c\u80cc\u5f8c\u5c31\u662f\u4f9d\u8cf4\u4e00\u500b\u8cc7\u6599\u593e\u642d\u914d\u773e\u591a\u6a94\u6848\u4f86\u8a18\u4f4f\u7576\u524d\u5230\u5e95\u5206\u914d\u54ea\u4e9b ",(0,o.kt)("strong",{parentName:"p"},"IP \u5730\u5740")),(0,o.kt)("p",null,"\u4e00\u5207\u5b8c\u7562\u4e4b\u5f8c\uff0c",(0,o.kt)("strong",{parentName:"p"},"kind-net")," \u5c31\u6703\u628a\u76f8\u95dc\u7684 ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u7d66\u8a2d\u5b9a\u5230 ",(0,o.kt)("strong",{parentName:"p"},"Pod")," \u4e0a\u9762\u3002\n",(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/9qkqNyQ.jpg",alt:null})),(0,o.kt)("h2",{id:"\u518d\u770b\u4e00\u6b21"},"\u518d\u770b\u4e00\u6b21"),(0,o.kt)("p",null,"\u6240\u4ee5\u56de\u5230\u524d\u9762\u7684\u6a21\u64ec\u74b0\u5883\uff0c\u73fe\u5728\u8981\u7406\u89e3\u6574\u500b\u554f\u984c\u6d41\u7a0b\u5c31\u975e\u5e38\u6e05\u695a\u660e\u77ad\u4e86\u3002\n\u4e00\u958b\u59cb\uff0c\u6211\u5011\u90e8\u7f72\u5927\u91cf\u7684 Pod \u5230 kind-worker3 \u4e0a\u9762\uff0c ",(0,o.kt)("strong",{parentName:"p"},"host-local")," \u958b\u59cb\u91dd\u5c0d\u6bcf\u500b\u5206\u914d\u7684 ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u53bb\u5beb\u6a94\u6848\uff0c\u4e26\u4e14\u8a18\u9304\u5230  ",(0,o.kt)("strong",{parentName:"p"},"/run/cni-ipam-state/kindnet"),"\u3002"),(0,o.kt)("p",null,"\u63a5\u8005\u6211\u5011\u505c\u6389 kubelet\uff0c\u8b93 CNI \u66ab\u6642\u4e0d\u6703\u88ab\u547c\u53eb\uff0c\u7136\u5f8c\u628a\u7dad\u8b77 ",(0,o.kt)("strong",{parentName:"p"},"host-local")," \u7684\u6240\u6709\u72c0\u614b\u90fd\u79fb\u9664\u4e86\u3002"),(0,o.kt)("p",null,"\u5230\u9019\u500b\u968e\u6bb5\uff0c\u5176\u5be6\u7cfb\u7d71\u5df2\u7d93\u51fa\u73fe\u4e86\u72c0\u614b\u4e0d\u4e00\u81f4\u7684\u73fe\u8c61\uff0c ",(0,o.kt)("strong",{parentName:"p"},"CNI")," \u7528\u4f86\u7dad\u8b77 ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u7684\u72c0\u614b\u8cc7\u8a0a\u88ab\u79fb\u9664\uff0c\u4f46\u662f\u4f7f\u7528\u90a3\u4e9b ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u7684\u5bb9\u5668\u90fd\u9084\u6d3b\u8005\u3002"),(0,o.kt)("p",null,"\u6700\u5f8c\uff0c\u6211\u5011\u900f\u904e\u91cd\u65b0\u90e8\u7f72 ",(0,o.kt)("strong",{parentName:"p"},"Pod")," \u5230 ",(0,o.kt)("strong",{parentName:"p"},"kind-worker3")," \u4e0a\u9762\uff0c\u9019\u6642\u5019 ",(0,o.kt)("strong",{parentName:"p"},"host-local")," \u6703\u5617\u8a66\u91cd\u65b0\u7522\u751f ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u5730\u5740\uff0c\u7531\u65bc ",(0,o.kt)("strong",{parentName:"p"},"/run/cni-ipam-state/kindnet")," \u88e1\u9762\u662f\u7a7a\u7684\uff0c\u6240\u4ee5\u53c8\u6703\u91cd\u65b0\u958b\u59cb\u8a08\u7b97\uff0c\u56e0\u6b64\u5206\u914d\u51fa\u4f86\u7684 ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u5c31\u6703\u8ddf\u4ee5\u524d\u91cd\u8907\uff0c\u7522\u751f IP \u885d\u7a81\u554f\u984c\u3002"),(0,o.kt)("h1",{id:"\u771f\u5be6\u60c5\u5883"},"\u771f\u5be6\u60c5\u5883"),(0,o.kt)("p",null,"\u770b\u5230\u9019\u908a\uff0c\u5c0d\u65bc\u6574\u500b\u554f\u984c\u7684\u767c\u751f\u5fc3\u7406\u90fd\u5df2\u7d93\u6709\u4e86\u500b\u5e95\uff0c\u4f46\u662f\u6211\u5011\u771f\u5be6\u60c5\u6cc1\u4e0b\u6703\u767c\u751f\u9019\u985e\u578b\u7684\u554f\u984c\u55ce?"),(0,o.kt)("p",null,"\u8981\u6eff\u8db3\u9019\u500b\u554f\u984c\u6709\u5e7e\u500b\u689d\u4ef6"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u63a1\u7528\u7684 CNI \u6700\u5f8c\u6703\u4f7f\u7528 host-local \u9019\u7a2e\u672c\u5730\u8cc7\u6599\u5eab\u4f86\u8a18\u9304\u4f7f\u7528\u7684 Pod IP \u5730\u5740"),(0,o.kt)("li",{parentName:"ol"},"\u7cfb\u7d71\u4e0a ",(0,o.kt)("strong",{parentName:"li"},"host-local")," \u4f7f\u7528\u7684\u8cc7\u6599\u593e\u88ab\u522a\u9664\uff0c\u5c0e\u81f4\u88e1\u9762\u7684\u8cc7\u6599\u5168\u90e8\u6d88\u5931\uff0c\u800c ",(0,o.kt)("strong",{parentName:"li"},"host-local")," \u6839\u672c\u4e0d\u77e5\u9053")),(0,o.kt)("p",null,"\u8981\u8e29\u5230\u689d\u4ef6\u4e00\u5176\u5be6\u5f88\u7c21\u55ae\uff0c\u9810\u8a2d\u60c5\u6297\u4e0b ",(0,o.kt)("strong",{parentName:"p"},"Flannel")," \u5c31\u662f\u4f7f\u7528\u9019\u500b\u65b9\u5f0f\u4f86\u8a18\u9304\u7684\n\u81f3\u65bc\u689d\u4ef6\u4e8c\uff0c\u5982\u679c\u7cfb\u7d71\u6a94\u6848\u6c92\u6709\u9047\u5230\u4e0d\u5982\u9810\u671f\u7684\u4fee\u6539\u7684\u8a71\uff0c\u901a\u5e38\u4e0d\u6703\u8e29\u5230\u9019\u500b\u9ede\u3002"),(0,o.kt)("p",null,"\u4f46\u662f\u4eca\u5929\u6709\u4e00\u500b\u4f7f\u7528\u60c5\u5883\u6703\u5b8c\u5168\u6eff\u8db3\u4e0a\u8ff0\u689d\u4ef6\uff0c\u5c31\u662f\u900f\u904e ",(0,o.kt)("strong",{parentName:"p"},"Rancher")," \u5b89\u88dd Kubernetes \u4e26\u4e14\u4f7f\u7528 ",(0,o.kt)("strong",{parentName:"p"},"Flannel")," \u4f5c\u70ba CNI\u3002 \u7136\u5f8c\u900f\u904e ",(0,o.kt)("strong",{parentName:"p"},"Restore")," \u7684\u529f\u80fd\u4f86\u5fa9\u539f Kubernetes\uff0c\u9019\u7a2e\u60c5\u6cc1\u4e0b\u5c31\u6703\u8e29\u5230\u9019\u500b\u554f\u984c\u3002"),(0,o.kt)("p",null,"Rancher \u518d\u9032\u884c Restore \u7684\u904e\u7a0b\u4e2d\uff0c\u6703\u5148\u95dc\u6389 ",(0,o.kt)("strong",{parentName:"p"},"kubelet"),"\uff0c\u4e26\u4e14\u5c0d\u7576\u7bc0\u9ede\u9032\u884c",(0,o.kt)("a",{parentName:"p",href:"https://github.com/rancher/rke/blob/2c270fa5ab2556e9eec3f2079cb6f2075d6dbfa9/hosts/hosts.go#L67-L82"},"\u4e00\u756a\u6e05\u9664"),"\uff0c\u8b6c\u5982"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-golang="},'\nconst (\n    ToCleanEtcdDir          = "/var/lib/etcd/"\n    ToCleanSSLDir           = "/etc/kubernetes/"\n    ToCleanCNIConf          = "/etc/cni/"\n    ToCleanCNIBin           = "/opt/cni/"\n    ToCleanCNILib           = "/var/lib/cni/"\n    ToCleanCalicoRun        = "/var/run/calico/"\n...\n)\n\n\nfunc (h *Host) CleanUpAll(ctx context.Context, cleanerImage string, prsMap map[string]v3.PrivateRegistry, externalEtcd bool) error {\n    log.Infof(ctx, "[hosts] Cleaning up host [%s]", h.Address)\n    toCleanPaths := []string{\n        path.Join(h.PrefixPath, ToCleanSSLDir),\n        ToCleanCNIConf,\n        ToCleanCNIBin,\n        ToCleanCalicoRun,\n        path.Join(h.PrefixPath, ToCleanTempCertPath),\n        path.Join(h.PrefixPath, ToCleanCNILib),\n    }\n\n    if !externalEtcd {\n        toCleanPaths = append(toCleanPaths, path.Join(h.PrefixPath, ToCleanEtcdDir))\n    }\n    return h.CleanUp(ctx, toCleanPaths, cleanerImage, prsMap)\n}\n')),(0,o.kt)("p",null,"\u8a72\u51fd\u5f0f\u5c31\u6703\u628a ",(0,o.kt)("strong",{parentName:"p"},"ToCleanCNILib")," \u9019\u500b\u8def\u5f91\u7d66\u79fb\u9664\u6389\uff0c\u800c ",(0,o.kt)("strong",{parentName:"p"},"ToCleanCNILib")," \u6307\u5411\u7684\u4f4d\u7f6e\u5247\u662f  ",(0,o.kt)("strong",{parentName:"p"},"/var/lib/cni/"),"\u3002"),(0,o.kt)("p",null,"\u975e\u5e38\u5de7\u7684\u662f ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/containernetworking/plugins/blob/ded2f1757770e8e2aa41f65687f8fc876f83048b/plugins/ipam/host-local/backend/disk/backend.go#L31-L39"},"host-local")," \u9810\u8a2d\u7684\u8def\u5f91\u4e5f\u662f ",(0,o.kt)("strong",{parentName:"p"},"/var/lib/cni")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-golang="},'var defaultDataDir = "/var/lib/cni/networks"\n\n// Store is a simple disk-backed store that creates one file per IP\n// address in a given directory. The contents of the file are the container ID.\ntype Store struct {\n    *FileLock\n    dataDir string\n}\n\n')),(0,o.kt)("p",null,"\u5169\u500b\u4e8b\u60c5\u5f88\u5de7\u7684\u649e\u518d\u4e00\u8d77\u4e4b\u5f8c\uff0c\u5c31\u6703\u7522\u751f IP \u885d\u7a81\u7684\u554f\u984c\u4e86\u3002"),(0,o.kt)("h1",{id:"\u89e3\u6c7a\u65b9\u5f0f"},"\u89e3\u6c7a\u65b9\u5f0f"),(0,o.kt)("p",null,"\u9019\u500b\u554f\u984c\u5f9e\u5169\u500b\u4eba\u7684\u89d2\u5ea6\u4f86\u770b\uff0c\u5176\u5be6\u90fd\u4e0d\u89ba\u5f97\u81ea\u5df1\u6709\u932f\uff0c\u90fd\u5f88\u76e1\u5fe0\u8077\u5b88\u3002\n\u4f46\u662f\u554f\u984c\u51fa\u5728\uff0c\u5c0d\u65bc CNI/IPAM \u4f86\u8aaa\uff0c\u6211\u7528\u4f86\u7dad\u8b77\u6574\u500b IP \u72c0\u614b\u7684\u6a94\u6848\u88ab\u79fb\u9664\u4e86\uff0c\u53ef\u662f\u4f7f\u7528\u90a3\u4e9b ",(0,o.kt)("strong",{parentName:"p"},"IP")," \u7684\u5bb9\u5668\u537b\u6c92\u6709\u88ab\u79fb\u9664\u3002"),(0,o.kt)("p",null,"\u6240\u4ee5\u4e00\u7a2e\u505a\u6cd5\u5c31\u662f\u628a\u8a72\u7bc0\u9ede\u4e0a\u7684\u6240\u6709 Pod \u90fd\u91cd\u555f\u4e00\u6b21\uff0c\u8b93 ",(0,o.kt)("strong",{parentName:"p"},"CNI")," \u91cd\u65b0\u8dd1\u904e\u3002\n\u6216\u662f\u6211\u5011\u900f\u904e Rancher \u5b89\u88dd Flannel \u7684\u6642\u5019\uff0c\u4fee\u6539\u8a2d\u5b9a\u6a94\u6848\u8b93 IPAM(host-local)  \u4f7f\u7528\u4e0d\u540c\u7684\u4f4d\u7f6e\u3002"),(0,o.kt)("p",null,"\u7562\u7adf Rancher (2.5\u4ee5\u524d)\u662f\u57fa\u65bc etcd \u7684\u6982\u5ff5\u53bb\u9084\u539f\u8207\u5099\u4efd\u6574\u500b Kubernetes Cluster\uff0c\u56e0\u6b64\u9019\u500b\u904e\u7a0b\u5c07\u7bc0\u9ede\u4e0a\u7684\u8cc7\u6599\u90fd\u6e05\u9664\u662f\u975e\u5e38\u5408\u7406\u3002"),(0,o.kt)("p",null,"\u4f46\u662f etcd \u7684\u8cc7\u6599\u4e26\u4e0d\u80fd\u5b8c\u6574\u5448\u73fe\u6574\u500b Kubernetes Cluster\uff0c\u7562\u7adf\u9084\u6709\u4e00\u4e9b\u8cc7\u6599\u4e26\u4e0d\u5b58\u5728 etcd \u5167\u3002\n\u8b6c\u5982\u672c\u6587\u7ae0\u7684 CNI\uff0c\u6216\u662f\u5176\u4ed6\u7684 PV/PVC \u7b49\uff0c\u60f3\u8981\u505a\u5230 k8s \u5b8c\u5168\u5099\u4efd\u8207\u9084\u539f\u5e7e\u4e4e\u662f\u4e0d\u592a\u53ef\u80fd\u7684\uff0c\u9019\u90e8\u5206\u9664\u4e86\u6280\u8853\u554f\u984c\u5916\uff0c\u6211\u89ba\u5f97\u66f4\u591a\u662f\u54f2\u5b78\u554f\u984c\uff0c\u8981\u5148\u5b9a\u7fa9\u4f60\u60f3\u8981\u7684\u5099\u4efd\u8207\u9084\u539f\u3002"))}c.isMDXComponent=!0}}]);