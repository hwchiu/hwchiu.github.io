"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[93136],{3905:(t,e,n)=>{n.d(e,{Zo:()=>k,kt:()=>g});var a=n(67294);function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function l(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function p(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?l(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t,e){if(null==t)return{};var n,a,r=function(t,e){if(null==t)return{};var n,a,r={},l=Object.keys(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||(r[n]=t[n]);return r}(t,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}var s=a.createContext({}),i=function(t){var e=a.useContext(s),n=e;return t&&(n="function"==typeof t?t(e):p(p({},e),t)),n},k=function(t){var e=i(t.components);return a.createElement(s.Provider,{value:e},t.children)},u="mdxType",c={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},m=a.forwardRef((function(t,e){var n=t.components,r=t.mdxType,l=t.originalType,s=t.parentName,k=o(t,["components","mdxType","originalType","parentName"]),u=i(n),m=r,g=u["".concat(s,".").concat(m)]||u[m]||c[m]||l;return n?a.createElement(g,p(p({ref:e},k),{},{components:n})):a.createElement(g,p({ref:e},k))}));function g(t,e){var n=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var l=n.length,p=new Array(l);p[0]=m;var o={};for(var s in e)hasOwnProperty.call(e,s)&&(o[s]=e[s]);o.originalType=t,o[u]="string"==typeof t?t:r,p[1]=o;for(var i=2;i<l;i++)p[i]=n[i];return a.createElement.apply(null,p)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},68945:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>s,contentTitle:()=>p,default:()=>c,frontMatter:()=>l,metadata:()=>o,toc:()=>i});var a=n(87462),r=(n(67294),n(3905));const l={title:"Docker \u7db2\u8def\u5165\u9580\u7bc7(\u4e09) - \u7db2\u8def\u5b58\u53d6\u5206\u6790",keywords:["docker","network"],tags:["Docker","Network","Kubernetes"],description:"\u672c\u7bc7\u6587\u7ae0\u63a2\u8a0e Docker Bridge \u7db2\u8def\u6a21\u578b\u7684\u904b\u4f5c\u904e\u7a0b\uff0c\u900f\u904e\u4e00\u7cfb\u5217\u6b65\u9a5f\u53bb\u62c6\u89e3\u5230\u5e95\u5bb9\u5668\u662f\u5982\u4f55\u5c0d\u5916\u4e0a\u7db2",date:new Date("2020-11-07T13:25:21.000Z")},p="\u524d\u8a00",o={unversionedId:"techPost/2020/docker-network-model-snat",id:"techPost/2020/docker-network-model-snat",title:"Docker \u7db2\u8def\u5165\u9580\u7bc7(\u4e09) - \u7db2\u8def\u5b58\u53d6\u5206\u6790",description:"\u672c\u7bc7\u6587\u7ae0\u63a2\u8a0e Docker Bridge \u7db2\u8def\u6a21\u578b\u7684\u904b\u4f5c\u904e\u7a0b\uff0c\u900f\u904e\u4e00\u7cfb\u5217\u6b65\u9a5f\u53bb\u62c6\u89e3\u5230\u5e95\u5bb9\u5668\u662f\u5982\u4f55\u5c0d\u5916\u4e0a\u7db2",source:"@site/docs/techPost/2020/docker-network-model-snat.md",sourceDirName:"techPost/2020",slug:"/techPost/2020/docker-network-model-snat",permalink:"/docs/techPost/2020/docker-network-model-snat",draft:!1,tags:[{label:"Docker",permalink:"/docs/tags/docker"},{label:"Network",permalink:"/docs/tags/network"},{label:"Kubernetes",permalink:"/docs/tags/kubernetes"}],version:"current",frontMatter:{title:"Docker \u7db2\u8def\u5165\u9580\u7bc7(\u4e09) - \u7db2\u8def\u5b58\u53d6\u5206\u6790",keywords:["docker","network"],tags:["Docker","Network","Kubernetes"],description:"\u672c\u7bc7\u6587\u7ae0\u63a2\u8a0e Docker Bridge \u7db2\u8def\u6a21\u578b\u7684\u904b\u4f5c\u904e\u7a0b\uff0c\u900f\u904e\u4e00\u7cfb\u5217\u6b65\u9a5f\u53bb\u62c6\u89e3\u5230\u5e95\u5bb9\u5668\u662f\u5982\u4f55\u5c0d\u5916\u4e0a\u7db2",date:"2020-11-07T13:25:21.000Z"},sidebar:"techPost",previous:{title:"Docker \u7db2\u8def\u5165\u9580\u7bc7(\u4e8c) - Bridge \u7db2\u8def\u6a21\u578b",permalink:"/docs/techPost/2020/docker-network-model-lab"},next:{title:"Docker Network - \u7db2\u8def\u6a21\u578b",permalink:"/docs/techPost/2020/docker-network-model"}},s={},i=[{value:"\u5c01\u5305\u8981\u9001\u7d66\u8ab0",id:"\u5c01\u5305\u8981\u9001\u7d66\u8ab0",level:2},{value:"\u8ab0\u4f86\u8655\u7406\u5c01\u5305",id:"\u8ab0\u4f86\u8655\u7406\u5c01\u5305",level:2},{value:"\u8ab0\u4f86\u904e\u6ffe\u5c01\u5305",id:"\u8ab0\u4f86\u904e\u6ffe\u5c01\u5305",level:2},{value:"\u7d50\u8ad6",id:"\u7d50\u8ad6",level:2},{value:"\u5c01\u5305\u8981\u9001\u7d66\u8ab0",id:"\u5c01\u5305\u8981\u9001\u7d66\u8ab0-1",level:2},{value:"\u8ab0\u4f86\u8655\u7406\u5c01\u5305",id:"\u8ab0\u4f86\u8655\u7406\u5c01\u5305-1",level:2},{value:"\u8ab0\u4f86\u904e\u6ffe\u5c01\u5305",id:"\u8ab0\u4f86\u904e\u6ffe\u5c01\u5305-1",level:2},{value:"\u7e3d\u7d50",id:"\u7e3d\u7d50",level:2}],k={toc:i},u="wrapper";function c(t){let{components:e,...n}=t;return(0,r.kt)(u,(0,a.Z)({},k,n,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u524d\u8a00"},"\u524d\u8a00"),(0,r.kt)("p",null,"\u672c\u7bc7\u6587\u7ae0\u662f Docker \u7db2\u8def\u5165\u9580\u7bc7\u7cfb\u5217\u6587\u7b2c\u4e09\u7bc7\uff0c\u95b1\u8b80\u672c\u6587\u524d\u8981\u5148\u6709\u524d\u9762\u5169\u7bc7\u6587\u7ae0\u7684\u57fa\u672c\u6982\u5ff5\uff0c\u56e0\u6b64\u9084\u4e0d\u5920\u719f\u6089\u7684\u8b80\u8005\u53ef\u4ee5\u518d\u6b21\u95b1\u8b80\u524d\u9762\u5169\u7bc7\u6587\u7ae0"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/docker-network-model.html"},"Docker Network - \u7db2\u8def\u6a21\u578b"),"\n",(0,r.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/docker-network-model-lab.html"},"Docker \u7db2\u8def\u5165\u9580\u7bc7(\u4e8c) - Bridge \u7db2\u8def\u6a21\u578b")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u9019\u7cfb\u5217\u7684\u6587\u7ae0\u90fd\u6703\u7528\u6bd4\u8f03\u4f7f\u7528\u8005\u7684\u89d2\u5ea6\u4f86\u63a2\u8a0e\u7db2\u8def\u6982\u5ff5\uff0c\u6bd4\u8f03\u4e0d\u6703\u53bb\u6df1\u5ea6\u63a2\u8a0e\u5e95\u5c64\u5be6\u4f5c\u7d30\u7bc0")),(0,r.kt)("h1",{id:"\u672c\u6587"},"\u672c\u6587"),(0,r.kt)("p",null,"\u524d\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u5011\u900f\u904e\u6307\u4ee4\u7684\u65b9\u5f0f\u4e00\u6b65\u4e00\u6b65\u7684\u6253\u9020\u4e00\u500b Bridge \u7db2\u8def\u6a21\u578b\uff0c\u6700\u5f8c\u6210\u529f\u7684\u8b93\u5169\u500b\u5bb9\u5668\u53ef\u4ee5\u900f\u904e  ping \u6307\u4ee4\u4f86\u4e92\u76f8\u5b58\u53d6\uff0c\u7136\u800c\u8a72\u74b0\u5883\u4e2d\u9019\u5169\u500b\u5bb9\u5668\u90fd\u6c92\u6709\u8fa6\u6cd5\u5c0d\u5916\u4e0a\u7db2\uff0c\u800c\u4e14\u6700\u5f8c\u7684\u904e\u7a0b\u4e2d\u6211\u5011\u9084\u7559\u4e0b\u4e86\u4e00\u500b iptables \u6307\u4ee4\u7684\u672a\u89e3\u4e4b\u8b0e\uff0c\u56e0\u6b64\u672c\u7bc7\u6587\u7ae0\u8981\u4f86\u5c07\u9019\u4e9b\u8cc7\u8a0a\u7d66\u91d0\u6e05\u4f5c\u70ba\u4e00\u500b\u5b8c\u7d50\u7bc7"),(0,r.kt)("p",null,"\u9019\u7bc7\u6587\u7ae0\u6703\u5f9e\u4e09\u500b\u9762\u5411\uff0c\u914d\u4e0a\u4e09\u500b\u4e3b\u8ef8\u4f86\u9032\u884c\u63a2\u8a0e\uff0c\u5206\u5225\u662f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u5bb9\u5668\u9593\u5982\u4f55\u4e92\u76f8\u5b58\u53d6"),(0,r.kt)("li",{parentName:"ol"},"\u5bb9\u5668\u5982\u4f55\u4e3b\u52d5\u5b58\u53d6\u5916\u90e8\u670d\u52d9"),(0,r.kt)("li",{parentName:"ol"},"\u5916\u90e8\u7db2\u8def\u5982\u4f55\u4e3b\u52d5\u5b58\u53d6\u5bb9\u5668")),(0,r.kt)("p",null,"\u5176\u4e2d\u7b2c\u4e09\u9ede\u7684\u529f\u80fd\u5c31\u662f ",(0,r.kt)("strong",{parentName:"p"},"docker -p")," \u9019\u529f\u80fd\u7684\u610f\u601d\uff0c\u56e0\u6b64\u7bc4\u4f8b\u4e2d\u4e5f\u6703\u4ed4\u7d30\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528"),(0,r.kt)("p",null,"\u6bcf\u500b\u9762\u5411\u88e1\u9762\u90fd\u7531\u4e09\u500b\u4e3b\u8ef8\u4f86\u63a2\u8a0e\uff0c\u5206\u5225\u662f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u5c01\u5305\u8981\u9001\u7d66\u8ab0"),(0,r.kt)("li",{parentName:"ol"},"\u8ab0\u4f86\u8655\u7406\u5c01\u5305"),(0,r.kt)("li",{parentName:"ol"},"\u8ab0\u4f86\u904e\u6ffe\u5c01\u5305")),(0,r.kt)("p",null,"\u7528\u6280\u8853\u5c64\u9762\u4f86\u8b1b\u4e0a\u9762\u4e09\u500b\u6982\u5ff5\u7684\u8a71\uff0c\u5927\u6982\u662f\u4e0b\u5217\u9019\u4e9b\u5167\u5bb9\uff0c\u4e0d\u904e\u672c\u6587\u4e0d\u6703\u592a\u7d30\u7a76\u6bcf\u500b\u5143\u4ef6\u7684\u5167\u5bb9"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"routing table + forwrding table"),(0,r.kt)("li",{parentName:"ol"},"kernel + iptables + conntrack"),(0,r.kt)("li",{parentName:"ol"},"iptables")),(0,r.kt)("h1",{id:"\u74b0\u5883"},"\u74b0\u5883"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ lsb_release -a\nNo LSB modules are available.\nDistributor ID: Ubuntu\nDescription:    Ubuntu 18.04.3 LTS\nRelease:        18.04\nCodename:       bionic\n\n$ uname -a\nLinux k8s-dev 4.15.0-72-generic #81-Ubuntu SMP Tue Nov 26 12:20:02 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\n\n$ docker --version\nDocker version 19.03.13, build 4484c46d9d\n")),(0,r.kt)("p",null,"\u5be6\u9a57\u6240\u6709\u6b65\u9a5f\u90fd\u53ef\u4ee5\u65bc ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/technologynoteniu/bloglab"},"GitHub Repo")," \u4e2d\u627e\u5230"),(0,r.kt)("h1",{id:"\u5bb9\u5668\u9593\u5982\u4f55\u5b58\u53d6"},"\u5bb9\u5668\u9593\u5982\u4f55\u5b58\u53d6"),(0,r.kt)("p",null,"\u672c\u5be6\u9a57\u662f\u57fa\u65bc\u4e0a\u6b21\u74b0\u5883\u4f86\u9032\u884c\u5f8c\u7e8c\u89c0\u5bdf\uff0c\u5230\u5e95\u4e00\u500b\u7c21\u55ae\u7684 ICMP \u5c01\u5305\u53ef\u4ee5\u901a\u5be6\u969b\u4e0a\u7cfb\u7d71\u4e2d\u5230\u5e95\u505a\u4e86\u4ec0\u9ebc\u4e8b\u60c5\u3002"),(0,r.kt)("p",null,"\u53ef\u4ee5\u76f4\u63a5\u57f7\u884c\u7bc4\u4f8b Repo \u4e2d\u7684 ",(0,r.kt)("strong",{parentName:"p"},"docker_network_basic_3/lab1.sh")," \u4f86\u6253\u9020\u4e0a\u6b21\u7684\u74b0\u5883"),(0,r.kt)("p",null,"\u9996\u5148\uff0c\u6211\u5011\u7684\u74b0\u5883\u4e2d\uff0c\u7279\u5225\u8a2d\u5b9a\u4e86\u540c\u7db2\u6bb5\u7684\u5c01\u5305\uff0c\u6240\u4ee5\u9019\u500b\u74b0\u5883\u4e2d\u7684\u5b58\u53d6\u5c31\u6703\u76f8\u5c0d\u7c21\u55ae"),(0,r.kt)("p",null,"\u6574\u500b\u74b0\u5883\u67b6\u69cb\u5716\u5982\u4e0b\n\u67b6\u69cb\u4e2d\u5169\u500b\u5bb9\u5668 C1 & C2 \u900f\u904e\u6211\u5011\u81ea\u884c\u5275\u9020\u7684 Linux Bridge(hwchiu0) \u4ee5\u53ca\u76f8\u95dc\u7684 ",(0,r.kt)("strong",{parentName:"p"},"veth")," \u865b\u64ec\u7db2\u5361\u4f86\u4e32\u9593\u5f7c\u6b64\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/XhNnxAq.jpg",alt:null})),(0,r.kt)("h2",{id:"\u5c01\u5305\u8981\u9001\u7d66\u8ab0"},"\u5c01\u5305\u8981\u9001\u7d66\u8ab0"),(0,r.kt)("p",null,"\u4e4b\u524d\u6211\u5011\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"ifconfig")," \u5e6b ",(0,r.kt)("strong",{parentName:"p"},"eth0")," \u8a2d\u5b9a IP \u5f8c\uff0cKernel \u6703\u91dd\u5c0d\u8a72\u7db2\u5361\u8a2d\u5b9a\u4e00\u500b Routing \u898f\u5247\uff0c\u544a\u8a34\u7cfb\u7d71\u8aaa\uff0c\u4ec0\u9ebc\u6a23\u7684\u5c01\u5305\uff0c\u5f80\u4ec0\u9ebc\u6a23\u7684\u7db2\u5361\u9001\u51fa\u53bb"),(0,r.kt)("p",null,"\u6211\u5011\u4f86\u770b\u4e00\u4e0b\u7576\u524d\u5169\u500b\u5bb9\u5668 C1 & C2 \u5206\u5225\u7684\u72c0\u614b\u9577\u600e\u6a23"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"\u25cb \u2192 docker exec c1 route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n10.55.66.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0\n\n\u25cb \u2192 docker exec c2 route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n10.55.66.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0\n\n")),(0,r.kt)("p",null,"\u9019\u5169\u500b\u8a0a\u606f\u7684\u6982\u5ff5\u90fd\u5f88\u7c21\u55ae\uff0c\u5c31\u662f\u544a\u8a34\u7cfb\u7d71\uff0c\u7576\u672a\u4f86\u770b\u5230 ",(0,r.kt)("strong",{parentName:"p"},"10.55.66.0/24")," \u7684\u5c01\u5305\uff0c\u5c31\u5f80 eth0 \u9019\u5f35\u7db2\u5361\u9001\u51fa\u53bb\uff0c\u4f46\u662f\u56e0\u70ba eth0 \u7db2\u5361\u662f\u7531 ",(0,r.kt)("strong",{parentName:"p"},"veth")," \u7d44\u6210\u7684\uff0c ",(0,r.kt)("strong",{parentName:"p"},"veth")," \u5c31\u5982\u540c\u6c34\u7ba1\u4e00\u6a23\uff0c\u5f9e\u5de6\u908a\u9032\u53bb\uff0c\u53f3\u908a\u5c31\u6703\u51fa\u4f86\uff0c\u56e0\u6b64\u9001\u5230 ",(0,r.kt)("strong",{parentName:"p"},"eth0")," \u7684\u5c01\u5305\u5c31\u6703\u99ac\u4e0a\u5f9e\u53e6\u4e00\u7aef\u7684 ",(0,r.kt)("strong",{parentName:"p"},"veth0/veth1")," \u8dd1\u51fa\u4f86\u3002"),(0,r.kt)("p",null,"\u6982\u5ff5\u5982\u4e0b\u5716\n\u6839\u64da\u4e0a\u8ff0\u89c0\u5ff5\uff0c\u7576\u524d\u5169\u500b\u5bb9\u5668\u5f80 ",(0,r.kt)("strong",{parentName:"p"},"10.55.66.0/24")," \u7684\u5c01\u5305\u6700\u5f8c\u90fd\u6703\u5f9e\u5bbf\u4e3b\u6a5f\u8eab\u4e0a\u7684 ",(0,r.kt)("strong",{parentName:"p"},"veth0/veth1")," \u4e0a\u51fa\u73fe\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/YxMBsYX.jpg",alt:null})),(0,r.kt)("h2",{id:"\u8ab0\u4f86\u8655\u7406\u5c01\u5305"},"\u8ab0\u4f86\u8655\u7406\u5c01\u5305"),(0,r.kt)("p",null,"\u7576\u5c01\u5305\u9032\u5165 eth0 \u7db2\u5361\uff0c\u4e4b\u5f8c\u5f9e veth0/veth1 \u51fa\u73fe\u5f8c\uff0c\u56e0\u70ba ",(0,r.kt)("strong",{parentName:"p"},"veth0/veth1")," \u672c\u8eab\u662f\u639b\u5728 Linux Bridge (hwchiu0) \u8eab\u4e0a\uff0c\u56e0\u6b64\u5c01\u5305\u5c31\u6703\u4ea4\u7531 ",(0,r.kt)("strong",{parentName:"p"},"Linux Bridge")," \u4f86\u8655\u7406\uff01"),(0,r.kt)("p",null,"\u9019\u908a\u7684\u8655\u7406\u5206\u6210\u5169\u500b\u90e8\u5206(\u9019\u908a\u4e0d\u8ac7\u5be6\u969b\u5c01\u5305\u8655\u7406\u9806\u5e8f)"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Linux Bridge \u5167\u90e8\u6703\u6709\u4e00\u500b\u6a5f\u5236\u7528\u4f86\u6c7a\u5b9a\u5982\u4f55\u8f49\u9001\u5c01\u5305"),(0,r.kt)("li",{parentName:"ol"},"ebtables (\u672c\u6587\u5ffd\u7565\u9019\u500b\u6982\u5ff5)")),(0,r.kt)("p",null,"Linux Bridge \u7684\u8f49\u9001\u6a5f\u5236\u662f\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"MAC Address")," \u4f86\u6c7a\u5b9a\u5c01\u5305\u600e\u9ebc\u8f49\u9001\uff0c\u800c\u9019\u4efd\u8f49\u63db\u8868\u53ef\u4ee5\u7a31\u70ba Forwarding Table\uff0c\u6839\u64da ",(0,r.kt)("strong",{parentName:"p"},"MAC Address")," \u4f86\u8f49\u767c\u5c01\u5305"),(0,r.kt)("p",null,"\u4e0b\u5716\u70ba\u4e00\u500b\u7bc4\u4f8b\uff0c\u7576\u5c01\u5305\u9032\u5165\u5230 Linux Bridge \u5f8c\uff0c\u5176\u6703\u6839\u64da\u5c01\u5305\u7684\u76ee\u6a19 ",(0,r.kt)("strong",{parentName:"p"},"MAC Address")," \u662f\u8ab0\uff0c\u4f86\u6c7a\u5b9a\u5f9e\u54ea\u500b ",(0,r.kt)("strong",{parentName:"p"},"Port")," \u9001\u51fa\u53bb\u3002"),(0,r.kt)("p",null,"\u56e0\u6b64\u6211\u5011\u7684\u7bc4\u4f8b\u4e2d\uff0cC1/C2 \u5bb9\u5668\u4e4b\u9593\u7684\u5c01\u5305\u5c31\u662f\u900f\u904e\u9019\u7a2e\u6a5f\u5236\u4f86\u8655\u7406\u8f49\u767c\u3002\n",(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/Cns14pD.jpg",alt:null})),(0,r.kt)("h2",{id:"\u8ab0\u4f86\u904e\u6ffe\u5c01\u5305"},"\u8ab0\u4f86\u904e\u6ffe\u5c01\u5305"),(0,r.kt)("p",null,"\u6709\u4e86\u4e0a\u8ff0\u7684\u898f\u5247\u5f8c\uff0cC1/C2 \u5bb9\u5668\u4e4b\u9593\u8981\u53ef\u4ee5\u4e92\u76f8\u50b3\u8f38\u5c01\u5305\u4e86\uff0c\u4f46\u662f\u5be6\u52d9\u4e0a\u537b\u767c\u73fe\u6703\u6709\u554f\u984c\uff0c\u6211\u5011\u7684 PING \u4e0d\u6703\u901a\uff0c\u539f\u56e0\u662f\u56e0\u70ba ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u5077\u5077\u4ecb\u5165\u4f86\u9032\u884c\u8655\u7406\uff0c\u4e26\u4e14\u5c07\u4e0d\u7b26\u5408\u898f\u5247\u7684\u5c01\u5305\u90fd\u4e1f\u68c4\u3002"),(0,r.kt)("p",null,"\u9019\u908a\u6709\u5169\u500b\u8b70\u984c"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"iptables \u70ba\u4ec0\u9ebc\u5077\u5077\u4ecb\u5165\u4f86\u8655\u7406"),(0,r.kt)("li",{parentName:"ol"},"\u70ba\u4ec0\u9ebc\u4e0d\u7b26\u5408\u898f\u5247\u7684\u5c01\u5305\u8981\u4e1f\u68c4\uff0c\u800c\u4e0d\u662f\u7b26\u5408\u898f\u5247\u7684\u5c01\u5305\u624d\u4e1f\u68c4")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"iptables")," \u9810\u8a2d\u4e0d\u6703\u5e72\u64fe\u4efb\u4f55 ",(0,r.kt)("strong",{parentName:"p"},"Linux Bridge")," \u8f49\u767c\u7684\u5c01\u5305\uff0c\u9019\u908a\u662f\u6709\u500b\u958b\u95dc\u8981\u6253\u958b\uff0c\u4e5f\u662f ",(0,r.kt)("strong",{parentName:"p"},"docker")," \u5b89\u88dd\u5f8c\u6703\u5e6b\u5fd9\u6253\u958b\u7684\u958b\u95dc"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"\u2192 cat /proc/sys/net/bridge/bridge-nf-call-iptables\n1\n")),(0,r.kt)("p",null,"\u9019\u908a\u6211\u5011\u53ef\u4ee5\u505a\u500b\u5be6\u9a57\uff0c\u6b65\u9a5f\u662f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u78ba\u8a8d\u7576\u524d\u7db2\u8def\u4e0d\u901a"),(0,r.kt)("li",{parentName:"ol"},"\u5c07\u4e0a\u8ff0\u958b\u95dc\u95dc\u9589\uff0c\u8b93 iptables \u4e0d\u8981\u5e72\u6d89"),(0,r.kt)("li",{parentName:"ol"},"\u91cd\u65b0\u767c\u9001 ping")),(0,r.kt)("p",null,"\u9019\u6642\u5019\u5c31\u6703\u767c\u73fe\u5bb9\u5668\u4e4b\u9593\u53ef\u4ee5\u900f\u904e ICMP \u50b3\u9001\u5c01\u5305\u4e86"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},'$ docker exec -it c1 ping 10.55.66.3 -c1 -W1\nPING 10.55.66.3 (10.55.66.3) 56(84) bytes of data.\n\n--- 10.55.66.3 ping statistics ---\n1 packets transmitted, 0 received, 100% packet loss, time 0ms\n\n\n$ echo "0" | sudo tee /proc/sys/net/bridge/bridge-nf-call-iptables\n0\n\n$ docker exec -it c1 ping 10.55.66.3 -c1 -W1\nPING 10.55.66.3 (10.55.66.3) 56(84) bytes of data.\n64 bytes from 10.55.66.3: icmp_seq=1 ttl=64 time=0.025 ms\n\n--- 10.55.66.3 ping statistics ---\n1 packets transmitted, 1 received, 0% packet loss, time 0ms\nrtt min/avg/max/mdev = 0.025/0.025/0.025/0.000 ms\n\n$ echo "1" | sudo tee /proc/sys/net/bridge/bridge-nf-call-iptables\n1\n')),(0,r.kt)("p",null,"\u7576 ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u88ab\u544a\u77e5\u8981\u5e72\u6d89 ",(0,r.kt)("strong",{parentName:"p"},"Linux Bridge")," \u7684\u5c01\u5305\u7ba1\u7406\u5f8c\uff0c\u6240\u6709\u7d93\u904e\u7684\u5c01\u5305\u90fd\u6703\u8b93 ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u4f86\u9032\u884c\u6aa2\u67e5"),(0,r.kt)("p",null,"Docker \u7684\u74b0\u5883\u4e4b\u4e2d\uff0c\u63a1\u53d6\u7684\u662f\u767d\u540d\u55ae\u6a5f\u5236\uff0c\u82e5\u6c92\u6709\u544a\u77e5\u8981\u901a\u904e\uff0c\u5247\u5c07\u8a72\u5c01\u5305\u7d66\u4e1f\u68c4\uff0c\u6240\u4ee5\u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc\u6211\u5011\u7684\u5c01\u5305\u4e0d\u6703\u901a\u904e\u3002\n\u9019\u908a\u6709\u5169\u7a2e\u89e3\u6c7a\u65b9\u6cd5"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u4fee\u6539\u6210\u9ed1\u540d\u55ae\u7684\u6982\u5ff5\uff0c\u9810\u8a2d\u901a\u904e\u5c01\u5305"),(0,r.kt)("li",{parentName:"ol"},"\u52a0\u5165\u76f8\u95dc\u898f\u5247\uff0c\u8b93\u6211\u5011\u7684\u5c01\u5305\u53ef\u4ee5\u901a\u904e")),(0,r.kt)("p",null,"\u524d\u4e00\u7bc7\u6587\u7ae0\u7684\u5be6\u9a57\u5c31\u662f\u91dd\u5c0d (1) \u9032\u884c\u64cd\u4f5c,\u9019\u908a\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"iptables -P FORWARD ACCEPT")," \u53bb\u8aaa\u660e\uff0c\u5c0d\u65bc ",(0,r.kt)("strong",{parentName:"p"},"FORAWRD")," \u5c01\u5305\u7684\u8655\u7406\uff0c\u9810\u8a2d\u5c31\u662f ",(0,r.kt)("strong",{parentName:"p"},"ACCEPT")," \u53bb\u63a5\u7d0d\u4ed6\u5011"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ docker exec -it c1 ping 10.55.66.3 -c1 -W1\nPING 10.55.66.3 (10.55.66.3) 56(84) bytes of data.\n\n--- 10.55.66.3 ping statistics ---\n1 packets transmitted, 0 received, 100% packet loss, time 0ms\n\n\n$ sudo iptables -P FORWARD ACCEPT\n\n$ docker exec -it c1 ping 10.55.66.3 -c1 -W1\nPING 10.55.66.3 (10.55.66.3) 56(84) bytes of data.\n64 bytes from 10.55.66.3: icmp_seq=1 ttl=64 time=0.039 ms\n\n--- 10.55.66.3 ping statistics ---\n1 packets transmitted, 1 received, 0% packet loss, time 0ms\nrtt min/avg/max/mdev = 0.039/0.039/0.039/0.000 ms\n\n# recover\n$ sudo iptables -P FORWARD DROP\n\n")),(0,r.kt)("h2",{id:"\u7d50\u8ad6"},"\u7d50\u8ad6"),(0,r.kt)("p",null,"\u91dd\u5c0d\u540c\u7bc0\u9ede\u4e0a\u4e0d\u540c\u5bb9\u5668\u4e4b\u9593\u7684\u50b3\u8f38\uff0c\u57fa\u672c\u4e0a\u90fd\u662f\u4f9d\u9760 ",(0,r.kt)("strong",{parentName:"p"},"Linux Bridge")," \u4f86\u5e6b\u5fd9\u8655\u7406\uff0c\u85c9\u7531 ",(0,r.kt)("strong",{parentName:"p"},"Forwarding Table")," \u4f86\u6c7a\u5b9a\u8a72\u600e\u9ebc\u50b3\u8f38\u5c01\u5305\uff0c\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u4f86\u6c7a\u5b9a\u5c01\u5305\u80fd\u4e0d\u80fd\u901a\u884c\u3002"),(0,r.kt)("p",null,"Docker \u9810\u8a2d\u7684\u60c5\u6cc1\u4e0b\u6703\u8b93 ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u4ecb\u5165 ",(0,r.kt)("strong",{parentName:"p"},"Linux Bridge")," \u7684\u8655\u7406\uff0c\u540c\u6642\u63a1\u7531\u767d\u540d\u55ae\u6a5f\u5236\uff0c\u6c92\u6709\u7b26\u5408\u898f\u5247\u7684\u5c31\u4e00\u5f8b\u4e1f\u68c4\uff0c\u800c Docker \u9019\u908a\u7684\u4f5c\u6cd5\u5247\u662f\u6703\u52a0\u5165\u76f8\u95dc\u7684\u898f\u5247\u4f86\u6253\u901a\u5c01\u5305\u9023\u63a5\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/b1veY6Z.jpg",alt:null})),(0,r.kt)("h1",{id:"\u5bb9\u5668\u5982\u4f55\u4e3b\u52d5\u5b58\u53d6\u5916\u90e8\u670d\u52d9"},"\u5bb9\u5668\u5982\u4f55\u4e3b\u52d5\u5b58\u53d6\u5916\u90e8\u670d\u52d9"),(0,r.kt)("p",null,"\u4e0a\u8ff0\u8a0e\u8ad6\u4e86\u5bb9\u5668\u9593\u7684\u57fa\u672c\u5b58\u53d6\u65b9\u5f0f\uff0c\u6709\u4e86\u4e0a\u8ff0\u7684\u6982\u5ff5\u4e4b\u5f8c\uff0c\u6211\u5011\u63a5\u4e0b\u4f86\u53ef\u4ee5\u5f80\u4e0b\u9081\u9032\u53bb\u63a2\u8a0e\uff0c\u5982\u679c\u5bb9\u5668\u60f3\u8981\u5b58\u53d6\u5916\u90e8\u670d\u52d9\uff0c\u8b6c\u5982 8.8.8.8 \u4e4b\u985e\u7684\u5916\u90e8\u7db2\u7ad9\u6642\uff0c\u5230\u5e95\u8a72\u600e\u9ebc\u8655\u7406\uff0c\u9019\u4e5f\u662f\u5bb9\u5668\u670d\u52d9\u4e2d\u6700\u5e38\u4f7f\u7528\u7684\u985e\u578b\uff0c\u7562\u7adf\u6c92\u6709\u5c0d\u5916\u4e0a\u7db2\u80fd\u529b\uff0c\u5f88\u591a\u4e8b\u60c5\u90fd\u6c92\u8fa6\u6cd5\u5b8c\u6210\u3002"),(0,r.kt)("p",null,"\u9019\u500b\u7bc4\u4f8b\u4e2d\u5c07\u63a2\u8a0e\u5982\u4f55\u8b93\u4e00\u500b\u5bb9\u5668\u4f5c\u70ba\u6211\u5011\u7684 Client \u7aef\uff0c\u80fd\u5920\u900f\u904e PING \u9019\u500b\u6307\u4ee4\u4f86\u5b58\u53d6\u5916\u90e8 8.8.8.8 \u670d\u52d9\u5668"),(0,r.kt)("p",null,"\u67b6\u69cb\u5716\u5982\u4e0b\u65b9\uff0c\u6700\u7d42\u76ee\u6a19\u662f\u5bb9\u5668 C1 \u80fd\u5920\u7528 ping \u5b58\u53d6 8.8.8.8\n",(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/PtgBuvH.jpg",alt:null})),(0,r.kt)("h2",{id:"\u5c01\u5305\u8981\u9001\u7d66\u8ab0-1"},"\u5c01\u5305\u8981\u9001\u7d66\u8ab0"),(0,r.kt)("p",null,"\u5c01\u5305\u7684\u8f49\u9001\u6211\u5011\u4e00\u958b\u59cb\u90fd\u9700\u8981\u5148\u6c7a\u5b9a\uff0c\u5230\u5e95\u9001\u7d66\u8ab0\uff0c\u9019\u908a\u6211\u5011\u518d\u6b21\u56de\u9867\u4e00\u4e0b\u7576\u524d\u5bb9\u5668 c1 \u5167\u7684\u8def\u7531\u8868"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ docker exec -it c1 route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n10.55.66.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0\n")),(0,r.kt)("p",null,"\u9019\u6642\u5019\u5982\u679c\u6211\u5011\u5f37\u884c\u9023\u63a5 8.8.8.8 \u7684\u8a71\uff0c\u6703\u5f97\u5230\u76f8\u95dc\u932f\u8aa4,\u56e0\u70ba\u7cfb\u7d71\u4e2d\u6839\u672c\u4e0d\u77e5\u9053\u8981\u600e\u9ebc\u8f49\u9001 8.8.8.8 \u7684\u5c01\u5305\uff0c\u5b8c\u5168\u6c92\u6709\u53ef\u4ee5\u7b26\u5408\u7684\u898f\u5247\u4f7f\u7528"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ docker exec -it c1 ping 8.8.8.8\nconnect: Network is unreachable\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u7db2\u8def\u9664\u932f\u6642\u8981\u683c\u5916\u5c0f\u5fc3\u8207\u8b39\u614e\uff0c\u6211\u5efa\u8b70\u6240\u6709\u7db2\u8def\u9664\u932f\u90fd\u662f\u5148\u756b\u51fa\u67b6\u69cb\u5716\uff0c\u7136\u5f8c\u601d\u8003\u4e00\u4e0b\u4f60\u8a8d\u70ba\u5c01\u5305\u8a72\u600e\u9ebc\u904b\u4f5c\uff0c\u5c0d\u65bc\u6240\u6709\u95dc\u9375\u9ede\u4f60\u6709\u6c92\u6709\u8fa6\u6cd5\u8209\u8b49\u4ed6\u662f\u5c0d\u6216\u662f\u932f\uff0c\u85c9\u7531\u9019\u500b\u904e\u7a0b\u7e2e\u5c0f\u53ef\u80fd\u51fa\u932f\u7684\u7bc4\u570d\u3002")),(0,r.kt)("p",null,"\u70ba\u4e86\u89e3\u6c7a\u9019\u500b\u554f\u984c\uff0c\u6211\u5011\u53ef\u4ee5 ",(0,r.kt)("strong",{parentName:"p"},"\u660e\u78ba\u544a\u8a34\u7cfb\u7d71\uff0c\u770b\u5230 8.8.8.8 \u7684\u5c01\u5305\u8a72\u600e\u9ebc\u9001"),"\n\u4f46\u662f\u9019\u7a2e\u601d\u8def\u9020\u6210\u7684\u554f\u984c\u5c31\u662f\u5982\u679c\u4eca\u5929\u4f60\u60f3\u8981\u5b58\u53d6 ",(0,r.kt)("strong",{parentName:"p"},"1.1.1.1"),"\uff0c\u4f60\u5c31\u8981\u984d\u5916\u7684\u65b0\u898f\u5247\uff0c\u6240\u4ee5\u6211\u5011\u53ef\u4ee5\u900f\u904e\u53e6\u5916\u4e00\u7a2e\u4f5c\u6cd5\u3002"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u6c92\u6709\u7b26\u5408\u4efb\u4f55\u898f\u5247\u7684\u8a71\uff0c\u5c31\u8d70\u9810\u8a2d\u8d70\u6cd5\u5427\uff01"),"\n\u9019\u4e5f\u662f\u7cfb\u7d71\u5be6\u52d9\u4e0a\u5e38\u898b\u7684\u4f5c\u6cd5\uff0c\u56e0\u70ba\u6c92\u6709\u4eba\u6709\u8fa6\u6cd5\u9810\u6599\u5230\u4f60\u6703\u60f3\u8981\u9023\u54ea\u500b\u7db2\u7ad9\uff0c\u91dd\u5c0d\u6bcf\u500b\u7db2\u7ad9\u90fd\u5beb\u4e00\u689d\u898f\u5247\u5be6\u5728\u662f\u4e0d\u592a\u5408\u7406"),(0,r.kt)("p",null,"\u6709\u4e86\u9019\u500b\u60f3\u6cd5\u5f8c\uff0c\u6211\u5011\u4e0b\u4e00\u500b\u554f\u984c\u5c31\u662f\uff0c\u90a3\u6211\u8981\u9001\u7d66\u8ab0\u5e6b\u5fd9\u8655\u7406\uff0c\u9019\u908a\u56e0\u70ba\u727d\u626f\u5230 L3 \u8def\u7531\u7684\u6982\u5ff5\u76f8\u5c0d\u8907\u96dc\uff0c\u76f4\u63a5\u8b1b\u7d50\u8ad6\u5c31\u662f\n\u6211\u5011\u5e0c\u671b\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"\u5bbf\u4e3b\u6a5f")," \u5e6b\u6211\u5011\u8655\u7406\uff0c\u5982\u679c\u5bbf\u4e3b\u6a5f\u672c\u8eab\u5c31\u6709\u80fd\u529b\u5b58\u53d6\u5916\u90e8\u7db2\u8def\uff0c\u6211\u5011\u662f\u4e0d\u662f\u80fd\u5920\u4f9d\u8cf4\u5bbf\u4e3b\u6a5f\u5e6b\u6211\u5011\u8655\u7406\uff0c\u6211\u5011\u53ea\u8981\u60f3\u8fa6\u6cd5\u5c07\u5c01\u5305\u9001\u7d66\u5bbf\u4e3b\u6a5f\uff0c\u8b93\u5bbf\u4e3b\u6a5f\u77e5\u9053\u6709\u5c01\u5305\u8981\u8655\u7406\uff0c\u8acb\u7e7c\u7e8c\u5f80\u4e0b\u5f04"),(0,r.kt)("p",null,"\u70ba\u4e86\u9054\u6210\u9019\u500b\u689d\u4ef6\uff0c\u6211\u5011\u9700\u8981\u9032\u884c\u4e0b\u5217\u8a2d\u5b9a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u7d66 Linux Bridge (hwchiu0) \u4e00\u500b IP \u5730\u5740"),(0,r.kt)("li",{parentName:"ol"},"\u544a\u8a34\u5bb9\u5668\u8aaa\uff0c\u9810\u8a2d\u8d70\u6cd5\u5c31\u662f\u5c07\u5c01\u5305\u9001\u7d66 ",(0,r.kt)("strong",{parentName:"li"},"Linux Bridge (hwchiu0)"))),(0,r.kt)("p",null,"\u4e0a\u8ff0\u5169\u500b\u6982\u5ff5\u8f49\u63db\u6210\u7cfb\u7d71\u6307\u4ee4\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ sudo ifconfig hwchiu0 10.55.66.1 netmask 255.255.255.0\n$ sudo docker exec -it c1 ip route add default via 10.55.66.1\n$ sudo docker exec -it c1 ip route show\ndefault via 10.55.66.1 dev eth0\n10.55.66.0/24 dev eth0  proto kernel  scope link  src 10.55.66.2\n")),(0,r.kt)("p",null,"\u8a2d\u5b9a\u5b8c\u7562\u5f8c\uff0c\u6211\u5011\u5bb9\u5668\u73fe\u5728\u591a\u4e86\u4e00\u500b\u898f\u5247\uff0c\u9810\u8a2d\u60c5\u6cc1\u4e0b\uff0c\u5c31\u5c07\u5c01\u5305\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"eth0")," \u9001\u51fa\u53bb\uff0c\u4e26\u4e14\u5c07\u5176 \u9598\u9053(Gateway) \u8a2d\u5b9a\u6210 ",(0,r.kt)("strong",{parentName:"p"},"10.55.66.1"),"\u3002"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u9019\u908a\u4e0d\u89e3\u91cb Gateway \u7684\u6982\u5ff5\uff0c\u60f3\u6210\u6211\u5011\u60f3\u8981\u900f\u904e Linux Bridge \u5e6b\u6211\u5011\u8f49\u767c\uff0c\u5c01\u5305\u9001\u7d66\u4ed6\u5c31\u5c0d\u4e86\uff01")),(0,r.kt)("p",null,"\u63a5\u4e0b\u4f86\u91dd\u5c0d\u7cfb\u7d71\u4e0a\u7684 ",(0,r.kt)("strong",{parentName:"p"},"eth0")," \u53bb\u76e3\u807d\u5c01\u5305\uff0c\u770b\u770b\u9019\u6642\u5019\u5f9e ",(0,r.kt)("strong",{parentName:"p"},"container c1")," \u767c\u9001\u5c01\u5305\u5230 8.8.8.8 \u6703\u600e\u9ebc\u6a23"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u70ba\u4e86\u907f\u514d iptables \u53c8\u4f86\u5e72\u64fe\u904e\u6ffe\u529f\u80fd\uff0c\u6211\u5011\u5148\u4fee\u6539\u6210\u9810\u8a2d\u5c01\u5305\u90fd\u6703\u901a")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u958b\u5169\u500b\u8996\u7a97\u57f7\u884c")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ sudo iptables -P FORWARD ACCEPT\n$ sudo docker exec -it c1 ping 8.8.8.8\nPING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ sudo tcpdump -vvvnn -i eth0 icmp\ntcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n19:01:20.425931 IP (tos 0x0, ttl 63, id 60779, offset 0, flags [DF], proto ICMP (1), length 84)\n    10.55.66.2 > 8.8.8.8: ICMP echo request, id 16700, seq 1, length 64\n19:01:21.445051 IP (tos 0x0, ttl 63, id 60899, offset 0, flags [DF], proto ICMP (1), length 84)\n    10.55.66.2 > 8.8.8.8: ICMP echo request, id 16700, seq 2, length 64\n")),(0,r.kt)("p",null,"\u900f\u904e\u4e0a\u8ff0\u6307\u4ee4\u53ef\u4ee5\u89c0\u5bdf\u5230\uff0c\u5c01\u5305\u9084\u662f\u4e0d\u901a\uff0c\u6c92\u6709\u8fa6\u6cd5\u5f97\u5230\u6b63\u78ba\u7684 ICMP \u56de\u61c9\uff0c\u4f46\u662f\u6211\u5011\u53ef\u4ee5\u5f9e\u5bbf\u4e3b\u6a5f\u4e0a\u9762\u7684 ",(0,r.kt)("strong",{parentName:"p"},"eth0")," \u89c0\u5bdf\u5230\u76f8\u95dc\u5c01\u5305\u4e86\uff0c\u9019\u4e9b\u5c01\u5305\u6a19\u793a ",(0,r.kt)("strong",{parentName:"p"},"10.55.66.2")," \u60f3\u8981\u9001\u7d66 ",(0,r.kt)("strong",{parentName:"p"},"8.8.8.8"),"\u3002"),(0,r.kt)("p",null,"\u53ea\u662f\u76ee\u524d\u90fd\u53ea\u6709\u770b\u5230 ",(0,r.kt)("strong",{parentName:"p"},"ICMP")," \u7684\u8acb\u6c42\uff0c\u800c\u6c92\u6709\u56de\u61c9\u3002"),(0,r.kt)("p",null,"\u4e0a\u8ff0\u7684\u6240\u6709\u6d41\u7a0b\u6211\u5011\u7528\u4e0b\u5217\u6d41\u7a0b\u5716\u518d\u6b21\u89e3\u91cb"),(0,r.kt)("p",null,"\u8a72\u5716\u7247\u600e\u9ebc\u89c0\u770b"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u4e0a\u9762\u767d\u8272\u6846\u6846\u4ee3\u8868\u4e0d\u540c\u5143\u4ef6\uff0c\u82e5\u5143\u4ef6\u4e0a\u65b9\u6709IP\uff0c\u5247\u4ee3\u8868\u8a72\u5143\u4ef6\u7684 IP \u5730\u5740"),(0,r.kt)("li",{parentName:"ol"},"\u6bcf\u500b\u5143\u4ef6\u4e4b\u9593\u900f\u904e\u7bad\u982d\u4f86\u63cf\u8ff0\u5c01\u5305\u6d41\u5411\uff0c\u4e26\u4e14\u8868\u660e\u8a72\u6d41\u5411\u4e2d\uff0c\u5c01\u5305\u5167\u7684 ",(0,r.kt)("strong",{parentName:"li"},"IP")," \u5730\u5740\u662f\u4ec0\u9ebc\uff0c",(0,r.kt)("strong",{parentName:"li"},"\u7531\u8ab0\u9001\u7d66\u8ab0")),(0,r.kt)("li",{parentName:"ol"},"\u5c01\u5305\u6d41\u5411\u4e0b\u65b9\u63cf\u8ff0\u7684\u5247\u662f\u7576\u524d\u904e\u7a0b\u4e2d\uff0c\u6709\u54ea\u4e9b\u5143\u4ef6\u6d89\u5165\u9032\u884c\u8655\u7406")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/POi2cVr.jpg",alt:null})),(0,r.kt)("p",null,"\u91cd\u65b0\u6574\u7406\u76ee\u524d\u5df2\u77e5\u6d41\u7a0b\u8207\u601d\u8def"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u7576\u5bb9\u5668\u5167\u767c\u51fa\u4e00\u500b\u9001\u5f80 ",(0,r.kt)("strong",{parentName:"li"},"8.8.8.8")," \u7684\u5c01\u5305\uff0c\u56e0\u70ba\u898f\u5247\u7684\u95dc\u4fc2\uff0c\u8a72\u5c01\u5305\u6703\u900f\u904e ",(0,r.kt)("strong",{parentName:"li"},"eth0")," \u9001\u51fa\u53bb"),(0,r.kt)("li",{parentName:"ol"},"\u7576\u5c01\u5305\u5f9e ",(0,r.kt)("strong",{parentName:"li"},"eth0")," \u9001\u51fa\u53bb\u5f8c\uff0c\u56e0\u70ba ",(0,r.kt)("strong",{parentName:"li"},"veth")," \u7684\u7279\u6027\uff0c\u5c01\u5305\u6703\u5230\u9054\u7cfb\u7d71\u4e0a\u7684 ",(0,r.kt)("strong",{parentName:"li"},"veth0")," \u865b\u64ec\u7db2\u5361"),(0,r.kt)("li",{parentName:"ol"},"\u5f9e ",(0,r.kt)("strong",{parentName:"li"},"veth0")," \u9032\u5165\u5230 ",(0,r.kt)("strong",{parentName:"li"},"Linux Bridge")," \u7684\u4e16\u754c\uff0c\u9019\u6642\u5019\u900f\u904e ",(0,r.kt)("strong",{parentName:"li"},"Forwarding Table")," \u7684\u6982\u5ff5\uff0c\u6700\u7d42\u8a72\u5c01\u5305\u6703\u9032\u5165\u5230 Linux Bridge(hwchiu0) \u672c\u8eab\u3002"),(0,r.kt)("li",{parentName:"ol"},"hwchiu0 \u6536\u5230\u5c01\u5305\u5f8c\uff0c\u63a5\u4e0b\u4f86\u90fd\u662f ",(0,r.kt)("strong",{parentName:"li"},"kernel")," \u5167\u7684\u4e8b\u60c5\u4e86\uff0c\u9019\u908a\u592a\u8907\u96dc\uff0c\u6211\u5011\u5ffd\u7565"),(0,r.kt)("li",{parentName:"ol"},"Kernel \u6700\u5f8c\u900f\u904e\u672c\u8eab\u7684 ",(0,r.kt)("strong",{parentName:"li"},"routing talbe")," \u53bb\u67e5\u8a62\uff0c\u8a72\u600e\u9ebc\u8f49\u9001 ",(0,r.kt)("strong",{parentName:"li"},"8.8.8.8")," \u7684\u5c01\u5305\uff0c\u7136\u5f8c\u6839\u64da\u898f\u5247\u9001\u5f80\u5bbf\u4e3b\u6a5f\u4e0a\u7684 ",(0,r.kt)("strong",{parentName:"li"},"eth0")," \u7db2\u5361"),(0,r.kt)("li",{parentName:"ol"},"\u5c01\u5305\u9001\u4e86\u51fa\u53bb\uff0c\u4f46\u662f\u6211\u5011\u6c92\u6709\u8fa6\u6cd5\u76e3\u807d\u5230\u56de\u4f86\u7684\u5c01\u5305")),(0,r.kt)("h2",{id:"\u8ab0\u4f86\u8655\u7406\u5c01\u5305-1"},"\u8ab0\u4f86\u8655\u7406\u5c01\u5305"),(0,r.kt)("p",null,"\u70ba\u4ec0\u9ebc\u6536\u4e0d\u5230\u5c01\u5305\uff0c\u7406\u7531\u5f88\u7c21\u55ae\n\u6211\u5011\u9001\u51fa\u53bb\u7684\u5c01\u5305\u4f86\u6e90\u662f ",(0,r.kt)("strong",{parentName:"p"},"10.55.66.2"),"\uff0c\u5927\u90e8\u5206\u60c5\u6cc1\u4e0b\u6211\u5011\u9019\u500b\u7db2\u6bb5\u90fd\u662f ",(0,r.kt)("strong",{parentName:"p"},"private"),"\uff0c\u4e5f\u5c31\u662f\u79c1\u6709\u7db2\u6bb5\uff0c\u4e16\u754c\u4e0a\u53ef\u80fd\u6709\u5f88\u591a\u4eba\u90fd\u6703\u4f7f\u7528 ",(0,r.kt)("strong",{parentName:"p"},"10.55.66.2"),"\uff0c\u90a3\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c ",(0,r.kt)("strong",{parentName:"p"},"8.8.8.8")," \u6839\u672c\u4e0d\u77e5\u9053\u8981\u600e\u9ebc\u628a\u5c01\u5305\u9001\u56de\u7d66 ",(0,r.kt)("strong",{parentName:"p"},"10.55.66.2")),(0,r.kt)("p",null,"\u9019\u6642\u5019\u6211\u5011\u8981\u4f86\u601d\u8003\uff0c\u6211\u5011\u7684\u5bbf\u4e3b\u6a5f\u662f\u4e0d\u662f\u53ef\u4ee5\u4e0a\u7db2\uff0c\u662f\u4e0d\u662f\u4ed6\u7684\u5c01\u5305\u90fd\u56de\u5f97\u4f86\uff1f\n\u5982\u679c\u662f\u7684\u8a71\uff0c\u6211\u5011\u80fd\u4e0d\u80fd\u53eb\u5bbf\u4e3b\u6a5f\u5e6b\u5fd9\u597d\u4eba\u4f5c\u5230\u5e95\uff0c\u628a\u5c01\u5305\u7684\u4f86\u6e90\u4e5f\u8b8a\u6210\u5bbf\u4e3b\u6a5f\u7684 ",(0,r.kt)("strong",{parentName:"p"},"IP")," ? \u7136\u5f8c\u5bbf\u4e3b\u6a5f\u518d\u60f3\u8fa6\u6cd5\u628a\u5c01\u5305\u8f49\u9001\u56de\u7d66\u6211\u5011\u5f8c\u9762\u7684\u5bb9\u5668\u5373\u53ef"),(0,r.kt)("p",null,"\u9019\u500b\u6982\u5ff5\u5c31\u662f\u6240\u8b02\u7684 Network Address Translation (NAT)\uff0c\u9019\u500b\u7bc4\u4f8b\u4e2d\u6211\u5011\u60f3\u8981\u4fee\u6539\u5c01\u5305\u7684\u4f86\u6e90 ",(0,r.kt)("strong",{parentName:"p"},"IP")," \u5730\u5740\uff0c\u56e0\u6b64\u9019\u500b\u884c\u70ba\u6211\u5011\u6703\u7a31\u70ba Source NAT (SNAT)\u3002"),(0,r.kt)("p",null,"\u70ba\u4e86\u9054\u6210\u9019\u500b\u76ee\u7684\uff0c\u6211\u5011\u8981\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u7684\u898f\u5247\u4f86\u5e6b\u6211\u5011\u505a\uff0c\u800c ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u6709\u591a\u7a2e\u7528\u6cd5\u53ef\u4ee5\u6eff\u8db3\u9019\u500b\u9700\u6c42\uff0c\u6211\u5011\u6c7a\u5b9a\u63a1\u7528\u6700\u7c21\u55ae\u7684\u4e5f\u662f\u6700\u5e38\u7528\u7684\u65b9\u5f0f, ",(0,r.kt)("strong",{parentName:"p"},"MASQUERADE"),"\uff0c\u9019\u7a2e\u52d5\u614b SNAT \u7684\u529f\u80fd\u4f86\u8655\u7406"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u5de5\u5546\u6211\u7684\u5176\u4ed6\u6587\u7ae0\uff0c\u5f9e Linux Kernel Source Code \u4f86\u63a2\u8a0e\u9019\u500b\u884c\u70ba\uff0c\u4e0d\u9069\u5408\u521d\u5b78\u8005\u770b ",(0,r.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/iptables-masquerade.html"},"Linux NAT Masquerade \u7814\u7a76(\u4e0a)\n"))),(0,r.kt)("p",null,"\u6211\u5011\u4f7f\u7528\u4e0b\u5217\u898f\u5247\uff0c\u544a\u8a34 ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u8aaa\uff0c\u4ee5\u5f8c\u4f60\u53ea\u8981\u770b\u5230 ",(0,r.kt)("strong",{parentName:"p"},"10.55.66.2/32")," \u7684\u5c01\u5305\uff0c\u800c\u4e14\u8981\u5f9e\u5bbf\u4e3b\u6a5f\u4e0a\u9762\u7684 ",(0,r.kt)("strong",{parentName:"p"},"eth0")," \u9001\u51fa\u53bb\u7684\uff0c\u8acb\u4f60\u9806\u4fbf\u5e6b\u5fd9\u4fee\u6539\u5c01\u5305\u4f86\u6e90\uff0c\u6539\u6210\u81ea\u5df1"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ sudo iptables -t nat -I POSTROUTING -s 10.55.66.2/32 -o eth0 -j MASQUERADE\n$ sudo docker exec -it c1 ping 8.8.8.8\nPING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.\n64 bytes from 8.8.8.8: icmp_seq=1 ttl=61 time=18.2 ms\n64 bytes from 8.8.8.8: icmp_seq=2 ttl=61 time=15.0 ms\n^C\n")),(0,r.kt)("p",null,"\u9019\u6642\u5019\u6211\u5011\u518d\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"tcpdump")," \u4f86\u76e3\u807d\u5c01\u5305\uff0c\u5c31\u6703\u89c0\u5bdf\u5230\u4e00\u5207\u90fd\u4e0d\u540c\u4e86!"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ sudo tcpdump -vvvnn -i eth0 icmp\ntcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n19:40:52.893673 IP (tos 0x0, ttl 63, id 39804, offset 0, flags [DF], proto ICMP (1), length 84)\n    10.0.2.15 > 8.8.8.8: ICMP echo request, id 19069, seq 3, length 64\n19:40:52.906130 IP (tos 0x0, ttl 62, id 11543, offset 0, flags [DF], proto ICMP (1), length 84)\n    8.8.8.8 > 10.0.2.15: ICMP echo reply, id 19069, seq 3, length 64\n19:40:54.962322 IP (tos 0x0, ttl 63, id 40179, offset 0, flags [DF], proto ICMP (1), length 84)\n    10.0.2.15 > 8.8.8.8: ICMP echo request, id 19079, seq 1, length 64\n19:40:54.977470 IP (tos 0x0, ttl 62, id 11559, offset 0, flags [DF], proto ICMP (1), length 84)\n    8.8.8.8 > 10.0.2.15: ICMP echo reply, id 19079, seq 1, length 64\n")),(0,r.kt)("p",null,"\u88e1\u9762\u7684\u5167\u5bb9\u6211\u5011\u5206\u6210\u5169\u7b46\u4f86\u770b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"19:40:52.893673 IP (tos 0x0, ttl 63, id 39804, offset 0, flags [DF], proto ICMP (1), length 84)\n    10.0.2.15 > 8.8.8.8: ICMP echo request, id 19069, seq 3, length 64\n")),(0,r.kt)("p",null,"\u6211\u5011\u53ef\u4ee5\u770b\u5230\u51fa\u53bb\u7684\u5c01\u5305 ",(0,r.kt)("strong",{parentName:"p"},"IP")," \u518d\u4e5f\u4e0d\u662f ",(0,r.kt)("strong",{parentName:"p"},"10.55.66.2")," \u4e86\uff0c\u800c\u662f\u5bbf\u4e3b\u6a5f\u672c\u8eab\u7684 ",(0,r.kt)("strong",{parentName:"p"},"10.0.2.15"),"\uff0c\u4f60\u53ef\u80fd\u6703\u60f3\u8aaa ",(0,r.kt)("strong",{parentName:"p"},"10.0.2.15")," \u4e5f\u662f\u79c1\u6709 IP\uff0c\u70ba\u4ec0\u9ebc ",(0,r.kt)("strong",{parentName:"p"},"8.8.8.8")," \u672c\u8eab\u53ef\u4ee5\u56de\u61c9\uff0c\u9019\u662f\u56e0\u70ba\u6211\u7684\u7cfb\u7d71\u74b0\u5883\u5916\u9762\u9084\u6709\u4e00\u5c64 ",(0,r.kt)("strong",{parentName:"p"},"SNAT"),"\uff0c\u4e00\u500b\u5c01\u5305\u7d93\u6b77\u904e\u591a\u6b21 SNAT \u662f\u6eff\u6b63\u5e38\u4e14\u5408\u7406\u7684\uff0c\u4f46\u662f\u6574\u500b\u904b\u4f5c\u908f\u8f2f\u90fd\u662f\u4e00\u81f4\u7684"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"[DF], proto ICMP (1), length 84)\n    8.8.8.8 > 10.0.2.15: ICMP echo reply, id 19069, seq 3, length 64\n")),(0,r.kt)("p",null,"\u9019\u500b\u60c5\u6cc1\u4e0b\u6211\u5011\u4e5f\u53ef\u4ee5\u770b\u5230\u5c01\u5305\u9806\u5229\u56de\u4f86\u4e86\uff0c\u540c\u6642\u5f9e\u5bb9\u5668\u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230 ",(0,r.kt)("strong",{parentName:"p"},"ICMP")," \u6709\u6b63\u5e38\u56de\u61c9\u3002"),(0,r.kt)("p",null,"\u9019\u908a\u88dc\u5145\u4e00\u4e0b\uff0c\u5982\u679c\u6211\u5011\u91dd\u5c0d ",(0,r.kt)("strong",{parentName:"p"},"hwchiu0")," \u9019\u5f35 Linux Bridge \u7684\u7db2\u5361\u53bb\u76e3\u807d\u5c01\u5305\uff0c\u6703\u5f97\u5230\u4e0b\u5217\u8cc7\u8a0a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ sudo tcpdump -vvvnn -i hwchiu0 icmp\ntcpdump: listening on hwchiu0, link-type EN10MB (Ethernet), capture size 262144 bytes\n19:47:55.128471 IP (tos 0x0, ttl 64, id 18861, offset 0, flags [DF], proto ICMP (1), length 84)\n    10.55.66.2 > 8.8.8.8: ICMP echo request, id 19515, seq 1, length 64\n19:47:55.146004 IP (tos 0x0, ttl 61, id 11872, offset 0, flags [DF], proto ICMP (1), length 84)\n    8.8.8.8 > 10.55.66.2: ICMP echo reply, id 19515, seq 1, length 64\n")),(0,r.kt)("p",null,"\u5f9e ",(0,r.kt)("strong",{parentName:"p"},"hwchiu0")," \u7684\u89d2\u5ea6\u4f86\u770b\uff0c\u4ed6\u770b\u5230\u7684\u5c01\u5305\u90fd\u662f ",(0,r.kt)("strong",{parentName:"p"},"10.55.66.2"),"\uff0c\u8ddf\u5bbf\u4e3b\u6a5f\u4e0a\u9762\u7684 IP \u6c92\u6709\u4efb\u4f55\u95dc\u4fc2\u3002"),(0,r.kt)("p",null,"\u6240\u4ee5\u4e0a\u8ff0\u7684\u6982\u5ff5\u6211\u5011\u7528\u4e00\u6a23\u7684\u6d41\u7a0b\u5716\u4f86\u770b\uff0c\u9019\u6642\u5019\u6703\u8b8a\u6210\u600e\u9ebc\u6a23"),(0,r.kt)("p",null,"\u9019\u4efd\u5716\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u9806\u5229\u63a5\u6536\u5c01\u5305\uff0c\u6240\u4ee5\u591a\u4e86\u56de\u4f86\u5c01\u5305\u7684\u8def\u7dda\uff0c\u5176\u4e2d ",(0,r.kt)("strong",{parentName:"p"},"IP")," \u7279\u5225\u7528\u7d05\u8272\u5e95\u6a19\u793a\u4ee3\u8868\u7684\u662f\u8a72\u5c01\u5305\u662f\u6709\u88ab\u6539\u904e\u7684\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/tBBZIn7.jpg",alt:null})),(0,r.kt)("p",null,"\u9019\u908a\u91cd\u65b0\u6574\u7406\u6240\u6709\u601d\u8def\uff0c\u5c07\u5176\u689d\u5217\u4e0b\u4f86"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u5c01\u5305\u6309\u7167\u524d\u9762\u6240\u6709\u6982\u5ff5\uff0c\u4e00\u8def\u9001\u5230 Linux Kernel"),(0,r.kt)("li",{parentName:"ol"},"Linux Kernel \u9019\u6642\u5019\u67e5\u8a62\u5b8c Routing Table \u5f8c\uff0c\u78ba\u8a8d\u5c01\u5305\u8981\u9001\u7d66 ",(0,r.kt)("strong",{parentName:"li"},"eth0")),(0,r.kt)("li",{parentName:"ol"},"iptables \u9019\u6642\u5019\u6703\u4ecb\u5165\uff0c\u900f\u904e ",(0,r.kt)("strong",{parentName:"li"},"MASQUERADE")," \u7684\u529f\u80fd\u4f86\u4fee\u6539\u5c01\u5305\u7684\u4f86\u6e90 ip \u5730\u5740"),(0,r.kt)("li",{parentName:"ol"},"\u5c01\u5305\u7684\u4f86\u6e90\u88ab\u4fee\u6539\u6210 ",(0,r.kt)("strong",{parentName:"li"},"10.0.2.15"),"\uff0c\u6700\u5f8c ",(0,r.kt)("strong",{parentName:"li"},"8.8.8.8")," \u6536\u5230\u9019\u4e9b\u5c01\u5305\u5f8c\u4e00\u8def\u9001\u56de\u4f86"),(0,r.kt)("li",{parentName:"ol"},"\u56de\u61c9\u7684\u5c01\u5305\u5230\u9054 ",(0,r.kt)("strong",{parentName:"li"},"eth0")," \u4e4b\u5f8c\uff0c",(0,r.kt)("strong",{parentName:"li"},"iptables")," \u518d\u5ea6\u4ecb\u5165\uff0c\u7562\u7adf\u8ab0\u5e6b\u4f60\u8f49\u63db\u5c01\u5305\uff0c\u8ab0\u5c31\u8981\u5e6b\u4f60\u8f49\u56de\u4f86\uff0c\u5e6b\u4f60\u628a\u5c01\u5305\u7684\u76ee\u6a19\u5f9e ",(0,r.kt)("strong",{parentName:"li"},"10.0.2.15")," \u8f49\u56de\u6700\u521d\u7684 ",(0,r.kt)("strong",{parentName:"li"},"10.55.66.2"),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},"\u5176\u5be6\u66f4\u7cbe\u6e96\u7684\u8aaa\u9019\u908a\u9084\u6709 conntrack \u7684\u4ecb\u5165\u4f86\u8655\u7406\uff0c\u4f46\u662f\u904e\u65bc\u8907\u96dc\uff0c\u56e0\u6b64\u9019\u908a\u5ffd\u7565\uff0c\u6211\u5011\u61c2\u5927\u6982\u5ff5\u5c31\u597d"))),(0,r.kt)("li",{parentName:"ol"},"\u5c01\u5305\u4e00\u8def\u900f\u904e Linux Bridge + Forwardnig Table + Veth \u7b49\u5143\u4ef6\u56de\u5230\u5bb9\u5668\u624b\u4e0a")),(0,r.kt)("h2",{id:"\u8ab0\u4f86\u904e\u6ffe\u5c01\u5305-1"},"\u8ab0\u4f86\u904e\u6ffe\u5c01\u5305"),(0,r.kt)("p",null,"\u5230\u9019\u908a\u70ba\u6b62\uff0c\u57fa\u672c\u4e0a\u6211\u5011\u7684\u5bb9\u5668\u5df2\u7d93\u53ef\u4ee5\u5c0d\u5916\u5b58\u53d6\u4e86\uff0c\u4f46\u662f\u9019\u908a\u6709\u500b\u524d\u63d0\u662f\uff0c\u6211\u5011\u4e8b\u5148\u4fee\u6539 ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u7684\u898f\u5247\uff0c\u8b93\u4ed6\u9810\u8a2d\u662f\u8f49\u9001\u5c01\u5305\uff0c\u800c\u4e0d\u662f\u4e1f\u68c4"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Docker \u5b89\u88dd\u5b8c\u7562\u5f8c\uff0c\u6703\u8b93 iptables ",(0,r.kt)("strong",{parentName:"p"},"FORWARD")," \u9810\u8a2d\u4e1f\u68c4\u5c01\u5305\uff0c\u6240\u4ee5 docker \u6703\u91dd\u5c0d\u9019\u4e00\u584a\u53bb\u64b0\u5beb\u898f\u5247\u8b93\u4f60\u7684\u5bb9\u5668\u53ef\u4ee5\u5c0d\u5916\u4e0a\u7db2")),(0,r.kt)("p",null,"\u56e0\u6b64\u9019\u500b\u5c0f\u7bc0\u6211\u5011\u5c31\u4f86\u770b\u770b\uff0c\u8981\u5982\u4f55\u900f\u904e iptables \u4f86\u5141\u8a31\u6211\u5011\u7684\u5c01\u5305\u901a\u904e"),(0,r.kt)("p",null,"\u6839\u64da\u6211\u5011\u524d\u9762\u7684\u6d41\u7a0b\u52a0\u4e0a\u6700\u521d\u7684\u904b\u4f5c\uff0c\u5176\u5be6 iptables \u904b\u4f5c\u7684\u5730\u65b9\u6709\u5169\u500b"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Linux Bridge \u9019\u908a\u6703\u5077\u5077\u8acb iptables \u8655\u7406\u4e00\u6b21"),(0,r.kt)("li",{parentName:"ol"},"Linux Kernel \u5f80\u5bbf\u4e3b\u6a5f eth0 \u9019\u908a\u767c\u9001\u6642\u4e5f\u6703\u6709\u4e00\u6b21")),(0,r.kt)("p",null,'\u9019\u5169\u500b\u74b0\u7bc0\u65bc\u9019\u500b\u60c5\u5883\u4e0b\uff0c\u6982\u5ff5\u5b8c\u5168\u4e0d\u540c\u3002\n\u5c0d\u65bc Linux Bridge(hwchiu0) \u4f86\u8aaa\uff0c\u5bb9\u5668\u7684\u5c01\u5305\u6703\u5230\u9054\u4ed6\u8eab\u4e0a\uff0c\u9019\u908a\u662f"\u5230\u9054"\u4ed6\u8eab\u4e0a\uff0c\u56e0\u6b64 ',(0,r.kt)("strong",{parentName:"p"},"iptables")," \u5167\u7684\u898f\u5247\u5c31\u4e0d\u662f ",(0,r.kt)("strong",{parentName:"p"},"FORWARD")," \u9019\u7a2e\u8f49\u767c\u6982\u5ff5\u4f86\u8655\u7406\uff0c\u800c\u662f ",(0,r.kt)("strong",{parentName:"p"},"INPUT")," \u4f86\u8655\u7406\u3002\u56e0\u6b64\u9019\u908a\u6211\u5011\u5c31\u4e0d\u9700\u8981\u7279\u5225\u8655\u7406"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"INPUT chain \u672c\u8eab\u6c92\u6709\u88ab\u6539\u6210\u9810\u8a2d\u4e1f\u68c4\uff0c\u56e0\u6b64\u90fd\u6703\u901a")),(0,r.kt)("p",null,"\u76f8\u53cd\u7684\uff0c\u7b2c\u4e8c\u500b\u6d41\u7a0b\u662f ",(0,r.kt)("strong",{parentName:"p"},"LINUX KERNEL")," \u8f49\u767c\u5c01\u5305\uff0c\u5f9e ",(0,r.kt)("strong",{parentName:"p"},"eth0")," \u51fa\u767c\uff0c\u56e0\u6b64\u9019\u908a ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u7684 ",(0,r.kt)("strong",{parentName:"p"},"FORWARD")," \u898f\u5247\u8868\u5c31\u8981\u88ab\u8003\u616e\uff0c\u6240\u4ee5\u6211\u5011\u8981\u8655\u7406\u7684\u5c31\u662f\u9019\u4e00\u6bb5\u904e\u7a0b"),(0,r.kt)("p",null,"\u9996\u5148\u6211\u5011\u5c07 ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u4e2d\u7684 ",(0,r.kt)("strong",{parentName:"p"},"FORWARD")," \u4fee\u6539\u56de\u9810\u8a2d\u4e1f\u68c4\u5c01\u5305\uff0c\u56de\u6b78\u5230\u5b89\u88dd\u597d ",(0,r.kt)("strong",{parentName:"p"},"docker")," \u7684\u8a2d\u5b9a\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ sudo iptables -P FORWARD DROP\n$ sudo docker exec -it c1 ping 8.8.8.8\n")),(0,r.kt)("p",null,"\u9019\u6642\u5019\u4f60\u6703\u767c\u73fe\u5c01\u5305\u4e0d\u6703\u901a\uff0c\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"tcpdump")," \u53bb\u76e3\u807d ",(0,r.kt)("strong",{parentName:"p"},"eth0")," \u7684\u5c01\u5305\u4e5f\u6c92\u6709\u4efb\u4f55\u8a0a\u606f\uff0c\u4e0d\u904e\u82e5\u662f\u76e3\u807d ",(0,r.kt)("strong",{parentName:"p"},"hwchiu0")," \u5247\u662f\u6703\u6709\u5c01\u5305"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ sudo tcpdump -vvvnn -i eth0 icmp\ntcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n^C\n0 packets captured\n0 packets received by filter\n0 packets dropped by kernel\n\n$ sudo tcpdump -vvvnn -i hwchiu0 icmp\ntcpdump: listening on hwchiu0, link-type EN10MB (Ethernet), capture size 262144 bytes\n20:16:28.313865 IP (tos 0x0, ttl 64, id 60164, offset 0, flags [DF], proto ICMP (1), length 84)\n    10.55.66.2 > 8.8.8.8: ICMP echo request, id 21202, seq 33, length 64\n")),(0,r.kt)("p",null,"\u6240\u4ee5\u6211\u5011\u8981\u900f\u904e ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u544a\u8a34\u7cfb\u7d71\uff0c\u8acb\u5141\u8a31\u6211\u5011\u7684\u5c01\u5305\u901a\u904e\uff0c\u9019\u908a\u6709\u975e\u5e38\u591a\u7a2e\u601d\u8def"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u91dd\u5c0d\u4f86\u6e90\u8207\u76ee\u7684 IP \u53bb\u8655\u7406"),(0,r.kt)("li",{parentName:"ol"},"\u91dd\u5c0d\u4f86\u6e90\u8207\u76ee\u7684 \u7db2\u5361 \u53bb\u8655\u7406")),(0,r.kt)("p",null,"\u7528\u7db2\u5361\u6703\u7c21\u55ae\u5f88\u591a\uff0c\u9019\u90e8\u4efd\u6c92\u6709\u4e00\u5b9a\uff0c\u5b8c\u5168\u770b\u4f60\u8a2d\u8a08\uff0c ",(0,r.kt)("strong",{parentName:"p"},"docker")," \u6703\u4f7f\u7528\u7db2\u5361\u4f86\u8655\u7406\uff0c\u9019\u6a23\u898f\u5247\u6578\u91cf\u4e0d\u6703\u56e0\u70ba\u5bb9\u5668\u904e\u591a\u800c\u8b8a\u591a\u3002"),(0,r.kt)("p",null,"\u4ee5\u4e0b\u662f\u6211\u5011\u4f7f\u7528\u7684\u898f\u5247\uff0c\u6211\u5011\u544a\u8a34 ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u8aaa"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u5f9e hwchiu0 \u5230 eth0 \u7684\u5c01\u5305\uff0c\u7d66\u4ed6\u904e\uff01"),(0,r.kt)("li",{parentName:"ol"},"\u5f9e eth0 \u5230 hwchiu0 \u7684\u5c01\u5305\uff0c\u7d66\u4ed6\u904e !")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ sudo iptables -t filter -I FORWARD -i hwchiu0 -o eth0 -j ACCEPT\n$ sudo iptables -t filter -I FORWARD -i eth0 -o hwchiu0 -j ACCEPT\n$ sudo docker exec -it c1 ping 8.8.8.8\nPING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.\n64 bytes from 8.8.8.8: icmp_seq=1 ttl=61 time=16.3 ms\n64 bytes from 8.8.8.8: icmp_seq=2 ttl=61 time=15.8 ms\n")),(0,r.kt)("p",null,"\u9019\u6642\u5f8c\u4f86\u770b\u67b6\u69cb\u5716\uff0c\u9019\u500b\u7bc4\u4f8b\u4e2d\uff0c iptables \u6703\u6709\u5169\u500b\u5730\u65b9\u5e72\u6d89\uff0c\u5206\u5225\u662f\u9032\u5165\u5230 hwchiu0 \u4ee5\u53ca\u5bbf\u4e3b\u6a5f eth0 \u5169\u500b\u5730\u65b9\u3002\n\u4f46\u662f\u5169\u500b\u5730\u65b9\u56e0\u70ba\u6982\u5ff5\u4e0d\u540c\uff0c\u4f7f\u7528\u7684\u662f iptables \u4e0b\u4e0d\u540c\u7684\u8868\uff0c\u800c\u6211\u5011\u9019\u908a\u91dd\u5c0d FORWARD \u8868\u53bb\u8655\u7406\uff0c\u56e0\u70ba\u5176\u9810\u8a2d\u662f\u4e1f\u68c4\u5c01\u5305\n",(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/ZyOxFzc.jpg",alt:null})),(0,r.kt)("h2",{id:"\u7e3d\u7d50"},"\u7e3d\u7d50"),(0,r.kt)("p",null,"\u5230\u9019\u908a\u70ba\u6b62\uff0c\u6211\u76e1\u53ef\u80fd\u7684\u7528\u7c21\u55ae\u7684\u65b9\u5f0f\u53bb\u63cf\u8ff0\uff0c\u5230\u5e95\u4e00\u500b\u5bb9\u5668\u8981\u5c0d\u5916\u4e0a\u7db2\u4e2d\u9593\u6703\u767c\u751f\u4ec0\u9ebc\u4e8b\u60c5\uff0c\u800c\u9019\u4e9b\u4e8b\u60c5\u5e73\u5e38\u6211\u5011\u90fd\u6c92\u6709\u611f\u89ba\uff0c\u662f\u56e0\u70ba ",(0,r.kt)("strong",{parentName:"p"},"docker")," \u672c\u8eab\u90fd\u5e6b\u6211\u5011\u8655\u7406\u5b8c\u7562\u4e86\uff0c\u6574\u9ad4\u601d\u8def\u90fd\u5b8c\u5168\u4e00\u6a23\uff0c\u4e0d\u904e\u5c0d\u65bc ",(0,r.kt)("strong",{parentName:"p"},"iptables")," \u7684\u898f\u5247\u6703\u56e0\u70ba\u7d30\u5ea6\u4e0d\u540c\uff0c\u6240\u4ee5\u4e0b\u6cd5\u4e5f\u4e0d\u592a\u4e00\u6a23\u3002"),(0,r.kt)("h1",{id:"\u7e3d\u7d50-1"},"\u7e3d\u7d50"),(0,r.kt)("p",null,"\u7531\u65bc\u672c\u7bc7\u6587\u7ae0\u5df2\u7d93\u904e\u9577\uff0c\u56e0\u6b64\u5982\u4f55\u5f9e\u5916\u90e8\u5b58\u53d6\u5bb9\u5668\u5c31\u7559\u5230\u4e0b\u7bc7\u6587\u7ae0\u518d\u4f86\u5206\u4eab"),(0,r.kt)("p",null,"\u7d9c\u5408\u672c\u6587\u8207\u524d\u6587\uff0c\u9019\u908a\u5e6b\u5927\u5bb6\u6574\u7406\u4e00\u4e0b\uff0c\u57fa\u65bc ",(0,r.kt)("strong",{parentName:"p"},"Bridge")," \u7db2\u8def\u6a21\u578b\u4e0b\uff0c Docker \u5bb9\u5668\u662f\u5982\u4f55\u5c0d\u5916\u4e0a\u7db2"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u64c1\u6709 Linux Bridge\uff0c\u4e26\u4e14\u8a2d\u5b9a\u4e00\u500b IP"),(0,r.kt)("li",{parentName:"ol"},"\u5275\u9020\u5bb9\u5668\uff0c\u900f\u904e veth \u5c07\u5bb9\u5668\u8207\u5bbf\u4e3b\u6a5f\u7684 Linux Bridge \u9023\u63a5"),(0,r.kt)("li",{parentName:"ol"},"\u5c0d\u5bb9\u5668\u5167\u7684\u7db2\u5361\u8a2d\u5b9a IP\uff0c\u4e26\u4e14\u8a2d\u5b9a\u4e00\u500b\u9810\u8a2d\u8def\u7531\u898f\u5247\uff0c\u8b93 Linux Bridge \u5e6b\u5fd9\u8f49\u767c\u5c0d\u5916\u5c01\u5305"),(0,r.kt)("li",{parentName:"ol"},"\u8a2d\u5b9a\u76f8\u95dc iptables \u898f\u5247\uff0c\u8b93\u7cfb\u7d71\u8f49\u767c\u6642\uff0c\u5c01\u5305\u4e0d\u6703\u88ab\u4e1f\u68c4"),(0,r.kt)("li",{parentName:"ol"},"\u8a2d\u5b9a iptables SNAT \u898f\u5247\uff0c\u8b93\u6211\u5011\u5f80\u5916\u7684\u5c01\u5305\u80fd\u5920\u6709\u6a5f\u6703\u56de\u4f86\uff0c\u6700\u5f8c\u8f3e\u8f49\u56de\u5230\u5bb9\u5668\u624b\u4e0a")),(0,r.kt)("p",null,"\u9019\u4e00\u7cfb\u5217\u7684\u898f\u5247\u770b\u8d77\u4f86\u5f88\u591a\uff0c\u4f46\u662f\u5176\u5be6\u6574\u9ad4\u90fd\u570d\u7e5e\u518d TCP/IP \u7684\u7db2\u8def\u898f\u5247\u4e0b\uff0c\u7c21\u55ae\u7684\u8aaa\u5c31\u662f\n\u5c01\u5305\u8a72\u600e\u9ebc\u8d70\uff0c\u8ab0\u5e6b\u5fd9\u8655\u7406\u5c01\u5305\uff0c\u6703\u4e0d\u6703\u6709\u4eba\u6514\u622a\u5c01\u5305\n\u5c07\u9019\u4e09\u500b\u601d\u8def\u6574\u7406\u4e0b\u4f86\uff0c\u5c31\u53ef\u4ee5\u5f88\u6e05\u6670\u7684\u53bb\u5206\u6790\u5c01\u5305\u7684\u8d70\u5411\u8207\u9664\u932f"))}c.isMDXComponent=!0}}]);