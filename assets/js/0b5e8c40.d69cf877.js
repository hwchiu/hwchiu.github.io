"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[41949],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>g});var r=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=r.createContext({}),d=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},p=function(e){var n=d(e.components);return r.createElement(s.Provider,{value:n},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=d(t),m=i,g=u["".concat(s,".").concat(m)]||u[m]||c[m]||o;return t?r.createElement(g,a(a({ref:n},p),{},{components:t})):r.createElement(g,a({ref:n},p))}));function g(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var o=t.length,a=new Array(o);a[0]=m;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[u]="string"==typeof e?e:i,a[1]=l;for(var d=2;d<o;d++)a[d]=t[d];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},80524:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>a,default:()=>c,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var r=t(87462),i=(t(67294),t(3905));const o={slug:"k8s-pod-affinity-1",title:"\u89e3\u5bc6 Assigning Pod To Nodes(\u4e0a)",keywords:["Kubernetes","DevOps","PodAffinity"],date:new Date("2023-08-05T04:06:15.000Z"),authors:"hwchiu",tags:["Kubernetes","DevOps"],description:"\u63a2\u8a0e Kubernetes \u5167\u5982\u4f55\u63a7\u5236 Pod \u8207\u7bc0\u9ede\u7684\u5206\u914d\u95dc\u4fc2"},a="Preface",l={unversionedId:"techPost/2023/k8s-assigning-pod",id:"techPost/2023/k8s-assigning-pod",title:"\u89e3\u5bc6 Assigning Pod To Nodes(\u4e0a)",description:"\u63a2\u8a0e Kubernetes \u5167\u5982\u4f55\u63a7\u5236 Pod \u8207\u7bc0\u9ede\u7684\u5206\u914d\u95dc\u4fc2",source:"@site/docs/techPost/2023/k8s-assigning-pod.md",sourceDirName:"techPost/2023",slug:"/techPost/2023/k8s-pod-affinity-1",permalink:"/docs/techPost/2023/k8s-pod-affinity-1",draft:!1,tags:[{label:"Kubernetes",permalink:"/docs/tags/kubernetes"},{label:"DevOps",permalink:"/docs/tags/dev-ops"}],version:"current",frontMatter:{slug:"k8s-pod-affinity-1",title:"\u89e3\u5bc6 Assigning Pod To Nodes(\u4e0a)",keywords:["Kubernetes","DevOps","PodAffinity"],date:"2023-08-05T04:06:15.000Z",authors:"hwchiu",tags:["Kubernetes","DevOps"],description:"\u63a2\u8a0e Kubernetes \u5167\u5982\u4f55\u63a7\u5236 Pod \u8207\u7bc0\u9ede\u7684\u5206\u914d\u95dc\u4fc2"},sidebar:"techPost",previous:{title:"\u89e3\u5bc6 Assigning Pod To Nodes(\u4e0b)",permalink:"/docs/techPost/2023/k8s-pod-affinity-2"},next:{title:"\u8b93\u4f60\u7684 Container Image \u9003\u812b Kubelet Image GC \u7684\u9b54\u638c",permalink:"/docs/techPost/2023/k8s-gc"}},s={},d=[{value:"requiredDuringSchedulingIgnoredDuringExecution",id:"requiredduringschedulingignoredduringexecution",level:2},{value:"preferredDuringSchedulingIgnoredDuringExecution",id:"preferredduringschedulingignoredduringexecution",level:2}],p={toc:d},u="wrapper";function c(e){let{components:n,...t}=e;return(0,i.kt)(u,(0,r.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"preface"},"Preface"),(0,i.kt)("p",null,"\u672c\u7bc7\u6587\u7ae0\u8981\u4f86\u63a2\u8a0e Kubernetes \u4e2d\u6709\u54ea\u4e9b\u65b9\u5f0f\u53ef\u4ee5\u7528\u4f86\u5f71\u97ff Pod \u8207 Node \u4e4b\u9593\u7684\u5206\u914d\u95dc\u4fc2\u3002"),(0,i.kt)("p",null,"\u7531\u65bc Kubernetes \u672c\u8eab\u53ef\u4ee5\u7ba1\u7406\u591a\u500b\u7bc0\u9ede\uff0c\u800c\u7bc0\u9ede\u672c\u8eab\u53ef\u4ee5\u6709\u4e0d\u540c\u7684\u7279\u6027\uff0c\u56e0\u6b64\u4e0d\u540c\u60c5\u5883\u4e0b\u53ef\u80fd\u5c31\u6703\u5e0c\u671b\u5c07 Pod \u7d66\u5206\u914d\u5230\u7279\u5b9a\u7684\u7bc0\u9ede\uff0c\u8b6c\u5982"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"CPU/Memory "),(0,i.kt)("li",{parentName:"ol"},"Disk \u5927\u5c0f\u8207\u901f\u5ea6"),(0,i.kt)("li",{parentName:"ol"},"\u7db2\u5361\u901f\u5ea6"),(0,i.kt)("li",{parentName:"ol"},"\u5176\u4ed6\u7279\u6b8a\u88dd\u7f6e")),(0,i.kt)("p",null,"\u9664\u4e86\u55ae\u7d14\u8003\u616e\u7bc0\u9ede\u80fd\u529b\u5916\uff0c\u5f88\u591a\u6642\u5019\u9084\u6703\u8003\u91cf\u5230\u6240\u8b02\u7684\u9ad8\u53ef\u7528\u6027\uff0c\u7279\u5225\u662f\u96f2\u7aef\u74b0\u5883\u4e0b\u7bc0\u9ede\u9084\u6703\u6709\u6240\u8b02\u7684 AZ(Availabilty Zone) \u7684\u7279\u6027\uff0c\u56e0\u6b64\u5c31\u6703\u6709"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u5e0c\u671b Pod \u53ef\u4ee5\u5747\u52fb\u5206\u5e03\u5230\u4e0d\u540c Zone"),(0,i.kt)("li",{parentName:"ol"},"\u5e0c\u671b\u4e0d\u540c\u670d\u52d9\u76e1\u53ef\u80fd\u90e8\u7f72\u5230\u540c Zone")),(0,i.kt)("p",null,"\u5176\u4e2d(2)\u7684\u8003\u91cf\u662f\u90e8\u5206\u696d\u8005\u5247\u662f\u6703\u91dd\u5c0d\u8de8 Zone \u7684\u6d41\u91cf\u53bb\u6536\u8cbb\uff0c\u56e0\u6b64\u5be6\u52d9\u4e0a\u5176\u5be6\u6709\u5404\u5f0f\u5404\u6a23\u7684\u60c5\u5883\u9700\u8981\u4f86\u8abf\u6574\u5206\u914d\u7684\u65b9\u5f0f"),(0,i.kt)("h1",{id:"environment"},"Environment"),(0,i.kt)("p",null,"\u63a5\u4e0b\u4f86\u6240\u63a2\u8a0e\u7684\u5be6\u9a57\u74b0\u5883\u90fd\u6703\u4f7f\u7528\u57fa\u65bc ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/kubernetes-sigs/kind?WT.mc_id=AZ-MVP-5003331"},"KIND 0.18.0")," \u6240\u7522\u751f\u7684 K8s v1.26.0\uff0c\u8a72 K8s \u53e2\u96c6\u7531\u4e00\u500b\u63a7\u5236\u7bc0\u9ede\u52a0\u4e0a\u56db\u500b\u5de5\u4f5c\u7bc0\u9ede\u7d44\u6210\u3002\n\u9664\u4e86\u57fa\u672c\u7684 Label \u5916\u9084\u984d\u5916\u8a2d\u5b9a\u4e86\u57fa\u65bc Zone \u7684 Label \u4f86\u6a21\u64ec\u74b0\u5883\u3002"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://hackmd.io/_uploads/B1ElQ3con.png",alt:null})),(0,i.kt)("h1",{id:"nodename"},"NodeName"),(0,i.kt)("p",null,"\u4e00\u822c\u4f86\u8aaa Pod \u7684\u8abf\u5ea6\u6703\u7d93\u7531 Scheduler \u6c7a\u5b9a\uff0c\u4e26\u4e14\u6c7a\u5b9a\u5f8c\u52d5\u614b\u7684\u4fee\u6539 pod.spec.nodeName \u9019\u500b\u6b04\u4f4d\uff0c\u6700\u5f8c\u5c31\u7531\u8a72\u7bc0\u9ede\u4e0a\u7684 Kubelet \u4f86\u90e8\u7f72 Pod\u3002\n\u800c\u5be6\u969b\u4e0a\u6211\u5011\u4e5f\u53ef\u4ee5\u76f4\u63a5\u8a2d\u5b9a pod.spec.nodeName \u9019\u500b\u6b04\u4f4d\u4f86\u9054\u5230\u5f37\u8feb\u6307\u5b9a\u7bc0\u9ede\u7684\u65b9\u5f0f\uff0c\u9019\u500b\u65b9\u5f0f\u662f\u6700\u76f4\u63a5\u4e14\u6700\u9ad8\u512a\u5148\u5ea6\uff0c\u6703\u76f4\u63a5\u8df3\u904e Scheduler \u7684\u6c7a\u7b56\u904e\u7a0b\uff0c\u53e6\u5916\u5982\u679c\u76ee\u6a19\u7bc0\u9ede\u4e0d\u5b58\u5728\uff0c\u5247 Pod \u6703\u9677\u5165 Pending \u7684\u72c0\u614b\u7121\u6cd5\u90e8\u7f72"),(0,i.kt)("p",null,"\u4f7f\u7528\u4e0a\u8981\u7279\u5225\u6ce8\u610f"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u5982\u679c K8s \u672c\u8eab\u6709\u8a2d\u5b9a ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/kubernetes/autoscaler?WT.mc_id=AZ-MVP-5003331"},"Cluster AutoScaler")," \u540c\u6642\u7522\u751f\u7684\u7bc0\u9ede\u90fd\u662f\u4e82\u6578\u540d\u7a31\uff0c\u90a3\u4f7f\u7528 nodeName \u5c31\u6703\u8b8a\u5f97\u975e\u5e38\u5371\u96aa"),(0,i.kt)("li",{parentName:"ol"},"\u4f7f\u7528\u4e0a\u975e\u5e38\u6c92\u6709\u5f48\u6027\uff0c\u56e0\u6b64\u5927\u90e8\u5206\u60c5\u6cc1\u90fd\u4e0d\u6703\u4f7f\u7528\u9019\u500b\u65b9\u5f0f")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml="},"apiVersion: v1\nkind: Pod\nmetadata:\n  name: nodename-pod\nspec:\n  nodeName: k8slab-worker\n  containers:\n    - name: server\n      image: hwchiu/netutils\n")),(0,i.kt)("p",null,"\u4ee5\u4e0a\u8ff0\u7bc4\u4f8b\u4f86\u90e8\u7f72\uff0c Pod \u6703\u76f4\u63a5\u88ab\u6307\u5b9a\u5230 k8slab-worker \u6b64\u7bc0\u9ede\uff0c\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl describe pod")," \u5c31\u4e0d\u6703\u770b\u5230\u4efb\u4f55\u8ddf scheduler \u6709\u95dc\u7684\u4e8b\u4ef6"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://hackmd.io/_uploads/HkNWFVjs2.png",alt:null})),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'Events:\n  Type    Reason   Age   From     Message\n  ----    ------   ----  ----     -------\n  Normal  Pulling  90s   kubelet  Pulling image "hwchiu/netutils"\n  Normal  Pulled   88s   kubelet  Successfully pulled image "hwchiu/netutils" in 1.582945894s (1.582973894s including waiting)\n  Normal  Created  88s   kubelet  Created container server\n  Normal  Started  88s   kubelet  Started container server\n')),(0,i.kt)("h1",{id:"nodeselector"},"NodeSelector"),(0,i.kt)("p",null,"\u76f8\u8f03\u65bc NodeName \u7c21\u55ae\u76f4\u63a5\u7684\u7528\u6cd5\uff0c NodeSelector \u5247\u662f\u57fa\u65bc Node Label \u7684\u7b56\u7565\u63d0\u4f9b\u975e\u5e38\u7c21\u55ae\u7684\u9078\u64c7\u7b56\u7565\uff0c"),(0,i.kt)("p",null,"\u4f7f\u7528\u65b9\u5f0f\u975e\u5e38\u7c21\u55ae\uff0c\u91dd\u5c0d pod.spec.nodeSelector \u53bb\u8a2d\u5b9a\u76ee\u6a19 label\uff0c\u5247 Schedule \u5c31\u6703\u57fa\u65bc\u6b64\u8a2d\u5b9a\u53bb\u904e\u6ffe\u6389\u6240\u6709\u4e0d\u7b26\u5408\u7684\u7bc0\u9ede\u3002"),(0,i.kt)("p",null,"\u8209\u4f8b\u4f86\u8aaa\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"kind.zone: zone1")," \u9019\u500b\u7bc0\u9ede\u7576\u7bc4\u4f8b\uff0c\u9019\u7a2e\u60c5\u6cc1\u4e0b\u6240\u6709 ",(0,i.kt)("inlineCode",{parentName:"p"},"kind-worker")," \u4ee5\u53ca ",(0,i.kt)("inlineCode",{parentName:"p"},"kind-worker2")," \u5c31\u6703\u662f\u6700\u7d42\u7bc0\u9ede\u7684\u5019\u9078\u4eba"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml="},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: node-selector\nspec:\n  replicas: 10\n  selector:\n    matchLabels:\n      app: nodeSelector\n  template:\n    metadata:\n      labels:\n        app: nodeSelector\n    spec:\n      containers:\n        - name: www-server\n          image: hwchiu/netutils\n      nodeSelector:\n        kind.zone: zone1\n")),(0,i.kt)("p",null,"\u4ee5\u4e0a\u8ff0 10 \u500b Pod \u70ba\u7bc4\u4f8b\u53bb\u90e8\u7f72\uff0c\u53ef\u4ee5\u89c0\u5bdf\u5230\u9019 10 \u500b Pod \u90fd\u6703\u5ea7\u843d\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"kind.zone: zone1")," \u9019\u500b\u5340\u9593"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://hackmd.io/_uploads/Skn-9Vjoh.png",alt:null})),(0,i.kt)("p",null,"\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f NodeSelector \u7684\u689d\u4ef6\u662f\u5fc5\u9808\u7b26\u5408\u7684\uff0c\u56e0\u6b64\u82e5\u627e\u4e0d\u5230\u4efb\u4f55\u7b26\u5408\u8a72\u9700\u6c42\u7684\u7bc0\u9ede\uff0c\u5247 Pod \u5c31\u7121\u6cd5\u9806\u5229\u904b\u884c\uff0c\u6703\u5361\u5728 Pending \u7684\u72c0\u614b"),(0,i.kt)("h1",{id:"nodeaffinity"},"NodeAffinity"),(0,i.kt)("p",null,'Node Affinity \u53ef\u4ee5\u8996\u70ba NodeSelector \u7684\u52a0\u5f37\u7248\uff0c\u4e00\u6a23\u662f\u57fa\u65bc Node Label \u4f86\u9078\u64c7\u7bc0\u9ede\u4f46\u662f\u63d0\u4f9b\u66f4\u7d30\u90e8\u7684\u64cd\u4f5c\uff0c\u9664\u4e86\u5169\u7a2e\u4e0d\u540c\u7684\u9078\u64c7\u7b56\u7565\u5916\uff0c\u5c0d\u65bc Label \u7684\u6c7a\u7b56\u65b9\u5f0f\u4e5f\u66f4\u52a0\u5f48\u6027\uff0c\u4e0d\u662f\u55ae\u7d14\u7684 "Equal" \u53bb\u6bd4\u8f03\u800c\u5df2\u3002'),(0,i.kt)("p",null,"\u76ee\u524d\u5176\u63d0\u4f9b\u5169\u7a2e\u9078\u64c7\u7b56\u7565\uff0c\u5206\u5225\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"requiredDuringSchedulingIgnoredDuringExecution")," \u4ee5\u53ca ",(0,i.kt)("inlineCode",{parentName:"p"},"preferredDuringSchedulingIgnoredDuringExecution"),"."),(0,i.kt)("p",null,"requiredDuringSchedulingIgnoredDuringExecution \u7684\u6982\u5ff5\u8207\u539f\u5148\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"NodeSelector")," \u985e\u4f3c\uff0c\u662f\u500b\u786c\u6027\u689d\u4ef6\uff0c\u82e5\u6c92\u6709\u4efb\u4f55\u7bc0\u9ede\u7b26\u5408\u689d\u4ef6\u5247 Pod \u5c31\u6703\u8655\u65bc Pending \u72c0\u614b\u3002"),(0,i.kt)("p",null,"preferredDuringSchedulingIgnoredDuringExecution \u5247\u662f\u76f8\u8f03\u65bc\u5f48\u6027\uff0c\u5c31\u662f\u76e1\u91cf\u6eff\u8db3\u5373\u53ef\uff0c\u82e5\u6c92\u6709\u6eff\u8db3\u5247\u5c31\u6309\u7167\u672c\u4f86 Scheduling \u7684\u65b9\u5f0f\u53bb\u8655\u7406"),(0,i.kt)("p",null,"\u6b64\u5916\uff0c\u7531\u65bc\u9019\u985e\u578b\u7684\u64cd\u4f5c\u90fd\u8ddf Node Label \u6709\u95dc\u4fc2\uff0c\u56e0\u6b64\u52e2\u5fc5\u6703\u6709\u4eba\u597d\u5947\u82e5\u52d5\u614b\u8abf\u6574 Node Label \u6703\u5f71\u97ff\u7576\u524d\u904b\u884c\u7684 Pod \u55ce\uff1f\n\u56e0\u6b64 ",(0,i.kt)("inlineCode",{parentName:"p"},"IgnoredDuringExecution")," \u9019\u500b\u542b\u610f\u5c31\u662f\u5b57\u9762\u4e0a\u7684\u610f\u601d\uff0c\u9019\u4e9b\u6c7a\u7b56\u90fd\u6703\u5ffd\u7565\u57f7\u884c\u671f\u9593\u7684 Label \u8b8a\u52d5\uff0c\u4e00\u65e6 Pod \u88ab\u9078\u5b9a\u6307\u6d3e\u5f8c\uff0cScheduler \u5c31\u4e0d\u6703\u53bb\u5e72\u6d89\u4e86\u3002"),(0,i.kt)("h2",{id:"requiredduringschedulingignoredduringexecution"},"requiredDuringSchedulingIgnoredDuringExecution"),(0,i.kt)("p",null,"\u6240\u6709\u4e0d\u719f\u6089\u7684\u6b04\u4f4d\u90fd\u5efa\u8b70\u900f\u904e ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl explain")," \u4f86\u95b1\u8b80\u4e00\u4e0b\u5176\u6982\u5ff5\u53ca\u7528\u6cd5\uff0c\u4ee5\u4e0b\u8ff0\u7bc4\u4f8b\u53ef\u4ee5\u89c0\u5bdf\u5230"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"requiredDuringSchedulingIgnoredDuringExecution")," \u5e95\u4e0b\u8981\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"nodeSelectorTerms"),' \u4ee5 list \u7684\u5f62\u5f0f\u53bb\u63cf\u8ff0\u7b26\u5408\u7684\u7bc0\u9ede\u8cc7\u8a0a\uff0c\u82e5\u63cf\u8ff0\u591a\u500b\u8cc7\u8a0a\u5247\u5f7c\u6b64\u7684\u904b\u7b97\u95dc\u4fc2\u70ba "OR"\uff0c\u9019\u610f\u5473\u7bc0\u9ede\u53ea\u8981\u6709\u7b26\u5408\u5176\u4e2d\u4e00\u500b\u95dc\u4fc2\uff0c\u5c31\u53ef\u4ee5\u88ab Scheduler \u7d66\u7d0d\u5165\u8003\u616e\u3002\n2')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell="},"$ kubectl explain pod.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution\nKIND:     Pod\nVERSION:  v1\n\nRESOURCE: requiredDuringSchedulingIgnoredDuringExecution <Object>\n\nDESCRIPTION:\n     If the affinity requirements specified by this field are not met at\n     scheduling time, the pod will not be scheduled onto the node. If the\n     affinity requirements specified by this field cease to be met at some point\n     during pod execution (e.g. due to an update), the system may or may not try\n     to eventually evict the pod from its node.\n\n     A node selector represents the union of the results of one or more label\n     queries over a set of nodes; that is, it represents the OR of the selectors\n     represented by the node selector terms.\n\nFIELDS:\n   nodeSelectorTerms    <[]Object> -required-\n     Required. A list of node selector terms. The terms are ORed.\n")),(0,i.kt)("p",null,"\u7e7c\u7e8c\u5f80\u4e0b\u770b\u53ef\u4ee5\u770b\u5230"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"$ kubectl explain pod.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms\nKIND:     Pod\nVERSION:  v1\n\nRESOURCE: nodeSelectorTerms <[]Object>\n\nDESCRIPTION:\n     Required. A list of node selector terms. The terms are ORed.\n\n     A null or empty node selector term matches no objects. The requirements of\n     them are ANDed. The TopologySelectorTerm type implements a subset of the\n     NodeSelectorTerm.\n\nFIELDS:\n   matchExpressions     <[]Object>\n     A list of node selector requirements by node's labels.\n\n   matchFields  <[]Object>\n     A list of node selector requirements by node's fields.\n")),(0,i.kt)("p",null,"nodeSelectorTerms \u672c\u8eab\u652f\u63f4\u5169\u7a2e\u683c\u5f0f\uff0c\u5206\u5225\u662f Node Labels \u4ee5\u53ca Node Fields\uff0c\u6240\u4ee5 API \u5c64\u9762\u4e0a\u4e0d\u55ae\u7d14\u53ea\u6709 labels \u53ef\u4ee5\u4f7f\u7528\u3002"),(0,i.kt)("p",null,"\u9019\u908a\u7e7c\u7e8c\u5f80\u4e0b\u770b\u4e00\u4e0b matchExpressions \u7684\u4ecb\u7d39\u8207\u7528\u6cd5"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell="},'$ kubectl explain pod.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms.matchExpressions\nKIND:     Pod\nVERSION:  v1\n\nRESOURCE: matchExpressions <[]Object>\n\nDESCRIPTION:\n     A list of node selector requirements by node\'s labels.\n\n     A node selector requirement is a selector that contains values, a key, and\n     an operator that relates the key and values.\n\nFIELDS:\n   key  <string> -required-\n     The label key that the selector applies to.\n\n   operator     <string> -required-\n     Represents a key\'s relationship to a set of values. Valid operators are In,\n     NotIn, Exists, DoesNotExist. Gt, and Lt.\n\n     Possible enum values:\n     - `"DoesNotExist"`\n     - `"Exists"`\n     - `"Gt"`\n     - `"In"`\n     - `"Lt"`\n     - `"NotIn"`\n\n   values       <[]string>\n     An array of string values. If the operator is In or NotIn, the values array\n     must be non-empty. If the operator is Exists or DoesNotExist, the values\n     array must be empty. If the operator is Gt or Lt, the values array must\n     have a single element, which will be interpreted as an integer. This array\n     is replaced during a strategic merge patch.\n')),(0,i.kt)("p",null,"\u9019\u908a\u53ef\u4ee5\u770b\u5230 ",(0,i.kt)("inlineCode",{parentName:"p"},"matchExpressions")," \u5e95\u4e0b\u6703\u4f7f\u7528"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Key (Label Key)"),(0,i.kt)("li",{parentName:"ol"},"Operator"),(0,i.kt)("li",{parentName:"ol"},"Value (Label Value)")),(0,i.kt)("p",null,"\u4e09\u500b\u6b04\u4f4d\u4f86\u5e6b\u4f60\u5224\u65b7\u7bc0\u9ede\u662f\u5426\u7b26\u5408\u689d\u4ef6\uff0c\u76f8\u8f03\u65bc NodeSelector \u4f86\u8aaa\uff0c\u9019\u908a\u7684\u689d\u4ef6\u66f4\u591a\u5143\uff0c\u8b6c\u5982 ",(0,i.kt)("inlineCode",{parentName:"p"},"Exists, NotIn, Gt")," \u7b49\uff0c\u8acb\u53c3\u95b1 ",(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#operators"},"Operator")," \u4f86\u5b78\u7fd2\u66f4\u591a Operator \u5f7c\u6b64\u7684\u5b9a\u7fa9"),(0,i.kt)("p",null,"\u4ee5\u4e0b\u7bc4\u4f8b\u662f\u5fc5\u9808\u8981\u5c07 Pod \u7d66\u90e8\u7f72\u5230\u6240\u6709\u542b\u6709 ",(0,i.kt)("inlineCode",{parentName:"p"},"kind.zone")," Label \u7684\u7bc0\u9ede"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml="},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: node-affinity-1\nspec:\n  replicas: 10\n  selector:\n    matchLabels:\n      app: node-affinity-1\n  template:\n    metadata:\n      labels:\n        app: node-affinity-1\n    spec:\n      containers:\n        - name: www-server\n          image: hwchiu/netutils\n      affinity:\n        nodeAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:\n            nodeSelectorTerms:\n              - matchExpressions:\n                  - key: kind.zone\n                    operator: Exists\n                    values: []\n")),(0,i.kt)("p",null,"\u90e8\u7f72\u5b8c\u7562\u7684\u7d50\u679c\u5982\u4e0b\uff0c\u56db\u500b\u7bc0\u9ede\u90fd\u6709 ",(0,i.kt)("inlineCode",{parentName:"p"},"kind.zone")," \u6b64 key\uff0c\u6240\u4ee5\u90fd\u7b26\u5408\u9700\u6c42\u3002"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://hackmd.io/_uploads/HyAffrsj3.png",alt:null})),(0,i.kt)("p",null,"\u7531\u65bc nodeSelectorTerms \u5e95\u4e0b\u7684\u7d50\u679c\u662f\u63a1\u53d6 OR \u904b\u7b97\uff0c\u56e0\u6b64\u4e0b\u5217 YAML \u5247\u900f\u904e OR \u7684\u6982\u5ff5\u53bb\u6bd4\u5c0d\u591a\u500b\u7d50\u679c\uff0c\u53ef\u4ee5\u5f97\u5230\u8ddf\u524d\u8ff0\u985e\u4f3c\u7684\u90e8\u7f72\u7d50\u679c\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml="},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: node-affinity-2\nspec:\n  replicas: 10\n  selector:\n    matchLabels:\n      app: node-affinity-2\n  template:\n    metadata:\n      labels:\n        app: node-affinity-2\n    spec:\n      containers:\n        - name: www-server\n          image: hwchiu/netutils\n      affinity:\n        nodeAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:\n            nodeSelectorTerms:\n              - matchExpressions:\n                  - key: kind.zone\n                    operator: In\n                    values:\n                      - zone1\n              - matchExpressions:\n                  - key: kind.zone\n                    operator: In\n                    values:\n                      - zone2\n\n")),(0,i.kt)("p",null,"\u5176\u4ed6\u6ce8\u610f\u4e8b\u9805"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u5982\u679c\u4eca\u5929\u60f3\u8981\u9054\u5230\u7684\u662f\u53cd\u89aa\u548c\u529b\u7684\u64cd\u4f5c\uff0c\u60f3\u8981\u8b93 Pod \u9060\u96e2\u67d0\u4e9b\u7bc0\u9ede\uff0c\u90a3\u5c31\u8981\u4ef0\u8cf4 NotIn, DoesNotExist \u7b49\u904b\u7b97\u5143\u4f86\u53cd\u5411\u64cd\u4f5c\uff0c\u540c\u6642\u82e5"),(0,i.kt)("li",{parentName:"ol"},"\u53ef\u8207 NodeSelector \u540c\u6642\u4f7f\u7528\uff0c\u4f46\u662f\u4f7f\u7528\u6642\u5c31\u6703\u5169\u908a\u689d\u4ef6\u90fd\u8981\u6eff\u8db3"),(0,i.kt)("li",{parentName:"ol"},"MatchExpressions \u5e95\u4e0b\u82e5\u6709\u591a\u7d44 (key/operator/value) \u7684\u689d\u4ef6\uff0c\u9019\u4e9b\u689d\u4ef6\u5f7c\u6b64\u5247\u662f AND \u7684\u7d50\u679c")),(0,i.kt)("p",null,"\u8209\u4f8b\u4f86\u8aaa\uff0c\u4e0b\u5217\u5beb\u6cd5\u5c31\u8981\u6c42\u7bc0\u9ede\u540c\u6642\u8981\u64c1\u6709 ",(0,i.kt)("inlineCode",{parentName:"p"},"kind.zone=Zone1")," \u4ee5\u53ca ",(0,i.kt)("inlineCode",{parentName:"p"},"kind.zone=Zone2"),"\uff0c\u800c\u6e2c\u8a66\u74b0\u5883\u5167\u6c92\u6709\u4efb\u4f55\u7bc0\u9ede\u53ef\u4ee5\u6eff\u8db3\uff0c\u56e0\u6b64\u6240\u6709 Pod \u90fd\u6703\u8655\u65bc Pending \u72c0\u614b"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml="},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: node-affinity-3\nspec:\n  replicas: 10\n  selector:\n    matchLabels:\n      app: node-affinity-3\n  template:\n    metadata:\n      labels:\n        app: node-affinity-3\n    spec:\n      containers:\n        - name: www-server\n          image: hwchiu/netutils\n      affinity:\n        nodeAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:\n            nodeSelectorTerms:\n              - matchExpressions:\n                  - key: kind.zone\n                    operator: In\n                    values:\n                      - zone1\n                  - key: kind.zone\n                    operator: In\n                    values:\n                      - zone2\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash="},"$ kubectl get pods\nNAME                               READY   STATUS    RESTARTS   AGE\nnode-affinity-3-7c5574dd67-7spjw   0/1     Pending   0          71s\nnode-affinity-3-7c5574dd67-98pbj   0/1     Pending   0          71s\nnode-affinity-3-7c5574dd67-9bgfr   0/1     Pending   0          71s\nnode-affinity-3-7c5574dd67-b9bs4   0/1     Pending   0          71s\nnode-affinity-3-7c5574dd67-bqm8m   0/1     Pending   0          71s\nnode-affinity-3-7c5574dd67-glmkx   0/1     Pending   0          71s\nnode-affinity-3-7c5574dd67-hcmgp   0/1     Pending   0          71s\nnode-affinity-3-7c5574dd67-l45bv   0/1     Pending   0          71s\nnode-affinity-3-7c5574dd67-mn7js   0/1     Pending   0          71s\nnode-affinity-3-7c5574dd67-th2pd   0/1     Pending   0          71s\n")),(0,i.kt)("h2",{id:"preferredduringschedulingignoredduringexecution"},"preferredDuringSchedulingIgnoredDuringExecution"),(0,i.kt)("p",null,"\u76f8\u5c0d\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"requiredDuringSchedulingIgnoreDuringExecution"),"\uff0c ",(0,i.kt)("inlineCode",{parentName:"p"},"preferred")," \u7684\u7248\u672c\u5247\u662f\u4e00\u500b\u504f\u597d\u7684\u8a2d\u5b9a\uff0c\u5982\u679c\u6709\u7b26\u5408\u5c31\u4ee5\u7b26\u5408\u70ba\u4e3b\uff0c\u6c92\u6709\u7684\u8a71\u4e5f\u6c92\u95dc\u4fc2\uff0c\u56e0\u6b64\u9664\u975e\u9047\u5230 Taint \u6216\u662f\u7bc0\u9ede\u8cc7\u6e90\u4e0d\u8db3\uff0c\u4e0d\u7136\u5927\u90e8\u5206\u60c5\u6cc1\u4e0b\u5c31\u4e0d\u6703\u9047\u5230 Pending \u5361\u4f4f\u7684\u60c5\u6cc1\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell="},'$ kubectl explain pod.spec.affinity.nodeAffinity.preferredDuringSchedulingIgnoredDuringExecution\nKIND:     Pod\nVERSION:  v1\n\nRESOURCE: preferredDuringSchedulingIgnoredDuringExecution <[]Object>\n\nDESCRIPTION:\n     The scheduler will prefer to schedule pods to nodes that satisfy the\n     affinity expressions specified by this field, but it may choose a node that\n     violates one or more of the expressions. The node that is most preferred is\n     the one with the greatest sum of weights, i.e. for each node that meets all\n     of the scheduling requirements (resource request, requiredDuringScheduling\n     affinity expressions, etc.), compute a sum by iterating through the\n     elements of this field and adding "weight" to the sum if the node matches\n     the corresponding matchExpressions; the node(s) with the highest sum are\n     the most preferred.\n\n     An empty preferred scheduling term matches all objects with implicit weight\n     0 (i.e. it\'s a no-op). A null preferred scheduling term matches no objects\n     (i.e. is also a no-op).\n\nFIELDS:\n   preference   <Object> -required-\n     A node selector term, associated with the corresponding weight.\n\n   weight       <integer> -required-\n     Weight associated with matching the corresponding nodeSelectorTerm, in the\n     range 1-100.\n')),(0,i.kt)("p",null,"\u9019\u908a\u53ef\u4ee5\u89c0\u5bdf\u5230 preferred \u672c\u8eab\u900f\u904e\u7684\u662f prefernce \u9019\u500b\u6b04\u4f4d\u4f86\u63cf\u8ff0 node selector term\uff0c\u540c\u6642\u56e0\u70ba preference \u672c\u8eab\u662f\u504f\u597d\u800c\u975e\u786c\u6027\u90e8\u7f72\uff0c\u6240\u4ee5\u9084\u591a\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"weight")," \u6b0a\u91cd\u7684\u6982\u5ff5\uff0c\u53ef\u4ee5\u8b93\u4f60\u900f\u904e\u6b0a\u91cd\u8abf\u6574 Pod \u7684\u5206\u914d\u60c5\u6cc1    "),(0,i.kt)("p",null,"\u4e0b\u8ff0\u7bc4\u4f8b\u5247\u4f7f\u7528\u5169\u500b\u4e0d\u540c\u7684\u898f\u5247\u4e26\u4e14\u7d66\u4e88\u4e0d\u540c\u6b0a\u91cd\uff0c\u80fd\u7684\u8a71\u76e1\u91cf\u5c07 Pod \u90e8\u7f72\u5230\u542b\u6709 ",(0,i.kt)("inlineCode",{parentName:"p"},"kind.zone:zone2")," \u7684\u7bc0\u9ede\u4e0a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml="},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: node-affinity-4\nspec:\n  replicas: 10\n  selector:\n    matchLabels:\n      app: node-affinity-4\n  template:\n    metadata:\n      labels:\n        app: node-affinity-4\n    spec:\n      containers:\n        - name: www-server\n          image: hwchiu/netutils\n      affinity:\n        nodeAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n            - weight: 1\n              preference:\n                matchExpressions:\n                  - key: kind.zone\n                    operator: In\n                    values:\n                      - zone1\n            - weight: 4\n              preference:\n                matchExpressions:\n                  - key: kind.zone\n                    operator: In\n                    values:\n                      - zone2\n")),(0,i.kt)("p",null,"\u90e8\u7f72\u7d50\u679c\u5982\u4e0b\u5716\uff0c\u5927\u90e8\u5206\u90fd\u5ea7\u843d\u65bc worker3/worker4\uff0c\u8207\u9810\u671f\u7b26\u5408\n",(0,i.kt)("img",{parentName:"p",src:"https://hackmd.io/_uploads/B1VN_Sso2.png",alt:null})),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Required")," \u8ddf ",(0,i.kt)("inlineCode",{parentName:"p"},"Preferred")," \u5169\u8005\u662f\u53ef\u4ee5\u4e92\u76f8\u758a\u52a0\u7684\uff0c\u8b6c\u5982\u53ef\u4ee5\u900f\u904e\u4e0b\u5217 YAML \u9054\u6210"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u670d\u52d9\u53ea\u80fd\u90e8\u7f72\u5230\u542b\u6709 ",(0,i.kt)("inlineCode",{parentName:"li"},"kind.zone: zone1")," \u7684\u7bc0\u9ede"),(0,i.kt)("li",{parentName:"ol"},"\u82e5\u7bc0\u9ede\u540d\u7a31\u70ba ",(0,i.kt)("inlineCode",{parentName:"li"},"k8slab-worker2"),"\uff0c\u5247\u7d66\u4e88\u66f4\u5927\u6b0a\u91cd")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml="},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: node-affinity-5\nspec:\n  replicas: 10\n  selector:\n    matchLabels:\n      app: node-affinity-5\n  template:\n    metadata:\n      labels:\n        app: node-affinity-5\n    spec:\n      containers:\n        - name: www-server\n          image: hwchiu/netutils\n      affinity:\n        nodeAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:\n            nodeSelectorTerms:\n              - matchExpressions:\n                  - key: kind.zone\n                    operator: In\n                    values:\n                      - zone1\n          preferredDuringSchedulingIgnoredDuringExecution:\n            - weight: 4\n              preference:\n                matchExpressions:\n                  - key: kubernetes.io/hostname\n                    operator: In\n                    values:\n                      - k8slab-worker2\n")),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://hackmd.io/_uploads/BybhYrosn.png",alt:null})),(0,i.kt)("h1",{id:"summary"},"Summary"),(0,i.kt)("p",null,"\u672c\u7bc7\u6587\u7ae0\u63a2\u8a0e\u4e86\u4e09\u500b\u4ee5 Node \u70ba\u51fa\u767c\u9ede\u7684\u8a2d\u5b9a\u65b9\u5f0f"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"NodeName"),(0,i.kt)("li",{parentName:"ol"},"NodeSelector"),(0,i.kt)("li",{parentName:"ol"},"NodeAffinity")),(0,i.kt)("p",null,"\u9664\u4e86 NodeName \u662f\u4ee5 Node \u540d\u7a31\u4f86\u8a2d\u5b9a\u5916\uff0c\u5f8c\u7e8c\u90fd\u662f\u57fa\u65bc Node Label \u70ba\u57fa\u790e\u4f86\u8abf\u6574\u4f86\u9054\u5230\u66f4\u70ba\u5f48\u6027\u7684\u8a2d\u5b9a\u65b9\u5f0f\uff0c\u800c NodeAffinity \u53ef\u8996\u70ba NodeSelector \u7684\u52a0\u5f37\u7248\uff0c\u63d0\u4f9b\u4e86\u57fa\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"Required")," \u8207 ",(0,i.kt)("inlineCode",{parentName:"p"},"Preferred")," \u5169\u7a2e\u6a21\u5f0f\u4f86\u9054\u5230\u66f4\u7d30\u90e8\u5f97\u64cd\u4f5c"),(0,i.kt)("p",null,"\u800c\u4e0b\u7bc7\u6587\u7ae0\u6703\u7e7c\u7e8c\u5f9e\nInter-Pod Affinity \u4ee5\u53ca Pod TopologySpreadConstraints \u4f86\u63a5\u7e8c\u63a2\u8a0e"))}c.isMDXComponent=!0}}]);