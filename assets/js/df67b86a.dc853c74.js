"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[64192],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>k});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),p=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(o.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,o=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=p(n),d=r,k=u["".concat(o,".").concat(d)]||u[d]||m[d]||s;return n?a.createElement(k,l(l({ref:t},c),{},{components:n})):a.createElement(k,l({ref:t},c))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,l=new Array(s);l[0]=d;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i[u]="string"==typeof e?e:r,l[1]=i;for(var p=2;p<s;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},63152:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>m,frontMatter:()=>s,metadata:()=>i,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const s={title:"\u540c\u6a23 2vCPU \u7684 Kubernetes Container \u70ba\u4ec0\u9ebc\u6703\u6bd4 VM \u6548\u80fd\u5dee",keywords:["Kubernetes","Network","Linux","Ubuntu"],tags:["Kubernetes","DevOps","Linux"],description:"\u8a18\u9304\u4e00\u4e0b\u5c07\u670d\u52d9\u8f49\u79fb\u5230 Container \u4e0a\u6642\u6548\u80fd\u8981\u6ce8\u610f\u7684\u5730\u65b9",image:"./assets/Bk5TEXjJ6.png"},l="\u540c\u6a23 2vCPU \u7684 Kubernetes Container \u70ba\u4ec0\u9ebc\u6703\u6bd4 VM \u6548\u80fd\u5dee",i={unversionedId:"2023/container-vm",id:"2023/container-vm",title:"\u540c\u6a23 2vCPU \u7684 Kubernetes Container \u70ba\u4ec0\u9ebc\u6703\u6bd4 VM \u6548\u80fd\u5dee",description:"\u8a18\u9304\u4e00\u4e0b\u5c07\u670d\u52d9\u8f49\u79fb\u5230 Container \u4e0a\u6642\u6548\u80fd\u8981\u6ce8\u610f\u7684\u5730\u65b9",source:"@site/docs/2023/container-vm.md",sourceDirName:"2023",slug:"/2023/container-vm",permalink:"/docs/2023/container-vm",draft:!1,tags:[{label:"Kubernetes",permalink:"/docs/tags/kubernetes"},{label:"DevOps",permalink:"/docs/tags/dev-ops"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",lastUpdatedBy:"HungWei Chiu",frontMatter:{title:"\u540c\u6a23 2vCPU \u7684 Kubernetes Container \u70ba\u4ec0\u9ebc\u6703\u6bd4 VM \u6548\u80fd\u5dee",keywords:["Kubernetes","Network","Linux","Ubuntu"],tags:["Kubernetes","DevOps","Linux"],description:"\u8a18\u9304\u4e00\u4e0b\u5c07\u670d\u52d9\u8f49\u79fb\u5230 Container \u4e0a\u6642\u6548\u80fd\u8981\u6ce8\u610f\u7684\u5730\u65b9",image:"./assets/Bk5TEXjJ6.png"},sidebar:"techPost",previous:{title:"Bash output \u8a0e\u8ad6 >file 2>&1 \u8207 2>&1 > file \u7684\u5dee\u7570",permalink:"/docs/2023/bash_redirection"},next:{title:"\u4f55\u8b02 Kubernetes Descheduler \u4ee5\u53ca\u53ef\u4ee5\u505a\u4ec0\u9ebc?",permalink:"/docs/2023/descheduler"}},o={image:n(69722).Z},p=[{value:"Background",id:"background",level:2},{value:"\uff37hat Is CPU Throttling",id:"\uff57hat-is-cpu-throttling",level:2},{value:"Thread",id:"thread",level:2},{value:"How To Avoid",id:"how-to-avoid",level:2},{value:"Monitor",id:"monitor",level:2},{value:"Background",id:"background-1",level:2},{value:"Implementation",id:"implementation",level:2}],c={toc:p},u="wrapper";function m(e){let{components:t,...s}=e;return(0,r.kt)(u,(0,a.Z)({},c,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u540c\u6a23-2vcpu-\u7684-kubernetes-container-\u70ba\u4ec0\u9ebc\u6703\u6bd4-vm-\u6548\u80fd\u5dee"},"\u540c\u6a23 2vCPU \u7684 Kubernetes Container \u70ba\u4ec0\u9ebc\u6703\u6bd4 VM \u6548\u80fd\u5dee"),(0,r.kt)("p",null,"\u96a8\u8005 Kubernetes \u8207 Container \u6982\u5ff5\u7684\u5d1b\u8d77\u8207\u6d41\u884c\uff0c\u8a31\u591a\u5718\u968a\u9664\u4e86\u5c07\u65b0\u7684\u61c9\u7528\u76f4\u63a5\u958b\u767c\u90e8\u7f72\u5230 Kubernetes \u4e0a\uff0c\u4e5f\u6703\u9700\u8981\u5c07\u65e2\u6709\u7684\u670d\u52d9\u5f9e\u8f49\u79fb\u5230\u5bb9\u5668\u4e2d\n\u800c\u9019\u4e9b\u65e2\u6709\u7684\u670d\u52d9\u53ef\u80fd\u662f\u76f4\u63a5\u90e8\u7f72\u65bc\u88f8\u6a5f\u6216\u662f\u865b\u64ec\u6a5f(Virtual Machine, VM)\u4e0a\u3002"),(0,r.kt)("p",null,'Container \u4e3b\u6253 "Build Once, Run Everywhere"\uff0c\u8b93\u958b\u767c\u5718\u968a\u8207\u7dad\u904b\u5718\u968a\u53ef\u4ee5\u7528\u66f4\u8f15\u9b06\u8207\u7cfb\u7d71\u7684\u65b9\u5f0f\u53bb\u7ba1\u7406\u61c9\u7528\u7a0b\u5f0f\uff0c\u4f46\u662f\u5f88\u5e38\u90fd\u6703\u770b\u5230\u61c9\u7528\u7a0b\u5f0f\u539f\u5c01\u4e0d\u52d5\u642c\u79fb\u904e\u4f86\u5f8c\u6548\u80fd\u4e0d\u5982\u9810\u671f\u7684\u73fe\u8c61\u3002'),(0,r.kt)("p",null,"\u672c\u6587\u4e3b\u8981\u6703\u5f9e CPU \u65b9\u5411\u53bb\u63a2\u8a0e\uff0c\u70ba\u4ec0\u9ebc\u5c07\u670d\u52d9\u5f9e VM \u642c\u79fb\u5230 Kubernetes(Container) \u4e16\u754c\u4e2d\u53ef\u80fd\u5b58\u5728\u7684\u4e00\u4e9b\u554f\u984c\uff0c\u4ee5\u53ca\u9019\u4e9b\u554f\u984c\u70ba\u4ec0\u9ebc\u6703\u5c0e\u81f4\u6548\u80fd\u4e0d\u5982\u9810\u671f\n\u61c9\u7528\u7a0b\u5f0f\u672c\u8eab\u6548\u80fd\u74f6\u9838\u662f Network I/O \u6216\u662f Disk I/O \u7684\u5247\u4e0d\u5728\u672c\u6587\u8a0e\u8ad6\u7bc4\u570d"),(0,r.kt)("h1",{id:"cpu-throttling"},"CPU Throttling"),(0,r.kt)("h2",{id:"background"},"Background"),(0,r.kt)("p",null,"\u904e\u5f80\u4f7f\u7528 VM \u4f86\u90e8\u7f72\u670d\u52d9\u6642\uff0c\u901a\u5e38\u90fd\u662f\u8981\u6c42\u4e00\u500b\u56fa\u5b9a\u5927\u5c0f\u7684\u7cfb\u7d71\u8cc7\u6e90\uff0c\u8b6c\u5982\u7d66\u6211\u4e00\u53f0 4 vCPU, 16 GB \u898f\u683c\u7684 VM\uff0c\u63a5\u8005\u4f7f\u7528\u8005\u5c31\u53ef\u4ee5\u81ea\u5df1\u9023\u7dda\u5230 VM \u5167\u5b89\u88dd\u904b\u884c\u81ea\u5df1\u9700\u8981\u7684\u61c9\u7528\u7a0b\u5f0f\u3002"),(0,r.kt)("p",null,"\u7136\u800c\u5230 Kubernetes \u7684\u4e16\u754c\u4e2d\uff0c\u5bb9\u5668\u5316\u7684\u61c9\u7528\u7a0b\u5f0f\u90e8\u7f72\u975e\u5e38\u5bb9\u5668\uff0c\u4f46\u662f\u70ba\u4e86\u907f\u514d\u5f71\u97ff\u5176\u4ed6\u5bb9\u5668\u8207\u8017\u76e1\u8cc7\u6e90\uff0c\u90fd\u6703\u8981\u6c42\u90e8\u7f72 Pod \u7684\u6642\u5019\u59a5\u5584\u8a2d\u5b9a resource.request \u4ee5\u53ca resoruce.limit\u3002"),(0,r.kt)("p",null,"\u7576\u61c9\u7528\u7a0b\u5f0f\u4f7f\u7528\u8cc7\u6e90\u9054\u5230 resource.limit \u8a2d\u5b9a\u6642\u5247\u6703\u767c\u751f\u5c0d\u61c9\u7684\u8655\u7f6e\u52d5\u4f5c\uff0c\u5c0d\u65bc CPU \u4f86\u8aaa\u5247\u662f\u6703\u6709 CPU Throttling\uff0c\u800c Memory \u5247\u662f\u6703\u6709 Out-Of-Memory Killer"),(0,r.kt)("p",null,"\u6709\u4e9b\u61c9\u7528\u7a0b\u5f0f\u958b\u767c\u8005\u6c92\u6709\u59a5\u5584\u8a2d\u5b9a resource.limit \u8207\u7a0b\u5f0f\u904b\u4f5c\u908f\u8f2f\u7684\u60c5\u6cc1\u4e0b\uff0c\u5c31\u5f88\u5bb9\u6613\u89f8\u767c CPU Throttling \u7684\u60c5\u6cc1\uff0c\u5f88\u5e38\u898b\u7684\u5c31\u662f p95, p99 \u7684\u6574\u500b\u53cd\u61c9\u4e0d\u5982\u9810\u671f\uff0c\u6216\u662f Thread \u6108\u958b\u6108\u591a\u7d50\u679c\u904b\u884c\u60c5\u6cc1\u53cd\u800c\u6108\u4f86\u6108\u6162\u7684\u60c5\u6cc1\u3002"),(0,r.kt)("p",null,"\u800c VM \u7684\u60c5\u6cc1\u4e0b\u5b8c\u5168\u4e0d\u9700\u8981\u53bb\u8003\u616e\u9019\u9ebc\u591a\u8cc7\u6e90\u8a2d\u5b9a\u7684\u554f\u984c\uff0c\u56e0\u6b64\u4e5f\u4e0d\u6703\u89f8\u767c CPU Throttling \u7b49\u554f\u984c\u800c\u88ab\u964d\u901f\uff0c\u56e0\u6b64\u63a5\u4e0b\u4f86\u5c31\u4f86\u4ed4\u7d30\u63a2\u8a0e\u5230\u5e95\u4f55\u8b02 CPU Throttling \u4ee5\u53ca\u70ba\u4ec0\u9ebc\u89f8\u767c\u6703\u5c0e\u81f4\u6548\u80fd\u4e0d\u5982\u9810\u671f"),(0,r.kt)("h2",{id:"\uff57hat-is-cpu-throttling"},"\uff37hat Is CPU Throttling"),(0,r.kt)("p",null,"\u95b1\u8b80\u904e\u6587\u4ef6\u7684\u8b80\u8005\u52e2\u5fc5\u5e38\u5e38\u807d\u5230 Kubernetes \u900f\u904e cgroup \u4f86\u7ba1\u7406\u5bb9\u5668\u904b\u884c\u7684\u6240\u9700\u8cc7\u6e90\uff0c\u8981\u7406\u89e3 CPU Throttling \u5c31\u5fc5\u9808\u8981\u5148\u7406\u89e3 cgroup \u5be6\u52d9\u4e0a\u8207 Kubernetes \u5167 resources.request/limit \u7684\u95dc\u4fc2\u662f\u4ec0\u9ebc"),(0,r.kt)("p",null,"CPU Request \u65bc Kubernetes \u4e2d\u6709\u5169\u500b\u7528\u9014"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Kubernetes \u5c07 Pod \u5167\u6240\u6709 Container \u7684 Request \u52a0\u7e3d\u8a08\u7b97\uff0c\u4f7f\u7528\u8a72\u6578\u503c\u4f86\u904e\u6ffe\u6c92\u6709\u8db3\u5920\u8cc7\u6e90\u88ab\u8abf\u5ea6\u7684\u7bc0\u9ede\uff0c\u9019\u90e8\u5206\u4e3b\u8981\u662f\u8ddf Scheduling \u6709\u95dc"),(0,r.kt)("li",{parentName:"ol"},"Linux Kernel CFS(Completely Fair Scheduler) \u4f86\u6307\u6d3e CPU \u5c0d\u61c9\u7684\u6642\u9593\u7d66\u76ee\u6a19\u5bb9\u5668")),(0,r.kt)("p",null,"\u5047\u8a2d\u6211\u5011\u90e8\u7f72\u4e0b\u5217\u670d\u52d9\uff0c\u8a72\u670d\u52d9\u6709\u4e09\u500b Container\uff0c CPU Request \u5206\u5225\u662f 250m, 250m \u8207 300m."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml="},'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: www-deployment-resource\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: www-resource\n  template:\n    metadata:\n      labels:\n        app: www-resource\n    spec:\n      containers:\n        - name: www-server\n          image: hwchiu/python-example\n          resources:\n            requests:\n              cpu: "250m"\n        - name: app\n          image: hwchiu/netutils\n          resources:\n            requests:\n              cpu: "250m"\n        - name: app2\n          image: hwchiu/netutils\n          resources:\n            requests:\n              cpu: "300m"\n')),(0,r.kt)("p",null,"\u5047\u8a2d\u5927\u5bb6\u90fd\u540c\u610f 1 vCPU = 1000ms\uff0c\u5247\u4e0a\u8ff0\u7684\u4f7f\u7528\u91cf\u53ef\u4ee5\u7e6a\u88fd\u6210\u4e0b\u5217\u5716\u8868"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(54691).Z,width:"849",height:"294"})),(0,r.kt)("p",null,"\u4f46\u662f CPU \u7684\u904b\u884c\u4e26\u4e0d\u662f\u4ee5 1\u79d2(1000ms) \u70ba\u55ae\u4f4d\uff0cCFS \u904b\u884c\u7684\u6642\u5019\u6703\u6839\u64da cgroup \u5167\u7684\u53c3\u6578 ",(0,r.kt)("strong",{parentName:"p"},"cfs_period_us")," \u4f86\u6c7a\u5b9a\u6bcf\u6b21\u904b\u884c\u7684\u9031\u671f\uff0c\u9810\u8a2d\u60c5\u6cc1\u4e0b\u90fd\u662f 100ms"),(0,r.kt)("p",null,"\u56e0\u6b64\u4e0a\u8ff0\u7684\u8a2d\u5b9a\u8f49\u63db\u5230\u5be6\u969b\u7684\u904b\u884c\u60c5\u6cc1\u66f4\u50cf\u662f\n",(0,r.kt)("img",{alt:"image",src:n(35123).Z,width:"849",height:"294"})),(0,r.kt)("p",null,"\u4f46\u662f CPU \u8cc7\u6e90\u672c\u8eab\u662f\u4e92\u76f8\u7af6\u722d\u7684\uff0c\u8981\u5982\u4f55\u78ba\u4fdd\u9019\u4e9b\u61c9\u7528\u7a0b\u5f0f\u65bc\u6bcf\u500b\u9031\u671f\u5167\u81f3\u5c11\u6709\u5c0d\u61c9\u7684\u6642\u9593\u53ef\u4ee5\u7528\uff1f\nCFS \u4f7f\u7528 CPU shares \u7684\u8a2d\u5b9a\u4f86\u78ba\u4fdd\u61c9\u7528\u7a0b\u5f0f\u53ef\u4ee5\u65bc\u6bcf\u500b\u9031\u671f\u5167\u4f7f\u7528\u5230\u81ea\u5df2\u6240\u8981\u6c42\u7684\u6642\u9593\uff0c\u9019\u90e8\u5206\u53ef\u4ee5\u60f3\u6210\u662f\u904b\u884c\u6642\u9593\u7684\u4e0b\u9650\uff0c\u5269\u4e0b\u591a\u51fa\u4f86\u7684\u6642\u9593\u5247\u5c31\u4ea4\u7d66\u5f7c\u6b64\u53bb\u7af6\u722d\u3002"),(0,r.kt)("p",null,"\u4e0a\u8ff0\u7684\u7bc4\u4f8b\u4f86\u770b\uff0c\u4e09\u500b\u61c9\u7528\u7a0b\u5f0f\u65bc 100ms \u7684\u6642\u9593\u9ede\u5167\u6240\u8981\u6c42\u7684\u6642\u9593\u91cf\u5206\u5225\u70ba\n25ms, 25ms, 30ms\uff0c\u800c\u5269\u4e0b\u7684 20ms \u5247\u7531\u4e09\u8005\u53bb\u6436\u596a\uff0c\u6240\u4ee5\u5be6\u52d9\u4e0a\u6709\u53ef\u80fd\u767c\u751f\u591a\u7a2e\u7d44\u5408\u60c5\u5f62\uff0c\u8b6c\u5982"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(98179).Z,width:"844",height:"634"})),(0,r.kt)("p",null,"\u4e0d\u8ad6\u662f\u54ea\u7a2e\u985e\u578b\uff0c\u90fd\u81f3\u5c11\u6eff\u8db3 CPU Share \u7684\u8acb\u6c42\uff0c\u6709\u7b26\u5408\u6700\u4f4e\u4f7f\u7528\u60c5\u5883\u3002"),(0,r.kt)("p",null,"\u82e5\u74b0\u5883\u662f cgroup v2 \u7684\u8a71\uff0c\u5e95\u5c64\u5247\u662f\u4f7f\u7528 cpu.weight     \u7684\u65b9\u5f0f\u4f86\u5be6\u4f5c"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"ubuntu@hwchiu:/sys/fs/cgroup/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-podacdcc83d_4cca_4271_9145_7af6c44b1858.slice$ cat cri-containerd-*/cpu.weight\n12\n10\n10\n\nubuntu@hwchiu:/sys/fs/cgroup/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-podacdcc83d_4cca_4271_9145_7af6c44b1858.slice$ cat cpu.weight\n32\n")),(0,r.kt)("p",null,"\u4e0a\u8ff0\u7bc4\u4f8b\u53ef\u4ee5\u770b\u5230 CPU Weight \u4e4b\u9593\u662f\u4ee5\u6bd4\u4f8b\u7684\u65b9\u5f0f\u53bb\u8a08\u7b97\uff0c25:25:30 \u4e5f\u5c31\u662f 10:10:12\uff0c\u800c\u7e3d\u984d\u5247\u662f 32"),(0,r.kt)("p",null,"\u800c CPU Limit \u65bc Kubernetes \u4e2d\u7684\u8aaa\u660e\u662f\u4e00\u500b CPU \u4f7f\u7528\u4e0a\u9650\uff0c\u7576 CPU \u7528\u91cf\u9054\u5230\u6b64\u7a0b\u5ea6\u6642\u5c31\u6703\u89f8\u767c CPU Throttling\uff0c\u56e0\u6b64\u53ef\u4ee5\u60f3\u6210\u662f CPU \u4f7f\u7528\u91cf\u7684\u5929\u82b1\u677f"),(0,r.kt)("p",null,"\u5c07\u4e0a\u8ff0\u7684 YAML \u6539\u70ba\u4e0b\u5217\u7bc4\u4f8b\uff0c\u8a72\u7bc4\u4f8b\u4e2d\u5c0d\u6bcf\u500b\u61c9\u7528\u7a0b\u5f0f\u52a0\u5165\u5c0d\u61c9\u7684 Limit"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: cpu-limit\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: www-resource\n  template:\n    metadata:\n      labels:\n        app: www-resource\n    spec:\n      containers:\n        - name: www-server\n          image: hwchiu/python-example\n          resources:\n            requests:\n              cpu: "250m"\n            limits:\n              cpu: "300m"\n        - name: www-server2\n          image: hwchiu/netutils\n          resources:\n            requests:\n              cpu: "250m"\n            limits:\n              cpu: "300m"\n        - name: www-server3\n          image: hwchiu/netutils\n          resources:\n            requests:\n              cpu: "300m"\n            limits:\n              cpu: "350m"\n')),(0,r.kt)("p",null,"\u4e00\u6a23\u4ee5 100ms \u9019\u500b\u9031\u671f\u4f86\u770b\u61c9\u7528\u7a0b\u5f0f\u7684\u5206\u4f48"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(82266).Z,width:"980",height:"353"})),(0,r.kt)("p",null,"\u7576\u61c9\u7528\u7a0b\u5f0f\u53ea\u8981\u4f7f\u7528\u5230\u8d85\u904e\u76ee\u6a19\u7684\u6642\u9593\u5f8c\uff0c\u5c31\u6703\u9677\u5165 Throttle \u7684\u72c0\u614b\uff0c\u6c92\u6709\u8fa6\u6cd5\u7e7c\u7e8c\u4f7f\u7528 CPU\uff0c\u6240\u4ee5\u4e0a\u8ff0\u7684\u7bc4\u4f8b\u5047\u8a2d\u4e09\u500b\u61c9\u7528\u7a0b\u5f0f\u90fd\u60f3\u8981\u53bb\u7af6\u722d\u591a\u9918\u7684 CPU\uff0c\u6700\u7d42\u5c31\u6703\u7522\u751f\u5982\u4e0b\u5716\u6240\u793a\n",(0,r.kt)("img",{alt:"image",src:n(11285).Z,width:"980",height:"425"})),(0,r.kt)("p",null,"\u6700\u7d42 CPU \u6703\u6709 5ms \u7684 IDLE \u6642\u9593\uff0c\u56e0\u70ba\u9019\u4e09\u500b\u61c9\u7528\u7a0b\u5f0f\u90fd\u88ab Throttled\uff0c\u6c92\u6709\u591a\u9918\u7684\u984d\u5ea6\u53ef\u4ee5\u7e7c\u7e8c\u904b\u884c\u4e86\u3002"),(0,r.kt)("p",null,"cgroup v1 \u5247\u662f\u900f\u904e cpu quota(cfs_quota_us, cfs_period_us) \u7684\u53c3\u6578\u4f86\u6307\u5b9a\u80fd\u5920\u904b\u884c\u7684\u6642\u9593\uff0c\u800c cgroup v2 \u5247\u662f\u4f9d\u64da cpu.max \u4f86\u8a2d\u5b9a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"ubuntu@hwchiu:/sys/fs/cgroup/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-podacdcc83d_4cca_4271_9145_7af6c44b1858.slice$ cat cri-containerd-*/cpu.max\n35000 100000\n30000 100000\n30000 100000\n\nubuntu@hwchiu:/sys/fs/cgroup/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-podacdcc83d_4cca_4271_9145_7af6c44b1858.slice$ cat cpu.max\n95000 100000\n")),(0,r.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\u4e0a\u8ff0\u4e09\u500b Container \u88ab\u653e\u5230\u540c\u4e00\u500b K8s Pod \u88e1\u9762\uff0c\u4e14\u6bcf\u500b container \u7684 CPU.MAX \u88ab\u8a2d\u5b9a\u6210 35000(ns), 30000(ns) \u8207 30000(ns)\n\u800c Pod \u672c\u8eab\u7684 cpu.max \u5247\u662f\u8a08\u7b97\u6210\u6240\u6709 container \u7684\u52a0\u7e3d 95000(ns)"),(0,r.kt)("p",null,"\u6839\u64da\u4e0a\u8ff0\u7684\u57fa\u672c\u7406\u89e3\uff0c\u76ee\u524d\u77e5\u9053\u7576\u670d\u52d9\u8e29\u5230 CPU Throttling \u6642\u6703\u4f7f\u5f97\u61c9\u7528\u7a0b\u5f0f\u65bc\u6bcf\u500b CPU \u9031\u671f\u5167\u80fd\u5920\u4f7f\u7528\u7684\u6642\u9593\u6709\u9650\uff0c\u7576\u767c\u751f\u6642\u5c31\u6c92\u6709\u8fa6\u6cd5\u7e7c\u7e8c\u904b\u884c\uff0c\u5373\u4f7f\u7576\u4e0b\u7684 CPU \u662f\u7a7a\u9591\u7684\u3002"),(0,r.kt)("h2",{id:"thread"},"Thread"),(0,r.kt)("p",null,"CPU Throttling \u807d\u8d77\u4f86\u662f\u500b\u975e\u5e38\u5408\u7406\u4e14\u6b63\u5e38\u7684\u884c\u70ba\uff0c\u90a3\u4ec0\u9ebc\u60c5\u6cc1\u4e0b\u6703\u4f7f\u5f97\u670d\u52d9\u904b\u4f5c\u4e0d\u5982\u9810\u671f\uff0c\u751a\u81f3\u524d\u9762\u6240\u63d0\u5230\u7684 p95, p99 \u7684\u6548\u80fd\u4e0d\u597d\uff1f"),(0,r.kt)("p",null,"CPU Share \u4f7f\u7528\u7684\u8a08\u7b97\u662f\u4ee5\u8a72 Container Process \u53bb\u8a08\u7b97\u7684\uff0c\u6240\u4ee5\u5047\u5982\u8a72 Process \u672c\u8eab\u6703\u7522\u751f\u591a\u500b Thread\uff0c\u5247\u8a08\u7b97\u65b9\u5f0f\u5247\u662f\u6240\u6709 Thread \u5b8c\u5168\u52a0\u7e3d\u3002"),(0,r.kt)("p",null,"\u5047\u8a2d\u4eca\u5929\u90e8\u7f72\u4e00\u500b\u61c9\u7528\u7a0b\u5f0f\uff0c\u8a72\u61c9\u7528\u7a0b\u5f0f\u7684 Limit \u662f 100ms\uff0c\u4f46\u662f\u5176 CPU \u5de5\u4f5c\u53ea\u9700\u8981 50ms\u5c31\u53ef\u4ee5\u5b8c\u6210"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(98675).Z,width:"787",height:"415"})),(0,r.kt)("p",null,"\u57fa\u672c\u4f7f\u7528\u4e0a\u5b8c\u5168\u6c92\u6709\u4efb\u4f55\u554f\u984c\u3002\n\u4eca\u5929\u7a81\u7136\u60f3\u8981\u589e\u52a0 Thread \u7684\u6578\u91cf\uff0c\u4f7f\u7528\u5169\u500b Thread \u4f86\u904b\u884c"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(73135).Z,width:"786",height:"430"})),(0,r.kt)("p",null,"\u7531\u65bc\u6bcf\u500b Thread \u90fd\u9700\u8981\u82b1\u8cbb 50ms\uff0c\u5169\u500b\u52a0\u7a2e\u525b\u597d 100ms\uff0c\u4e5f\u6c92\u6709\u8d85\u904e limit(quota) \u4e0a\u9650\uff0c\u56e0\u6b64\u4f7f\u7528\u8d77\u4f86\u4e5f\u6c92\u6709\u4efb\u4f55\u554f\u984c"),(0,r.kt)("p",null,"\u4f46\u662f\u7576\u958b\u555f 3 \u500b Thread \u7684\u6642\u5019\u6703\u767c\u751f\u4ec0\u9ebc\u4e8b\u60c5?(\u5047\u8a2d\u7cfb\u7d71\u4e0a\u81f3\u5c11\u6709\u4e09\u500b vCPU \u53ef\u7528)\n",(0,r.kt)("img",{alt:"image",src:n(48640).Z,width:"789",height:"479"})),(0,r.kt)("p",null,"\u56e0\u70ba\u7e3d\u91cf\u53ea\u6709 100ms\uff0c\u7531\u4e09\u500b thread \u5404\u81ea\u53bb\u7af6\u722d\uff0c\u6240\u4ee5\u5e73\u5747\u60c5\u6cc1\u4e0b\u6bcf\u500b thread \u90fd\u53ea\u80fd\u7528\u5230 33ms\uff0c\u6700\u7d42\u5c31\u89f8\u767c\u4e86 Throtteld \u6a5f\u5236\uff0c\u6bcf\u500b Thread \u65bc\u5269\u4e0b\u7684 idle(67ms) \u4ec0\u9ebc\u4e8b\u60c5\u90fd\u4e0d\u80fd\u5b8c\u6210"),(0,r.kt)("p",null,"\u65bc\u662f\u6240\u6709\u7684 Thread \u90fd\u5fc5\u9808\u8981\u7b49\u5f85\u76f4\u5230\u7b2c\u4e8c\u500b CPU \u9031\u671f\u624d\u53ef\u4ee5\u7e7c\u7e8c\u8dd1\u5b8c\u6240\u9700\u8981\u7684\u5de5\u4f5c\n",(0,r.kt)("img",{alt:"image",src:n(6821).Z,width:"950",height:"479"})),(0,r.kt)("p",null,"\u7b2c\u4e8c\u500b\u9031\u671f\u958b\u59cb\uff0c\u6bcf\u500b Thread \u5927\u6982\u53ea\u9700\u8981 17ms \u5de6\u53f3\u5c31\u53ef\u4ee5\u6eff\u8db3\uff0c\u96d6\u7136\u6700\u7d42\u4e09\u500b Thread \u90fd\u9806\u5229\u5b8c\u6210\uff0c\u4f46\u662f\u6bcf\u500b Thread \u5f9e\u958b\u59cb\u5230\u7d50\u675f\u5be6\u969b\u4e0a\u537b\u82b1\u4e86 117 \u79d2(100+17) \u79d2\uff0c\u5176\u4e2d\u5de5\u4f5c 50ms\uff0cidle 67 \u79d2\u3002"),(0,r.kt)("p",null,"\u82e5\u5c07\u4e0a\u8ff0\u7684\u7bc4\u4f8b\u6539\u70ba 8 \u500b Thread\uff0c\u6574\u500b\u60c5\u6cc1\u6703\u8b8a\u5f97\u66f4\u52a0\u56b4\u91cd\uff0c\u5982\u4e0b\u5716"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(44295).Z,width:"2829",height:"679"})),(0,r.kt)("p",null,"\u9019\u500b\u60c5\u6cc1\u4e0b\uff0c Thread \u65bc\u6bcf\u500b CPU \u9031\u671f\u53ea\u80fd\u7528\u5230 12.5 ms\uff0c\u56e0\u6b64\u9700\u8981\u81f3\u5c11\u4e94\u500b\u9031\u671f\u624d\u53ef\u4ee5\u8dd1\u5b8c\u5168\u90e8\u7684\u5de5\u4f5c\n\u56e0\u6b64\u672c\u4f86 50 ms \u7684\u5de5\u4f5c\u6700\u5f8c\u537b\u82b1\u8cbb\u4e86 412.5 ms\uff0c\u9019\u56b4\u91cd\u7684\u60c5\u6cc1\u751a\u81f3\u6703\u5c0e\u81f4 Client \u7684\u8acb\u6c42 timeout \u6216\u662f latency \u66b4\u589e"),(0,r.kt)("p",null,"\u56e0\u6b64\u4e0d\u6b63\u78ba\u7684 Thread \u6578\u91cf\u8207 CPU Limit \u5c07\u6703\u6709\u6a5f\u6703\u4f7f\u5f97\u61c9\u7528\u7a0b\u5f0f\u5927\u91cf\u7684\u89f8\u767c CPU Throttled\uff0c\u96d6\u7136 CPU \u6700\u7d42\u90fd\u9084\u662f\u53ef\u4ee5\u904b\u884c\u5b8c\u7562\uff0c\u4f46\u662f\u6bcf\u500b\u5de5\u4f5c\u6240\u82b1\u8cbb\u7684\u6642\u9593\u90fd\u6703\u88ab\u62c9\u9577\uff0c\u6700\u7d42\u5c31\u6703\u53cd\u61c9\u70ba P95, P99 \u7cfb\u7d71\u5fd9\u788c\u60c5\u6cc1\u4e0b\u7684\u6548\u80fd\u3002"),(0,r.kt)("h2",{id:"how-to-avoid"},"How To Avoid"),(0,r.kt)("p",null,"\u907f\u514d CPU Throttling \u7684\u65b9\u5f0f\u6709\u5169\u7a2e\u65b9\u5f0f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u63d0\u9ad8 CPU Limit \u7684\u7528\u91cf"),(0,r.kt)("li",{parentName:"ol"},"\u6aa2\u8996\u61c9\u7528\u7a0b\u5f0f\u7684 Thread \u7528\u91cf\u662f\u5426\u4e0d\u6b63\u78ba")),(0,r.kt)("p",null,"\u63d0\u5347 CPU Limit \u7684\u7528\u91cf\u662f\u6700\u76f4\u63a5\u7684\uff0c\u4f46\u662f\u8a2d\u5b9a\u591a\u5c11 CPU Limit \u624d\u662f\u4e00\u500b\u9069\u7576\u7684\u6578\u503c\u5247\u6c92\u6709\u4e00\u500b\u6b63\u78ba\u7684\u6a94\u6848\uff0c\u666e\u904d\u4f86\u8aaa\u90fd\u63a8\u85a6\u642d\u914d Monitoring \u7cfb\u7d71\u53bb\u89c0\u6e2c\u8cc7\u6599\u4f86\u8a55\u4f30\u4e00\u500b\u5408\u9069\u7684\u6578\u503c\uff0c\u6b64\u5916\u82e5\u672c\u8eab\u4e5f\u5728\u610f Pod QoS \u7684\u8a71\uff0cLimit \u7684\u8a2d\u5b9a\u4e5f\u5c31\u4e0d\u80fd\u4e82\u7d66\uff0c\u800c\u662f\u5fc5\u9808\u8981\u6709\u6240\u672c\u7684\u8207 Request \u4e00\u81f4"),(0,r.kt)("p",null,"Thread \u7684\u6578\u91cf\u9019\u90e8\u5206\u5247\u9700\u8981\u4ef0\u8cf4\u61c9\u7528\u7a0b\u5f0f\u958b\u767c\u8005\u53bb\u6ce8\u610f\uff0cThread \u7684\u6578\u91cf\u901a\u5e38\u7531\u5169\u7a2e\u65b9\u5f0f\u8a2d\u5b9a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u4f7f\u7528\u8005\u81ea\u884c\u8a2d\u5b9a\u9700\u8981\u7684\u6578\u91cf"),(0,r.kt)("li",{parentName:"ol"},"\u7a0b\u5f0f\u8a9e\u8a00\u672c\u8eab\u6216\u662f\u6846\u67b6\u81ea\u52d5\u5075\u6e2c")),(0,r.kt)("p",null,"(1) \u7684\u90e8\u5206\u4ef0\u8cf4\u7a0b\u5f0f\u958b\u767c\u8005\u7684\u64b0\u5beb\uff0c\u9019\u90e8\u5206\u5982\u679c\u8981\u624b\u52d5\u8a2d\u5b9a\u7684\u8a71\u9084\u9700\u8981\u540c\u6b65 Kubernetes Resource \u7684\u8a2d\u5b9a\uff0c\u8b6c\u5982\u56e0\u61c9\u9700\u6c42\u958b\u555f\u66f4\u591a Thread \u90a3\u5c31\u53ef\u80fd\u9700\u8981\u8abf\u6574 limit.CPU \u8207 request.CPU \u7684\u8a2d\u5b9a\u907f\u514d\u89f8\u767c\u66f4\u983b\u7e41\u7684 CPU Throttling"),(0,r.kt)("p",null,"\u81f3\u65bc(2) \u7684\u81ea\u52d5\u5075\u6e2c\u90e8\u5206\u5247\u9084\u662f\u8981\u4ef0\u8cf4\u61c9\u7528\u7a0b\u5f0f\u958b\u767c\u8005\u719f\u6089\u81ea\u5df1\u6240\u4f7f\u7528\u7684\u7a0b\u5f0f\u8a9e\u8a00\u8207\u6846\u67b6\uff0c\u4ee5\u4e0b\u5217\u7bc4\u4f8b\u4f86\u8aaa\uff0c\u904b\u884c\u4e00\u500b (request: 2vCPU, limit: 4vCPU) \u7684\u5bb9\u5668\u5230\u4e00\u53f0\u64c1\u6709 128 vCPU \u7684\u4f3a\u670d\u5668\u4e0a\u6642\uff0c\u9019\u4e9b\u7a0b\u5f0f\u8a9e\u8a00\u6216\u662f\u7a0b\u5f0f\u6846\u67b6\u5230\u5e95\u662f\u57fa\u65bc\u4f55\u7a2e\u6578\u5b57\u53bb\u81ea\u52d5\u8abf\u6574\u6578\u91cf\uff0c\u9019\u90e8\u5206\u6c92\u6709\u4e00\u5b9a\u7b54\u6848\uff0c\u6240\u4ee5\u958b\u767c\u8005\u4e00\u5b9a\u8981\u4ed4\u7d30\u78ba\u8a8d\u81ea\u5df1\u6240\u4f7f\u7528\u7684\u8a9e\u8a00\u8207\u6846\u67b6\uff0c\u5230\u5e95\u600e\u9ebc\u8655\u7406\u7684\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(85194).Z,width:"583",height:"370"})),(0,r.kt)("p",null,"\u4ee5 Java \u4f86\u8aaa\uff0c\u7248\u672c ",(0,r.kt)("a",{parentName:"p",href:"https://bugs.openjdk.org/browse/JDK-8146115"},"8u131")," \u5f8c\u5c31\u6709\u80fd\u529b\u53bb\u5075\u6e2c Container \u74b0\u5883\u4e0b\u7684\u7cfb\u7d71\u8cc7\u6e90\uff0c\u5426\u5247\u904e\u5f80\u7684 Java \u61c9\u7528\u7a0b\u5f0f\u662f\u6703\u57fa\u65bc\u5be6\u9ad4\u6a5f\u5668 (128 vCPU) \u53bb\u8a2d\u5b9a\u9700\u8981\u7684 Thread \u6578\u91cf\uff0c\u9019\u7a2e\u60c5\u6cc1\u4e0b\u5c31\u6703\u975e\u5e38\u5bb9\u6613\u89f8\u767c Throttling\u3002"),(0,r.kt)("h2",{id:"monitor"},"Monitor"),(0,r.kt)("p",null,"\u5982\u679c\u74b0\u5883\u4e2d\u6709\u5b89\u88dd Promehteus \u7684\u8a71\uff0c\u53ef\u4ee5\u900f\u904e\u4e0b\u5217\u4e09\u500b\u6307\u6a19\u4f86\u89c0\u6e2c\u61c9\u7528\u7a0b\u5f0f\u662f\u5426\u6709\u9047\u5230 CPU Throttling \u7684\u60c5\u6cc1\uff0c\u5206\u5225\u662f"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"container_cpu_cfs_throttled_seconds_total"),(0,r.kt)("li",{parentName:"ol"},"container_cpu_cfs_periods_total"),(0,r.kt)("li",{parentName:"ol"},"container_cpu_cfs_throttled_periods_total")),(0,r.kt)("p",null,"container_cpu_cfs_throttled_seconds_total \u9019\u500b\u6307\u6a19\u6703\u4ee5\u79d2\u6578\u70ba\u55ae\u4f4d\u53bb\u7d00\u9304\u76ee\u6a19 Container \u76ee\u524d\u7e3d\u5171\u88ab Throttled \u591a\u5c11\u6642\u9593\uff0c\u79d2\u6578\u70ba\u55ae\u4f4d\uff0c\u985e\u578b\u70ba Counter\uff0c\u56e0\u6b64\u4f7f\u7528\u4e0a\u9700\u8981\u642d\u914d\nrate \u7b49\u4e4b\u985e\u7684\u51fd\u6578\u53bb\u89c0\u6e2c\u8b8a\u7570\u91cf\uff0c\u540c\u6642\u8981\u6ce8\u610f\u7684\u662f\u9019\u500b\u6307\u6a19\u56de\u50b3\u7684\u662f\u7e3d\u91cf\uff0c\u6240\u4ee5\u82e5\u61c9\u7528\u7a0b\u5f0f\u672c\u8eab\u4f7f\u7528\u7684 Thread \u6578\u91cf\u904e\u591a\u6642\uff0c\u6709\u53ef\u80fd\u7d71\u8a08\u51fa\u4f86\u7684\u7d50\u679c\u79d2\u6578\u6703\u975e\u5e38\u9ad8\uff0c\u4f7f\u7528\u4e0a\u8981\u7279\u5225\u6ce8\u610f\u5982\u4f55\u95b1\u8b80\u6b64\u6307\u6a19\u3002"),(0,r.kt)("p",null,"\u56e0\u6b64\u5be6\u52d9\u4e0a\u66f4\u50be\u5411\u540c\u6642\u4f7f\u7528\u5f8c\u9762\u5169\u500b\u6307\u6a19\uff0c",(0,r.kt)("strong",{parentName:"p"},"container_cpu_cfs_periods_total")," \u662f\u500b Counter\uff0c\u4ee3\u8868\u7684\u662f\u8a72\u5bb9\u5668\u76ee\u524d\u7d2f\u7a4d\u81f3\u4eca\u6240\u6709\u7d93\u6b77\u904e\u7684 CPU Cycle, \u4e5f\u5c31\u662f CFS periods(100ms)\uff0c\u800c\u5f8c\u8005 ",(0,r.kt)("strong",{parentName:"p"},"container_cpu_cfs_throttled_periods_total")," \u4e00\u6a23\u7684\u8a08\u7b97\u65b9\u5f0f\uff0c\u53ea\u662f\u8a08\u7b97\u7684\u662f\u6709\u591a\u5c11 periods \u5167\u767c\u751f\u904e CPU Throttling\u3002"),(0,r.kt)("p",null,"\u76f8\u5c0d\u65bc\u524d\u8005\u76f4\u63a5\u8a08\u7b97\u79d2\u6578\uff0c\u900f\u904e\u5f8c\u5169\u8005\u6307\u6a19\u7684\u8a08\u7b97\uff0c",(0,r.kt)("strong",{parentName:"p"},"container_cpu_cfs_throttled_periods_total")," / ",(0,r.kt)("strong",{parentName:"p"},"container_cpu_cfs_periods_total")," \u53ef\u4ee5\u7372\u5f97\u4e00\u500b Throttling \u7684\u767e\u5206\u6bd4"),(0,r.kt)("p",null,"\u4ee5\u4e0b\u5217\u7bc4\u4f8b\u4f86\u8aaa\uff0c\u61c9\u7528\u7a0b\u5f0f\u7e3d\u5171\u9700\u8981\u4e94\u500b period\uff0c\u5176\u4e2d\u56db\u500b period \u6709\u767c\u751f CPU Throttling \u7684\u60c5\u6cc1\uff0c\u56e0\u6b64\u8a08\u7b97\u51fa\u4f86\u7684\u767e\u5206\u6bd4\u5c31\u662f 4/5 = 80%\n",(0,r.kt)("img",{alt:"image",src:n(89461).Z,width:"895",height:"298"})),(0,r.kt)("p",null,"\u53e6\u5916\u8981\u6ce8\u610f\u7684\u662f\u56e0\u70ba\u9019\u4e9b\u6307\u6a19\u90fd\u662f\u7d2f\u7a4d\u81f3\u4eca\u4ee5\u4f86\u6240\u6709\u7684\u8cc7\u6599\uff0c\u800c\u6211\u5011\u5728\u610f\u7684\u4e26\u4e0d\u662f\u5f9e\u982d\u81f3\u4eca\u7684\u6240\u6709\u8cc7\u6599\uff0c\u800c\u662f\u6700\u8fd1\u7576\u4e0b\u7684\u904b\u7b97\u60c5\u6cc1\uff0c\u56e0\u6b64\u9700\u8981\u900f\u904e increase \u7b49\u4e4b\u985e\u7684\u8868\u9054\u5f0f\u4f86\u8a08\u7b97\u5dee\u7570\uff0c\u4e26\u4e14\u6839\u64da\u5dee\u7570\u518d\u9032\u884c\u767e\u5206\u6bd4\u7684\u63db\u7b97"),(0,r.kt)("p",null,"\u8209\u4f8b\u4f86\u8aaa"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'sum(increase(container_cpu_cfs_throttled_periods_total{container!=""}[5m])) by (container, pod, namespace)\n                /\nsum(increase(container_cpu_cfs_periods_total[5m])) by (container, pod, namespace)\n')),(0,r.kt)("p",null,"\u900f\u904e Grafana/Prometheus \u7b49\u5de5\u5177\u76e3\u63a7\u61c9\u7528\u7a0b\u5f0f\u6548\u80fd\u6642\uff0c CPU Throttling \u4e5f\u662f\u4e00\u500b\u503c\u5f97\u6ce8\u610f\u7684\u9818\u57df\u3002"),(0,r.kt)("h1",{id:"exclusive-cpu"},"Exclusive CPU"),(0,r.kt)("h2",{id:"background-1"},"Background"),(0,r.kt)("p",null,"\u53e6\u5916\u4e00\u500b\u5f71\u97ff Container \u8207 VM \u4e4b\u9593 CPU \u6548\u80fd\u7684\u56e0\u7d20\u5c31\u662f CPU \u7684\u4f7f\u7528\u6548\u7387\uff0c\u5148\u8a66\u60f3\u4e0b\u5217\u60c5\u5883\n\u6709\u4e00\u53f0\u6709 16 vCPU \u7684 Server\uff0c\u7136\u5f8c\u6709\u4e00\u500b\u6703\u5e0c\u671b\u53ef\u4ee5\u4f7f\u7528\u5230 4 vCPU \u4e14\u6709 4 \u689d Thread \u7684\u670d\u52d9\u8981\u90e8\u7f72\uff0c\u90a3\u4ee5 Container \u6216\u662f VM \u4f86\u904b\u884c\u7684\u6642\u5019\u53ef\u80fd\u6703\u6709\u4ec0\u9ebc\u4e0d\u540c\u5dee\u7570\uff1f"),(0,r.kt)("p",null,"\u4e0b\u5716\u4ee3\u8868\u7684\u662f\u4e00\u500b\u6709 16 vCPU \u7684\u4f3a\u670d\u5668\u72c0\u6cc1\uff0c\u6bcf\u4e00\u500b\u5708\u5708\u90fd\u4ee3\u8868\u4e00\u500b vCPU"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(49583).Z,width:"335",height:"334"})),(0,r.kt)("p",null,"\u4ee5 VM \u4f86\u8aaa\uff0c\u5e38\u898b\u7684\u7bc4\u4f8b\u662f\u56fa\u5b9a 4 vCPU \u7d66 VM \u5c08\u9580\u4f7f\u7528\uff0c\u63a5\u8005\u8a72\u670d\u52d9\u5c31\u6703\u65bc\u8a72 4 vCPU \u4e0a\u7531 VM \u7684 Kernel \u53bb\u81ea\u884c\u8abf\u5ea6\u4f7f\u7528\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(55279).Z,width:"335",height:"334"})),(0,r.kt)("p",null,"\u4f46\u662f\u5c0d\u65bc Container \u4f86\u8aaa\uff0c\u56e0\u70ba\u8cc7\u6e90\u662f\u5171\u4eab\uff0c\u800c\u4e14 CPU (request) \u7684\u6982\u5ff5\u662f\u6bcf\u500b\u6642\u9593\u5340\u9593\u8981\u6eff\u8db3 4 vCPU \u7684\u7528\u91cf\uff0c\u56e0\u6b64\u5be6\u52d9\u4e0a\n\u5230\u5e95\u662f\u4f7f\u7528\u54ea\u4e9b CPU \u4e26\u4e0d\u662f\u88ab\u80af\u5b9a\u7684\uff0c\u6240\u4ee5\u6709 4thread \u7684\u61c9\u7528\u7a0b\u5f0f\u904b\u884c\u7684 CPU \u5206\u4f48\u53ef\u80fd\u6709\u4e0b\u5217\u60c5\u6cc1\uff0c\u800c\u9019\u4e9b\u60c5\u6cc1\u662f\u96a8\u8005\u6642\u9593\u6703\u8b8a\u5316\u7684\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(7651).Z,width:"1125",height:"372"})),(0,r.kt)("p",null,"\u90a3\u70ba\u4ec0\u9ebc CPU \u5206\u4f48\u6703\u5f71\u97ff\u5230\u6548\u80fd\u554f\u984c\uff1f \u9019\u500b\u554f\u984c\u8981\u5148\u56de\u6b78\u5230 CPU \u7684\u57fa\u672c\u6982\u5ff5\uff0c\u70ba\u4ec0\u9ebc\u6211\u5011\u5e73\u5e38\u6703\u8b1b CPU \u4f46\u662f\u5230\u96f2\u7aef\u4e16\u754c\u4e2d\u6211\u5011\u5c31\u7528 vCPU(Virtual CPU)\u4f86\u5f62\u5bb9\uff1f"),(0,r.kt)("p",null,"\u96a8\u8005\u6280\u8853\u7684\u767c\u5c55\uff0c\u4ef0\u8cf4\u65bc Hyper Threading \u6280\u8853\u7684\u767c\u5c55\uff0c\u6bcf\u500b\u7269\u7406 CPU \u53ef\u4ee5\u904b\u884c\u591a\u500b Thread(\u4ea6\u7a31 virtual CPU\uff0c\u6b64 Thread)\uff0c\u7fd2\u6163\u4e0a\u6703\u7a31\u7269\u7406 CPU \u70ba Core\n\u800c Socket \u4e0a\u5247\u6703\u6709\u773e\u591a Core\u3002"),(0,r.kt)("p",null,"\u4ee5\u4e0b\u5217\u6a5f\u5668\u4f86\u8aaa\uff0c\u53ef\u4ee5\u900f\u904e ",(0,r.kt)("inlineCode",{parentName:"p"},"lscpu")," \u6307\u4ee4\u4f86\u89c0\u770b CPU \u7684\u4e00\u4e9b\u7d30\u7bc0"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"ubuntu@blog-test:~$ lscpu\nArchitecture:                       x86_64\nCPU op-mode(s):                     32-bit, 64-bit\nByte Order:                         Little Endian\nAddress sizes:                      46 bits physical, 57 bits virtual\nCPU(s):                             32\nOn-line CPU(s) list:                0-31\nThread(s) per core:                 2\nCore(s) per socket:                 16\nSocket(s):                          1\nNUMA node(s):                       1\n")),(0,r.kt)("p",null,"\u4e0a\u8ff0\u7bc4\u4f8b\u53ef\u4ee5\u770b\u5230"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u6709 1 \u500b Socket"),(0,r.kt)("li",{parentName:"ol"},"\u6bcf\u500b Socket \u6709 16 Core"),(0,r.kt)("li",{parentName:"ol"},"\u6bcf\u500b Core \u6709 2 \u500b Thread")),(0,r.kt)("p",null,"\u6240\u4ee5\u6700\u5f8c\u8a08\u7b97\u51fa\u4f86\u5c31\u662f 1",(0,r.kt)("em",{parentName:"p"},"16"),"2 = 32 \u500b vCPU"),(0,r.kt)("p",null,"\u800c\u4e0b\u5217\u6307\u4ee4\u5247\u662f\u4f86\u81ea\u65bc\u4e0d\u540c\u7684\u6a5f\u5668"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"ubuntu@hwchiu:~$ lscpu\nVendor ID:               GenuineIntel\n  Model name:            Intel(R) Xeon(R) Gold 6230R CPU @ 2.10GHz\n    Thread(s) per core:  2\n    Core(s) per socket:  8\n    Socket(s):           2\nNUMA:\n  NUMA node(s):          2\n  NUMA node0 CPU(s):     0-15\n  NUMA node1 CPU(s):     16-31\n")),(0,r.kt)("p",null,"\u96d6\u7136\u7e3d\u6578\u4e5f\u662f 2",(0,r.kt)("em",{parentName:"p"},"8"),"2=32\uff0c\u4f46\u662f\u5176\u5e95\u5c64\u7684\u67b6\u69cb\u5247\u660e\u986f\u4e0d\u540c"),(0,r.kt)("p",null,"\u56e0\u70ba Socket, Core \u7684\u67b6\u69cb\uff0c\u4e0a\u8ff0\u5169\u7a2e\u60c5\u6cc1\u90fd\u53ef\u4ee5\u4ee3\u8868\u4e00\u500b 32 vCPU \u7684\u4f3a\u670d\u5668"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(94819).Z,width:"1000",height:"910"})),(0,r.kt)("p",null,"\u9664\u4e86\u4e0a\u8ff0\u6982\u5ff5\u5916\uff0c\u73fe\u5728\u67b6\u69cb\u4e0a\u9084\u6709\u4e00\u500b\u540d\u70ba NUMA(Non-Uniform Memory Access) \u7684\u67b6\u69cb\nNUMA \u5c07\u6574\u53f0\u4f3a\u670d\u5668\u62c6\u5206\u6210\u591a\u500b NUMA \u7bc0\u9ede\uff0c\u6bcf\u500b\u7bc0\u9ede\u4e0a\u64c1\u6709\u591a\u500b Core(\u7269\u7406 CPU)\uff0c NUMA \u7bc0\u9ede\u5167\u5171\u4eab\u76f8\u540c\u7684\u8a18\u61b6\u9ad4\u63a7\u5236\u5668\n\u6240\u4ee5 Core \u4e4b\u9593\u5982\u679c\u6709\u8a18\u61b6\u9ad4\u76f8\u95dc\u5b58\u53d6\u9700\u6c42\u6642\uff0c\u540c\u7bc0\u9ede\u4e0a\u7684\u901f\u5ea6\u6703\u6700\u5feb\uff0c\u8de8 NUMA \u7bc0\u9ede\u5247\u6703\u5f8c\u4e9b\u8a31\u6548\u80fd\u7684\u640d\u8017"),(0,r.kt)("p",null,"\u4e0a\u8ff0\u7684\u7b2c\u4e00\u500b\u7bc4\u4f8b\u4ee3\u8868\u53ea\u6709\u4e00\u500b NUMA \u7bc0\u9ede\uff0c\u800c\u7b2c\u4e8c\u500b\u7bc4\u4f8b\u5247\u6709\u5169\u500b NUMA \u7bc0\u9ede\uff0c\u5176\u4e2d CPU \u7de8\u865f 0-15 \u5c6c\u65bc\u7b2c\u4e00\u500b NUMA \u7bc0\u9ede\uff0c\u800c 16-31 \u5247\u5c6c\u65bc\u7b2c\u4e8c\u500b NUMA \u7bc0\u9ede\uff0c\u9019\u90e8\u5206\u4e5f\u53ef\u4ee5\u900f\u904e ",(0,r.kt)("inlineCode",{parentName:"p"},"numactl")," \u6aa2\u8996"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"ubuntu@hwchiu:~$ numactl -H\navailable: 2 nodes (0-1)\nnode 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15\nnode 0 size: 16058 MB\nnode 0 free: 14530 MB\nnode 1 cpus: 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31\nnode 1 size: 16075 MB\nnode 1 free: 14284 MB\n")),(0,r.kt)("p",null,"\u642d\u914d ",(0,r.kt)("inlineCode",{parentName:"p"},"cat /proc/cpuinfo")," \u53bb\u6aa2\u8996\u6bcf\u500b CPU \u7de8\u865f\u8207 Core \u7684\u95dc\u4fc2\uff0c\u5927\u81f4\u4e0a\u53ef\u4ee5\u7e6a\u88fd\u51fa\u4e0b\u5217\u7684\u5716"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(93437).Z,width:"1111",height:"588"})),(0,r.kt)("p",null,"CPU \u7684\u67b6\u69cb\u9664\u4e86\u4e0a\u8ff0\u7684\u57fa\u672c\u6982\u5ff5\u5916\uff0c\u4e0d\u540c\u5340\u584a\u4e4b\u9593\u4e5f\u6709\u4e0d\u540c\u5c64\u7d1a\u7684 Cache \u4f86\u8655\u7406\u8cc7\u6599\uff0c\u5c07\u9019\u4e9b Cache \u52a0\u5165\u5f8c\u7684\u67b6\u69cb\u5716\u5982\u4e0b"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(28456).Z,width:"885",height:"799"})),(0,r.kt)("p",null,"\u6709\u4e86\u9019\u4e9b\u57fa\u672c\u6982\u5ff5\u5f8c\u5c31\u53ef\u4ee5\u91cd\u65b0\u56de\u9867\u6700\u521d\u7684\u554f\u984c\uff0c CPU \u7684\u904b\u884c\u5206\u4f48\u70ba\u4ec0\u9ebc\u6703\u5f71\u97ff\u6548\u80fd\uff1f\n\u539f\u56e0\u662f Cache + Context Switch(\u8abf\u5ea6\u4e0d\u540c CPU)\n\u7576\u61c9\u7528\u7a0b\u5f0f\u540c\u6642\u904b\u884c\u7684 vCPU \u5f7c\u6b64\u4e4b\u9593\u8981\u4e92\u76f8\u5b58\u53d6\u8cc7\u6599\uff0c\u9019\u4e9b\u8cc7\u6599\u5b58\u653e\u7684 Memory \u5230\u5e95\u5728\u54ea\u88e1\uff1f \u5f7c\u6b64\u4e4b\u9593\u662f\u5426\u6709 Cache\uff1f\n\u5982\u679c\u9019\u4e9b\u904b\u884c\u7684 vCPU \u8de8\u4e0d\u540c Socket \u751a\u81f3\u8de8\u4e0d\u540c NUMA \u7bc0\u9ede\uff0c\u9019\u4e9b\u8cc7\u8a0a\u7684\u5b58\u53d6\u90fd\u6703\u7522\u751f Cache Miss\uff0c\u751a\u81f3\u7b49\u5f85\u4e0b\u4e00\u500b CPU Cycle \u53ef\u80fd\u53c8\u6703\u88ab\u8abf\u5ea6\u5230\u4e0d\u540c\u7684 Core \u53bb\u904b\u884c\n\u9019\u7a2e\u60c5\u6cc1\u4e0b\u767c\u751f\u7684 Context Switch \u4e5f\u6703\u964d\u4f4e\u6548\u80fd\u3002"),(0,r.kt)("p",null,"\u5c0d\u65bc\u5927\u90e8\u5206\u7684\u61c9\u7528\u7a0b\u5f0f\u4f86\u8aaa\u53ef\u80fd\u6c92\u6709\u611f\u89ba\uff0c\u4f46\u662f\u5c0d\u65bc\u90e8\u5206\u5f88\u8981\u6c42\u9ad8\u6548\u80fd\u7684\u61c9\u7528\u7a0b\u5f0f\u4f86\u8aaa\uff0c\u5982\u679c\u53ef\u4ee5\u907f\u514d\u4e0a\u8ff0\u7684\u554f\u984c\u5c31\u53ef\u4ee5\u5c07\u7cfb\u7d71\u6548\u80fd\u5f80\u4e0a\u63d0\u5347\u4e00\u9ede\u9ede"),(0,r.kt)("h2",{id:"implementation"},"Implementation"),(0,r.kt)("p",null,"Linux \u4e00\u76f4\u4ee5\u4f86\u90fd\u6709\u4e00\u500b\u540d\u70ba taskset \u7684\u5de5\u5177\uff0c\u6839\u64da man \u7684\u4ecb\u7d39\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'       The taskset command is used to set or retrieve the CPU affinity of a running process given its pid, or to launch a new command with a given CPU affinity. CPU affinity is a scheduler property that "bonds" a process to a given set of CPUs on the system. The Linux scheduler will honor the given CPU affinity and the process will not run on any other\n')),(0,r.kt)("p",null,"\u6240\u4ee5\u5c0d\u65bc\u88f8\u6a5f\u4e0a\u7684\u61c9\u7528\u7a0b\u5f0f\uff0c\u4e00\u76f4\u4ee5\u4f86\u7cfb\u7d71\u7ba1\u7406\u54e1\u90fd\u6703\u900f\u904e taskset \u7684\u65b9\u5f0f\u4f86\u7d81\u5b9a CPU \u4f86\u63d0\u5347\u6548\u80fd\uff0c\u4f46\u662f\u5c0d\u65bc Contianer \u6216\u662f Kubernetes \u4f86\u8aaa\u9019\u90e8\u5206\u8a72\u600e\u9ebc\u8655\u7406\uff1f"),(0,r.kt)("p",null,"\u4ee5 Docker \u4f86\u8aaa\uff0c\u5176",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/config/containers/resource_constraints/"},"\u5b98\u65b9\u6587\u4ef6"),'\u8aaa\u660e\u53ef\u4ee5\u900f\u904e "cpuset-cpus" \u4f86\u6307\u5b9a\u6b32\u4f7f\u7528\u7684 CPU \u7de8\u865f\u3002'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"--cpuset-cpuLimit the specific CPUs or cores a container can use. \n")),(0,r.kt)("p",null,'\u800c Kubernetes \u5f88\u65e9\u5c31\u6ce8\u610f\u5230\u6b64\u554f\u984c\uff0c\u56e0\u6b64\u5f9e Kubernetes v1.8 \u5c31\u5f15\u5165\u4e86 "CPU Manager" \u9019\u584a\u529f\u80fd\uff0c\u8a72\u529f\u80fd\u65bc v1.10 \u8f49\u70ba Beta \u4e26\u4e14\u65bc v1.26 \u6b63\u5f0f\u8f49\u70ba GA'),(0,r.kt)("p",null,"CPU Manager Policy \u672c\u8eab\u652f\u63f4\u5169\u7a2e\u8a2d\u5b9a\uff0c\u4e14\u8a2d\u5b9a\u662f\u767c\u751f\u65bc Kubelet \u8eab\u4e0a\u3002"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"None"),(0,r.kt)("li",{parentName:"ol"},"Static")),(0,r.kt)("p",null,"\u56e0\u70ba\u8a2d\u5b9a\u662f\u4ee5 Kubelet \u70ba\u57fa\u6e96\uff0c\u56e0\u6b64\u5982\u679c\u9700\u8981\u958b\u555f\u6b64\u529f\u80fd\uff0c\u5247\u5fc5\u9808\u8981\u5f9e kubelet \u7684\u555f\u52d5\u53c3\u6578\u53bb\u8a2d\u5b9a\u5982\u4f55\u4f7f\u7528\uff0c\u6b64\u5916\u4e5f\u8981\u7279\u5225\u6ce8\u610f\u4e0d\u540c Kubernetes \u7248\u672c\u4e4b\u9593\u7684\u5dee\u7570\uff0c\u8acb\u53c3\u95b1",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/#static-policy-options"},"\u5b98\u65b9\u6587\u4ef6")," \u78ba\u8a8d\u4e0d\u540c\u7248\u672c\u4e0a\u54ea\u4e9b\u529f\u80fd\u9700\u8981\u7279\u5225\u958b\u555f feature gate\u3002"),(0,r.kt)("p",null,"None \u7684\u8a2d\u5b9a\u4ee3\u8868\u6c92\u6709\u4efb\u4f55\u4f5c\u70ba\uff0c\u56e0\u6b64 CPU Manager \u4e0d\u6703\u6709\u7279\u5225\u7684\u64cd\u4f5c\uff0c\u9019\u4e5f\u662f\u76ee\u524d Kubernetes \u7684\u9810\u8a2d\u503c\nStatic \u53ef\u4ee5\u5141\u8a31\u7b26\u5408\u7279\u5b9a\u689d\u4ef6\u7684\u5bb9\u5668\u904b\u884c\u65bc\u7368\u4f54\u7684 vCPU \u4e0a\uff0c\u5e95\u5c64\u57fa\u672c\u4e0a\u662f\u4ef0\u8cf4 cpuset cgroup \u63a7\u5236\u5668\u800c\u5b8c\u6210\u3002"),(0,r.kt)("p",null,"\u7279\u5b9a\u689d\u4ef6\u7684\u5bb9\u5668\u6709\u5169\u500b"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"QoS \u70ba Guarantee"),(0,r.kt)("li",{parentName:"ol"},"CPU \u7684\u6578\u91cf\u70ba\u6574\u6578")),(0,r.kt)("p",null,"\u56e0\u70ba\u8a72\u8a2d\u5b9a\u8981\u7368\u4f54 vCPU\uff0c\u65e2\u7136\u90fd\u8981\u7368\u4f54\u5c31\u6703\u8981\u6c42\u662f\u4ee5\u6574\u6578\u70ba\u55ae\u4f4d\uff0c\u5426\u5247\u7368\u4f54\u4e00\u9846 vCPU \u7d50\u679c\u53ea\u8981\u6c42\u4f7f\u7528 0.5 vCPU\uff0c\u9019\u6a23\u5c31\u662f\u660e\u986f\u7684\u6d6a\u8cbb\u7cfb\u7d71\u8cc7\u6e90\n\u6b64\u5916\u7368\u4f54\u7cfb\u7d71\u8cc7\u6e90\u96d6\u7136\u80fd\u5920\u63d0\u5347\u5bb9\u5668\u7684\u904b\u884c\u6548\u80fd\uff0c\u4f46\u662f\u82e5\u670d\u52d9\u672c\u8eab\u6c92\u6709\u5145\u5206\u5229\u7528\u8cc7\u6e90\uff0c\u662f\u53ef\u80fd\u6703\u6d6a\u8cbb vCPU \u7684\u8cc7\u6e90\uff0c\u56e0\u6b64\u4f7f\u7528\u4e0a\u4e26\u4e0d\u6703\u5c0d\u6240\u6709\u7684 Pod \u90fd\u958b\u555f\uff0c\u800c\u662f\u5fc5\u9808\u8981\u5c07 QoS \u8a2d\u5b9a\u70ba Guarantee \u7684 Pod \u624d\u53ef\u4ee5\u4eab\u7528\u5230\u6b64\u529f\u80fd\u3002"),(0,r.kt)("p",null,"\u6b64\u5916\u7576\u8a2d\u5b9a\u70ba Static \u5f8c\uff0c\u76ee\u524d\u9084\u6709\u5176\u4ed6\u4e0d\u540c\u7684\u529f\u80fd\u53ef\u4ee5\u958b\u555f\uff0c\u8b6c\u5982"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"full-pcpus-only"),(0,r.kt)("li",{parentName:"ol"},"distribute-cpus-across-numa"),(0,r.kt)("li",{parentName:"ol"},"align-by-socket")),(0,r.kt)("p",null,"\u8b6c\u5982(1)\u7684\u76ee\u7684\u662f\u5e0c\u671b\u8b93\u5bb9\u5668\u4e0d\u55ae\u7d14\u662f\u7368\u4f54 vCPU\uff0c\u800c\u662f\u7368\u4f54\u6574\u500b Core\uff0c\u4e5f\u5c31\u662f\u6240\u8b02\u7684\u7269\u7406 CPU(pCPU)\uff0c\u76ee\u7684\u662f\u5e0c\u671b\u6e1b\u5c11 noisy neighbours \u554f\u984c\uff0c\u907f\u514d\u5176\u4ed6 vCPU(Thread) \u9020\u6210\u7684\u6548\u80fd\u640d\u8017\u3002"),(0,r.kt)("p",null,"\u8209\u4f8b\u4f86\u8aaa\uff0c\u4e0b\u5716\u662f\u6c92\u6709\u958b\u555f ",(0,r.kt)("strong",{parentName:"p"},"full-pcpus-only")," \u7684\u6548\u679c\uff0c\u96d6\u7136\u53ef\u4ee5\u7368\u4f54 vCPU \u4f46\u662f\u6bcf\u500b Core \u4e0a\u53ef\u80fd\u904b\u884c\u4e0d\u540c\u5169\u500b Container\uff0c\u56e0\u70ba\u670d\u52d9\u4e0d\u540c\u6240\u4ee5 L1/L2 Cache \u5c31\u6709\u53ef\u80fd\u6703\u6709 Cache Miss"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(60755).Z,width:"1051",height:"857"})),(0,r.kt)("p",null,"\u958b\u555f ",(0,r.kt)("strong",{parentName:"p"},"full-pcpus-only")," \u5f8c\u5c31\u53ef\u4ee5\u7368\u4f54\u7269\u7406 CPU(pCPU)\uff0c\u9019\u6a23\u5c31\u53ef\u4ee5\u7368\u4eab\u6574\u500b Cache\uff0c\u6548\u80fd\u4e0a\u5c31\u6703\u66f4\u52a0\u63d0\u5347\uff0c\u4f46\u662f\u5982\u679c\u61c9\u7528\u7a0b\u5f0f\u672c\u8eab\u53ea\u8981\u6c42\u4e00\u500b vCPU \u7684\u8a71\uff0c\u9084\u662f\u6703\u914d\u7f6e\u4e00\u500b Core \u904e\u53bb\uff0c\u9019\u7a2e\u60c5\u6cc1\u4e0b\u6709\u53ef\u80fd\u6703\u767c\u751f\u7368\u4f54\u5169\u500b vCPU \u537b\u53ea\u6709\u7528\u4e00\u500b\u6d6a\u8cbb\u60c5\u6cc1\uff0c\u56e0\u6b64\u4f7f\u7528\u4e0a\u8981\u7279\u5225\u6ce8\u610f\u5e95\u5c64\u67b6\u69cb\u4e26\u4e14\u4ed4\u7d30\u7684\u53bb\u8a2d\u5b9a"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(70493).Z,width:"1265",height:"853"})),(0,r.kt)("h1",{id:"summary"},"Summary"),(0,r.kt)("p",null,"\u61c9\u7528\u7a0b\u5f0f\u5f9e VM \u76f4\u63a5\u642c\u9077\u5230 Kubernetes \u6642\u5f88\u5e38\u9047\u5230\u6548\u80fd\u4e0d\u5982\u9810\u671f\u7684\u60c5\u6cc1\uff0c\u4e0d\u7406\u89e3\u7d30\u7bc0\u7684\u60c5\u6cc1\u4e0b\u6700\u7c21\u55ae\u7684\u505a\u6cd5\u5c31\u662f\u52a0\u5927\u5404\u7a2e\u8cc7\u6e90\uff0c\u6216\u662f\u90e8\u7f72\u66f4\u591a\u526f\u672c\uff0c\u9019\u4e9b\u65b9\u5f0f\u90fd\u6709\u6a5f\u6703\u53ef\u4ee5\u8212\u7de9\u554f\u984c\u75c7\u72c0\uff0c\u4f46\u662f\u6839\u672c\u554f\u984c\u6c92\u89e3\u6c7a\u7684\u60c5\u6cc1\u4e0b\u63d0\u5347\u7a7a\u9593\u6709\u9650\u3002\n\u591a\u7406\u89e3 Container \u8207 VM \u5167\u7684\u6bcf\u500b\u8a2d\u5b9a\u8207\u7d30\u7bc0\uff0c\u5c0d\u65bc\u672a\u4f86\u9047\u5230\u6548\u80fd\u74f6\u9838\u6642\u90fd\u6709\u6a5f\u6703\u5f9e\u4e0d\u540c\u89d2\u5ea6\u5207\u5165\u53bb\u89e3\u6c7a\u554f\u984c\u3002"),(0,r.kt)("p",null,"\u53e6\u5916 CPU Throttling \u4e5f\u4e0d\u662f\u7d55\u5c0d\u6b63\u78ba\uff0cKernel \u5167\u4e5f\u662f\u6709\u904e CPU Throttling \u4e0d\u5920\u7cbe\u6e96\u7684 Bug \u5c0e\u81f4\u61c9\u7528\u7a0b\u5f0f\u6703\u9047\u5230\u4e0d\u5fc5\u8981\u7684 CPU Throttling\uff0c\u56e0\u6b64\u554f\u984c\u767c\u751f\u6642\u4e5f\u53ef\u5617\u8a66\u7814\u7a76\u4e00\u4e0b\u7576\u524d\u4f7f\u7528\u7684 Kernel \u662f\u5426\u6709\u76f8\u95dc bug\u3002"),(0,r.kt)("h1",{id:"reference"},"Reference"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/kubernetes/enhancements/blob/master/keps/sig-node/3570-cpumanager/README.md"},"https://github.com/kubernetes/enhancements/blob/master/keps/sig-node/3570-cpumanager/README.md")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2625-cpumanager-policies-thread-placement"},"https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2625-cpumanager-policies-thread-placement")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2902-cpumanager-distribute-cpus-policy-option"},"https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2902-cpumanager-distribute-cpus-policy-option")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/kubernetes-monitoring/kubernetes-mixin/issues/108"},"https://github.com/kubernetes-monitoring/kubernetes-mixin/issues/108")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://www.datadoghq.com/blog/kubernetes-cpu-requests-limits/"},"https://www.datadoghq.com/blog/kubernetes-cpu-requests-limits/")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://www.cnblogs.com/charlieroro/p/17074808.html"},"https://www.cnblogs.com/charlieroro/p/17074808.html"))))}m.isMDXComponent=!0},98675:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/B12M4ZC8p-ce83c3cafa0ced54d25b06f6f6b5b24e.png"},69722:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Bk5TEXjJ6-7bbb6fe658b858bdc5553e6f38ffd599.png"},49583:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Bk8vRLn8T-66ac4332781cb111feba8bc2b383f60f.png"},82266:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/BkHiRe0Ua-b50f99793cb6bb31f9b402c0941f5db5.png"},48640:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/BkWkI-CUa-2c6942693960afc6ae64e720c0f53e90.png"},70493:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/ByVc0M1va-367be7381e05692badd25d8ce14fc1ec.png"},85194:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/BykX39nUp-21a8f9337baec8834dd753d23faedb75.png"},94819:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/H1NYUvhU6-3cccdb62fd03e214f34b42758663f559.png"},98179:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/HJ3pogRIT-a976e4355da9dc00d2649b3b79847e3c.png"},7651:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/HJPEkD2LT-8d4c62fef9ce4a50315af52677e760fa.png"},11285:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/SJcZkb0L6-ca5adbfdf94a0797a9cf87eed3ce3f70.png"},55279:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/SJhaC83La-54435b3345750cc4040ed8280822d05d.png"},6821:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/SkDkU-C8p-158d5ea8d8d8a4981b6fcff546caccc8.png"},44295:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/r1anUbAIT-9d03a9077726fbfa55e947f8700ead65.png"},73135:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rJFNNbCUp-a1fae0af0d12b0b011e452a1a0f04878.png"},35123:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rJaO9eA8T-088c6d92523efe5430fab404e84a6cce.png"},93437:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rJsxBO286-3e18f0de7a7c0e841bb261d458787aca.png"},54691:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rkjPDgRLT-781a3f1b47c8eb7f37be24ecd4976e55.png"},28456:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rkwxednLT-36b05400d406610913f51809b7421432.png"},89461:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/ryALUkAUT-1ad448832c8fd94e298224b5c14eb26d.png"},60755:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/ryIU6tnIT-83b73cc9e56d2397a2fc492451a521d4.png"}}]);