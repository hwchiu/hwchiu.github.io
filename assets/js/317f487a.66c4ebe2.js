"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[98378],{3905:(t,e,n)=>{n.d(e,{Zo:()=>k,kt:()=>N});var a=n(67294);function l(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function p(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){l(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t,e){if(null==t)return{};var n,a,l=function(t,e){if(null==t)return{};var n,a,l={},r=Object.keys(t);for(a=0;a<r.length;a++)n=r[a],e.indexOf(n)>=0||(l[n]=t[n]);return l}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(a=0;a<r.length;a++)n=r[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(l[n]=t[n])}return l}var i=a.createContext({}),s=function(t){var e=a.useContext(i),n=e;return t&&(n="function"==typeof t?t(e):p(p({},e),t)),n},k=function(t){var e=s(t.components);return a.createElement(i.Provider,{value:e},t.children)},m="mdxType",g={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},u=a.forwardRef((function(t,e){var n=t.components,l=t.mdxType,r=t.originalType,i=t.parentName,k=o(t,["components","mdxType","originalType","parentName"]),m=s(n),u=l,N=m["".concat(i,".").concat(u)]||m[u]||g[u]||r;return n?a.createElement(N,p(p({ref:e},k),{},{components:n})):a.createElement(N,p({ref:e},k))}));function N(t,e){var n=arguments,l=e&&e.mdxType;if("string"==typeof t||l){var r=n.length,p=new Array(r);p[0]=u;var o={};for(var i in e)hasOwnProperty.call(e,i)&&(o[i]=e[i]);o.originalType=t,o[m]="string"==typeof t?t:l,p[1]=o;for(var s=2;s<r;s++)p[s]=n[s];return a.createElement.apply(null,p)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},90713:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>i,contentTitle:()=>p,default:()=>g,frontMatter:()=>r,metadata:()=>o,toc:()=>s});var a=n(87462),l=(n(67294),n(3905));const r={title:"\u521d\u63a2 IPTABLES \u6d41\u52d5\u4e4b\u8def - \u4ee5 Docker \u70ba\u7bc4\u4f8b",tags:["Network","Linux","iptables","Container"],description:"\u672c\u6587\u900f\u904e IPTABLES/EBTABLES \u7684\u898f\u5247\u8207 Docker Container \u7684\u74b0\u5883\u4f86\u89c0\u5bdf\u4e0d\u540c\u60c5\u6cc1\u4e0b\u7684\u5c01\u5305\u6d41\u5411\uff0c\u4e3b\u8981\u662f\u5e6b\u7dda\u4e0a\u8b70\u7a0b\u9032\u884c\u7684\u91cd\u9ede\u6574\u7406\uff0c\u4e3b\u8981\u5167\u5bb9\u90fd\u5728\u5f71\u7247\u4e2d\u3002",date:new Date("2020-05-09T19:01:27.000Z")},p=void 0,o={unversionedId:"techPost/2020/iptables-1",id:"techPost/2020/iptables-1",title:"\u521d\u63a2 IPTABLES \u6d41\u52d5\u4e4b\u8def - \u4ee5 Docker \u70ba\u7bc4\u4f8b",description:"\u672c\u6587\u900f\u904e IPTABLES/EBTABLES \u7684\u898f\u5247\u8207 Docker Container \u7684\u74b0\u5883\u4f86\u89c0\u5bdf\u4e0d\u540c\u60c5\u6cc1\u4e0b\u7684\u5c01\u5305\u6d41\u5411\uff0c\u4e3b\u8981\u662f\u5e6b\u7dda\u4e0a\u8b70\u7a0b\u9032\u884c\u7684\u91cd\u9ede\u6574\u7406\uff0c\u4e3b\u8981\u5167\u5bb9\u90fd\u5728\u5f71\u7247\u4e2d\u3002",source:"@site/docs/techPost/2020/iptables-1.md",sourceDirName:"techPost/2020",slug:"/techPost/2020/iptables-1",permalink:"/docs/techPost/2020/iptables-1",draft:!1,tags:[{label:"Network",permalink:"/docs/tags/network"},{label:"Linux",permalink:"/docs/tags/linux"},{label:"iptables",permalink:"/docs/tags/iptables"},{label:"Container",permalink:"/docs/tags/container"}],version:"current",frontMatter:{title:"\u521d\u63a2 IPTABLES \u6d41\u52d5\u4e4b\u8def - \u4ee5 Docker \u70ba\u7bc4\u4f8b",tags:["Network","Linux","iptables","Container"],description:"\u672c\u6587\u900f\u904e IPTABLES/EBTABLES \u7684\u898f\u5247\u8207 Docker Container \u7684\u74b0\u5883\u4f86\u89c0\u5bdf\u4e0d\u540c\u60c5\u6cc1\u4e0b\u7684\u5c01\u5305\u6d41\u5411\uff0c\u4e3b\u8981\u662f\u5e6b\u7dda\u4e0a\u8b70\u7a0b\u9032\u884c\u7684\u91cd\u9ede\u6574\u7406\uff0c\u4e3b\u8981\u5167\u5bb9\u90fd\u5728\u5f71\u7247\u4e2d\u3002",date:"2020-05-09T19:01:27.000Z"},sidebar:"techPost",previous:{title:"Summary",permalink:"/docs/techPost/2020/iThome_Challenge/cicd-29"},next:{title:"Linux NAT Masquerade \u7814\u7a76(\u4e0b)",permalink:"/docs/techPost/2020/iptables-masquerade-handson"}},i={},s=[{value:"User/Kernel",id:"userkernel",level:2},{value:"\u898f\u5247\u7d44\u6210",id:"\u898f\u5247\u7d44\u6210",level:2},{value:"\u89c0\u5bdf\u65b9\u5f0f",id:"\u89c0\u5bdf\u65b9\u5f0f",level:2},{value:"Chain",id:"chain",level:2},{value:"Tables",id:"tables",level:2},{value:"Workflow",id:"workflow",level:2},{value:"Lab",id:"lab",level:2},{value:"Container to Container",id:"container-to-container",level:3},{value:"Host to Container",id:"host-to-container",level:3},{value:"Chain",id:"chain-1",level:2},{value:"Table",id:"table",level:2},{value:"Workflow",id:"workflow-1",level:2},{value:"Lab",id:"lab-1",level:2},{value:"Contaienr to Container",id:"contaienr-to-container",level:3},{value:"Host to Container",id:"host-to-container-1",level:3},{value:"Container to WAN",id:"container-to-wan",level:3}],k={toc:s},m="wrapper";function g(t){let{components:e,...n}=t;return(0,l.kt)(m,(0,a.Z)({},k,n,{components:e,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"\u672c\u6587\u4e3b\u8981\u662f\u91dd\u5c0d ",(0,l.kt)("a",{parentName:"p",href:"https://www.meetup.com/CloudNative-Taiwan/events/269343753/"},"SDN x Cloud Native Meetup - Webinar \u6d77\u5916\u7bc7 #1\n")," \u9019\u5834\u7dda\u4e0a\u6f14\u8b1b\u9032\u884c\u91cd\u9ede\u6574\u7406\uff0c\u8a73\u7d30\u5167\u5bb9\u8acb\u53c3\u95b1 ",(0,l.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=y4e_B6PdX8A"},"Youtube\u7d00\u9304")),(0,l.kt)("h1",{id:"introduction"},"Introduction"),(0,l.kt)("p",null,"\u672c\u6b21\u6f14\u8b1b\u4e3b\u8981\u662f\u63a2\u8a0e\u5c01\u5305\u57fa\u65bc Docker Container \u7684\u9810\u8a2d\u74b0\u5883\u4e0b\uff0c\u4e0d\u540c\u8d70\u5411\u5be6\u969b\u4e0a\u5c0d\u61c9\u5230 iptables/ebtables \u7684\u5be6\u969b\u6d41\u5411\u3002\n\u6f14\u8b1b\u4e2d\u4e3b\u8981\u91dd\u5c0d\u4e09\u500b\u65b9\u5411\u9032\u884c\u63a2\u8a0e\uff0c\u5206\u5225\u662f"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Host to Container"),(0,l.kt)("li",{parentName:"ol"},"Container to Container"),(0,l.kt)("li",{parentName:"ol"},"Container to WAN")),(0,l.kt)("p",null,"\u6bcf\u500b\u65b9\u5411\u90fd\u5305\u542b\u4e86\u96d9\u5411\u4f86\u56de\uff0c\u8b6c\u5982\nHost to Container \u5176\u5be6\u4e5f\u5305\u542b\u4e86 Container to Host\nContainer to WAN \u4e5f\u5305\u542b\u4e86 WAN to Containe\n\u4e3b\u8981\u5dee\u5225\u5728\u65bc\u8ab0\u767c\u8d77\u4e86\u9023\u7dda\uff0c\u9019\u4e2d\u9593\u5dee\u7570\u4e0d\u5927 (WAN to Container \u53ef\u80fd\u6703\u6709 DNAT)"),(0,l.kt)("p",null,"\u4e0b\u5716\u662f\u9019\u6b21\u6f14\u8b1b\u6700\u4e3b\u8981\u7684\u5716\u7247\uff0c\u63a5\u4e0b\u4f86\u6703\u900f\u904e\u5be6\u969b\u89c0\u5bdf\u7684\u65b9\u5f0f\uff0c\u4e00\u6b65\u4e00\u6b65\u7684\u5efa\u7acb\u8d77\u9019\u5f35\u5716\u7247\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/tAXRdHs.png",alt:null})),(0,l.kt)("h1",{id:"environment"},"Environment"),(0,l.kt)("p",null,"\u672c\u5f71\u7247\u7684\u6e2c\u8a66\u74b0\u5883\u53ef\u900f\u904e Vagrant \u7684\u65b9\u5f0f\u9084\u539f\uff0c\u76f8\u95dc\u8cc7\u6e90\u90fd\u653e\u5728 ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/hwchiu/network-study/tree/master/iptables/iptables_ebtables"},"hwchiu\n/\nnetwork-study")," \u9019\u500b\u5c08\u6848\u5167\uff0c\u53ef\u4ee5\u900f\u904e ",(0,l.kt)("inlineCode",{parentName:"p"},"vagrant up")," \u7684\u65b9\u5f0f\u5c07\u6574\u500b\u74b0\u5883\u5efa\u7acb\u8d77\u4f86"),(0,l.kt)("p",null,"\u7576\u6574\u500b OS \u90fd\u6e96\u5099\u5b8c\u7562\u4e4b\u5f8c\uff0c\u63a5\u4e0b\u4f86\u6703\u63a1\u7528\u4e0b\u5217\u7684\u74b0\u5883\u4f86\u555f\u52d5\u5169\u500b Container \u4e26\u4e14\u4f7f\u7528\u9810\u8a2d\u7684 Linux Bridge \u6a21\u5f0f\u3002\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/W6gqCCG.png",alt:null})),(0,l.kt)("p",null,"\u63a5\u4e0b\u4f86\u6240\u6709\u7684\u64cd\u4f5c\u90fd\u6703\u57fa\u65bc\u9019\u5169\u500b Container \u7684\u4e92\u52d5\u4f86\u89c0\u5bdf\u5c01\u5305\u6d41\u5411"),(0,l.kt)("h1",{id:"basic-concept"},"Basic Concept"),(0,l.kt)("p",null,"\u4e0d\u8ad6\u662f iptables, ebtables \u6216\u662f\u672c\u6587\u6c92\u6709\u63d0\u5230\u7684 arptables, \u5176\u67b6\u69cb\u90fd\u53ef\u4ee5\u7528\u4e0b\u5217\u9019\u5f35\u5716\u7247\u4f86\u89e3\u91cb\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/ujpKTQb.png",alt:null})),(0,l.kt)("h2",{id:"userkernel"},"User/Kernel"),(0,l.kt)("p",null,"\u6240\u6709\u4f60\u53ef\u4ee5\u76f4\u63a5\u5728\u7cfb\u7d71\u4e0a\u64cd\u4f5c\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"iptables-")," \u7cfb\u5217\u5de5\u5177 (ebtables,arptables\u96f7\u540c)\u5168\u90e8\u90fd\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"User Space")," \u7684\u5de5\u5177\uff0c\u5176\u529f\u80fd\u90fd\u662f\u7528\u4f86\u7ba1\u7406 ",(0,l.kt)("inlineCode",{parentName:"p"},"\u898f\u5247"),", \u4f46\u662f\u898f\u5247\u771f\u6b63\u904b\u884c\u88ab\u89f8\u767c\u7684\u6642\u6a5f\u9ede\u90fd\u662f\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"Kernel")," \u5167\u3002"),(0,l.kt)("p",null,"\u5be6\u969b\u4e0a\uff0c ",(0,l.kt)("inlineCode",{parentName:"p"},"iptables")," \u6703\u900f\u904e ",(0,l.kt)("inlineCode",{parentName:"p"},"getsockopt/setsockopt")," \u7b49 IPC \u65b9\u5f0f\u8207 Kernel \u9032\u884c\u6e9d\u901a\uff0c\u4e0d\u8ad6\u662f\u8b80\u53d6\u7576\u524d\u7684\u898f\u5247\uff0c\u6216\u662f\u5beb\u5165\u65b0\u898f\u5247\uff0c\u9019\u908a\u4e5f\u6709\u4e00\u500b\u91cd\u8981\u7684\u6982\u5ff5\u5c31\u662f ",(0,l.kt)("strong",{parentName:"p"},"\u898f\u5247")," \u672c\u8eab\u4e0d\u6703\u88ab\u5132\u5b58\uff0c\u6240\u4ee5\u7576\u6a5f\u5668\u91cd\u65b0\u958b\u6a5f\u7684\u6642\u5019\uff0c ",(0,l.kt)("strong",{parentName:"p"},"kernel")," \u5167\u7684\u898f\u5247\u5c31\u6703\u5168\u90e8\u6d88\u5931\uff0c\u9700\u8981\u4ef0\u8cf4 ",(0,l.kt)("strong",{parentName:"p"},"userspace")," \u7684\u5de5\u5177\u91cd\u65b0\u5beb\u5165\u898f\u5247\u5230 ",(0,l.kt)("strong",{parentName:"p"},"kernel")," \u5167\uff0c"),(0,l.kt)("p",null,"\u4e0a\u8ff0\u7684\u67b6\u69cb\u5176\u5be6\u4e5f\u6703\u8b93\u6574\u500b ",(0,l.kt)("strong",{parentName:"p"},"iptables")," \u7684\u89c0\u5bdf\u8207\u7ba1\u7406\u8b8a\u5f97\u76f8\u5c0d\u56f0\u96e3\uff0c\u56e0\u70ba\u5927\u90e8\u5206\u60c5\u6cc1\u4e0b\u6211\u5011\u90fd\u662f\u4f7f\u7528 ",(0,l.kt)("strong",{parentName:"p"},"iptables-*")," \u7cfb\u5217\u5de5\u5177\u4f86\u9032\u884c\u89c0\u5bdf\u8207\u7ba1\u7406\uff0c\u800c\u5be6\u969b\u4e0a\u5c01\u5305\u5230\u5e95\u600e\u9ebc\u6d41\u52d5\uff0c\u88ab\u54ea\u4e9b\u898f\u5247\u7d66\u4e1f\u68c4\uff0c\u88ab\u54ea\u4e9b\u898f\u5247\u7d66\u4fee\u6539\uff0c\u4e00\u5207\u90fd\u662f\u5728 ",(0,l.kt)("strong",{parentName:"p"},"kernel")," \u5167\u9032\u884c\u3002\n\u9019\u610f\u5473\u8005\u6211\u5011\u5fc5\u9808\u8981\u76f8\u4fe1 ",(0,l.kt)("strong",{parentName:"p"},"iptablse")," \u8207 ",(0,l.kt)("strong",{parentName:"p"},"kernel")," \u7684\u6e9d\u901a\u662f\u6c92\u6709\u554f\u984c\u7684\uff0c\u4e0d\u7136\u55ae\u7d14\u4f9d\u9760 ",(0,l.kt)("strong",{parentName:"p"},"userspace")," \u7684\u5de5\u5177\u4f86\u89c0\u5bdf\u7d50\u679c\u5176\u5be6\u662f\u6703\u6709\u4e00\u4e9b\u4e0d\u78ba\u5b9a\u6027\u3002"),(0,l.kt)("p",null,"\u4f46\u662f\u5982\u679c\u8981\u89c0\u5bdf\u9019\u4e00\u5207\u7684\u8a0a\u606f\u90fd\u8981\u53bb\u6539 Kernel \u4f86\u5e6b\u52a9\u9664\u932f\uff0c\u9019\u65b9\u9762\u7684\u5de5\u8207\u7cbe\u529b\u4e5f\u82b1\u8cbb\u592a\u5927\uff0c\u6240\u4ee5\u4e00\u822c\u60c5\u6cc1\u4e0b\u90fd\u9084\u662f\u57fa\u65bc ",(0,l.kt)("strong",{parentName:"p"},"iptables")," \u7684\u898f\u5247\u4f86\u89e3\u8b80\u5c01\u5305\u8207 iptables \u4e4b\u9593\u7684\u95dc\u4fc2\u3002"),(0,l.kt)("h2",{id:"\u898f\u5247\u7d44\u6210"},"\u898f\u5247\u7d44\u6210"),(0,l.kt)("p",null,"\u5927\u62b5\u4e0a\uff0c iptables/ebtables/arptables \u7684\u898f\u5247\u7d44\u6210\u662f\u6709\u4e00\u8a02\u7684\u898f\u7bc4\uff0c\u4e00\u500b\u4f7f\u7528\u7bc4\u4f8b\u5982\u4e0b\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/Ki0OnyE.png",alt:null})),(0,l.kt)("p",null,"\u9019\u500b\u898f\u7bc4\u4e2d\u53ef\u4ee5\u5206\u6210\u56db\u500b\u90e8\u5206"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Chain: \u6700\u7c21\u55ae\u7684\u60f3\u6cd5\u5c31\u662f\u5c01\u5305\u767c\u751f\u7684\u6642\u9593\u9ede\uff0c\u8b6c\u5982\u4e0a\u8ff0\u7684 ",(0,l.kt)("strong",{parentName:"li"},"OUTPUT"),", ",(0,l.kt)("strong",{parentName:"li"},"INPUT")),(0,l.kt)("li",{parentName:"ol"},"Table: \u4e00\u7fa4\u76f8\u540c\u898f\u5247\u7684\u96c6\u5408\u9ad4\uff0c\u8b6c\u5982 ",(0,l.kt)("strong",{parentName:"li"},"nat"),", ",(0,l.kt)("strong",{parentName:"li"},"filter"),", \u8a72 ",(0,l.kt)("strong",{parentName:"li"},"table")," \u5167\u7684\u898f\u5247\u90fd\u6709\u985e\u4f3c\u7684\u76ee\u7684"),(0,l.kt)("li",{parentName:"ol"},"Match: \u7b26\u5408\u7684\u689d\u4ef6\uff0c\u53ef\u4ee5\u60f3\u6210\u8a72\u898f\u5247\u8981\u88ab\u89f8\u767c\u7684\u689d\u4ef6\uff0c\u8b6c\u5982\u4e0a\u8ff0\u7684 ",(0,l.kt)("strong",{parentName:"li"},"! -d 127.0.0.0/8 -m addrtype --dst-tppe LOCAL"),", \u9019\u90e8\u5206\u53ef\u4ee5\u662f ",(0,l.kt)("strong",{parentName:"li"},"iptables")," \u5167\u5efa\u7684\u57fa\u672c\u689d\u4ef6\uff0c\u6216\u662f\u900f\u904e ",(0,l.kt)("strong",{parentName:"li"},"-m")," \u4f86\u52d5\u614b\u8f09\u5165\u7684\u5176\u4ed6\u7684 module"),(0,l.kt)("li",{parentName:"ol"},"Target: \u7576\u898f\u5247\u7b26\u5408\u689d\u4ef6\u5f8c\uff0c\u8981\u505a\u4ec0\u9ebc\u4e8b\u60c5\uff0c\u8b6c\u5982\u4e0a\u8ff0\u7684 ",(0,l.kt)("strong",{parentName:"li"},"-j DOCKER, --log-level debug"),"\n, \u5982\u540c ",(0,l.kt)("strong",{parentName:"li"},"Match")," \u4e00\u6a23\uff0c\u6709\u5167\u5efa\u7684 ",(0,l.kt)("strong",{parentName:"li"},"Target")," \u5916\u4e5f\u53ef\u4ee5\u52d5\u614b\u8f09\u5165\u5176\u4ed6 module \u4f86\u8655\u7406\u3002")),(0,l.kt)("p",null,"\u6240\u4ee5\u4eca\u5929\u5982\u679c\u8981\u5beb\u5165\u4e00\u500b iptables\u898f\u5247\uff0c\u601d\u8def\u5927\u6982\u662f\n\u6211\u60f3\u8981\u64b0\u5beb\u4e00\u500b\u898f\u5247\uff0c\u9019\u500b\u898f\u5247\u6703\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"\u4ec0\u9ebc\u6642\u9593\u9ede")," \u88ab\u89f8\u767c\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"\u4ec0\u9ebc\u6a23\u7684\u5c01\u5305")," \u7b26\u5408\u689d\u4ef6\uff0c\u6700\u5f8c\u8981",(0,l.kt)("inlineCode",{parentName:"p"},"\u57f7\u884c\u4ec0\u9ebc\u52d5\u4f5c"),".\n\u800c\u6839\u64da\u52d5\u4f5c\u7684\u985e\u578b\u518d\u628a\u9019\u500b\u898f\u5247\u653e\u5230\u5c0d\u61c9\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"Table")," \u88e1\u9762\u3002"),(0,l.kt)("h2",{id:"\u89c0\u5bdf\u65b9\u5f0f"},"\u89c0\u5bdf\u65b9\u5f0f"),(0,l.kt)("p",null,"\u6709\u4e86\u4e0a\u9762\u7684\u6982\u5ff5\u5f8c\uff0c\u672c\u6587\u5c31\u6703\u4f7f\u7528 ",(0,l.kt)("strong",{parentName:"p"},"LOG")," \u6982\u5ff5\u7684 ",(0,l.kt)("strong",{parentName:"p"},"Target")," \u4f86\u89c0\u5bdf\u5c01\u5305\u6d41\u5411\uff0c\u6574\u500b\u898f\u5247\u7684\u542b\u7fa9\u5c31\u662f\n\u5728",(0,l.kt)("strong",{parentName:"p"},"\u4ec0\u9ebc\u6642\u9593\u9ede"),",",(0,l.kt)("strong",{parentName:"p"},"\u91dd\u5c0d\u6211\u5011\u60f3\u8981\u89c0\u5bdf\u7684\u6d41\u5411\u5c01\u5305"),",",(0,l.kt)("strong",{parentName:"p"},"\u8f38\u51fa\u76f8\u95dc\u8cc7\u8a0a"),"\u3002\n\u85c9\u7531\u9019\u4e9b\u8cc7\u8a0a\uff0c\u6211\u5011\u53ef\u4ee5\u7d44\u5408\u51fa\u5c01\u5305\u65bc iptables/ebtalbes/arptables \u5167\u7684\u6d41\u5411\n",(0,l.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff0c\u9019\u908a\u53ea\u80fd\u505a\u5230 iptables/ebtables/arptables \u5167\u7684\u6d41\u5411\uff0c\u5176\u9918\u66f4\u7d30\u90e8\u7684 network stack \u8655\u7406\u5247\u6c92\u6709\u8fa6\u6cd5")),(0,l.kt)("h1",{id:"ebtables"},"EBTABLES"),(0,l.kt)("p",null,"EBTABLES \u76f8\u5c0d\u65bc ",(0,l.kt)("strong",{parentName:"p"},"IPTABLES")," \u4f86\u8aaa\u6bd4\u8f03\u964c\u751f\uff0c\u4e3b\u8981\u662f\u5176\u904b\u4f5c\u7684\u5c64\u6b21\u66f4\u4f4e\uff0c\u57fa\u65bc ",(0,l.kt)("strong",{parentName:"p"},"ethernet")," \u4f86\u8655\u7406\uff0c\u4e00\u822c\u4f7f\u7528\u60c5\u6cc1\u4e0b\uff0c\u5927\u5bb6\u90fd\u6bd4\u8f03\u4f9d\u8cf4 ",(0,l.kt)("strong",{parentName:"p"},"iptables"),"\uff0c\u4e5f\u662f\u56e0\u70ba\u900f\u904e ",(0,l.kt)("strong",{parentName:"p"},"IP")," \u7684\u63cf\u8ff0\u65b9\u5f0f\u6703\u6bd4\u4f7f\u7528 ",(0,l.kt)("strong",{parentName:"p"},"MAC Address")," \u4f86\u5f97\u66f4\u4f73\u5bb9\u6613\u8a18\u61b6\u8207\u7ba1\u7406\u3002"),(0,l.kt)("p",null,"\u5373\u7ba1\u5982\u6b64\uff0c",(0,l.kt)("strong",{parentName:"p"},"ebtables")," \u7684\u5b58\u5728\u9084\u662f\u4e0d\u53ef\u5ffd\u8996\uff0c\u4e5f\u8a31\u67d0\u4e00\u5929\u4f60\u7684\u61c9\u7528\u5834\u666f\u5c31\u6703\u9700\u8981\u4f7f\u7528\u5230 ",(0,l.kt)("strong",{parentName:"p"},"ebtables")," \u4f86\u7ba1\u7406"),(0,l.kt)("h2",{id:"chain"},"Chain"),(0,l.kt)("p",null,"EBTABLES \u5167\u7e3d\u5171\u6709\u516d\u689d ",(0,l.kt)("strong",{parentName:"p"},"Chain"),"\uff0c\u4e5f\u5c31\u662f\u516d\u500b\u6642\u6a5f\u9ede"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"INPUT:\n\u6839\u64da ",(0,l.kt)("strong",{parentName:"li"},"Forwarding table"),", \u8a72\u5c01\u5305\u8981\u9001\u5230 ",(0,l.kt)("strong",{parentName:"li"},"Linux Bridge")," \u524d"),(0,l.kt)("li",{parentName:"ol"},"FORWARD:\n\u6839\u64da ",(0,l.kt)("strong",{parentName:"li"},"Forwarding table"),"\uff0c\u8a72\u5c01\u5305\u8981\u88ab\u8f49\u767c\u5230\u5176\u4ed6\u9023\u63a5\u57e0\u524d (\u4e0d\u80fd\u662f Linux Bridge \u672c\u8eab\uff0c\u5426\u5247\u6703\u8d70 INPUT)"),(0,l.kt)("li",{parentName:"ol"},"OUTPUT:\n\u672c\u5730\u7522\u751f\u7684\u5c01\u5305\uff0c\u6700\u5f8c\u76ee\u7684\u662f ",(0,l.kt)("strong",{parentName:"li"},"Linux Bridge")," \u5e95\u4e0b\u7684\u9023\u63a5\u57e0\uff0c\u57fa\u672c\u4e0a\u8207 ",(0,l.kt)("strong",{parentName:"li"},"FORWARD")," \u975e\u5e38\u76f8\u4f3c\uff0c\u53ea\u662f\u4e00\u500b\u4f86\u6e90\u662f\u5176\u4ed6\u4eba\uff0c\u4e00\u500b\u662f\u81ea\u5df1\u6a5f\u5668\u672c\u8eab"),(0,l.kt)("li",{parentName:"ol"},"PRE-ROUTING:\n\u6211\u770b\u904e\u4e00\u4e9b\u8a55\u8ad6\uff0c\u8ddf\u6211\u7684\u60f3\u6cd5\u6eff\u985e\u4f3c\u7684\u5c31\u662f\u9019\u908a\u6e96\u78ba\u7684\u8aaa\u61c9\u8a72\u662f ",(0,l.kt)("strong",{parentName:"li"},"PRE-FORWARDING"),", \u56e0\u70ba\u9019\u500b\u5c64\u7d1a\u6211\u5011\u4e0d\u63a2\u8a0e ",(0,l.kt)("strong",{parentName:"li"},"IP"),"\uff0c\u4e0d\u6703\u7528 ",(0,l.kt)("strong",{parentName:"li"},"Routing")," \u9019\u500b\u5b57\uff0c\u4f46\u662f\u7406\u8ad6\u8207\u5be6\u4f5c\u672c\u4f86\u5c31\u6703\u6709\u6240\u5dee\u7570\uff0c\u8207 ",(0,l.kt)("strong",{parentName:"li"},"IPTABLES")," \u5171\u7528\u76f8\u540c\u7684\u7d50\u69cb\u5728\u5be6\u4f5c\u4e0a\u6703\u6bd4\u8f03\u7c21\u55ae\u4e9b\u3002\n\u9019\u500b\u6642\u9593\u9ede\u4e3b\u8981\u662f\u7528\u5728\u525b\u525b\u5f9e ",(0,l.kt)("inlineCode",{parentName:"li"},"Linux Bridge")," \u76f8\u95dc\u9023\u63a5\u57e0\u6536\u5230\u5c01\u5305\u5f8c\uff0c\u9084\u6c92\u6709\u900f\u904e ",(0,l.kt)("strong",{parentName:"li"},"Forwarding table")," \u6c7a\u5b9a\u76ee\u6a19\u524d\uff0c\u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc\u7a31\u70ba ",(0,l.kt)("strong",{parentName:"li"},"PRE-")," \u7684\u539f\u56e0\uff0c\u4e3b\u8981\u90fd\u662f\u7528\u4f86\u4fee\u6539\u5c01\u5305\u5167\u5bb9")),(0,l.kt)("p",null,"\u984c\u5916\u8a71\uff1a\u56e0\u70ba\u9084\u6c92\u6709\u88ab ",(0,l.kt)("strong",{parentName:"p"},"Forwarding Table")," \u6c7a\u5b9a\u600e\u9ebc\u8f49\u9001\uff0c\u6240\u4ee5\u901a\u5e38\u9019\u6642\u5019\u90fd\u53ef\u4ee5\u4fee\u6539\u5c01\u5305\u7684\u76ee\u7684\u5730"),(0,l.kt)("ol",{start:5},(0,l.kt)("li",{parentName:"ol"},"POST-ROUTING:\n\u57fa\u672c\u4e0a\u8ddf ",(0,l.kt)("strong",{parentName:"li"},"PRE-ROUTING")," \u662f\u96f7\u540c\u7684\uff0c\u6982\u5ff5\u6539\u6210 ",(0,l.kt)("strong",{parentName:"li"},"\u5c01\u5305\u8981\u5f9e\u7db2\u5361\u51fa\u53bb\u524d")," \u6703\u89f8\u767c\u7684\u6642\u9593\u9ede\uff0c\u4e5f\u6703\u7528\u4f86\u4fee\u6539\u5c01\u5305")),(0,l.kt)("p",null,"\u984c\u5916\u8a71\uff1a\u56e0\u70ba\u9084\u5df2\u7d93\u88ab ",(0,l.kt)("strong",{parentName:"p"},"Forwarding Table")," \u6c7a\u5b9a\u600e\u9ebc\u8f49\u9001\uff0c\u901a\u5e38\u9019\u6642\u5019\u4e0d\u53ef\u4ee5\u4fee\u6539\u5c01\u5305\u7684\u76ee\u7684\u5730\uff0c\u4f46\u662f\u53ef\u4ee5\u4fee\u6539\u5c01\u5305\u7684\u4f86\u6e90"),(0,l.kt)("ol",{start:7},(0,l.kt)("li",{parentName:"ol"},"BROUTING:\n\u9019\u662f\u4e00\u500b ebtalbes \u7368\u6709\u7684\u9ede\uff0c\u975e\u5e38\u5c11\u7528\uff0c\u89f8\u767c\u6642\u9593\u9ede\u975e\u5e38\u65e9\uff0c\u5c01\u5305\u6536\u5230\u5f8c\u5c31\u6703\u5148\u9032\u5165\u5230\u9019\u908a\u53bb\u8655\u7406\n\u9019\u500b\u6642\u9593\u9ede\u80fd\u505a\u7684\u4e8b\u60c5\u53ea\u6709 ",(0,l.kt)("strong",{parentName:"li"},"\u5c01\u5305\u8981\u4e0d\u8981\u76f4\u63a5\u9001\u5230 Layer3 \u53bb\u8655\u7406")," \u7684\u5224\u65b7\u3002")),(0,l.kt)("p",null,"\u4ee5\u4e0a\u5c31\u662f ",(0,l.kt)("strong",{parentName:"p"},"ebtalbe")," \u7684\u516d\u500b\u6642\u6a5f\u9ede\uff0c\u63a5\u4e0b\u4f86\u770b\u770b\u6709\u54ea\u4e9b ",(0,l.kt)("strong",{parentName:"p"},"table")," \u6700\u5f8c\u5982\u4f55\u7d44\u5408\u518d\u4e00\u8d77"),(0,l.kt)("h2",{id:"tables"},"Tables"),(0,l.kt)("p",null,"Table\u65b9\u9762\u5247\u662f\u6703\u6709\u4e09\u500b"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Filter\n\u7528\u4f86\u904e\u6ffe\u5c01\u5305\uff0c\u53ef\u4ee5\u6c7a\u5b9a\u8981\u4e0d\u8981\u4e1f\u68c4\u6216\u662f\u901a\u904e"),(0,l.kt)("li",{parentName:"ol"},"NAT\n\u91dd\u5c0d PRE-ROUTING/POST-ROUTING \u7b49\u6642\u6a5f\u9ede\u4f7f\u7528\uff0c\u53bb\u4fee\u6539\u5c01\u5305\u7684 MAC Address"),(0,l.kt)("li",{parentName:"ol"},"Brout\n\u9019\u500b\u662f\u975e\u5e38\u7279\u5225\uff0c\u5c31\u91dd\u5c0d BROUTING \u9019\u500b chain \u53bb\u4f7f\u7528\u800c\u5df2")),(0,l.kt)("p",null,"\u6bcf\u500b Table \u90fd\u6709\u81ea\u5df1\u642d\u914d\u7684 Chain, \u6240\u6709\u7684\u898f\u5247\u90fd\u5b9a\u7fa9\u65bc ",(0,l.kt)("strong",{parentName:"p"},"Linux Kernel")," \u5167\uff0c\u521d\u59cb\u5316\u9019\u4e9b ",(0,l.kt)("strong",{parentName:"p"},"Table")," \u7684\u6642\u5019\u5c31\u6703\u53bb\u6c7a\u5b9a\u6709\u54ea\u4e9b ",(0,l.kt)("strong",{parentName:"p"},"Chain")," \u53ef\u4ee5\u8207\u4e4b\u5339\u914d\u3002"),(0,l.kt)("h2",{id:"workflow"},"Workflow"),(0,l.kt)("p",null,"\u5c07\u4e0a\u8ff0\u7684 ",(0,l.kt)("strong",{parentName:"p"},"Chain")," \u8207 ",(0,l.kt)("strong",{parentName:"p"},"Table")," \u7d50\u5408\u5f8c\u6703\u5f97\u5230\u9019\u5f35\u5716\u7247\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/didIHNQ.png",alt:null})),(0,l.kt)("p",null,"\u5716\u7247\u4e2d\u5148\u5ffd\u7565\u6240\u6709 ",(0,l.kt)("strong",{parentName:"p"},"iptables")," \u7684\u8655\u7406\uff0c\u5c08\u5fc3\u89c0\u5bdf ",(0,l.kt)("strong",{parentName:"p"},"ebtables")," \u7684\u67b6\u69cb\uff0c\u5716\u4e2d\u7684 ",(0,l.kt)("strong",{parentName:"p"},"Bridging Decision")," \u4e5f\u5c31\u662f\u672c\u6587\u4e0a\u8ff0\u63d0\u7684 ",(0,l.kt)("strong",{parentName:"p"},"Forwarding table"),", \u7528\u4f86\u6c7a\u5b9a\u65b9\u5411\u3002"),(0,l.kt)("h2",{id:"lab"},"Lab"),(0,l.kt)("p",null,"\u63a5\u4e0b\u4f86\u8981\u900f\u904e\u5be6\u969b\u64cd\u4f5c\u4f86\u9a57\u8b49\u4e0a\u8ff0\u7684\u884c\u70ba\uff0c\u6703\u4f7f\u7528\u985e\u4f3c\u65bc\u4e0b\u9762\u7528\u6cd5\u7684\u898f\u5247\u4f86\u986f\u793a\u8cc7\u8a0a\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/avlfprm.png",alt:null}),"\n\u9019\u6a23\u7576\u5c01\u5305\u7d93\u904e\u6642\u5c31\u6703\u5c07\u8cc7\u8a0a\u5410\u51fa\uff0c\u53ef\u4ee5\u900f\u904e ",(0,l.kt)("strong",{parentName:"p"},"dmesg")," \u4f86\u89c0\u5bdf"),(0,l.kt)("p",null,"\u5b8c\u6574\u898f\u5247\u5982\u4e0b\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/W4HzYOi.png",alt:null})),(0,l.kt)("h3",{id:"container-to-container"},"Container to Container"),(0,l.kt)("p",null,"Contaienr to Contaienr \u7684\u65b9\u5f0f\u975e\u5e38\u7c21\u55ae\uff0c\u5c31\u76f4\u63a5\u8b93\u5169\u500b Container \u900f\u904e ",(0,l.kt)("strong",{parentName:"p"},"ICMP request/reply")," \u4f86\u7522\u751f\u6d41\u91cf\u5373\u53ef"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash="},"sudo docker exec netutils ping 172.18.0.2 -c1\n")),(0,l.kt)("p",null,(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/hD5y2GM.png",alt:null}),"\n\u6700\u5f8c\u89c0\u5bdf ",(0,l.kt)("strong",{parentName:"p"},"kernel log")," \u6703\u5f97\u5230\u985e\u4f3c\u4e0b\u5217\u7684\u8f38\u51fa"),(0,l.kt)("p",null,(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/R5bEplY.png",alt:null}),"\n\u5c07\u9019\u4e9b\u8f38\u51fa\u7d50\u679c\u8207\u524d\u9762\u7684\u6d41\u7a0b\u5716\u5408\u4f75\u5f8c\uff0c\u53ef\u4ee5\u5f97\u5230\u4e0b\u5217\u7684\u8cc7\u8a0a\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/DwPgD3L.png",alt:null})),(0,l.kt)("p",null,"\u57fa\u672c\u4e0a Container to Container \u5c31\u53ea\u6703\u7d93\u904e\u9019\u56db\u500b\u9ede"),(0,l.kt)("h3",{id:"host-to-container"},"Host to Container"),(0,l.kt)("p",null,"Host to Container \u4e5f\u662f\u4f7f\u7528 ",(0,l.kt)("strong",{parentName:"p"},"ICMP Request/Reply")," \u4f86\u8655\u7406\uff0c\u4e0d\u904e\u662f\u7531 ",(0,l.kt)("strong",{parentName:"p"},"host")," \u672c\u8eab\u767c\u8d77\uff0c\u6240\u4ee5\u6982\u5ff5\u5982\u4e0b\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/CpIONzF.png",alt:null})),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash="},"sudo ping 172.18.0.2 -c1\n")),(0,l.kt)("p",null,"\u89c0\u5bdf ",(0,l.kt)("strong",{parentName:"p"},"kernel log"),"\u6703\u5f97\u5230\u985e\u4f3c\u4e0b\u5217\u8f38\u51fa\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/9ExPHOr.png",alt:null}),"\n\u6574\u7406\u5f8c\u6703\u5f97\u5230\u985e\u4f3c\u9019\u7a2e\u8d70\u5411\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/KWaemyK.png",alt:null})),(0,l.kt)("p",null,"\u53ef\u4ee5\u770b\u5230 ",(0,l.kt)("strong",{parentName:"p"},"Host to Contaienr")," \u5247\u6703\u8d70 ",(0,l.kt)("strong",{parentName:"p"},"output")," \u51fa\u53bb\uff0c\u800c ",(0,l.kt)("strong",{parentName:"p"},"Container to Host")," \u6700\u5f8c\u5247\u662f\u5728 ",(0,l.kt)("strong",{parentName:"p"},"Bridging Decision")," \u6c7a\u7b56\u5f8c\u8d70 ",(0,l.kt)("strong",{parentName:"p"},"INPUT")," \u4e0a\u53bb\u3002"),(0,l.kt)("p",null,"\u66f4\u591a\u8a73\u7d30\u7684\u64cd\u4f5c\u904e\u7a0b\u53ef\u4ee5\u89c0\u770b\u5f71\u7247\uff0c\u88e1\u9762\u6709\u5be6\u969b\u7684 Demo \u4ee5\u53ca\u76f8\u95dc\u7684\u64cd\u4f5c\u3002"),(0,l.kt)("h1",{id:"iptables"},"IPTABLES"),(0,l.kt)("p",null,"IPTABLES \u6982\u5ff5\u975e\u5e38\u96f7\u540c\uff0c\u6709\u56db\u500b ",(0,l.kt)("strong",{parentName:"p"},"Table"),", 5\u500b ",(0,l.kt)("strong",{parentName:"p"},"Chain"),"\uff0c\u6b64\u5916\u9084\u6709 ",(0,l.kt)("strong",{parentName:"p"},"Conntrack(Connnection Track)")," \u5728\u8f14\u4f50\u5e6b\u5fd9\u3002"),(0,l.kt)("p",null,"\u9019\u908a\u6211\u5011\u5c08\u6ce8\u65bc ",(0,l.kt)("strong",{parentName:"p"},"IPTABLES")," \u672c\u8eab\uff0c ",(0,l.kt)("strong",{parentName:"p"},"Conntrack")," \u7684\u6982\u5ff5\u5c31\u4e0d\u7d00\u9304\u592a\u591a\uff0c\u5f71\u7247\u4e2d\u6709\u4e00\u4e9b\u6bb5\u843d\u518d\u4ecb\u7d39\u5176\u6982\u5ff5\u8207\u5f71\u97ff\u3002"),(0,l.kt)("h2",{id:"chain-1"},"Chain"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"INPUT"),(0,l.kt)("li",{parentName:"ol"},"FORWARD"),(0,l.kt)("li",{parentName:"ol"},"OUTPUT"),(0,l.kt)("li",{parentName:"ol"},"PREROUTING"),(0,l.kt)("li",{parentName:"ol"},"POSTROUTING")),(0,l.kt)("p",null,"\u9019\u908a\u7684\u6982\u5ff5\u8ddf ",(0,l.kt)("strong",{parentName:"p"},"EBTALBE")," \u5b8c\u5168\u4e00\u6a23\uff0c\u53ea\u662f ",(0,l.kt)("strong",{parentName:"p"},"\u5168\u90e8\u7684 Forwarding Table")," \u90fd\u8981\u63db\u6210\u57fa\u65bc ",(0,l.kt)("strong",{parentName:"p"},"IP")," \u67e5\u8a62\u7684 ",(0,l.kt)("strong",{parentName:"p"},"Routing Table"),"\uff0c\u4e26\u4e14\u6c92\u6709\u4e86 ",(0,l.kt)("strong",{parentName:"p"},"BROUTING")," \u9019\u500b\u9ede\u3002"),(0,l.kt)("h2",{id:"table"},"Table"),(0,l.kt)("p",null,"\u9664\u4e86\u539f\u6709\u4e86 ",(0,l.kt)("strong",{parentName:"p"},"Filter")," \u4ee5\u53ca ",(0,l.kt)("strong",{parentName:"p"},"NAT")," \u4e4b\u5916\uff0c\u591a\u51fa\u4e86 ",(0,l.kt)("strong",{parentName:"p"},"RAW")," \u4ee5\u53ca ",(0,l.kt)("strong",{parentName:"p"},"MANGLE")," \u5169\u5f35 ",(0,l.kt)("strong",{parentName:"p"},"Table"),"."),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"RAW\nRAW \u9019\u500b Table \u672c\u8eab\u88ab\u547c\u53eb\u7684\u9806\u5e8f\u5c31\u5f88\u65e9\uff0c\u57fa\u672c\u662f\u88ab ",(0,l.kt)("strong",{parentName:"li"},"Conntrack")," \u8655\u7406\u524d\u6703\u547c\u53eb\u7684 Table"),(0,l.kt)("li",{parentName:"ol"},"Mangel\n\u9019\u500b\u53ef\u4ee5\u7528\u4f86\u9032\u884c\u4e00\u4e9b\u4fee\u6539\u5c01\u5305\u7684\u5167\u5bb9\uff0c\u8b6c\u5982 mark \u7b49\u4e4b\u985e\u7684\u8cc7\u8a0a")),(0,l.kt)("p",null,"\u6700\u5e38\u7528\u7684\u9084\u662f ",(0,l.kt)("strong",{parentName:"p"},"filter")," \u4ee5\u53ca ",(0,l.kt)("strong",{parentName:"p"},"NAT"),"\u3002"),(0,l.kt)("h2",{id:"workflow-1"},"Workflow"),(0,l.kt)("p",null,"iptables \u672c\u8eab\u7684\u6d41\u5411\u7c21\u5316\u7248\u672c\u5982\u4e0b"),(0,l.kt)("p",null,(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/wQoCYtx.png",alt:null})),(0,l.kt)("p",null,"\u6982\u5ff5\u8ddf ",(0,l.kt)("strong",{parentName:"p"},"ebtables")," \u975e\u5e38\u50cf\uff0c\u9019\u908a\u900f\u904e ",(0,l.kt)("strong",{parentName:"p"},"Routing")," \u4f86\u6c7a\u5b9a\u5c01\u5305\u8d70\u5411\u3002"),(0,l.kt)("p",null,"\u7531\u65bc\u524d\u9762\u6709 ",(0,l.kt)("strong",{parentName:"p"},"ebtables")," \u7684\u7d93\u9a57\uff0c\u6211\u5011\u5148\u5c07\u5169\u8005\u5408\u4f75\u7684\u5716\u7247\u5c55\u793a\uff0c\u63a5\u4e0b\u4f86\u518d\u900f\u904e\u89c0\u5bdf\u7684\u65b9\u5f0f\u9a57\u8b49\u9019\u5f35\u5716\u7247\u4e2d\u7684\u5c01\u5305\u6d41\u5411\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/rTmTiJz.png",alt:null})),(0,l.kt)("h2",{id:"lab-1"},"Lab"),(0,l.kt)("p",null,"\u89c0\u5bdf\u7684\u65b9\u5f0f\u8ddf ",(0,l.kt)("strong",{parentName:"p"},"ebtable")," \u4e00\u6a23\uff0c\u900f\u904e ",(0,l.kt)("strong",{parentName:"p"},"LOG")," \u7684\u65b9\u5f0f\u4f86\u89c0\u5bdf\u5c01\u5305\uff0c\u8b6c\u5982"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash="},"iptables -t mangle -I PREROUTING -p tcp -d 172.18.0.0/16 -j LOG --log-prefix '/iptable/mangle-PREROUTE' --log-level debug\n")),(0,l.kt)("p",null,"\u5b8c\u6574\u7684\u898f\u5247\u5982\u4e0b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash="},"insert() {\n    iptables -t raw -I PREROUTING -p icmp -j LOG --log-prefix 'iptable/raw-PREROUTE' --log-level debug\n    iptables -t mangle -I PREROUTING -p icmp -j LOG --log-prefix 'iptable/mangle-PREROUTE' --log-level debug\n    iptables -t nat -I PREROUTING -p icmp -j LOG --log-prefix 'iptable/nat-PREROUTE' --log-level debug\n\n    iptables -t mangle -I FORWARD -p icmp -j LOG --log-prefix 'iptable/mangle-FORWARD' --log-level debug\n    iptables -t filter -I FORWARD -p icmp -j LOG --log-prefix 'iptable/filter-FORWARD' --log-level debug\n\n    iptables -t mangle -I INPUT -p icmp -j LOG --log-prefix 'iptable/mangle-INPUT' --log-level debug\n    iptables -t filter -I INPUT -p icmp -j LOG --log-prefix 'iptable/filter-INPUT' --log-level debug\n\n\n    iptables -t raw -I OUTPUT -p icmp -j LOG --log-prefix 'iptable/raw-OUTPUT' --log-level debug\n    iptables -t mangle -I OUTPUT -p icmp -j LOG --log-prefix 'iptable/mangle-OUTPUT' --log-level debug\n    iptables -t nat -I OUTPUT -p icmp -j LOG --log-prefix 'iptable/nat-OUTPUT' --log-level debug\n    iptables -t filter -I OUTPUT -p icmp -j LOG --log-prefix 'iptable/filter-OUTPUT' --log-level debug\n\n    iptables -t mangle -I POSTROUTING -p icmp -j LOG --log-prefix 'iptable/mangle-POSTROUTE' --log-level debug\n    iptables -t nat -I POSTROUTING -p icmp -j LOG --log-prefix 'iptable/nat-POSTROUTE' --log-level debug\n }\n")),(0,l.kt)("p",null,"ebtables \u7684\u898f\u5247\u4e5f\u4e00\u4f75\u4fdd\u7559\u4e00\u8d77\u4f7f\u7528\uff0c\u5c31\u53ef\u4ee5\u89c0\u5bdf iptables+ebtables \u7684\u6d41\u5411"),(0,l.kt)("h3",{id:"contaienr-to-container"},"Contaienr to Container"),(0,l.kt)("p",null,"\u6307\u4ee4\u5982\u4e0b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash="},"sudo docker exec netutils ping 172.18.0.2 -c 1\n")),(0,l.kt)("p",null,"\u4e0b\u9762\u5169\u5f35\u5716\u5c31\u662f\u53bb\u56de\u6d41\u5411\uff0c\u9019\u908a\u6709\u5169\u500b\u9ede\u8981\u6ce8\u610f\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/0fCdsSy.png",alt:null}),"\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/OHGBMsJ.png",alt:null})),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u56de\u4f86\u7684\u5c01\u5305\u4e0d\u6703\u9032\u5165\u5230 ",(0,l.kt)("strong",{parentName:"li"},"NAT")," table, \u4e3b\u8981\u662f\u9019\u4e9b\u5c01\u5305\u88ab ",(0,l.kt)("strong",{parentName:"li"},"Conntion Track(Conntrack)")," \u7d66\u8655\u7406\u904e\uff0c\u63a5\u4e0b\u4f86\u90fd\u4e0d\u6703\u9032\u5165 ",(0,l.kt)("strong",{parentName:"li"},"NAT")," \u8655\u7406\u3002"),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},"ebtables")," \u5167\u6703\u5077\u5077\u547c\u53eb ",(0,l.kt)("strong",{parentName:"li"},"iptables")," \u4f86\u9032\u884c\u8655\u7406\uff0c\u9019\u90e8\u5206\u662f\u500b\u52d5\u614b\u958b\u95dc\uff0c\u53ef\u4ee5\u900f\u904e\n",(0,l.kt)("inlineCode",{parentName:"li"},"/proc/sys/net/bridge/bridge-nf-call-iptables\n")," \u4f86\u544a\u8a34 ",(0,l.kt)("strong",{parentName:"li"},"kernel")," \u8981\u4e0d\u8981\u5077\u5077\u547c\u53eb ",(0,l.kt)("strong",{parentName:"li"},"iptables"),"\u3002")),(0,l.kt)("p",null,"\u9019\u6a23\u7684\u597d\u8655\u5c31\u662f\u5c0d\u65bc ",(0,l.kt)("strong",{parentName:"p"},"Contaienr to Container")," \u7684\u5c01\u5305\u6d41\u5411\uff0c\u53ef\u4ee5\u4f7f\u7528 ",(0,l.kt)("strong",{parentName:"p"},"iptables")," \u4f86\u7ba1\u7406\uff0c\u4e0d\u7136\u5c31\u55ae\u7d14\u53ea\u80fd\u4f7f\u7528 ",(0,l.kt)("strong",{parentName:"p"},"ebtables")," \u4f86\u4f7f\u7528\u3002"),(0,l.kt)("h3",{id:"host-to-container-1"},"Host to Container"),(0,l.kt)("p",null,"\u57f7\u884c\u6307\u4ee4"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash="},"ping 172.18.0.2 -c 1\n")),(0,l.kt)("p",null,"\u76f8\u95dc\u7684 Log \u8acb\u53c3\u95b1\u5f71\u7247\u7d50\u679c\uff0c\u5e95\u4e0b\u5c31\u7d00\u9304\u6700\u5f8c\u7d50\u679c"),(0,l.kt)("p",null,"Host to Contaienr\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/OUf3KcS.png",alt:null})),(0,l.kt)("p",null,"Container to Host\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/PiMQ4uZ.png",alt:null})),(0,l.kt)("h3",{id:"container-to-wan"},"Container to WAN"),(0,l.kt)("p",null,"\u57f7\u884c\u6307\u4ee4"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash="},"sudo docker exec netutils ping 8.8.8.8 -c 1\n")),(0,l.kt)("p",null,"\u76f8\u95dc\u7684 Log \u8acb\u53c3\u95b1\u5f71\u7247\u7d50\u679c\uff0c\u5e95\u4e0b\u5c31\u7d00\u9304\u6700\u5f8c\u7d50\u679c"),(0,l.kt)("p",null,"Container to WAN\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/uLcRpGW.png",alt:null})),(0,l.kt)("p",null,"WAN to Container\n",(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/pWgDbjA.png",alt:null})),(0,l.kt)("h1",{id:"summary"},"Summary"),(0,l.kt)("p",null,"\u7d93\u904e\u9019\u6b21\u7684\u89c0\u5bdf\uff0c\u5927\u81f4\u4e0a\u7684\u7d50\u8ad6\u662f"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u7db2\u8def\u5f88\u96e3\uff0c\u9664\u932f\u5f88\u9ebb\u7169"),(0,l.kt)("li",{parentName:"ol"},"IPTABLES \u5f88\u96e3\uff0c\u9664\u932f\u5f88\u9ebb\u7169"),(0,l.kt)("li",{parentName:"ol"},"Linux Kernel \u5f88\u8907\u96dc\uff0c\u9664\u932f\u5f88\u9ebb\u7169")),(0,l.kt)("p",null,"\u5982\u679c\u9664\u932f\u9019\u9ebc\u96e3\uff0c\u90a3\u7db2\u8def\u51fa\u554f\u984c\u5230\u5e95\u8a72\u600e\u9ebc\u8fa6"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u7db2\u8def\u57fa\u672c\u6982\u5ff5\u7684\u7406\u89e3"),(0,l.kt)("li",{parentName:"ol"},"Linux \u7db2\u8def\u904b\u4f5c\u7684\u7406\u89e3"),(0,l.kt)("li",{parentName:"ol"},"TCPDUMP \u7b49\u76f8\u95dc\u5de5\u5177\u7684\u4f7f\u7528"),(0,l.kt)("li",{parentName:"ol"},"\u6aa2\u67e5 IPTABLES/EBTABLES/ARPTABLES \u7b49\u898f\u5247"),(0,l.kt)("li",{parentName:"ol"},"\u6aa2\u67e5 Routing Table/ARP Tables/Forwarding Tables \u7684\u7d00\u9304"),(0,l.kt)("li",{parentName:"ol"},"\u76f8\u95dc\u8cc7\u8a0a\u52a0\u4e0a\u7d93\u9a57\u6574\u5408\uff0c\u6700\u5f8c\u6b78\u7d0d\u51fa\u4e00\u5957\u5c01\u5305\u7684\u8d70\u5411\uff0c\u4e26\u4e14\u53bb\u9a57\u8b49")))}g.isMDXComponent=!0}}]);