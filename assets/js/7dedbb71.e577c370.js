"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[69560],{3905:(e,n,a)=>{a.d(n,{Zo:()=>g,kt:()=>p});var t=a(67294);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function i(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function o(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?i(Object(a),!0).forEach((function(n){r(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function l(e,n){if(null==e)return{};var a,t,r=function(e,n){if(null==e)return{};var a,t,r={},i=Object.keys(e);for(t=0;t<i.length;t++)a=i[t],n.indexOf(a)>=0||(r[a]=e[a]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)a=i[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var c=t.createContext({}),s=function(e){var n=t.useContext(c),a=n;return e&&(a="function"==typeof e?e(n):o(o({},n),e)),a},g=function(e){var n=s(e.components);return t.createElement(c.Provider,{value:n},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},u=t.forwardRef((function(e,n){var a=e.components,r=e.mdxType,i=e.originalType,c=e.parentName,g=l(e,["components","mdxType","originalType","parentName"]),m=s(a),u=r,p=m["".concat(c,".").concat(u)]||m[u]||d[u]||i;return a?t.createElement(p,o(o({ref:n},g),{},{components:a})):t.createElement(p,o({ref:n},g))}));function p(e,n){var a=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=u;var l={};for(var c in n)hasOwnProperty.call(n,c)&&(l[c]=n[c]);l.originalType=e,l[m]="string"==typeof e?e:r,o[1]=l;for(var s=2;s<i;s++)o[s]=a[s];return t.createElement.apply(null,o)}return t.createElement.apply(null,a)}u.displayName="MDXCreateElement"},48389:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>s});var t=a(87462),r=(a(67294),a(3905));const i={title:"\u8b93\u4f60\u7684 Container Image \u9003\u812b Kubelet Image GC \u7684\u9b54\u638c",keywords:["Kubernetes"],date:new Date("2023-10-07T23:57:25.000Z"),authors:"hwchiu",tags:["Kubernetes","Linux","DevOps"],description:"\u7c21\u8ff0\u4e00\u4e0b\u5982\u4f55\u8a2d\u5b9a Contaienr Image \u8b93\u5176\u53ef\u4ee5\u8df3\u904e Kubelet Image GC \u7684\u8655\u7406"},o=void 0,l={unversionedId:"2023/k8s-gc",id:"2023/k8s-gc",title:"\u8b93\u4f60\u7684 Container Image \u9003\u812b Kubelet Image GC \u7684\u9b54\u638c",description:"\u7c21\u8ff0\u4e00\u4e0b\u5982\u4f55\u8a2d\u5b9a Contaienr Image \u8b93\u5176\u53ef\u4ee5\u8df3\u904e Kubelet Image GC \u7684\u8655\u7406",source:"@site/docs/2023/k8s-gc.md",sourceDirName:"2023",slug:"/2023/k8s-gc",permalink:"/docs/2023/k8s-gc",draft:!1,tags:[{label:"Kubernetes",permalink:"/docs/tags/kubernetes"},{label:"Linux",permalink:"/docs/tags/linux"},{label:"DevOps",permalink:"/docs/tags/dev-ops"}],version:"current",frontMatter:{title:"\u8b93\u4f60\u7684 Container Image \u9003\u812b Kubelet Image GC \u7684\u9b54\u638c",keywords:["Kubernetes"],date:"2023-10-07T23:57:25.000Z",authors:"hwchiu",tags:["Kubernetes","Linux","DevOps"],description:"\u7c21\u8ff0\u4e00\u4e0b\u5982\u4f55\u8a2d\u5b9a Contaienr Image \u8b93\u5176\u53ef\u4ee5\u8df3\u904e Kubelet Image GC \u7684\u8655\u7406"},sidebar:"techPost",previous:{title:"\u89e3\u5bc6 Assigning Pod To Nodes(\u4e0a)",permalink:"/docs/2023/k8s-assigning-pod"},next:{title:"Kubernetes \u7db2\u8def\u9664\u932f\u4e4b\u65c5",permalink:"/docs/2023/k8s-network-debug"}},c={},s=[{value:"\u5be6\u4f5c",id:"\u5be6\u4f5c",level:2},{value:"\u74b0\u5883",id:"\u74b0\u5883",level:2},{value:"\u5be6\u9a57",id:"\u5be6\u9a57-1",level:2}],g={toc:s},m="wrapper";function d(e){let{components:n,...a}=e;return(0,r.kt)(m,(0,t.Z)({},g,a,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"\u672c\u7bc7\u6587\u7ae0\u7b46\u8a18\u4e00\u4e0b\u5982\u4f55\u8b93 container image \u53ef\u4ee5\u8df3\u904e Kubelet image GC \u7684\u968e\u6bb5\u800c\u88ab\u4fdd\u5b58\u5230\u7bc0\u9ede\u4e2d"),(0,r.kt)("h1",{id:"\u4f7f\u7528\u60c5\u5883"},"\u4f7f\u7528\u60c5\u5883"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},'\u6709\u4e9b\u90e8\u7f72\u74b0\u5883(airgap)\u7121\u6cd5\u900f\u904e\u7db2\u8def\u53bb\u6293\u53d6 Image\uff0c\u56e0\u6b64\u5fc5\u9808\u8981\u4e8b\u5148\u5c07 Container Image \u4e8b\u5148\u8f09\u5165\u5230\u7bc0\u9ede\u4e2d\uff0c\u4e26\u4e14\u900f\u904e "ImagePullPolicy:Never" \u7684\u65b9\u5f0f\u4f86\u90e8\u7f72\u5bb9\u5668\uff0c\u800c\u9019\u7a2e\u60c5\u6cc1\u4e0b\n\u5c31\u6703\u5e0c\u671b\u76f8\u95dc Image \u80fd\u5920\u4fdd\u5b58\u65bc\u7bc0\u9ede\u4e0a\u800c\u4e0d\u8981\u88ab Kubelet GC \u7d66\u56de\u6536\u6389'),(0,r.kt)("li",{parentName:"ol"},"\u6709\u4e9b\u958b\u767c\u8005\u4f7f\u7528 KIND \u4f86\u642d\u5efa\u6e2c\u8a66\u7528\u7684 Kubernetes \u7bc0\u9ede\uff0c\u90e8\u7f72\u7684 Container Image \u4e5f\u662f\u5f9e\u7bc0\u9ede\u8f09\u5165\u800c\u975e\u53ef\u4ee5\u7db2\u8def\u4e0a\u6293\u53d6\u7684\uff0c\u56e0\u6b64\u9577\u671f\u4f7f\u7528\u4e0a\u4e5f\u5e0c\u671b\u67d0\u4e9b image \u53ef\u4ee5\u4fdd\u7559\u800c\u4e0d\u8981\u88ab GC")),(0,r.kt)("h1",{id:"kubelet-gc"},"Kubelet GC"),(0,r.kt)("p",null,"\u6839\u64da Kubernetes \u7684\u5b98\u7db2\u6587\u7ae0 ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/architecture/garbage-collection/"},"Garbage Collection"),"\u6240\u8ff0\uff0c Kubernetes \u900f\u904e Kubelet \u5167\u7684 image manager \u4f86\u57f7\u884c Image GC\u3002\nImage GC \u7684\u57f7\u884c\u6703\u6839\u64da\u5169\u500b\u53c3\u6578 ",(0,r.kt)("inlineCode",{parentName:"p"},"HighThresholdPercent")," \u4ee5\u53ca ",(0,r.kt)("inlineCode",{parentName:"p"},"LowThresholdPercent")," \u4f86\u63a7\u7ba1 Image GC \u7684\u57f7\u884c\u908f\u8f2f\uff0c\u7576\u7cfb\u7d71\u786c\u789f\u7528\u91cf\u8d85\u904e ",(0,r.kt)("inlineCode",{parentName:"p"},"HighThresholdPercent")," \u6642\u5c31\u6703\u89f8\u767c GC\uff0c\u4e26\u4e14\u6839\u64da Image \u4e0a\u6b21\u4f7f\u7528\u6642\u9593\u70ba\u57fa\u790e\u53bb\u9010\u6f38\u522a\u9664 Image \u76f4\u5230\u7cfb\u7d71\u7528\u91cf\u4f4e\u65bc ",(0,r.kt)("inlineCode",{parentName:"p"},"LowThresholdPercent"),"\u3002"),(0,r.kt)("p",null,"\u4e0a\u8ff0\u5169\u500b\u53c3\u6578\u7684\u9810\u8a2d\u503c\u5206\u5225\u70ba 85/80\uff0c\u5982\u4e0b\u5217",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubelet/config/v1beta1/types.go#L293C1-L307"},"\u7a0b\u5f0f\u78bc")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'// imageGCHighThresholdPercent is the percent of disk usage after which\n// image garbage collection is always run. The percent is calculated by\n// dividing this field value by 100, so this field must be between 0 and\n// 100, inclusive. When specified, the value must be greater than\n// imageGCLowThresholdPercent.\n// Default: 85\n// +optional\nImageGCHighThresholdPercent *int32 `json:"imageGCHighThresholdPercent,omitempty"`\n// imageGCLowThresholdPercent is the percent of disk usage before which\n// image garbage collection is never run. Lowest disk usage to garbage\n// collect to. The percent is calculated by dividing this field value by 100,\n// so the field value must be between 0 and 100, inclusive. When specified, the\n// value must be less than imageGCHighThresholdPercent.\n// Default: 80\n// +optional\nImageGCLowThresholdPercent *int32 `json:"imageGCLowThresholdPercent,omitempty"`\n')),(0,r.kt)("p",null,"\u7136\u800c\u5be6\u969b\u4e0a\u8a72\u6587\u4ef6\u5167\u5bb9\u4e26\u6c92\u6709\u89e3\u91cb\u5230\u8a73\u7d30\u6d41\u7a0b\uff0c\u7a0b\u5f0f\u78bc\u5167\u9084\u6709\u4e00\u4e9b\u96b1\u85cf\u7684\u5be6\u4f5c\u7d30\u7bc0\uff0c\u56e0\u6b64\u63a5\u4e0b\u4f86\u5c31\u4f86\u900f\u904e\u95b1\u8b80",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/images/image_gc_manager.go#L341-L367"},"\u7a0b\u5f0f\u78bc")," \u5b78\u7fd2\u6574\u9ad4\u6d41\u7a0b"),(0,r.kt)("h2",{id:"\u5be6\u4f5c"},"\u5be6\u4f5c"),(0,r.kt)("p",null,"\u5982",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/architecture/garbage-collection/"},"\u6587\u4ef6"),"\u6240\u8ff0\uff0c Kubelet \u5167\u7684 ImageManager \u6703\u8ca0\u8cac\u8655\u7406\u76f8\u95dc GC \u6d41\u7a0b\uff0c\u56e0\u6b64\u5f9e Kubelet \u5167\u7684",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/kubernetes/blob/v1.28.0/pkg/kubelet/kubelet.go#L1423-L1441"},"\u7a0b\u5f0f\u78bc"),"\u53ef\u4ee5\u770b\u5230\u5176\u6bcf\u4e94\u5206\u9418\u6703\u547c\u53eb\u4e00\u6b21 ImageManager \u5167\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"GarbageCollect")," \u4f86\u8655\u7406\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'const (\n...\n    // ImageGCPeriod is the period for performing image garbage collection.\n    ImageGCPeriod = 5 * time.Minute\n...\n)\n...\ngo wait.Until(func() {\n    ctx := context.Background()\n    if err := kl.imageManager.GarbageCollect(ctx); err != nil {\n        if prevImageGCFailed {\n            klog.ErrorS(err, "Image garbage collection failed multiple times in a row")\n            // Only create an event for repeated failures\n            kl.recorder.Eventf(kl.nodeRef, v1.EventTypeWarning, events.ImageGCFailed, err.Error())\n        } else {\n            klog.ErrorS(err, "Image garbage collection failed once. Stats initialization may not have completed yet")\n        }\n        prevImageGCFailed = true\n    } else {\n        var vLevel klog.Level = 4\n        if prevImageGCFailed {\n            vLevel = 1\n            prevImageGCFailed = false\n        }\n\n        klog.V(vLevel).InfoS("Image garbage collection succeeded")\n    }\n}, ImageGCPeriod, wait.NeverStop)\n...\n')),(0,r.kt)("p",null,"\u800c GarbaeCollect \u5167\u7684",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/images/image_gc_manager.go#L310-L324"},"\u7a0b\u5f0f\u78bc"),"\u6700\u5f8c\u5247\u6709\u4e00\u500b ",(0,r.kt)("inlineCode",{parentName:"p"},"HighThresholdPercent")," \u7684\u5224\u65b7\u3002\n\u7576\u524d\u4f7f\u7528\u91cf\u8d85\u904e\u8a72\u6a19\u6e96\u6642\uff0c\u5c31\u6703\u8a08\u7b97\u9700\u8981\u79fb\u9664\u591a\u5c11\u7a7a\u9593\u4f86\u4f4e\u65bc ",(0,r.kt)("inlineCode",{parentName:"p"},"LowThreholdPercent")," \u4e26\u4e14\u547c\u53eb\u5167\u90e8\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"freeSpace")," \u53bb\u79fb\u9664\u7a7a\u9593"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'...\nusagePercent := 100 - int(available*100/capacity)\nif usagePercent >= im.policy.HighThresholdPercent {\n    amountToFree := capacity*int64(100-im.policy.LowThresholdPercent)/100 - available\n    klog.InfoS("Disk usage on image filesystem is over the high threshold, trying to free bytes down to the low threshold", "usage", usagePercent, "highThreshold", im.policy.HighThresholdPercent, "amountToFree", amountToFree, "lowThreshold", im.policy.LowThresholdPercent)\n    freed, err := im.freeSpace(ctx, amountToFree, time.Now())\n    if err != nil {\n        return err\n    }\n\n    if freed < amountToFree {\n        err := fmt.Errorf("Failed to garbage collect required amount of images. Attempted to free %d bytes, but only found %d bytes eligible to free.", amountToFree, freed)\n        im.recorder.Eventf(im.nodeRef, v1.EventTypeWarning, events.FreeDiskSpaceFailed, err.Error())\n        return err\n    }\n}\n...\n')),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/images/image_gc_manager.go#L341C1-L368C1"},"fresSpace")," \u9996\u5148\u6703\u5148\u547c\u53eb ",(0,r.kt)("inlineCode",{parentName:"p"},"detectImages")," \u5f9e\u7cfb\u7d71\u6293\u53d6\u7576\u524d\u904b\u884c\u7684 Images \u8cc7\u8a0a\uff0c\u63a5\u8005\u904b\u884c\u4e00\u500b\u8ff4\u5708\u5f9e\u4e2d\u904e\u6ffe\u6389\u4e0d\u9700\u8981\u7684 Image\uff0c\u6700\u5f8c\u518d\u6839\u64da Image \u7684\u6700\u5f8c\u88ab\u4f7f\u7528\u4f86\u9032\u884c\u6392\u5e8f\uff0c\u6392\u5e8f\u5f8c\u5247\u6703\u6709\u4e00\u500b\u984d\u5916\u7684\u8ff4\u5708\u53bb\u79fb\u9664 Image \u76f4\u5230\u7a7a\u9593\u8db3\u5920\u70ba\u6b62\u3002"),(0,r.kt)("p",null,"\u9019\u908a\u7684\u904e\u6ffe\u689d\u4ef6\u4e5f\u88dc\u5145\u4e86\u6587\u4ef6\u4e2d\u6c92\u6709\u8aaa\u660e\u7684\u7d30\u7bc0\uff0c\u8aaa\u660e\u4e86\u54ea\u4e9b Image \u6703\u88ab GC \u7d66\u5ffd\u7565"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Image \u6b63\u5728\u88ab\u4f7f\u7528"),(0,r.kt)("li",{parentName:"ol"},"Image \u672c\u8eab\u6709 pinned \u7684\u5c6c\u6027")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'func (im *realImageGCManager) freeSpace(ctx context.Context, bytesToFree int64, freeTime time.Time) (int64, error) {\n    imagesInUse, err := im.detectImages(ctx, freeTime)\n    if err != nil {\n        return 0, err\n    }\n\n\n    // Get all images in eviction order.\n    images := make([]evictionInfo, 0, len(im.imageRecords))\n    for image, record := range im.imageRecords {\n        if isImageUsed(image, imagesInUse) {\n            klog.V(5).InfoS("Image ID is being used", "imageID", image)\n            continue\n        }\n        // Check if image is pinned, prevent garbage collection\n        if record.pinned {\n            klog.V(5).InfoS("Image is pinned, skipping garbage collection", "imageID", image)\n            continue\n\n        }\n        images = append(images, evictionInfo{\n            id:          image,\n            imageRecord: *record,\n        })\n    }\n    sort.Sort(byLastUsedAndDetected(images))\n...\n')),(0,r.kt)("p",null,"\u89c0\u5bdf\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"pinned")," \u7684\u76f8\u95dc\u6982\u5ff5\u5f8c\uff0c\u7ffb\u4e86",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2040-kubelet-cri#pinned-images"},"sig-node/2040-kubelet-cri")," \u5167\u7684\u6587\u4ef6\u4e5f\u53ef\u4ee5\u770b\u5230\u9019\u6bb5\u8aaa\u660e"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Introduce field in the Image message to indicate an image should not be garbage collected:")),(0,r.kt)("p",null,"\u76f8\u95dc\u7a0b\u5f0f\u78bc\u4e5f\u65bc 2021 \u5de6\u53f3\u65bc\u9019\u96bb ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/kubernetes/pull/103299"},"PR")," \u5167\u5be6\u4f5c\u3002"),(0,r.kt)("p",null,"\u6b64\u5916\u4e5f\u53ef\u4ee5\u5f9e Containerd \u7684\u76f8\u95dc ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containerd/containerd/pull/7944"},"Issue")," \u770b\u5230\u76f8\u95dc\u5be6\u4f5c\uff0c\u800c\u8a72\u529f\u80fd\u6700\u5f8c\u65bc Containerd 1.7 \u5f8c\u91cb\u51fa\uff0c\u4f7f\u7528\u8005\u53ef\u4ee5\u900f\u904e\u4e0b\u5217\u5169\u7a2e\u6307\u4ee4\u53bb pin image\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"sudo ctr -n k8s.io images label docker.io/library/jenkins:2.60.1 io.cri-containerd.pinned=pinned\nsudo ctr -n k8s.io images pull --label=io.cri-containerd.pinned=pinned docker.io/library/jenkins:2.60.1\n")),(0,r.kt)("h1",{id:"\u5be6\u9a57"},"\u5be6\u9a57"),(0,r.kt)("p",null,"\u6709\u4e86\u4e0a\u8ff0\u6982\u5ff5\u5f8c\uff0c\u63a5\u4e0b\u4f86\u5c31\u8981\u6e96\u5099\u4e00\u500b Kubernetes \u74b0\u5883\u4f86\u9a57\u8b49\u4e0a\u8ff0\u6982\u5ff5"),(0,r.kt)("h2",{id:"\u74b0\u5883"},"\u74b0\u5883"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ kubectl version\nClient Version: v1.28.2\nKustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3\nServer Version: v1.28.2\n$ ctr --version\nctr github.com/containerd/containerd v1.7.6\n$ lsb_release -a\nNo LSB modules are available.\nDistributor ID: Ubuntu\nDescription:    Ubuntu 23.04\nRelease:        23.04\nCodename:       lunar\n")),(0,r.kt)("h2",{id:"\u5be6\u9a57-1"},"\u5be6\u9a57"),(0,r.kt)("p",null,'\u9996\u5148\u900f\u904e ctr \u6307\u4ee4\u8207 containerd \u4e92\u52d5\u4e26\u4e14\u89c0\u5bdf\u76f8\u95dc image \u72c0\u6cc1\uff0c\u5176\u4e2d Kubernetes \u9810\u8a2d\u6703\u4f7f\u7528 "k8s.io" namespace\uff0c\u56e0\u6b64\u4f7f\u7528\u4e0a\u90fd\u8981\u52a0\u4e0a "-n k8s.io"'),(0,r.kt)("p",null,"\u900f\u904e ",(0,r.kt)("inlineCode",{parentName:"p"},"imags ls"),' \u53bb\u6aa2\u8996\u6240\u6709 image \u7684\u72c0\u6cc1\uff0c\u53ef\u4ee5\u767c\u73fe pause \u7cfb\u5217\u7684 image \u9810\u8a2d\u5c31\u6703\u6709 "io.cri-containerd.pinned=pinned" \u9019\u500b\u9078\u9805\uff0c\u800c\u5176\u4ed6 image \u90fd\u6c92\u6709\u3002'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"$ sudo ctr -n k8s.io image ls\n...\nregistry.k8s.io/pause:3.6                                                                                      application/vnd.docker.distribution.manifest.list.v2+json sha256:3d380ca8864549e74af4b29c10f9cb0956236dfb01c40ca076fb6c37253234db 294.7 KiB linux/amd64,linux/arm/v7,linux/arm64,linux/ppc64le,linux/s390x,windows/amd64 io.cri-containerd.image=managed,io.cri-containerd.pinned=pinned\nregistry.k8s.io/pause@sha256:3d380ca8864549e74af4b29c10f9cb0956236dfb01c40ca076fb6c37253234db                  application/vnd.docker.distribution.manifest.list.v2+json sha256:3d380ca8864549e74af4b29c10f9cb0956236dfb01c40ca076fb6c37253234db 294.7 KiB linux/amd64,linux/arm/v7,linux/arm64,linux/ppc64le,linux/s390x,windows/amd64 io.cri-containerd.image=managed,io.cri-containerd.pinned=pinned\ndocker.io/calico/cni:v3.26.1                                                                                   application/vnd.docker.distribution.manifest.list.v2+json sha256:3be3c67ddba17004c292eafec98cc49368ac273b40b27c8a6621be4471d348d6 89.0 MiB  linux/amd64,linux/arm/v7,linux/arm64,linux/ppc64le,linux/s390x               io.cri-containerd.image=managed\ndocker.io/calico/cni@sha256:3be3c67ddba17004c292eafec98cc49368ac273b40b27c8a6621be4471d348d6                   application/vnd.docker.distribution.manifest.list.v2+json sha256:3be3c67ddba17004c292eafec98cc49368ac273b40b27c8a6621be4471d348d6 89.0 MiB  linux/amd64,linux/arm/v7,linux/arm64,linux/ppc64le,linux/s390x               io.cri-containerd.image=managed\n...\n")),(0,r.kt)("p",null,"\u63a5\u4e0b\u4f86\u53ef\u4ee5\u5617\u8a66\u900f\u904e ",(0,r.kt)("inlineCode",{parentName:"p"},"ctr")," \u53bb Pin"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"ctr -n k8s.io images label xxxxxxxx io.cri-containerd.pinned=pinned\n")),(0,r.kt)("p",null,"\u7531\u65bc\u7cfb\u7d71\u7684\u786c\u789f\u7a7a\u9593\u53ea\u6709 30G\uff0c\u56e0\u6b64\u6211\u4f7f\u7528\u4e0b\u5217\u7684\u8173\u672c\u4e0b\u8f09\u4e0d\u540c\u7684 Image \u4e26\u5617\u8a66\u4f7f\u5f97\u786c\u789f\u4f7f\u7528\u91cf\u8d85\u51fa HighThresholdPercent (85%) \u4e26\u4e14\u89f8\u767c\u76f8\u95dc\u8cc7\u8a0a\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash="},"kubectl run a --image=docker.io/library/node:bullseye                                                                                                                       [1851/4810]\nkubectl run a1 --image=docker.io/library/node:current-bookworm\nkubectl run a2 --image=docker.io/library/node:bookworm\nkubectl run a3 --image=docker.io/library/node:current\nkubectl run a4 --image=docker.io/library/node:20.8.0-bullseye\nkubectl run a5 --image=docker.io/library/openjdk:22-oraclekubectl run a6 --image=docker.io/library/jenkins:2.60.1\nkubectl run a7 --image=docker.io/library/jenkins:2.60.2\nkubectl run a8 --image=docker.io/library/jenkins:2.60.3\nkubectl run a9 --image=docker.io/library/jenkins:2.46.2\nkubectl run a10 --image=docker.io/library/jenkins:2.46.1\nkubectl run a11 --image=docker.io/pytorch/pytorch:latest\nkubectl run a12 --image=docker.io/pytorch/pytorch:2.0.1-cuda11.7-cudnn8-devel\n")),(0,r.kt)("p",null,"\u6b64\u5916\u6211\u74b0\u5883\u90e8\u7f72\u4e2d\uff0c\u6709\u7279\u5225\u958b\u555f kubelet \u7684\u8a2d\u5b9a\u6a94\u6848\uff0c\u6253\u958b\u5176 log \u7b49\u7d1a\u4f86\u89c0\u770b\u66f4\u591a\u904b\u4f5c log\u3002"),(0,r.kt)("p",null,"\u63a5\u4e0b\u4f86\u900f\u904e\u4e0b\u5217\u6307\u4ee4\u89c0\u5bdf kubelet \u6307\u4ee4\u4e26\u4e14\u89c0\u5bdf\u7576\u786c\u789f\u7a7a\u9593\u8d85\u904e\u5f8c\u7684\u76f8\u95dc log"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ sudo journalctl -f -u kubelet | grep image_gc\n")),(0,r.kt)("p",null,"\u4ee5\u4e0b\u662f\u7576\u7cfb\u7d71\u7a7a\u9593\u8d85\u904e ",(0,r.kt)("inlineCode",{parentName:"p"},"HighThresholdPercent")," \u5f8c\u7684\u76f8\u95dc Log (\u79fb\u9664\u7528\u4e0d\u5230\u7684\u8cc7\u8a0a\u65b9\u4fbf\u95b1\u8b80)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'image_gc_manager.go:340] "Attempting to delete unused images"\n...\nimage_gc_manager.go:255] "Adding image ID to currentImages" imageID="sha256:112170efb091e6c02eac19703986e3c59ce11e86\nb826c1d70a4a4a73a333339b"\nimage_gc_manager.go:272] "Image ID has size" imageID="sha256:112170efb091e6c02eac19703986e3c59ce11e86b826c1d70a4a4a7\n3a333339b" size=366064122\nimage_gc_manager.go:275] "Image ID is pinned" imageID="sha256:112170efb091e6c02eac19703986e3c59ce11e86b826c1d70a4a4a\n73a333339b" pinned=true\n...\nimage_gc_manager.go:364] "Image ID is being used" imageID="sha256:c62308471249574d567c4fff9a927451ac999f50fe9190ceb50e9949922762ef"\nimage_gc_manager.go:364] "Image ID is being used" imageID="sha256:677ad13d73108d775aec52e9bd38c33042ad14bb3a780b67613b8eb7be5de5b2"\nimage_gc_manager.go:369] "Image is pinned, skipping garbage collection" imageID="sha256:6270bb605e12e581514ada5fd5b3216f727db55dc87d5889c790e4c760683fee"\nimage_gc_manager.go:364] "Image ID is being used" imageID="sha256:8065b798a4d6729605e3706c202db657bfbcb8109127ece6af5bfb6da106adb7"\n')),(0,r.kt)("p",null,'\u5f9e\u4e0a\u8ff0\u7684 log \u770b\u8d77\u4f86\u4f3c\u4e4e\u904b\u4f5c\u6b63\u5e38\uff0c\u4f46\u662f\u4ed4\u7d30\u89c0\u5bdf\u5f8c\u767c\u73fe\u6240\u6709\u624b\u52d5\u52a0\u5165 pinned \u7684 image \u90fd\u6c92\u6709\u9806\u5229\u5730\u88ab\u5075\u6e2c\u5230\u6709 "pinned=true"\uff0c\u53ea\u6709\u9810\u8a2d\u7684 puase image \u6709\u88ab\u5075\u6e2c\u5230\u3002'),(0,r.kt)("p",null,"\u900f\u904e ",(0,r.kt)("inlineCode",{parentName:"p"},"crictl")," \u6307\u4ee4\u89c0\u5bdf\uff0c\u6703\u767c\u73fe\u5c0d\u65bc Kubernetes \u4f86\u8aaa\uff0c\u4e26\u4e0d\u8a8d\u70ba\u8a72 Image \u6709\u88ab\u6a19\u793a\u70ba pinned"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ sudo crictl inspecti docker.io/library/jenkins:2.60.2\n{\n  "status": {\n    "id": "sha256:112170efb091e6c02eac19703986e3c59ce11e86b826c1d70a4a4a73a333339b",\n    "repoTags": [\n      "docker.io/library/jenkins:2.60.2"\n    ],\n    "repoDigests": [\n      "docker.io/library/jenkins@sha256:5d628badc50487581da2b4cb95a7589fe1d39922391e128f6a031273ad351b71"\n    ],\n    "size": "366064122",\n    "uid": null,\n    "username": "jenkins",\n    "spec": null,\n    "pinned": false\n  },\n')),(0,r.kt)("p",null,"\u7d93\u904e\u53cd\u8986\u5be6\u9a57\u5f8c\u89c0\u5bdf\u5230\u82e5\u63a1\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"ctr image label")," \u52a0\u4e0a\u7684 label \u4f3c\u4e4e\u4e0d\u6703\u88ab\u8a8d\u53ef\u70ba pinned\uff0c\u53ea\u6709\u900f\u904e ",(0,r.kt)("inlineCode",{parentName:"p"},"ctr image pull")," \u7684\u624d\u6709\u8fa6\u6cd5\u88ab\u6b63\u5f0f\u88ab\u8fa8\u8b58\u3002"),(0,r.kt)("p",null,"\u53e6\u5916 kubelet \u6c92\u6709\u8fa6\u6cd5\u8fa8\u8b58\u7684\u554f\u984c\u5be6\u969b\u4e0a\u662f\u4e00\u500b\u5be6\u4f5c\u7684 bug\uff0c\u8a72 bug \u5df2\u7d93\u65bc",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/kubernetes/pull/119986"},"PR Pass Pinned field to kubecontainer.Image\n")," \u7d66\u4fee\u5fa9\uff0c\u8a72\u4fee\u5fa9\u9810\u8a08\u65bc v1.29 \u4e00\u8d77\u91cb\u51fa\u3002"),(0,r.kt)("p",null,"\u56e0\u6b64\u5617\u8a66\u4e0b\u8f09 v1.29.0-alpha.1 \u7248\u672c\u7684 ",(0,r.kt)("a",{parentName:"p",href:"https://dl.k8s.io/v1.29.0-alpha.1/kubernetes-node-linux-amd64.tar.gz"},"kubelet"),"\u4e26\u4e14\u9032\u884c\u66ff\u63db\u4f86\u9a57\u8b49\uff0c\u6700\u5f8c\u6574\u500b\u529f\u80fd\u904b\u4f5c\u5982\u9810\u671f\uff0c\u80fd\u5920\u9806\u5229\u7684\u8df3\u904e pinned image\u3002"),(0,r.kt)("h1",{id:"summary"},"Summary"),(0,r.kt)("p",null,"\u6700\u5f8c\u4ee5\u4e00\u5f35\u5716\u4f86\u6982\u62ec\u4e0a\u8ff0\u7684\u6d41\u7a0b\n",(0,r.kt)("img",{parentName:"p",src:"https://hackmd.io/_uploads/ByrD0ekba.png",alt:null})))}d.isMDXComponent=!0}}]);