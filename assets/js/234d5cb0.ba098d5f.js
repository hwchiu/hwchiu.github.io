"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[11880],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var u=r.createContext({}),i=function(e){var t=r.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=i(e.components);return r.createElement(u.Provider,{value:t},e.children)},p="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},k=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,u=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),p=i(n),k=a,m=p["".concat(u,".").concat(k)]||p[k]||c[k]||o;return n?r.createElement(m,s(s({ref:t},d),{},{components:n})):r.createElement(m,s({ref:t},d))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,s=new Array(o);s[0]=k;var l={};for(var u in t)hasOwnProperty.call(t,u)&&(l[u]=t[u]);l.originalType=e,l[p]="string"==typeof e?e:a,s[1]=l;for(var i=2;i<o;i++)s[i]=n[i];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}k.displayName="MDXCreateElement"},77250:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>c,frontMatter:()=>o,metadata:()=>l,toc:()=>i});var r=n(87462),a=(n(67294),n(3905));const o={title:"[Kubernetes] Static Pod \u4ecb\u7d39",date:new Date("2020-03-10T07:05:00.000Z"),tags:["Kubernetes","Container","Linux"],description:"\u672c\u6587\u4e3b\u8981\u8ddf\u5927\u5bb6\u5206\u4eab\u5982\u4f55\u900f\u904e Static Pod \u7684\u65b9\u5f0f\u4f86\u6eff\u8db3\u7528 Kubernetes \u7ba1\u7406 API-Server/Controller/Scheduler \u9019\u4e9b Kubernetes \u7684\u57fa\u790e\u5143\u4ef6\uff0c\u5176\u4e2d Static Pod \u66f4\u662f Kubeadm \u7684\u67b6\u8a2d\u539f\u7406\uff0c\u900f\u904e\u9019\u500b\u65b9\u5f0f\u6211\u5011\u4e5f\u53ef\u4ee5\u66f4\u52a0\u4e86\u89e3 Kubeadm \u7684\u5b89\u88dd\u65b9\u5f0f"},s="Preface",l={unversionedId:"techPost/2020/kubernetes-static-pod",id:"techPost/2020/kubernetes-static-pod",title:"[Kubernetes] Static Pod \u4ecb\u7d39",description:"\u672c\u6587\u4e3b\u8981\u8ddf\u5927\u5bb6\u5206\u4eab\u5982\u4f55\u900f\u904e Static Pod \u7684\u65b9\u5f0f\u4f86\u6eff\u8db3\u7528 Kubernetes \u7ba1\u7406 API-Server/Controller/Scheduler \u9019\u4e9b Kubernetes \u7684\u57fa\u790e\u5143\u4ef6\uff0c\u5176\u4e2d Static Pod \u66f4\u662f Kubeadm \u7684\u67b6\u8a2d\u539f\u7406\uff0c\u900f\u904e\u9019\u500b\u65b9\u5f0f\u6211\u5011\u4e5f\u53ef\u4ee5\u66f4\u52a0\u4e86\u89e3 Kubeadm \u7684\u5b89\u88dd\u65b9\u5f0f",source:"@site/docs/techPost/2020/kubernetes-static-pod.md",sourceDirName:"techPost/2020",slug:"/techPost/2020/kubernetes-static-pod",permalink:"/docs/techPost/2020/kubernetes-static-pod",draft:!1,tags:[{label:"Kubernetes",permalink:"/docs/tags/kubernetes"},{label:"Container",permalink:"/docs/tags/container"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",frontMatter:{title:"[Kubernetes] Static Pod \u4ecb\u7d39",date:"2020-03-10T07:05:00.000Z",tags:["Kubernetes","Container","Linux"],description:"\u672c\u6587\u4e3b\u8981\u8ddf\u5927\u5bb6\u5206\u4eab\u5982\u4f55\u900f\u904e Static Pod \u7684\u65b9\u5f0f\u4f86\u6eff\u8db3\u7528 Kubernetes \u7ba1\u7406 API-Server/Controller/Scheduler \u9019\u4e9b Kubernetes \u7684\u57fa\u790e\u5143\u4ef6\uff0c\u5176\u4e2d Static Pod \u66f4\u662f Kubeadm \u7684\u67b6\u8a2d\u539f\u7406\uff0c\u900f\u904e\u9019\u500b\u65b9\u5f0f\u6211\u5011\u4e5f\u53ef\u4ee5\u66f4\u52a0\u4e86\u89e3 Kubeadm \u7684\u5b89\u88dd\u65b9\u5f0f"},sidebar:"techPost",previous:{title:"Kubernetes - IP \u91cd\u8907\u5947\u9047\u8a18",permalink:"/docs/techPost/2020/kubernetes-duplicate-pod-ip"},next:{title:"2019",permalink:"/docs/category/2019"}},u={},i=[],d={toc:i},p="wrapper";function c(e){let{components:t,...n}=e;return(0,a.kt)(p,(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"preface"},"Preface"),(0,a.kt)("p",null,"\u672c\u6587\u60f3\u8981\u8ddf\u5927\u5bb6\u4f86\u5206\u4eab\u8a0e\u8ad6\u4e00\u4e0b\u53e6\u5916\u4e00\u7a2e\u90e8\u7f72 Kubernetes Pod \u7684\u65b9\u5f0f\uff0c\u7a31\u4e4b\u70ba Static Pod\uff0c\u9019\u500b\u90e8\u7f72\u65b9\u5f0f\u6700\u5927\u7684\u793a\u7bc4\u60c5\u5883\u5c31\u662f Kubeadm \u7684\u4f7f\u7528\u3002"),(0,a.kt)("p",null,"\u7576\u90e8\u7f72\u5b8c Kubeadm \u5f8c\uff0c\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl -n kube-system get pods"),"\uff0c\u662f\u4e0d\u662f\u6703\u770b\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"kube-scheduler"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"kube-apiserver")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"kube-controller-manager"),"."),(0,a.kt)("p",null,"\u90a3..\u9019\u4e9b\u6838\u5fc3\u5143\u4ef6\u7d44\u6210\u4e86 Kubernetes Control-Plane\uff0c\u4f46\u662f\u672c\u8eab\u537b\u53c8\u662f\u88ab Kubernetes \u6240\u7ba1\u7406\uff0c\u90a3\u5230\u5e95\u662f\u9019\u4e2d\u9593\u662f\u600e\u9ebc\u904b\u4f5c\u7684?"),(0,a.kt)("p",null,"\u9019\u500b\u554f\u984c\u5c31\u8981\u5f9e Static Pod \u7684\u90e8\u7f72\u4f86\u8ac7\u8d77"),(0,a.kt)("h1",{id:"environment"},"Environment"),(0,a.kt)("p",null,"\u672c\u6587\u89c0\u5bdf\u74b0\u5883\u57fa\u65bc\u4e0b\u5217\u7248\u672c"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"kubeadm: v1.17.3"),(0,a.kt)("li",{parentName:"ol"},"kubectl: v1.17.3"),(0,a.kt)("li",{parentName:"ol"},"Kubernetes: v1.17.3")),(0,a.kt)("p",null,"\u5982\u679c\u6709\u4f7f\u7528 Vagrant \u7684\u4eba\uff0c\u53ef\u4ee5\u7528\u4e0b\u5217\u7684\u6a94\u6848\u5efa\u7f6e\u76f8\u95dc\u74b0\u5883"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ruby="},'# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nVagrant.configure("2") do |config|\n  config.vm.box = "bento/ubuntu-18.04"\n  config.vm.box_version =\'201912.14.0\'\n  config.vm.hostname = \'k8s-dev\'\n  config.vm.define vm_name = \'k8s\'\n\n  config.vm.provision "shell", privileged: false, inline: <<-SHELL\n    set -e -x -u\n    export DEBIAN_FRONTEND=noninteractive\n    #change the source.list\n    sudo apt-get update\n    sudo apt-get install -y vim git cmake build-essential tcpdump tig jq socat bash-completion\n    # Install Docker\n    export DOCKER_VERSION="5:19.03.5~3-0~ubuntu-bionic"\n    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\n    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"\n    sudo apt-get update\n    sudo apt-get install -y docker-ce=${DOCKER_VERSION}\n    sudo usermod -aG docker $USER\n    #Disable swap\n    #https://github.com/kubernetes/kubernetes/issues/53533\n    sudo swapoff -a && sudo sysctl -w vm.swappiness=0\n    sudo sed \'/vagrant--vg-swap/d\' -i /etc/fstab\n\n    sudo apt-get update && sudo apt-get install -y apt-transport-https curl\n    curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -\n    echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee --append /etc/apt/sources.list.d/kubernetes.list\n    sudo apt-get update\n    sudo apt-get install -y kubelet kubeadm kubectl\n    sudo kubeadm init --pod-network-cidr=10.244.0.0/16\n    mkdir -p $HOME/.kube\n    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n    sudo chown $(id -u):$(id -g) $HOME/.kube/config\n    kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml\n    echo \'source <(kubectl completion bash)\' >>~/.bashrc\n  SHELL\n\n  config.vm.network :private_network, ip: "172.17.8.111"\n  config.vm.provider :virtualbox do |v|\n      v.customize ["modifyvm", :id, "--cpus", 2]\n      v.customize ["modifyvm", :id, "--memory", 4096]\n      v.customize [\'modifyvm\', :id, \'--nicpromisc1\', \'allow-all\']\n  end\nend\n\n')),(0,a.kt)("h1",{id:"how-kubeadm-works"},"How Kubeadm Works"),(0,a.kt)("p",null,"\u70ba\u4e86\u90e8\u7f72\u4e00\u500b Pod \u5230 Kubernetes \u7bc0\u9ede\u4e0a\uff0c\u5176\u4e2d\u727d\u626f\u4e86\u591a\u500b\u5143\u4ef6\uff0c\u5f9e API Server, Scheduler, Controller \u5230\u7bc0\u9ede\u4e0a\u7684 kubelet, Container Runtime\u3002"),(0,a.kt)("p",null,"\u7136\u800c\u5c0d\u65bc Scheduler/Controller/API Server \u9019\u4e09\u500b\u6838\u5fc3\u5143\u4ef6\u8aaa\uff0c\u5230\u5e95\u8a72\u600e\u9ebc\u5efa\u5236\u4ee5\u53ca\u7dad\u8b77\uff1f"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Native Application, \u76f4\u63a5\u904b\u884c\u4e09\u500b\u4e0d\u540c\u7684 Binary \u57f7\u884c\u6a94\u6848",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u53ef\u900f\u904e systemd \u4f86\u5305\u88dd\u9019\u4e9b\u61c9\u7528\u7a0b\u5f0f"))),(0,a.kt)("li",{parentName:"ol"},"\u900f\u904e\u5df2\u7d93\u5305\u88dd\u597d\u7684 Container Image \u4f86\u57f7\u884c\u9019\u4e09\u500b\u670d\u52d9")),(0,a.kt)("p",null,"\u4ee5 ",(0,a.kt)("inlineCode",{parentName:"p"},"Kubeadm")," \u70ba\u7bc4\u4f8b\uff0c\u5176\u5148\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"systemd")," \u7684\u65b9\u5f0f\u4f86\u7ba1\u7406 ",(0,a.kt)("inlineCode",{parentName:"p"},"kubelet"),"\uff0c\u78ba\u4fdd ",(0,a.kt)("inlineCode",{parentName:"p"},"kubelet")," \u9019\u500b daemon \u672c\u8eab\u53ef\u4ee5\u88ab\u76e3\u63a7\uff0c\u5982\u679c\u6709\u554f\u984c\u6703\u81ea\u52d5\u91cd\u65b0\u8d77\u52d5\uff0c\u751a\u81f3\u91cd\u65b0\u958b\u6a5f\u5f8c\u90fd\u53ef\u4ee5\u6eff\u8db3\u53eb\u8d77\u4f86\u63d0\u4f9b\u670d\u52d9\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ systemctl status kubelet\n\u25cf kubelet.service - kubelet: The Kubernetes Node Agent\n   Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)\n  Drop-In: /etc/systemd/system/kubelet.service.d\n           \u2514\u250010-kubeadm.conf\n   Active: active (running) since Tue 2020-03-10 04:42:30 UTC; 1h 20min ago\n     Docs: https://kubernetes.io/docs/home/\n Main PID: 646 (kubelet)\n    Tasks: 21 (limit: 4659)\n   CGroup: /system.slice/kubelet.service\n           \u2514\u2500646 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kub\n")),(0,a.kt)("p",null,"\u81f3\u65bc\u4e0a\u8ff0\u4e09\u500b\u5143\u4ef6\u672c\u8eab\u90fd\u6709\u76f8\u95dc\u7684\u5bb9\u5668\u6620\u50cf\u6a94\uff0c\u5176\u5be6\u6700\u7c21\u55ae\u7684\u65b9\u5f0f\u5c31\u662f\u65bc\u7bc0\u9ede\u4e0a\u76f4\u63a5\u900f\u904e Container Runtime \u53bb\u904b\u884c\u9019\u4e09\u500b\u7bc0\u9ede\u5373\u53ef\u3002"),(0,a.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\u5b89\u88dd\u5b8c\u7562 kubeadm \u7684\u74b0\u5883\u5f8c\uff0c\u7cfb\u7d71\u4e0a\u90fd\u6709\u9019\u4e9b\u76f8\u95dc\u7684 container image."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ docker images | grep k8s.gcr\nk8s.gcr.io/kube-proxy                v1.17.3             ae853e93800d        3 weeks ago         116MB\nk8s.gcr.io/kube-controller-manager   v1.17.3             b0f1517c1f4b        3 weeks ago         161MB\nk8s.gcr.io/kube-apiserver            v1.17.3             90d27391b780        3 weeks ago         171MB\nk8s.gcr.io/kube-scheduler            v1.17.3             d109c0821a2b        3 weeks ago         94.4MB\nk8s.gcr.io/coredns                   1.6.5               70f311871ae1        4 months ago        41.6MB\nk8s.gcr.io/etcd                      3.4.3-0             303ce5db0e90        4 months ago        288MB\nk8s.gcr.io/pause                     3.1                 da86e6ba6ca1        2 years ago         742kB\n")),(0,a.kt)("p",null,"\u70ba\u4e86\u80fd\u5920\u904b\u884c\u8d77\u6574\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"Kubernetes"),", \u53ea\u8981\u900f\u904e(\u4ee5\u7bc4\u4f8b\u4f86\u8aaa) ",(0,a.kt)("strong",{parentName:"p"},"docker start")," \u7684\u65b9\u5f0f\u4e26\u4e14\u7d66\u4e88\u76f8\u95dc\u7684\u53c3\u6578\uff0c\u5c31\u80fd\u5920\u5c07\u6574\u500b API-Server/Controller/Schduler \u904b\u884c\u8d77\u4f86\u642d\u5efa\u4e00\u500b Kubernetes \u53e2\u96c6\u3002"),(0,a.kt)("p",null,"\u7136\u800c\u5be6\u969b\u4e0a\u4f60\u900f\u904e\u4e0b\u5217\u6307\u4ee4\u4f60\u537b\u6703\u767c\u73fe ",(0,a.kt)("inlineCode",{parentName:"p"},"kube-system")," \u4e2d\u537b\u6709\u9019\u4e09\u500b\u5bb9\u5668\u7684\u5b58\u5728"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ kubectl -n kube-system get pods\nNAME                              READY   STATUS    RESTARTS   AGE\ncoredns-6955765f44-gdvrd          1/1     Running   1          15d\ncoredns-6955765f44-p4wj2          1/1     Running   1          15d\netcd-k8s-dev                      1/1     Running   1          15d\nkube-apiserver-k8s-dev            1/1     Running   1          15d\nkube-controller-manager-k8s-dev   1/1     Running   1          15d\nkube-flannel-ds-amd64-k2w8g       1/1     Running   1          15d\nkube-proxy-6nnrt                  1/1     Running   1          15d\nkube-scheduler-k8s-dev            1/1     Running   1          15d\n")),(0,a.kt)("p",null,"\u66f4\u7279\u5225\u7684\u662f\uff0c\u7531\u4e0b\u5217\u5e7e\u7a2e\u65b9\u5f0f\u53ef\u4ee5\u63a8\u8ad6\u51fa\u57fa\u672c\u4e0a\u6c92\u6709\u4f7f\u7528\u66f4\u4e0a\u5c64\u7684\u7ba1\u7406 ",(0,a.kt)("strong",{parentName:"p"},"Deployment"),", ",(0,a.kt)("strong",{parentName:"p"},"ReplicaSet"),", ",(0,a.kt)("strong",{parentName:"p"},"DaemonSet"),", ",(0,a.kt)("strong",{parentName:"p"},"StatefulSet"),", ",(0,a.kt)("strong",{parentName:"p"},"ReplicatController")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Pod \u7684\u547d\u540d\u898f\u5247"),(0,a.kt)("li",{parentName:"ol"},"Pod \u88e1\u9762\u7684 ownerReference")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'vagrant@k8s-dev:~$ kubectl -n kube-system get pod kube-scheduler-k8s-dev -o json | jq \'.metadata.ownerReferences\'\n[\n  {\n    "apiVersion": "v1",\n    "controller": true,\n    "kind": "Node",\n    "name": "k8s-dev",\n    "uid": "b8755102-968b-41ac-a923-0e2cceacaf03"\n  }\n]\n')),(0,a.kt)("ol",{start:3},(0,a.kt)("li",{parentName:"ol"},"kubectl -n kube-system get all")),(0,a.kt)("p",null,"\u5c0d\u4e00\u500b\u6c92\u6709\u4efb\u4f55\u66f4\u9ad8\u968e\u7684 ",(0,a.kt)("strong",{parentName:"p"},"Controller")," \u7ba1\u7406\u7684 ",(0,a.kt)("strong",{parentName:"p"},"Pod")," \u4f86\u8aaa\uff0c\u4f60\u5982\u679c\u5617\u8a66\u5c07\u9019\u4e9b ",(0,a.kt)("strong",{parentName:"p"},"Pod")," \u79fb\u9664\uff0c\u4f60\u6703\u767c\u73fe\u9019\u4e9b ",(0,a.kt)("strong",{parentName:"p"},"Pod")," \u90fd\u6703\u81ea\u5df1\u91cd\u751f"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'vagrant@k8s-dev:~$ kubectl -n kube-system get pods -l component=kube-controller-manager\nNAME                              READY   STATUS    RESTARTS   AGE\nkube-controller-manager-k8s-dev   1/1     Running   1          15d\nvagrant@k8s-dev:~$ kubectl -n kube-system delete pod kube-controller-manager-k8s-dev\npod "kube-controller-manager-k8s-dev" deleted\nvagrant@k8s-dev:~$ kubectl -n kube-system get pods -l component=kube-controller-manager\nNAME                              READY   STATUS    RESTARTS   AGE\nkube-controller-manager-k8s-dev   0/1     Pending   0          3s\n')),(0,a.kt)("p",null,"\u4f46\u662f\u5982\u679c\u4f60\u81ea\u5df1\u5275\u7acb\u4e00\u500b ",(0,a.kt)("strong",{parentName:"p"},"pod")," \u4e26\u4e14\u522a\u9664\uff0c\u5c31\u771f\u7684\u5b8c\u5168\u522a\u9664\u4e0d\u6703\u91cd\u555f\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ kubectl get pods\nNo resources found in default namespace.\nvagrant@k8s-dev:~$ kubectl run --generator=run-pod/v1 nginx --image=nginx\npod/nginx created\nvagrant@k8s-dev:~$ kubectl get pods\nNAME    READY   STATUS              RESTARTS   AGE\nnginx   0/1     ContainerCreating   0          3s\nvagrant@k8s-dev:~$ kubectl get pods\nNAME    READY   STATUS    RESTARTS   AGE\nnginx   1/1     Running   0          6s\nvagrant@k8s-dev:~$ kubectl get pods nginx -o json | jq '.metadata.ownerReferences'\nnull\nvagrant@k8s-dev:~$ kubectl delete pod nginx\npod \"nginx\" deleted\nvagrant@k8s-dev:~$ kubectl get pods\nNo resources found in default namespace.\nvagrant@k8s-dev:~$\nvagrant@k8s-dev:~$\nvagrant@k8s-dev:~$ kubectl get pods\nNo resources found in default namespace.\nvagrant@k8s-dev:~$\n")),(0,a.kt)("p",null,"\u9019\u5176\u4e2d\u7684\u5967\u5999\u5c31\u5728\u65bc ",(0,a.kt)("strong",{parentName:"p"},"ownerReferences"),"\uff0c\u81ea\u884c\u5275\u7acb\u7684 ",(0,a.kt)("strong",{parentName:"p"},"pod")," \u662f\u5b8c\u5168\u7a7a\u7684\uff0c\u4f46\u662f ",(0,a.kt)("strong",{parentName:"p"},"kubeadm")," \u88e1\u9762\u7684 ",(0,a.kt)("strong",{parentName:"p"},"API Server/Controller/Scheduler")," \u537b\u662f\u6709\u8cc7\u6599\uff0c\u4e26\u4e14\u8cc7\u6599\u662f"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json="},'[\n  {\n    "apiVersion": "v1",\n    "controller": true,\n    "kind": "Node",\n    "name": "k8s-dev",\n    "uid": "b8755102-968b-41ac-a923-0e2cceacaf03"\n  }\n]\n')),(0,a.kt)("p",null,"\u5176\u5be6\u9019\u908a\u5df2\u7d93\u900f\u6f0f\u51fa\u4e86\u7384\u6a5f\uff0c\u9019\u4e9b ",(0,a.kt)("strong",{parentName:"p"},"Pod")," \u662f\u7531 ",(0,a.kt)("strong",{parentName:"p"},"\u7bc0\u9edeNode")," \u672c\u8eab\u53bb\u7dad\u8b77\u7684\uff0c\u672c\u8eab\u4e0d\u4f9d\u8cf4\u4efb\u4f55\u6211\u5011\u5230\u7684 workload \u578b\u614b\u3002 \u7bc0\u9ede\u53d6\u4ee3\u4e86\u904e\u5f80\u7684 ",(0,a.kt)("strong",{parentName:"p"},"Kubernetes Controller")," \u53bb\u78ba\u4fdd\u4e09\u500b\u6838\u5fc3\u529f\u80fd\u7684 Pod \u5fc5\u9808\u6d3b\u8005"),(0,a.kt)("p",null,"\u800c\u9019\u500b\u7528\u6cd5\u5c31\u662f\u6240\u8b02\u7684 Static Pod"),(0,a.kt)("h1",{id:"static-pod"},"Static Pod"),(0,a.kt)("p",null,"\u76f8\u5c0d\u65bc\u900f\u904e ",(0,a.kt)("strong",{parentName:"p"},"Kubernetess")," \u63a7\u5236\u5e73\u9762\u4f86\u7ba1\u7406\u9019\u4e9b ",(0,a.kt)("strong",{parentName:"p"},"Pod"),", ",(0,a.kt)("strong",{parentName:"p"},"Static Pod")," \u6709\u4e00\u4e9b\u7279\u6027"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u6c92\u6709 Schedule \u7684\u6982\u5ff5\uff0c\u5c31\u662f\u56fa\u5b9a\u65bc\u8a72\u7bc0\u9ede\u904b\u884c"),(0,a.kt)("li",{parentName:"ol"},"\u7531 Kubelet \u53bb\u9032\u884c\u76e3\u63a7\u4e26\u4e14\u7ba1\u7406\uff0c\u4e00\u65e6\u8a72 Pod \u7d50\u675f\u5247\u6703\u91cd\u65b0\u555f\u52d5"),(0,a.kt)("li",{parentName:"ol"},"Kubelet \u672c\u8eab\u6703 Mirror \u8a72 Pod \u7684\u8cc7\u8a0a\uff0c\u6240\u4ee5\u624d\u53ef\u4ee5\u900f\u904e kubectl \u7b49\u76f8\u95dc\u8cc7\u8a0a\u53bb\u770b\u5230")),(0,a.kt)("p",null,"\u5176\u4e2d\u5982\u679c(3)\u7684\u90e8\u5206\u53ef\u4ee5\u53c3\u95b1 ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/kubernetes/blob/v1.17.3/pkg/kubelet/kubelet.go#L1638"},"kubelet \u539f\u59cb\u78bc")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-golang="},'    // Create Mirror Pod for Static Pod if it doesn\'t already exist\n    if kubetypes.IsStaticPod(pod) {\n        podFullName := kubecontainer.GetPodFullName(pod)\n        deleted := false\n        if mirrorPod != nil {\n            if mirrorPod.DeletionTimestamp != nil || !kl.podManager.IsMirrorPodOf(mirrorPod, pod) {\n                // The mirror pod is semantically different from the static pod. Remove\n                // it. The mirror pod will get recreated later.\n                klog.Infof("Trying to delete pod %s %v", podFullName, mirrorPod.ObjectMeta.UID)\n                var err error\n                deleted, err = kl.podManager.DeleteMirrorPod(podFullName, &mirrorPod.ObjectMeta.UID)\n                if deleted {\n                    klog.Warningf("Deleted mirror pod %q because it is outdated", format.Pod(mirrorPod))\n                } else if err != nil {\n                    klog.Errorf("Failed deleting mirror pod %q: %v", format.Pod(mirrorPod), err)\n                }\n            }\n        }\n        if mirrorPod == nil || deleted {\n            node, err := kl.GetNode()\n            if err != nil || node.DeletionTimestamp != nil {\n                klog.V(4).Infof("No need to create a mirror pod, since node %q has been removed from the cluster", kl.nodeName)\n            } else {\n                klog.V(4).Infof("Creating a mirror pod for static pod %q", format.Pod(pod))\n                if err := kl.podManager.CreateMirrorPod(pod); err != nil {\n                    klog.Errorf("Failed creating a mirror pod for %q: %v", format.Pod(pod), err)\n                }\n            }\n        }\n    }\n')),(0,a.kt)("p",null,"\u5c0d\u65bc Kubelet \u4f86\u8aaa\uff0c\u5176\u672c\u8eab\u6709\u4e00\u500b\u8a2d\u5b9a\u53eb\u505a ",(0,a.kt)("inlineCode",{parentName:"p"},"staticPodPath"),", \u9019\u662f\u4e00\u500b\u8cc7\u6599\u593e\uff0c\u53ea\u8981\u653e\u5230\u8a72\u8cc7\u6599\u593e\u4e0b\u7684\u6a94\u6848\u90fd\u6703\u88ab ",(0,a.kt)("strong",{parentName:"p"},"kubelet")," \u7528\u4f86\u5275\u7acb ",(0,a.kt)("strong",{parentName:"p"},"static pod"),"."),(0,a.kt)("p",null,"\u81f3\u65bc ",(0,a.kt)("strong",{parentName:"p"},"Kubelet")," \u5275\u9020 ",(0,a.kt)("strong",{parentName:"p"},"Pod")," \u7684\u65b9\u5f0f\u5176\u5be6\u9084\u662f\u9075\u5faa ",(0,a.kt)("strong",{parentName:"p"},"Kubernetes")," \u7684\u8d70\u6cd5\uff0c\u4e26\u975e\u76f4\u63a5\u4f7f\u7528 ",(0,a.kt)("strong",{parentName:"p"},"docker start"),"(\u8209\u4f8b) \u4f86\u5275\u7acb\u3002\u9019\u90e8\u5206\u662f\u70ba\u4e86\u8b93\u6240\u6709\u7684 ",(0,a.kt)("strong",{parentName:"p"},"Container")," \u64cd\u4f5c\u5168\u90e8\u90fd\u7d93\u7531 ",(0,a.kt)("strong",{parentName:"p"},"Container Runtime Interface")," \u4f86\u7ba1\u7406\uff0c\u9032\u800c\u63d0\u4f9b\u66f4\u597d\u7684\u76f8\u5bb9\u6027\u3002"),(0,a.kt)("h1",{id:"hands-on"},"Hands-on"),(0,a.kt)("p",null,"\u63a5\u4e0b\u4f86\u6211\u5011\u5c31\u52d5\u624b\u89c0\u5bdf\u4e00\u4e0b\u76f8\u95dc\u7684\u53c3\u6578\uff0c\u9996\u5148\u6839\u64da\u525b\u525b ",(0,a.kt)("strong",{parentName:"p"},"systemd")," \u7684\u63d0\u793a\uff0c\u6211\u5011\u77e5\u9053\u7528\u4f86\u63a7\u7ba1 ",(0,a.kt)("strong",{parentName:"p"},"kubelet")," \u7684\u555f\u52d5\u6a94\u6848\u65bc ",(0,a.kt)("strong",{parentName:"p"},"/etc/systemd/system/kubelet.service.d/10-kubeadm.conf")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'vagrant@k8s-dev:~$ sudo cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n# Note: This dropin only works with kubeadm and kubelet v1.11+\n[Service]\nEnvironment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"\nEnvironment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"\n# This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically\nEnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env\n# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use\n# the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.\nEnvironmentFile=-/etc/default/kubelet\nExecStart=\nExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS\n')),(0,a.kt)("p",null,"\u88e1\u9762\u8981\u6ce8\u610f\u7684\u662f ",(0,a.kt)("strong",{parentName:"p"},"KUBELET_CONFIG_ARGS")," \u9019\u500b\u8b8a\u6578\uff0c\u88e1\u9762\u4f7f\u7528\u4e86 ",(0,a.kt)("strong",{parentName:"p"},"--config=/var/lib/kubelet/config.yaml")," \u4f86\u6307\u540d ",(0,a.kt)("strong",{parentName:"p"},"kubelet")," \u7684\u53c3\u6578\u6a94\u6848"),(0,a.kt)("p",null,"\u56e0\u6b64\u63a5\u4e0b\u4f86\u770b\u4e00\u4e0b\u5176\u5167\u5bb9"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ sudo cat  /var/lib/kubelet/config.yaml\napiVersion: kubelet.config.k8s.io/v1beta1\nauthentication:\n  anonymous:\n    enabled: false\n  webhook:\n    cacheTTL: 0s\n    enabled: true\n  x509:\n    clientCAFile: /etc/kubernetes/pki/ca.crt\nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 0s\n    cacheUnauthorizedTTL: 0s\nclusterDNS:\n- 10.96.0.10\nclusterDomain: cluster.local\ncpuManagerReconcilePeriod: 0s\nevictionPressureTransitionPeriod: 0s\nfileCheckFrequency: 0s\nhealthzBindAddress: 127.0.0.1\nhealthzPort: 10248\nhttpCheckFrequency: 0s\nimageMinimumGCAge: 0s\nkind: KubeletConfiguration\nnodeStatusReportFrequency: 0s\nnodeStatusUpdateFrequency: 0s\nrotateCertificates: true\nruntimeRequestTimeout: 0s\nstaticPodPath: /etc/kubernetes/manifests\nstreamingConnectionIdleTimeout: 0s\nsyncFrequency: 0s\nvolumeStatsAggPeriod: 0s\n")),(0,a.kt)("p",null,"\u5176\u4e2d\u5438\u5f15\u6211\u5011\u6ce8\u610f\u7684\u662f  ",(0,a.kt)("strong",{parentName:"p"},"staticPodPath")," \u9019\u500b\u53c3\u6578\uff0c\u63a5\u4e0b\u4f86\u770b\u4e00\u4e0b\u8a72\u8cc7\u6599\u593e\u7684\u4f4d\u7f6e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"vagrant@k8s-dev:~$ sudo ls /etc/kubernetes/manifests\netcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml\n")),(0,a.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\u88e1\u9762\u653e\u4e86\u56db\u500b ",(0,a.kt)("strong",{parentName:"p"},"yaml")," \u6a94\u6848(\u5305\u542b etcd)\uff0c\u5982\u679c\u6253\u958b\u9019\u4e9b ",(0,a.kt)("strong",{parentName:"p"},"yaml")," \u5c31\u6703\u662f\u6211\u5011\u6240\u719f\u6089\u7684 ",(0,a.kt)("strong",{parentName:"p"},"Kubernetes")," \u683c\u5f0f\u4e86\u3002"),(0,a.kt)("p",null,"\u5982\u679c\u9019\u6642\u5019\u96a8\u4fbf\u653e\u5165\u4e00\u500b ",(0,a.kt)("strong",{parentName:"p"},"yaml")," \u5230\u8a72\u8cc7\u6599\u593e\u4e2d\uff0c\u6703\u767c\u751f\u4ec0\u9ebc\u4e8b\u60c5?"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'\ncat <<EOF | sudo tee /etc/kubernetes/manifests/static-debug.yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: static-debug\nspec:\n  containers:\n    - name: hwchiu\n      image: hwchiu/netutils\nEOF\n\nvagrant@k8s-dev:~$ kubectl get  pods\nNAME                   READY   STATUS    RESTARTS   AGE\nstatic-debug-k8s-dev   1/1     Running   0          27s\nvagrant@k8s-dev:~$ kubectl delete pod static-debug-k8s-dev\npod "static-debug-k8s-dev" deleted\nvagrant@k8s-dev:~$ kubectl get  pods\nNAME                   READY   STATUS    RESTARTS   AGE\nstatic-debug-k8s-dev   0/1     Pending   0          1s\nvagrant@k8s-dev:~$ kubectl get  pods\nNAME                   READY   STATUS    RESTARTS   AGE\nstatic-debug-k8s-dev   1/1     Running   0          3s\n')),(0,a.kt)("p",null,"\u9019\u908a\u53ef\u4ee5\u770b\u5230\u99ac\u4e0a\u5c31\u6703\u7522\u751f\u5c0d\u61c9\u7684 ",(0,a.kt)("strong",{parentName:"p"},"Pod")," \u4e26\u4e14\u4e5f\u7372\u5f97\u4e86\u81ea\u52d5\u91cd\u5553\u7684\u80fd\u529b\u3002"),(0,a.kt)("p",null,"\u6700\u5f8c\uff01 \u6211\u5011\u900f\u904e ",(0,a.kt)("strong",{parentName:"p"},"docker  ps")," \u89c0\u5bdf\u4e00\u4e0b"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'vagrant@k8s-dev:~$ docker ps | grep kube-controller\n5f16cb76460f        b0f1517c1f4b           "kube-controller-man\u2026"   2 hours ago         Up 2 hours                              k8s_kube-controller-manager_kube-controller-manager-k8s-dev_kube-system_25245994bd78f09602b6f5c3e5d2246c_1\na94f104316af        k8s.gcr.io/pause:3.1   "/pause"                 2 hours ago         Up 2 hours                              k8s_POD_kube-controller-manager-k8s-dev_kube-system_25245994bd78f09602b6f5c3e5d2246c_1vagrant@k8s-dev:~$ docker ps | grep kube-controller\n5f16cb76460f        b0f1517c1f4b           "kube-controller-man\u2026"   2 hours ago         Up 2 hours                              k8s_kube-controller-manager_kube-controller-manager-k8s-dev_kube-system_25245994bd78f09602b6f5c3e5d2246c_1\na94f104316af        k8s.gcr.io/pause:3.1   "/pause"                 2 hours ago         Up 2 hours                              k8s_POD_kube-controller-manager-k8s-dev_kube-system_25245994bd78f09602b6f5c3e5d2246c_1\n')),(0,a.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\u91dd\u5c0d ",(0,a.kt)("strong",{parentName:"p"},"kube-controller-manager"),"  \u9019\u500b ",(0,a.kt)("strong",{parentName:"p"},"Pod")," \u4f86\u8aaa\uff0c\u5176\u5be6\u80cc\u5f8c\u4e5f\u662f\u6709 ",(0,a.kt)("strong",{parentName:"p"},"Pause Container")," \u4f5c\u70ba\u6574\u500b ",(0,a.kt)("strong",{parentName:"p"},"Pod")," \u7684\u6c99\u76d2\uff0c\u9019\u4e5f\u8b49\u660e\u4e86\u9019\u4e9b ",(0,a.kt)("strong",{parentName:"p"},"Static Pod")," \u7684\u5275\u5efa\u4e5f\u662f\u57fa\u65bc ",(0,a.kt)("strong",{parentName:"p"},"CRI")," \u7684\u6a19\u6e96\u6240\u5275\u7acb\u7684\uff0c\u4e26\u975e\u662f\u76f4\u63a5\u900f\u904e ",(0,a.kt)("strong",{parentName:"p"},"docker command")," \u4f86\u5275\u7acb\u3002"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"CRI \u5167\u7684\u57fa\u672c\u55ae\u4f4d\u90fd\u662f Pod, \u800c\u975e Container, \u6709\u8208\u8da3\u7684\u53ef\u4ee5\u53c3\u8003\u4ed6\u5011\u7684 gRPC \u4ecb\u9762")),(0,a.kt)("p",null,"\u53e6\u5916\uff0c\u5176\u5be6 ",(0,a.kt)("strong",{parentName:"p"},"kubeadm")," \u7684\u5b89\u88dd\u904e\u7a0b\u5c31\u5df2\u7d93\u900f\u9732\u51fa\u76f8\u95dc\u8cc7\u8a0a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'[control-plane] Using manifest folder "/etc/kubernetes/manifests"\n[control-plane] Creating static Pod manifest for "kube-apiserver"\n[control-plane] Creating static Pod manifest for "kube-controller-manager"\nW0310 06:57:46.902862    2798 manifests.go:214] the default kube-apiserver authorization-mode is "Node,RBAC"; using "Node,RBAC"\n[control-plane] Creating static Pod manifest for "kube-scheduler"\nW0310 06:57:46.903651    2798 manifests.go:214] the default kube-apiserver authorization-mode is "Node,RBAC"; using "Node,RBAC"\n[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"\n[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifes\nts". This can take up to 4m0s\n')),(0,a.kt)("h1",{id:"summary"},"Summary"),(0,a.kt)("p",null,"\u9019\u6b21\u6211\u5011\u63a2\u8a0e\u4e86\u95dc\u65bc ",(0,a.kt)("strong",{parentName:"p"},"Static Pod")," \u7684\u6982\u5ff5\uff0c\u96d6\u7136\u5be6\u969b\u90e8\u7f72\u4e0a\u6bd4\u8f03\u5c11\u9019\u6a23\u4f7f\u7528\uff0c\u4f46\u662f\u900f\u904e\u9019\u6b21\u7684\u63a2\u8a0e\u6211\u5011\u53ef\u4ee5\u66f4\u4e86\u89e3 ",(0,a.kt)("strong",{parentName:"p"},"Kubeadm")," \u662f\u5982\u4f55\u5b89\u88dd ",(0,a.kt)("strong",{parentName:"p"},"Kubernetes")," \u74b0\u5883\uff0c\n\u4e26\u4e14\u4e5f\u5b78\u7fd2\u5230\u4e86\u4e00\u4e9b ",(0,a.kt)("strong",{parentName:"p"},"Kubernetes")," \u672c\u8eab\u7684\u7279\u6027\u3002"),(0,a.kt)("h1",{id:"\u8ab2\u7a0b\u5206\u4eab"},"\u8ab2\u7a0b\u5206\u4eab"),(0,a.kt)("p",null,"\u6700\u5f8c\uff0c\u6211\u76ee\u524d\u65bc Hiskio \u4e0a\u9762\u6709\u958b\u8a2d\u4e00\u9580 Kubernetes \u5165\u9580\u7bc7\u7684\u8ab2\u7a0b\uff0c\u88e1\u9762\u6703\u63a2\u8a0e\u904b\u7b97/\u7db2\u8def/\u5132\u5b58\u4e09\u500b\u6700\u91cd\u8981\u7684\u5e73\u53f0\u8cc7\u6e90\uff0c\u6b64\u5916\u5c0d\u65bc CRI/CNI/CSI \u4e5f\u90fd\u6709\u7c21\u55ae\u7684\u4ecb\u7d39\uff0c\u4e3b\u8981\u6703\u57fa\u65bc ",(0,a.kt)("strong",{parentName:"p"},"Kubernetes")," \u672c\u8eab\u7684\u8a2d\u8a08\u539f\u7406\u53ca\u5404\u8cc7\u6e90\u7684\u7528\u6cd5\u8207\u60c5\u5883\u53bb\u4ecb\u7d39\u3002\n\u5982\u679c\u672c\u8eab\u5df2\u7d93\u5f88\u719f\u7df4\u7684\u4f7f\u7528 Kubernetes \u65bc\u74b0\u5883\u4e2d\u5c31\u4e0d\u592a\u9069\u5408\u9019\u9580\u8ab2\u7a0b\uff0c\u4e3b\u8981\u662f\u7d66\u60f3\u8981\u8e0f\u5165\u5230 Kubernetes \u4e16\u754c\u4e2d\u7684\u670b\u53cb\uff0c\u6709\u8208\u8da3\u7684\u5e6b\u5fd9\u6367\u5834\u6216\u63a8\u5ee3\n\u7dda\u4e0a\u8ab2\u7a0b\u8a73\u7d30\u8cc7\u8a0a: ",(0,a.kt)("a",{parentName:"p",href:"https://course.hwchiu.com/"},"https://course.hwchiu.com/")),(0,a.kt)("h1",{id:"reference"},"Reference"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/"},"https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/kubernetes/kubernetes/blob/v1.17.3/pkg/kubelet/kubelet.go#L1637-L1638"},"https://github.com/kubernetes/kubernetes/blob/v1.17.3/pkg/kubelet/kubelet.go#L1637-L1638"))))}c.isMDXComponent=!0}}]);