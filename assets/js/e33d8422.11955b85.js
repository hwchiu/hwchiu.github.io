"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[44029],{3905:(e,n,t)=>{t.d(n,{Zo:()=>k,kt:()=>N});var i=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},l=Object.keys(e);for(i=0;i<l.length;i++)t=l[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(i=0;i<l.length;i++)t=l[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var o=i.createContext({}),m=function(e){var n=i.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},k=function(e){var n=m(e.components);return i.createElement(o.Provider,{value:n},e.children)},s="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},d=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,l=e.originalType,o=e.parentName,k=p(e,["components","mdxType","originalType","parentName"]),s=m(t),d=a,N=s["".concat(o,".").concat(d)]||s[d]||u[d]||l;return t?i.createElement(N,r(r({ref:n},k),{},{components:t})):i.createElement(N,r({ref:n},k))}));function N(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var l=t.length,r=new Array(l);r[0]=d;var p={};for(var o in n)hasOwnProperty.call(n,o)&&(p[o]=n[o]);p.originalType=e,p[s]="string"==typeof e?e:a,r[1]=p;for(var m=2;m<l;m++)r[m]=t[m];return i.createElement.apply(null,r)}return i.createElement.apply(null,t)}d.displayName="MDXCreateElement"},27977:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>r,default:()=>u,frontMatter:()=>l,metadata:()=>p,toc:()=>m});var i=t(87462),a=(t(67294),t(3905));const l={title:"[Kubernetes] How to Implement Kubernetes Service - ClusterIP",date:new Date("2018-08-22T00:56:15.000Z"),tags:["Kubernetes","Linux","iptables","Network"],description:"\u5728\u524d\u8ff0\u4e2d\u6211\u5011\u5df2\u7d93\u5b78\u904e\u4e86\u4ec0\u9ebc\u662f kubernetes service, \u4e00\u822c\u60c5\u6cc1\u4e0b\u90fd\u6703\u63a1\u7528 ClusterIP \u7684\u5f62\u614b\u5e6b\u7279\u5b9a\u7684\u5bb9\u5668\u61c9\u7528\u7a0b\u5f0f\u63d0\u4f9b Service \u7684\u670d\u52d9. \u672c\u6587\u6703\u91dd\u5c0d ClusterIP \u7684\u6982\u5ff5\u9032\u884c\u66f4\u6df1\u5165\u7684\u63a2\u8a0e,\u4e26\u4e14\u5617\u8a66\u5f9e\u7cfb\u7d71\u5c64\u9762\u7684\u8a2d\u8a08\u8207\u61c9\u7528\u4f86\u7814\u7a76\u5230\u5e95 ClusterIP \u5e95\u5c64\u662f\u600e\u9ebc\u5be6\u4f5c\u7684,\u9019\u90e8\u5206\u7684\u5be6\u4f5c\u5305\u542b\u4e861) ClusterIP \u5230\u5e95\u5728\u90a3\u88e1\uff1f 2) \u5982\u679c\u6709\u591a\u500b Endpoints \u7684\u8a71, \u662f\u5982\u4f55\u9078\u64c7\u7576\u524d\u9023\u7dda\u7684\u6700\u7d42\u76ee\u6a19. \u9019\u4e9b\u7814\u7a76\u7684\u5167\u5bb9\u5305\u542b\u4e86\u5e38\u898b\u4e86\u7db2\u8def\u6982\u5ff5\uff0c\u5982 NAT(Network Address Translation) \u4ee5\u53ca iptables \u672c\u8eab\u7684\u8a2d\u8a08\u53ca\u4f7f\u7528\uff0c\u5982 table/chian \u7b49\u6982\u5ff5\u6709\u521d\u6b65\u7684\u8a8d\u77e5,\u9019\u6a23\u5c0d\u65bc\u672c\u6587\u7684\u63a2\u8a0e\u6703\u66f4\u660e\u767d\u8207\u77ad\u89e3."},r="Preface",p={unversionedId:"techPost/2018/kubernetes-service-ii",id:"techPost/2018/kubernetes-service-ii",title:"[Kubernetes] How to Implement Kubernetes Service - ClusterIP",description:"\u5728\u524d\u8ff0\u4e2d\u6211\u5011\u5df2\u7d93\u5b78\u904e\u4e86\u4ec0\u9ebc\u662f kubernetes service, \u4e00\u822c\u60c5\u6cc1\u4e0b\u90fd\u6703\u63a1\u7528 ClusterIP \u7684\u5f62\u614b\u5e6b\u7279\u5b9a\u7684\u5bb9\u5668\u61c9\u7528\u7a0b\u5f0f\u63d0\u4f9b Service \u7684\u670d\u52d9. \u672c\u6587\u6703\u91dd\u5c0d ClusterIP \u7684\u6982\u5ff5\u9032\u884c\u66f4\u6df1\u5165\u7684\u63a2\u8a0e,\u4e26\u4e14\u5617\u8a66\u5f9e\u7cfb\u7d71\u5c64\u9762\u7684\u8a2d\u8a08\u8207\u61c9\u7528\u4f86\u7814\u7a76\u5230\u5e95 ClusterIP \u5e95\u5c64\u662f\u600e\u9ebc\u5be6\u4f5c\u7684,\u9019\u90e8\u5206\u7684\u5be6\u4f5c\u5305\u542b\u4e861) ClusterIP \u5230\u5e95\u5728\u90a3\u88e1\uff1f 2) \u5982\u679c\u6709\u591a\u500b Endpoints \u7684\u8a71, \u662f\u5982\u4f55\u9078\u64c7\u7576\u524d\u9023\u7dda\u7684\u6700\u7d42\u76ee\u6a19. \u9019\u4e9b\u7814\u7a76\u7684\u5167\u5bb9\u5305\u542b\u4e86\u5e38\u898b\u4e86\u7db2\u8def\u6982\u5ff5\uff0c\u5982 NAT(Network Address Translation) \u4ee5\u53ca iptables \u672c\u8eab\u7684\u8a2d\u8a08\u53ca\u4f7f\u7528\uff0c\u5982 table/chian \u7b49\u6982\u5ff5\u6709\u521d\u6b65\u7684\u8a8d\u77e5,\u9019\u6a23\u5c0d\u65bc\u672c\u6587\u7684\u63a2\u8a0e\u6703\u66f4\u660e\u767d\u8207\u77ad\u89e3.",source:"@site/docs/techPost/2018/kubernetes-service-ii.md",sourceDirName:"techPost/2018",slug:"/techPost/2018/kubernetes-service-ii",permalink:"/docs/techPost/2018/kubernetes-service-ii",draft:!1,tags:[{label:"Kubernetes",permalink:"/docs/tags/kubernetes"},{label:"Linux",permalink:"/docs/tags/linux"},{label:"iptables",permalink:"/docs/tags/iptables"},{label:"Network",permalink:"/docs/tags/network"}],version:"current",frontMatter:{title:"[Kubernetes] How to Implement Kubernetes Service - ClusterIP",date:"2018-08-22T00:56:15.000Z",tags:["Kubernetes","Linux","iptables","Network"],description:"\u5728\u524d\u8ff0\u4e2d\u6211\u5011\u5df2\u7d93\u5b78\u904e\u4e86\u4ec0\u9ebc\u662f kubernetes service, \u4e00\u822c\u60c5\u6cc1\u4e0b\u90fd\u6703\u63a1\u7528 ClusterIP \u7684\u5f62\u614b\u5e6b\u7279\u5b9a\u7684\u5bb9\u5668\u61c9\u7528\u7a0b\u5f0f\u63d0\u4f9b Service \u7684\u670d\u52d9. \u672c\u6587\u6703\u91dd\u5c0d ClusterIP \u7684\u6982\u5ff5\u9032\u884c\u66f4\u6df1\u5165\u7684\u63a2\u8a0e,\u4e26\u4e14\u5617\u8a66\u5f9e\u7cfb\u7d71\u5c64\u9762\u7684\u8a2d\u8a08\u8207\u61c9\u7528\u4f86\u7814\u7a76\u5230\u5e95 ClusterIP \u5e95\u5c64\u662f\u600e\u9ebc\u5be6\u4f5c\u7684,\u9019\u90e8\u5206\u7684\u5be6\u4f5c\u5305\u542b\u4e861) ClusterIP \u5230\u5e95\u5728\u90a3\u88e1\uff1f 2) \u5982\u679c\u6709\u591a\u500b Endpoints \u7684\u8a71, \u662f\u5982\u4f55\u9078\u64c7\u7576\u524d\u9023\u7dda\u7684\u6700\u7d42\u76ee\u6a19. \u9019\u4e9b\u7814\u7a76\u7684\u5167\u5bb9\u5305\u542b\u4e86\u5e38\u898b\u4e86\u7db2\u8def\u6982\u5ff5\uff0c\u5982 NAT(Network Address Translation) \u4ee5\u53ca iptables \u672c\u8eab\u7684\u8a2d\u8a08\u53ca\u4f7f\u7528\uff0c\u5982 table/chian \u7b49\u6982\u5ff5\u6709\u521d\u6b65\u7684\u8a8d\u77e5,\u9019\u6a23\u5c0d\u65bc\u672c\u6587\u7684\u63a2\u8a0e\u6703\u66f4\u660e\u767d\u8207\u77ad\u89e3."},sidebar:"techPost",previous:{title:"[Kubernetes] What Is Service?",permalink:"/docs/techPost/2018/kubernetes-service-i"},next:{title:"[Kubernetes] How to Implement Kubernetes Service - NodePort",permalink:"/docs/techPost/2018/kubernetes-service-iii"}},o={},m=[{value:"Endpoints",id:"endpoints",level:2},{value:"Custom Chain",id:"custom-chain",level:2},{value:"iptables-save",id:"iptables-save",level:2},{value:"Access By FQDN",id:"access-by-fqdn",level:2},{value:"Cluster Only",id:"cluster-only",level:2},{value:"Loab Balancing",id:"loab-balancing",level:2}],k={toc:m},s="wrapper";function u(e){let{components:n,...t}=e;return(0,a.kt)(s,(0,i.Z)({},k,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"preface"},"Preface"),(0,a.kt)("p",null,"\u672c\u6587\u7ae0\u662f\u5c6c\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"kubernetes")," service \u7cfb\u5217\u6587\u4e4b\u4e00\uff0c\u8a72\u7cfb\u5217\u6587\u5e0c\u671b\u80fd\u5920\u8207\u5927\u5bb6\u8a0e\u8ad6\u4e0b\u5217\u5169\u500b\u89c0\u5ff5"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u4ec0\u9ebc\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"Kubernetes Service"),", \u70ba\u4ec0\u9ebc\u6211\u5011\u9700\u8981\u5b83\uff1f \u5b83\u80fd\u5920\u5e6b\u5fd9\u89e3\u6c7a\u4ec0\u9ebc\u554f\u984c"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"Kubernetes Service")," \u662f\u600e\u9ebc\u5be6\u73fe\u7684?\uff0c \u8b93\u6211\u5011\u7528 iptables \u4f86\u5fb9\u5fb9\u5e95\u5e95\u7684\u7406\u89e3\u4ed6")),(0,a.kt)("p",null,"\u76f8\u95dc\u6587\u7ae0:\n",(0,a.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/kubernetes-service-i.html"},"[Kubernetes] What is Service"),"\n",(0,a.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/kubernetes-service-iii.html"},"[Kubernetes] How To Implement Kubernetes Service - NodePort"),"\n",(0,a.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/kubernetes-service-iiii.html"},"[Kubernetes] How To Implement Kubernetes Service - SessionAffinity")),(0,a.kt)("p",null,"\u672c\u7bc7\u6587\u7ae0\u8457\u91cd\u65bc\u5f8c\u8005\uff0c\u900f\u904e\u5c0d\u7cfb\u7d71\u4e0a\u7684\u5206\u6790\u4f86\u63a2\u8a0e ",(0,a.kt)("inlineCode",{parentName:"p"},"kubernetes service")," \u5be6\u4f5c\u7684\u539f\u7406\u3002\n\u7531\u65bc\u7bc7\u5e45\u6709\u9650\uff0c\u672c\u6587\u6703\u5c07\u57fa\u672c\u6982\u5ff5\u90fd\u8aaa\u660e\u4e00\u904d\uff0c\u4e26\u4e14\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"ClusterIP")," \u9019\u500b\u5f62\u5f0f\u4f86\u89e3\u91cb\u5176\u904b\u4f5c\u539f\u7406\u3002\n\u5f85\u4e0b\u7bc7\u6587\u7ae0\u5728\u4f86\u89e3\u91cb ",(0,a.kt)("inlineCode",{parentName:"p"},"NodePort")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"SessionAffinity")," \u662f\u5982\u4f55\u5be6\u73fe\u7684\u3002"),(0,a.kt)("p",null,"\u5f88\u591a\u4eba\u5728\u5b78\u7fd2\u4e00\u500b\u65b0\u7684\u7cfb\u7d71\u7684\u6642\u5019\uff0c\u6700\u521d\u63a5\u89f8\u7684\u90fd\u662f\u5982\u4f55\u4f7f\u7528\uff0c\u5982\u4f55\u64cd\u4f5c\uff0c\u7136\u800c\u5c0d\u5176\u80cc\u5f8c\u7684\u5be6\u73fe\u539f\u7406\u537b\u6c92\u6709\u592a\u591a\u7684\u8457\u58a8\u3002\n\u70ba\u4ec0\u9ebc\u8981\u5b78\u7fd2\u5be6\u73fe\u7684\u539f\u7406\uff1f\n\u5f88\u7c21\u55ae\uff0c\u56e0\u70ba\u300c\u77e5\u5df1\u77e5\u5f7c\uff0c\u767e\u6230\u767e\u52dd\u300d\n\u7576\u6211\u5011\u7406\u89e3\u9019\u4e9b\u529f\u80fd\u80cc\u5f8c\u7684\u5be6\u73fe\u65b9\u5f0f\u5f8c\uff0c\u6211\u5011\u4e0d\u4f46\u53ef\u4ee5\u5b78\u7fd2\u5230\u5176\u80cc\u5f8c\u7684\u8a2d\u8a08\u7406\u5ff5\u8207\u65b9\u5f0f\uff0c\u540c\u6642\u7576\u554f\u984c\u51fa\u73fe\u6642\u3002\n\u6211\u5011\u53ef\u4ee5\u6bd4\u4e00\u822c\u4f7f\u7528\u8005\u7528\u66f4\u5ee3\u7684\u89d2\u5ea6\u53bb\u601d\u8003\u554f\u984c\uff0c\u540c\u6642\u4e5f\u53ef\u4ee5\u63a1\u7528\u66f4\u7cfb\u7d71\u7684\u65b9\u5f0f\u53bb\u9664\u932f\u627e\u51fa\u554f\u984c\u7684\u6839\u672c\uff0c\u9019\u66f4\u80fd\u9ad4\u73fe\u51fa\u4f60\u76f8\u5c0d\u65bc\u4e00\u822c\u4eba\u7684\u50f9\u503c\u3002"),(0,a.kt)("h1",{id:"introduction"},"Introduction"),(0,a.kt)("p",null,"\u5728\u524d\u7bc7\u6587\u7ae0 ",(0,a.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/kubernetes-service-i.html"},"[Kubernetes] What is Service")," \u6211\u5011\u5df2\u7d93\u5b78\u7fd2\u5230\u95dc\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"Kubernetes Service")," \u7684\u57fa\u672c\u6982\u5ff5\u8207\u7528\u6cd5\n\u800c\u672c\u7bc7\u6587\u7ae0\u5247\u662f\u60f3\u8981\u63a2\u8a0e\u5728\u9810\u8a2d\u5b89\u88dd\u60c5\u6cc1\u4e0b\uff0c ",(0,a.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u662f\u5982\u4f55\u5be6\u73fe ",(0,a.kt)("inlineCode",{parentName:"p"},"service")," \u7684\u529f\u80fd\u3002"),(0,a.kt)("h1",{id:"kube-proxy-mode"},"Kube-Proxy Mode"),(0,a.kt)("p",null,"\u76ee\u524d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Kubernetes")," \u88e1\u9762\u7e3d\u5171\u6709\u4e09\u7a2e\u65b9\u6cd5\u53bb\u5be6\u73fe ",(0,a.kt)("inlineCode",{parentName:"p"},"Service"),"\uff0c\u5206\u5225\u662f"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"kube-Proxy (old)"),(0,a.kt)("li",{parentName:"ol"},"iptables (default)"),(0,a.kt)("li",{parentName:"ol"},"ipvs (experimental)")),(0,a.kt)("p",null,"\u7c21\u55ae\u6558\u8ff0\u4e00\u4e0b\u9019\u4e09\u7a2e\u7684\u5dee\u7570"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"kube-Proxy \u662f\u6307\u900f\u904e",(0,a.kt)("inlineCode",{parentName:"li"},"kube-proxy"),"\u672c\u8eab\u7a0b\u5f0f\u5167\u90e8\u7684\u908f\u8f2f\u4f86\u5be6\u73fe ",(0,a.kt)("inlineCode",{parentName:"li"},"service"),"\uff0c\u7531\u65bc ",(0,a.kt)("inlineCode",{parentName:"li"},"kube-proxy")," \u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"user-space")," \u7684\u61c9\u7528\u7a0b\u5f0f\uff0c\u6240\u4ee5\u6548\u7387\u975e\u5e38\u4f4e\u843d\uff0c\u4f46\u662f\u56e0\u70ba\u662f\u7a0b\u5f0f\u5316\u7684\u7d50\u679c\uff0c\u5f48\u6027\u6bd4\u8f03\u9ad8\u3002"),(0,a.kt)("li",{parentName:"ol"},"iptables \u7684\u8a71\uff0c\u5247\u662f\u8b93 ",(0,a.kt)("inlineCode",{parentName:"li"},"kube-proxy")," \u53bb\u7dad\u8b77\u8ddf ",(0,a.kt)("inlineCode",{parentName:"li"},"service"),"\u6709\u95dc\u7684\u908f\u8f2f\u90e8\u5206\uff0c\u771f\u6b63\u6240\u6709\u5c01\u5305\u8f49\u9001\u90fd\u4ea4\u7531 ",(0,a.kt)("inlineCode",{parentName:"li"},"kernel-space")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u4f86\u8655\u7406\u3002 \u6548\u7387\u6bd4(1)\u4f86\u5f97\u5f37\uff0c\u4f46\u662f\u5728\u4f7f\u7528\u4e0a\u5247\u662f\u6703\u53d7\u9650\u65bc ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u7684\u898f\u5247\u8207\u6846\u67b6\u3002"),(0,a.kt)("li",{parentName:"ol"},"ipvs(IP virtual switch) \u8207(2)\u985e\u4f3c\uff0c\u53ea\u662f\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"kernel-space")," \u88e1\u9762\u63a1\u7528 ",(0,a.kt)("inlineCode",{parentName:"li"},"ipvs")," \u7684\u65b9\u5f0f\u4f86\u8f49\u9001\u5c01\u5305\uff0c\u76f8\u5c0d\u65bc ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u672c\u8eab\u6548\u7387\u66f4\u9ad8\uff0c\u540c\u6642\u4e5f\u4e0d\u6703\u53d7\u9650\u65bc",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u7684\u4f7f\u7528\u898f\u5247")),(0,a.kt)("p",null,"\u6211\u5011\u53ef\u4ee5\u85c9\u7531\u8a2d\u5b9a ",(0,a.kt)("inlineCode",{parentName:"p"},"kube-proxy")," \u88e1\u9762\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"--proxy-mode")," \u9019\u500b\u53c3\u6578\u4f86\u6c7a\u5b9a\u8981\u4f7f\u7528\u54ea\u4e00\u7a2e\u5be6\u73fe\u65b9\u5f0f"),(0,a.kt)("p",null,"kube-proxy \u672c\u8eab\u6703\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"daemonset")," \u7684\u65b9\u5f0f\u90e8\u5c6c\u5230\u6bcf\u4e00\u500b\u7bc0\u9ede\u4e0a\uff0c\u6709\u8208\u8da3\u7684\u53ef\u4ee5\u900f\u904e\nkubectl -n kube-system describe ds kube-proxy \u6307\u4ee4\u89c0\u5bdf\u4e00\u4e0b\u76f8\u95dc\u7684\u5167\u5bb9"),(0,a.kt)("p",null,"\u56de\u6b78\u6b63\u984c\uff0c\u672c\u6587\u4e3b\u8981\u63a2\u8a0e\u7684\u5c0d\u8c61\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables"),"\uff0c\u770b\u770b\u9019\u500b\u6b77\u53f2\u60a0\u4e45\u4e14\u529f\u80fd\u5f37\u5927\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u6846\u67b6\u662f\u5982\u4f55\u5b8c\u6210 ",(0,a.kt)("inlineCode",{parentName:"p"},"kubernetes service")," \u6240\u9700\u8981\u7684\u5404\u7a2e\u529f\u80fd"),(0,a.kt)("h1",{id:"iptables"},"Iptables"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u672c\u8eab\u771f\u6b63\u8b1b\u8d77\u4f86\uff0c\u5176\u5be6\u662f\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"user-space")," \u7684\u7ba1\u7406\u5de5\u5177",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u642d\u914d ",(0,a.kt)("inlineCode",{parentName:"p"},"kernel-space")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"netfilter")," \u7db2\u8def\u5b50\u7cfb\u7d71\u5169\u8005\u7d44\u5408\u4f86\u63d0\u4f9b\u5404\u5f0f\u5404\u6a23\u7684\u529f\u80fd\u3002"),(0,a.kt)("p",null,"\u60f3\u8981\u66f4\u52a0\u77ad\u89e3 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684\u4ecb\u7d39\u53ef\u4ee5\u53c3\u95b1\u6211\u5728 ",(0,a.kt)("a",{parentName:"p",href:"https://www.slideshare.net/hongweiqiu/understand-the-iptables-step-by-step-109650841"},"COSCUP x GNOME.Asia x openSUSE.Asia 2018")," \u6240\u8b1b\u6388\u7684\u900f\u904e\u95b1\u8b80\u539f\u59cb\u78bc\u7684\u65b9\u5f0f\u4f86\u66f4\u52a0\u77ad\u89e3 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables"),".\n\u6b64\u5916\u6211\u4e4b\u5f8c\u4e5f\u6703\u64b0\u5beb\u8ddf ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u76f8\u95dc\u7684\u6587\u7ae0\uff0c\u5230\u6642\u5019\u6703\u6574\u7406\u76f8\u95dc\u7684\u5167\u5bb9\u8b93\u5927\u5bb6\u66f4\u5bb9\u6613\u53bb\u7406\u89e3\u9019\u5957\u5f37\u5927\u7684\u5de5\u5177\u3002"),(0,a.kt)("p",null,"\u70ba\u4e86\u7406\u89e3\u672c\u7bc7\u6587\u7ae0\u63a5\u4e0b\u4f86\u7684\u5167\u5bb9\uff0c\u6211\u5011\u5fc5\u9808\u8981\u5c0d ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u6709\u4e00\u4e9b\u57fa\u672c\u7684\u8a8d\u8b58\uff0c\u9019\u908a\u5e6b\u5927\u5bb6\u6574\u7406\u4e00\u4e0b\u9700\u8981\u7684\u6982\u5ff5\u3002"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u88e1\u9762\u6bcf\u500b\u898f\u5247\u9762\u5c0d\u7684\u5c0d\u8c61\u90fd\u662f\u4e00\u500b\u500b\u7684\u7db2\u8def\u5c01\u5305"),(0,a.kt)("li",{parentName:"ol"},"\u6bcf\u689d\u898f\u5247\u7684\u908f\u8f2f\u5927\u62b5\u4e0a\u5982\u4e0b",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u8acb\u554f\u8a72\u5c01\u5305\u6709\u6c92\u6709\u7b26\u5408 ",(0,a.kt)("inlineCode",{parentName:"li"},"Match")," \u689d\u4ef6"),(0,a.kt)("li",{parentName:"ul"},"\u5982\u679c\u6709 ",(0,a.kt)("inlineCode",{parentName:"li"},"Match"),", \u5247\u57f7\u884c\u76ee\u6a19 ",(0,a.kt)("inlineCode",{parentName:"li"},"Action(Target)")))),(0,a.kt)("li",{parentName:"ol"},"\u6bcf\u689d\u898f\u5247\u90fd\u5c6c\u65bc\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"chain"),", \u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"chain")," \u53ef\u4ee5\u6709\u591a\u689d\u898f\u5247"),(0,a.kt)("li",{parentName:"ol"},"\u9664\u4e86\u5167\u5efa\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"chain")," \u4e4b\u5916, \u7ba1\u7406\u8005\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u65b0\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"chain")," \u65b9\u4fbf\u7ba1\u7406")),(0,a.kt)("p",null,"\u6709\u4e86\u57fa\u672c\u6982\u5ff5\u5f8c\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u958b\u59cb\u4f86\u63a2\u8a0e ",(0,a.kt)("inlineCode",{parentName:"p"},"kubernetes serivce")," \u5982\u4f55\u5be6\u4f5c\u4e86"),(0,a.kt)("p",null,"\u82e5\u9700\u8981\u771f\u6b63\u5b8c\u5168\u7406\u89e3\u9019\u4e00\u5207\uff0c\u9084\u9700\u8981\u642d\u914d ",(0,a.kt)("inlineCode",{parentName:"p"},"PREROTUING"),",",(0,a.kt)("inlineCode",{parentName:"p"},"FORWARD"),",",(0,a.kt)("inlineCode",{parentName:"p"},"POSTRING")," \u7b49\u4e0d\u540c ",(0,a.kt)("inlineCode",{parentName:"p"},"table")," \u7684\u5148\u5f8c\u95dc\u4fc2\u8207\u6982\u5ff5\uff0c\u4e0d\u4f46\u5c0d\u65bc\u7406\u89e3\u6709\u66f4\u52a0\u7684\u5e6b\u52a9\uff0c\u5c0d\u65bc\u9664\u932f\u627e\u554f\u984c\u4e5f\u662f\u6709\u5f88\u5927\u7684\u6548\u76ca\u3002\n\u6709\u8208\u8da3\u7684\u8b80\u8005\u53ef\u81ea\u884c\u4e0a\u7db2\u5c0b\u627e\u76f8\u95dc\u6587\u7ae0\u5b78\u7fd2\uff0c\u6216\u662f\u7b49\u6211\u54ea\u5929\u6703\u5beb\u51fa\u76f8\u95dc\u7684\u6587\u7ae0\u4f86\u4ecb\u7d39\u9019\u4e9b\u8cc7\u8a0a\u3002"),(0,a.kt)("h1",{id:"kubernetes-service"},"Kubernetes Service"),(0,a.kt)("p",null,"\u5728\u6211\u5011\u958b\u59cb\u524d\uff0c\u6211\u5011\u8981\u5148\u5b9a\u7fa9\u5e7e\u500b\u76f8\u95dc\u7684\u540d\u8a5e\uff0c\u65b9\u4fbf\u4e4b\u5f8c\u95b1\u8b80\u7684\u6642\u5019\u53ef\u4ee5\u9806\u5229\u7684\u7406\u89e3\u524d\u5f8c\u6587\u7684\u95dc\u4fc2\u8207\u6982\u5ff5\u3002"),(0,a.kt)("p",null,"\u9019\u908a\u5148\u501f\u7528 ",(0,a.kt)("a",{parentName:"p",href:"https://www.hwchiu.com/kubernetes-service-i.htmlvvv"},"[Kubernetes] What is Service")," \u5167\u6700\u5f8c\u5c55\u793a\u7bc4\u4f8b\u4f7f\u7528\u7684\u6982\u5ff5\u5716\n",(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/osNqxlw.png",alt:"Imgur"})),(0,a.kt)("h2",{id:"endpoints"},"Endpoints"),(0,a.kt)("p",null,"\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"kubernetes")," \u5167\u6709\u4e00\u500b\u540d\u70ba ",(0,a.kt)("inlineCode",{parentName:"p"},"endpoints")," \u7684\u8cc7\u6e90\uff0c\u5176\u4ee3\u8868\u7684\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"service")," \u6240\u95dc\u6ce8\u76ee\u6a19\u670d\u52d9\u5be6\u969b\u4e0a\u771f\u6b63\u904b\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"Pod"),"\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"vortex-dev:02:00:28 [~/go/src/github.com/hwchiu/kubeDemo](master)vagrant\n$kubectl get endpoints\nNAME                ENDPOINTS                                      AGE\nk8s-nginx-cluster   10.244.0.88:80,10.244.0.89:80,10.244.0.90:80   9h\nk8s-nginx-node      10.244.0.88:80,10.244.0.89:80,10.244.0.90:80   9h\nkubernetes          172.17.8.100:6443                              11d\n")),(0,a.kt)("p",null,"\u53ef\u4ee5\u5f9e\u4e0a\u8ff0\u7684\u8f38\u51fa\u7d50\u679c\u770b\u5230\u6bcf\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"service")," \u90fd\u6703\u5c0d\u61c9\u5230\u591a\u7d44\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"endpoints"),"\uff0c\u6240\u4ee5\u7576\u53e2\u96c6\u5167\u7684\u5bb9\u5668\u6709\u4efb\u4f55 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u66f4\u52d5\u7684\u6642\u5019\uff0c\u9019\u908a\u7684\u6578\u64da\u90fd\u6703\u81ea\u52d5\u66f4\u65b0\uff0c\u4ee5\u78ba\u4fdd ",(0,a.kt)("inlineCode",{parentName:"p"},"service")," \u6709\u8fa6\u6cd5\u5b58\u53d6\u5f8c\u7aef\u771f\u6b63\u7684\u670d\u52d9"),(0,a.kt)("p",null,"\u6709\u5728\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"Service")," \u7684\u8b80\u8005\uff0c\u4ee5\u5f8c\u82e5\u6709\u9047\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"service")," \u4e0d\u901a\u7684\u60c5\u6cc1\uff0c\u53ef\u4ee5\u5617\u8a66\u5148\u770b\u770b\u8a72 ",(0,a.kt)("inlineCode",{parentName:"p"},"service")," \u662f\u5426\u6709\u5c0d\u61c9\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"endpoints"),"\uff0c\u6c92\u6709\u7684\u8a71\u53ef\u80fd\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"selector")," \u5beb\u932f\u6216\u662f\u76ee\u6a19\u670d\u52d9\u6839\u672c\u6c92\u6709\u904b\u884c\u8d77\u4f86\u3002"),(0,a.kt)("h2",{id:"custom-chain"},"Custom Chain"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"kubenetes")," \u4f7f\u7528 iptables \u6642\u70ba\u4e86\u66f4\u6709\u6548\u7ba1\u7406\u4e0d\u540c\u7684\u529f\u80fd\u8207\u898f\u5247\u7684\u6b78\u5c6c\uff0c\u5efa\u7acb\u7684\u5927\u91cf\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"custom chain")),(0,a.kt)("h2",{id:"iptables-save"},"iptables-save"),(0,a.kt)("p",null,"\u9019\u662f\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u76f8\u95dc\u7684\u6307\u4ee4\uff0c\u6211\u500b\u4eba\u5f88\u559c\u6b61\u7528\u5b83\u4f86\u89c0\u5bdf ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684\u898f\u5247\uff0c\u672c\u6587\u7684\u6240\u6709\u7bc4\u4f8b\u90fd\u6703\u662f\u4f7f\u7528\u8a72\u6307\u4ee4\u9032\u884c\u5c55\u793a"),(0,a.kt)("h1",{id:"clusterip"},"ClusterIP"),(0,a.kt)("p",null,"\u6211\u5011\u5df2\u7d93\u77e5\u9053 ",(0,a.kt)("inlineCode",{parentName:"p"},"ClusterIP")," \u7684\u4f5c\u7528\u7bc4\u570d\u53ea\u6709",(0,a.kt)("inlineCode",{parentName:"p"},"\u53e2\u96c6\u5167"),"\u7684\u61c9\u7528\u7a0b\u5f0f/\u7bc0\u9ede\uff0c\u6240\u4ee5\u5728\u672c\u6bb5\u843d\u6211\u5011\u6703\u8457\u91cd\u65bc\u4e09\u500b\u6982\u5ff5\u4f86\u7406\u89e3"),(0,a.kt)("p",null,"\u53e2\u96c6\u5167\u7bc0\u9ede\u662f\u7684\u5b58\u53d6\u6bd4\u8f03\u5c37\u5c2c\uff0c\u7684\u78ba\u53ef\u4ee5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"ClusterIP")," \u5730\u5740\u4f86\u5b58\u53d6\uff0c\u4f46\u662f\u9810\u8a2d\u60c5\u6cc1\u4e0b\u662f\u6c92\u6709\u8fa6\u6cd5\u89e3\u6790",(0,a.kt)("inlineCode",{parentName:"p"},"FQDN"),"\u53d6\u5f97\u5c0d\u61c9\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"ClusterIP")," \u5730\u5740\u3002"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u5982\u4f55\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"FQDN")," \u8f3e\u8f49\u5b58\u53d6\u5230\u76ee\u6a19\u5bb9\u5668\u5011(Endpoints)"),(0,a.kt)("li",{parentName:"ol"},"\u5982\u4f55\u505a\u5230\u53ea\u6709",(0,a.kt)("inlineCode",{parentName:"li"},"\u53e2\u96c6\u5167"),"\u7684\u61c9\u7528\u7a0b\u5f0f/\u7bc0\u9ede\u624d\u53ef\u4ee5\u5b58\u53d6"),(0,a.kt)("li",{parentName:"ol"},"\u5047\u8a2d\u6709\u591a\u500b\u76ee\u6a19\u5bb9\u5668(Endpoints), \u9019\u4e2d\u9593\u7684\u9078\u64c7\u65b9\u5f0f\u662f\u600e\u9ebc\u8655\u7406?")),(0,a.kt)("h2",{id:"access-by-fqdn"},"Access By FQDN"),(0,a.kt)("p",null,"\u6211\u5011\u90fd\u77e5\u9053 ",(0,a.kt)("inlineCode",{parentName:"p"},"Service")," \u672c\u8eab\u6703\u63d0\u4f9b\u4e00\u7d44\u5c0d\u61c9\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"FQDN")," \u4f9b\u61c9\u7528\u7a0b\u5f0f\u4f7f\u7528\n\u5be6\u969b\u4e0a\u9019\u7d44",(0,a.kt)("inlineCode",{parentName:"p"},"FQDN")," \u53ea\u6709 ",(0,a.kt)("inlineCode",{parentName:"p"},"kube-dns")," \u80fd\u5920\u7406\u89e3\uff0c\u800c\u4e14\u5176\u5c0d\u61c9\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740\u5176\u5be6\u5c31\u662f\u6bcf\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"Service")," \u63d0\u4f9b\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"ClusterIP"),"\n\u9019\u908a\u7684ClusterIP\u525b\u597d\u8ddf ",(0,a.kt)("inlineCode",{parentName:"p"},"Type")," \u7684ClusterIP \u540d\u7a31\u4e00\u6a23\uff0c\u4f46\u662f\u9019\u908a\u8981\u8868\u793a\u7684\u771f\u7684\u662f\u500b",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"vortex-dev:05:36:40 [~/go/src/github.com/hwchiu/kubeDemo](master)vagrant\n$kubectl get svc\nNAME                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE\nk8s-nginx-cluster   ClusterIP   10.98.51.150   <none>        80/TCP         1d\nk8s-nginx-node      NodePort    10.99.157.45   <none>        80:32293/TCP   1d\n")),(0,a.kt)("p",null,"\u5728\u6b64\u7bc4\u4f8b\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u8ad6\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"ClusterIP")," \u6216\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"NodePort")," \u5be6\u969b\u4e0a\u90fd\u6703\u6709\u4e00\u7d44 ",(0,a.kt)("inlineCode",{parentName:"p"},"Cluster-IP")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740\u3002"),(0,a.kt)("p",null,"\u9019\u500b",(0,a.kt)("inlineCode",{parentName:"p"},"Cluster-IP"),"\u6700\u5927\u7684\u7279\u6027\u5c31\u662f\u4ed6\u662f\u4e00\u500b\u865b\u64ec\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\uff0c\u5728\u6574\u500b",(0,a.kt)("inlineCode",{parentName:"p"},"kubernetes"),"\u53e2\u96c6\u5167\u662f\u627e\u4e0d\u5230\u4efb\u4f55\u4e00\u5f35\u7db2\u5361\u64c1\u6709\u9019\u500b",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\u7684\u3002"),(0,a.kt)("p",null,"\u6240\u6709\u91dd\u5c0d\u8a72",(0,a.kt)("inlineCode",{parentName:"p"},"Cluster-IP"),"\u767c\u9001\u7684\u5c01\u5305\uff0c\u5728\u6eff\u8db3\u7279\u5b9a\u7684\u689d\u4ef6\u4e0b\uff0c\u90fd\u6703\u88ab\u900f\u904e",(0,a.kt)("inlineCode",{parentName:"p"},"DNAT(Destination Network Address Translation)")," \u9032\u884c\u8f49\u63db\uff0c\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"service"),"  \u5176\u5be6\u5c31\u6703\u662f\u88ab\u8f49\u63db\u5230\u5176\u4e2d\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"EndPoints")," \u7684\u771f\u6b63 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'vortex-dev:05:43:50 [~/go/src/github.com/hwchiu/kubeDemo](master)vagrant\n$sudo iptables-save -t nat | grep nginx-cluster | grep DNAT\n-A KUBE-SEP-7MBJVYFMXTKOJUKD -p tcp -m comment --comment "default/k8s-nginx-cluster:" -m tcp -j DNAT --to-destination 10.244.0.88:80\n-A KUBE-SEP-ARZAHNE3T3EMMTGB -p tcp -m comment --comment "default/k8s-nginx-cluster:" -m tcp -j DNAT --to-destination 10.244.0.90:80\n-A KUBE-SEP-O3CWA7STMVCKFPRY -p tcp -m comment --comment "default/k8s-nginx-cluster:" -m tcp -j DNAT --to-destination 10.244.0.89:80\n\nvortex-dev:05:43:54 [~/go/src/github.com/hwchiu/kubeDemo](master)vagrant\n$kubectl get endpoints k8s-nginx-cluster\nNAME                ENDPOINTS                                      AGE\nk8s-nginx-cluster   10.244.0.88:80,10.244.0.89:80,10.244.0.90:80   1d\n')),(0,a.kt)("p",null,"\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684\u89c0\u5bdf\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u5728\u67d0\u4e9b ",(0,a.kt)("inlineCode",{parentName:"p"},"custom chain")," \u4e2d\u6703\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"DNAT")," \u7684\u65b9\u5f0f\u628a\u5c01\u5305\u7684\u76ee\u6a19",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u4f4d\u5740\u8f49\u63db\u5230\u9019\u4e9b",(0,a.kt)("inlineCode",{parentName:"p"},"endpoints")," \u64c1\u6709\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\u3002\n\u5be6\u969b\u4e0a\u9019\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"custom chain")," \u5c31\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"KUBE-SEP-XXXX"),", \u6bcf\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"Endpoints")," \u90fd\u6709\u4e00\u689d\u5c6c\u65bc\u81ea\u5df1\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"custom chain"),". \u800c ",(0,a.kt)("inlineCode",{parentName:"p"},"KUBE-SEP")," \u6211\u60f3\u5176\u542b\u610f\u61c9\u8a72\u5c31\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"KUBE Service Endpoint")," \u5427\u3002"),(0,a.kt)("p",null,"\u525b\u525b\u6211\u5011\u5c0d",(0,a.kt)("inlineCode",{parentName:"p"},"iptables"),"\u898f\u5247\u7684\u7406\u89e3\uff0c\u6bcf\u500b\u898f\u5247\u90fd\u662f",(0,a.kt)("inlineCode",{parentName:"p"},"\u7b26\u5408\u689d\u4ef6"),",",(0,a.kt)("inlineCode",{parentName:"p"},"\u505a\u4e00\u4ef6\u4e8b\u60c5"),"\uff0c\u56e0\u6b64\u80cc\u5f8c\u6709\u591a\u5c11\u500b",(0,a.kt)("inlineCode",{parentName:"p"},"endpoints"),",\u5be6\u969b\u4e0a\u5c31\u6703\u6709\u591a\u5c11\u689d\u898f\u5247\u5728\u8655\u7406",(0,a.kt)("inlineCode",{parentName:"p"},"DNAT"),"\u3002"),(0,a.kt)("p",null,"\u5230\u9019\u908a\u6211\u5011\u9084\u6709\u4e00\u4e9b\u7591\u554f\u9084\u6c92\u6709\u89e3\u958b\uff0c\u53ea\u8981\u5148\u8a18\u4f4f\u4e0b\u9762\u7684\u7d50\u8ad6\u5c31\u597d\u3002"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u6bcf\u500b",(0,a.kt)("inlineCode",{parentName:"li"},"service"),"\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"FQDN"),"\u90fd\u6703\u5c0d\u61c9\u5230\u4e00\u7d44",(0,a.kt)("inlineCode",{parentName:"li"},"Cluster-IP")," ",(0,a.kt)("inlineCode",{parentName:"li"},"IP")," \u5730\u5740\uff0c\u8a72\u5730\u5740\u5176\u5be6\u662f\u865b\u64ec",(0,a.kt)("inlineCode",{parentName:"li"},"IP"),"\u5730\u5740\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u9001\u5f80\u8a72",(0,a.kt)("inlineCode",{parentName:"li"},"Cluster-IP")," \u7684\u5c01\u5305\u5728\u6eff\u8db3\u7279\u5b9a\u7684\u60c5\u6cc1\u4e0b\uff0c\u6703\u900f\u904e",(0,a.kt)("inlineCode",{parentName:"li"},"DNAT"),"\u7684\u65b9\u5f0f\u8f49\u63db\u6210\u5176\u4e2d\u4e00\u500b",(0,a.kt)("inlineCode",{parentName:"li"},"endpoints"),"\u5bb9\u5668\u4e0a\u7684\u771f\u5be6",(0,a.kt)("inlineCode",{parentName:"li"},"IP"),"\u5730\u5740")),(0,a.kt)("h2",{id:"cluster-only"},"Cluster Only"),(0,a.kt)("p",null,"\u73fe\u5728\u6211\u5011\u8981\u4f86\u8a0e\u8ad6\u4e00\u4e0b\uff0c\u5230\u5e95\u6240\u8b02\u7684\u53ea\u6709",(0,a.kt)("inlineCode",{parentName:"p"},"\u53e2\u96c6\u5167"),"\u7684\u61c9\u7528\u7a0b\u5f0f/\u7bc0\u9ede\u624d\u53ef\u4ee5\u5b58\u53d6",(0,a.kt)("inlineCode",{parentName:"p"},"clusterIP"),"\u9019\u5230\u5e95\u662f\u600e\u9ebc\u904b\u4f5c\u7684\u3002"),(0,a.kt)("p",null,"\u6211\u5011\u8907\u7fd2\u4e00\u4e0b\u524d\u9762\u7684\u67d0\u500b\u6558\u8ff0\n\u9001\u5f80\u8a72",(0,a.kt)("inlineCode",{parentName:"p"},"Cluster-IP")," \u7684\u5c01\u5305\u5728\u6eff\u8db3\u7279\u5b9a\u7684\u60c5\u6cc1\u4e0b\uff0c\u6703\u900f\u904e",(0,a.kt)("inlineCode",{parentName:"p"},"DNAT"),"\u7684\u65b9\u5f0f\u8f49\u63db\u6210\u5176\u4e2d\u4e00\u500b",(0,a.kt)("inlineCode",{parentName:"p"},"endpoints"),"\u5bb9\u5668\u4e0a\u7684\u771f\u5be6",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740"),(0,a.kt)("p",null,"\u9019\u908a\u63d0\u5230\u8981\u6eff\u8db3\u7279\u5b9a\u7684\u60c5\u6cc1\u624d\u6703\u8d70\u5230",(0,a.kt)("inlineCode",{parentName:"p"},"DNAT"),"\u8f49\u5230\u5c0d\u61c9\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"EndPoints"),"\u3002\n\u6240\u4ee5\n",(0,a.kt)("strong",{parentName:"p"},"\u53ea\u6709",(0,a.kt)("inlineCode",{parentName:"strong"},"\u53e2\u96c6\u5167"),"\u7684\u61c9\u7528\u7a0b\u5f0f/\u7bc0\u9ede\u624d\u53ef\u4ee5\u5b58\u53d6")," \u5176\u5be6\u5c31\u662f ",(0,a.kt)("strong",{parentName:"p"},"\u7279\u5b9a\u7684\u60c5\u6cc1")),(0,a.kt)("p",null,"\u6211\u5011\u90fd\u77e5\u9053 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684\u898f\u5247\u53ef\u4ee5\u6839\u64da\u5c01\u5305\u7684\u4e00\u4e9b\u8cc7\u8a0a\u4f86\u505a\u6bd4\u5c0d\uff0c\u6240\u4ee5\u6211\u5011\u80fd\u4e0d\u80fd\u505a\u51fa\u4e00\u7a2e\u898f\u5247\u662f\n\u53ea\u6709 ",(0,a.kt)("strong",{parentName:"p"},"\u5c01\u5305\u7684\u4f86\u6e90",(0,a.kt)("inlineCode",{parentName:"strong"},"IP"),"\u5730\u5740\u662f\u4f86\u81ea",(0,a.kt)("inlineCode",{parentName:"strong"},"\u53e2\u96c6\u5167\u7684\u61c9\u7528\u7a0b\u5f0f/\u7bc0\u9ede")),"\uff0c\u7b26\u5408\u9019\u7a2e\u898f\u5247\u7684\u624d\u6709\u8cc7\u683c\u53bb\u9032\u884c ",(0,a.kt)("inlineCode",{parentName:"p"},"DNAT")," \u9032\u884c\u8f49\u767c"),(0,a.kt)("p",null,"\u5be6\u969b\u4e0a\u4f7f\u7528\u7684\u6982\u5ff5\u662f\u66f4\u7c21\u55ae\uff0c\u9019\u908a\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables build-in chain")," \u88e1\u9762\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"OUTPUT/PREROUTING")," \u5169\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"chain")," \u4f86\u9054\u6210\n",(0,a.kt)("strong",{parentName:"p"},"\u53ea\u6709",(0,a.kt)("inlineCode",{parentName:"strong"},"\u53e2\u96c6\u5167"),"\u7684\u61c9\u7528\u7a0b\u5f0f/\u7bc0\u9ede"),"\n\u9019\u500b\u529f\u80fd"),(0,a.kt)("p",null,"\u9019\u908a\u6211\u76f4\u63a5\u8b1b\u660e"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"OUTPUT: \u672c\u5730\u7bc0\u9ede\u9001\u51fa\u53bb\u7684\u5c01\u5305\u90fd\u6703\u5148\u8d70\u5230\u9019\u908a"),(0,a.kt)("li",{parentName:"ul"},"PREROUTING: \u672c\u5730\u7db2\u5361\u6536\u5230\u5c01\u5305\u5f8c\u6703\u8d70\u5230\u9019\u908a\uff0c\u5305\u542b\u4e86",(0,a.kt)("inlineCode",{parentName:"li"},"Contaienr"),"\u51fa\u4f86\u7684\u5c01\u5305\u90fd\u6703\u8d70\u5230")),(0,a.kt)("p",null,"\u63a5\u4e0b\u6211\u5011\u4f86\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684\u6307\u4ee4\u4f86\u89c0\u5bdf\u4e00\u4e0b\u9019\u4e9b\u898f\u5247\u3002"),(0,a.kt)("p",null,"\u6839\u64da\u524d\u9762\u7684\u67e5\u8a62\uff0c\u6211\u5011\u77e5\u9053 ",(0,a.kt)("inlineCode",{parentName:"p"},"ClusterIP")," \u5730\u5740\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"10.98.51.150"),","),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'vortex-dev:04:24:49 [~/go/src/github.com/hwchiu/kubeDemo](master)vagrant\n$sudo iptables-save | grep k8s-nginx-cluster\n....\n-A KUBE-SERVICES -d 10.98.51.150/32 -p tcp -m comment --comment "default/k8s-nginx-cluster: cluster IP" -m tcp --dport 80 -j KUBE-SVC-3FL7SSXCKTCXAYCR\n....\n')),(0,a.kt)("p",null,"\u4e0a\u8ff0\u7684\u898f\u5247\u6211\u5011\u4f86\u4ed4\u7d30\u770b\u4e00\u4e0b\u6bcf\u500b\u53c3\u6578\u7684\u610f\u7fa9"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"-A ",(0,a.kt)("inlineCode",{parentName:"li"},"KUBE-SERVICES"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u9019\u662f\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"Custom Chain"),", \u6240\u6709\u8ddf ",(0,a.kt)("inlineCode",{parentName:"li"},"Kubernetes Service")," \u6709\u95dc\u7684\u7b2c\u4e00\u5230\u9632\u7dda\u898f\u5247\u90fd\u5728\u9019\u908a"))),(0,a.kt)("li",{parentName:"ul"},"-d 10.98.51.150/32",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u76ee\u6a19\u4f4d\u7f6e\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"ClusterIP")," \u7684\u8a71"))),(0,a.kt)("li",{parentName:"ul"},"-p tcp",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u76ee\u6a19\u662f TCP \u5354\u5b9a"))),(0,a.kt)("li",{parentName:"ul"},"-m comment",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u5c31\u662f\u8a3b\u89e3"))),(0,a.kt)("li",{parentName:"ul"},"-m tcp --dport 80",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u4f7f\u7528\u5916\u639b\u6a21\u7d44\u4f86\u89e3\u6790TCP\u88e1\u9762\u7684\u8cc7\u8a0a\uff0c\u5e0c\u671b TCP port \u662f80"))),(0,a.kt)("li",{parentName:"ul"},"-j KUBE-SVC-3FL7SSXCKTCXAYCR",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u4e0a\u8ff0\u6240\u6709\u689d\u4ef6\u90fd\u7b26\u5408\uff0c\u5c31\u6703\u8df3\u5165\u53e6\u5916\u4e00\u500b",(0,a.kt)("inlineCode",{parentName:"li"},"custom chain"),"\u4f86\u57f7\u884c\u5f8c\u7e8c\u4efb\u52d9")))),(0,a.kt)("p",null,"\u5f8c\u9762\u7684\u90e8\u4efd\u6211\u5011\u5148\u4e0d\u7ba1\u4ed6\uff0c\u6211\u5011\u4f86\u770b\u4e00\u4e0b\u4ec0\u9ebc\u60c5\u6cc1\u4e0b\u7684\u5c01\u5305\u6703\u9032\u5165\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"KUBE-SERVICES")," \u9019\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"custom chain"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'$sudo iptables-save -c | grep KUBE-SERVICES\n:KUBE-SERVICES - [0:0]\n[2376:171145] -A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES\n[3706:223392] -A OUTPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES\n...\n')),(0,a.kt)("p",null,"\u9019\u908a\u53ef\u4ee5\u770b\u5230\u6709\u5169\u689d\u898f\u5247\uff0c\u5206\u5225\u5c0d\u61c9\u5230\u539f\u751f\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"OUTPUT")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"PREROUTING"),"\uff0c\u76f4\u63a5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"-j")," \u76f4\u63a5\u8df3\u5165\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"KUBE-SERVICES")," \u4f86\u9032\u884c\u5f8c\u7e8c\u8655\u7406\u3002"),(0,a.kt)("p",null,"\u5176\u5be6\u5920\u719f\u6089 iptables \u7684\u670b\u53cb\u61c9\u8a72\u5df2\u7d93\u53ef\u4ee5\u731c\u5230\uff0c\u5728\u6b64\u898f\u5247\u72c0\u6cc1\u4e0b\uff0c\u6211\u53ea\u8981\u6709\u8fa6\u6cd5\u8b93\u6d41\u5411",(0,a.kt)("inlineCode",{parentName:"p"},"ClusterIP"),"\u7684\u5c01\u5305\u900f\u904e\u4e00\u4e9b\u7db2\u8def\u898f\u5247\u7684\u65b9\u5f0f\u6d41\u5411\u5230\u53e2\u96c6\u5167\u7684\u7bc0\u9ede\uff0c\u4f9d\u7136\u53ef\u4ee5\u9806\u5229\u7684\u5b58\u53d6\u80cc\u5f8c\u7684\u670d\u52d9\u3002\n\u53ea\u662f\u56e0\u70ba\u9019\u4e9b",(0,a.kt)("inlineCode",{parentName:"p"},"ClusterIP"),"\u672c\u8eab\u4e0d\u5b58\u5728\u7db2\u8def\u4e4b\u4e2d\uff0c\u6240\u4ee5\u9700\u8981\u91dd\u5c0d\u6574\u500b\u7db2\u8def\u7684\u8def\u7531\u8868\u898f\u5247\u984d\u5916\u8a2d\u5b9a\n\u9019\u90e8\u4efd\u5c31\u662f\u984d\u5916\u6709\u8208\u8da3\u7684\u4eba\u53ef\u4ee5\u81ea\u5df1\u7814\u7a76\uff0c\u9019\u908a\u5c31\u4e0d\u518d\u591a\u6558\u8ff0\u3002"),(0,a.kt)("p",null,"\u6211\u5011\u5148\u7528\u4e0b\u5716\u4f86\u5e6b\u52a9\u76ee\u524d\u7684\u6982\u5ff5\u505a\u4e00\u500b\u6574\u7406"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u6a58\u8272\u5e95\u7684\u4ee3\u8868\u662f\u5c01\u5305\u7684\u4f86\u6e90\uff0c\u5728\u6b64\u6848\u4f8b\u4e2d\u5176\u5be6\u5c31\u4ee3\u8868",(0,a.kt)("inlineCode",{parentName:"li"},"\u53e2\u96c6\u5167\u7684\u7bc0\u9ede/\u61c9\u7528\u7a0b\u5f0f")),(0,a.kt)("li",{parentName:"ul"},"\u7da0\u8272\u5e95\u4ee3\u8868\u7684\u662f",(0,a.kt)("inlineCode",{parentName:"li"},"iptables build-in chain"),"\uff0c\u4e3b\u8981\u7528\u4f86\u8655\u7406\u53e2\u96c6\u5167\u61c9\u7528\u7a0b\u5f0f/\u7bc0\u9ede\u4e0a\u7684\u5c01\u5305\u50b3\u8f38"),(0,a.kt)("li",{parentName:"ul"},"\u85cd\u8272\u7684\u5247\u662f",(0,a.kt)("inlineCode",{parentName:"li"},"kubernetes")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"custom chain"),"."),(0,a.kt)("li",{parentName:"ul"},"\u7d2b\u8272\u7684\u5247\u662f\u4ee3\u8868 ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u7684\u63cf\u8ff0\u898f\u5247"),(0,a.kt)("li",{parentName:"ul"},"\u7d05\u8272\u5247\u662f\u6211\u5011\u77e5\u9053\u6700\u5f8c\u6703\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"KUBE-SEP-XXX")," \u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"DNAT")," \u628a\u5c01\u5305\u8f49\u63db\u5230\u5176\u4e2d\u4e00\u500b",(0,a.kt)("inlineCode",{parentName:"li"},"endpoints"),"\u4e4b\u4e2d\u3002"),(0,a.kt)("li",{parentName:"ul"},"???\u5247\u662f\u4ee3\u8868\u6211\u5011\u9084\u6c92\u6709\u7814\u7a76\u5230\u7684\uff0c\u53ea\u77e5\u9053\u9019\u4e2d\u9593\u9084\u6709\u4e00\u90e8\u5206\u7684\u8b0e\u5718\u7b49\u5f85\u89e3\u958b")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/74jQEiM.png",alt:"Imgur"})),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u6bcf\u500b",(0,a.kt)("inlineCode",{parentName:"li"},"service"),"\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"FQDN"),"\u90fd\u6703\u5c0d\u61c9\u5230\u4e00\u7d44",(0,a.kt)("inlineCode",{parentName:"li"},"ClusterIP")," ",(0,a.kt)("inlineCode",{parentName:"li"},"IP")," \u5730\u5740\uff0c\u8a72\u5730\u5740\u5176\u5be6\u662f\u865b\u64ec",(0,a.kt)("inlineCode",{parentName:"li"},"IP"),"\u5730\u5740\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"iptablse")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"OUTPUT/PREROUTING"),"\uff0c\u5176\u6709\u80fd\u529b\u53bb\u5339\u914d\u6240\u6709\u53e2\u96c6\u5167\u7684\u61c9\u7528\u7a0b\u5f0f/\u7bc0\u9ede\u6240\u9001\u51fa\u7684\u5c01\u5305"),(0,a.kt)("li",{parentName:"ol"},"\u6700\u5f8c\u900f\u904e\u53bb\u6bd4\u5c0d\u5c01\u5305\u7684\u76ee\u7684\u5730\u4f4d\u5740\u662f\u5426\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"ClusterIP")," \u4f86\u6c7a\u5b9a\u8981\u4e0d\u8981\u5f80\u4e0b\u8df3\u5230\u5176\u4ed6",(0,a.kt)("inlineCode",{parentName:"li"},"custom chain")," \u53bb\u8655\u7406\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u5c01\u5305\u6700\u5f8c\u6703\u900f\u904e",(0,a.kt)("inlineCode",{parentName:"li"},"DNAT"),"\u7684\u65b9\u5f0f\u8f49\u63db\u6210\u5176\u4e2d\u4e00\u500b",(0,a.kt)("inlineCode",{parentName:"li"},"endpoints"),"\u5bb9\u5668\u4e0a\u7684\u771f\u5be6",(0,a.kt)("inlineCode",{parentName:"li"},"IP"),"\u5730\u5740")),(0,a.kt)("h2",{id:"loab-balancing"},"Loab Balancing"),(0,a.kt)("p",null,"\u73fe\u5728\u6211\u5011\u8981\u4f86\u770b\u770b\u6700\u5f8c\u4e00\u500b\u90e8\u5206\u4e86\uff0c\u5230\u5e95\u8981\u600e\u9ebc\u5f9e\u773e\u591a\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Endpoints")," \u4e2d\u6311\u9078\u51fa\u4e00\u500b\u53ef\u7528\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Pod")," \u4f86\u4f7f\u7528\u3002"),(0,a.kt)("p",null,"\u6839\u64da\u524d\u9762\u7684\u5206\u6790\uff0c\u7576\u6211\u5011\u7684\u5c01\u5305\u7b26\u5408\u53e2\u96c6\u5167\u4f7f\u7528\u7684\u898f\u5247\u5f8c\uff0c\u6703\u8df3\u5230\u4e00\u500b",(0,a.kt)("inlineCode",{parentName:"p"},"KUBE-SVC-3FL7SSXCKTCXAYCR")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"custom chain"),".\n\u5be6\u969b\u4e0a ",(0,a.kt)("inlineCode",{parentName:"p"},"KUBE-SVC-XXXX")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"custom chain")," \u5c31\u662f\u7528\u4f86\u8655\u7406\u6311\u9078 ",(0,a.kt)("inlineCode",{parentName:"p"},"Endpoints")," \u7528\u7684\uff0c\u6703\u6839\u64da\u6bcf\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"kubernetes service")," \u5275\u9020\u4e00\u689d\u5c6c\u65bc\u5176\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"chain"),"."),(0,a.kt)("p",null,"\u6211\u5011\u5148\u91cd\u65b0\u8a8d\u771f\u770b\u4e00\u4e0b\u9019\u689d\u898f\u5247"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'-A KUBE-SERVICES -d 10.98.51.150/32 -p tcp -m comment --comment "default/k8s-nginx-cluster: cluster IP" -m tcp --dport 80 -j KUBE-SVC-3FL7SSXCKTCXAYCR\n')),(0,a.kt)("p",null,"\u7576\u5c01\u5305\u6eff\u8db3\u53e2\u96c6\u5167\u7684\u689d\u4ef6\u6642\uff0c\u5c31\u6703\u8df3\u5230\u4e00\u500b\u540d\u70ba",(0,a.kt)("inlineCode",{parentName:"p"},"KUBE-SVC-3FL7SSXCKTCXAYCR"),"\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"custom chain"),"."),(0,a.kt)("p",null,"\u9019\u6642\u5019\u4f86\u4ed4\u7d30\u6aa2\u8996\u5176\u5167\u5bb9"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},'-A KUBE-SVC-3FL7SSXCKTCXAYCR -m comment --comment "default/k8s-nginx-cluster:" -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-POVAFWTN5ECIRK7J\n-A KUBE-SVC-3FL7SSXCKTCXAYCR -m comment --comment "default/k8s-nginx-cluster:" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-AQWRPA7WRPWQAWLR\n-A KUBE-SVC-3FL7SSXCKTCXAYCR -m comment --comment "default/k8s-nginx-cluster:" -j KUBE-SEP-XPSDT7KEI65EZ2WI\n')),(0,a.kt)("p",null,"\u6211\u5011\u53ef\u4ee5\u89c0\u5bdf\u5230\u88e1\u9762\u6709\u5e7e\u500b\u91cd\u9ede"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u6709 ",(0,a.kt)("inlineCode",{parentName:"li"},"-m statistic"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"random"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"probability")," \u9019\u4e9b\u8ddf\u6a5f\u7387\u76f8\u95dc\u7684\u6587\u5b57\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u6eff\u8db3\u7279\u5b9a\u689d\u4ef6\u5f8c\uff0c\u90fd\u6703\u8df3\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"KUBE-SEP-XXXXX")," \u9019\u4e9b ",(0,a.kt)("inlineCode",{parentName:"li"},"custom chain"),". \u9019\u5c31\u5982\u540c\u6211\u5011\u4e4b\u524d\u6240\u89c0\u5bdf\u5230\u6703\u57f7\u884c ",(0,a.kt)("inlineCode",{parentName:"li"},"DNAT")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"custom chain")," \u4e86")),(0,a.kt)("p",null,"\u63a5\u4e0b\u4f86\u8aaa\u660e\u4e00\u4e0b\u5230\u5e95\u90a3\u7fa4\u8ddf\u6a5f\u7387\u6709\u95dc\u7684\u898f\u5247\u662f\u600e\u9ebc\u904b\u4f5c\u7684\u3002\n\u6211\u5011\u5148\u524d\u5df2\u7d93\u8aaa\u660e\u904e\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"iptables"),"\u7684\u904b\u4f5c\u65b9\u5f0f\u662f",(0,a.kt)("strong",{parentName:"p"},"\u7b26\u5408\u689d\u4ef6"),", ",(0,a.kt)("strong",{parentName:"p"},"\u5c31\u505a\u4e00\u4ef6\u4e8b\u60c5"),"\n\u6240\u4ee5\u4e26\u6c92\u6709\u5f88\u7c21\u55ae\u7684\u5728\u4e00\u689d\u898f\u5247\u5167\uff0c\u5e6b\u4f60\u9078\u51fa\u5c0d\u61c9\u7684",(0,a.kt)("strong",{parentName:"p"},"Endpoints"),".\n\u65bc\u662f\u9019\u908a\u7684\u4f5c\u6cd5\u662f\uff0c\u5047\u8a2d\u6211\u6709\u4e09\u500b ",(0,a.kt)("strong",{parentName:"p"},"Endpoint"),"\uff0c\u6311\u9078\u7684\u6d41\u7a0b\u5982\u4e0b"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u8acb\u554f\u6a5f\u7387\u5927\u795e\uff0c\u7d66\u6211\u4e00\u500b\u6578\u5b57",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u82e5\u8a72\u6578\u5b57<0.33, \u5247\u4f7f\u7528\u7b2c\u4e00\u500b",(0,a.kt)("strong",{parentName:"li"},"endpoints")),(0,a.kt)("li",{parentName:"ul"},"\u5426\u5247\u91cd\u65b0\u554f\u6a5f\u7387\u5927\u795e\uff0c\u5f9e\u5269\u4e0b\u7684 ",(0,a.kt)("strong",{parentName:"li"},"endpoints")," \u6311\u9078"))),(0,a.kt)("li",{parentName:"ol"},"\u8acb\u554f\u6a5f\u7387\u5927\u795e\uff0c\u518d\u6b21\u7d66\u6211\u4e00\u500b\u6578\u5b57",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u82e5\u8a72\u6578\u5b57<0.5, \u5247\u4f7f\u7528\u7b2c\u4e8c\u500b ",(0,a.kt)("strong",{parentName:"li"},"endpoints")),(0,a.kt)("li",{parentName:"ul"},"\u5426\u5247\u76f4\u63a5\u4f7f\u7528\u5730\u4e09\u500b ",(0,a.kt)("strong",{parentName:"li"},"endpoints"),".")))),(0,a.kt)("p",null,"\u7528\u4e0b\u5716\u7684\u65b9\u5f0f\u4f86\u91cd\u65b0\u89e3\u91cb\u9019\u500b\u6d41\u7a0b\uff0c\u5047\u8a2d\u4eca\u5929\u6709\u56db\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"Endpoints")," \u8981\u9078\u64c7\n",(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/tpSFwKg.png",alt:"Imgur"})),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u4e00\u958b\u59cb\u8981\u5f9e\u56db\u500b\u88e1\u9762\u9078\u64c7\uff0c\u6240\u4ee5\u6a5f\u7387\u53ea\u6709 ",(0,a.kt)("strong",{parentName:"li"},"1/4"),", \u82e5\u7b26\u5408\u4e86\u5c31\u63a1\u7528\u7b2c\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"Endpoint")),(0,a.kt)("li",{parentName:"ol"},"\u56e0\u70ba\u524d\u9762\u6c92\u6709\u7b26\u5408\uff0c\u6240\u4ee5\u63a5\u4e0b\u4f86\u8981\u5f9e\u4e09\u500b\u88e1\u9762\u7e7c\u7e8c\u9078\u64c7\u4e0b\u4e00\u500b ",(0,a.kt)("strong",{parentName:"li"},"endpoints"),"\uff0c\u9019\u6642\u5019\u7684\u6a5f\u7387\u5c31\u662f",(0,a.kt)("strong",{parentName:"li"},"1/3"),",\u4f46\u662f\u56e0\u70ba\u8981\u8d70\u5230\u9019\u6b65\u5fc5\u9808(1)\u6c92\u6709\u6210\u529f\uff0c\u6240\u4ee5\u6a5f\u7387\u662f(3/4*1/3), \u5c31\u662f ",(0,a.kt)("strong",{parentName:"li"},"1/4")),(0,a.kt)("li",{parentName:"ol"},"\u4e00\u6b64\u985e\u63a8\uff0c\u6bcf\u500b ",(0,a.kt)("strong",{parentName:"li"},"Endpoints")," \u7684\u6a5f\u7387\u90fd\u662f ",(0,a.kt)("strong",{parentName:"li"},"1/4")),(0,a.kt)("li",{parentName:"ol"},"\u904b\u6c23\u6700\u4e0d\u597d\u7684 ",(0,a.kt)("strong",{parentName:"li"},"endpoints")," \u5fc5\u9808\u8981\u9032\u884c ",(0,a.kt)("strong",{parentName:"li"},"n-1")," \u6b21\u7684\u898f\u5247\u6bd4\u5c0d (n\u662fendpoints\u7684\u6578\u91cf)"),(0,a.kt)("li",{parentName:"ol"},"\u904b\u6c23\u6700\u597d\u7684\u53ea\u9700\u8981\u4e00\u6b21\u6bd4\u5c0d\u5c31\u53ef\u4ee5\u627e\u5230\u3002")),(0,a.kt)("p",null,"\u7576\u627e\u5230\u8981\u4f7f\u7528\u7684 ",(0,a.kt)("strong",{parentName:"p"},"Endpoints")," \u7684\u6642\u5019\uff0c\u5c31\u6703\u8df3\u5230\u5c0d\u61c9\u7684 ",(0,a.kt)("strong",{parentName:"p"},"KUBE-SEP-XXXX")," \u53bb\u9032\u884c ",(0,a.kt)("strong",{parentName:"p"},"DNAT")," \u7684\u8f49\u63db\u3002"),(0,a.kt)("h1",{id:"summary"},"Summary"),(0,a.kt)("p",null,"\u6700\u5f8c\u4e00\u584a\u62fc\u5716\u4e5f\u5df2\u7d93\u5b8c\u6210\u4e86\uff0c\u5230\u9019\u908a\u5df2\u7d93\u53ef\u4ee5\u5927\u6982\u77e5\u9053\u662f\u5982\u4f55\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u4f86\u5b8c\u6210 ",(0,a.kt)("inlineCode",{parentName:"p"},"clusterIP")," \u7684\u8f49\u767c\u3002\n\u5728\u9019\u7a2e\u5be6\u4f5c\u67b6\u69cb\u4e2d\uff0c\u6bcf\u500b\u7bc0\u9ede\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u90fd\u6703\u81ea\u884c\u53bb\u8ca0\u8cac\u5c0b\u627e ",(0,a.kt)("inlineCode",{parentName:"p"},"endpoints")," \u4f86\u8655\u7406\uff0c\u800c",(0,a.kt)("inlineCode",{parentName:"p"},"ClusterIP")," \u9019\u500b\u4e0d\u5b58\u5728\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\u53ea\u662f\u5e6b\u52a9\u6211\u5011\u8b93",(0,a.kt)("inlineCode",{parentName:"p"},"iptables"),"\u6709\u500b\u597d\u4f9d\u64da\u4f86\u8655\u7406\u3002"),(0,a.kt)("p",null,"\u5c31\u7528\u4e0b\u5716\u4f86\u5e6b\u9019\u7bc7\u6587\u7ae0\u505a\u500b\u6700\u5f8c\u7684\u7d50\u5c3e\u3002\n\u4e0b\u7bc7\u6587\u7ae0\u5728\u4f86\u4ed4\u7d30\u770b\u770b ",(0,a.kt)("inlineCode",{parentName:"p"},"NodePort")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"SessionAffinity")," \u9019\u4e9b\u529f\u80fd\u5982\u4f55\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u4f86\u5be6\u73fe\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/xoPvipq.png",alt:"Imgur"})))}u.isMDXComponent=!0}}]);