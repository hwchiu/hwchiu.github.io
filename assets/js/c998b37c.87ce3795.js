"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[82547],{3905:(e,t,l)=>{l.d(t,{Zo:()=>c,kt:()=>T});var n=l(67294);function a(e,t,l){return t in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}function i(e,t){var l=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),l.push.apply(l,n)}return l}function p(e){for(var t=1;t<arguments.length;t++){var l=null!=arguments[t]?arguments[t]:{};t%2?i(Object(l),!0).forEach((function(t){a(e,t,l[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(l)):i(Object(l)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(l,t))}))}return e}function r(e,t){if(null==e)return{};var l,n,a=function(e,t){if(null==e)return{};var l,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)l=i[n],t.indexOf(l)>=0||(a[l]=e[l]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)l=i[n],t.indexOf(l)>=0||Object.prototype.propertyIsEnumerable.call(e,l)&&(a[l]=e[l])}return a}var o=n.createContext({}),b=function(e){var t=n.useContext(o),l=t;return e&&(l="function"==typeof e?e(t):p(p({},t),e)),l},c=function(e){var t=b(e.components);return n.createElement(o.Provider,{value:t},e.children)},d="mdxType",s={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},g=n.forwardRef((function(e,t){var l=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,c=r(e,["components","mdxType","originalType","parentName"]),d=b(l),g=a,T=d["".concat(o,".").concat(g)]||d[g]||s[g]||i;return l?n.createElement(T,p(p({ref:t},c),{},{components:l})):n.createElement(T,p({ref:t},c))}));function T(e,t){var l=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=l.length,p=new Array(i);p[0]=g;var r={};for(var o in t)hasOwnProperty.call(t,o)&&(r[o]=t[o]);r.originalType=e,r[d]="string"==typeof e?e:a,p[1]=r;for(var b=2;b<i;b++)p[b]=l[b];return n.createElement.apply(null,p)}return n.createElement.apply(null,l)}g.displayName="MDXCreateElement"},26832:(e,t,l)=>{l.r(t),l.d(t,{assets:()=>o,contentTitle:()=>p,default:()=>s,frontMatter:()=>i,metadata:()=>r,toc:()=>b});var n=l(87462),a=(l(67294),l(3905));const i={title:"[netfilter] Dig Into Docker Bridge Network By iptables/ebtables",date:new Date("2018-09-18T10:49:21.000Z"),tags:["Network","Netfilter","Linux","Docker","iptables"],description:"\u672c\u6587\u900f\u904e\u5c0d iptables/ebtables \u4f86\u8a2d\u5b9a\u76f8\u5c0d\u61c9\u7684\u898f\u5247\uff0c\u85c9\u7531\u9019\u4e9b\u898f\u5247\u4f86\u89c0\u5bdf\u5728 Docker Bridge Network \u7684\u7db2\u8def\u8a2d\u5b9a\u4e0b\uff0c\u4e0d\u540c\u60c5\u5883\u7684\u7db2\u8def\u50b3\u905e\u5be6\u969b\u4e0a\u6703\u53d7\u5230\u54ea\u4e9b iptables/ebtables \u898f\u5247\u7684\u5f71\u97ff\u3002\u9019\u4e9b\u60c5\u5883\u5305\u542b\u4e86\u5e38\u898b\u7684\u7528\u6cd5\uff0c\u8b6c\u5982\u5bb9\u5668\u8207\u5bb9\u5668\u4e4b\u9593\u540c\u7db2\u6bb5\u7684\u50b3\u8f38\uff0c\u5bbf\u4e3b\u6a5f\u900f\u904e\u5bb9\u5668IP\u4f4d\u5740\u76f4\u63a5\u9023\u7dda\uff0c\u751a\u81f3\u662f\u5916\u90e8\u7db2\u8def\u900f\u904e docker run -p xxx.xxx \u7684\u898f\u5247\u4f86\u63a5\u89f8\u5230\u5167\u90e8\u5bb9\u5668\u3002\u9019\u4e9b\u4e0d\u540c\u60c5\u5883\u7684\u7db2\u8def\u9023\u7dda\u727d\u626f\u5230\u95dc\u65bc Layer3 \u8def\u7531\uff0cLayer2 \u6a4b\u63a5 \u7b49\u4e0d\u540c\u65b9\u5f0f\u7684\u8655\u7406\uff0c\u56e0\u6b64\u5728 iptables/ebtables \u90fd\u6703\u6709\u4e0d\u540c\u7684\u8d70\u5411\u3002\u53ea\u8981\u80fd\u5920\u66f4\u4f73\u7684\u719f\u6089 iptables/ebtables \u7684\u7528\u6cd5\u8207\u898f\u5247\uff0c\u672a\u4f86\u6709\u9700\u8981\u89aa\u81ea\u8a2d\u5b9a\u76f8\u95dc\u898f\u5247\u6642\uff0c\u90fd\u80fd\u5920\u66f4\u7cbe\u6e96\u4e14\u5b89\u5168\u7684\u53bb\u9054\u5230\u60f3\u8981\u7684\u76ee\u7684\uff0c\u6e1b\u5c11\u76f2\u76ee\u731c\u6e2c\u7684\u6642\u9593\u8207\u82b1\u8cbb\u3002"},p=void 0,r={unversionedId:"2018/netfilter-eiptables-iii",id:"2018/netfilter-eiptables-iii",title:"[netfilter] Dig Into Docker Bridge Network By iptables/ebtables",description:"\u672c\u6587\u900f\u904e\u5c0d iptables/ebtables \u4f86\u8a2d\u5b9a\u76f8\u5c0d\u61c9\u7684\u898f\u5247\uff0c\u85c9\u7531\u9019\u4e9b\u898f\u5247\u4f86\u89c0\u5bdf\u5728 Docker Bridge Network \u7684\u7db2\u8def\u8a2d\u5b9a\u4e0b\uff0c\u4e0d\u540c\u60c5\u5883\u7684\u7db2\u8def\u50b3\u905e\u5be6\u969b\u4e0a\u6703\u53d7\u5230\u54ea\u4e9b iptables/ebtables \u898f\u5247\u7684\u5f71\u97ff\u3002\u9019\u4e9b\u60c5\u5883\u5305\u542b\u4e86\u5e38\u898b\u7684\u7528\u6cd5\uff0c\u8b6c\u5982\u5bb9\u5668\u8207\u5bb9\u5668\u4e4b\u9593\u540c\u7db2\u6bb5\u7684\u50b3\u8f38\uff0c\u5bbf\u4e3b\u6a5f\u900f\u904e\u5bb9\u5668IP\u4f4d\u5740\u76f4\u63a5\u9023\u7dda\uff0c\u751a\u81f3\u662f\u5916\u90e8\u7db2\u8def\u900f\u904e docker run -p xxx.xxx \u7684\u898f\u5247\u4f86\u63a5\u89f8\u5230\u5167\u90e8\u5bb9\u5668\u3002\u9019\u4e9b\u4e0d\u540c\u60c5\u5883\u7684\u7db2\u8def\u9023\u7dda\u727d\u626f\u5230\u95dc\u65bc Layer3 \u8def\u7531\uff0cLayer2 \u6a4b\u63a5 \u7b49\u4e0d\u540c\u65b9\u5f0f\u7684\u8655\u7406\uff0c\u56e0\u6b64\u5728 iptables/ebtables \u90fd\u6703\u6709\u4e0d\u540c\u7684\u8d70\u5411\u3002\u53ea\u8981\u80fd\u5920\u66f4\u4f73\u7684\u719f\u6089 iptables/ebtables \u7684\u7528\u6cd5\u8207\u898f\u5247\uff0c\u672a\u4f86\u6709\u9700\u8981\u89aa\u81ea\u8a2d\u5b9a\u76f8\u95dc\u898f\u5247\u6642\uff0c\u90fd\u80fd\u5920\u66f4\u7cbe\u6e96\u4e14\u5b89\u5168\u7684\u53bb\u9054\u5230\u60f3\u8981\u7684\u76ee\u7684\uff0c\u6e1b\u5c11\u76f2\u76ee\u731c\u6e2c\u7684\u6642\u9593\u8207\u82b1\u8cbb\u3002",source:"@site/docs/2018/netfilter-eiptables-iii.md",sourceDirName:"2018",slug:"/2018/netfilter-eiptables-iii",permalink:"/docs/2018/netfilter-eiptables-iii",draft:!1,tags:[{label:"Network",permalink:"/docs/tags/network"},{label:"Netfilter",permalink:"/docs/tags/netfilter"},{label:"Linux",permalink:"/docs/tags/linux"},{label:"Docker",permalink:"/docs/tags/docker"},{label:"iptables",permalink:"/docs/tags/iptables"}],version:"current",frontMatter:{title:"[netfilter] Dig Into Docker Bridge Network By iptables/ebtables",date:"2018-09-18T10:49:21.000Z",tags:["Network","Netfilter","Linux","Docker","iptables"],description:"\u672c\u6587\u900f\u904e\u5c0d iptables/ebtables \u4f86\u8a2d\u5b9a\u76f8\u5c0d\u61c9\u7684\u898f\u5247\uff0c\u85c9\u7531\u9019\u4e9b\u898f\u5247\u4f86\u89c0\u5bdf\u5728 Docker Bridge Network \u7684\u7db2\u8def\u8a2d\u5b9a\u4e0b\uff0c\u4e0d\u540c\u60c5\u5883\u7684\u7db2\u8def\u50b3\u905e\u5be6\u969b\u4e0a\u6703\u53d7\u5230\u54ea\u4e9b iptables/ebtables \u898f\u5247\u7684\u5f71\u97ff\u3002\u9019\u4e9b\u60c5\u5883\u5305\u542b\u4e86\u5e38\u898b\u7684\u7528\u6cd5\uff0c\u8b6c\u5982\u5bb9\u5668\u8207\u5bb9\u5668\u4e4b\u9593\u540c\u7db2\u6bb5\u7684\u50b3\u8f38\uff0c\u5bbf\u4e3b\u6a5f\u900f\u904e\u5bb9\u5668IP\u4f4d\u5740\u76f4\u63a5\u9023\u7dda\uff0c\u751a\u81f3\u662f\u5916\u90e8\u7db2\u8def\u900f\u904e docker run -p xxx.xxx \u7684\u898f\u5247\u4f86\u63a5\u89f8\u5230\u5167\u90e8\u5bb9\u5668\u3002\u9019\u4e9b\u4e0d\u540c\u60c5\u5883\u7684\u7db2\u8def\u9023\u7dda\u727d\u626f\u5230\u95dc\u65bc Layer3 \u8def\u7531\uff0cLayer2 \u6a4b\u63a5 \u7b49\u4e0d\u540c\u65b9\u5f0f\u7684\u8655\u7406\uff0c\u56e0\u6b64\u5728 iptables/ebtables \u90fd\u6703\u6709\u4e0d\u540c\u7684\u8d70\u5411\u3002\u53ea\u8981\u80fd\u5920\u66f4\u4f73\u7684\u719f\u6089 iptables/ebtables \u7684\u7528\u6cd5\u8207\u898f\u5247\uff0c\u672a\u4f86\u6709\u9700\u8981\u89aa\u81ea\u8a2d\u5b9a\u76f8\u95dc\u898f\u5247\u6642\uff0c\u90fd\u80fd\u5920\u66f4\u7cbe\u6e96\u4e14\u5b89\u5168\u7684\u53bb\u9054\u5230\u60f3\u8981\u7684\u76ee\u7684\uff0c\u6e1b\u5c11\u76f2\u76ee\u731c\u6e2c\u7684\u6642\u9593\u8207\u82b1\u8cbb\u3002"},sidebar:"techPost",previous:{title:"[netfilter] Introduction to iptables",permalink:"/docs/2018/netfilter-eiptables-ii"},next:{title:"[\u8ad6\u6587\u5c0e\u8b80] - Towards Zero Copy Dataflows using RDMA",permalink:"/docs/2018/paper-tensorflow-with-rdma"}},o={},b=[{value:"Preface",id:"preface",level:2},{value:"Introduction",id:"introduction",level:2},{value:"Software Requirement",id:"software-requirement",level:3},{value:"Environment",id:"environment",level:3},{value:"Setup Docker Containets",id:"setup-docker-containets",level:3},{value:"Container To Container",id:"container-to-container",level:2},{value:"Setup ebtables",id:"setup-ebtables",level:3},{value:"Setup iptables",id:"setup-iptables",level:3},{value:"Test",id:"test",level:3},{value:"Localhost To Container",id:"localhost-to-container",level:2},{value:"Setup ebtables",id:"setup-ebtables-1",level:3},{value:"Setup iptables",id:"setup-iptables-1",level:3},{value:"Test",id:"test-1",level:3},{value:"Wan To Container",id:"wan-to-container",level:2},{value:"Setup ebtables",id:"setup-ebtables-2",level:3},{value:"Setup iptables",id:"setup-iptables-2",level:3},{value:"Test",id:"test-2",level:3},{value:"Summary",id:"summary",level:2}],c={toc:b},d="wrapper";function s(e){let{components:t,...l}=e;return(0,a.kt)(d,(0,n.Z)({},c,l,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"preface"},"Preface"),(0,a.kt)("p",null,"\u9019\u6b21\u60f3\u8981\u8ddf\u5927\u5bb6\u6162\u6162\u4ecb\u7d39\u7684\u5c31\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u9019\u500b\u5e38\u898b\u4e5f\u5e38\u7528\u7684\u5de5\u5177\u3002\n\u7db2\u8def\u4e0a\u5176\u5be6\u5df2\u7d93\u53ef\u4ee5\u641c\u5c0b\u5230\u975e\u5e38\u591a\u95dc\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u76f8\u95dc\u7684\u6587\u7ae0\u3002\n\u4e0d\u8ad6\u662f\u57fa\u672c\u4ecb\u7d39\uff0c\u6216\u662f\u4e00\u4e9b\u76f8\u95dc\u7528\u6cd5\uff0c\u5176\u5be6\u90fd\u6709\u6eff\u591a\u7684\u8cc7\u6e90\u53ef\u4ee5\u5b78\u7fd2\uff0c\u4e0d\u904e\u6211\u8a8d\u70ba\u9019\u4e9b\u6587\u7ae0\u90fd\u6563\u843d\u5404\u5730\uff0c\u6240\u4ee5\u60f3\u8981\u6574\u7406\u4e00\u4e0b\u9019\u4e9b\u8cc7\u8a0a\u4e26\u4e14\u7d71\u6574\u8d77\u4f86\u505a\u4e00\u500b\u4e00\u7cfb\u5217\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u6587\u7ae0\u3002"),(0,a.kt)("p",null,"\u9019\u500b\u7cfb\u5217\u6587\u7684\u5167\u5bb9\u5927\u81f4\u4e0a\u5982\u4e0b"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"iptables/ebtables \u7684\u57fa\u672c\u67b6\u69cb\u4ecb\u7d39\uff0c\u5305\u542b\u4e0b\u5217\u5404\u7a2e\u7d44\u6210\u7684\u6982\u5ff5",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Target/Chain/Table/Match"))),(0,a.kt)("li",{parentName:"ol"},"\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"docker")," \u9810\u8a2d\u7db2\u8def",(0,a.kt)("inlineCode",{parentName:"li"},"Bridge"),"\u7684\u60c5\u6cc1\u4f86\u89e3\u91cb\uff0c\u5bb9\u5668\u8207\u5916\u754c\u7db2\u8def\uff0c\u5bb9\u5668\u8207\u5bb9\u5668\u5f7c\u6b64\u4e4b\u9593\u7684\u7db2\u8def\u50b3\u8f38\uff0c\u5be6\u969b\u4e0a\u518d ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u4e2d\u5230\u5e95\u6703\u600e\u9ebc\u904b\u4f5c\uff0c\u5982\u679c\u60f3\u8981\u8655\u7406\u9019\u4e9b\u5c01\u5305\uff0c\u8a72\u600e\u9ebc\u8a2d\u5b9a\u76f8\u95dc\n\u898f\u5247\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u4ecb\u7d39\u76f8\u95dc ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u5e38\u898b\u7684\u4f7f\u7528\u554f\u984c"),(0,a.kt)("li",{parentName:"ol"},"\u6700\u5f8c\u5247\u662f\u6703\u8ddf\u5927\u5bb6\u4ecb\u7d39\uff0c\u5982\u4f55\u81ea\u5df1\u624b\u52d5\u64b0\u5beb\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u64f4\u5145\u6a21\u7d44\uff0c\u8b93\u4f60\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"iptables"),"\u64c1\u6709\u7368\u4e00\u7121\u4e8c\u7684\u529f\u80fd")),(0,a.kt)("p",null,"\u672c\u6587\u5ef6\u7e8c\u524d\u4e00\u7bc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u7684\u4ecb\u7d39\uff0c\u5c07\u4f7f\u7528\u76f8\u540c\u7684\u6982\u5ff5\u4f86\u95e1\u8ff0 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables(ipv4)")," \u7684\u6982\u5ff5\uff0c\u5305\u542b\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"Tarble/Chain/Match/Target")," \u7b49\u529f\u80fd\u3002"),(0,a.kt)("p",null,"\u76f8\u95dc\u7cfb\u5217\u6587\u7ae0"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.hwchiu.com/netfilter-eiptables-i.html"},"[netfilter] Introduction to ebtables")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.hwchiu.com/netfilter-eiptables-ii.html"},"[netfilter] Introduction to iptables"))),(0,a.kt)("h2",{id:"introduction"},"Introduction"),(0,a.kt)("p",null,"\u672c\u6587\u662f\u7d50\u5408\u524d\u8ff0\u5169\u7bc7\u7406\u8ad6\u6587\u7ae0\u5f8c\u7684\u5be6\u6230\u6587\uff0c\u8981\u900f\u904e\u5c0d ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u7684\u64cd\u4f5c\u4f86\u5be6\u969b\u89c0\u5bdf\u5c01\u5305\u65bc\u4e0d\u540c\u7684\u60c5\u5883\u4e4b\u4e2d\u50b3\u8f38\u5be6\u969b\u4e0a\u6703\u7d93\u904e\u54ea\u4e9b ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u7684\u63a7\u7ba1\u3002"),(0,a.kt)("h3",{id:"software-requirement"},"Software Requirement"),(0,a.kt)("p",null,"\u5728\u5be6\u969b\u89c0\u5bdf\u524d\uff0c\u6211\u5011\u9700\u8981\u5148\u5efa\u7acb\u597d\u4e00\u500b\u5bb9\u6613\u6e2c\u8a66\u7684\u74b0\u5883\uff0c\u6211\u81ea\u5df1\u6e2c\u8a66\u7684\u74b0\u5883\u5982\u4e0b"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Linux: 4.4.0-128-generic"),(0,a.kt)("li",{parentName:"ul"},"Ubuntu: Ubuntu 16.04.4 LTS"),(0,a.kt)("li",{parentName:"ul"},"Docker: 17.06.2-ce")),(0,a.kt)("p",null,"\u6574\u500b\u6e2c\u8a66\u7528\u7684\u6240\u6709\u7a0b\u5f0f\u4ee5\u53ca\u76f8\u95dc\u8173\u672c\u90fd\u53ef\u4ee5\u5728 ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/hwchiu/iptablesExample/tree/master/docker"},"iptables experience")," \u9019\u908a\u627e\u5230"),(0,a.kt)("h3",{id:"environment"},"Environment"),(0,a.kt)("p",null,"\u672c\u6587\u6240\u6709\u7684\u6e2c\u8a66\u60c5\u5883\u90fd\u6703\u57fa\u65bc\u4e0b\u5716\u7684\u74b0\u5883\u3002\u5de6\u908a\u662f\u4ee5\u4e0a\u5e1d\u8996\u89d2\u7684\u8996\u91ce\u4f86\u89c0\u5bdf\u6574\u500b\u6e2c\u8a66\u74b0\u5883\uff0c\u53f3\u908a\u5247\u662f\u63a1\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"User-Space/Kernel-Space")," \u6b64\u89d2\u5ea6\u4f86\u89c0\u5bdf\u6e2c\u8a66\u74b0\u5883"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/Zi8190W.png",alt:"Imgur"})),(0,a.kt)("p",null,"\u9996\u5148\u6703\u5148\u6e96\u5099\u5169\u500b Container \u5bb9\u5668\uff0c\u9019\u5169\u500b\u5bb9\u5668\u5206\u5225\u626e\u6f14 ",(0,a.kt)("inlineCode",{parentName:"p"},"Nginx Server")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"Ping Clinet")," \u7684\u89d2\u8272\u3002"),(0,a.kt)("p",null,"\u6b64\u5916\uff0c\u4e3b\u6a5f\u4e0a\u9762\u672c\u8eab\u4e5f\u8981\u64c1\u6709 ",(0,a.kt)("inlineCode",{parentName:"p"},"Ping")," \u7684\u80fd\u529b\uff0c\u82e5\u6c92\u6709\u7684\u9700\u8981\u9032\u884c\u5b89\u88dd\uff0c\u5426\u5247\u672c\u6587\u5f8c\u7e8c\u7684\u6e2c\u8a66\u6703\u6c92\u6709\u8fa6\u6cd5\u7e7c\u7e8c\u3002"),(0,a.kt)("p",null,"\u6700\u5f8c\u6211\u5011\u6703\u5617\u8a66\u9032\u884c\u4e09\u500b\u4e0d\u540c\u985e\u578b\u7684\u5c01\u5305\u50b3\u8f38\uff0c\u89c0\u5bdf\u9019\u4e9b\u5c01\u5305\u5be6\u969b\u4e0a\u6703\u53d7\u5230\u54ea\u4e9b ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u7684\u5f71\u97ff\u3002"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Container Bash \u900f\u904e ping \u6307\u4ee4\u9023\u7dda\u5230 Container Nginx"),(0,a.kt)("li",{parentName:"ul"},"\u5916\u7db2\u9023\u5230 Container \u5167\u7684 Nginx"),(0,a.kt)("li",{parentName:"ul"},"\u672c\u6a5f\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"ping")," \u9023\u5230 Container \u5167\u7684 Nginx")),(0,a.kt)("h3",{id:"setup-docker-containets"},"Setup Docker Containets"),(0,a.kt)("p",null,"\u9996\u5148\uff0c\u78ba\u8a8d\u4e3b\u6a5f\u672c\u8eab\u5df2\u7d93\u6709\u5b89\u88dd Docker \u76f8\u95dc\u7684\u670d\u52d9\uff0c\u63a5\u8005\u57f7\u884c\u4e0b\u5217\u7a0b\u5f0f\u4f86\u904b\u884c\u5169\u500b Docker \u5bb9\u5668\u65bc\u4e3b\u6a5f\u4e0a\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"#!/bin/bash\ndocker rm -f nginx\ndocker rm -f netutils\n\ndocker run -d -p 5566:80 --name nginx nginx\ndocker run -d --name netutils hwchiu/netutils\n")),(0,a.kt)("p",null,"\u540c\u6642\u70ba\u4e86\u78ba\u4fdd\u80fd\u5920\u6b63\u5e38\u904b\u4f5c\u6240\u6709\u6307\u4ee4\uff0c\u53ef\u57f7\u884c\u4e0b\u5217\u6307\u5b9a\u5c07\u76f8\u95dc\u6307\u4ee4\u5b89\u88dd\u8d77\u4f86"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"apt-get install -y ebtables iputils-ping\n")),(0,a.kt)("p",null,"\u6b64\u5916\uff0c\u70ba\u4e86\u8a73\u7d30\u7684\u89c0\u5bdf ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u5c0d\u9023\u7dda\u5c01\u5305\u7684\u50b3\u8f38\uff0c\u6211\u5011\u8981\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"Log")," \u76f8\u95dc\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Target")," \u4f86\u64cd\u4f5c\u9019\u4e9b\uff0c\u6700\u5f8c\u9019\u4e9b ",(0,a.kt)("inlineCode",{parentName:"p"},"Log")," \u7684\u8cc7\u8a0a\u90fd\u6703\u5f9e ",(0,a.kt)("inlineCode",{parentName:"p"},"Kernel")," \u6253\u5370\u51fa\u4f86\uff0c\n\u6211\u5011\u53ef\u4ee5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"Dmesg")," \u7684\u65b9\u5f0f\u53bb\u89c0\u5bdf\u9019\u4e9b\u5c01\u5305\u3002"),(0,a.kt)("p",null,"\u57fa\u672c\u4e0a\u5728 iptables \u662f\u63a1\u7528 -j LOG \u7684\u65b9\u5f0f\u4f86\u8655\u7406\uff0c\u7136\u800c\u5728 ebtables \u5247\u662f\u76f4\u63a5\u63a1\u7528 --log \u9019\u7a2e\u539f\u751f\u7684\u65b9\u5f0f\u4f86\u8655\u7406\uff0c\u5176\u96b1\u6027\u7684\u4f7f\u7528 -j CONTINUE \u53bb\u7e7c\u7e8c\u8655\u7406\u5c01\u5305\u3002"),(0,a.kt)("p",null,"\u5be6\u969b\u4e0a\u6211\u5011\u53ef\u4ee5\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"dmesg -c")," \u7684\u65b9\u5f0f\uff0c\u6bcf\u6b21\u547c\u53eb\u90fd\u53ea\u6703\u986f\u793a\u65b0\u51fa\u73fe\u7684\u90e8\u5206\uff0c\u9019\u6a23\u6703\u66f4\u5bb9\u6613\u5e6b\u52a9\u6211\u5011\u89c0\u5bdf\u5c01\u5305"),(0,a.kt)("p",null,"\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"Log")," \u7684\u6307\u4ee4\u4e2d\uff0c\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"--log-prefix")," \u7684\u65b9\u5f0f\u53bb\u5217\u5370\u66f4\u591a\u7684\u8cc7\u8a0a\uff0c\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u66f4\u597d\u89c0\u5bdf\u3002"),(0,a.kt)("p",null,"\u7bc4\u4f8b\u6307\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"iptables -t mangle -I PREROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-PREROUTE' --log-level debug\n\nebtables -t filter -I INPUT --log --log-prefix 'ctc/ebtable/filter-input' --log-level debug\n")),(0,a.kt)("h2",{id:"container-to-container"},"Container To Container"),(0,a.kt)("p",null,"\u5728\u9019\u500b\u6e2c\u8a66\u60c5\u5883\u4e2d\uff0c\u6211\u5011\u8981\u89c0\u5bdf\u5bb9\u5668\u8207\u5bb9\u5668\u4e4b\u9593\u7684\u50b3\u8f38\uff0c\u5982\u4e0b\u5716\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/pDtDXsP.png",alt:"Imgur"})),(0,a.kt)("p",null,"\u5728\u9019\u908a\u6211\u5011\u8981\u5f9e\u4e00\u500b\u5bb9\u5668\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"ping -c1")," \u53bb\u50b3\u9001\u4e00\u500b\u5c01\u5305\u5230\u53e6\u5916\u4e00\u500b\u5bb9\u5668\u3002"),(0,a.kt)("p",null,"\u7136\u5f8c\u85c9\u7531 ",(0,a.kt)("inlineCode",{parentName:"p"},"dmesg")," \u9019\u500b\u6307\u4ee4\u4f86\u89c0\u5bdf\u679c\u3002"),(0,a.kt)("p",null,"\u7531\u65bc\u6211\u81ea\u5df1\u6240\u4e0b\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u7684\u898f\u5247\u975e\u5e38\u7c21\u55ae\uff0c\u6240\u4ee5",(0,a.kt)("inlineCode",{parentName:"p"},"\u5f37\u70c8\u5efa\u8b70"),"\u7cfb\u7d71\u4e0a\u4e0d\u8981\u6709\u4efb\u4f55\u5176\u4ed6\u7684\u5bb9\u5668\u6b63\u5728\u6709\u4efb\u4f55\u7684\u7db2\u8def\u50b3\u8f38\uff0c\u5426\u5247 ",(0,a.kt)("inlineCode",{parentName:"p"},"Kernel")," \u8f38\u51fa\u6703\u8b93\u4f60\u5f88\u96e3\u7406\u89e3\u6bcf\u500b\u8a0a\u606f\u7684\u5148\u5f8c\u9806\u5e8f\u3002"),(0,a.kt)("h3",{id:"setup-ebtables"},"Setup ebtables"),(0,a.kt)("p",null,"\u6211\u7528\u4f86\u5efa\u7acb\u8ddf\u522a\u9664 ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u898f\u5247\u7684\u8173\u672c\u5982\u4e0b"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"#!/bin/bash\n\ninsert() {\n    ebtables -t broute -I BROUTING --log --log-prefix 'ctc/ebtable/broute-BROUTING' --log-level debug\n    ebtables -t nat -I PREROUTING --log --log-prefix 'ctc/ebtable/nat-PREROUTE' --log-level debug\n    ebtables -t nat -I POSTROUTING --log --log-prefix 'ctc/ebtable/nat-POSTROUTE' --log-level debug\n    ebtables -t filter -I INPUT --log --log-prefix 'ctc/ebtable/filter-input' --log-level debug\n    ebtables -t filter -I OUTPUT --log --log-prefix 'ctc/ebtable/filter-output' --log-level debug\n    ebtables -t filter -I FORWARD --log --log-prefix 'ctc/ebtable/filter-forward' --log-level debug\n}\n\ndelete() {\n    ebtables -t broute -D BROUTING --log --log-prefix 'ctc/ebtable/broute-BROUTING' --log-level debug\n    ebtables -t nat -D PREROUTING --log --log-prefix 'ctc/ebtable/nat-PREROUTE' --log-level debug\n    ebtables -t nat -D POSTROUTING --log --log-prefix 'ctc/ebtable/nat-POSTROUTE' --log-level debug\n    ebtables -t filter -D INPUT --log --log-prefix 'ctc/ebtable/filter-input' --log-level debug\n    ebtables -t filter -D OUTPUT --log --log-prefix 'ctc/ebtable/filter-output' --log-level debug\n    ebtables -t filter -D FORWARD --log --log-prefix 'ctc/ebtable/filter-forward' --log-level debug\n}\n\ncheck() {\n    count=`ebtables-save | grep ctc| wc -l`\n    if [ \"$count\" == \"0\" ]; then\n        echo \"Delete Success\"\n    else\n        echo \"Delete Fail, Use the ebtables-save to check what rules still exist\"\n    fi\n}\n\nif [ \"$1\" == \"d\" ]; then\ndelete\ncheck\nelse\ninsert\nfi\n")),(0,a.kt)("p",null,"\u57f7\u884c\u88e1\u9762\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"insert")," \u51fd\u5f0f\u5c31\u53ef\u4ee5\u5c0d ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u7684\u6240\u6709 ",(0,a.kt)("inlineCode",{parentName:"p"},"Table/Chain")," \u7d44\u5408\u90fd\u5beb\u4e00\u689d\u898f\u5247\uff0c\u6ce8\u610f\u7684\u662f\u6211\u63a1\u7528\u7684\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"-I xxx")," \u610f\u5473\u8005\u5c07\u8a72\u898f\u5247\u653e\u5230\u7b2c\u4e00\u689d\uff0c\u907f\u514d\u6211\u5011\u7684\u898f\u5247\u56e0\u70ba\u5176\u4ed6\u7684\u898f\u5247\u6c92\u6709\u88ab\u9806\u5229\u57f7\u884c\u3002"),(0,a.kt)("p",null,"\u5be6\u9a57\u7d50\u675f\u6642\u53ef\u4ee5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"delete")," \u51fd\u5f0f\u53bb\u79fb\u9664\u76f8\u95dc\u7684\u898f\u5247"),(0,a.kt)("h3",{id:"setup-iptables"},"Setup iptables"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684\u6982\u5ff5\u975e\u5e38\u96f7\u540c\uff0c\u4f46\u662f\u56e0\u70ba\u7cfb\u7d71\u672c\u8eab\u6709\u592a\u591a\u7db2\u8def\u6d41\u91cf\u5728\u50b3\u8f38\uff0c\u6240\u4ee5\u6211\u6709\u7279\u5225\u8a2d\u5b9a ",(0,a.kt)("inlineCode",{parentName:"p"},"-s 172.18.0.0/16 -d 172.18.0.0/16")," \u9019\u898f\u5247\u4f86\u78ba\u4fdd\u53ea\u6709\u5c01\u5305\u7684\u4f86\u6e90\u8207\u76ee\u7684\u5730\u90fd\u662f\u5c6c\u65bc\u5bb9\u5668\u4e4b\u9593\u7684\u624d\u6703\u53bb\u7d00\u9304\u3002"),(0,a.kt)("p",null,"\u6b64\u5916\uff0c\u6211\u7279\u5225\u4e0b\u4e86\u4e00\u689d ",(0,a.kt)("inlineCode",{parentName:"p"},"mangle")," \u7684\u898f\u5247\u662f\u56e0\u70ba ",(0,a.kt)("inlineCode",{parentName:"p"},"nat")," \u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"PREROUTING/POSTROUTING")," \u6703\u56e0\u70ba ",(0,a.kt)("inlineCode",{parentName:"p"},"conntrack")," \u7684\u5e6b\u5fd9\u5c0e\u81f4\u770b\u4e0d\u51fa\u4f86\u6709\u88ab\u57f7\u884c\u591a\u6b21\uff0c\u6240\u4ee5\u7279\u5225\u591a\u7528\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"mangle")," \u4f86\u5e6b\u5fd9\u91d0\u6e05\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"#!/bin/bash\n\ninsert() {\n    iptables -t mangle -I PREROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-PREROUTE' --log-level debug\n    iptables -t mangle -I POSTROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-POSTROUTE' --log-level debug\n    iptables -t nat -I PREROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/nat-PREROUTE' --log-level debug\n    iptables -t nat -I POSTROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/nat-POSTROUTE' --log-level debug\n    iptables -t filter -I INPUT -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-input' --log-level debug\n    iptables -t filter -I OUTPUT -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-output' --log-level debug\n    iptables -t filter -I FORWARD -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-forward' --log-level debug\n}\n\ndelete() {\n    iptables -t mangle -D PREROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-PREROUTE' --log-level debug\n    iptables -t mangle -D POSTROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-POSTROUTE' --log-level debug\n    iptables -t nat -D PREROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/nat-PREROUTE' --log-level debug\n    iptables -t nat -D POSTROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/nat-POSTROUTE' --log-level debug\n    iptables -t filter -D INPUT -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-input' --log-level debug\n    iptables -t filter -D OUTPUT -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-output' --log-level debug\n    iptables -t filter -D FORWARD -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-forward' --log-level debug\n}\n\ncheck() {\n    count=`iptables-save | grep ctc| wc -l`\n    if [ \"$count\" == \"0\" ]; then\n        echo \"Delete Success\"\n    else\n        echo \"Delete Fail, Use the iptables-save to check what rules still exist\"\n    fi\n}\n\n\nif [ \"$1\" == \"d\" ]; then\ndelete\ncheck\nelse\ninsert\nfi\n")),(0,a.kt)("h3",{id:"test"},"Test"),(0,a.kt)("p",null,"\u7576\u4e0a\u8ff0\u898f\u5247\u7684\u8a2d\u5b9a\u5b8c\u7562\u5f8c\uff0c\u6211\u5011\u5148\u57f7\u884c\u6578\u6b21 ",(0,a.kt)("inlineCode",{parentName:"p"},"dmesg -c")," \u53bb\u78ba\u4fdd\u76ee\u524d\u6c92\u6709\u4efb\u4f55 ",(0,a.kt)("inlineCode",{parentName:"p"},"kernel")," \u6240\u8f38\u51fa\u7684\u65b0\u8a0a\u606f\u3002\n\u63a5\u8005\u57f7\u884c\u4e0b\u5217\u6307\u4ee4\uff0c\u8acb\u5148\u78ba\u4fdd(172.18.0.2)\u662f \u5bb9\u5668 ",(0,a.kt)("inlineCode",{parentName:"p"},"nginx")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"docker exec  netutils ping 172.18.0.2 -c1\n")),(0,a.kt)("p",null,"\u63a5\u4e0b\u4f86\u99ac\u4e0a\u57f7\u884c ",(0,a.kt)("inlineCode",{parentName:"p"},"sudo dmesg -ct")," \u4f86\u986f\u793a\u8cc7\u6599\u3002(\u900f\u904e -t \u53ea\u662f\u4e0d\u60f3\u8981\u986f\u793a\u6642\u9593\uff0c\u6392\u7248\u6bd4\u8f03\u597d\u770b)"),(0,a.kt)("p",null,"\u8a72\u8f38\u51fa\u8cc7\u6599\u5982\u4e0b\uff0c\u6211\u5011\u5c07\u8a72\u8cc7\u6599\u5206\u6210\u5169\u90e8\u5206\uff0c\u56e0\u70ba ",(0,a.kt)("inlineCode",{parentName:"p"},"ping -c1")," \u5be6\u969b\u4e0a\u6703\u727d\u626f\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Request")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Reply"),"."),(0,a.kt)("p",null,"\u5982\u679c\u4f60\u7684\u74b0\u5883\u4e2d\u6709\u770b\u5230 proto=0x0806, \u9019\u662f\u6240\u8b02\u7684 APR \u5c01\u5305\uff0c\u672c\u6587\u66ab\u6642\u4e0d\u8a0e\u8ad6 ARP\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"ctc/ebtable/broute-BROUTING IN=vethd709394 OUT= MAC source = 02:42:ac:12:00:03 MAC dest = 02:42:ac:12:00:02 proto = 0x0800\nctc/ebtable/nat-PREROUTE IN=vethd709394 OUT= MAC source = 02:42:ac:12:00:03 MAC dest = 02:42:ac:12:00:02 proto = 0x0800\nctc/iptable/mangle-PREROUTEIN=docker0 OUT= PHYSIN=vethd709394 MAC=02:42:ac:12:00:02:02:42:ac:12:00:03:08:00 SRC=172.18.0.3 DST=172.18.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=7179 DF PROTO=ICMP TYPE=8 CODE=0 ID=8896 SEQ=1\nctc/iptable/nat-PREROUTEIN=docker0 OUT= PHYSIN=vethd709394 MAC=02:42:ac:12:00:02:02:42:ac:12:00:03:08:00 SRC=172.18.0.3 DST=172.18.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=7179 DF PROTO=ICMP TYPE=8 CODE=0 ID=8896 SEQ=1\nctc/ebtable/filter-forward IN=vethd709394 OUT=veth5ead5c7 MAC source = 02:42:ac:12:00:03 MAC dest = 02:42:ac:12:00:02 proto = 0x0800\nctc/iptable/filter-forwardIN=docker0 OUT=docker0 PHYSIN=vethd709394 PHYSOUT=veth5ead5c7 MAC=02:42:ac:12:00:02:02:42:ac:12:00:03:08:00 SRC=172.18.0.3 DST=172.18.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=7179 DF PROTO=ICMP TYPE=8 CODE=0 ID=8896 SEQ=1\nctc/ebtable/nat-POSTROUTE IN= OUT=veth5ead5c7 MAC source = 02:42:ac:12:00:03 MAC dest = 02:42:ac:12:00:02 proto = 0x0800\nctc/iptable/mangle-POSTROUTEIN= OUT=docker0 PHYSIN=vethd709394 PHYSOUT=veth5ead5c7 SRC=172.18.0.3 DST=172.18.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=7179 DF PROTO=ICMP TYPE=8 CODE=0 ID=8896 SEQ=1\nctc/iptable/nat-POSTROUTEIN= OUT=docker0 PHYSIN=vethd709394 PHYSOUT=veth5ead5c7 SRC=172.18.0.3 DST=172.18.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=7179 DF PROTO=ICMP TYPE=8 CODE=0 ID=8896 SEQ=1\n")),(0,a.kt)("p",null,"\u900f\u904e\u6211\u5011\u4e8b\u5148\u63cf\u8ff0\u597d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"log-prefix"),", \u6211\u5011\u53ef\u4ee5\u5f88\u6e05\u695a\u7684\u89c0\u5bdf\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u6bd4\u5c0d\u7684\u904e\u7a0b\u3002\n\u9019\u4e9b\u898f\u5247\u6211\u53ea\u91dd\u5c0d\u5e7e\u500b\u6709\u8da3\u7684\u90e8\u5206\u4ecb\u7d39\u4e00\u4e0b"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u524d\u9762\u5c01\u5305\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"IN="),"\u4ee3\u8868\u7684\u90fd\u662f\u672c\u6a5f\u4e0a\u7528\u4f86\u5c07 ",(0,a.kt)("inlineCode",{parentName:"li"},"Docker"),"\u5bb9\u5668\u8207 ",(0,a.kt)("inlineCode",{parentName:"li"},"Linux Bridge")," \u9023\u7d50\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"veth")," \u865b\u64ec\u9023\u7dda\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u53ef\u4ee5\u89c0\u5bdf\u5230\u524d\u9762\u5e7e\u500b\u8a0a\u606f\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"OUT=")," \u90fd\u662f\u7a7a\u7684\uff0c\u9019\u662f\u56e0\u70ba\u9084\u6c92\u6709\u9032\u884c ",(0,a.kt)("inlineCode",{parentName:"li"},"Bridge Decision"),", \u9084\u6c92\u6709\u8fa6\u6cd5\u77e5\u9053\u5c01\u5305\u5230\u5e95\u76ee\u6a19\u7684\u7db2\u5361\u662f\u8ab0\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u53ef\u4ee5\u770b\u5230\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"ebtables")," \u9019\u908a\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"in=")," \u90fd\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"vethxxx")," \u800c ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u7684\u90fd\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"docker0"),", \u9019\u662f\u56e0\u70ba\u5169\u8005\u5c64\u53ca\u4e0d\u540c\uff0c\u95dc\u6ce8\u7684\u9ede\u4e0d\u4e00\u6a23\uff0c\u5be6\u969b\u5728\u4e0a ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u4e2d\u53ef\u4ee5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"physical")," \u76f8\u95dc\u7684\u53c3\u6578\u62ff\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"vethxxxx"),"."),(0,a.kt)("li",{parentName:"ol"},"\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"FORWARD")," \u4e4b\u5f8c\uff0c\u53ef\u4ee5\u89c0\u5bdf\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"IN")," \u7684\u8a0a\u606f\u90fd\u4e0d\u898b\u4e86\uff0c\u9019\u662f\u56e0\u70ba\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"PREROUTING"),"  \u9019\u908a\u53ef\u4ee5\u9032\u884c ",(0,a.kt)("inlineCode",{parentName:"li"},"SNAT")," \u4e4b\u985e\u7684\u9078\u9805\uff0c\u53ef\u4ee5\u6539\u8b8a\u5c01\u5305\u7684\u9001\u7aef\u662f\u8ab0\uff0c\u6240\u4ee5\u9019\u6642\u5019 ",(0,a.kt)("inlineCode",{parentName:"li"},"IN=")," \u7684\u8cc7\u6599\u5176\u5be6\u5c31\u662f\u4e00\u500b\u4e0d\u78ba\u5b9a\u6027\uff0c\u800c\u4e14\u4e5f\u6c92\u90a3\u9ebc\u91cd\u8981\u4e86\u3002")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"ctc/ebtable/broute-BROUTING IN=veth5ead5c7 OUT= MAC source = 02:42:ac:12:00:02 MAC dest = 02:42:ac:12:00:03 proto = 0x0800\nctc/ebtable/nat-PREROUTE IN=veth5ead5c7 OUT= MAC source = 02:42:ac:12:00:02 MAC dest = 02:42:ac:12:00:03 proto = 0x0800\nctc/iptable/mangle-PREROUTEIN=docker0 OUT= PHYSIN=veth5ead5c7 MAC=02:42:ac:12:00:03:02:42:ac:12:00:02:08:00 SRC=172.18.0.2 DST=172.18.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=59995 PROTO=ICMP TYPE=0 CODE=0 ID=8896 SEQ=1\nctc/ebtable/filter-forward IN=veth5ead5c7 OUT=vethd709394 MAC source = 02:42:ac:12:00:02 MAC dest = 02:42:ac:12:00:03 proto = 0x0800\nctc/iptable/filter-forwardIN=docker0 OUT=docker0 PHYSIN=veth5ead5c7 PHYSOUT=vethd709394 MAC=02:42:ac:12:00:03:02:42:ac:12:00:02:08:00 SRC=172.18.0.2 DST=172.18.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=59995 PROTO=ICMP TYPE=0 CODE=0 ID=8896 SEQ=1\nctc/ebtable/nat-POSTROUTE IN= OUT=vethd709394 MAC source = 02:42:ac:12:00:02 MAC dest = 02:42:ac:12:00:03 proto = 0x0800\nctc/iptable/mangle-POSTROUTEIN= OUT=docker0 PHYSIN=veth5ead5c7 PHYSOUT=vethd709394 SRC=172.18.0.2 DST=172.18.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=59995 PROTO=ICMP TYPE=0 CODE=0 ID=8896 SEQ=1\n")),(0,a.kt)("p",null,"\u91dd\u5c0d ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Reply")," \u56de\u50b3\u7684\u90e8\u5206\uff0c\u6211\u5011\u9996\u5148\u53ef\u4ee5\u89c0\u5bdf\u5230"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u8a0a\u606f\u6578\u91cf\u4e0d\u5c0d\u7a31\uff0c\u5c11\u4e86\u5169\u500b\u6bd4\u5c0d\u7684\u8a0a\u606f"),(0,a.kt)("li",{parentName:"ol"},"\u5c11\u7684\u5206\u5225\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"iptable/nat-PREROUTEIN")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"li"},"ctc/iptable/nat-POSTROUTEIN"),". \u56e0\u70ba ",(0,a.kt)("inlineCode",{parentName:"li"},"nat")," \u76f8\u95dc\u7684\u64cd\u4f5c\u90fd\u6703\u88ab ",(0,a.kt)("inlineCode",{parentName:"li"},"conntrack")," \u9032\u884c\u5feb\u53d6\u5e6b\u5fd9\u505a\u6389\u4e86\u3002")),(0,a.kt)("p",null,"\u6211\u5011\u5c07\u5c01\u5305\u4e86\u4f86\u56de\u642d\u914d\u4e4b\u524d\u7684\u5716\u8868\u6574\u7406\u4e00\u4e0b\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/AuCxab9.png",alt:"Imgur"}),"v\n\u56e0\u70ba\u5bb9\u5668\u8207\u5bb9\u5668\u4e4b\u9593\u7684\u50b3\u8f38\uff0c\u57fa\u672c\u4e0a\u90fd\u662f\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"Linux Bridge")," \u5e95\u4e0b\u9032\u884c\u50b3\u8f38\uff0c\u6240\u4ee5 ",(0,a.kt)("inlineCode",{parentName:"p"},"ping")," \u7522\u751f\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Request")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Reply")," \u90fd\u6703\u8d70\u76f8\u540c\u7684\u8def\u7dda\u4f86\u50b3\u8f38\u3002"),(0,a.kt)("h2",{id:"localhost-to-container"},"Localhost To Container"),(0,a.kt)("p",null,"\u9019\u6b21\u7684\u60c5\u5883\u66f4\u70ba\u7c21\u55ae\uff0c\u672c\u6a5f\u4e0a\u9762\u76f4\u63a5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"ping")," \u9019\u500b\u61c9\u7528\u7a0b\u5f0f\u53bb\u9023\u7d50\u5230\u5bb9\u5668\u5167\u90e8\uff0c\u9019\u908a\u6703\u76f4\u63a5\u4f7f\u7528\u5bb9\u5668\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740\u4f86\u9032\u884c\u6e9d\u901a\u3002"),(0,a.kt)("p",null,"\u60c5\u5883\u5716\u5982\u4e0b\uff0c\u76f8\u5c0d\u65bc\u4e0a\u8ff0\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Container To Container"),", \u9019\u6b21\u7684\u5c01\u5305\u4e0d\u662f\u5b8c\u5168\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer2")," \u8f49\u767c\u5c31\u53ef\u4ee5\u8655\u7406\u7684\uff0c\u6703\u727d\u626f\u5230\u672c\u6a5f\u4e0a\u9762\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Ping")," \u7a0b\u5f0f\uff0c\u9019\u610f\u5473\u8005 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer3")," \u7684\u90e8\u5206\u4e5f\u6703\u51fa\u73fe\u3002\n",(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/v8xwHDe.png",alt:"Imgur"})),(0,a.kt)("h3",{id:"setup-ebtables-1"},"Setup ebtables"),(0,a.kt)("p",null,"\u57fa\u672c\u4e0a ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u7684\u6307\u4ee4\u8207\u524d\u8ff0\u76f8\u540c\uff0c\u6c92\u6709\u90e8\u4efd\u9700\u8981\u4fee\u6539\uff0c\u53ef\u4ee5\u7e7c\u7e8c\u4f7f\u7528\u524d\u8ff0\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u6307\u4ee4\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"#!/bin/bash\n\ninsert() {\n    ebtables -t broute -I BROUTING --log --log-prefix 'ctc/ebtable/broute-BROUTING' --log-level debug\n    ebtables -t nat -I PREROUTING --log --log-prefix 'ctc/ebtable/nat-PREROUTE' --log-level debug\n    ebtables -t nat -I POSTROUTING --log --log-prefix 'ctc/ebtable/nat-POSTROUTE' --log-level debug\n    ebtables -t filter -I INPUT --log --log-prefix 'ctc/ebtable/filter-input' --log-level debug\n    ebtables -t filter -I OUTPUT --log --log-prefix 'ctc/ebtable/filter-output' --log-level debug\n    ebtables -t filter -I FORWARD --log --log-prefix 'ctc/ebtable/filter-forward' --log-level debug\n}\n\ndelete() {\n    ebtables -t broute -D BROUTING --log --log-prefix 'ctc/ebtable/broute-BROUTING' --log-level debug\n    ebtables -t nat -D PREROUTING --log --log-prefix 'ctc/ebtable/nat-PREROUTE' --log-level debug\n    ebtables -t nat -D POSTROUTING --log --log-prefix 'ctc/ebtable/nat-POSTROUTE' --log-level debug\n    ebtables -t filter -D INPUT --log --log-prefix 'ctc/ebtable/filter-input' --log-level debug\n    ebtables -t filter -D OUTPUT --log --log-prefix 'ctc/ebtable/filter-output' --log-level debug\n    ebtables -t filter -D FORWARD --log --log-prefix 'ctc/ebtable/filter-forward' --log-level debug\n}\n\ncheck() {\n    count=`ebtables-save | grep ctc| wc -l`\n    if [ \"$count\" == \"0\" ]; then\n        echo \"Delete Success\"\n    else\n        echo \"Delete Fail, Use the ebtables-save to check what rules still exist\"\n    fi\n}\n\n\nif [ \"$1\" == \"d\" ]; then\ndelete\ncheck\nelse\ninsert\nfi\n")),(0,a.kt)("h3",{id:"setup-iptables-1"},"Setup iptables"),(0,a.kt)("p",null,"\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u65b9\u9762\uff0c\u6211\u5011\u65b0\u589e\u4e86\u4e00\u689d ",(0,a.kt)("inlineCode",{parentName:"p"},"mangle OUTPUT")," \u4f86\u5354\u52a9\u89c0\u5bdf\u5c01\u5305\u7684\u8f49\u9001\uff0c\u4e3b\u8981\u539f\u56e0\u662f\u672c\u6a5f\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"ping")," \u61c9\u7528\u7a0b\u5f0f\u9001\u51fa ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Request")," \u6703\u727d\u626f\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"OUTPUT Chain"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"#!/bin/bash\n\ninsert() {\n    iptables -t mangle -I OUTPUT -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-OUTPUT' --log-level debug\n    iptables -t mangle -I PREROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-PREROUTE' --log-level debug\n    iptables -t mangle -I POSTROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-POSTROUTE' --log-level debug\n    iptables -t nat -I PREROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/nat-PREROUTE' --log-level debug\n    iptables -t nat -I POSTROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/nat-POSTROUTE' --log-level debug\n    iptables -t filter -I INPUT -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-input' --log-level debug\n    iptables -t filter -I OUTPUT -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-output' --log-level debug\n    iptables -t filter -I FORWARD -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-forward' --log-level debug\n}\n\ndelete() {\n    iptables -t mangle -D OUTPUT -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-OUTPUT' --log-level debug\n    iptables -t mangle -D PREROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-PREROUTE' --log-level debug\n    iptables -t mangle -D POSTROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/mangle-POSTROUTE' --log-level debug\n    iptables -t nat -D PREROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/nat-PREROUTE' --log-level debug\n    iptables -t nat -D POSTROUTING -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/nat-POSTROUTE' --log-level debug\n    iptables -t filter -D INPUT -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-input' --log-level debug\n    iptables -t filter -D OUTPUT -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-output' --log-level debug\n    iptables -t filter -D FORWARD -s 172.18.0.0/16 -d 172.18.0.0/16 -j LOG --log-prefix 'ctc/iptable/filter-forward' --log-level debug\n}\n\ncheck() {\n    count=`iptables-save | grep ctc| wc -l`\n    if [ \"$count\" == \"0\" ]; then\n        echo \"Delete Success\"\n    else\n        echo \"Delete Fail, Use the iptables-save to check what rules still exist\"\n    fi\n}\n\n\nif [ \"$1\" == \"d\" ]; then\ndelete\ncheck\nelse\ninsert\nfi\n")),(0,a.kt)("h3",{id:"test-1"},"Test"),(0,a.kt)("p",null,"\u7576\u4e0a\u8ff0\u7684\u898f\u5247\u90fd\u6e96\u5099\u5b8c\u7562\u4e4b\u5f8c\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u958b\u59cb\u4f86\u9032\u884c\u6e2c\u8a66\u4e86\u3002\n\u7531\u65bc\u9019\u6b21\u662f\u4f7f\u7528\u672c\u6a5f\u4e0a\u9762\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"ping")," \u6307\u4ee4\u4f86\u50b3\u8f38\u5c01\u5305\uff0c\u6240\u4ee5\u6e2c\u8a66\u7684\u6307\u4ee4\u66f4\u70ba\u7c21\u55ae"),(0,a.kt)("p",null,"\u63a5\u8005\u57f7\u884c\u4e0b\u5217\u6307\u4ee4\uff0c\u8acb\u5148\u78ba\u4fdd(172.18.0.2)\u662f \u5bb9\u5668 ",(0,a.kt)("inlineCode",{parentName:"p"},"nginx")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"ping 172.18.0.2 -c1\n")),(0,a.kt)("p",null,"\u63a5\u4e0b\u4f86\u99ac\u4e0a\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"sudo dmesg -ct")," \u4f86\u89c0\u5bdf\u7d50\u679c\uff0c\u7136\u5f8c\u6211\u5c07\u7d50\u679c\u5206\u6210 ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Request")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Reply")," \u5169\u500b\u90e8\u5206\u4f86\u89c0\u5bdf\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"ctc/iptable/mangle-OUTPUTIN= OUT=docker0 SRC=172.18.0.1 DST=172.18.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=15859 DF PROTO=ICMP TYPE=8 CODE=0 ID=30580 SEQ=1\nctc/iptable/filter-outputIN= OUT=docker0 SRC=172.18.0.1 DST=172.18.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=15859 DF PROTO=ICMP TYPE=8 CODE=0 ID=30580 SEQ=1\nctc/iptable/mangle-POSTROUTEIN= OUT=docker0 SRC=172.18.0.1 DST=172.18.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=15859 DF PROTO=ICMP TYPE=8 CODE=0 ID=30580 SEQ=1\nctc/iptable/nat-POSTROUTEIN= OUT=docker0 SRC=172.18.0.1 DST=172.18.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=15859 DF PROTO=ICMP TYPE=8 CODE=0 ID=30580 SEQ=1\nctc/ebtable/filter-output IN= OUT=veth5ead5c7 MAC source = 02:42:db:a1:f2:79 MAC dest = 02:42:ac:12:00:02 proto = 0x0800\nctc/ebtable/nat-POSTROUTE IN= OUT=veth5ead5c7 MAC source = 02:42:db:a1:f2:79 MAC dest = 02:42:ac:12:00:02 proto = 0x0800\n")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u7531\u65bc\u5c01\u5305\u662f\u76f4\u63a5\u5f9e\u672c\u6a5f\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"Ping")," \u51fa\u767c\u7684\uff0c\u6240\u4ee5\u6703\u5148\u5f9e ",(0,a.kt)("inlineCode",{parentName:"li"},"Layer3")," \u958b\u59cb\u50b3\u9001\u5c01\u5305\uff0c\u56e0\u6b64\u7b2c\u4e00\u500b\u9047\u5230\u7684\u5c31\u6703\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"iptables")," \u76f8\u95dc\u7684\u898f\u5247"),(0,a.kt)("li",{parentName:"ol"},"\u9019\u908a\u53ef\u4ee5\u89c0\u5bdf\u5230\u56e0\u70ba\u5c01\u5305\u662f\u5f9e\u672c\u6a5f\u51fa\u53bb\u7684\uff0c\u6240\u4ee5\u5176\u5be6 ",(0,a.kt)("inlineCode",{parentName:"li"},"IN=")," \u7684\u6b04\u4f4d\u4e00\u76f4\u90fd\u662f\u7a7a\u7684\uff0c\u56e0\u70ba\u5176\u5be6\u4e5f\u4e0d\u91cd\u8981\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u56e0\u70ba\u76ee\u6a19\u5bb9\u5668\u662f\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"Linux Bridge")," \u5e95\u4e0b\uff0c\u6240\u4ee5\u5c01\u5305\u6703\u5148\u67e5\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"docker0"),", \u6700\u5f8c\u4f9d\u8cf4 ",(0,a.kt)("inlineCode",{parentName:"li"},"Layer2")," \u53bb\u8f49\u767c\u9001\u51fa\u53bb\u3002")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"ctc/ebtable/broute-BROUTING IN=veth5ead5c7 OUT= MAC source = 02:42:ac:12:00:02 MAC dest = 02:42:db:a1:f2:79 proto = 0x0800\nctc/ebtable/nat-PREROUTE IN=veth5ead5c7 OUT= MAC source = 02:42:ac:12:00:02 MAC dest = 02:42:db:a1:f2:79 proto = 0x0800\nctc/iptable/mangle-PREROUTEIN=docker0 OUT= PHYSIN=veth5ead5c7 MAC=02:42:db:a1:f2:79:02:42:ac:12:00:02:08:00 SRC=172.18.0.2 DST=172.18.0.1 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=55481 PROTO=ICMP TYPE=0 CODE=0 ID=30580 SEQ=1\nctc/ebtable/filter-input IN=veth5ead5c7 OUT= MAC source = 02:42:ac:12:00:02 MAC dest = 02:42:db:a1:f2:79 proto = 0x0800\nctc/iptable/filter-inputIN=docker0 OUT= PHYSIN=veth5ead5c7 MAC=02:42:db:a1:f2:79:02:42:ac:12:00:02:08:00 SRC=172.18.0.2 DST=172.18.0.1 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=55481 PROTO=ICMP TYPE=0 CODE=0 ID=30580 SEQ=1\n")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"ICMP Reply")," \u7684\u65b9\u5411\u662f\u5f9e\u5bb9\u5668\u56de\u5230\u672c\u6a5f\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"Ping")," \u61c9\u7528\u7a0b\u5f0f\uff0c\u56e0\u6b64\u9032\u5165\u9ede\u5c31\u662f",(0,a.kt)("inlineCode",{parentName:"li"},"Linux Bridge"),", \u9019\u610f\u5473\u8005\u4e00\u5b9a\u662f\u5f9e ",(0,a.kt)("inlineCode",{parentName:"li"},"ebtables/broute-BROUTING"),"  \u958b\u59cb"),(0,a.kt)("li",{parentName:"ol"},"\u67e5\u8a62\u5b8c\u76f8\u95dc\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"Bridging Table")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"li"},"Routing Table"),", \u6700\u5f8c\u6c7a\u5b9a\u8981\u5c07\u5c01\u5305\u9001\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"Ping")," \u7684\u61c9\u7528\u7a0b\u5f0f\uff0c\u56e0\u6b64\u6703\u8d70\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"INPUT Chain")," \u9019\u908a\u4f86\u8655\u7406\u3002")),(0,a.kt)("p",null,"\u6700\u5f8c\u6211\u5011\u5c07\u4e0a\u8ff0\u7684\u6d41\u5411\u7d66\u5408\u4f75\u8d77\u4f86\u89c0\u770b\uff0c\u5728\u9019\u500b\u7bc4\u4f8b\u4e4b\u4e2d\u56e0\u70ba ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Request")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Reply")," \u662f\u4e0d\u540c\u7684\u8d70\u5411\u3002\u6240\u4ee5\u5728\u4e0b\u5716\u4e2d\u3002\u6211\u5011\u7d2b\u8272\u7684\u4ee3\u8868\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Request")," \u7684\u8d70\u5411\uff0c\u800c\u85cd\u8272\u4ee3\u8868\u7684\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"ICMP Reply")," \u7684\u8d70\u5411\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/6CDXA6w.png",alt:"Imgur"})),(0,a.kt)("h2",{id:"wan-to-container"},"Wan To Container"),(0,a.kt)("p",null,"\u7d42\u65bc\u5230\u4e86\u6700\u5f8c\u4e00\u500b\u60c5\u5883\uff0c\u9019\u500b\u60c5\u5883\u4e5f\u662f\u6700\u591a\u4eba\u5e38\u7528\u7684\u60c5\u5883\u3002\u6211\u5011\u7684\u5bb9\u5668\u672c\u8eab\u518d\u5275\u7acb\u7684\u6642\u5019\uff0c\u6703\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"-p 5566:80")," \u7684\u65b9\u5f0f\u5c07\u672c\u6a5f\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"5566")," \u9023\u63a5\u57e0\u4e32\u901a\u5230\u5bb9\u5668\u5167\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"80")," \u9023\u63a5\u57e0."),(0,a.kt)("p",null,"\u63a5\u8005\u5916\u90e8\u7684\u7db2\u8def\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"5566")," \u9023\u7d50\u57e0\u4f86\u5b58\u53d6\u5c0d\u61c9\u7684\u5bb9\u5668\u5167\u5bb9\u3002"),(0,a.kt)("p",null,"\u56e0\u6b64\u5728\u9019\u500b\u7bc4\u4f8b\u4e2d\uff0c\u6211\u5011\u6253\u7b97\u5f9e\u5916\u90e8\u7db2\u8def\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"5566")," \u9023\u7d50\u57e0\u4f86\u5b58\u53d6\u662f\u5148\u5efa\u7acb\u597d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Nginx")," \u5bb9\u5668\u3002"),(0,a.kt)("p",null,"\u63a5\u8005\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u7684\u8a18\u9304\u4f86\u89c0\u5bdf\u5728\u9019\u7a2e\u60c5\u5883\u4e0b\uff0c\u5c01\u5305\u6703\u600e\u9ebc\u50b3\u8f38\u3002\n\u6b64\u5916\uff0c\u7531\u65bc\u6211\u5011\u9084\u6709\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"5566")," \u9023\u7d50\u57e0\u8f49\u63db\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"80"),"\u9023\u7d50\u57e0\u7684\u9700\u6c42\uff0c\u6240\u4ee5\u5728\u6211\u5011\u89c0\u5bdf\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u7684\u7d50\u679c\u4e2d\uff0c\u61c9\u8a72\u4e5f\u8981\u53ef\u4ee5\u770b\u5230\u5c01\u5305\u8cc7\u8a0a\u7684\u8b8a\u63db(IP/Port/MAC Address)\n",(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/Ongf166.png",alt:"Imgur"})),(0,a.kt)("h3",{id:"setup-ebtables-2"},"Setup ebtables"),(0,a.kt)("p",null,"\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables")," \u65b9\u9762\uff0c\u898f\u5247\u57fa\u672c\u4e0a\u6c92\u6709\u592a\u591a\u8b8a\u5316\uff0c\u7e7c\u7e8c\u4f9d\u7167\u4e4b\u524d\u7684\u7528\u6cd5\u5373\u53ef\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"#!/bin/bash\n\ninsert() {\n    ebtables -t broute -I BROUTING --log --log-prefix 'ctc/ebtable/broute-BROUTING' --log-level debug\n    ebtables -t nat -I PREROUTING --log --log-prefix 'ctc/ebtable/nat-PREROUTE' --log-level debug\n    ebtables -t nat -I POSTROUTING --log --log-prefix 'ctc/ebtable/nat-POSTROUTE' --log-level debug\n    ebtables -t filter -I INPUT --log --log-prefix 'ctc/ebtable/filter-input' --log-level debug\n    ebtables -t filter -I OUTPUT --log --log-prefix 'ctc/ebtable/filter-output' --log-level debug\n    ebtables -t filter -I FORWARD --log --log-prefix 'ctc/ebtable/filter-forward' --log-level debug\n}\n\ndelete() {\n    ebtables -t broute -D BROUTING --log --log-prefix 'ctc/ebtable/broute-BROUTING' --log-level debug\n    ebtables -t nat -D PREROUTING --log --log-prefix 'ctc/ebtable/nat-PREROUTE' --log-level debug\n    ebtables -t nat -D POSTROUTING --log --log-prefix 'ctc/ebtable/nat-POSTROUTE' --log-level debug\n    ebtables -t filter -D INPUT --log --log-prefix 'ctc/ebtable/filter-input' --log-level debug\n    ebtables -t filter -D OUTPUT --log --log-prefix 'ctc/ebtable/filter-output' --log-level debug\n    ebtables -t filter -D FORWARD --log --log-prefix 'ctc/ebtable/filter-forward' --log-level debug\n}\n\ncheck() {\n    count=`ebtables-save | grep ctc| wc -l`\n    if [ \"$count\" == \"0\" ]; then\n        echo \"Delete Success\"\n    else\n        echo \"Delete Fail, Use the ebtables-save to check what rules still exist\"\n    fi\n}\n\n\nif [ \"$1\" == \"d\" ]; then\ndelete\ncheck\nelse\ninsert\nfi\n")),(0,a.kt)("h3",{id:"setup-iptables-2"},"Setup iptables"),(0,a.kt)("p",null,"\u4e0d\u540c\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"ebtables"),"\uff0c\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u9019\u908a\u7684\u4fee\u6539\u6bd4\u8f03\u591a\uff0c\u539f\u56e0\u5982\u4e0b"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u6b64\u60c5\u5883\u5c6c\u65bc ",(0,a.kt)("inlineCode",{parentName:"li"},"Wan To Container"),", \u9019\u610f\u5473\u727d\u626f\u5230\u4e0d\u540c\u7db2\u6bb5\u7684\u50b3\u8f38"),(0,a.kt)("li",{parentName:"ol"},"\u56e0\u70ba\u6211\u64cd\u4f5c\u7684\u74b0\u5883\u7b97\u662f\u5f88\u4e7e\u6de8\uff0c\u6240\u4ee5\u6211\u91dd\u5c0d ",(0,a.kt)("inlineCode",{parentName:"li"},"Wan IP")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"li"},"Container IP")," \u4f86\u4f5c\u70ba\u5c01\u5305\u7684\u689d\u4ef6"),(0,a.kt)("li",{parentName:"ol"},"\u5728\u6211\u7684\u74b0\u5883\u4e2d\uff0c\u6211\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"Wan")," \u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"172.17.0.1")," \u800c ",(0,a.kt)("inlineCode",{parentName:"li"},"Container")," \u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"172.18.0.2"),". \u6240\u4ee5\u6211\u898f\u5247\u6703\u91dd\u5c0d ",(0,a.kt)("inlineCode",{parentName:"li"},"172.17.0.0/16")," \u4ee5\u53ca ",(0,a.kt)("inlineCode",{parentName:"li"},"172.18.0.0/16")," \u4f86\u8a2d\u5b9a\u3002")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"#!/bin/bash\n\ninsert() {\n    iptables -t mangle -I PREROUTING -p tcp -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-PREROUTE' --log-level debug\n    iptables -t nat -I PREROUTING -p tcp  -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/nat-PREROUTE' --log-level debug\n    iptables -t mangle -I PREROUTING -p tcp -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-PREROUTE' --log-level debug\n    iptables -t nat -I PREROUTING -p tcp  -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/nat-PREROUTE' --log-level debug\n\n    iptables -t filter -I FORWARD -p tcp -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/filter-forward' --log-level debug\n    iptables -t filter -I FORWARD -p tcp -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/filter-forward' --log-level debug\n    iptables -t mangle -I FORWARD -p tcp -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-FORWARD' --log-level debug\n    iptables -t mangle -I FORWARD -p tcp -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-FORWARD' --log-level debug\n\n    iptables -t mangle -I POSTROUTING -p tcp -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-POSTROUTE' --log-level debug\n    iptables -t mangle -I POSTROUTING -p tcp -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-POSTROUTE' --log-level debug\n    iptables -t nat -I POSTROUTING -p tcp -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/nat-POSTROUTE' --log-level debug\n    iptables -t nat -I POSTROUTING -p tcp -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/nat-POSTROUTE' --log-level debug\n }\n\ndelete() {\n    iptables -t mangle -D PREROUTING -p tcp -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-PREROUTE' --log-level debug\n    iptables -t nat -D PREROUTING -p tcp  -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/nat-PREROUTE' --log-level debug\n    iptables -t mangle -D PREROUTING -p tcp -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-PREROUTE' --log-level debug\n    iptables -t nat -D PREROUTING -p tcp  -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/nat-PREROUTE' --log-level debug\n\n    iptables -t filter -D FORWARD -p tcp -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/filter-forward' --log-level debug\n    iptables -t filter -D FORWARD -p tcp -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/filter-forward' --log-level debug\n    iptables -t mangle -D FORWARD -p tcp -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-FORWARD' --log-level debug\n    iptables -t mangle -D FORWARD -p tcp -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-FORWARD' --log-level debug\n\n    iptables -t mangle -D POSTROUTING -p tcp -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-POSTROUTE' --log-level debug\n    iptables -t mangle -D POSTROUTING -p tcp -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/mangle-POSTROUTE' --log-level debug\n    iptables -t nat -D POSTROUTING -p tcp -d 172.18.0.0/16 -j LOG --log-prefix 'wtc/iptable/nat-POSTROUTE' --log-level debug\n    iptables -t nat -D POSTROUTING -p tcp -d 172.17.0.0/16 -j LOG --log-prefix 'wtc/iptable/nat-POSTROUTE' --log-level debug\n}\n\ncheck() {\n    count=`iptables-save | grep wtc| wc -l`\n    if [ \"$count\" == \"0\" ]; then\n        echo \"Delete Success\"\n    else\n        echo \"Delete Fail, Use the iptables-save to check what rules still exist\"\n    fi\n}\n\n\nif [ \"$1\" == \"d\" ]; then\ndelete\ncheck\nelse\ninsert\nfi\n")),(0,a.kt)("h3",{id:"test-2"},"Test"),(0,a.kt)("p",null,"\u5728\u6e2c\u8a66\u65b9\u9762\uff0c\u6211\u4e00\u958b\u59cb\u672c\u4f86\u662f\u63a1\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"curl")," \u7684\u65b9\u5f0f\u53bb\u9023\u7dda ",(0,a.kt)("inlineCode",{parentName:"p"},"nginx")," \u5bb9\u5668\uff0c\u4f46\u662f\u5176\u5be6 ",(0,a.kt)("inlineCode",{parentName:"p"},"curl")," \u505a\u4e86\u592a\u591a\u4e8b\u60c5\u4e86\uff0c\u9664\u4e86\u4e00\u958b\u59cb\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"TCP")," \u4e09\u65b9\u4ea4\u63e1\u9023\u7dda\u5916\uff0c\u9084\u5305\u542b\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"HTTP GET"),"\u3002 \u5c0d\u65bc\u6211\u5011\u53ea\u60f3\u8981\u55ae\u7d14\u89c0\u5bdf ",(0,a.kt)("inlineCode",{parentName:"p"},"Wan To Controller")," \u9019\u4f86\u56de\u7684\u9023\u7dda\u4f86\u8aaa\uff0c\u9019\u5176\u5be6\u505a\u4e86\u592a\u591a\u4e8b\u60c5\u4e86\u3002"),(0,a.kt)("p",null,"\u70ba\u4e86\u7c21\u5316\u6574\u500b\u89c0\u5bdf\u7d50\u679c\uff0c\u6211\u6700\u5f8c\u6c7a\u5b9a\u63a1\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"telnet")," \u7684\u65b9\u5f0f\uff0c\u55ae\u7d14\u5efa\u7acb ",(0,a.kt)("inlineCode",{parentName:"p"},"TCP")," \u9023\u7dda\u5c31\u597d\u3002\u800c\u6574\u500b ",(0,a.kt)("inlineCode",{parentName:"p"},"TCP")," \u7684\u4e09\u65b9\u4ea4\u63e1\u9023\u7dda\u5176\u5be6\u662f\u4e09\u500b\u5c01\u5305\u7684\u50b3\u8f38\uff0c\u6240\u5728\u89c0\u5bdf\u7684\u7d50\u679c\u4e2d\u53ef\u4ee5\u89c0\u5bdf\u5230\u4e09\u500b\u90e8\u5206\u7684\u9023\u7dda\u3002"),(0,a.kt)("p",null,"\u7136\u800c\u5728\u6211\u5011\u7684\u89c0\u5bdf\u76ee\u6a19\u4e2d\uff0c\u6211\u5011\u53ea\u9700\u8981\u89c0\u5bdf\u524d\u5169\u500b\u9023\u7dda\u5c31\u597d\uff0c\u7562\u7adf\u9019\u6a23\u5df2\u7d93\u8db3\u5920\u8b93\u6211\u5011\u53bb\u89c0\u5bdf ",(0,a.kt)("inlineCode",{parentName:"p"},"Wan To Controller")," \u7684\u50b3\u8f38\u904e\u7a0b\u4e2d\uff0c ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u6703\u5982\u4f55\u5f71\u97ff\u6211\u5011\u7684\u9023\u7dda\u3002"),(0,a.kt)("p",null,"\u5f85\u4e00\u5207\u898f\u5247\u90fd\u6e96\u5099\u597d\u5f8c\uff0c\u5728\u4f60\u5916\u7db2\u7684\u6a5f\u5668\u4e0a\uff0c\u57f7\u884c\u4e0b\u5217\u6307\u4ee4\u3002\n\u9019\u908a\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u6e2c\u8a66\u6a5f\u5668\u7684\u5c0d\u5916",(0,a.kt)("inlineCode",{parentName:"p"},"IP")," \u5730\u5740\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"172.18.8.211"),"\uff0c\u800c\u6211\u672c\u8eab\u4e3b\u6a5f\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"IP"),"\u5730\u5740\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"172.17.8.1"),". \u9019\u908a\u8acb\u8abf\u6574\u6210\u81ea\u5df1\u7684\u74b0\u5883"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"[18:13:20] hwchiu \u279c ~\xbb telnet 172.17.8.211 5566\nTrying 172.17.8.211...\nConnected to 172.17.8.211.\nEscape character is '^]'.\n")),(0,a.kt)("p",null,"\u9019\u6642\u5019\u99ac\u4e0a\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"dmesg -ct")," \u53bb\u6536\u96c6\u5c01\u5305\uff0c\u53ef\u4ee5\u5f97\u5230\u985e\u4f3c\u4e0b\u5217\u7684\u7d50\u679c\uff0c\u6211\u5c07\u7d50\u679c\u6574\u7406\uff0c\u53ea\u6536\u96c6 ",(0,a.kt)("inlineCode",{parentName:"p"},"TCP")," \u4e09\u65b9\u6559\u63e1\u7684\u524d\u5169\u65b9\u50b3\u8f38\u5c31\u597d"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"ctc/iptable/mangle-PREROUTEIN=enp0s8 OUT= MAC=08:00:27:ff:b2:c4:0a:00:27:00:00:02:08:00 SRC=172.17.8.1 DST=172.17.8.211 LEN=64 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=63584 DPT=5566 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0\nctc/iptable/nat-PREROUTEIN=enp0s8 OUT= MAC=08:00:27:ff:b2:c4:0a:00:27:00:00:02:08:00 SRC=172.17.8.1 DST=172.17.8.211 LEN=64 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=63584 DPT=5566 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0\nctc/iptable/mangle-FORWARDIN=enp0s8 OUT=docker0 MAC=08:00:27:ff:b2:c4:0a:00:27:00:00:02:08:00 SRC=172.17.8.1 DST=172.18.0.2 LEN=64 TOS=0x00 PREC=0x00 TTL=63 ID=0 DF PROTO=TCP SPT=63584 DPT=80 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0\nctc/iptable/filter-forwardIN=enp0s8 OUT=docker0 MAC=08:00:27:ff:b2:c4:0a:00:27:00:00:02:08:00 SRC=172.17.8.1 DST=172.18.0.2 LEN=64 TOS=0x00 PREC=0x00 TTL=63 ID=0 DF PROTO=TCP SPT=63584 DPT=80 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0\nctc/iptable/mangle-POSTROUTEIN= OUT=docker0 SRC=172.17.8.1 DST=172.18.0.2 LEN=64 TOS=0x00 PREC=0x00 TTL=63 ID=0 DF PROTO=TCP SPT=63584 DPT=80 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0\nctc/iptable/nat-POSTROUTEIN= OUT=docker0 SRC=172.17.8.1 DST=172.18.0.2 LEN=64 TOS=0x00 PREC=0x00 TTL=63 ID=0 DF PROTO=TCP SPT=63584 DPT=80 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0\nctc/ebtable/filter-output IN= OUT=veth5ead5c7 MAC source = 02:42:db:a1:f2:79 MAC dest = 02:42:ac:12:00:02 proto = 0x0800\nctc/ebtable/nat-POSTROUTE IN= OUT=veth5ead5c7 MAC source = 02:42:db:a1:f2:79 MAC dest = 02:42:ac:12:00:02 proto = 0x0800\n")),(0,a.kt)("p",null,"\u5982\u540c\u524d\u8ff0\u4e00\u6a23\uff0c\u6211\u9019\u908a\u4e5f\u91dd\u5c0d\u4e00\u4e9b\u6709\u8da3\u7684\u5c01\u5305\u5167\u5bb9\u9032\u884c\u8a0e\u8ad6"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u56e0\u70ba\u6211\u5011\u662f\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"docker run -p 5566:80"),", \u6240\u4ee5\u6211\u5011\u50b3\u8f38\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"5566")," \u9023\u63a5\u57e0\u6703\u88ab\u8f49\u63db\u6210 ",(0,a.kt)("inlineCode",{parentName:"li"},"80")," \u9023\u63a5\u57e0\u3002 \u53ef\u4ee5\u89c0\u5bdf\u5230\u7b2c\u4e09\u500b\u898f\u5247 ",(0,a.kt)("inlineCode",{parentName:"li"},"mangle-FORWARD")," \u4e4b\u5f8c\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"DPT=5566")," \u90fd\u8b8a\u6210\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"DPT=80"),". \u4e3b\u8981\u662f\u56e0\u70ba\u7d93\u904e\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"nat-PREROUTING")," \u5f8c\u5c31\u88ab\u66f4\u52d5\u4e86\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u540c\u4e0a\u9762\u7684\u7406\u7531\uff0c\u53ef\u4ee5\u89c0\u5bdf\u5230\u5c01\u5305\u7684\u76ee\u6a19",(0,a.kt)("inlineCode",{parentName:"li"},"IP"),"\u5730\u5740\u5f9e\u539f\u672c\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"DST=172.17.8.211")," \u88ab\u8f49\u63db\u6210\u5bb9\u5668\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"DST=172.18.0.2"),"."),(0,a.kt)("li",{parentName:"ol"},"\u56e0\u70ba\u662f\u5f9e",(0,a.kt)("inlineCode",{parentName:"li"},"Wan To Controller"),", \u6240\u4ee5\u5c01\u5305\u6703\u5148\u5f9e ",(0,a.kt)("inlineCode",{parentName:"li"},"iptalbes")," \u958b\u59cb\u8dd1\uff0c\u6700\u5f8c\u8dd1\u9053 ",(0,a.kt)("inlineCode",{parentName:"li"},"Linux Bridge")," \u5f8c\u624d\u6703\u9032\u5165\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"ebtables")),(0,a.kt)("li",{parentName:"ol"},"\u6700\u4e00\u958b\u59cb\u5c01\u5305\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"MAC Address")," \u7684\u767c\u9001\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"0a:00:27:00:00:02 ->08:00:27:ff:b2:c4"),". \u4f46\u662f\u4e00\u4f46\u5230\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"ebtables")," \u90a3\u5c64\uff0c\u4e5f\u5c31\u662f\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"docker0")," \u4e4b\u5f8c\uff0c\u4f60\u53ef\u4ee5\u89c0\u5bdf\u5230\u9019\u6642\u5019\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"MAC address")," \u7684\u6d41\u5411\u8b8a\u6210 ",(0,a.kt)("inlineCode",{parentName:"li"},"02:42:db:a1:f2:79  -> 02:42:ac:12:00:02"),". \u9019\u908a\u539f\u7406\u5be6\u969b\u4e0a\u8ddf ",(0,a.kt)("inlineCode",{parentName:"li"},"IP")," \u5c01\u5305\u50b3\u8f38\u6709\u95dc\uff0c\u9019\u908a\u4e0d\u591a\u6558\u8ff0\u3002")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash="},"ctc/ebtable/broute-BROUTING IN=veth5ead5c7 OUT= MAC source = 02:42:ac:12:00:02 MAC dest = 02:42:db:a1:f2:79 proto = 0x0800\nctc/ebtable/nat-PREROUTE IN=veth5ead5c7 OUT= MAC source = 02:42:ac:12:00:02 MAC dest = 02:42:db:a1:f2:79 proto = 0x0800\nctc/iptable/mangle-PREROUTEIN=docker0 OUT= PHYSIN=veth5ead5c7 MAC=02:42:db:a1:f2:79:02:42:ac:12:00:02:08:00 SRC=172.18.0.2 DST=172.17.8.1 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=80 DPT=63584 WINDOW=28960 RES=0x00 ECE ACK SYN URGP=0\nctc/ebtable/filter-input IN=veth5ead5c7 OUT= MAC source = 02:42:ac:12:00:02 MAC dest = 02:42:db:a1:f2:79 proto = 0x0800\nctc/iptable/mangle-FORWARDIN=docker0 OUT=enp0s8 PHYSIN=veth5ead5c7 MAC=02:42:db:a1:f2:79:02:42:ac:12:00:02:08:00 SRC=172.18.0.2 DST=172.17.8.1 LEN=60 TOS=0x00 PREC=0x00 TTL=63 ID=0 DF PROTO=TCP SPT=80 DPT=63584 WINDOW=28960 RES=0x00 ECE ACK SYN URGP=0\nctc/iptable/filter-forwardIN=docker0 OUT=enp0s8 PHYSIN=veth5ead5c7 MAC=02:42:db:a1:f2:79:02:42:ac:12:00:02:08:00 SRC=172.18.0.2 DST=172.17.8.1 LEN=60 TOS=0x00 PREC=0x00 TTL=63 ID=0 DF PROTO=TCP SPT=80 DPT=63584 WINDOW=28960 RES=0x00 ECE ACK SYN URGP=0\nctc/iptable/mangle-POSTROUTEIN= OUT=enp0s8 PHYSIN=veth5ead5c7 SRC=172.18.0.2 DST=172.17.8.1 LEN=60 TOS=0x00 PREC=0x00 TTL=63 ID=0 DF PROTO=TCP SPT=80 DPT=63584 WINDOW=28960 RES=0x00 ECE ACK SYN URGP=0\n")),(0,a.kt)("p",null,"\u9019\u908a\u662f\u5c01\u5305\u7684\u56de\u7a0b\uff0c\u662f\u7531 ",(0,a.kt)("inlineCode",{parentName:"p"},"Container To Wan")," \u7684\u65b9\u5411"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u5c01\u5305\u662f\u5f9e ",(0,a.kt)("inlineCode",{parentName:"li"},"ebtables")," \u958b\u59cb\uff0c\u56e0\u70ba\u662f\u5f9e ",(0,a.kt)("inlineCode",{parentName:"li"},"Linux Bridge")," \u5e95\u4e0b\u7684\u7db2\u5361\u6536\u5230\u5bb9\u5668\u50b3\u51fa\u4f86\u7684\u5c01\u5305\uff0c\u63a5\u4e0b\u4f86\u900f\u904e\u5404\u7a2e\u8f49\u767c\uff0c\u6700\u5f8c\u5f9e ",(0,a.kt)("inlineCode",{parentName:"li"},"iptabes")," \u90a3\u908a\u8f49\u767c\u51fa\u53bb\u5230\u5916\u90e8\u7db2\u8def\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u89c0\u5bdf\u6700\u5f8c\u4e00\u500b ",(0,a.kt)("inlineCode",{parentName:"li"},"mangle-postrouting")," \u53ef\u4ee5\u770b\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"IP/Port/Mac")," \u90fd\u9084\u6c92\u6709\u88ab\u8f49\u63db\uff0c\u9019\u4e9b\u90fd\u6703\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"nat-postrouting")," \u9019\u908a\u53bb\u8655\u7406\uff0c\u4f46\u662f\u56e0\u70ba ",(0,a.kt)("inlineCode",{parentName:"li"},"conntrack")," \u7684\u95dc\u4fc2\uff0c\u9019\u4e9b\u64cd\u4f5c\u6703\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"kernel")," \u7d66\u5feb\u53d6\u57f7\u884c\u6389\u4e86\u3002\u82e5\u8981\u771f\u7684\u89c0\u5bdf\u53ef\u4ee5\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"li"},"tcpdump")," \u7684\u65b9\u5f0f\u53bb\u76e3\u807d\u5c01\u5305\u3002")),(0,a.kt)("p",null,"\u5728\u770b\u5230\u4e86\u9019\u5169\u7a2e\u7684\u60c5\u5883\u5f8c\uff0c\u6211\u5011\u5c07\u5f7c\u6b64\u7684\u6d41\u5411\u5716\u7d66\u6574\u7406\u4e00\u4e0b\uff0c\u5982\u4e0b\u5716\u3002\n\u5716\u4e2d\u85cd\u8272\u7684\u9023\u7dda\u5247\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"Wan To Container")," \u800c\u7d2b\u8272\u5247\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"Container To Wan")," \u7684\u5c01\u5305\u6d41\u5411\u3002"),(0,a.kt)("p",null,"\u57fa\u672c\u4e0a\u56e0\u70ba\u727d\u626f\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer3/Layer2")," \u7684\u8655\u7406\uff0c\u5c01\u5305\u90fd\u6703\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"filter Table/FORWARD Chain"),". \u5982\u679c\u6709\u8981\u91dd\u5c0d\u9632\u706b\u7246\u53bb\u8655\u7406\u7684\u8a71\uff0c\u53ef\u4ee5\u5728\u9019\u908a\u53bb\u57f7\u884c\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/nzd69Ob.png",alt:"Imgur"})),(0,a.kt)("h2",{id:"summary"},"Summary"),(0,a.kt)("p",null,"\u5728\u672c\u6587\u4e2d\uff0c\u6211\u5011\u5617\u8a66\u900f\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u672c\u8eab\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"log")," \u6a21\u7d44\u4f86\u5354\u52a9\u6211\u5011\u91d0\u6e05\u65bc\u4e0d\u540c\u7684\u62d3\u58a3\u60c5\u5883\u4e2d\uff0c\u5c01\u5305\u4e4b\u9593\u7684\u8f49\u9001\u6703\u600e\u9ebc\u7d93\u904e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables"),"\u3002\n\u7e3d\u5171\u6709\u4e09\u7a2e\u62d3\u58a3\u74b0\u5883\uff0c\u5206\u5225\u662f"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Container To Container"),(0,a.kt)("li",{parentName:"ol"},"Localhost to Container"),(0,a.kt)("li",{parentName:"ol"},"Wan To Container")),(0,a.kt)("p",null,"\u91dd\u5c0d\u6bcf\u500b\u74b0\u5883\uff0c\u6211\u5011\u90fd\u89c0\u5bdf\u5c01\u5305\u7684\u4f86\u56de\u5169\u7a2e\u72c0\u614b\uff0c\u9664\u4e86\u89c0\u5bdf ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u7684\u8d70\u5411\u4e4b\u5916\uff0c\u4e5f\u9806\u4fbf\u89c0\u5bdf\u5c01\u5305\u5167\u5bb9\u7684\u8b8a\u5316\u3002\n\u53ea\u6709\u771f\u6b63\u7684\u77ad\u89e3\u6574\u500b\u5c01\u5305\u7684\u50b3\u8f38\u884c\u70ba\uff0c\u4ee5\u53ca\u5c0d\u61c9\u4f4e ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u7684\u8d70\u5411\uff0c\u672a\u4f86\u5728\u7ba1\u7406 ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables/ebtables")," \u624d\u80fd\u5920\u66f4\u7cbe\u6e96\u7684\u53bb\u8a2d\u5b9a\u76f8\u95dc\u7684\u898f\u5247\u4f86\u6eff\u8db3\u81ea\u5df1\u7684\u9700\u6c42\u3002"))}s.isMDXComponent=!0}}]);