"use strict";(self.webpackChunkhwchiu=self.webpackChunkhwchiu||[]).push([[96837],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>u});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},h="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},k=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),h=p(n),k=r,u=h["".concat(s,".").concat(k)]||h[k]||m[k]||o;return n?a.createElement(u,l(l({ref:t},c),{},{components:n})):a.createElement(u,l({ref:t},c))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=k;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[h]="string"==typeof e?e:r,l[1]=i;for(var p=2;p<o;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},16035:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const o={title:"OpenvSwitch - overview",date:"2013-12-17 15:13",comments:!0,tags:["SDN","Network","OpenvSwitch"],description:"This post shoes about what the system do when we install the OpenvSwitch in your system. The architecture of OpenvSwitch covers both user-space and kernel-space and we can see functions of each part in this porsts."},l="Environment",i={unversionedId:"techPost/2013/openvswitch-overview",id:"techPost/2013/openvswitch-overview",title:"OpenvSwitch - overview",description:"This post shoes about what the system do when we install the OpenvSwitch in your system. The architecture of OpenvSwitch covers both user-space and kernel-space and we can see functions of each part in this porsts.",source:"@site/docs/techPost/2013/openvswitch-overview.md",sourceDirName:"techPost/2013",slug:"/techPost/2013/openvswitch-overview",permalink:"/docs/techPost/2013/openvswitch-overview",draft:!1,tags:[{label:"SDN",permalink:"/docs/tags/sdn"},{label:"Network",permalink:"/docs/tags/network"},{label:"OpenvSwitch",permalink:"/docs/tags/openv-switch"}],version:"current",frontMatter:{title:"OpenvSwitch - overview",date:"2013-12-17 15:13",comments:!0,tags:["SDN","Network","OpenvSwitch"],description:"This post shoes about what the system do when we install the OpenvSwitch in your system. The architecture of OpenvSwitch covers both user-space and kernel-space and we can see functions of each part in this porsts."},sidebar:"techPost",previous:{title:"OpenVSwitch - Basic Install",permalink:"/docs/techPost/2013/openvswitch-install"},next:{title:"OpenvSwitch - 2",permalink:"/docs/techPost/2013/openvswitch-source-2"}},s={},p=[],c={toc:p},h="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(h,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"environment"},"Environment"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Three PCs."),(0,r.kt)("li",{parentName:"ul"},"One for openvswitch (with a 4-port ethernet card)."),(0,r.kt)("li",{parentName:"ul"},"Two for hosts."),(0,r.kt)("li",{parentName:"ul"},"OVS version 1.9")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/x1arC8nSTiOAQ0AoLtjj_test.png",alt:"test.png"})),(0,r.kt)("h1",{id:"kernel-module"},"kernel module"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"insmod datapath/linux/openvswitch.ko")),(0,r.kt)("p",null,"When we load the ",(0,r.kt)("strong",{parentName:"p"},"openvswitch"),"'s kernel module, it will register four ",(0,r.kt)("strong",{parentName:"p"},"generic netlink")," event including\n",(0,r.kt)("inlineCode",{parentName:"p"},"datapath"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"vport"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"flow")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"packet"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/a9o3mQ2iR2GrYSRMKuIN_%E6%93%B7%E5%8F%961.PNG",alt:"\u64f7\u53d61.PNG"})),(0,r.kt)("p",null,"In the ",(0,r.kt)("strong",{parentName:"p"},"datapath.c"),", we can see those four ",(0,r.kt)("strong",{parentName:"p"},"generic netlink"),"  type."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/Tt1PPwiHSMiBWmKiztJM_2.PNG",alt:"2.PNG"})),(0,r.kt)("p",null,"Take the ",(0,r.kt)("strong",{parentName:"p"},"vport")," for example, there're four command we can excute via this ",(0,r.kt)("strong",{parentName:"p"},"netlink")," type.\nIf we want the kernel to create a new port, we can send the ",(0,r.kt)("strong",{parentName:"p"},"vport")," type ",(0,r.kt)("strong",{parentName:"p"},"netlink")," with the command ",(0,r.kt)("strong",{parentName:"p"},"OVS_VPORT_CMD_NEW"),"\n, and the command handler (",(0,r.kt)("strong",{parentName:"p"},"doit"),") ovs_vport_cmd_new will be excuted to create the new vport."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/eHZ7vqScSjCAaFJMDiIn_%E6%93%B7%E5%8F%96.PNG",alt:"\u64f7\u53d6.PNG"})),(0,r.kt)("h1",{id:"ovs-vswitchd"},"ovs-vswitchd"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"}," ovsdb-server ..."),"\n",(0,r.kt)("inlineCode",{parentName:"p"},"ovs-vswitchd --pidfile --detach")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"First, the ",(0,r.kt)("inlineCode",{parentName:"li"},"ovsdb-server")," will start a database daemon, In addition, there're some user-space tool will work with it, like ",(0,r.kt)("strong",{parentName:"li"},"ove-vsctl"),", ",(0,r.kt)("strong",{parentName:"li"},"ovs-ofctl"),"..etc."),(0,r.kt)("li",{parentName:"ul"},"The user-space process ",(0,r.kt)("strong",{parentName:"li"},"ovs-vswitchd")," play a importmant role about ",(0,r.kt)("strong",{parentName:"li"},"openflow")," in OpenvSwitch.\nIt will parse the openflow protocol and handle it (you can use the keyword ",(0,r.kt)("strong",{parentName:"li"},"ofproto")," to find the resource about it)")),(0,r.kt)("p",null,"ovs-vswitchd:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Process openflow messages"),(0,r.kt)("li",{parentName:"ul"},"Manage the datapath (which actually in kernel space)"),(0,r.kt)("li",{parentName:"ul"},"Maintain two flow table (exactly flow & wildcard flow)")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/A5R1wlMlQMGHHmAMjURg_%E6%93%B7%E5%8F%963.PNG",alt:"\u64f7\u53d63.PNG"})),(0,r.kt)("h1",{id:"adding-bridge"},"Adding bridge"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ovs-vsctl add-br br0")),(0,r.kt)("p",null,"When we excute the ",(0,r.kt)("inlineCode",{parentName:"p"},"ovs-vsctl"),", it will send a command to ",(0,r.kt)("strong",{parentName:"p"},"ovsdb")," and the DB will store this information.\nAfter that, the ",(0,r.kt)("strong",{parentName:"p"},"ovsdb")," will pass the command to ",(0,r.kt)("strong",{parentName:"p"},"ovs-vswitchd"),", and the ",(0,r.kt)("strong",{parentName:"p"},"ovs-vswitch")," send the ",(0,r.kt)("strong",{parentName:"p"},"netlink"),"  with ",(0,r.kt)("strong",{parentName:"p"},"datapath")," type to the kernel.\nSince we have installed the kernel module before, the datapath will receive the netlink and excute the corresponding command handler.\nIn this case, it will excute ",(0,r.kt)("strong",{parentName:"p"},"ovs_dp_cmd_new"),".\nFinally, the ",(0,r.kt)("strong",{parentName:"p"},"datapath")," will be created and it will be managed by ",(0,r.kt)("strong",{parentName:"p"},"ovs-vswitchd"),"."),(0,r.kt)("p",null,"datapath:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Maintain one flow table (exactly flow) ",(0,r.kt)("strong",{parentName:"li"},"This study is based on the OVS v1.9")),(0,r.kt)("li",{parentName:"ul"},"Act as the software switch (look up flow, forward the packet)")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/22cYSkNQQwmksjbBcDPq_%E6%93%B7%E5%8F%963.PNG",alt:"\u64f7\u53d63.PNG"})),(0,r.kt)("h1",{id:"adding-vports"},"Adding vports"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ovs-vsctl add-port br0 eth1")),(0,r.kt)("p",null,"Like the above discussion about ",(0,r.kt)("strong",{parentName:"p"},"datapath"),", ",(0,r.kt)("strong",{parentName:"p"},"ovs-vswitchd")," send the ",(0,r.kt)("strong",{parentName:"p"},"netlink")," to the kernel.\nIn the command handler ",(0,r.kt)("strong",{parentName:"p"},"ovs_vport_cmd_new"),"."),(0,r.kt)("p",null,"1.Find the the ",(0,r.kt)("strong",{parentName:"p"},"struct net_device")," object in the kernel by the user typing interface name (",(0,r.kt)("strong",{parentName:"p"},"eth1"),")\n2.Modify the receive_handler of that ",(0,r.kt)("strong",{parentName:"p"},"net_device")," to the OpenvSwitch's packet handler."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/jdtSnR6SbCZRX2QcwTqQ_%E6%93%B7%E5%8F%963.PNG",alt:"\u64f7\u53d63.PNG"})),(0,r.kt)("h1",{id:"set-controller"},"Set-Controller"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ovs-vsctl set-controller br0 tcp:xxx.xxx.xxx.xxx:6633")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Set the controller setting and it will be done in ",(0,r.kt)("strong",{parentName:"li"},"ovs-vswitchd"),".")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/Lioqm31mTWqVrFUAkbTZ_%E6%93%B7%E5%8F%963.PNG",alt:"\u64f7\u53d63.PNG"})),(0,r.kt)("p",null,"##In the following example, we use a simple case to explain how the ping works"),(0,r.kt)("h1",{id:"target-command"},"Target command"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"hostA ping hostB")),(0,r.kt)("p",null,"We devide the picture into two parts by the red line."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Upper Part")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"This part show the physical view of thie case."),(0,r.kt)("li",{parentName:"ul"},"The middle PC has installed the Ubuntu 12.04 and OVS 1.9."),(0,r.kt)("li",{parentName:"ul"},"The left PC connect to the OVS's nic ",(0,r.kt)("strong",{parentName:"li"},"eth1")),(0,r.kt)("li",{parentName:"ul"},"The right PC connect to the OVS's nic ",(0,r.kt)("strong",{parentName:"li"},"eth2"))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Lower Part")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"This part show the system view of the switch PC (middle one)"),(0,r.kt)("li",{parentName:"ul"},"We use the dash-line to separate the user-space and kernel-space.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Analysis")),(0,r.kt)("p",null,"After the OVS receives the ICMP packet from the left PC.\nWhat will happen about OVS?"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/iQ4NzZPtTEyHzA4XyXln_%E6%93%B7%E5%8F%963.PNG",alt:"\u64f7\u53d63.PNG"})),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The NIC ",(0,r.kt)("strong",{parentName:"li"},"eth1")," receives the ICMP packet."),(0,r.kt)("li",{parentName:"ol"},"Call the ",(0,r.kt)("strong",{parentName:"li"},"receive_handler")," to handler this ICMP packet."),(0,r.kt)("li",{parentName:"ol"},"Do ",(0,r.kt)("inlineCode",{parentName:"li"},"flow_lookup"),", it will look up the flow table maintained by the kernel-space. All the flow entry in this table is ",(0,r.kt)("strong",{parentName:"li"},"exactly")," flow entry, which means there're no any wildcard.\nThis architecture will speed up the look-up since we don't need to consider the wildcard field.\nIn the OpenvSwtich, it use the ",(0,r.kt)("strong",{parentName:"li"},"struct sw_flow_key")," to present a ",(0,r.kt)("strong",{parentName:"li"},"exactly flow"),"."),(0,r.kt)("li",{parentName:"ol"},"If we find the flow entry in the flow table, excute its ",(0,r.kt)("strong",{parentName:"li"},"flow actiojn"),"."),(0,r.kt)("li",{parentName:"ol"},"Otherwise, we need the help from controller. so the ",(0,r.kt)("strong",{parentName:"li"},"datapath.ko")," will send this flow to the user-space via the f unction ",(0,r.kt)("strong",{parentName:"li"},"upcall"),"\n(actually, it's a netlink message)")),(0,r.kt)("p",null,"What will happen when the ",(0,r.kt)("strong",{parentName:"p"},"ovs-vswitch")," receive the flow from the kernel-space."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/itUv393WQbS2dl34nKjG_%E6%93%B7%E5%8F%963.PNG",alt:"\u64f7\u53d63.PNG"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Both ",(0,r.kt)("strong",{parentName:"li"},"exactly matching flow")," and ",(0,r.kt)("strong",{parentName:"li"},"wildcard matching flow")," are stored in the user-space (by Openflow protocol)."),(0,r.kt)("li",{parentName:"ul"},"Since the ",(0,r.kt)("strong",{parentName:"li"},"exactly matching")," has high priority than ",(0,r.kt)("strong",{parentName:"li"},"wildcard matching"),", we need to lookup the ",(0,r.kt)("strong",{parentName:"li"},"exactly macthing flow table")," first."),(0,r.kt)("li",{parentName:"ul"},"Look up the flow entry in the user-space by ",(0,r.kt)("strong",{parentName:"li"},"exactly matching"),", if we find it, send ",(0,r.kt)("strong",{parentName:"li"},"two")," netlink message to the kernel (we will discuss these two nelitnkj message later)"),(0,r.kt)("li",{parentName:"ul"},"Otherwise, look up the flow entry by ",(0,r.kt)("strong",{parentName:"li"},"wildcard matching"),", if we find it, generate a corrsponding exactly flow entry and send ",(0,r.kt)("strong",{parentName:"li"},"two")," netlink message to the kernel."),(0,r.kt)("li",{parentName:"ul"},"If we can't find any flow entry in the flow-table, we issue a ",(0,r.kt)("strong",{parentName:"li"},"Packet_In")," to the controller.")),(0,r.kt)("p",null,"After the kernel-space receive those ",(0,r.kt)("strong",{parentName:"p"},"two")," netlink message which sending from user-space."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Excute the ",(0,r.kt)("strong",{parentName:"li"},"flow_actiojn")," about that flow entry."),(0,r.kt)("li",{parentName:"ol"},"Insert that ",(0,r.kt)("strong",{parentName:"li"},"exactly mactching flow")," into the kernel's flow-table. That will create the cache for that connection  and crease the processing time for nect packets.")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://user-image.logdown.io/user/415/blog/415/post/167510/VJcdFvSAawgDpSoLDrVA_%E6%93%B7%E5%8F%963.PNG",alt:"\u64f7\u53d63.PNG"})),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Summary")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"There is a limitation about the size of flow table in kernel, it use the cache (exactly macthing) to speed up the look-up.For the recently activity connection, those packets can be handled quickly."),(0,r.kt)("li",{parentName:"ul"},"The flow-table in the user-space is the same as the what the controller see. It support the wildcard matching. We can reduce the size of flow entries by wildcard matching but it will bring the overhaed for look-up")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"MISC")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"You can use the ",(0,r.kt)("strong",{parentName:"li"},"ovs-dpctl dump-flows")," to dump the flow table of kernel-space"),(0,r.kt)("li",{parentName:"ol"},"This article is based on the OVS v1.9 and the architecture has some change after v1.11")))}m.isMDXComponent=!0}}]);